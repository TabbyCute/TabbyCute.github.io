<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>TabbyBlog</title>
  
  <subtitle>TabbyBlog的个人主页和一些技术博客的分享。</subtitle>
  <link href="https://tabbycute.github.io/atom.xml" rel="self"/>
  
  <link href="https://tabbycute.github.io/"/>
  <updated>2023-06-10T15:21:23.981Z</updated>
  <id>https://tabbycute.github.io/</id>
  
  <author>
    <name>TabbyBlog</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>腾讯云COS前端临时token直传</title>
    <link href="https://tabbycute.github.io/2023/04/15/20230415COS%E5%89%8D%E7%AB%AF%E7%9B%B4%E4%BC%A0/"/>
    <id>https://tabbycute.github.io/2023/04/15/20230415COS%E5%89%8D%E7%AB%AF%E7%9B%B4%E4%BC%A0/</id>
    <published>2023-04-14T16:00:00.000Z</published>
    <updated>2023-06-10T15:21:23.981Z</updated>
    
    <content type="html"><![CDATA[<h3 id="服务端获取临时秘钥"><a href="#服务端获取临时秘钥" class="headerlink" title="服务端获取临时秘钥"></a>服务端获取临时秘钥</h3><p><a href="https://cloud.tencent.com/document/product/436/14048">golang获取cos临时秘钥官方文档</a></p><h3 id="前端直传"><a href="#前端直传" class="headerlink" title="前端直传"></a>前端直传</h3><h4 id="普通项目"><a href="#普通项目" class="headerlink" title="普通项目"></a>普通项目</h4><p><a href="https://github.com/tencentyun/cos-js-sdk-v5">cos-js-sdk-v5地址</a>或者<a href="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js">CDN地址引入</a><a href="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js">https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js</a></p><ul><li>示例<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;file-selector&quot;</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> <span class="title class_">XCosSecurityToken</span>=<span class="string">&quot;3PCM60BvU7Rn6i5X9uPq6hni4MR0a7a545dc67e23d015d82bf311650ba22ab6S7pP-3AVNt1ob9zN8BdkGSFDF5r0KeAIvl3JAWayfA4M-z5K5JzzlHY_aU-XAi8y8DVLHPq61kYFEzQvCQ2wgbSDjWNwXH3V6QYEZvW2BtHpEFU87ME4h9geXrFXucln3a4cwCW_VWDzvHc07rhYbTOjYY0Iv5QfCvgrAtqmlgYN4i6G0DNOW-77-cePbwYPY9edzZH2LNCjdvFGEpWVAuta5KzGjEetyN2GvsexFq2pHVxZmNu6zEcEQ4_sS1EcTRtv86h75KGjbunbrrkpNV6uoTgE6gdy49QoOWbkMZeVczPzM2QyTpwi7P8tfIDvc4NapoD6GxJIbHvrW4PiUbpi0loHC5HFdswPFJn7UiR_uw8ZOpIBcI_MGvBx5nJBMgiw5YFABcb0JQqO8f6BKBZRE7BFPAx8BmUiD_UuTF8SsyLUKEcAzCwEFqXovI2c6eBJtBxh8wpDj86mh3YCNL90gMWL2MOC_wp4aye46NS-WbUFEJcVaEaSSghYJ8KMIkzaGpl_qoZyw8iOOu7DPDHj7V_J02FJLR239k0io4nwZm-1yL7fui12ufqm3gVqYYNtkm6FUQGA8Gj0cw58eEgNZyx3bUxuWuHHT7tMk0rQQWbMUJrKPqhFvvZ-dtSCf_-6gzpXXq-L1WqtOTEv4shv6Oe6hvV8dOfuf5QzcBigoqE50H1LUf0WsBAoJhJNqCrX8wc14cFsi52Mb50H35T86ccynx10G52m8JaKuCGl8MdGAoH2nf7sUoNzfalm&quot;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="title class_">XCosSecurityToken</span>=<span class="string">&quot;3PCMV60vU7Rn6i5X9uPq6hni4MR0a7a2d3bc587bab11a530d40f363a977d412S7pP-3AVNt1ob9zN8BdkGXMZQHasR3fm0UnpYU65oT3T2fAH92lRKCRYTjA4h4LGp3bgp4o0eaKBRPr2KmYdVfKwH0h1-TRU8VF05qpgbqw1gv_ty-A0ovUNFLJCX5-2O8eARmOdl8jt6bQHvEfcsy4xfAwy_to-y7Ax3ErdjqJ5cTsaKWr5ru85bW7nPJH945hyqRHX1nduwGlYlIn4GztlVB2W-EbrjnKAti8P-HKY4JWD7kxS3UjB1yQm5QBNcM5lY6xyyS-pat_nmm7pqyegU_P7VWcIT587o_OUTC_lLJPD9S0nLYygB_7VWITWOCZcGd_Yfhj5pQR4L0ByMMTHqkvG3B3JVl2j8EKKZOpDXUtzBqznCVw9bDp87F5AwDtE0RQSLzoqBK-Dd68d5leqk_nULqPAMQPjmu2YUApI2X81Lsz6VioD7HNwRxegPPa1Ik53X89nFAh6GhKVouw0cQjDvj39SpHeVAvH8TL0S4muRborXqkmyLhqrgY98NZOVr0TIeoV-KEbxKgbciRe18sMowJ7jsmmuy3iI_FGRL97pDmNFWX4vMkVS9R4&quot;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> <span class="title class_">TmpSecretKey</span> = <span class="string">&quot;NpEEntHyD9X/TzdXg9muRnB8obxtUzeKePT3QPX820=&quot;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> <span class="title class_">TmpSecretId</span> = <span class="string">&quot;AKIDxKFyybjsuzxhTg-5WvrZhuTQ5xKxrivElSB81ySz9KKl1qK1_O5yglpWqD7kf_&quot;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> <span class="title class_">StartTime</span> = <span class="number">1664288985</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> <span class="title class_">ExpiredTime</span> = <span class="number">1664292585</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> <span class="title class_">Bucket</span> = <span class="string">&#x27;test9-1314103605&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> <span class="title class_">Region</span> = <span class="string">&#x27;ap-chengdu&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 初始化实例</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> cos = <span class="keyword">new</span> <span class="title function_">COS</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">getAuthorization</span>: <span class="keyword">function</span> (<span class="params">options, callback</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">callback</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">TmpSecretId</span>: <span class="title class_">TmpSecretId</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">TmpSecretKey</span>: <span class="title class_">TmpSecretKey</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">XCosSecurityToken</span>: <span class="title class_">XCosSecurityToken</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">StartTime</span>: <span class="title class_">StartTime</span>, <span class="comment">// 时间戳，单位秒，如：1580000000，建议返回服务器时间作为签名的开始时间，避免用户浏览器本地时间偏差过大导致签名错误</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">ExpiredTime</span>:<span class="title class_">ExpiredTime</span>, <span class="comment">// 时间戳，单位秒，如：1580000900</span></span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 监听选文件</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;file-selector&#x27;</span>).<span class="property">onchange</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> file = <span class="variable language_">this</span>.<span class="property">files</span>[<span class="number">0</span>];</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (!file) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 分片上传文件</span></span></span><br><span class="line"><span class="language-javascript">            cos.<span class="title function_">sliceUploadFile</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">Bucket</span>: <span class="title class_">Bucket</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">Region</span>: <span class="title class_">Region</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">Key</span>: <span class="string">&quot;test/&quot;</span>+file.<span class="property">name</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">Body</span>: file,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">onHashProgress</span>: <span class="keyword">function</span> (<span class="params">progressData</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;校验中&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(progressData));</span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">onProgress</span>: <span class="keyword">function</span> (<span class="params">progressData</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;上传中&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(progressData));</span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">            &#125;, <span class="keyword">function</span> (<span class="params">err, data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(err, data);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="微信小程序前端直传"><a href="#微信小程序前端直传" class="headerlink" title="微信小程序前端直传"></a>微信小程序前端直传</h4><p><a href="https://github.com/tencentyun/cos-wx-sdk-v5">微信小程序前端直传SDK</a></p><ul><li>示例<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">把 demo/lib/cos-wx-sdk-v5.<span class="property">js</span> 复制到自己小程序项目代码里，在需要上传文件的地方贴以下代码</span><br><span class="line">把 demo/lib/cos-wx-sdk-v5.<span class="property">js</span> 复制到自己小程序项目代码里，在需要上传文件的地方贴以下代码</span><br><span class="line">把 demo/lib/cos-wx-sdk-v5.<span class="property">js</span> 复制到自己小程序项目代码里，在需要上传文件的地方贴以下代码</span><br><span class="line">很重要</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存储桶名称，由bucketname-appid 组成，appid必须填入，可以在COS控制台查看存储桶名称。 https://console.cloud.tencent.com/cos5/bucket</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Bucket</span> = <span class="string">&#x27;test-1250000000&#x27;</span>;</span><br><span class="line"><span class="comment">// 存储桶Region可以在COS控制台指定存储桶的概览页查看 https://console.cloud.tencent.com/cos5/bucket/ </span></span><br><span class="line"><span class="comment">// 关于地域的详情见 https://cloud.tencent.com/document/product/436/6224</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Region</span> = <span class="string">&#x27;ap-guangzhou&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化实例</span></span><br><span class="line"><span class="keyword">var</span> cos = <span class="keyword">new</span> <span class="title function_">COS</span>(&#123;</span><br><span class="line">    <span class="attr">getAuthorization</span>: <span class="keyword">function</span> (<span class="params">options, callback</span>) &#123;</span><br><span class="line">        <span class="comment">// 异步获取签名</span></span><br><span class="line">        wx.<span class="title function_">request</span>(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;https://example.com/sts.php&#x27;</span>, <span class="comment">// 步骤二提供的签名接口</span></span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="title class_">Method</span>: options.<span class="property">Method</span>,</span><br><span class="line">                <span class="title class_">Key</span>: options.<span class="property">Key</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">dataType</span>: <span class="string">&#x27;text&#x27;</span>,</span><br><span class="line">            <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">result</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> data = result.<span class="property">data</span>;</span><br><span class="line">                <span class="title function_">callback</span>(&#123;</span><br><span class="line">                    <span class="title class_">TmpSecretId</span>: data.<span class="property">credentials</span> &amp;&amp; data.<span class="property">credentials</span>.<span class="property">tmpSecretId</span>,</span><br><span class="line">                    <span class="title class_">TmpSecretKey</span>: data.<span class="property">credentials</span> &amp;&amp; data.<span class="property">credentials</span>.<span class="property">tmpSecretKey</span>,</span><br><span class="line">                    <span class="title class_">XCosSecurityToken</span>: data.<span class="property">credentials</span> &amp;&amp; data.<span class="property">credentials</span>.<span class="property">sessionToken</span>,</span><br><span class="line">                    <span class="title class_">ExpiredTime</span>: data.<span class="property">expiredTime</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择文件</span></span><br><span class="line">wx.<span class="title function_">chooseImage</span>(&#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">1</span>, <span class="comment">// 默认9</span></span><br><span class="line">    <span class="attr">sizeType</span>: [<span class="string">&#x27;original&#x27;</span>], <span class="comment">// 可以指定是原图还是压缩图，默认用原图</span></span><br><span class="line">    <span class="attr">sourceType</span>: [<span class="string">&#x27;album&#x27;</span>, <span class="string">&#x27;camera&#x27;</span>], <span class="comment">// 可以指定来源是相册还是相机，默认二者都有</span></span><br><span class="line">    <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> filePath = res.<span class="property">tempFiles</span>[<span class="number">0</span>].<span class="property">path</span>;</span><br><span class="line">        <span class="keyword">var</span> filename = filePath.<span class="title function_">substr</span>(filePath.<span class="title function_">lastIndexOf</span>(<span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line">        cos.<span class="title function_">postObject</span>(&#123;</span><br><span class="line">            <span class="title class_">Bucket</span>: <span class="title class_">Bucket</span>,</span><br><span class="line">            <span class="title class_">Region</span>: <span class="title class_">Region</span>,</span><br><span class="line">            <span class="title class_">Key</span>: filename,</span><br><span class="line">            <span class="title class_">FilePath</span>: filePath,</span><br><span class="line">            <span class="attr">onProgress</span>: <span class="keyword">function</span> (<span class="params">info</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(info));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">function</span> (<span class="params">err, data</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(err || data);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li>封装<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///实际引入</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">COS</span> = <span class="built_in">require</span>(<span class="string">&#x27;./cos-wx-sdk-v5.js&#x27;</span>);</span><br><span class="line"><span class="comment">///这个必须引入，否则找不到文件</span></span><br><span class="line"><span class="comment">///这个必须引入，否则找不到文件</span></span><br><span class="line"><span class="comment">///这个必须引入，否则找不到文件</span></span><br><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">&#x27;./cos-wx-sdk-v5.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Credential</span> &#123;</span><br><span class="line"><span class="title class_">TmpSecretId</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="title class_">TmpSecretKey</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="title class_">XCosSecurityToken</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="title class_">StartTime</span>=<span class="number">0</span></span><br><span class="line"><span class="title class_">ExpiredTime</span>=<span class="number">0</span></span><br><span class="line"><span class="title class_">Bucket</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="title class_">Region</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="title class_">BucketPath</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">obj=&#123;&#125;</span>)&#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">TmpSecretId</span>=obj.<span class="property">TmpSecretId</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">TmpSecretKey</span>=obj.<span class="property">TmpSecretKey</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">XCosSecurityToken</span>=obj.<span class="property">XCosSecurityToken</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">StartTime</span>=obj.<span class="property">StartTime</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">ExpiredTime</span>=obj.<span class="property">ExpiredTime</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">Bucket</span>=obj.<span class="property">Bucket</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">Region</span>=obj.<span class="property">Region</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">BucketPath</span>=obj.<span class="property">BucketPath</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getFileNameByPath</span>=(<span class="params">filePath</span>)=&gt;&#123;</span><br><span class="line"><span class="keyword">return</span> filePath.<span class="title function_">match</span>(<span class="regexp">/[^/]*$/</span>)[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"><span class="doctag">@process</span> [function] 进度回调</span></span><br><span class="line"><span class="comment"><span class="doctag">@done</span> [function] 结果回调</span></span><br><span class="line"><span class="comment"><span class="doctag">@filePath</span> string 文件路径</span></span><br><span class="line"><span class="comment"><span class="doctag">@filename</span> string 文件名称 ，可不传</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">COSSingle</span> = (<span class="params">obj=&#123;&#125;</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">let</span> &#123;cre,filePath,done,process,filename&#125;=obj</span><br><span class="line"><span class="comment">// 初始化实例</span></span><br><span class="line"><span class="keyword">var</span> cos = <span class="keyword">new</span> <span class="title function_">COS</span>(&#123;</span><br><span class="line"><span class="attr">getAuthorization</span>: <span class="keyword">function</span> (<span class="params">options, callback</span>) &#123;</span><br><span class="line"><span class="title function_">callback</span>(&#123;</span><br><span class="line"><span class="title class_">TmpSecretId</span>: cre.<span class="property">TmpSecretId</span>,</span><br><span class="line"><span class="title class_">TmpSecretKey</span>: cre.<span class="property">TmpSecretKey</span>,</span><br><span class="line"><span class="title class_">XCosSecurityToken</span>: cre.<span class="property">XCosSecurityToken</span>,</span><br><span class="line"><span class="title class_">StartTime</span>: cre.<span class="property">StartTime</span>, <span class="comment">// 时间戳，单位秒，如：1580000000，建议返回服务器时间作为签名的开始时间，避免用户浏览器本地时间偏差过大导致签名错误</span></span><br><span class="line"><span class="title class_">ExpiredTime</span>: cre.<span class="property">ExpiredTime</span>, <span class="comment">// 时间戳，单位秒，如：1580000900</span></span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">if</span>(!filename)&#123;filename=<span class="title function_">getFileNameByPath</span>(filePath)&#125;</span><br><span class="line">cos.<span class="title function_">postObject</span>(&#123;</span><br><span class="line"><span class="title class_">Bucket</span>: cre.<span class="property">Bucket</span>,</span><br><span class="line"><span class="title class_">Region</span>: cre.<span class="property">Region</span>,</span><br><span class="line"><span class="title class_">Key</span>: cre.<span class="property">BucketPath</span>+filename,</span><br><span class="line"><span class="title class_">FilePath</span>: filePath,</span><br><span class="line"><span class="attr">onProgress</span>: <span class="keyword">function</span> (<span class="params">info</span>) &#123;process&amp;&amp;<span class="title function_">process</span>(info)&#125;</span><br><span class="line">&#125;, <span class="keyword">function</span> (<span class="params">err, data</span>) &#123;</span><br><span class="line">done&amp;&amp;<span class="title function_">done</span>(err,data)</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">COSMultiple</span> = (<span class="params">cre=<span class="keyword">new</span> Credential(),Files=[]</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="comment">// 初始化实例</span></span><br><span class="line"><span class="keyword">var</span> cos = <span class="keyword">new</span> <span class="title function_">COS</span>(&#123;</span><br><span class="line"><span class="attr">getAuthorization</span>: <span class="keyword">function</span> (<span class="params">options, callback</span>) &#123;</span><br><span class="line"><span class="title function_">callback</span>(&#123;</span><br><span class="line"><span class="title class_">TmpSecretId</span>: cre.<span class="property">TmpSecretId</span>,</span><br><span class="line"><span class="title class_">TmpSecretKey</span>: cre.<span class="property">TmpSecretKey</span>,</span><br><span class="line"><span class="title class_">XCosSecurityToken</span>: cre.<span class="property">XCosSecurityToken</span>,</span><br><span class="line"><span class="title class_">StartTime</span>: cre.<span class="property">StartTime</span>, <span class="comment">// 时间戳，单位秒，如：1580000000，建议返回服务器时间作为签名的开始时间，避免用户浏览器本地时间偏差过大导致签名错误</span></span><br><span class="line"><span class="title class_">ExpiredTime</span>: cre.<span class="property">ExpiredTime</span>, <span class="comment">// 时间戳，单位秒，如：1580000900</span></span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UpItem</span>(<span class="params">filePath,filename</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">sle,reject</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(!filename)&#123;filename=<span class="title function_">getFileNameByPath</span>(filePath)&#125;</span><br><span class="line">cos.<span class="title function_">postObject</span>(&#123;</span><br><span class="line"><span class="title class_">Bucket</span>: cre.<span class="property">Bucket</span>,</span><br><span class="line"><span class="title class_">Region</span>: cre.<span class="property">Region</span>,</span><br><span class="line"><span class="title class_">Key</span>: cre.<span class="property">BucketPath</span>+filename,</span><br><span class="line"><span class="title class_">FilePath</span>: filePath,</span><br><span class="line"><span class="attr">onProgress</span>: <span class="keyword">function</span> (<span class="params">info</span>) &#123;&#125;</span><br><span class="line">&#125;, <span class="keyword">function</span> (<span class="params">err, data</span>) &#123;</span><br><span class="line"><span class="title function_">sle</span>(&#123;err, data&#125;);</span><br><span class="line"><span class="comment">// done&amp;&amp;done(err,data)</span></span><br><span class="line">&#125;);</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>(<span class="title class_">Files</span>.<span class="title function_">map</span>(<span class="function"><span class="params">i</span>=&gt;</span><span class="title class_">UpItem</span>(i.<span class="property">filePath</span>,i.<span class="property">filename</span>))).<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line"><span class="title function_">resolve</span>(res)</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">e</span>=&gt;</span>&#123;</span><br><span class="line"><span class="title function_">reject</span>(e)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>使用<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">测试使用</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">COSSingle</span>,<span class="title class_">COSMultiple</span>,<span class="title class_">Credential</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;@/pkg/cos/index.js&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">upload</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line"><span class="keyword">var</span> cre= <span class="keyword">new</span> <span class="title class_">Credential</span>(&#123;</span><br><span class="line"><span class="title class_">TmpSecretId</span>:<span class="string">&quot;AKIDC5DKwFpmKLYEV4jkyB6MzHSA2RJBwQuCowagLCXuU-8gjebR3mKRreLCoGIa77y&quot;</span>,</span><br><span class="line"><span class="title class_">TmpSecretKey</span>:<span class="string">&quot;pcqawQkKxJz9dTWg+5ndBLVowHW/is1S7f6J+jBtY4M=&quot;</span>,</span><br><span class="line"><span class="title class_">XCosSecurityToken</span>:<span class="string">&quot;d7YzDoYn03sPOuolg9Zj17hWJ6oTBqXa876a52cdb6c39574696f11da7bb4dcc1MxnevotTIlzOwvElw6cIdIMEEuPMs642ww2kn3WvepO0jK1rE8JC6iZb9xT9_r8eJwpEitqqpCDedHEoYQ-zf0HM9DsbSI-t3iuDnVunzxr2qwKo4RGa6CMyotXMkYvnDsuDWVHLfY47GWEcXGpaXV2Oqco3zX3KOilU9AzA7Q0FjIlx4bGOYGUEmuquqbjAvz_USAdxjYCdq1Ia5x8nv-JYb0xEQfK79UrwFU87fu8n-kVhIaOWofbMj9EwSOYpCjn_LRxvYxnObV6PB9ytbuj20QRjtVmFVBLcrY5qlXw29UhU0IttCc7a2xxCNNQq5shQIZeaDoew6gS1gQMKgwUQLP9hE-2OPLHTq15T7miB2orMDEOHK-4aCFGZCKABLvHGaQFisE7bQ0DwNNpSeJI6R_sf2-PSgP4nfE6HUxTSLaigHlBEBkIwnNydcJoTZIjcHiVT2dA4u6t9O2sd5EOAeopRaI7dEKQykBHeJojaIg4oOHL6t2IkSZX4eW8Caml9J7dPN20wufjwOU_IVbZLuDG79Gyj2TjAuFSxsq5lORoempn3RTL6dU9YW5_k0b5eQq6VMQ-9u-EJWf6n9iwvXv0BUe3qMcyF1sC2O8-qAm4MBx1rTGRNCUeOx0f&quot;</span>,</span><br><span class="line"><span class="title class_">StartTime</span>:<span class="number">1686408158</span>,</span><br><span class="line"><span class="title class_">ExpiredTime</span>:<span class="number">1686415358</span>,</span><br><span class="line"><span class="title class_">Bucket</span>:<span class="string">&quot;test2-1257289329&quot;</span>,</span><br><span class="line"><span class="title class_">Region</span>:<span class="string">&quot;ap-chengdu&quot;</span>,</span><br><span class="line"><span class="title class_">BucketPath</span>:<span class="string">&quot;test/&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">///筛选掉已经上传的，和组织数据对象[&#123;filePath,filename&#125;]</span></span><br><span class="line"><span class="comment">///up是未上传的文件</span></span><br><span class="line"><span class="keyword">var</span> target=fdata.<span class="property">value</span>.<span class="title function_">map</span>(<span class="function"><span class="params">i</span>=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(i.<span class="property">up</span>===<span class="literal">false</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line"><span class="attr">filePath</span>:i.<span class="property">tempFilePath</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">///单个上传</span></span><br><span class="line"><span class="comment">// COSSingle(&#123;</span></span><br><span class="line"><span class="comment">// cre,</span></span><br><span class="line"><span class="comment">// filePath:target[0].filePath,</span></span><br><span class="line"><span class="comment">// done:function(err,data)&#123;</span></span><br><span class="line"><span class="comment">// if(!err)&#123;</span></span><br><span class="line"><span class="comment">// ///上传成功</span></span><br><span class="line"><span class="comment">// console.log(err,data)</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">///多个文件上传</span></span><br><span class="line"><span class="comment">// COSMultiple(cre,target).then(res=&gt;&#123;</span></span><br><span class="line"><span class="comment">// console.log(&quot;成功&quot;)</span></span><br><span class="line"><span class="comment">// console.log(res)</span></span><br><span class="line"><span class="comment">// &#125;).catch(e=&gt;&#123;</span></span><br><span class="line"><span class="comment">// console.log(e)</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>如果是uniapp，可以把cos-wx-sdk-v5.js中的<strong>wx.uploadFile</strong> 改成 <strong>uni.uploadFile</strong>代码<img src="/assets/img/2023041503.png" alt=""></li></ul><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p>有时候会报403的错，那是因为腾讯云后台配置问题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;Code&gt;AccessDenied&lt;/Code&gt;</span><br><span class="line">&lt;Message&gt;Access Denied.&lt;/Message&gt;</span><br></pre></td></tr></table></figure><p>修改一下COS存储桶权限配置<br><img src="/assets/img/2023041502.png" alt="COS存储桶权限配置示例"><br>访问报错修改<br><img src="/assets/img/2023041501.png" alt=""></p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;服务端获取临时秘钥&quot;&gt;&lt;a href=&quot;#服务端获取临时秘钥&quot; class=&quot;headerlink&quot; title=&quot;服务端获取临时秘钥&quot;&gt;&lt;/a&gt;服务端获取临时秘钥&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://cloud.tencent.com/document/product/436/14048&quot;&gt;golang获取cos临时秘钥官方文档&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;前端直传&quot;&gt;&lt;a href=&quot;#前端直传&quot; class=&quot;headerlink&quot; title=&quot;前端直传&quot;&gt;&lt;/a&gt;前端直传&lt;/h3&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="golang" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/golang/"/>
    
    
    <category term="COS" scheme="https://tabbycute.github.io/tags/COS/"/>
    
  </entry>
  
  <entry>
    <title>widget截图和获取widget尺寸</title>
    <link href="https://tabbycute.github.io/2023/03/15/20230315widget%E6%88%AA%E5%9B%BE%E5%92%8C%E8%8E%B7%E5%8F%96widget%E5%B0%BA%E5%AF%B8/"/>
    <id>https://tabbycute.github.io/2023/03/15/20230315widget%E6%88%AA%E5%9B%BE%E5%92%8C%E8%8E%B7%E5%8F%96widget%E5%B0%BA%E5%AF%B8/</id>
    <published>2023-03-14T16:00:00.000Z</published>
    <updated>2023-05-01T07:18:17.917Z</updated>
    
    <content type="html"><![CDATA[<p>对widget进行截图</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GlobalKey globalKey = GlobalKey();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RepaintBoundary(</span><br><span class="line">key: globalKey,</span><br><span class="line">child: QrImage(</span><br><span class="line">data: logic.buildQRContent(),</span><br><span class="line">size: <span class="number">134.</span>h,</span><br><span class="line">backgroundColor: Colors.white,</span><br><span class="line">),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">Future saveImg () <span class="keyword">async</span> &#123;</span><br><span class="line">    RenderRepaintBoundary boundary = globalKey.currentContext?.findRenderObject() <span class="keyword">as</span> RenderRepaintBoundary;</span><br><span class="line">    ui.Image image = <span class="keyword">await</span> boundary.toImage(pixelRatio: <span class="number">10.0</span>);</span><br><span class="line">    ByteData? byteData = <span class="keyword">await</span> image.toByteData(format: ui.ImageByteFormat.png);</span><br><span class="line">    Uint8List? pngBytes = byteData?.buffer.asUint8List();</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">设置图片保存的路径</span></span></span><br><span class="line">    <span class="built_in">String?</span> rootPath=DataPersistence.getAppRootPath()!;</span><br><span class="line"><span class="built_in">String</span> filePath=<span class="string">&quot;<span class="subst">$rootPath</span><span class="subst">$&#123;DateTime.now().microsecondsSinceEpoch&#125;</span>.jpg&quot;</span>;</span><br><span class="line">File file = File(filePath);</span><br><span class="line"><span class="comment">///<span class="language-markdown">保存图片</span></span></span><br><span class="line">file.writeAsBytesSync(pngBytes!,flush:<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取widget的尺寸，位置啥的</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GlobalKey globalKey = GlobalKey();</span><br><span class="line"></span><br><span class="line">RenderBox? renderBox = globalKey.currentContext?.findRenderObject() <span class="keyword">as</span> RenderBox;</span><br><span class="line"><span class="built_in">print</span>(renderBox.size.height);</span><br><span class="line"><span class="built_in">print</span>(renderBox.size.width);</span><br><span class="line"><span class="keyword">var</span> offset = renderBox.localToGlobal(Offset.zero); <span class="comment">//组件坐标</span></span><br><span class="line"><span class="comment">// var underOffset = renderBox?.localToGlobal(Offset(0.0, renderBox.size.height)); //组件下方坐标</span></span><br><span class="line"><span class="built_in">print</span>(offset.dx);</span><br><span class="line"><span class="built_in">print</span>(offset.dy);</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;对widget进行截图&lt;/p&gt;
&lt;figure class=&quot;highlight dart&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;GlobalKey globalKey = GlobalKey();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;RepaintBoundary(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	key: globalKey,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	child: QrImage(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		data: logic.buildQRContent(),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		size: &lt;span class=&quot;number&quot;&gt;134.&lt;/span&gt;h,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		backgroundColor: Colors.white,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Future saveImg () &lt;span class=&quot;keyword&quot;&gt;async&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    RenderRepaintBoundary boundary = globalKey.currentContext?.findRenderObject() &lt;span class=&quot;keyword&quot;&gt;as&lt;/span&gt; RenderRepaintBoundary;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ui.Image image = &lt;span class=&quot;keyword&quot;&gt;await&lt;/span&gt; boundary.toImage(pixelRatio: &lt;span class=&quot;number&quot;&gt;10.0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ByteData? byteData = &lt;span class=&quot;keyword&quot;&gt;await&lt;/span&gt; image.toByteData(format: ui.ImageByteFormat.png);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Uint8List? pngBytes = byteData?.buffer.asUint8List();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;///&lt;span class=&quot;language-markdown&quot;&gt;设置图片保存的路径&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;String?&lt;/span&gt; rootPath=DataPersistence.getAppRootPath()!;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;built_in&quot;&gt;String&lt;/span&gt; filePath=&lt;span class=&quot;string&quot;&gt;&amp;quot;&lt;span class=&quot;subst&quot;&gt;$rootPath&lt;/span&gt;&lt;span class=&quot;subst&quot;&gt;$&amp;#123;DateTime.now().microsecondsSinceEpoch&amp;#125;&lt;/span&gt;.jpg&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	File file = File(filePath);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;///&lt;span class=&quot;language-markdown&quot;&gt;保存图片&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	file.writeAsBytesSync(pngBytes!,flush:&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;获取widget的尺寸，位置啥的&lt;/p&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
  <entry>
    <title>List&lt;String&gt;与String互转</title>
    <link href="https://tabbycute.github.io/2023/02/23/20230223DartList%E5%92%8CString%E4%BA%92%E8%BD%AC/"/>
    <id>https://tabbycute.github.io/2023/02/23/20230223DartList%E5%92%8CString%E4%BA%92%E8%BD%AC/</id>
    <published>2023-02-22T16:00:00.000Z</published>
    <updated>2023-02-23T12:03:48.445Z</updated>
    
    <content type="html"><![CDATA[<p>例1</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:convert&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line"><span class="comment">//1.List转为String</span></span><br><span class="line">  <span class="keyword">var</span> l1 = &lt;<span class="built_in">String</span>&gt;[<span class="string">&#x27;adaadad&#x27;</span>, <span class="string">&#x27;adaadad&#x27;</span>];</span><br><span class="line">  <span class="built_in">String</span> s = JsonEncoder().convert(l1);</span><br><span class="line">  <span class="built_in">print</span>(s);</span><br><span class="line"><span class="comment">//2.String转回List</span></span><br><span class="line">  <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; l2 = &lt;<span class="built_in">String</span>&gt;[];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> value <span class="keyword">in</span> JsonDecoder().convert(s)) &#123;</span><br><span class="line">    l2.add(value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">print</span>(l2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>例2</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">String</span> s =<span class="string">&#x27;[&#123;&quot;sessionID&quot;:&quot;10000002&quot;,&quot;sessionKey&quot;:&quot;d44caf6bd7184aeb&quot;,&quot;sessionType&quot;:1&#125;]&#x27;</span>;</span><br><span class="line">  <span class="built_in">List</span>&lt;<span class="built_in">Map</span>&gt; l1 = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> value <span class="keyword">in</span> JsonDecoder().convert(s)) &#123;</span><br><span class="line">    <span class="built_in">print</span>(value[<span class="string">&quot;sessionID&quot;</span>]);</span><br><span class="line">    l1.add(value);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">print</span>(l1[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;例1&lt;/p&gt;
&lt;figure class=&quot;highlight dart&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;#x27;dart:convert&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; main() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//1.List转为String&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; l1 = &amp;lt;&lt;span class=&quot;built_in&quot;&gt;String&lt;/span&gt;&amp;gt;[&lt;span class=&quot;string&quot;&gt;&amp;#x27;adaadad&amp;#x27;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;#x27;adaadad&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;String&lt;/span&gt; s = JsonEncoder().convert(l1);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(s);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//2.String转回List&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;List&lt;/span&gt;&amp;lt;&lt;span class=&quot;built_in&quot;&gt;String&lt;/span&gt;&amp;gt; l2 = &amp;lt;&lt;span class=&quot;built_in&quot;&gt;String&lt;/span&gt;&amp;gt;[];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; value &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; JsonDecoder().convert(s)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    l2.add(value);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(l2);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;例2&lt;/p&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
  <entry>
    <title>flutter插件开发(集成本地sdk)</title>
    <link href="https://tabbycute.github.io/2023/02/08/20230208flutter%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/"/>
    <id>https://tabbycute.github.io/2023/02/08/20230208flutter%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/</id>
    <published>2023-02-07T16:00:00.000Z</published>
    <updated>2023-02-09T13:41:07.941Z</updated>
    
    <content type="html"><![CDATA[<p>平台：Android，iOS；</p><p>都使用本地的sdk，解决编译器默认语法报错；</p><p>准备工作先创建插件项目安装环境什么的不需要过多介绍；</p><h3 id="安卓"><a href="#安卓" class="headerlink" title="安卓"></a>安卓</h3><h4 id="配置引入调用"><a href="#配置引入调用" class="headerlink" title="配置引入调用"></a>配置引入调用</h4><ul><li>先在android/libs引入aar包</li></ul><img src="/assets/img/202302081.png" alt="" class="cImgSizeWS30"><blockquote><p>插件中的android目录下的层级和普通项目中的android目录下的层级不太一样</p></blockquote><ul><li>在android/build.gradle里面做一些更改</li></ul><img src="/assets/img/202302082.png" alt="" class="cImgSizeWS30"><blockquote><p>api ‘io.openim:core-sdk:2.3.5-t08@aar’<br>实际路径为 ***/android/libs/core-sdk-2.3.5-t08.aar<br>***/android/libs/core-sdk.aar</p></blockquote><ul><li>然后在项目调用方法</li></ul><img src="/assets/img/202302083.png" alt="" class="cImgSizeWS30"><img src="/assets/img/202302085.png" alt="方法调用" class="cImgSizeWS30"><img src="/assets/img/202302084.png" alt="" class="cImgSizeWS30"><img src="/assets/img/202302086.png" alt="方法调用" class="cImgSizeWS30"><ul><li><p>编写平台通道(创建插件项目自动项目中自带)</p></li><li><p>然后就可以测试下。</p></li></ul><h4 id="语法错误解决"><a href="#语法错误解决" class="headerlink" title="语法错误解决"></a>语法错误解决</h4><p>可能你的项目会出现语法错误一直爆红，利用local.properties中的flutter.sdk路径来；</p><img src="/assets/img/202302088.png" alt="报红" class="cImgSizeWS50"><ul><li>android/local.properties下面添加fluttersdk路径（根据自己电脑环境来配置）</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sdk.dir</span>=<span class="string">C:\\Users\\DELL\\AppData\\Local\\Android\\Sdk</span></span><br><span class="line"><span class="attr">flutter.sdk</span>=<span class="string">G:\\flutterDev\\flutter   #根据自己电脑环境来配置</span></span><br></pre></td></tr></table></figure><ul><li>我们在android/build.gradle文件中，编写读取flutter.sdk的代码，最后使用compileOnly files依赖本地的flutter库</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取local.properties配置文件</span></span><br><span class="line"><span class="keyword">def</span> localProperties = <span class="keyword">new</span> Properties()</span><br><span class="line"><span class="keyword">def</span> localPropertiesFile = rootProject.<span class="keyword">file</span>(<span class="string">&#x27;local.properties&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> (localPropertiesFile.exists()) &#123;</span><br><span class="line">    localPropertiesFile.<span class="keyword">withReader</span>(<span class="string">&#x27;UTF-8&#x27;</span>) &#123; reader -&gt;</span><br><span class="line">        localProperties.load(reader)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取flutter的sdk路径</span></span><br><span class="line"><span class="keyword">def</span> flutterRoot = localProperties.getProperty(<span class="string">&#x27;flutter.sdk&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> (flutterRoot == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> GradleException(<span class="string">&quot;Flutter SDK not found. Define location with flutter.sdk in the local.properties file.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    compileOnly files(<span class="string">&quot;$flutterRoot/bin/cache/artifacts/engine/android-arm/flutter.jar&quot;</span>)</span><br><span class="line">    api <span class="string">&#x27;io.openim:core-sdk:2.3.5-t08@aar&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>打开android目录(直接file-open)，打开了过后会同步更新然后就ok；同步有点久。。。</li></ul><blockquote><p>我出现了没有gradle的错误，我自己复制了一份过来</p></blockquote><img src="/assets/img/202302089.png" alt="" class="cImgSizeWS30"><p>解决完成！</p><img src="/assets/img/202302087.png" alt="解决过后" class="cImgSizeWS50"><h3 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h3><p>准备工作可以参考安卓</p><p>使用mac进入到example的ios中在xcode中打开</p><p>首先项目先正常运行起来；</p><p>用我们自己的****.xcframework去替换从远程拉下来的文件；</p><blockquote><p>对iOS比较陌生，暂时不会直接在本地使用，后期学习下才行<br>这里的插件不并不是我们自己的，是一个线上版本的修改版</p></blockquote><img src="/assets/img/2023020810.png" alt="文件" class="cImgSizeWS30"><p>主要是替换掉他就ok；</p><p>报错1：<br><img src="/assets/img/2023020811.png" alt="报错1" ><br><img src="/assets/img/2023020812.png" alt="解决"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;平台：Android，iOS；&lt;/p&gt;
&lt;p&gt;都使用本地的sdk，解决编译器默认语法报错；&lt;/p&gt;
&lt;p&gt;准备工作先创建插件项目安装环境什么的不需要过多介绍；&lt;/p&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
  <entry>
    <title>flutter通过本地服务访问静态文件</title>
    <link href="https://tabbycute.github.io/2023/02/02/20230202flutter%E9%80%9A%E8%BF%87%E6%9C%AC%E5%9C%B0%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6/"/>
    <id>https://tabbycute.github.io/2023/02/02/20230202flutter%E9%80%9A%E8%BF%87%E6%9C%AC%E5%9C%B0%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6/</id>
    <published>2023-02-01T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.286Z</updated>
    
    <content type="html"><![CDATA[<p>最近遇到一个需求，给我一个h5的页面，让我直接放在app内，用webview静态访问。</p><p>这个需求本身没什么问题，但是他这个项目比较特殊是个three.js搞得任务模型，双击在浏览器打开直接就报错。</p><p>因为这个项目需要使用本地服务启动！通过本地服务来访问路径</p><p>准备三个包</p><blockquote><p>jaguar_flutter_asset: ^3.0.0      开启本地服务<br>webview_flutter: ^4.0.2        webview<br>dio: ^4.0.6                    网络访问。测试用！</p></blockquote><h3 id="注册静态文件"><a href="#注册静态文件" class="headerlink" title="注册静态文件"></a>注册静态文件</h3><p>把项目拷贝的到项目的静态目录下，并且在pubspec.yaml中注册这个项目<strong>所有的文件夹</strong>是所有的！！！否则你的项目可能会跑不起来！！！一定要是所有</p><img src="/assets/img/202302021.png" alt="目录示例" class="cImgSizeWS50"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> assets:</span><br><span class="line">...</span><br><span class="line">   - assets/web/models/</span><br><span class="line">   - assets/web/models/obj/</span><br><span class="line">   - assets/web/models/obj/male02/</span><br><span class="line">...</span><br></pre></td></tr></table></figure><blockquote><p>实际项目，目录是很多的，层级也多，手动写，难免丢失，我是用的shell脚本遍历生成的</p></blockquote><h3 id="页面使用"><a href="#页面使用" class="headerlink" title="页面使用"></a>页面使用</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHomePage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> MyHomePage(&#123;Key? key, <span class="keyword">required</span> <span class="keyword">this</span>.title&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> title;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyHomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyHomePage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">void</span> loadData() <span class="keyword">async</span>&#123;</span><br><span class="line">    <span class="keyword">final</span> server = Jaguar(address:<span class="string">&quot;127.0.0.1&quot;</span>,port: <span class="number">8000</span>);</span><br><span class="line">    server.addRoute(serveFlutterAssets());</span><br><span class="line">    <span class="keyword">await</span> server.serve(logRequests: <span class="keyword">true</span>);</span><br><span class="line">    server.log.onRecord.listen((r) =&gt; <span class="built_in">print</span>(r));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> Future.delayed(<span class="built_in">Duration</span>(seconds: <span class="number">1</span>));</span><br><span class="line">    <span class="comment">///<span class="language-markdown">测试用</span></span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> response = <span class="keyword">await</span> Dio().<span class="keyword">get</span>(<span class="string">&#x27;http://127.0.0.1:8000/web/webgl_loader_obj_mtl.html&#x27;</span>);</span><br><span class="line">      <span class="built_in">print</span>(response);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="built_in">print</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    loadView();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  WebViewController? controller;</span><br><span class="line"></span><br><span class="line">  loadView()<span class="keyword">async</span>&#123;</span><br><span class="line">    controller=WebViewController()</span><br><span class="line">    ..setJavaScriptMode(JavaScriptMode.unrestricted)</span><br><span class="line">    ..setBackgroundColor(<span class="keyword">const</span> Color(<span class="number">0x00000000</span>))</span><br><span class="line">    ..loadRequest(<span class="built_in">Uri</span>.parse(<span class="string">&#x27;http://127.0.0.1:8000/web/webgl_loader_obj_mtl.html&#x27;</span>));</span><br><span class="line">    setState(() &#123;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> implement initState</span></span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    loadData();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body:controller==null?Container():WebViewWidget(controller: controller!),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我测试的是安卓平台（公司的测试机！真机！）！现在访问页面访问不了，用dio请求下看看能否拿到页面，结果如下：</p><img src="/assets/img/202302022.png" alt="dio请求结果" class="cImgSizeWS50"><p>然后我怀疑是<a href="http://127.0.0.1:8000这个地址的原因，查了一下果然">http://127.0.0.1:8000这个地址的原因，查了一下果然</a>~</p><h4 id="安卓配置"><a href="#安卓配置" class="headerlink" title="安卓配置"></a>安卓配置</h4><ul><li>在下创建/android/app/src/main/res/xml/network_security_config.xml文件，填上配置内容：</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">network-security-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">base-config</span> <span class="attr">cleartextTrafficPermitted</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">trust-anchors</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">certificates</span> <span class="attr">src</span>=<span class="string">&quot;system&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">certificates</span> <span class="attr">src</span>=<span class="string">&quot;user&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">trust-anchors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">base-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network-security-config</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>修改android/app/src/main/AndroidManifest.xml，在application节点加入以下两个属性即可：</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;demoimg&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;$&#123;applicationName&#125;&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">&lt;!<span class="attr">--添加如下--</span>&gt;</span></span><br><span class="line">        android:usesCleartextTraffic=&quot;true&quot;</span><br><span class="line">        android:networkSecurityConfig=&quot;@xml/network_security_config&quot;</span><br><span class="line"></span><br><span class="line">        android:icon=&quot;@mipmap/ic_launcher&quot;&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br></pre></td></tr></table></figure><p>重新访问OK。ios未知！！！</p><img src="/assets/img/202302023.png" alt="" class="cImgSizeWS50">]]></content>
    
    
    <summary type="html">&lt;p&gt;最近遇到一个需求，给我一个h5的页面，让我直接放在app内，用webview静态访问。&lt;/p&gt;
&lt;p&gt;这个需求本身没什么问题，但是他这个项目比较特殊是个three.js搞得任务模型，双击在浏览器打开直接就报错。&lt;/p&gt;
&lt;p&gt;因为这个项目需要使用本地服务启动！通过本地服务来访问路径&lt;/p&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
  <entry>
    <title>某众点评的商户数据爬取</title>
    <link href="https://tabbycute.github.io/2023/01/30/20230130%E6%9F%90%E4%BC%97%E7%82%B9%E8%AF%84%E7%9A%84%E5%95%86%E6%88%B7%E6%95%B0%E6%8D%AE%E7%88%AC%E5%8F%96/"/>
    <id>https://tabbycute.github.io/2023/01/30/20230130%E6%9F%90%E4%BC%97%E7%82%B9%E8%AF%84%E7%9A%84%E5%95%86%E6%88%B7%E6%95%B0%E6%8D%AE%E7%88%AC%E5%8F%96/</id>
    <published>2023-01-29T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.286Z</updated>
    
    <content type="html"><![CDATA[<p>最近需要获取某众点评的商户数据需求就是搜索某个分类，然后获取每家店的电话地址服务评分等等各种信息；</p><p>选择地区，登录，在网站里面拿token，uuid，cookie什么的就不过多赘述；</p><p>这里只是演示分析过程实际使用根据自己需求更改，请求过多可能会导致部分接口暂时性无法访问；</p><p>前提部分准备</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Fileds = <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>)<span class="comment">///商家结果分页列表错误的集合</span></span><br><span class="line"><span class="keyword">var</span> ShopIdList = <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>)<span class="comment">///商家id集合</span></span><br><span class="line"><span class="keyword">var</span> ShopInfo = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)<span class="comment">///商家信息结果：店铺名称，类型，地址，电话，营业时间，其他...</span></span><br><span class="line"><span class="keyword">var</span> ShopPrice = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)<span class="comment">///商家信息结果：星级，评分，评论数量，人均价格，其他...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="comment">///搜索商家结果分页列表</span></span><br><span class="line"><span class="keyword">const</span> url = <span class="string">&quot;https://www.dianping.com/search/keyword/3/0_%E5%AE%A0%E7%89%A9/o3&quot;</span></span><br><span class="line"><span class="keyword">const</span> token = <span class="string">&quot;&quot;</span><span class="comment">///用户token</span></span><br><span class="line"><span class="keyword">const</span> uuid = <span class="string">&quot;uuid&quot;</span><span class="comment">///用户uuid</span></span><br><span class="line"><span class="keyword">const</span> cityId = <span class="string">&quot;3&quot;</span><span class="comment">///城市id</span></span><br><span class="line"><span class="keyword">const</span> mainCategoryId = <span class="string">&quot;25147&quot;</span><span class="comment">///分类id</span></span><br><span class="line"><span class="keyword">const</span> cookie = <span class="string">&quot;cookie&quot;</span><span class="comment">///用户cookie</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RequestPage</span><span class="params">(u <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">req, _ := http.NewRequest(<span class="string">&quot;GET&quot;</span>, u, <span class="literal">nil</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Cookie&quot;</span>, cookie)</span><br><span class="line">req.Header.Set(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;*/*&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Host&quot;</span>, <span class="string">&quot;www.dianping.com&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept-Encoding&quot;</span>, <span class="string">&quot;gzip, deflate, br&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;keep-alive&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-mobile&quot;</span>, <span class="string">&quot;?0&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-platform&quot;</span>, <span class="string">&quot;Windows&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Dest&quot;</span>, <span class="string">&quot;document&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Mode&quot;</span>, <span class="string">&quot;navigate&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Site&quot;</span>, <span class="string">&quot;same-origin&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-User&quot;</span>, <span class="string">&quot;?1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua&quot;</span>, <span class="string">`Not_A Brand;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;109&quot;, &quot;Chromium&quot;;v=109`</span>)</span><br><span class="line"></span><br><span class="line">resp, err := (&amp;http.Client&#123;&#125;).Do(req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">///可能会乱码，所以还是判断下好的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bodyReader io.Reader</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> resp.Header.Get(<span class="string">&quot;Content-Encoding&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;gzip&quot;</span>:</span><br><span class="line">bodyReader, err = gzip.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;deflate&quot;</span>:</span><br><span class="line">bodyReader = flate.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">bodyReader = resp.Body</span><br><span class="line">&#125;</span><br><span class="line">respByte, _ := ioutil.ReadAll(bodyReader)</span><br><span class="line">fmt.Println(<span class="type">string</span>(respByte))</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(respByte) &gt; <span class="number">150000</span> &#123;</span><br><span class="line">GetShopIdSlice(respByte[<span class="number">150000</span>:])</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">Fileds=<span class="built_in">append</span>(Fileds,u)</span><br><span class="line">wg.Done()</span><br><span class="line">fmt.Println(u + <span class="string">&quot;错误&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Find</span><span class="params">(slice []<span class="type">string</span>, val <span class="type">string</span>)</span></span> (<span class="type">int</span>, <span class="type">bool</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> i, item := <span class="keyword">range</span> slice &#123;</span><br><span class="line"><span class="keyword">if</span> item == val &#123;</span><br><span class="line"><span class="keyword">return</span> i, <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetShopIdSlice</span><span class="params">(data []<span class="type">byte</span>)</span></span> &#123;</span><br><span class="line">re, _ := regexp.Compile(<span class="string">`&quot;[A-Za-z0-9]&#123;16&#125;&quot;`</span>)</span><br><span class="line">all := re.FindAll(data, <span class="number">-1</span>)</span><br><span class="line"><span class="keyword">for</span> _, bytes := <span class="keyword">range</span> all &#123;</span><br><span class="line">key := strings.Replace(<span class="type">string</span>(bytes), <span class="string">`&quot;`</span>, <span class="string">``</span>, <span class="number">-1</span>)</span><br><span class="line">fmt.Println(key)</span><br><span class="line"><span class="keyword">if</span> _, found := Find(ShopIdList, key); !found &#123;</span><br><span class="line">ShopIdList = <span class="built_in">append</span>(ShopIdList, key)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetShopInfo</span><span class="params">(id <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">curl := fmt.Sprintf(<span class="string">&quot;https://www.dianping.com/ajax/json/shopDynamic/basicHideInfo?shopId=%v&amp;_token=%v&amp;uuid=%v&amp;platform=1&amp;partner=150&amp;optimusCode=10&amp;originUrl=https://www.dianping.com/shop/%v&quot;</span>, id, token, uuid, id)</span><br><span class="line"></span><br><span class="line">req, _ := http.NewRequest(<span class="string">&quot;GET&quot;</span>, curl, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">req.Header.Set(<span class="string">&quot;Cookie&quot;</span>, cookie)</span><br><span class="line">req.Header.Set(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;*/*&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Host&quot;</span>, <span class="string">&quot;www.dianping.com&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept-Encoding&quot;</span>, <span class="string">&quot;gzip, deflate, br&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;keep-alive&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-mobile&quot;</span>, <span class="string">&quot;?0&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-platform&quot;</span>, <span class="string">&quot;Windows&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Dest&quot;</span>, <span class="string">&quot;document&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Mode&quot;</span>, <span class="string">&quot;navigate&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Site&quot;</span>, <span class="string">&quot;same-origin&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-User&quot;</span>, <span class="string">&quot;?1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua&quot;</span>, <span class="string">`Not_A Brand;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;109&quot;, &quot;Chromium&quot;;v=109`</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//req.Header.Set(&quot;Content-Length&quot;, &quot;231&quot;)</span></span><br><span class="line"></span><br><span class="line">resp, err := (&amp;http.Client&#123;&#125;).Do(req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;错误--&quot;</span>,id)</span><br><span class="line">wg.Done()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">///可能会乱码，所以还是判断下好的</span></span><br><span class="line"><span class="keyword">var</span> bodyReader io.Reader</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> resp.Header.Get(<span class="string">&quot;Content-Encoding&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;gzip&quot;</span>:</span><br><span class="line">bodyReader, err = gzip.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;deflate&quot;</span>:</span><br><span class="line">bodyReader = flate.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">bodyReader = resp.Body</span><br><span class="line">&#125;</span><br><span class="line">respByte, _ := ioutil.ReadAll(bodyReader)</span><br><span class="line">ShopInfo[id] = <span class="type">string</span>(respByte)</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetShopPrice</span><span class="params">(id <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">curl := fmt.Sprintf(<span class="string">&quot;https://www.dianping.com/ajax/json/shopDynamic/reviewAndStar?shopId=%v&amp;cityId=%v&amp;mainCategoryId=%v&amp;_token=%v&amp;uuid=%v&amp;platform=1&amp;partner=150&amp;optimusCode=10&amp;originUrl=https://www.dianping.com/shop/%v&quot;</span>,</span><br><span class="line">id,</span><br><span class="line">cityId,</span><br><span class="line">mainCategoryId,</span><br><span class="line">token,</span><br><span class="line">uuid,</span><br><span class="line">id)</span><br><span class="line"></span><br><span class="line">fmt.Println(curl)</span><br><span class="line"></span><br><span class="line">req, _ := http.NewRequest(<span class="string">&quot;GET&quot;</span>, curl, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">req.Header.Set(<span class="string">&quot;Cookie&quot;</span>, cookie)</span><br><span class="line">req.Header.Set(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;*/*&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Host&quot;</span>, <span class="string">&quot;www.dianping.com&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept-Encoding&quot;</span>, <span class="string">&quot;gzip, deflate, br&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;keep-alive&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-mobile&quot;</span>, <span class="string">&quot;?0&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-platform&quot;</span>, <span class="string">&quot;Windows&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Dest&quot;</span>, <span class="string">&quot;document&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Mode&quot;</span>, <span class="string">&quot;navigate&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Site&quot;</span>, <span class="string">&quot;same-origin&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-User&quot;</span>, <span class="string">&quot;?1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua&quot;</span>, <span class="string">`Not_A Brand;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;109&quot;, &quot;Chromium&quot;;v=109`</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//req.Header.Set(&quot;Content-Length&quot;, &quot;231&quot;)</span></span><br><span class="line"></span><br><span class="line">resp, err := (&amp;http.Client&#123;&#125;).Do(req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;错误--&quot;</span>,id)</span><br><span class="line">wg.Done()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">///可能会乱码，所以还是判断下好的</span></span><br><span class="line"><span class="keyword">var</span> bodyReader io.Reader</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> resp.Header.Get(<span class="string">&quot;Content-Encoding&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;gzip&quot;</span>:</span><br><span class="line">bodyReader, err = gzip.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;deflate&quot;</span>:</span><br><span class="line">bodyReader = flate.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">bodyReader = resp.Body</span><br><span class="line">&#125;</span><br><span class="line">respByte, _ := ioutil.ReadAll(bodyReader)</span><br><span class="line">ShopPrice[id] = <span class="type">string</span>(respByte)</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///存储结果json</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetInfoFile</span><span class="params">(filePath <span class="type">string</span>, t <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">file, err := os.OpenFile(filePath, os.O_WRONLY|os.O_CREATE, <span class="number">0666</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;文件打开失败&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//及时关闭file句柄</span></span><br><span class="line"><span class="keyword">defer</span> file.Close()</span><br><span class="line"><span class="comment">//写入文件时，使用带缓存的 *Writer</span></span><br><span class="line">write := bufio.NewWriter(file)</span><br><span class="line">write.WriteString(<span class="string">&quot;&#123; \n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> t &#123;</span><br><span class="line"><span class="keyword">if</span> strings.HasPrefix(v,<span class="string">&quot;&lt;html&gt;&quot;</span>)&#123;</span><br><span class="line">data := fmt.Sprintf(<span class="string">&quot;\&quot;%v\&quot;:%v,\n&quot;</span>, k, <span class="string">`&#123;&quot;msg&quot;:&quot;403 Forrbiden&quot;&#125;`</span>)</span><br><span class="line">write.WriteString(data)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">data := fmt.Sprintf(<span class="string">&quot;\&quot;%v\&quot;:%v,\n&quot;</span>, k, v)</span><br><span class="line">write.WriteString(data)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">write.WriteString(<span class="string">&quot;&#125; \n&quot;</span>)</span><br><span class="line"><span class="comment">//Flush将缓存的文件真正写入到文件中</span></span><br><span class="line">write.Flush()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///存储店铺id和失败的店铺url</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetInfoFile2</span><span class="params">(filePath <span class="type">string</span>, t []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">file, err := os.OpenFile(filePath, os.O_WRONLY|os.O_CREATE, <span class="number">0666</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;文件打开失败&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//及时关闭file句柄</span></span><br><span class="line"><span class="keyword">defer</span> file.Close()</span><br><span class="line"><span class="comment">//写入文件时，使用带缓存的 *Writer</span></span><br><span class="line">write := bufio.NewWriter(file)</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> t &#123;</span><br><span class="line">data := fmt.Sprintf(<span class="string">&quot;%v\n&quot;</span>,v)</span><br><span class="line">write.WriteString(data)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Flush将缓存的文件真正写入到文件中</span></span><br><span class="line">write.Flush()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>token,uuid,cityId,mainCategoryId,cookie可在<strong><a href="https://www.dianping.com/ajax/json/shopDynamic/reviewAndStar">https://www.dianping.com/ajax/json/shopDynamic/reviewAndStar</a></strong>参数获取</p></blockquote><p>下面开始部分步骤</p><ul><li>搜索某个分类收集所有商户的id（需要cookie），并写入到本地文件</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">main()&#123;</span><br><span class="line">wg.Add(<span class="number">50</span>)</span><br><span class="line">RequestPage(url)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">2</span>; i &lt; <span class="number">51</span>; i++ &#123;</span><br><span class="line">urll := fmt.Sprintf(<span class="string">&quot;%vp%v&quot;</span>, url, i)</span><br><span class="line">RequestPage(urll)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">SetInfoFile2(<span class="string">&quot;./ShopIdList.txt&quot;</span>,ShopIdList)</span><br><span class="line">SetInfoFile2(<span class="string">&quot;./Fileds.txt&quot;</span>,Fileds)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///ShopIdList 内为下格式</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">k7iqTA5NY3wKmZt6</span></span><br><span class="line"><span class="comment">k6MAqHVYeFjSSlHy</span></span><br><span class="line"><span class="comment">G8ir506MAEWwZTha</span></span><br><span class="line"><span class="comment">l4Z2t8wfoLfTBe66</span></span><br><span class="line"><span class="comment">l4xW5fnwhEUwarXb</span></span><br><span class="line"><span class="comment">l3oH7kNLYmaqIjQy</span></span><br><span class="line"><span class="comment">l3i0yhjr2vYIlIgG</span></span><br><span class="line"><span class="comment">Ga6HlnZT8cD8LGLn</span></span><br><span class="line"><span class="comment">k3zNWxI6HirLcY5P</span></span><br><span class="line"><span class="comment">H7EHl8np2n0SdI1g</span></span><br><span class="line"><span class="comment">GaPMQLKeBPOhEV8a</span></span><br><span class="line"><span class="comment">H1gT7NAaoUUvem6g</span></span><br><span class="line"><span class="comment">l5NBYrCIEaMVi8s4</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><ul><li>获取商家的各种信息</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">fi, err := os.Open(<span class="string">&quot;./ShopIdList.txt&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Error: %s\n&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> fi.Close()</span><br><span class="line"></span><br><span class="line">br := bufio.NewReader(fi)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">a, _, c := br.ReadLine()</span><br><span class="line"><span class="keyword">if</span> c == io.EOF &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">ShopIdList=<span class="built_in">append</span>(ShopIdList,<span class="type">string</span>(a))</span><br><span class="line"><span class="comment">//fmt.Println(string(a))</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;当前共有店铺：&quot;</span>,<span class="built_in">len</span>(ShopIdList))</span><br><span class="line">time.Sleep(time.Second*<span class="number">2</span>)</span><br><span class="line"><span class="comment">//测试一下，获取部分信息</span></span><br><span class="line"><span class="comment">//下面这个会出现非并发安全的错误，使用读写锁就好了，我这里只是测试一下能否获取数据</span></span><br><span class="line">a:=ShopIdList[:<span class="number">30</span>]</span><br><span class="line">wg.Add(<span class="built_in">len</span>(a)*<span class="number">2</span>)</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> a &#123;</span><br><span class="line"><span class="keyword">go</span> GetShopPrice(v)</span><br><span class="line"><span class="keyword">go</span> GetShopInfo(v)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">time.Sleep(time.Second*<span class="number">2</span>)</span><br><span class="line">SetInfoFile(<span class="string">&quot;./Ainfo.json&quot;</span>, ShopInfo)</span><br><span class="line">SetInfoFile(<span class="string">&quot;./Aprice.json&quot;</span>, ShopPrice)</span><br></pre></td></tr></table></figure><p>结果展示</p><img src="/assets/img/202301301.png" alt="Aprice.json" class="cImgSizeWS50"><img src="/assets/img/202301302.png" alt="Ainfo.json" class="cImgSizeWS50"><p>问题来了他的部分信息是html标签和一些代码</p><p>在网页审查他的元素</p><img src="/assets/img/202301303.png" ><p>原来是用了字体文件怪不得，网页复制都是乱码的</p><img src="/assets/img/202301304.png" alt="woff"><p>解决下载网页中所有的woff文件，然后把上面的json文件引入到html中循环展示，写点样式，就可以查看了</p><p>完结！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近需要获取某众点评的商户数据需求就是搜索某个分类，然后获取每家店的电话地址服务评分等等各种信息；&lt;/p&gt;
&lt;p&gt;选择地区，登录，在网站里面拿token，uuid，cookie什么的就不过多赘述；&lt;/p&gt;
&lt;p&gt;这里只是演示分析过程实际使用根据自己需求更改，请求过多可能会导致部分接口暂时性无法访问；&lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://tabbycute.github.io/categories/golang/"/>
    
    
    <category term="golang" scheme="https://tabbycute.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>imgly超强编辑器在flutter中的简单使用</title>
    <link href="https://tabbycute.github.io/2022/12/10/20221210imgly%E8%B6%85%E5%BC%BA%E5%9B%BE%E7%89%87%E7%BC%96%E8%BE%91%E8%A7%86%E9%A2%91%E7%BC%96%E8%BE%91%E5%88%9B%E6%84%8F%E7%BC%96%E8%BE%91%E4%BD%BF%E7%94%A8/"/>
    <id>https://tabbycute.github.io/2022/12/10/20221210imgly%E8%B6%85%E5%BC%BA%E5%9B%BE%E7%89%87%E7%BC%96%E8%BE%91%E8%A7%86%E9%A2%91%E7%BC%96%E8%BE%91%E5%88%9B%E6%84%8F%E7%BC%96%E8%BE%91%E4%BD%BF%E7%94%A8/</id>
    <published>2022-12-09T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.285Z</updated>
    
    <content type="html"><![CDATA[<p>先给出官网： <a href="https://img.ly/">https://img.ly/</a></p><p>flutter插件地址： <a href="https://pub.flutter-io.cn/packages/photo_editor_sdk">https://pub.flutter-io.cn/packages/photo_editor_sdk</a></p><p>下面开始集成（会需要一个选择图片的插件，这个自己解决，或者使用静态文件）</p><ul><li>通过打开 android/build.gradle 文件（不是 android/app/build.gradle）并更改以下块来添加 img.ly 存储库和插件：</li></ul><blockquote><p>为了更新适用于 Android 的 PhotoEditor SDK，请将版本字符串 10.3.1 替换为较新的版本。</p><p>如果版本和你pub的版本不对可能会报错，根据报错的版本来修改下面的插件版本就好了，去查看changelog</p></blockquote><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">-   ext.kotlin_version = <span class="string">&#x27;1.3.50&#x27;</span></span><br><span class="line">+   ext.kotlin_version = <span class="string">&#x27;1.5.32&#x27;</span> <span class="comment">// Minimum version.</span></span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        mavenCentral()</span><br><span class="line">+       maven &#123; url <span class="string">&quot;https://artifactory.img.ly/artifactory/imgly&quot;</span> &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">+       <span class="keyword">classpath</span> <span class="string">&#x27;ly.img.android.sdk:plugin:10.4.1&#x27;</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>仍然在 android/build.gradle 文件（不是 android/app/build.gradle）中，在底部添加这些行：</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        maven &#123; url <span class="string">&#x27;https://artifactory.img.ly/artifactory/imgly&#x27;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>android/build.gradle 完整配置如下</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    ext.kotlin_version = <span class="string">&#x27;1.6.10&#x27;</span></span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">        maven &#123; url <span class="string">&quot;https://artifactory.img.ly/artifactory/imgly&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;com.android.tools.build:gradle:7.1.2&#x27;</span></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;ly.img.android.sdk:plugin:10.4.1&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">        maven &#123; url <span class="string">&#x27;https://artifactory.img.ly/artifactory/imgly&#x27;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在 android/app/build.gradle 文件（不是 android/build.gradle）中，您需要将 minSdkVersion 修改为至少 21。我们还建议将 buildToolsVersion 更新为 31.0.0 或更高版本，并将 compileSdkVersion 更新为 31 或更高</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">compileSdkVersion <span class="number">33</span></span><br><span class="line">ndkVersion flutter.ndkVersion</span><br><span class="line">buildToolsVersion <span class="string">&quot;31.0.0&quot;</span></span><br><span class="line"></span><br><span class="line">compileOptions &#123;</span><br><span class="line"><span class="keyword">sourceCompatibility</span> JavaVersion.VERSION_1_8</span><br><span class="line"><span class="keyword">targetCompatibility</span> JavaVersion.VERSION_1_8</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">defaultConfig &#123;</span><br><span class="line">applicationId <span class="string">&quot;com.example.demoimg&quot;</span></span><br><span class="line">minSdkVersion <span class="number">22</span></span><br><span class="line">targetSdkVersion flutter.targetSdkVersion</span><br><span class="line">versionCode flutterVersionCode.<span class="keyword">toInteger</span>()</span><br><span class="line">versionName flutterVersionName</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>在同一个文件中，通过在应用插件下添加以下行来配置适用于 Android 的 PhotoEditor SDK</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> flutterVersionName = localProperties.getProperty(<span class="string">&#x27;flutter.versionName&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> (flutterVersionName == <span class="keyword">null</span>) &#123;</span><br><span class="line">    flutterVersionName = <span class="string">&#x27;1.0&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply plugin: <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line">apply plugin: <span class="string">&#x27;kotlin-android&#x27;</span></span><br><span class="line">apply <span class="keyword">from</span>: <span class="string">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///添加如下部分</span></span><br><span class="line">apply plugin: <span class="string">&#x27;ly.img.android.sdk&#x27;</span></span><br><span class="line">apply plugin: <span class="string">&#x27;kotlin-android&#x27;</span></span><br><span class="line">apply <span class="keyword">from</span>: <span class="string">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br><span class="line">imglyConfig &#123;</span><br><span class="line">    modules &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:text&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:focus&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:frame&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:brush&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:filter&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:sticker&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:overlay&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:transform&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:adjustment&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:text-design&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// This module is big, remove the serializer if you don&#x27;t need that feature.</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;backend:serializer&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remove the asset packs you don&#x27;t need, these are also big in size.</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:font-basic&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:frame-basic&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:filter-basic&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:overlay-basic&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:sticker-shapes&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:sticker-emoticons&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;backend:sticker-smart&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;backend:background-removal&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>flutter 使用</li></ul><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">获取一个图片</span></span></span><br><span class="line"><span class="keyword">final</span> <span class="built_in">List</span>&lt;AssetEntity&gt;? result = <span class="keyword">await</span> AssetPicker.pickAssets(context);</span><br><span class="line"><span class="built_in">print</span>(result?.first.relativePath);</span><br><span class="line"><span class="keyword">if</span>(result==<span class="keyword">null</span>)<span class="keyword">return</span>;</span><br><span class="line">File? f=<span class="keyword">await</span> result.first.file;</span><br><span class="line"><span class="keyword">if</span>(f==<span class="keyword">null</span>)<span class="keyword">return</span>;</span><br><span class="line"><span class="built_in">print</span>(f.path);</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">解除水印，免费版是有水印的，需要购买获取证书</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将不带扩展名的文件路径传递给unlockWithLicense函数以解锁 iOS 和 Android：</span></span><br><span class="line">PESDK.unlockWithLicense(<span class="string">&quot;assets/pesdk_license&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">传入一个图片地址</span></span></span><br><span class="line">PESDK.openEditor(image:f.path);</span><br></pre></td></tr></table></figure><img src="/assets/img/202212101.gif" alt="效果展示">]]></content>
    
    
    <summary type="html">&lt;p&gt;先给出官网： &lt;a href=&quot;https://img.ly/&quot;&gt;https://img.ly/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;flutter插件地址： &lt;a href=&quot;https://pub.flutter-io.cn/packages/photo_editor_sdk&quot;&gt;https://pub.flutter-io.cn/packages/photo_editor_sdk&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;下面开始集成（会需要一个选择图片的插件，这个自己解决，或者使用静态文件）&lt;/p&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
  <entry>
    <title>图片选择和图片编辑插件魔改以及iOS打包问题的解决</title>
    <link href="https://tabbycute.github.io/2022/12/05/20221205flutter%E6%8F%92%E4%BB%B6%E5%90%88%E5%B9%B6/"/>
    <id>https://tabbycute.github.io/2022/12/05/20221205flutter%E6%8F%92%E4%BB%B6%E5%90%88%E5%B9%B6/</id>
    <published>2022-12-04T16:00:00.000Z</published>
    <updated>2023-01-16T15:22:22.557Z</updated>
    
    <content type="html"><![CDATA[<p>最近在项目遇见一个需求，是选择图片。于是我在pub上面找了这款<a href="https://pub.flutter-io.cn/packages/wechat_assets_picker">仿微信图片视频选择插件</a>感觉还挺好的~</p><p>经过上线之后老板觉得不方便，微信比起来不能编辑图片，于是我有找了另一款<a href="https://pub.flutter-io.cn/packages/image_editor_dove">编辑图片的插件</a></p><p>现在好了，编辑图片和选择图片的功能都有了，但是他并不能像微信选择图片的那样在预览的时候编辑图片。没办法，只能硬着头皮在现在插件上改了。</p><div class="cImgBoxCenter"><img src="/assets/img/202212051.jpg" class="cImgSizeW325" alt="仿微信图片视频选择插件"><img src="/assets/img/202212052.gif" class="cImgSizeW325" alt="编辑图片的插件"></div><h3 id="集成插件"><a href="#集成插件" class="headerlink" title="集成插件"></a>集成插件</h3><p>要改代码我们需要把插件静态集成到我们的项目中。</p><p>首先在我们需要在本地找到插件需要在flutter的SDK目录下<strong>\.pub-cache\hosted\pub.dartlang.org</strong>找到我们的插件wechat_assets_picker-7.3.4（什么版本看你自己）</p><p>修改之前</p><p><img src="/assets/img/202212053.png"></p><p>修改之后</p><div class="cImgBoxCenter"><img src="/assets/img/202212054.png" alt=""><img src="/assets/img/202212055.png" alt=""></div><h3 id="使用插件"><a href="#使用插件" class="headerlink" title="使用插件"></a>使用插件</h3><p>在plugins/wechat_assets_picker****/pubspec.yaml中添加插件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">extended_image:</span> <span class="string">^6.2.0</span></span><br><span class="line"><span class="attr">photo_manager:</span> <span class="string">^2.1.4</span></span><br><span class="line"><span class="attr">provider:</span> <span class="string">^6.0.2</span></span><br><span class="line"><span class="attr">video_player:</span> <span class="string">^2.4.0</span></span><br><span class="line"><span class="attr">image_editor_dove:</span> <span class="string">^0.0.2</span></span><br></pre></td></tr></table></figure><p>修改代码第一个位置，需要添加一个按钮，在<strong>lib/src/delegates/asset_picker_viewer_builder_delegate.dart</strong>文件中对**Widget selectButton(BuildContext context)**次函数做如下修改</p><h5 id="进入编辑页面"><a href="#进入编辑页面" class="headerlink" title="进入编辑页面"></a>进入编辑页面</h5><ul><li>预览大图页面-&gt;图片编辑页面</li></ul><h5 id="编辑页面返回（这里是我的业务需求）"><a href="#编辑页面返回（这里是我的业务需求）" class="headerlink" title="编辑页面返回（这里是我的业务需求）"></a>编辑页面返回（这里是我的业务需求）</h5><ul><li>如果编辑的图片保存成功：图片编辑页面-&gt;预览大图页面-&gt;预览小图页面-&gt;业务页面</li><li>如果编辑的图片未保存：图片编辑页面-&gt;预览大图页面</li></ul><blockquote><p>注意这里需要统一一下路由返回参数 <strong>List&lt;AssetEntity&gt;?</strong></p></blockquote><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">Semantics(</span><br><span class="line">selected: isSelected,</span><br><span class="line">label: semanticsTextDelegate.select,</span><br><span class="line">onTap: () =&gt; onChangingSelected(context, asset, isSelected),</span><br><span class="line">onTapHint: semanticsTextDelegate.select,</span><br><span class="line">excludeSemantics: <span class="keyword">true</span>,</span><br><span class="line">child: Row(</span><br><span class="line">  mainAxisAlignment: MainAxisAlignment.spaceBetween,</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line"><span class="comment">/// <span class="language-markdown">下面是就是添加核心代码的地方</span></span></span><br><span class="line"><span class="keyword">if</span>(previewAssets[currentIndex].type==AssetType.image)InkWell(</span><br><span class="line">  child: Text(<span class="string">&quot;编辑&quot;</span>),</span><br><span class="line">  onTap: ()<span class="keyword">async</span>&#123;</span><br><span class="line">File? f=<span class="keyword">await</span> previewAssets[currentIndex].file;</span><br><span class="line">Directory? savePath=f?.parent;</span><br><span class="line"><span class="comment">/// <span class="language-markdown">预览大图页面-&gt;图片编辑页面</span></span></span><br><span class="line"><span class="keyword">var</span> data = <span class="keyword">await</span> Navigator.push(context, MaterialPageRoute(builder: (context) &#123;</span><br><span class="line">  <span class="keyword">return</span> ImageEditor(</span><br><span class="line">originImage:f!,</span><br><span class="line">savePath: savePath,</span><br><span class="line">  );</span><br><span class="line">&#125;));</span><br><span class="line"><span class="comment">/// <span class="language-markdown">如果编辑的图片保存成功：图片编辑页面-&gt;预览大图页面-&gt;预览小图页面-&gt;业务页面</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">如果编辑的图片保存成功：图片编辑页面-&gt;预览大图页面</span></span></span><br><span class="line"><span class="keyword">if</span> (data <span class="keyword">is</span> EditorImageResult) &#123;</span><br><span class="line">  <span class="built_in">List</span>&lt;AssetEntity&gt;? result=[];</span><br><span class="line">  result.add(AssetEntity(</span><br><span class="line">  width: data.imgWidth,</span><br><span class="line">  typeInt: <span class="number">0</span>,</span><br><span class="line">  height: data.imgHeight,</span><br><span class="line">  id:<span class="string">&quot;editImg&quot;</span>,</span><br><span class="line">  relativePath:data.newFile.path</span><br><span class="line">  ));</span><br><span class="line">  Navigator.pop(context,result);</span><br><span class="line">&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">),</span><br><span class="line">Row(</span><br><span class="line">  mainAxisAlignment: MainAxisAlignment.end,</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line"><span class="comment">///<span class="language-markdown">tabby</span></span></span><br><span class="line"><span class="keyword">if</span> (isAppleOS)</span><br><span class="line">  _appleOSSelectButton(c, isSelected, asset)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  _androidSelectButton(c, isSelected, asset),</span><br><span class="line"><span class="keyword">if</span> (!isAppleOS)</span><br><span class="line">  ScaleText(</span><br><span class="line">textDelegate.select,</span><br><span class="line">style: <span class="keyword">const</span> TextStyle(fontSize: <span class="number">17</span>, height: <span class="number">1</span>),</span><br><span class="line">semanticsLabel: semanticsTextDelegate.select,</span><br><span class="line">  ),</span><br><span class="line">  ],</span><br><span class="line">),</span><br><span class="line">  ],</span><br><span class="line">),</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src="/assets/img/202212056.gif" class="cImgSizeW325" alt="完美！nice"><h3 id="打包与发布"><a href="#打包与发布" class="headerlink" title="打包与发布"></a>打包与发布</h3><p>安卓打包非常完美，一点问题都没有。但是iOS上却有问题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bz@bdeMac-mini ios % pod install</span><br><span class="line">Analyzing dependencies</span><br><span class="line">[!] The name of the given podspec `image_editor` doesn&#x27;t match the expected one `image_editor_dove`</span><br><span class="line"></span><br><span class="line">[!] Automatically assigning platform `iOS` with version `13.0` on target `Runner` because no platform was specified. Please specify a platform for this target in your Podfile. See `https://guides.cocoapods.org/syntax/podfile.html#platform`.</span><br></pre></td></tr></table></figure><p>他说image_editor下面没有一个名为image_editor_dove，类型为podspec的文件</p><p>我们进入到ios/.symlinks/plugins/image_editor_dove路径下面，发现确实没有image_editor_dove.podspec，</p><p>但是有一个image_editor.podspec，试着将其重新命名为image_editor_dove.podspec，同时修改此文件中的s.name = ‘image_editor_dove’</p><p>pod install 可以正常执行了</p><p>项目运行的时候xcode又出现了一个错误</p><p><strong>image_editor-Swift.h 大概意思这个文件引入不进来，不存在</strong></p><p>ios/Classes/ImageEditorPlugin.m 中修改image_editor全都修改为image_editor_dove</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;ImageEditorPlugin.h&quot;</span><br><span class="line">#if __has_include(&lt;image_editor_dove/image_editor_dove-Swift.h&gt;)</span><br><span class="line">#import &lt;image_editor_dove/image_editor_dove-Swift.h&gt;</span><br><span class="line">#else</span><br><span class="line">// Support project import fallback if the generated compatibility header</span><br><span class="line">// is not copied when this plugin is created as a library.</span><br><span class="line">// https://forums.swift.org/t/swift-static-libraries-dont-copy-generated-objective-c-header/19816</span><br><span class="line">#import &quot;image_editor_dove-Swift.h&quot;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">@implementation ImageEditorPlugin</span><br><span class="line">+ (void)registerWithRegistrar:(NSObject&lt;FlutterPluginRegistrar&gt;*)registrar &#123;</span><br><span class="line">  [SwiftImageEditorPlugin registerWithRegistrar:registrar];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>打包成功！</p><p>猝！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近在项目遇见一个需求，是选择图片。于是我在pub上面找了这款&lt;a href=&quot;https://pub.flutter-io.cn/packages/wechat_assets_picker&quot;&gt;仿微信图片视频选择插件&lt;/a&gt;感觉还挺好的~&lt;/p&gt;
&lt;p&gt;经过上线之后老板觉得不方便，微信比起来不能编辑图片，于是我有找了另一款&lt;a href=&quot;https://pub.flutter-io.cn/packages/image_editor_dove&quot;&gt;编辑图片的插件&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;现在好了，编辑图片和选择图片的功能都有了，但是他并不能像微信选择图片的那样在预览的时候编辑图片。没办法，只能硬着头皮在现在插件上改了。&lt;/p&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
  <entry>
    <title>在React项目中IM富文本输入框</title>
    <link href="https://tabbycute.github.io/2022/11/15/20221115%E8%87%AA%E5%AE%9A%E4%B9%89im%E7%BC%96%E8%BE%91%E5%99%A8/"/>
    <id>https://tabbycute.github.io/2022/11/15/20221115%E8%87%AA%E5%AE%9A%E4%B9%89im%E7%BC%96%E8%BE%91%E5%99%A8/</id>
    <published>2022-11-14T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.284Z</updated>
    
    <content type="html"><![CDATA[<p>im中的编辑器实际上是一个富文本的编辑器改好的成品，找了很多都没有适合</p><p>最终还是自己找一个插件二次封装一下吧（基于<a href="https://www.kancloud.cn/liuwave/quill/1409423">quill</a>），实际上大部分富文本编辑器都是基于<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Global_attributes/contenteditable">contenteditable</a>的高度封装，有兴趣可以了解下。</p><p>需要@用户，表情就ok</p><p>先安装依赖</p><blockquote><p>npm i react-quill –save<br>“react-quill”: “^2.0.0”<br>npm i quill-image-drop-module –save<br>“quill-image-drop-module”: “^1.0.3”</p></blockquote><img src="/assets/img/202211151.gif" alt="效果展示"><p>核心代码(测试demo)</p><blockquote><p>还没写输入部分。js添加的内容测试下</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Quill</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react-quill&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;react-quill/dist/quill.snow.css&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ImageDrop</span> &#125; <span class="keyword">from</span> <span class="string">&quot;quill-image-drop-module&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;theme,<span class="title class_">Tooltip</span>&#125; <span class="keyword">from</span> <span class="string">&quot;antd&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;useEffect&#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">TalkVideoCall</span>,<span class="title class_">TalkSingCall</span>,<span class="title class_">TalkFile</span>,<span class="title class_">TalkPhotos</span>,<span class="title class_">TalkEmoji</span>,<span class="title class_">TalkAtIcon</span>,<span class="title class_">TalkPicture</span>,<span class="title class_">TalkVideo</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@/strings/imgs&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Gap</span> <span class="keyword">from</span> <span class="string">&quot;../gap.jsx&quot;</span>;</span><br><span class="line"><span class="comment">///拖拽图片</span></span><br><span class="line"><span class="title class_">Quill</span>.<span class="title function_">register</span>(<span class="string">&quot;modules/imageDrop&quot;</span>, <span class="title class_">ImageDrop</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">///去除剪贴板中文字的样式</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ClipboardTextHandler</span> = (<span class="params">node, delta</span>) =&gt; &#123;</span><br><span class="line">    delta.<span class="property">ops</span> = delta.<span class="property">ops</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">op</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">insert</span>: op.<span class="property">insert</span>,</span><br><span class="line">            <span class="comment">///修改插入图片的大小,当然这里肯定有些判断</span></span><br><span class="line">            <span class="comment">// attributes: &#123; width: &quot;50px&quot;, height: &quot;50px&quot; &#125;</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> delta;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 继承相关 https://kang-bing-kui.gitbook.io/quill/other/parchment</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///at用户插入</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Embed</span> = <span class="title class_">Quill</span>.<span class="keyword">import</span>(<span class="string">&quot;blots/embed&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MsgAtUser</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Embed</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">create</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(value.<span class="property">tagName</span>&amp;&amp;(value.<span class="property">tagName</span>.<span class="title function_">toLowerCase</span>()===<span class="string">&quot;at&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> node = <span class="variable language_">super</span>.<span class="title function_">create</span>();</span><br><span class="line">        node.<span class="property">innerText</span> = value.<span class="property">text</span>;</span><br><span class="line">        node.<span class="title function_">setAttribute</span>(<span class="string">&quot;id&quot;</span>, value.<span class="property">id</span>);</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">margin</span> = <span class="string">&quot;0 4px&quot;</span>;</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">fontWeight</span> = <span class="string">&quot;600&quot;</span>;</span><br><span class="line">        node.<span class="title function_">setAttribute</span>(<span class="string">&quot;contenteditable&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">///撤消操作</span></span><br><span class="line">    <span class="keyword">static</span> value=<span class="function">(<span class="params">node</span>)=&gt;</span>node</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">MsgAtUser</span>.<span class="property">blotName</span> = <span class="string">&quot;MsgAtUser&quot;</span>;</span><br><span class="line"><span class="title class_">MsgAtUser</span>.<span class="property">tagName</span> = <span class="string">&quot;at&quot;</span>;</span><br><span class="line"><span class="title class_">Quill</span>.<span class="title function_">register</span>(<span class="title class_">MsgAtUser</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">///表情</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MsgEmoji</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Embed</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">create</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;create&quot;</span>,value)</span><br><span class="line"></span><br><span class="line">        <span class="comment">///通过id判断是否需要格式化，防止误伤</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(value)===<span class="string">&quot;[object HTMLImageElement]&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> node = <span class="variable language_">super</span>.<span class="title function_">create</span>();</span><br><span class="line">        node.<span class="title function_">setAttribute</span>(<span class="string">&quot;src&quot;</span>, value.<span class="property">src</span>);</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">width</span> = <span class="string">&quot;16px&quot;</span>;</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">height</span> = <span class="string">&quot;16px&quot;</span>;</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&quot;red&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">///撤消操作</span></span><br><span class="line">    <span class="keyword">static</span> value=<span class="function"><span class="params">node</span>=&gt;</span>node</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">MsgEmoji</span>.<span class="property">blotName</span> = <span class="string">&quot;MsgEmoji&quot;</span>;</span><br><span class="line"><span class="title class_">MsgEmoji</span>.<span class="property">tagName</span> = <span class="string">&quot;img&quot;</span>;</span><br><span class="line"><span class="title class_">Quill</span>.<span class="title function_">register</span>(<span class="title class_">MsgEmoji</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">InputTools</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; token &#125; = theme.<span class="title function_">useToken</span>();</span><br><span class="line">    <span class="keyword">const</span> &#123;colorText,colorBorder&#125;=token;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">className</span>=<span class="string">&quot;flex-ltr-ac-js&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">style</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">width:</span>&quot;<span class="attr">100</span>%&quot;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">padding:</span>&quot;<span class="attr">12px</span> <span class="attr">15px</span> <span class="attr">0</span>&quot;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex-ltr-ac-js&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;alignItems:</span>&quot;<span class="attr">start</span>&quot;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;表情&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkEmoji</span> <span class="attr">size</span>=<span class="string">&#123;28&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Gap</span> <span class="attr">w</span>=<span class="string">&#123;16&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkPicture</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Gap</span> <span class="attr">w</span>=<span class="string">&#123;16&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkVideo</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Gap</span> <span class="attr">w</span>=<span class="string">&#123;16&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkFile</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;/*<span class="tag">&lt;<span class="name">TalkPhotos</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;/</span>&gt;</span>*/&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex-ltr-ac-js&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkVideoCall</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Gap</span> <span class="attr">w</span>=<span class="string">&#123;16&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkSingCall</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">ChatTalkInput</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; token &#125; = theme.<span class="title function_">useToken</span>();</span><br><span class="line">    <span class="keyword">const</span> &#123;colorBgContainer,colorBorder&#125;=token;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> quill=<span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        quill = <span class="keyword">new</span> <span class="title class_">Quill</span>(<span class="string">&quot;#editor&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">modules</span>: &#123;</span><br><span class="line">                <span class="attr">toolbar</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">clipboard</span>: &#123;</span><br><span class="line">                    <span class="attr">matchers</span>: [[<span class="title class_">Node</span>.<span class="property">ELEMENT_NODE</span>, <span class="title class_">ClipboardTextHandler</span>]],</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">theme</span>: <span class="string">&quot;snow&quot;</span>,</span><br><span class="line">            <span class="attr">imageDrop</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        quill.<span class="title function_">insertText</span>(<span class="number">0</span>,<span class="string">&quot;今天下午全都去开会&quot;</span>,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        <span class="comment">///插入at</span></span><br><span class="line">        quill.<span class="title function_">insertEmbed</span>(<span class="number">9</span>,<span class="string">&quot;MsgAtUser&quot;</span>,&#123; <span class="attr">text</span>: <span class="string">`@所有人`</span>, <span class="attr">id</span>: <span class="string">&quot;0&quot;</span> &#125;,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        quill.<span class="title function_">insertText</span>(<span class="number">10</span>,<span class="string">&quot;都要到&quot;</span>,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        <span class="comment">///插入表情</span></span><br><span class="line">        quill.<span class="title function_">insertEmbed</span>(<span class="number">0</span>,<span class="string">&quot;MsgEmoji&quot;</span>,&#123;<span class="attr">src</span>: <span class="string">&quot;https://www.w3school.com.cn/i/eg_tulip.jpg&quot;</span>, <span class="attr">code</span>: <span class="string">&quot;0&quot;</span> &#125;,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        quill.<span class="title function_">insertText</span>(<span class="number">0</span>,<span class="string">&quot;通知！！！！！！！&quot;</span>,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        <span class="comment">// quill.setSelection(1, Quill.sources.SILENT);</span></span><br><span class="line">    &#125;, []);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">///当输入框失去焦点，后如果输入框里面全是Embed，下次则无法聚焦！！！！只能重新聚焦</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">setSelection</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">        <span class="comment">///先要判断一下，防止误伤！！！</span></span><br><span class="line">        <span class="comment">// quill.setSelection(1, Quill.sources.SILENT);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">className</span>=<span class="string">&quot;flex-ttb-ac-js&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">style</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">height:</span>&quot;<span class="attr">230px</span>&quot;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">width:</span>&quot;<span class="attr">100</span>%&quot;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">border:</span>&quot;<span class="attr">none</span>&quot;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">InputTools</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;editor&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;setSelection&#125;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width:</span>&quot;<span class="attr">100</span>%&quot;,<span class="attr">height:</span>&quot;<span class="attr">100px</span>&quot;,<span class="attr">flex:</span>&quot;<span class="attr">1</span>&quot;,<span class="attr">border:</span>&quot;<span class="attr">none</span>&quot;&#125;&#125;&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;im中的编辑器实际上是一个富文本的编辑器改好的成品，找了很多都没有适合&lt;/p&gt;
&lt;p&gt;最终还是自己找一个插件二次封装一下吧（基于&lt;a href=&quot;https://www.kancloud.cn/liuwave/quill/1409423&quot;&gt;quill&lt;/a&gt;），实际上大部分富文本编辑器都是基于&lt;a href=&quot;https://developer.mozilla.org/zh-CN/docs/Web/HTML/Global_attributes/contenteditable&quot;&gt;contenteditable&lt;/a&gt;的高度封装，有兴趣可以了解下。&lt;/p&gt;
&lt;p&gt;需要@用户，表情就ok&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="react" scheme="https://tabbycute.github.io/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>浏览器中的模块化(ES Module,import-maps)</title>
    <link href="https://tabbycute.github.io/2022/11/11/20221111%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96/"/>
    <id>https://tabbycute.github.io/2022/11/11/20221111%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96/</id>
    <published>2022-11-10T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.284Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ES-Module"><a href="#ES-Module" class="headerlink" title="ES Module"></a>ES Module</h3><p>ES Module 是 JavaScript 模块化的官方标准， 目前主流的浏览器已经实现，不依赖任何第三方加载器 (Loader) 即可使用。</p><blockquote><p><a href="https://caniuse.com/mdn-javascript_statements_import">点击此链接查看最新的浏览器支持情况</a></p></blockquote><p>浏览器中只支持相对路径或者绝对路径下的 ES 模块 (./, ../, /, http://, https://) ， 同时也受服务器跨域请求策略、 HTTPS 策略的约束。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// my_func.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">my_func</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;script type=<span class="string">&quot;module&quot;</span>&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; my_func &#125; <span class="keyword">from</span> <span class="string">&#x27;./my_func.js&#x27;</span>;</span><br><span class="line"><span class="title function_">my_func</span>();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="import-maps"><a href="#import-maps" class="headerlink" title="import-maps"></a>import-maps</h3><p>import-maps 就是为了解决浏览器中的全局模块而出现的， 目前浏览器的支持情况如下图所示， 基于 Chromium 的浏览器已经实现这个功能。</p><p>这个script 标签必须放在 document 中的中第一个 type=”module” 标签之前（最好是在<head>中），以便在进行模块解析之前对它进行解析。</p><blockquote><p><a href="https://caniuse.com/import-maps">点击此链接查看最新的浏览器支持情况</a></p></blockquote><p>import-maps 使用 Json 的形式来定义浏览器中的全局模块：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;importmap&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;imports&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;three&quot;</span>: <span class="string">&quot;./build/three.module.js&quot;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;three/addons/&quot;</span>: <span class="string">&quot;./jsm/&quot;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;react-dom&quot;</span>: <span class="string">&quot;https://cdn.skypack.dev/react-dom&quot;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这个标签中应该是严格的json格式，注意逗号的使用，如下<strong>错误实例</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;importmap&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;imports&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;three&quot;</span>: <span class="string">&quot;./build/three.module.js&quot;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;three/addons/&quot;</span>: <span class="string">&quot;./jsm/&quot;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;react-dom&quot;</span>: <span class="string">&quot;https://cdn.skypack.dev/react-dom&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>上面逗号引起浏览器报错</p></blockquote><blockquote><p>Failed to resolve module specifier “vue”. Relative references must start with either “/“, “./“, or “../“.</p></blockquote><h3 id="在浏览器中使用-import-maps-和-ES-模块示例"><a href="#在浏览器中使用-import-maps-和-ES-模块示例" class="headerlink" title="在浏览器中使用 import-maps 和 ES 模块示例"></a>在浏览器中使用 import-maps 和 ES 模块示例</h3><ul><li>简单测试demo</li></ul><p>index.html<br>/web/aaa.js</p><blockquote><p>因为使用的本地的，记得本地服务启动</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const Test = ()=&gt;&#123;</span><br><span class="line">    console.log(&quot;sdadadada&quot;)</span><br><span class="line">&#125;</span><br><span class="line">export &#123; Test,&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-cn&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vue<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;root&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;importmap&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;imports&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;@t/&quot;</span>: <span class="string">&quot;./web/&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">import</span> &#123;<span class="title class_">Test</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;@t/aaa.js&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">Test</span>()</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>在浏览器中直接使用 ArcGIS JS API 4.20 提供的 ES 模块</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>ArcGIS JS API ES Module Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">id</span>=<span class="string">&quot;mapstyle-link&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://js.arcgis.com/4.20/@arcgis/core/assets/esri/themes/dark/main.css&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-tag">html</span>,<span class="selector-tag">body</span>,<span class="selector-id">#mapview</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">width</span>: <span class="number">100%</span>; <span class="attribute">height</span>: <span class="number">100%</span>; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>; <span class="attribute">overflow</span>: hidden;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css">  </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;mapview&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;importmap&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;imports&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;@arcgis/&quot;</span>: <span class="string">&quot;https://js.arcgis.com/4.20/@arcgis/&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> <span class="title class_">Map</span> <span class="keyword">from</span> <span class="string">&#x27;@arcgis/core/Map.js&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> <span class="title class_">MapView</span> <span class="keyword">from</span> <span class="string">&#x27;@arcgis/core/views/MapView.js&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> * <span class="keyword">as</span> intl <span class="keyword">from</span> <span class="string">&quot;@arcgis/core/intl.js&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">  intl.<span class="title function_">setLocale</span>(<span class="string">&#x27;zh-CN&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">basemap</span>: <span class="string">&#x27;dark-gray-vector&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">ground</span>: <span class="string">&#x27;world-elevation&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">MapView</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">container</span>: <span class="string">&#x27;mapview&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">map</span>: map,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">zoom</span>: <span class="number">7</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">center</span>: [<span class="number">113.2</span>, <span class="number">23.4</span>],</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">viewingMode</span>: <span class="string">&#x27;global&#x27;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;ES-Module&quot;&gt;&lt;a href=&quot;#ES-Module&quot; class=&quot;headerlink&quot; title=&quot;ES Module&quot;&gt;&lt;/a&gt;ES Module&lt;/h3&gt;&lt;p&gt;ES Module 是 JavaScript 模块化的官方标准， 目前主流的浏览器已经实现，不依赖任何第三方加载器 (Loader) 即可使用。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://caniuse.com/mdn-javascript_statements_import&quot;&gt;点击此链接查看最新的浏览器支持情况&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>前端换肤解决方案及其思路</title>
    <link href="https://tabbycute.github.io/2022/10/25/20221025%E5%89%8D%E7%AB%AF%E6%8D%A2%E8%82%A4%E6%80%9D%E8%B7%AF/"/>
    <id>https://tabbycute.github.io/2022/10/25/20221025%E5%89%8D%E7%AB%AF%E6%8D%A2%E8%82%A4%E6%80%9D%E8%B7%AF/</id>
    <published>2022-10-24T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.283Z</updated>
    
    <content type="html"><![CDATA[<h3 id="CSS变量实现"><a href="#CSS变量实现" class="headerlink" title="CSS变量实现"></a>CSS变量实现</h3><p>没什么好说的简单</p><blockquote><p>使用stylus注意</p><p>–fill-1:#222;（正常）</p><p>–fill-1: #222;（可能报错）</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">change</span>=(<span class="params">theme</span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> html=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;body&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">html.<span class="title function_">setAttribute</span>(<span class="string">&quot;data-theme&quot;</span>,theme)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;change(&#x27;light&#x27;)&quot;</span>&gt;</span>主题颜色亮色<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;change(&#x27;dark&#x27;)&quot;</span>&gt;</span>主题颜色暗色<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;bg&quot;</span>&gt;</span>测试文字啊阿达瓦大大<span class="tag">&lt;<span class="name">i</span>&gt;</span>家中的<span class="tag">&lt;/<span class="name">i</span>&gt;</span>王阿达瓦<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">&quot;stylus&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    //默认</span></span><br><span class="line"><span class="language-css"><span class="selector-pseudo">:root</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--fill-1</span>:<span class="number">#ffffff</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--text</span>:<span class="number">#3c3c3c</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--text-1</span>:<span class="number">#757575</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--text-2</span>:<span class="number">#222</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-large</span>:<span class="number">18px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-large-x</span>:<span class="number">22px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-medium</span>:<span class="number">14px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-medium-x</span>:<span class="number">16px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-small-s</span>:<span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-small</span>:<span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-attr">[data-theme=<span class="string">&quot;dark&quot;</span>]</span> &#123;</span></span><br><span class="line"><span class="language-css"><span class="attr">--fill-1</span>:<span class="number">#222</span>;</span></span><br><span class="line"><span class="language-css"><span class="attr">--text</span>:<span class="number">#fff</span>;</span></span><br><span class="line"><span class="language-css"><span class="attr">--text-1</span>:<span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.3</span>);</span></span><br><span class="line"><span class="language-css"><span class="attr">--text-2</span>:<span class="number">#ffcd32</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.bg</span></span></span><br><span class="line"><span class="language-css"><span class="attribute">transition-duration</span>: <span class="number">0.5s</span></span></span><br><span class="line"><span class="language-css">height: <span class="number">100px</span></span></span><br><span class="line"><span class="language-css">background <span class="built_in">var</span>(--fill-<span class="number">1</span>);</span></span><br><span class="line"><span class="language-css"><span class="attribute">color</span>: <span class="built_in">var</span>(--text-<span class="number">2</span>);</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="js动态"><a href="#js动态" class="headerlink" title="js动态"></a>js动态</h3><p>使用覆盖样式实现与scss变量实现会把多套皮肤的样式都编译到一个css文件里面，如果有多套皮肤样式，这个文件是会非常大的。</p><p>为了解决这样的问题，就自然的想出了拆分scss的实现，，通过编译工具与构建工具编译出多套皮肤css。或者使用网络地址。</p><p>通过js动态的link对应的皮肤样式</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> theme = <span class="regexp">/\bt=(\w+)/</span>.<span class="title function_">exec</span>(location.<span class="property">search</span>);</span><br><span class="line">theme = theme ? theme[<span class="number">1</span>] : <span class="string">&quot;light&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">changeTheme</span>(theme);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">changeTheme</span>(<span class="params">theme</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> head = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;head&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;link&quot;</span>);</span><br><span class="line">    link.<span class="property">dataset</span>.<span class="property">type</span> = <span class="string">&quot;theme&quot;</span>;</span><br><span class="line">    link.<span class="property">href</span> = <span class="string">&quot;assets/css/theme-&quot;</span> + theme + <span class="string">&quot;/pages/home/home.css&quot;</span>;</span><br><span class="line">    link.<span class="property">rel</span> = <span class="string">&quot;stylesheet&quot;</span>;</span><br><span class="line">    link.<span class="property">type</span> = <span class="string">&quot;text/css&quot;</span>;</span><br><span class="line">    head.<span class="title function_">appendChild</span>(link);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ElementUI换肤"><a href="#ElementUI换肤" class="headerlink" title="ElementUI换肤"></a>ElementUI换肤</h3><p>ElementUI的实现原理，通过预设的配置，颜色计算出颜色和生成正则，获取所有的style标签，拿到标签中的字符串，在去用正则替换字符串中的颜色，在设置回去。</p><p>为了考虑重复设置可以给style标签添加个标记</p><p>这个实现方式正如他官方所说相当暴力莫得感情！！！同时自己写的颜色也会被替换掉</p><blockquote><p><a href="https://github.com/ianstormtaylor/css-color-function">颜色计算</a></p><p><a href="https://www.runoob.com/js/js-obj-regexp.html">前端正则</a></p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">Color</span> <span class="keyword">from</span> <span class="string">&quot;css-color-function&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> current=<span class="string">&quot;default&quot;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> formulaes = [</span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&quot;0&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">exp</span>: <span class="string">&quot;color(primary)&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&quot;aaa&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">exp</span>: <span class="string">&quot;color(textColor)&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&quot;bbb&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">exp</span>: <span class="string">&quot;color(btn)&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">];</span></span><br><span class="line"><span class="language-javascript"><span class="comment">///多个主题</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> themes=&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">default</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;primary&quot;</span>:<span class="string">&quot;#DC143C&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;textColor&quot;</span>:<span class="string">&quot;#BBFFAA&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;btn&quot;</span>:<span class="string">&quot;#2F4F4F&quot;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t1</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;primary&quot;</span>:<span class="string">&quot;#FFD700&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;textColor&quot;</span>:<span class="string">&quot;#000000&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;btn&quot;</span>:<span class="string">&quot;#000080&quot;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t2</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;primary&quot;</span>:<span class="string">&quot;#2F4F4F&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;textColor&quot;</span>:<span class="string">&quot;#FFFFFF&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;btn&quot;</span>:<span class="string">&quot;#adff2f&quot;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">computedColors</span> = (<span class="params">colors</span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">return</span> formulaes.<span class="title function_">map</span>(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> value = f.<span class="property">exp</span></span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">replace</span>(<span class="regexp">/primary/g</span>, colors.<span class="property">primary</span>)</span></span><br><span class="line"><span class="language-javascript">    .<span class="property">replace</span> (<span class="regexp">/textColor/g</span>,colors.<span class="property">textColor</span>)</span></span><br><span class="line"><span class="language-javascript">    .<span class="property">replace</span> (<span class="regexp">/btn/g</span>,colors.<span class="property">btn</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> <span class="title class_">Color</span>.<span class="title function_">convert</span>(value);</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">PageInit</span>=(<span class="params"></span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(themes).<span class="title function_">forEach</span>(<span class="function"><span class="params">k</span>=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> initColorCluster=[...<span class="title class_">Object</span>.<span class="title function_">values</span>(themes[k]),...<span class="title function_">computedColors</span>(themes[k])]</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> initStyleReg=initColorCluster.<span class="title function_">join</span>(<span class="string">&quot;|&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">      .<span class="title function_">replace</span>(<span class="regexp">/\(/g</span>, <span class="string">&quot;\\(&quot;</span>) <span class="comment">// 括号的转义</span></span></span><br><span class="line"><span class="language-javascript">      .<span class="title function_">replace</span>(<span class="regexp">/\)/g</span>, <span class="string">&quot;\\)&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">      .<span class="title function_">replace</span>(<span class="regexp">/0\./g</span>, <span class="string">&quot;.&quot;</span>); <span class="comment">// 这里替换是因为默认的css中计算出来的值透明度会缺省0，</span></span></span><br><span class="line"><span class="language-javascript">    themes[k].<span class="property">_initColorCluster</span>=initColorCluster</span></span><br><span class="line"><span class="language-javascript">    themes[k].<span class="property">_initStyleReg</span>=initStyleReg</span></span><br><span class="line"><span class="language-javascript">  &#125;)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="title class_">PageInit</span>()</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">changeTheme</span> = (<span class="params">t</span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> cT=themes[current],</span></span><br><span class="line"><span class="language-javascript">        tT=themes[t];</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> styles = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;style&quot;</span>)).<span class="title function_">filter</span>(<span class="function">(<span class="params">style</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 找到需要进行替换的style标签</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> text = style.<span class="property">innerText</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">`<span class="subst">$&#123;cT._initStyleReg&#125;</span>`</span>, <span class="string">&quot;i&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span> re.<span class="title function_">test</span>(text);</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///生成正则</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">`<span class="subst">$&#123;cT._initStyleReg&#125;</span>`</span>, <span class="string">&quot;ig&quot;</span>); <span class="comment">// 老的颜色簇正则，全局替换，且不区分大小写</span></span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">    styles.<span class="title function_">forEach</span>(<span class="function">(<span class="params">style</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> &#123; innerText &#125; = style;</span></span><br><span class="line"><span class="language-javascript">      style.<span class="property">innerHTML</span> = innerText.<span class="title function_">replace</span>(re, <span class="function">(<span class="params">match</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">///通过小写检查  rgba(0,0,0,.5) 替换成0.5 兼容好</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> index = cT.<span class="property">_initColorCluster</span>.<span class="title function_">indexOf</span>(match.<span class="title function_">toLowerCase</span>().<span class="title function_">replace</span>(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;0.&quot;</span>));</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">///通过大写写检查</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (index === -<span class="number">1</span>)index = cT.<span class="property">_initColorCluster</span>.<span class="title function_">indexOf</span>(match.<span class="title function_">toUpperCase</span>().<span class="title function_">replace</span>(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;0.&quot;</span>));</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 进行替换</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> tT.<span class="property">_initColorCluster</span>[index].<span class="title function_">toLowerCase</span>().<span class="title function_">replace</span>(<span class="regexp">/0\./g</span>, <span class="string">&quot;.&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      &#125;);</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// console.log(style.innerHTML)</span></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// style.setAttribute(&quot;class&quot;, &quot;so-ui-react-theme&quot;);</span></span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">    current=t;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;当前主题：%s&quot;</span>,current)</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">change</span>=(<span class="params"></span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">if</span>(current===<span class="string">&quot;default&quot;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">changeTheme</span>(<span class="string">&quot;t1&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(current===<span class="string">&quot;t1&quot;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">changeTheme</span>(<span class="string">&quot;t2&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">changeTheme</span>(<span class="string">&quot;default&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// componentDidMount();</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;a b&quot;</span>&gt;</span>testaaaaaai<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;b c&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;change&quot;</span>&gt;</span>更换颜色<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.a</span>&#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>: <span class="number">#DC143C</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.b</span>&#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">color</span>: <span class="number">#BBFFAA</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.c</span>&#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>:<span class="number">#2F4F4F</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="less实现换肤"><a href="#less实现换肤" class="headerlink" title="less实现换肤"></a>less实现换肤</h3><p>感觉less实现的很优雅</p><p>设置默认样式，原来它会找到所有如下的less样式标签，并且使用已编译的css同步创建 style 标签。</p><p>相当于在原来的基础上生成一个一模一样的style样式表添加到页面中。也就是说他需要一个模板。如果放在src里面他会被编译成css，无法成为模板。</p><p>我们这里把这个模板放到项目主目录的public中去。。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/public/test<span class="selector-class">.less</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@primary-color</span>: red;</span><br><span class="line"><span class="keyword">@bg-color</span>: blue;</span><br><span class="line"><span class="selector-class">.test-block</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">20px</span> auto;</span><br><span class="line">  <span class="attribute">color</span>: @primary-color;</span><br><span class="line">  <span class="attribute">background</span>: @bg-color;</span><br><span class="line">  <span class="selector-class">.block2</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: aquamarine;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>修改项目模板文件index.html，添加lessjs，也可以搞成本地的的，我这里为了方便直接添加cdn的</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">type</span>=<span class="string">&quot;image/svg+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/vite.svg&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vite + Vue<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet/less&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/test.less&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">less</span> = &#123;<span class="attr">async</span>:<span class="literal">true</span>,&#125;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/less.js/2.7.3/less.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/src/main.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>页面简单使用</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> themes=&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t1</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@primary-color&quot;</span>: <span class="string">&quot;#8b0000&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@bg-color&quot;</span>: <span class="string">&quot;#2f4f4f&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t2</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@primary-color&quot;</span>: <span class="string">&quot;#ffa500&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@bg-color&quot;</span>: <span class="string">&quot;#c0c0c0&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t3</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@primary-color&quot;</span>:<span class="string">&quot;#000080&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@bg-color&quot;</span>: <span class="string">&quot;#000000&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">onchange</span>=(<span class="params">t</span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">console</span>.<span class="title function_">log</span>(themes[t])</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">window</span>.<span class="property">less</span>.<span class="title function_">modifyVars</span>(themes[t]).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;修改成功&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;onchange(&#x27;t1&#x27;)&quot;</span>&gt;</span>改变哦<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;onchange(&#x27;t2&#x27;)&quot;</span>&gt;</span>改变哦<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;onchange(&#x27;t3&#x27;)&quot;</span>&gt;</span>改变哦<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;test-block&quot;</span>&gt;</span>testaaaaaai<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="其他思路"><a href="#其他思路" class="headerlink" title="其他思路"></a>其他思路</h3><p>vuex，自定义指令等等实现起来应该也很不错。理论上他们也能获得较高的自定义程度，颜色，背景图等等等。</p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;CSS变量实现&quot;&gt;&lt;a href=&quot;#CSS变量实现&quot; class=&quot;headerlink&quot; title=&quot;CSS变量实现&quot;&gt;&lt;/a&gt;CSS变量实现&lt;/h3&gt;&lt;p&gt;没什么好说的简单&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;使用stylus注意&lt;/p&gt;
&lt;p&gt;–fill-1:#222;（正常）&lt;/p&gt;
&lt;p&gt;–fill-1: #222;（可能报错）&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="vue" scheme="https://tabbycute.github.io/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>flutter极光推送集成华为(鸿蒙)厂商通道</title>
    <link href="https://tabbycute.github.io/2022/10/05/20221005flutter%E9%9B%86%E6%88%90%E5%8D%8E%E4%B8%BA%E6%8E%A8%E9%80%81/"/>
    <id>https://tabbycute.github.io/2022/10/05/20221005flutter%E9%9B%86%E6%88%90%E5%8D%8E%E4%B8%BA%E6%8E%A8%E9%80%81/</id>
    <published>2022-10-04T16:00:00.000Z</published>
    <updated>2022-12-07T14:17:58.960Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>flutter插件<a href="https://pub.flutter-io.cn/packages/jpush_flutter">jpush_flutter: 2.2.5</a>,<a href="https://github.com/jpush/jpush-flutter-plugin">github</a></p><p>华为推送证书<a href="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html#/myProject/99536292102686645/97458334310914890?appId=107234249">agconnect-services.json导出地址</a></p><p>极光<a href="https://www.jiguang.cn/portal/#/dev/newOverview">开发者平台</a></p><p>客户端sdk集成<a href="https://docs.jiguang.cn/jpush/client/Android/android_sdk">官方文档</a></p><p>客户端华为厂商通道集成<a href="https://docs.jiguang.cn/jpush/client/Android/android_3rd_guide#%E9%85%8D%E7%BD%AE-mavencentral-%E6%94%AF%E6%8C%81-1">官方文档</a></p><p>极光推送<a href="https://www.jiguang.cn/portal/#/push/app/bffe9289b1b2f16861869be9/config_manage/check/message">排查工具</a></p><p>com.huawei.hms:push:X.X.X.XXX<a href="https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/service-introduction-0000001050040060">推送服务（Push Kit）</a>是华为提供的消息推送平台，建立了从云端到终端的消息推送通道。您通过集成推送服务，可以向客户端应用实时推送消息，构筑良好的用户关系，提升用户的感知度和活跃度。</p><p>com.huawei.hms:push:X.X.X.XXX推送服务<a href="https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/android-app-version-0000001074227861#section527519181712">版本及其历史版本</a></p><p>com.huawei.agconnect:agcp:X.X.X.XXX<a href="https://developer.huawei.com/consumer/cn/doc/development/AppGallery-connect-Guides/agc-apm-android-releasenotes-0000001052887266">华为分析服务（Analytics Kit）</a>是针对移动应用、Web、快应用、快游戏、小程序等产品的一站式用户行为分析平台，贴合业务场景，提供数据采集、数据管理、数据分析、数据应用的一体化解决方案，驱动企业实现精准拉新、产品优化、精益运营、业务增长。</p><p><a href="https://docs.jiguang.cn/jpush/client/Android/android_sdk">极光推送官方</a>客户端集成，包括荣耀，OPPO，等等需要引入aar包，<strong>极光文档可能会更新，需要留意观看，</strong>看着他文档来就OK</p></blockquote><h3 id="极光推送基础集成"><a href="#极光推送基础集成" class="headerlink" title="极光推送基础集成"></a>极光推送基础集成</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">class MyHomePage extends StatefulWidget &#123;</span><br><span class="line">  const MyHomePage(&#123;super.key, required this.title&#125;);</span><br><span class="line">  final String title;</span><br><span class="line">  @override</span><br><span class="line">  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();</span><br><span class="line">&#125;</span><br><span class="line">class _MyHomePageState extends State&lt;MyHomePage&gt; &#123;</span><br><span class="line">  JPush jpush = new JPush();</span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              try &#123;</span><br><span class="line">                //Map&lt;String, dynamic&gt; message</span><br><span class="line">                jpush.addEventHandler(onReceiveNotification: (message) async &#123;</span><br><span class="line">                  print(&quot;jpush flutter onReceiveNotification: $&#123;json.encode(message)&#125;&quot;);</span><br><span class="line">                &#125;, onOpenNotification: (message) async &#123;</span><br><span class="line">                &#125;, onReceiveMessage: (message) async &#123;</span><br><span class="line">                  print(&quot;jpush flutter onReceiveMessage: $&#123;json.encode(message)&#125;&quot;);</span><br><span class="line">                &#125;, onReceiveNotificationAuthorization: (message) async &#123;</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125; on PlatformException &#123;</span><br><span class="line">                print(&quot;jpush Failed to get platform version.&quot;);</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              jpush.setup(</span><br><span class="line">                appKey: &quot;bffe9289**********61869be9&quot;,</span><br><span class="line">                channel: &quot;developer-default&quot;,</span><br><span class="line">                production: false,</span><br><span class="line">                debug: false, // 设置是否打印 debug 日志</span><br><span class="line">              );</span><br><span class="line"></span><br><span class="line">              jpush.applyPushAuthority(NotificationSettingsIOS(</span><br><span class="line">                sound: true,</span><br><span class="line">                alert: true,</span><br><span class="line">                badge: true,</span><br><span class="line">              ));</span><br><span class="line"></span><br><span class="line">              jpush.getRegistrationID().then((rid) &#123;</span><br><span class="line">                print(&quot;jpush flutter get registration id : $rid&quot;);</span><br><span class="line">              &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;, child: Text(&quot;setup&quot;)),</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              jpush.applyPushAuthority();</span><br><span class="line">            &#125;, child: Text(&quot;apply&quot;)),</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              jpush.isNotificationEnabled().then((bool value) &#123;</span><br><span class="line">                print(&quot;jpush 通知授权是否打开: $value&quot;);</span><br><span class="line">              &#125;).catchError((onError) &#123;</span><br><span class="line">                print(&quot;jpush 通知授权是否打开: $&#123;onError.toString()&#125;&quot;);</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;, child: Text(&quot;通知&quot;)),</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              jpush.setAlias(&quot;1000*****&quot;).then((map) &#123; </span><br><span class="line">                print(&quot;==setAlias==$&#123;map&#125;==&quot;);</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;, child: Text(&quot;setAlias&quot;))</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="厂商通道集成"><a href="#厂商通道集成" class="headerlink" title="厂商通道集成"></a>厂商通道集成</h3><blockquote><p>gradle:6.7</p><p>distributionUrl=https://services.gradle.org/distributions/gradle-6.7-all.zip</p><p>android/build.gradle———-classpath com.android.tools.build:gradle:4.1.3</p><p>jpush_flutter: 2.2.5 Jcore版本:3.2.2  Jpush版本: 4.6.4   (可以在flutter的插件地址Changelog中查看)</p></blockquote><h4 id="android-build-gradle加上如下代码"><a href="#android-build-gradle加上如下代码" class="headerlink" title="android/build.gradle加上如下代码"></a>android/build.gradle加上如下代码</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    ext.kotlin_version = <span class="string">&#x27;1.6.10&#x27;</span></span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line"><span class="comment">// 加上如下代码</span></span><br><span class="line">        maven &#123;url <span class="string">&#x27;https://developer.huawei.com/repo/&#x27;</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;com.android.tools.build:gradle:4.1.3&#x27;</span></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加上如下代码</span></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;com.huawei.agconnect:agcp:1.4.2.300&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line"><span class="comment">// 加上如下代码</span></span><br><span class="line">        maven &#123; url <span class="string">&#x27;https://developer.huawei.com/repo/&#x27;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="agconnect-services-json放入到-android-app-中"><a href="#agconnect-services-json放入到-android-app-中" class="headerlink" title="agconnect-services.json放入到**android/app/**中"></a>agconnect-services.json放入到**android/app/**中</h4><h4 id="进入到android-app-build-gradle"><a href="#进入到android-app-build-gradle" class="headerlink" title="进入到android/app/build.gradle"></a>进入到<strong>android/app/build.gradle</strong></h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line">apply plugin: <span class="string">&#x27;kotlin-android&#x27;</span></span><br><span class="line">apply <span class="keyword">from</span>: <span class="string">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br><span class="line"><span class="comment">// 加上如下代码（位置随意）</span></span><br><span class="line">apply plugin: <span class="string">&#x27;com.huawei.agconnect&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="引入厂商sdk"><a href="#引入厂商sdk" class="headerlink" title="引入厂商sdk"></a>引入厂商sdk</h4><p>极光厂商插件版本与接入 JPush 版本保持一致，下同，jpush版本可以在极光推送<a href="https://www.jiguang.cn/portal/#/push/app/bffe9289b1b2f16861869be9/config_manage/check/message">排查工具</a>中查看</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="comment">// 接入华为厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;com.huawei.hms:push:5.3.0.301&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:huawei:4.4.5&#x27;</span><span class="comment">// 极光厂商插件版本与接入 JPush 版本保持一致，下同</span></span><br><span class="line">    <span class="comment">// 接入小米厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:xiaomi:4.4.5&#x27;</span></span><br><span class="line">    <span class="comment">// 接入 FCM 厂商</span></span><br><span class="line"><span class="comment">// implementation &#x27;com.google.firebase:firebase-messaging:21.0.1&#x27;</span></span><br><span class="line"><span class="comment">// implementation &#x27;cn.jiguang.sdk.plugin:fcm:4.0.0&#x27;</span></span><br><span class="line">    <span class="comment">// 接入魅族厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:meizu:4.4.5&#x27;</span></span><br><span class="line">    <span class="comment">// 接入 VIVO 厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:vivo:4.4.5&#x27;</span></span><br><span class="line">    <span class="comment">// 接入 OPPO 厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:oppo:4.4.5&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修改AndroidManifest-xml"><a href="#修改AndroidManifest-xml" class="headerlink" title="修改AndroidManifest.xml"></a>修改AndroidManifest.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> </span></span><br><span class="line"><span class="tag">···</span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    ···&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">       ···</span></span><br><span class="line"><span class="tag">       <span class="attr">tools:replace</span>=<span class="string">&quot;android:label&quot;</span></span></span><br></pre></td></tr></table></figure><h3 id="版本升级"><a href="#版本升级" class="headerlink" title="版本升级"></a>版本升级</h3><p><strong>‘com.huawei.agconnect:agcp:1.5.2.300’</strong> 这个版本是IDE自动提示我的如果版本不对他运行可能会报错!!!!,开头给力地址可以查找自己对应的版本</p><p><strong>‘com.huawei.hms:push:5.3.0.301’</strong> 开头给力地址可以查找自己对应的版本</p><blockquote><p>gradle:7.4</p><p>distributionUrl=https://services.gradle.org/distributions/gradle-7.4-all.zip</p><p>android/build.gradle———-classpath ‘com.android.tools.build:gradle:7.1.2’</p><p>jpush_flutter: 2.4.0 Jpush版本: 4.8.4 (可以在flutter的插件地址Changelog中查看)</p><p>aar的包位于android/app/libs/***.aar</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">...</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath &#x27;com.android.tools.build:gradle:7.1.2&#x27;</span><br><span class="line">        classpath &quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span><br><span class="line"></span><br><span class="line">// 加上如下代码  </span><br><span class="line">        classpath &#x27;com.huawei.agconnect:agcp:1.5.2.300&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    // 接入华为厂商</span><br><span class="line">    implementation &#x27;com.huawei.hms:push:5.3.0.301&#x27;</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:huawei:4.8.4&#x27;// 极光厂商插件版本与接入 JPush 版本保持一致，下同</span><br><span class="line">    // 接入小米厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:xiaomi:4.8.4&#x27;</span><br><span class="line">    // 接入魅族厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:meizu:4.8.4&#x27;</span><br><span class="line">    // 接入 VIVO 厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:vivo:4.8.4&#x27;</span><br><span class="line">    // 接入 OPPO 厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:oppo:4.8.4&#x27;</span><br><span class="line">    implementation(name: &#x27;com.heytap.msp-push-3.1.0&#x27;, ext: &#x27;aar&#x27;)</span><br><span class="line">    //以下为 OPPO 3.1.0 aar需要依赖</span><br><span class="line">    implementation &#x27;com.google.code.gson:gson:2.6.2&#x27;</span><br><span class="line">    implementation &#x27;commons-codec:commons-codec:1.6&#x27;</span><br><span class="line">    implementation &#x27;androidx.annotation:annotation:1.1.0&#x27;</span><br><span class="line">    //荣耀</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:honor:4.8.4&#x27;</span><br><span class="line">    implementation(name: &#x27;HonorPushSDK-7.0.1.103&#x27;, ext: &#x27;aar&#x27;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;flutter插件&lt;a href=&quot;https://pub.flutter-io.cn/packages/jpush_flutter&quot;&gt;jpush_flutter: 2.2.5&lt;/a&gt;,&lt;a href=&quot;https://github.com/jpush/jpush-flutter-plugin&quot;&gt;github&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;华为推送证书&lt;a href=&quot;https://developer.huawei.com/consumer/cn/service/josp/agc/index.html#/myProject/99536292102686645/97458334310914890?appId=107234249&quot;&gt;agconnect-services.json导出地址&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;极光&lt;a href=&quot;https://www.jiguang.cn/portal/#/dev/newOverview&quot;&gt;开发者平台&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;客户端sdk集成&lt;a href=&quot;https://docs.jiguang.cn/jpush/client/Android/android_sdk&quot;&gt;官方文档&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;客户端华为厂商通道集成&lt;a href=&quot;https://docs.jiguang.cn/jpush/client/Android/android_3rd_guide#%E9%85%8D%E7%BD%AE-mavencentral-%E6%94%AF%E6%8C%81-1&quot;&gt;官方文档&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;极光推送&lt;a href=&quot;https://www.jiguang.cn/portal/#/push/app/bffe9289b1b2f16861869be9/config_manage/check/message&quot;&gt;排查工具&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;com.huawei.hms:push:X.X.X.XXX&lt;a href=&quot;https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/service-introduction-0000001050040060&quot;&gt;推送服务（Push Kit）&lt;/a&gt;是华为提供的消息推送平台，建立了从云端到终端的消息推送通道。您通过集成推送服务，可以向客户端应用实时推送消息，构筑良好的用户关系，提升用户的感知度和活跃度。&lt;/p&gt;
&lt;p&gt;com.huawei.hms:push:X.X.X.XXX推送服务&lt;a href=&quot;https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/android-app-version-0000001074227861#section527519181712&quot;&gt;版本及其历史版本&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;com.huawei.agconnect:agcp:X.X.X.XXX&lt;a href=&quot;https://developer.huawei.com/consumer/cn/doc/development/AppGallery-connect-Guides/agc-apm-android-releasenotes-0000001052887266&quot;&gt;华为分析服务（Analytics Kit）&lt;/a&gt;是针对移动应用、Web、快应用、快游戏、小程序等产品的一站式用户行为分析平台，贴合业务场景，提供数据采集、数据管理、数据分析、数据应用的一体化解决方案，驱动企业实现精准拉新、产品优化、精益运营、业务增长。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.jiguang.cn/jpush/client/Android/android_sdk&quot;&gt;极光推送官方&lt;/a&gt;客户端集成，包括荣耀，OPPO，等等需要引入aar包，&lt;strong&gt;极光文档可能会更新，需要留意观看，&lt;/strong&gt;看着他文档来就OK&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;极光推送基础集成&quot;&gt;&lt;a href=&quot;#极光推送基础集成&quot; class=&quot;headerlink&quot; title=&quot;极光推送基础集成&quot;&gt;&lt;/a&gt;极光推送基础集成&lt;/h3&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;class MyHomePage extends StatefulWidget &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  const MyHomePage(&amp;#123;super.key, required this.title&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  final String title;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  @override&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  State&amp;lt;MyHomePage&amp;gt; createState() =&amp;gt; _MyHomePageState();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;class _MyHomePageState extends State&amp;lt;MyHomePage&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  JPush jpush = new JPush();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  @override&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Widget build(BuildContext context) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    return Scaffold(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      appBar: AppBar(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        title: Text(widget.title),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      ),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      body: Center(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        child: Column(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          mainAxisAlignment: MainAxisAlignment.center,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          children: &amp;lt;Widget&amp;gt;[&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ElevatedButton(onPressed:()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                //Map&amp;lt;String, dynamic&amp;gt; message&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                jpush.addEventHandler(onReceiveNotification: (message) async &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  print(&amp;quot;jpush flutter onReceiveNotification: $&amp;#123;json.encode(message)&amp;#125;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;, onOpenNotification: (message) async &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;, onReceiveMessage: (message) async &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  print(&amp;quot;jpush flutter onReceiveMessage: $&amp;#123;json.encode(message)&amp;#125;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;, onReceiveNotificationAuthorization: (message) async &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125; on PlatformException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;jpush Failed to get platform version.&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.setup(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                appKey: &amp;quot;bffe9289**********61869be9&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                channel: &amp;quot;developer-default&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                production: false,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                debug: false, // 设置是否打印 debug 日志&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.applyPushAuthority(NotificationSettingsIOS(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                sound: true,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                alert: true,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                badge: true,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              ));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.getRegistrationID().then((rid) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;jpush flutter get registration id : $rid&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;, child: Text(&amp;quot;setup&amp;quot;)),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ElevatedButton(onPressed:()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.applyPushAuthority();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;, child: Text(&amp;quot;apply&amp;quot;)),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ElevatedButton(onPressed:()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.isNotificationEnabled().then((bool value) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;jpush 通知授权是否打开: $value&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;).catchError((onError) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;jpush 通知授权是否打开: $&amp;#123;onError.toString()&amp;#125;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;, child: Text(&amp;quot;通知&amp;quot;)),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ElevatedButton(onPressed:()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.setAlias(&amp;quot;1000*****&amp;quot;).then((map) &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;==setAlias==$&amp;#123;map&amp;#125;==&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;, child: Text(&amp;quot;setAlias&amp;quot;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          ],&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      ),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
    <category term="极光推送" scheme="https://tabbycute.github.io/tags/%E6%9E%81%E5%85%89%E6%8E%A8%E9%80%81/"/>
    
  </entry>
  
  <entry>
    <title>etcd集群的搭建</title>
    <link href="https://tabbycute.github.io/2022/09/25/20220925etcd%E7%9A%84%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"/>
    <id>https://tabbycute.github.io/2022/09/25/20220925etcd%E7%9A%84%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/</id>
    <published>2022-09-24T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.048Z</updated>
    
    <content type="html"><![CDATA[<p>etcd安装不说了详情请看上篇文章</p><h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><h4 id="节点1"><a href="#节点1" class="headerlink" title="节点1"></a>节点1</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd --name etcd_t_0 --initial-advertise-peer-urls http://119.91.206.195:2380 \</span><br><span class="line">  --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --advertise-client-urls http://119.91.206.195:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd_t_0=http://119.91.206.195:2380,etcd_t_1=http://1.117.72.9:2380,etcd_t_2=http://47.92.80.135:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir /var/lib/etcd5/</span><br></pre></td></tr></table></figure><h4 id="节点2"><a href="#节点2" class="headerlink" title="节点2"></a>节点2</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd --name etcd_t_1 --initial-advertise-peer-urls http://1.117.72.9:2380 \</span><br><span class="line">  --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --advertise-client-urls http://1.117.72.9:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd_t_0=http://119.91.206.195:2380,etcd_t_1=http://1.117.72.9:2380,etcd_t_2=http://47.92.80.135:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir /var/lib/etcd5/</span><br></pre></td></tr></table></figure><h4 id="节点3"><a href="#节点3" class="headerlink" title="节点3"></a>节点3</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd --name etcd_t_2 --initial-advertise-peer-urls http://47.92.80.135:2380 \</span><br><span class="line">  --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --advertise-client-urls http://47.92.80.135:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd_t_0=http://119.91.206.195:2380,etcd_t_1=http://1.117.72.9:2380,etcd_t_2=http://47.92.80.135:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir /var/lib/etcd5/</span><br></pre></td></tr></table></figure><h3 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h3><ul><li><p>查看集群成员</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member list --write-out=table</span></span><br><span class="line">+------------------+---------+----------+----------------------------+----------------------------+</span><br><span class="line">|        ID        | STATUS  |   NAME   |         PEER ADDRS         |        CLIENT ADDRS        |</span><br><span class="line">+------------------+---------+----------+----------------------------+----------------------------+</span><br><span class="line">| 362499433afddc14 | started | etcd_t_1 | http://1.117.72.9:2380     | http://1.117.72.9:2379     |</span><br><span class="line">| e4258ae59dee9dc3 | started | etcd_t_0 | http://119.91.206.195:2380 | http://119.91.206.195:2379 |</span><br><span class="line">| feb1217e15f7013f | started | etcd_t_2 | http://47.92.80.135:2380   | http://47.92.80.135:2379   |</span><br><span class="line">+------------------+---------+----------+----------------------------+----------------------------+</span><br></pre></td></tr></table></figure></li><li><p>查看集群健康</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl --endpoints=119.91.206.195:2380,1.117.72.9:2380,47.92.80.135:2380 endpoint health</span></span><br><span class="line">1.117.72.9:2380 is healthy: successfully committed proposal: took = 87.35868ms</span><br><span class="line">47.92.80.135:2380 is healthy: successfully committed proposal: took = 111.468497ms</span><br><span class="line">119.91.206.195:2380 is healthy: successfully committed proposal: took = 101.468497ms</span><br></pre></td></tr></table></figure></li><li><p>查看集群状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl --endpoints=119.91.206.195:2380,1.117.72.9:2380,47.92.80.135:2380 endpoint status --write-out=table</span></span><br><span class="line">+---------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">|     ENDPOINT        |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">| 1.117.72.9:2380     | 362499433afddc14 | 3.3.11  | 20 kB   | <span class="literal">false</span>     |        15 |          9 |</span><br><span class="line">| 47.92.80.135:2380   | feb1217e15f7013f | 3.3.11  | 16 kB   | <span class="literal">false</span>     |        15 |          9 |</span><br><span class="line">| 119.91.206.195:2380 | e4258ae59dee9dc3 | 3.3.11  | 16 kB   | <span class="literal">true</span>      |        15 |          9 |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+-----------+------------+</span><br></pre></td></tr></table></figure></li><li><p>删除一个节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member remove 362499433afddc14</span></span><br><span class="line">Member 362499433afddc14 removed from cluster 51573d7cfd299893</span><br></pre></td></tr></table></figure></li><li><p>加入一个节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member add etcd_t_1 --peer-urls=http://1.117.72.9:2380</span></span><br><span class="line">Member c4356e396bf22311 added to cluster 51573d7cfd299893</span><br><span class="line"></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd_t_1&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd_t_1=http://1.117.72.9:2380,etcd_t_0=http://119.91.206.195:2380,etcd_t_2=http://47.92.80.135:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;existing&quot;</span></span><br></pre></td></tr></table></figure><p>新节点启动的时候使用以上输出的配置启动一定注意参数</p></li><li><p>故障主机加入节点</p></li></ul><p>故障的etcd主机：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop etcd</span><br></pre></td></tr></table></figure><p>移除故障节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member remove 362499433afddc14</span></span><br><span class="line">Member 362499433afddc14 removed from cluster 51573d7cfd299893</span><br></pre></td></tr></table></figure><p>查询集群成员</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+------------------+-----------+----------+----------------------------+----------------------------+</span><br><span class="line">|        ID        |  STATUS   |   NAME   |         PEER ADDRS         |        CLIENT ADDRS        |</span><br><span class="line">+------------------+-----------+----------+----------------------------+----------------------------+</span><br><span class="line">| 50466d8335f8506a | unstarted |          | http://1.117.72.9:2380     |                            |</span><br><span class="line">| e4258ae59dee9dc3 | started   | etcd_t_0 | http://119.91.206.195:2380 | http://119.91.206.195:2379 |</span><br><span class="line">| feb1217e15f7013f | started   | etcd_t_2 | http://47.92.80.135:2380   | http://47.92.80.135:2379   |</span><br><span class="line">+------------------+-----------+----------+----------------------------+----------------------------+</span><br></pre></td></tr></table></figure><p>正常的etcd主机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member add etcd_t_1 --peer-urls=http://1.117.72.9:2380</span></span><br><span class="line">Member c4356e396bf22311 added to cluster 51573d7cfd299893</span><br><span class="line"></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd_t_1&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd_t_1=http://1.117.72.9:2380,etcd_t_0=http://119.91.206.195:2380,etcd_t_2=http://47.92.80.135:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;existing&quot;</span></span><br></pre></td></tr></table></figure><p>故障的etcd主机，启动etcd后，再查看etcd状态：</p><blockquote><p>一定要去修改故障主机的配置为：ETCD_INITIAL_CLUSTER_STATE=”existing”</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先删除错误节点的数据</span></span><br><span class="line"><span class="built_in">rm</span> -rf /var/lib/etcd/member</span><br><span class="line">systemctl start etcd</span><br><span class="line"><span class="comment"># 等待一会，这时候会同步数据，稍等再查看节点状态</span></span><br><span class="line">etcdctl endpoint health</span><br><span class="line">127.0.0.1:2379 is healthy: successfully committed proposal: took = 24.52485ms</span><br></pre></td></tr></table></figure><p>到这里，etcd故障节点修复完毕</p><h3 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h3><ul><li>这是集群中使用的etcd版本不一致的提示(<strong>这很有可能到导致集群不健康，至少我这个版本会，后来我全是yum install etcd</strong>)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2022-09-25 21:59:44.187212 W | etcdserver: the <span class="built_in">local</span> etcd version 3.1.5 is not up-to-date</span><br><span class="line">2022-09-25 21:59:44.187217 W | etcdserver: member feb1217e15f7013f has a higher version 3.3.11</span><br></pre></td></tr></table></figure></li><li>如果在一个目录启动过etcd，要启动新的集群或者其他的新的实例，最好换个目录，他可能会导致无法启动。暴力点rm -rf ******</li><li>故障的etcd主机，一定要去修改故障主机的配置为：ETCD_INITIAL_CLUSTER_STATE=existing</li><li>注意如果是前面修复过坏节点，下次启动集群的时候也不需要去修改坏节点的ETCD_INITIAL_CLUSTER_STATE=new</li><li>不同版本的etcd命令可能不一样，比如：添加节点</li><li>设置成existing，必须确保在启动时候其他member是存活的（peer端口），否则启动失败。用在扩容新实例的启动。设置成new，用在cluster已知member的启动。</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;etcd安装不说了详情请看上篇文章&lt;/p&gt;
&lt;h3 id=&quot;启动服务&quot;&gt;&lt;a href=&quot;#启动服务&quot; class=&quot;headerlink&quot; title=&quot;启动服务&quot;&gt;&lt;/a&gt;启动服务&lt;/h3&gt;&lt;h4 id=&quot;节点1&quot;&gt;&lt;a href=&quot;#节点1&quot; class=&quot;headerlink&quot; title=&quot;节点1&quot;&gt;&lt;/a&gt;节点1&lt;/h4&gt;</summary>
    
    
    
    <category term="linux" scheme="https://tabbycute.github.io/categories/linux/"/>
    
    
    <category term="linux" scheme="https://tabbycute.github.io/tags/linux/"/>
    
    <category term="etcd" scheme="https://tabbycute.github.io/tags/etcd/"/>
    
  </entry>
  
  <entry>
    <title>etcd单节点安装和golang的简单使用</title>
    <link href="https://tabbycute.github.io/2022/09/18/20220918etcd%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85%E5%92%8Cgolang%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
    <id>https://tabbycute.github.io/2022/09/18/20220918etcd%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85%E5%92%8Cgolang%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</id>
    <published>2022-09-17T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.282Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装golang"><a href="#安装golang" class="headerlink" title="安装golang"></a>安装golang</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install golang</span><br></pre></td></tr></table></figure><h2 id="etcd单节点安装"><a href="#etcd单节点安装" class="headerlink" title="etcd单节点安装"></a>etcd单节点安装</h2><h3 id="源码包安装"><a href="#源码包安装" class="headerlink" title="源码包安装"></a>源码包安装</h3><h4 id="下载etcd"><a href="#下载etcd" class="headerlink" title="下载etcd"></a>下载etcd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.1.5/etcd-v3.1.5-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><h4 id="解压-etcd-v3-1-5-linux-amd64-tar-gz-压缩文件"><a href="#解压-etcd-v3-1-5-linux-amd64-tar-gz-压缩文件" class="headerlink" title="解压 etcd-v3.1.5-linux-amd64.tar.gz 压缩文件"></a>解压 etcd-v3.1.5-linux-amd64.tar.gz 压缩文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf etcd-v3.1.5-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><h4 id="将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。"><a href="#将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。" class="headerlink" title="将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。"></a>将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//进入文件夹</span><br><span class="line"><span class="built_in">cd</span> etcd-v3.1.5-linux-amd64/</span><br><span class="line">//将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。</span><br><span class="line"><span class="built_in">mv</span> etcd* /usr/local/bin</span><br></pre></td></tr></table></figure><h4 id="修改使用的api等级"><a href="#修改使用的api等级" class="headerlink" title="修改使用的api等级"></a>修改使用的api等级</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><h4 id="查看版本信息"><a href="#查看版本信息" class="headerlink" title="查看版本信息"></a>查看版本信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">etcdctl v</span><br><span class="line"></span><br><span class="line">etcdctl version: 3.1.5</span><br><span class="line">API version: 3.1</span><br><span class="line"></span><br><span class="line">etcd --version</span><br><span class="line"></span><br><span class="line">etcd Version: 3.1.5</span><br><span class="line">Git SHA: 2cf9e51</span><br><span class="line">Go Version: go1.10.3</span><br><span class="line">Go OS/Arch: linux/amd64</span><br></pre></td></tr></table></figure><h4 id="创建etcd数据存放位置"><a href="#创建etcd数据存放位置" class="headerlink" title="创建etcd数据存放位置"></a>创建etcd数据存放位置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 数据存放位置的文件夹</span><br><span class="line"><span class="built_in">mkdir</span> -p /var/lib/etcd/</span><br></pre></td></tr></table></figure><h4 id="创建启动文件"><a href="#创建启动文件" class="headerlink" title="创建启动文件"></a>创建启动文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/systemd/system/etcd.service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//复制以下即可</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Etcd Server</span></span><br><span class="line"><span class="string">Documentation=https://github.com/coreos/etcd</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">User=root</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">Environment=ETCD_NAME=etcd_test_1</span></span><br><span class="line"><span class="string">Environment=ETCD_DATA_DIR=/var/lib/etcd/</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/etcd</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">RestartSec=10s</span></span><br><span class="line"><span class="string">LimitNOFILE=40000</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h4 id="重新加载配置-amp-amp-开机启动-amp-amp-启动-etcd"><a href="#重新加载配置-amp-amp-开机启动-amp-amp-启动-etcd" class="headerlink" title="重新加载配置 &amp;&amp; 开机启动 &amp;&amp; 启动 etcd"></a>重新加载配置 &amp;&amp; 开机启动 &amp;&amp; 启动 etcd</h4><h5 id="启动etcd"><a href="#启动etcd" class="headerlink" title="启动etcd"></a>启动etcd</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> etcd &amp;&amp; systemctl start etcd</span><br><span class="line">//成功如下</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/etcd.service to /etc/systemd/system/etcd.service.</span><br></pre></td></tr></table></figure><h5 id="开机启动设置状态，状态-enabled"><a href="#开机启动设置状态，状态-enabled" class="headerlink" title="开机启动设置状态，状态 enabled"></a>开机启动设置状态，状态 enabled</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files etcd.service</span><br><span class="line"></span><br><span class="line">//成功如下</span><br><span class="line">UNIT FILE    STATE </span><br><span class="line">etcd.service enabled</span><br><span class="line"> </span><br><span class="line">1 unit files listed.</span><br></pre></td></tr></table></figure><h5 id="查看-etcd-状态"><a href="#查看-etcd-状态" class="headerlink" title="查看 etcd 状态"></a>查看 etcd 状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl show etcd.service</span><br></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">etcdctl put mykey <span class="string">&quot;this is etcd2&quot;</span></span><br><span class="line">OK</span><br><span class="line">etcdctl get mykey</span><br><span class="line">mykey</span><br><span class="line">this is etcd</span><br></pre></td></tr></table></figure><h4 id="外网连接"><a href="#外网连接" class="headerlink" title="外网连接"></a>外网连接</h4><p>当然，etcd默认本地访问。如果需要远程访问需要在配置文件（/etc/etcd.conf 上面创建的文件）中加上如下操作。注意如果上面一行不是字符串需要加个</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Type=notify</span><br><span class="line">Environment=ETCD_NAME=etcd_test_1</span><br><span class="line">Environment=ETCD_DATA_DIR=/var/lib/etcd/</span><br><span class="line"></span><br><span class="line">Environment=ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379</span><br><span class="line">Environment=ETCD_ADVERTISE_CLIENT_URLS=http://0.0.0.0:2379</span><br><span class="line">或者直接使用本机</span><br><span class="line">Environment=ETCD_LISTEN_CLIENT_URLS=http://1.117.72.92:2379</span><br><span class="line">Environment=ETCD_ADVERTISE_CLIENT_URLS=http://1.117.72.92:2379</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ExecStart=/usr/local/bin/etcd</span><br></pre></td></tr></table></figure><p><strong>如果当前已经启动了修改的配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启生效</span></span><br><span class="line">systemctl restart etcd</span><br><span class="line"><span class="comment"># 重启生效</span></span><br><span class="line">systemctl stop etcd</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> etcd &amp;&amp; systemctl start etcd</span><br></pre></td></tr></table></figure><h4 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h4><ul><li>–name：方便理解的节点名称，默认为 default，在集群中应该保持唯一，可以使用 hostname</li><li>–data-dir：服务运行数据保存的路径，默认为 ${name}.etcd</li><li>–snapshot-count：指定有多少事务（transaction）被提交时，触发截取快照保存到磁盘</li><li>–heartbeat-interval：leader 多久发送一次心跳到 followers。默认值是 100ms</li><li>–eletion-timeout：重新投票的超时时间，如果follower在该时间间隔没有收到心跳包，会触发重新投票，默认为 1000 ms</li><li>–listen-peer-urls：和同伴通信的地址，比如 <a href="http://ip:2380，如果有多个，使用逗号分隔。需要所有节点都能够访问，所以不要使用">http://ip:2380，如果有多个，使用逗号分隔。需要所有节点都能够访问，所以不要使用</a> localhost</li><li>–listen-client-urls：对外提供服务的地址：比如 <a href="http://ip:2379,http://127.0.0.1:2379，客户端会连接到这里和etcd交互">http://ip:2379,http://127.0.0.1:2379，客户端会连接到这里和etcd交互</a></li><li>–advertise-client-urls：对外公告的该节点客户端监听地址，这个值会告诉集群中其他节点</li><li>–initial-advertise-peer-urls：该节点同伴监听地址，这个值会告诉集群中其他节点</li><li>–initial-cluster：集群中所有节点的信息，格式为 node1=<a href="http://ip1:2380,node2=http://ip2:2380,…。需要注意的是，这里的">http://ip1:2380,node2=http://ip2:2380,…。需要注意的是，这里的</a> node1 是节点的–name指定的名字；后面的ip1:2380 是–initial-advertise-peer-urls 指定的值</li><li>–initial-cluster-state：新建集群的时候，这个值为 new；假如已经存在的集群，这个值为existing</li><li>–initial-cluster-token：创建集群的token，这个值每个集群保持唯一。这样的话，如果你要重新创建集群，即使配置和之前一样，也会再次生成新的集群和节点 uuid；否则会导致多个集群之间的冲突，造成未知的错误<br></li></ul><p>这些选项，与上面我们配置文件里的配置一一对应，如ETCD_INITIAL_CLUSTER等同于–inital-cluster, ETCD_INITIAL_CLUSTER_STATE等同于–initial-cluster-state。</p><blockquote><p>所有以–init开头的配置都是在第一次启动etcd集群的时候才会用到，后续节点的重启会被忽略，如–initial-cluseter参数。所以当成功初始化了一个etcd集群以后，就不再需要这个参数或环境变量了。</p></blockquote><h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl stop etcd</span><br><span class="line">etcdctl member list//查看节点</span><br></pre></td></tr></table></figure><h4 id="报错收集"><a href="#报错收集" class="headerlink" title="报错收集"></a>报错收集</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">No <span class="built_in">help</span> topic <span class="keyword">for</span> ‘put’</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_API=3 解决</span><br></pre></td></tr></table></figure><h3 id="etcd-git官方安装脚本"><a href="#etcd-git官方安装脚本" class="headerlink" title="etcd git官方安装脚本"></a>etcd git官方安装脚本</h3><blockquote><p><a href="https://github.com/etcd-io/etcd/releases">https://github.com/etcd-io/etcd/releases</a><br>继续从 &lt;&lt;将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中&gt;&gt; 开始</p></blockquote><h3 id="etcd-yum安装"><a href="#etcd-yum安装" class="headerlink" title="etcd yum安装"></a>etcd yum安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install etcd</span><br><span class="line"></span><br><span class="line">//继续从 &lt;&lt;修改使用的api等级&gt;&gt; 开始</span><br></pre></td></tr></table></figure><h2 id="安装etcd-webui"><a href="#安装etcd-webui" class="headerlink" title="安装etcd webui"></a>安装etcd webui</h2><ul><li>记得启动Etcd服务。</li><li>先安装node，git环境，然后clone。</li><li>安装node可以到 <a href="http://nodejs.cn/download/%E4%B8%8B%E8%BD%BD%E5%AF%B9%E5%BA%94%E7%9A%84">http://nodejs.cn/download/下载对应的</a> node 版本。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/henszey/etcd-browser.git</span><br><span class="line">cd etcd-browser/</span><br><span class="line">vim server.js  </span><br></pre></td></tr></table></figure>编辑server.js，修改内容如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var etcdHost = process.env.ETCD_HOST || &#x27;127.0.0.1&#x27;;  # etcd 主机IP</span><br><span class="line">var etcdPort = process.env.ETCD_PORT || 2379;          # etcd 主机端口</span><br><span class="line">var serverPort = process.env.SERVER_PORT || 8000;      # etcd-browser 监听端口</span><br></pre></td></tr></table></figure>然后启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node server.js</span><br></pre></td></tr></table></figure>访问：<a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a></li></ul><h2 id="go连接etcd和一些操作"><a href="#go连接etcd和一些操作" class="headerlink" title="go连接etcd和一些操作"></a>go连接etcd和一些操作</h2><h3 id="put-get的简单操作示例"><a href="#put-get的简单操作示例" class="headerlink" title="put/get的简单操作示例"></a>put/get的简单操作示例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;go.etcd.io/etcd/client/v3&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="comment">// handle error!</span></span><br><span class="line">      fmt.Printf(<span class="string">&quot;connect to etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line">   <span class="comment">// put</span></span><br><span class="line">   ctx, cancel := context.WithTimeout(context.Background(), <span class="number">3</span>*time.Second)</span><br><span class="line">   _, err = cli.Put(ctx, <span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v1&quot;</span>)</span><br><span class="line">   cancel()</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;put to etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// get</span></span><br><span class="line">   ctx, cancel = context.WithTimeout(context.Background(), <span class="number">3</span>*time.Second)</span><br><span class="line">   resp, err := cli.Get(ctx, <span class="string">&quot;k1&quot;</span>)</span><br><span class="line">   cancel()</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;get from etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">for</span> _, ev := <span class="keyword">range</span> resp.Kvs &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;%s:%s\n&quot;</span>, ev.Key, ev.Value)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="watch的使用"><a href="#watch的使用" class="headerlink" title="watch的使用"></a>watch的使用</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;go.etcd.io/etcd/client/v3&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;connect to etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line">   <span class="comment">// watch key:q1mi change</span></span><br><span class="line">   rch := cli.Watch(context.Background(), <span class="string">&quot;k1&quot;</span>) <span class="comment">// &lt;-chan WatchResponse</span></span><br><span class="line">   <span class="keyword">for</span> wresp := <span class="keyword">range</span> rch &#123;</span><br><span class="line">      <span class="keyword">for</span> _, ev := <span class="keyword">range</span> wresp.Events &#123;</span><br><span class="line">         fmt.Printf(<span class="string">&quot;Type: %s Key:%s Value:%s\n&quot;</span>, ev.Type, ev.Kv.Key, ev.Kv.Value)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在同级的目录下cmd进入(下面操作是在windows上进行的，因为方便)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcdctl.exe --endpoints=http://127.0.0.1:2379 put k1 <span class="string">&quot;xixixixix&quot;</span></span><br><span class="line">etcdctl.exe --endpoints=http://127.0.0.1:2379 del k1</span><br><span class="line">etcdctl.exe --endpoints=http://127.0.0.1:2379 put k1 <span class="string">&quot;dsb3&quot;</span></span><br></pre></td></tr></table></figure><h3 id="lease租约的使用"><a href="#lease租约的使用" class="headerlink" title="lease租约的使用"></a>lease租约的使用</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;go.etcd.io/etcd/client/v3&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: time.Second * <span class="number">5</span>,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success.&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 创建一个5秒的租约</span></span><br><span class="line">   resp, err := cli.Grant(context.TODO(), <span class="number">5</span>)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(resp.ID)</span><br><span class="line">   <span class="comment">// 5秒钟之后, /aaaa/ 这个key就会被移除</span></span><br><span class="line">   _, err = cli.Put(context.TODO(), <span class="string">&quot;/aaaa/&quot;</span>, <span class="string">&quot;dsb&quot;</span>, clientv3.WithLease(resp.ID))</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   time.Sleep(time.Second * <span class="number">6</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="keepAlive"><a href="#keepAlive" class="headerlink" title="keepAlive"></a>keepAlive</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: time.Second * <span class="number">5</span>,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success.&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">   resp, err := cli.Grant(context.TODO(), <span class="number">5</span>)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   _, err = cli.Put(context.TODO(), <span class="string">&quot;/aaaa/&quot;</span>, <span class="string">&quot;dsb&quot;</span>, clientv3.WithLease(resp.ID))</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// the key &#x27;foo&#x27; will be kept forever</span></span><br><span class="line">   ch, kaerr := cli.KeepAlive(context.TODO(), resp.ID)</span><br><span class="line">   <span class="keyword">if</span> kaerr != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      ka := &lt;-ch</span><br><span class="line">      fmt.Println(<span class="string">&quot;ttl:&quot;</span>, ka.TTL)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;安装golang&quot;&gt;&lt;a href=&quot;#安装golang&quot; class=&quot;headerlink&quot; title=&quot;安装golang&quot;&gt;&lt;/a&gt;安装golang&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install golang&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;etcd单节点安装&quot;&gt;&lt;a href=&quot;#etcd单节点安装&quot; class=&quot;headerlink&quot; title=&quot;etcd单节点安装&quot;&gt;&lt;/a&gt;etcd单节点安装&lt;/h2&gt;</summary>
    
    
    
    <category term="golang" scheme="https://tabbycute.github.io/categories/golang/"/>
    
    
    <category term="golang" scheme="https://tabbycute.github.io/tags/golang/"/>
    
    <category term="linux" scheme="https://tabbycute.github.io/tags/linux/"/>
    
    <category term="etcd" scheme="https://tabbycute.github.io/tags/etcd/"/>
    
  </entry>
  
  <entry>
    <title>docker安装mysql</title>
    <link href="https://tabbycute.github.io/2022/06/14/20220614docker%E5%AE%89%E8%A3%85mysql/"/>
    <id>https://tabbycute.github.io/2022/06/14/20220614docker%E5%AE%89%E8%A3%85mysql/</id>
    <published>2022-06-13T16:00:00.000Z</published>
    <updated>2023-02-09T13:41:07.940Z</updated>
    
    <content type="html"><![CDATA[<p>注意自己的mysql镜像版本</p><p>docker版本20.10.14 </p><p>单机模式</p><ul><li>拉取镜像</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql</span><br></pre></td></tr></table></figure><ul><li>运行容器<blockquote><p>需要把数据库的数据映射到主机（否则容器关闭数据丢失）且，下次使用同样的映射命令创建容器，数据能继续使用</p></blockquote></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p=13306:3306 --privileged=<span class="literal">true</span> \</span><br><span class="line">-v /usr/mysql/log:/var/log/mysql \</span><br><span class="line">-v /usr/mysql/data:/var/lib/mysql \</span><br><span class="line">-v /usr/mysql/conf:/etc/mysql/conf.d \</span><br><span class="line">--name=tabbymysql2 \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=bb123456 \</span><br><span class="line">mysql</span><br></pre></td></tr></table></figure><h4 id="报错解决"><a href="#报错解决" class="headerlink" title="报错解决"></a>报错解决</h4><ul><li>不同版本的映射可能不同比如：5.7</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- /app/mysql/db:/var/lib/mysql</span><br><span class="line">- /app/mysql/conf/my.cnf:/etc/my.cnf</span><br><span class="line">- /app/mysql/init:/docker-entrypoint-init.d</span><br></pre></td></tr></table></figure><ul><li>可能会出现查询乱码</li></ul><p>需要修改数据的默认字符集</p><p>docker的mysql默认字符集是拉丁还是其他的（如下方法查看），会导致中文乱码，navicat查看不会乱码，因为navicat工具自带功能utf8</p><blockquote><p>mysql -uroot -p<br>SHOW VARIABLES LIKE ‘character%’;</p></blockquote><p>解决方法：</p><p>在宿主机中修改配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/mysql/conf/my.cnf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">default_character_set=utf8</span><br><span class="line">[mysqld]</span><br><span class="line">collation_server = utf8_general_ci</span><br><span class="line">character_set_server = utf8</span><br></pre></td></tr></table></figure><p>简单的测试一下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#重启容器</span></span><br><span class="line">docker restart b4f981975015</span><br><span class="line"><span class="comment">#进入容器</span></span><br><span class="line"><span class="comment">#进入sql</span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"><span class="comment">#测试：</span></span><br><span class="line">create database test2;</span><br><span class="line">insert into t1 values(1,<span class="string">&quot;zs&quot;</span>);</span><br><span class="line"><span class="comment">#navicat中：</span></span><br><span class="line">INSERT into test2.t1 VALUES(3,<span class="string">&quot;张三&quot;</span>);</span><br><span class="line"><span class="comment">#docker查询</span></span><br><span class="line">SELECT * FROM t1;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;注意自己的mysql镜像版本&lt;/p&gt;
&lt;p&gt;docker版本20.10.14 &lt;/p&gt;
&lt;p&gt;单机模式&lt;/p&gt;</summary>
    
    
    
    <category term="docker" scheme="https://tabbycute.github.io/categories/docker/"/>
    
    
    <category term="docker" scheme="https://tabbycute.github.io/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>docker安装redis及redis集群</title>
    <link href="https://tabbycute.github.io/2022/06/12/20220612docker%E5%AE%89%E8%A3%85redis%E5%8F%8Aredis%E9%9B%86%E7%BE%A4/"/>
    <id>https://tabbycute.github.io/2022/06/12/20220612docker%E5%AE%89%E8%A3%85redis%E5%8F%8Aredis%E9%9B%86%E7%BE%A4/</id>
    <published>2022-06-11T16:00:00.000Z</published>
    <updated>2023-02-09T13:41:07.940Z</updated>
    
    <content type="html"><![CDATA[<p>需要自己准备一个redis.conf文件</p><p>redis中文官方网站：<a href="http://www.redis.cn/download.html">http://www.redis.cn/download.html</a> 下载解压然后获取文件</p><p>docker版本20.10.14 </p><h3 id="单机模式"><a href="#单机模式" class="headerlink" title="单机模式"></a>单机模式</h3><ul><li><p>获取docker镜像</p><blockquote><p>docker pull redis</p></blockquote></li><li><p>修改准备好的redis.conf文件</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span> 127.0.0.1  修改后  <span class="comment"># bind 127.0.0.1</span></span><br><span class="line">protected-mode <span class="built_in">yes</span> 修改后 protected-mode no</span><br><span class="line"><span class="comment">#设置密码，他这个没有写，随便找一行加上</span></span><br><span class="line">requirepass myPassword修改后 requirepass bb123456</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个配置不能为yes ，他会和docker的 -d 参数冲突</span></span><br><span class="line">daemonize no</span><br><span class="line"></span><br><span class="line"><span class="comment">#redis持久化随意</span></span><br><span class="line">appendonly no</span><br></pre></td></tr></table></figure><ul><li>把上面的文件放入某个目录</li></ul><p>我这里放入 /usr/redis/redis.conf</p><ul><li>启动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p=16379:6379 --name=testredis --privileged=<span class="literal">true</span> \</span><br><span class="line">-v /usr/redis/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-v /usr/redis/data:/data \</span><br><span class="line">redis redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure><h3 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h3><h4 id="启动多个redis（可以在多个服务器上或者在一个上）"><a href="#启动多个redis（可以在多个服务器上或者在一个上）" class="headerlink" title="启动多个redis（可以在多个服务器上或者在一个上）"></a>启动多个redis（可以在多个服务器上或者在一个上）</h4><p>创建并运行docker容器实例</p><blockquote><p>–name redis-node-6 容器名字<br>–net host 使用宿主机的IP和端口，默认<br>–privileged=true 获取宿主机root用户权限<br>-v /data/redis/share/redis-node-6:/data 容器卷，宿主机地址:docker内部地址<br>redis:6.0.8 redis镜像和版本号<br>–cluster-enabled yes 开启redis集群<br>–appendonly yes 开启持久化<br>–port 6386 redis端口号</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name=redis-node-1 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode1:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6381</span><br><span class="line">docker run -d --name=redis-node-2 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode2:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6382</span><br><span class="line">docker run -d --name=redis-node-3 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode3:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6383</span><br><span class="line">docker run -d --name=redis-node-4 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode4:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6384</span><br><span class="line">docker run -d --name=redis-node-5 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode5:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6385</span><br><span class="line">docker run -d --name=redis-node-6 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode6:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6386</span><br></pre></td></tr></table></figure><h4 id="构建集群关系与测试"><a href="#构建集群关系与测试" class="headerlink" title="构建集群关系与测试"></a>构建集群关系与测试</h4><ul><li>随机选取一个节点作为主节点,并进入容器</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it redis-node-1 /bin/bash -it</span><br></pre></td></tr></table></figure><ul><li>构建集群</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create 1.117.72.9:6381 \</span><br><span class="line">1.117.72.9:6382 \</span><br><span class="line">1.117.72.9:6383 \</span><br><span class="line">1.117.72.9:6384 \</span><br><span class="line">1.117.72.9:6385 \</span><br><span class="line">1.117.72.9:6386 \</span><br><span class="line">--cluster-replicas 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入yes</span></span><br><span class="line"><span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重新进入第一个节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-node-1 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用redis</span></span><br><span class="line">redis-cli -p 6381</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看集群状态</span></span><br><span class="line">127.0.0.1:6381&gt; cluster info</span><br><span class="line"><span class="comment">#查看集群节点，当前配置会返回三主三从</span></span><br><span class="line">127.0.0.1:6381&gt; cluster nodes</span><br><span class="line"></span><br><span class="line"><span class="comment">#存储测试</span></span><br><span class="line">127.0.0.1:6381&gt; <span class="built_in">set</span> k1 v1</span><br><span class="line">(error) MOVED 12706 1.117.72.9:6383</span><br><span class="line">127.0.0.1:6381&gt; <span class="built_in">set</span> k2 v2</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment">#上面失败了是因为我在node1节点中，因为node1的节点槽位0-5460，但是存储k1的时候分配的槽位为12706，高于当前节点的5460所以存不进去、</span></span><br><span class="line"><span class="comment">#上面是单机使用redis，应该使用集群模式进入</span></span><br><span class="line">redis-cli -p 6381 -c</span><br><span class="line"></span><br><span class="line"><span class="comment">#清空redis</span></span><br><span class="line">FLUSHALL</span><br><span class="line"></span><br><span class="line"><span class="comment">#存储测试</span></span><br><span class="line">127.0.0.1:6381&gt; <span class="built_in">set</span> k1 v1</span><br><span class="line">-&gt; Redirected to slot [12706] located at 1.117.72.9:6383</span><br><span class="line">OK</span><br><span class="line">1.117.72.9:6383&gt; </span><br><span class="line"></span><br><span class="line"><span class="comment">#Redirected to slot [12706] located at 1.117.72.9:6383  这里k1分配的槽位为12706，但是他会配重定向到合适的节点</span></span><br><span class="line"><span class="comment">#同时还给我跳到了这个节点上</span></span><br></pre></td></tr></table></figure><ul><li>查看集群信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入一个节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-node-1 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看信息</span></span><br><span class="line">redis-cli --cluster check 1.117.72.9:6382</span><br><span class="line"></span><br><span class="line">root@VM-4-14-centos:/data<span class="comment"># redis-cli --cluster check 1.117.72.9:6382</span></span><br><span class="line">1.117.72.9:6382 (544721f6...) -&gt; 0 keys | 5462 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6383 (893773f4...) -&gt; 1 keys | 5461 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6381 (ea6144e4...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line">[OK] 1 keys <span class="keyword">in</span> 3 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 1.117.72.9:6382)</span><br><span class="line">M: 544721f66ef390e6536bd7314e0f367b776fa369 1.117.72.9:6382</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 821e7809ebd937c7abfc25460ddeba1e22587ac2 1.117.72.9:6385</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates ea6144e47cd29369eceaf3406cc51b85daa672a4</span><br><span class="line">S: 0ac5588e0826bfe7242e193150404412360c5197 1.117.72.9:6386</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 544721f66ef390e6536bd7314e0f367b776fa369</span><br><span class="line">M: 893773f4b7f1e15f0477056c4895aad7d6076ca4 1.117.72.9:6383</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 60a5f33a6ae6c4dc892613e0243b3bb371b6fc70 1.117.72.9:6384</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 893773f4b7f1e15f0477056c4895aad7d6076ca4</span><br><span class="line">M: ea6144e47cd29369eceaf3406cc51b85daa672a4 1.117.72.9:6381</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure><h4 id="主从容错切换分析与实现"><a href="#主从容错切换分析与实现" class="headerlink" title="主从容错切换分析与实现"></a>主从容错切换分析与实现</h4><ul><li>当前的三主三从</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1       5</span><br><span class="line"></span><br><span class="line">2       6</span><br><span class="line"></span><br><span class="line">3       4</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>停止节点1</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1[X]    5</span><br><span class="line"></span><br><span class="line">2       6</span><br><span class="line"></span><br><span class="line">3       4</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>过一分钟左右，进入节点2查看集群节点，可以看到1对应的5直接成为了master</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker stop redis-node-1</span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-node-2 /bin/bash</span><br><span class="line"></span><br><span class="line">redis-cli -p 6382 -c</span><br><span class="line"></span><br><span class="line">127.0.0.1:6382&gt; cluster nodes</span><br><span class="line">544721f66ef390e6536bd7314e0f367b776fa369 10.0.4.14:6382@16382 myself,master - 0 1665762114000 2 connected 5461-10922</span><br><span class="line">821e7809ebd937c7abfc25460ddeba1e22587ac2 1.117.72.9:6385@16385 master - 0 1665762115241 7 connected 0-5460</span><br><span class="line">0ac5588e0826bfe7242e193150404412360c5197 1.117.72.9:6386@16386 slave 544721f66ef390e6536bd7314e0f367b776fa369 0 1665762112000 2 connected</span><br><span class="line">893773f4b7f1e15f0477056c4895aad7d6076ca4 1.117.72.9:6383@16383 master - 0 1665762114000 3 connected 10923-16383</span><br><span class="line">60a5f33a6ae6c4dc892613e0243b3bb371b6fc70 1.117.72.9:6384@16384 slave 893773f4b7f1e15f0477056c4895aad7d6076ca4 0 1665762114240 3 connected</span><br><span class="line">ea6144e47cd29369eceaf3406cc51b85daa672a4 1.117.72.9:6381@16381 master,fail - 1665761820440 1665761816433 1 disconnected</span><br></pre></td></tr></table></figure><ul><li>重新启动节点1，可以看到节点5任然是master，节点1变成了slave</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5       1</span><br><span class="line"></span><br><span class="line">2       6</span><br><span class="line"></span><br><span class="line">3       4</span><br></pre></td></tr></table></figure><ul><li>如果你还行让节点1为主机，节点5成从机，那么就先停掉，节点5，在启动节点5….</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker start redis-node-1</span><br><span class="line"></span><br><span class="line">127.0.0.1:6382&gt; cluster nodes</span><br><span class="line">544721f66ef390e6536bd7314e0f367b776fa369 10.0.4.14:6382@16382 myself,master - 0 1665762514000 2 connected 5461-10922</span><br><span class="line">821e7809ebd937c7abfc25460ddeba1e22587ac2 1.117.72.9:6385@16385 master - 0 1665762517279 7 connected 0-5460</span><br><span class="line">0ac5588e0826bfe7242e193150404412360c5197 1.117.72.9:6386@16386 slave 544721f66ef390e6536bd7314e0f367b776fa369 0 1665762516000 2 connected</span><br><span class="line">893773f4b7f1e15f0477056c4895aad7d6076ca4 1.117.72.9:6383@16383 master - 0 1665762516000 3 connected 10923-16383</span><br><span class="line">60a5f33a6ae6c4dc892613e0243b3bb371b6fc70 1.117.72.9:6384@16384 slave 893773f4b7f1e15f0477056c4895aad7d6076ca4 0 1665762515000 3 connected</span><br><span class="line">ea6144e47cd29369eceaf3406cc51b85daa672a4 1.117.72.9:6381@16381 slave 821e7809ebd937c7abfc25460ddeba1e22587ac2 0 1665762516278 7 connected</span><br></pre></td></tr></table></figure><h4 id="redis集群扩容"><a href="#redis集群扩容" class="headerlink" title="redis集群扩容"></a>redis集群扩容</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5       1</span><br><span class="line"></span><br><span class="line">2       6</span><br><span class="line"></span><br><span class="line">3       4</span><br></pre></td></tr></table></figure><p>我这里使用的是其他的服务器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先增加两个节点</span></span><br><span class="line">docker run -d --name=redis-node-7 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode7:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6387</span><br><span class="line">docker run -d --name=redis-node-8 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode8:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6388</span><br><span class="line"><span class="comment">#进入节点7</span></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-node-7 /bin/bash</span><br><span class="line"><span class="comment">#将新增的6387作为master节点加入集群</span></span><br><span class="line"><span class="comment">#6387就是将要作为master新增节点</span></span><br><span class="line"><span class="comment">#1.117.72.9:6385就是原来集群节点里面的领路人，相当于47.92.80.135:6387拜拜1.117.72.9:6385的码头从而找到组织加入集群</span></span><br><span class="line">redis-cli --cluster add-node 47.92.80.135:6387 1.117.72.9:6385</span><br><span class="line"></span><br><span class="line"><span class="comment">#在节点1中查看集群状态，并且重新分配槽号（其实随便在哪个节点中，只不是通过某个机器执行集群命令，随意）</span></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-node-1 /bin/bas</span><br><span class="line"></span><br><span class="line">redis-cli --cluster check 127.0.0.1:6381</span><br><span class="line"><span class="comment">#可以发现节点7虽然是master但是没有分配槽位</span></span><br><span class="line"></span><br><span class="line">47.92.80.135:6387 (27313d8b...) -&gt; 0 keys | 0 slots | 0 slaves.</span><br><span class="line">1.117.72.9:6383 (893773f4...) -&gt; 1 keys | 5461 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6382 (544721f6...) -&gt; 0 keys | 5462 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6385 (821e7809...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line">[OK] 1 keys <span class="keyword">in</span> 4 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:6381)</span><br><span class="line">S: ea6144e47cd29369eceaf3406cc51b85daa672a4 127.0.0.1:6381</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 821e7809ebd937c7abfc25460ddeba1e22587ac2</span><br><span class="line">M: 27313d8b85918737d08e068ef0c1eecf7d82211b 47.92.80.135:6387</span><br><span class="line">   slots: (0 slots) master</span><br><span class="line">M: 893773f4b7f1e15f0477056c4895aad7d6076ca4 1.117.72.9:6383</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 60a5f33a6ae6c4dc892613e0243b3bb371b6fc70 1.117.72.9:6384</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 893773f4b7f1e15f0477056c4895aad7d6076ca4</span><br><span class="line">S: 0ac5588e0826bfe7242e193150404412360c5197 1.117.72.9:6386</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 544721f66ef390e6536bd7314e0f367b776fa369</span><br><span class="line">M: 544721f66ef390e6536bd7314e0f367b776fa369 1.117.72.9:6382</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 821e7809ebd937c7abfc25460ddeba1e22587ac2 1.117.72.9:6385</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#在节点7中重新分配槽位（其实随便在哪个节点中，只不是通过某个机器执行集群命令，随意）</span></span><br><span class="line">redis-cli --cluster reshard 1.117.72.9:6385</span><br><span class="line"></span><br><span class="line"><span class="comment">#你想要移动多少槽位</span></span><br><span class="line"><span class="comment">#我这里分配的是4096 = 16383 / master数量</span></span><br><span class="line">How many slots <span class="keyword">do</span> you want to move (from 1 to 16384)? 4096</span><br><span class="line"></span><br><span class="line"><span class="comment">#需要移动到那一个节点上面（ID）</span></span><br><span class="line">what is the receiving node ID? 27313d8b85918737d08e068ef0c1eecf7d8221</span><br><span class="line"></span><br><span class="line"><span class="comment">#all 为自动分配，第二种方式为手动分配。</span></span><br><span class="line">Please enter all the <span class="built_in">source</span> node IDs.</span><br><span class="line">Type <span class="string">&#x27;all&#x27;</span> to use all the nodes as <span class="built_in">source</span> nodes <span class="keyword">for</span> the <span class="built_in">hash</span> slots.</span><br><span class="line">Type <span class="string">&#x27;done&#x27;</span> once you entered all the <span class="built_in">source</span> nodes IDs.</span><br><span class="line"></span><br><span class="line"><span class="comment">#我这里选择all</span></span><br><span class="line">Source node <span class="comment">#1: all</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#中途会输入yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#完了过后重新查看分配的结果</span></span><br><span class="line"></span><br><span class="line">root@tabby-aliyun:/data<span class="comment"># redis-cli --cluster check 127.0.0.1:6387</span></span><br><span class="line">127.0.0.1:6387 (27313d8b...) -&gt; 0 keys | 4096 slots | 0 slaves.</span><br><span class="line">1.117.72.9:6382 (544721f6...) -&gt; 0 keys | 4096 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6385 (821e7809...) -&gt; 0 keys | 4096 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6383 (893773f4...) -&gt; 1 keys | 4096 slots | 1 slaves.</span><br><span class="line">[OK] 1 keys <span class="keyword">in</span> 4 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:6387)</span><br><span class="line">M: 27313d8b85918737d08e068ef0c1eecf7d82211b 127.0.0.1:6387</span><br><span class="line">   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master</span><br><span class="line">S: ea6144e47cd29369eceaf3406cc51b85daa672a4 1.117.72.9:6381</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 821e7809ebd937c7abfc25460ddeba1e22587ac2</span><br><span class="line">M: 544721f66ef390e6536bd7314e0f367b776fa369 1.117.72.9:6382</span><br><span class="line">   slots:[6827-10922] (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 821e7809ebd937c7abfc25460ddeba1e22587ac2 1.117.72.9:6385</span><br><span class="line">   slots:[1365-5460] (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 60a5f33a6ae6c4dc892613e0243b3bb371b6fc70 1.117.72.9:6384</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 893773f4b7f1e15f0477056c4895aad7d6076ca4</span><br><span class="line">S: 0ac5588e0826bfe7242e193150404412360c5197 1.117.72.9:6386</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 544721f66ef390e6536bd7314e0f367b776fa369</span><br><span class="line">M: 893773f4b7f1e15f0477056c4895aad7d6076ca4 1.117.72.9:6383</span><br><span class="line">   slots:[12288-16383] (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"></span><br><span class="line"><span class="comment">#对边前后的变化，可以看出他的节点并不是重新分配，而是从每个节点上抽出一点点给新节点</span></span><br><span class="line">47.92.80.135:6387 (27313d8b...) -&gt; 0 keys | 0 slots | 0 slaves.</span><br><span class="line">1.117.72.9:6383 (893773f4...) -&gt; 1 keys | 5461 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6382 (544721f6...) -&gt; 0 keys | 5462 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6385 (821e7809...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line"></span><br><span class="line">127.0.0.1:6387 (27313d8b...) -&gt; 0 keys | 4096 slots | 0 slaves.</span><br><span class="line">1.117.72.9:6382 (544721f6...) -&gt; 0 keys | 4096 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6385 (821e7809...) -&gt; 0 keys | 4096 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6383 (893773f4...) -&gt; 1 keys | 4096 slots | 1 slaves.</span><br><span class="line"></span><br><span class="line">M: 27313d8b85918737d08e068ef0c1eecf7d82211b 47.92.80.135:6387</span><br><span class="line">   slots: (0 slots) master</span><br><span class="line"></span><br><span class="line">M: 27313d8b85918737d08e068ef0c1eecf7d82211b 127.0.0.1:6387</span><br><span class="line">   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master</span><br><span class="line"></span><br><span class="line"><span class="comment">#给节点7挂载从机47.92.80.135:6388</span></span><br><span class="line">redis-cli --cluster add-node 47.92.80.135:6388 47.92.80.135:6387 --cluster-slave --cluster-master-id 27313d8b85918737d08e068ef0c1eecf7d82211b</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="redis集群缩容"><a href="#redis集群缩容" class="headerlink" title="redis集群缩容"></a>redis集群缩容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">7       8</span><br><span class="line"></span><br><span class="line">5       1</span><br><span class="line"></span><br><span class="line">2       6</span><br><span class="line"></span><br><span class="line">3       4</span><br><span class="line"></span><br><span class="line">将6388，6387从集群删除</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入节点5</span></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-node-5 /bin./bash</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看集群状态</span></span><br><span class="line">redis-cli --cluster check 127.0.0.1:6387</span><br><span class="line"></span><br><span class="line"><span class="comment">#拿到节点7和8</span></span><br><span class="line">S: b4ca84a31f5fc5129f6e201e8db85dad2d256b21 47.92.80.135:6388</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 27313d8b85918737d08e068ef0c1eecf7d82211b</span><br><span class="line">M: 27313d8b85918737d08e068ef0c1eecf7d82211b 47.92.80.135:6387</span><br><span class="line">   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">   </span><br><span class="line"><span class="comment">#删除从节点8</span></span><br><span class="line">redis-cli --cluster del-node 47.92.80.135:6388 b4ca84a31f5fc5129f6e201e8db85dad2d256b21</span><br><span class="line">&gt;&gt;&gt; Removing node b4ca84a31f5fc5129f6e201e8db85dad2d256b21 from cluster 47.92.80.135:6388</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.</span><br><span class="line"></span><br><span class="line"><span class="comment">#检查一下是否已经删除</span></span><br><span class="line"><span class="comment">#清空6387的槽号，重新分配给6385（只不是通过6385机器执行集群命令，随意）</span></span><br><span class="line"><span class="comment">#通过6385执行命令</span></span><br><span class="line">redis-cli --cluster reshard 1.117.72.9:6385</span><br><span class="line"></span><br><span class="line"><span class="comment">#把6387上的4096个槽位移除</span></span><br><span class="line">How many slots <span class="keyword">do</span> you want to move (from 1 to 16384)? 4096</span><br><span class="line"></span><br><span class="line"><span class="comment">#6387的id</span></span><br><span class="line">What is the receiving node ID? 821e7809ebd937c7abfc25460ddeba1e22587ac2</span><br><span class="line">Please enter all the <span class="built_in">source</span> node IDs.</span><br><span class="line">  Type <span class="string">&#x27;all&#x27;</span> to use all the nodes as <span class="built_in">source</span> nodes <span class="keyword">for</span> the <span class="built_in">hash</span> slots.</span><br><span class="line">  Type <span class="string">&#x27;done&#x27;</span> once you entered all the <span class="built_in">source</span> nodes IDs.</span><br><span class="line">  </span><br><span class="line"><span class="comment">#移动到6385上，这里是6385的id</span></span><br><span class="line">Source node <span class="comment">#1: 27313d8b85918737d08e068ef0c1eecf7d82211b</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#输入done</span></span><br><span class="line">Source node <span class="comment">#2: done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#输入yes</span></span><br><span class="line"><span class="comment">#检查集群的状态</span></span><br><span class="line"></span><br><span class="line">root@VM-4-14-centos:/data<span class="comment"># redis-cli --cluster check 1.117.72.9:6385</span></span><br><span class="line">1.117.72.9:6385 (821e7809...) -&gt; 0 keys | 8192 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6383 (893773f4...) -&gt; 1 keys | 4096 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6382 (544721f6...) -&gt; 0 keys | 4096 slots | 1 slaves.</span><br><span class="line">47.92.80.135:6387 (27313d8b...) -&gt; 0 keys | 0 slots | 0 slaves.</span><br><span class="line"></span><br><span class="line"><span class="comment">#4096个槽位都指给6381，它变成了8192个槽位，相当于全部都给6381了，不然要输入3次，一锅端</span></span><br><span class="line"><span class="comment">#如果你需要平均分配给剩下的主机，那么要重新分配三次</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#删除6387</span></span><br><span class="line">redis-cli --cluster del-node 47.92.80.135:6387 27313d8b85918737d08e068ef0c1eecf7d82211b</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Removing node 27313d8b85918737d08e068ef0c1eecf7d82211b from cluster 47.92.80.135:6387</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;需要自己准备一个redis.conf文件&lt;/p&gt;
&lt;p&gt;redis中文官方网站：&lt;a href=&quot;http://www.redis.cn/download.html&quot;&gt;http://www.redis.cn/download.html&lt;/a&gt; 下载解压然后获取文件&lt;/p&gt;
&lt;p&gt;docker版本20.10.14 &lt;/p&gt;</summary>
    
    
    
    <category term="docker" scheme="https://tabbycute.github.io/categories/docker/"/>
    
    
    <category term="docker" scheme="https://tabbycute.github.io/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>docker及相关的安装</title>
    <link href="https://tabbycute.github.io/2022/06/10/20220610docker%E7%9A%84%E5%AE%89%E8%A3%85/"/>
    <id>https://tabbycute.github.io/2022/06/10/20220610docker%E7%9A%84%E5%AE%89%E8%A3%85/</id>
    <published>2022-06-09T16:00:00.000Z</published>
    <updated>2023-02-09T13:41:07.939Z</updated>
    
    <content type="html"><![CDATA[<p>centos 7.9</p><p>docker-compose根据自己情况安装</p><p>yum选择自己合适的</p><h3 id="官网推荐安装"><a href="#官网推荐安装" class="headerlink" title="官网推荐安装"></a>官网推荐安装</h3><hr><ul><li>卸载旧版本<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">      docker-client \</span><br><span class="line">      docker-client-latest \</span><br><span class="line">      docker-common \</span><br><span class="line">      docker-latest \</span><br><span class="line">      docker-latest-logrotate \</span><br><span class="line">      docker-logrotate \</span><br><span class="line">      docker-engine</span><br><span class="line"><span class="comment">#卸载 Docker Engine、CLI、Containerd 和 Docker Compose 软件包：</span></span><br><span class="line">yum remove docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br><span class="line"><span class="comment">#主机上的映像、容器、卷或自定义配置文件不会自动删除。要删除所有映像、容器和卷：</span></span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/docker</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/containerd</span><br></pre></td></tr></table></figure></li></ul><h3 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h3><hr><ul><li>设置存储库。安装yum-utils包（提供yum-config-manager 实用程序）并设置存储库。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置源</span></span><br><span class="line"><span class="comment">#可以使用阿里源，最好选这个</span></span><br><span class="line">yum-config-manager --add-repo=http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment">#官方</span></span><br><span class="line">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">yum makecache <span class="comment">#重新构建缓存</span></span><br><span class="line"></span><br><span class="line">yum repolist &#123;all|enabled|disabled&#125;             <span class="comment">#列出所有/已启用/已禁用的yum源</span></span><br><span class="line">yum --disablerepo=repo                          <span class="comment">#临时禁用某个repo源</span></span><br><span class="line">yum --enablerepo=repo                          <span class="comment">#解除禁用某个repo源</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>安装 Docker 引擎。安装最新版本的 Docker Engine、containerd 和 Docker Compose </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure><ul><li>要安装特定版本的 Docker Engine，请在 repo 中列出可用版本，然后选择并安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | <span class="built_in">sort</span> -r</span><br><span class="line"></span><br><span class="line">docker-ce.x86_64            3:20.10.19-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:20.10.18-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:20.10.17-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:20.10.16-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:20.10.15-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:20.10.14-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:20.10.1-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:20.10.13-3.el7                    docker-ce-stable</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>安装。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认安装</span></span><br><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br><span class="line"><span class="comment">#可以选择版本</span></span><br><span class="line">sudo yum install docker-ce-20.10.14 docker-ce-cli-20.10.14 containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure><ul><li>结束</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start docker       <span class="comment">#启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker      <span class="comment">#开机启动</span></span><br><span class="line">docker version                    <span class="comment">#查看版本</span></span><br><span class="line">docker run hello-world            <span class="comment">#示例进项</span></span><br></pre></td></tr></table></figure><blockquote><p>出现报错</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;Transaction check error:</span><br><span class="line"> file /usr/libexec/docker/cli-plugins/docker-buildx from install of docker-ce-cli-1:20.10.14-3.el7.x86_64 conflicts with file from package docker-buildx-plugin-0:0.10.2-1.el7.x86_64</span><br><span class="line">Error Summary</span><br></pre></td></tr></table></figure><p>用 yum list installed | grep docker 查看，<br>然后删除相关的 rpm -e docker-buildx-plugin.x86_64 , rpm -e *** , rpm -e *** </p></blockquote><h3 id="官网脚本安装"><a href="#官网脚本安装" class="headerlink" title="官网脚本安装"></a>官网脚本安装</h3><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com -o get-docker.sh</span><br><span class="line"></span><br><span class="line">sudo sh get-docker.sh</span><br><span class="line">或者</span><br><span class="line">sudo DRY_RUN=1 sh ./get-docker.sh</span><br></pre></td></tr></table></figure><blockquote><p>官网主站 <a href="https://docs.docker.com/">https://docs.docker.com/</a><br>历史版本 <a href="https://download.docker.com/linux/static/stable/x86_64/">https://download.docker.com/linux/static/stable/x86_64/</a><br>镜像 <a href="https://hub.docker.com/search?q=">https://hub.docker.com/search?q=</a><br>官网安装 <a href="https://docs.docker.com/engine/install/centos/">https://docs.docker.com/engine/install/centos/</a></p></blockquote><h3 id="docker-compose安装"><a href="#docker-compose安装" class="headerlink" title="docker-compose安装"></a>docker-compose安装</h3><h4 id="官方安装"><a href="#官方安装" class="headerlink" title="官方安装"></a>官方安装</h4><ul><li><p>官网选择版本 <a href="https://github.com/docker/compose/releases">https://github.com/docker/compose/releases</a> </p></li><li><p>以下命令手动修改版本号,例如1.24.1</p><blockquote><p>curl -L <a href="https://github.com/docker/compose/releases/download/1.24.1/docker-compose-%60uname">https://github.com/docker/compose/releases/download/1.24.1/docker-compose-`uname</a> -s<code>-</code>uname -m` -o /usr/local/bin/docker-compose</p></blockquote></li><li><p>添加执行权限chmod +x /usr/local/bin/docker-compose</p></li><li><p>检查docker compose版本docker-compose version</p></li></ul><h4 id="手动安装"><a href="#手动安装" class="headerlink" title="手动安装"></a>手动安装</h4><ul><li><p>官网选择版本 <a href="https://github.com/docker/compose/releases">https://github.com/docker/compose/releases</a> </p></li><li><p>选择相应版本,下载docker-compose-Linux-x86_64到本地或者服务器中</p></li><li><p>更名为docker-compose,并移动到 /usr/local/bin 目录下 </p></li><li><p>添加执行权限chmod +x /usr/local/bin/docker-compose</p></li><li><p>检查docker compose版本docker-compose version</p></li></ul><h3 id="安装gcc"><a href="#安装gcc" class="headerlink" title="安装gcc"></a>安装gcc</h3><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc</span><br><span class="line">yum -y install gcc c++</span><br></pre></td></tr></table></figure><h3 id="镜像加速"><a href="#镜像加速" class="headerlink" title="镜像加速"></a>镜像加速</h3><hr><ul><li>创建 /etc/docker</li><li>加入地址</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;https://mirror.ccs.tencentyun.com&quot;</span></span><br><span class="line">     ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;centos 7.9&lt;/p&gt;
&lt;p&gt;docker-compose根据自己情况安装&lt;/p&gt;
&lt;p&gt;yum选择自己合适的&lt;/p&gt;</summary>
    
    
    
    <category term="docker" scheme="https://tabbycute.github.io/categories/docker/"/>
    
    
    <category term="linux" scheme="https://tabbycute.github.io/tags/linux/"/>
    
    <category term="docker" scheme="https://tabbycute.github.io/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>IM项目中electron对文件加密的方案设计与落地</title>
    <link href="https://tabbycute.github.io/2022/05/08/20220508IM%E9%A1%B9%E7%9B%AE%E4%B8%ADelectron%E5%AF%B9%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E7%9A%84%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E4%B8%8E%E8%90%BD%E5%9C%B0/"/>
    <id>https://tabbycute.github.io/2022/05/08/20220508IM%E9%A1%B9%E7%9B%AE%E4%B8%ADelectron%E5%AF%B9%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E7%9A%84%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E4%B8%8E%E8%90%BD%E5%9C%B0/</id>
    <published>2022-05-07T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.047Z</updated>
    
    <content type="html"><![CDATA[<p>文本加密很好实现，但是文件加密就稍微麻烦点。</p><p>但是我的预期加密的规则需要兼容老版本能够分辨出老版本未加密的文件，因为我们用户还可能查看老版本的聊天记录。能够分别不同版本规则的加密文件。文件不能全加密，效率要高。加密过后的文件大小，不能太大，要节约oss资源控制成本，这里我改成了一个参，可以手动设置加密后的文件新增的大小。视情况而定。</p><p>最终的加密路线如下：</p><p><img src="%22assets/img/202202041.png%22"></p><p>核心代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TBFileRules</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> checkHeadSign=[<span class="string">&quot;abcdabcdabcdabc&quot;</span>,<span class="string">&quot;abcdabcdabcdabcd&quot;</span>]                     <span class="comment">///解密时使用。是否符合解密文件。</span></span><br><span class="line">    <span class="keyword">static</span> headSign=&#123;<span class="attr">sign</span>:<span class="string">&quot;abcdabcdabcdabcd&quot;</span>,<span class="attr">headLen</span>:<span class="number">1024</span>/<span class="number">2</span>&#125;                        <span class="comment">///加密时使用。标记为加密文件。对象编译过后的字节长度不能超过50</span></span><br><span class="line">    <span class="keyword">static</span> appKey=<span class="string">&quot;tabby&quot;</span>                                                           <span class="comment">///appkey</span></span><br><span class="line">    <span class="keyword">static</span> encDataLen=<span class="number">1024</span>*<span class="number">10</span>;                                                      <span class="comment">///加密的长度，文件小于这个长度全加密 默认只加密10kb</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; -sgin:app签名</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -headLen:文件头的总长度</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileLen:文件的原长</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileEncLen:文件加密后总体的长度（不含头）</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileDataLen:加密段加密前的长度</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileDataEncLen:加密段加密后的长度</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileEncStart:加密后加密段开始的位置（不含头）</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; -ext:预留拓展字段</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">generateHeaderByte</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> &#123;fileLen,fileEncLen,fileDataLen,fileDataEncLen,fileEncStart,ext&#125;=opt;</span><br><span class="line">        <span class="keyword">let</span> header=&#123;&#125;</span><br><span class="line">        header.<span class="property">sgin</span>=<span class="title class_">TBFileRules</span>.<span class="property">appKey</span>;                     <span class="comment">///32 位app签名</span></span><br><span class="line">        header.<span class="property">headLenSign</span>=<span class="number">50</span>;                              <span class="comment">///加密标识的长度</span></span><br><span class="line">        header.<span class="property">headLen</span>=<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>.<span class="property">headLen</span>;        <span class="comment">///文件头的总长度</span></span><br><span class="line">        header.<span class="property">fileLen</span>=fileLen;                             <span class="comment">///文件的原长</span></span><br><span class="line">        header.<span class="property">fileEncLen</span>=fileEncLen;                       <span class="comment">///文件加密后总体的长度（不含头）</span></span><br><span class="line">        header.<span class="property">fileDataLen</span>=fileDataLen;                     <span class="comment">///加密段加密前的长度</span></span><br><span class="line">        header.<span class="property">fileDataEncLen</span>=fileDataEncLen;               <span class="comment">///加密段加密后的长度</span></span><br><span class="line">        header.<span class="property">fileEncStart</span>=fileEncStart;                   <span class="comment">///加密后加密段开始的位置（不含头）</span></span><br><span class="line">        header.<span class="property">ext</span>=ext;                                     <span class="comment">///预留拓展字段</span></span><br><span class="line">        <span class="comment">// console.log(header)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">TBFileRules</span>.<span class="title function_">strToByte</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(header))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        检查是否为加密文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Uint8Array</span>&#125; -source:源文件</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">checkIsEncFile</span>(<span class="params">source</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> headSign=<span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">TBFileRules</span>.<span class="title function_">byteToStr</span>(<span class="title class_">TBFileRules</span>.<span class="title function_">unshif0</span>(source.<span class="title function_">slice</span>(<span class="number">0</span>,<span class="number">50</span>))))</span><br><span class="line">            <span class="keyword">if</span>(<span class="title class_">TBFileRules</span>.<span class="property">checkHeadSign</span>.<span class="title function_">indexOf</span>(headSign.<span class="property">sign</span>)&gt;-<span class="number">1</span>)<span class="keyword">return</span> headSign</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        加密文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">CryptoJSTB</span>&#125; -cjstb:CryptoJSTB 实例</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Uint8Array</span>&#125; -source:源文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125;     -ext:拓展</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">encData</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> &#123;cjstb,source,ext&#125;=opt</span><br><span class="line"></span><br><span class="line">            source=<span class="title class_">Array</span>.<span class="title function_">from</span>(source)</span><br><span class="line">            <span class="keyword">if</span>(!ext)ext=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> encDataU8=[],                               <span class="comment">//加密前的加密段</span></span><br><span class="line">                fileEnd=<span class="title class_">TBFileRules</span>.<span class="property">encDataLen</span>,             <span class="comment">//加密结束的位置</span></span><br><span class="line">                encDataSourceU8=[],                         <span class="comment">//加密后的加密段</span></span><br><span class="line">                sourceOtherData=[],                         <span class="comment">//未加密的部分</span></span><br><span class="line">                sourceEecData=[];                           <span class="comment">//未加密的部分</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(fileEnd&gt;source.<span class="property">length</span>)fileEnd=source.<span class="property">length</span></span><br><span class="line">            <span class="keyword">else</span> sourceOtherData=source.<span class="title function_">slice</span>(fileEnd)</span><br><span class="line"></span><br><span class="line">            encDataU8=source.<span class="title function_">slice</span>(<span class="number">0</span>,fileEnd)</span><br><span class="line">            encDataSourceU8=cjstb.<span class="title function_">encByteAES</span>(encDataU8)</span><br><span class="line">            sourceEecData=[...encDataSourceU8,...sourceOtherData]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> headerParams = <span class="title class_">TBFileRules</span>.<span class="title function_">generateHeaderByte</span>(&#123;</span><br><span class="line">                <span class="attr">fileLen</span>:source.<span class="property">length</span>,</span><br><span class="line">                <span class="attr">fileEncLen</span>:sourceEecData.<span class="property">length</span>,</span><br><span class="line">                <span class="attr">fileDataLen</span>:encDataU8.<span class="property">length</span>,</span><br><span class="line">                <span class="attr">fileDataEncLen</span>:encDataSourceU8.<span class="property">length</span>,</span><br><span class="line">                ext</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">var</span> headerSign = <span class="title class_">TBFileRules</span>.<span class="title function_">strToByte</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(headerSign.<span class="property">length</span>&lt;=<span class="number">50</span>)&#123;</span><br><span class="line">                <span class="keyword">let</span> ent=[]</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">50</span>-headerSign.<span class="property">length</span>;i++)&#123;ent.<span class="title function_">push</span>(<span class="number">0</span>)&#125;</span><br><span class="line">                headerSign=[...headerSign,...ent]</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_">reject</span>(&#123;<span class="attr">code</span>:<span class="number">0</span>,<span class="attr">msg</span>:<span class="string">&quot;headerSign.length  too long 50&quot;</span>&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> head=[...headerSign,...headerParams]</span><br><span class="line">           </span><br><span class="line">            <span class="keyword">if</span>(head.<span class="property">length</span>&lt;<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>.<span class="property">headLen</span>)&#123;</span><br><span class="line">                <span class="keyword">let</span> ent=[]</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>.<span class="property">headLen</span>-head.<span class="property">length</span>;i++)&#123;ent.<span class="title function_">push</span>(<span class="number">0</span>)&#125;</span><br><span class="line">                head=[...head,...ent]</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_">reject</span>(&#123;<span class="attr">code</span>:<span class="number">0</span>,<span class="attr">msg</span>:<span class="string">&quot;File head too long&quot;</span>&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_">resolve</span>(&#123;<span class="attr">code</span>:<span class="number">1</span>,<span class="attr">data</span>:<span class="keyword">new</span> <span class="title class_">Uint8Array</span>([...head,...sourceEecData])&#125;)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        解密密文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">CryptoJSTB</span>&#125; -cjstb:CryptoJSTB 实例</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Uint8Array</span>&#125; -source:源文件</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">decData</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> &#123;source,cjstb&#125;=opt</span><br><span class="line">            source=<span class="title class_">Array</span>.<span class="title function_">from</span>(source)</span><br><span class="line">            <span class="keyword">var</span> headSign=<span class="title class_">TBFileRules</span>.<span class="title function_">checkIsEncFile</span>(source)</span><br><span class="line">            <span class="keyword">if</span>(!headSign)&#123;</span><br><span class="line">                <span class="title function_">reject</span>(&#123;<span class="attr">code</span>:<span class="number">0</span>,<span class="attr">msg</span>:<span class="string">&quot;Failed to parse file&quot;</span>&#125;)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> headParamsByte = source.<span class="title function_">slice</span>(<span class="number">50</span>,headSign.<span class="property">headLen</span>)</span><br><span class="line">            <span class="keyword">var</span> headParamsByteUnfit0 = <span class="title class_">TBFileRules</span>.<span class="title function_">unshif0</span>(headParamsByte)</span><br><span class="line">            <span class="keyword">var</span> headParams = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">TBFileRules</span>.<span class="title function_">byteToStr</span>(headParamsByteUnfit0))</span><br><span class="line">            <span class="keyword">var</span> encData=source.<span class="title function_">slice</span>(headSign.<span class="property">headLen</span>,headSign.<span class="property">headLen</span> + headParams.<span class="property">fileDataEncLen</span>)</span><br><span class="line">            <span class="keyword">var</span> otherData=source.<span class="title function_">slice</span>(headSign.<span class="property">headLen</span> + headParams.<span class="property">fileDataEncLen</span>)</span><br><span class="line">            <span class="keyword">var</span> decData=cjstb.<span class="title function_">decByteAES</span>(encData)</span><br><span class="line">            <span class="title function_">resolve</span>(&#123;</span><br><span class="line">                <span class="attr">code</span>:<span class="number">1</span>,</span><br><span class="line">                <span class="attr">params</span>:headParams,</span><br><span class="line">                <span class="attr">data</span>:<span class="keyword">new</span> <span class="title class_">Uint8Array</span>([...decData,...otherData])</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        文件转u8</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">file</span>&#125;</span></span><br><span class="line"><span class="comment">        <span class="doctag">@return</span> &#123;<span class="type">Promise&lt;Uint8Array&gt;</span>&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">fileToUint8</span>(<span class="params">file</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span><br><span class="line">            reader.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;<span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(e.<span class="property">target</span>.<span class="property">result</span>))&#125;</span><br><span class="line">            reader.<span class="title function_">readAsArrayBuffer</span>(file);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">saveFile</span>(<span class="params">uint8List,fileName</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> blob=<span class="keyword">new</span> <span class="title class_">Blob</span>([uint8List]);</span><br><span class="line">        <span class="keyword">const</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">        link.<span class="property">href</span> = <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span><br><span class="line">        link.<span class="property">download</span> = fileName;</span><br><span class="line">        link.<span class="title function_">click</span>();</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">revokeObjectURL</span>(link.<span class="property">href</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">///去除字节最后的0</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">unshif0</span>(<span class="params">list</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> data=[...list]</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;list.<span class="property">length</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(data[data.<span class="property">length</span>-<span class="number">1</span>])<span class="keyword">return</span> data</span><br><span class="line">            <span class="keyword">else</span> data.<span class="title function_">pop</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">strToByte</span>(<span class="params">str</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line">        <span class="keyword">var</span> len, c;</span><br><span class="line">        len = str.<span class="property">length</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            c = str.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">            <span class="keyword">if</span> (c &gt;= <span class="number">0x010000</span> &amp;&amp; c &lt;= <span class="number">0x10FFFF</span>) &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">18</span>) &amp; <span class="number">0x07</span>) | <span class="number">0xF0</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>((c &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &gt;= <span class="number">0x000800</span> &amp;&amp; c &lt;= <span class="number">0x00FFFF</span>) &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x0F</span>) | <span class="number">0xE0</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>((c &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &gt;= <span class="number">0x000080</span> &amp;&amp; c &lt;= <span class="number">0x0007FF</span>) &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x1F</span>) | <span class="number">0xC0</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>((c &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(c &amp; <span class="number">0xFF</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">byteToStr</span>(<span class="params">utf8Bytes</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> unicodeStr =<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> pos = <span class="number">0</span>; pos &lt; utf8Bytes.<span class="property">length</span>;)&#123;</span><br><span class="line">            <span class="keyword">var</span> flag= utf8Bytes[pos];</span><br><span class="line">            <span class="keyword">var</span> unicode = <span class="number">0</span> ;</span><br><span class="line">            <span class="keyword">if</span> ((flag &gt;&gt;&gt;<span class="number">7</span>) === <span class="number">0</span> ) &#123;</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(utf8Bytes[pos]);</span><br><span class="line">                pos += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xFC</span>) === <span class="number">0xFC</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x3</span>) &lt;&lt; <span class="number">30</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">24</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">18</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">3</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">12</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">4</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">5</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xF8</span>) === <span class="number">0xF8</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x7</span>) &lt;&lt; <span class="number">24</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">18</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">12</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">3</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">4</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xF0</span>) === <span class="number">0xF0</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0xF</span>) &lt;&lt; <span class="number">18</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">12</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">3</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xE0</span>) === <span class="number">0xE0</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x1F</span>) &lt;&lt; <span class="number">12</span>;;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xC0</span>) === <span class="number">0xC0</span> )&#123; <span class="comment">//110</span></span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(utf8Bytes[pos]);</span><br><span class="line">                pos += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> unicodeStr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试demo <a href="https://github.com/TabbyCute/web_libs/tree/main/demos/crypto-js-bigfile">https://github.com/TabbyCute/web_libs/tree/main/demos/crypto-js-bigfile</a></p><p>项目使用 <a href="https://github.com/TabbyCute/web_libs/tree/main/libs/crypto-js-bigfile">https://github.com/TabbyCute/web_libs/tree/main/libs/crypto-js-bigfile</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;文本加密很好实现，但是文件加密就稍微麻烦点。&lt;/p&gt;
&lt;p&gt;但是我的预期加密的规则需要兼容老版本能够分辨出老版本未加密的文件，因为我们用户还可能查看老版本的聊天记录。能够分别不同版本规则的加密文件。文件不能全加密，效率要高。加密过后的文件大小，不能太大，要节约oss资源控制成本，这里我改成了一个参，可以手动设置加密后的文件新增的大小。视情况而定。&lt;/p&gt;
&lt;p&gt;最终的加密路线如下：&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="cryptojs" scheme="https://tabbycute.github.io/tags/cryptojs/"/>
    
    <category term="im" scheme="https://tabbycute.github.io/tags/im/"/>
    
  </entry>
  
  <entry>
    <title>查看yum软件的安装目录</title>
    <link href="https://tabbycute.github.io/2022/05/01/20220601%E6%9F%A5%E7%9C%8Byum%E5%AE%89%E8%A3%85%E7%9A%84%E8%BD%AF%E4%BB%B6%E4%BD%8D%E7%BD%AE/"/>
    <id>https://tabbycute.github.io/2022/05/01/20220601%E6%9F%A5%E7%9C%8Byum%E5%AE%89%E8%A3%85%E7%9A%84%E8%BD%AF%E4%BB%B6%E4%BD%8D%E7%BD%AE/</id>
    <published>2022-04-30T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.047Z</updated>
    
    <content type="html"><![CDATA[<p>今天使用yum 安装了一个软件，后来没有找到路径</p><p>1、首先安装一个redis</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># yum install redis</span></span><br></pre></td></tr></table></figure><p>2、查找redis的安装包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># rpm -qa|grep redis</span></span><br><span class="line">redis-3.2.10-2.el7.x86_64</span><br><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure><p>3、查找安装包的安装路径</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># rpm -ql redis-3.2.10-2.el7.x86_64</span></span><br><span class="line">/etc/logrotate.d/redis</span><br><span class="line">/etc/redis-sentinel.conf</span><br><span class="line">/etc/redis.conf</span><br><span class="line">/etc/systemd/system/redis-sentinel.service.d</span><br><span class="line">/etc/systemd/system/redis-sentinel.service.d/limit.conf</span><br><span class="line">/etc/systemd/system/redis.service.d</span><br><span class="line">/etc/systemd/system/redis.service.d/limit.conf</span><br><span class="line">/usr/bin/redis-benchmark</span><br><span class="line">/usr/bin/redis-check-aof</span><br><span class="line">/usr/bin/redis-check-rdb</span><br><span class="line">/usr/bin/redis-cli</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;今天使用yum 安装了一个软件，后来没有找到路径&lt;/p&gt;
&lt;p&gt;1、首先安装一个redis&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@iZbp1eem925ojwyx17ao9kZ ~]&lt;span class=&quot;comment&quot;&gt;# yum install redis&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="linux" scheme="https://tabbycute.github.io/categories/linux/"/>
    
    
    <category term="linux" scheme="https://tabbycute.github.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>IM聊天页面消息时间的展示(Flutter)</title>
    <link href="https://tabbycute.github.io/2022/04/25/20220425IM%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2%E6%B6%88%E6%81%AF%E6%97%B6%E9%97%B4%E7%9A%84%E5%B1%95%E7%A4%BAFlutter/"/>
    <id>https://tabbycute.github.io/2022/04/25/20220425IM%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2%E6%B6%88%E6%81%AF%E6%97%B6%E9%97%B4%E7%9A%84%E5%B1%95%E7%A4%BAFlutter/</id>
    <published>2022-04-24T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.047Z</updated>
    
    <content type="html"><![CDATA[<p>值得一提的是微信会根据手机系统的时间制度（24小时，12小时）展示的不一样的时间</p><blockquote><p>比如同一天 早上的11:30</p><p>24小时制 11:30</p><p>12小时制 上午 11:30</p></blockquote><p>下面时间为毫秒</p><p>数据结构因项目而异，请根据自己的项目适当更改</p><blockquote><p>dependencies: {intl: ^0.17.0}</p></blockquote><p>核心代码如下</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:intl/intl.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">String</span> _formatDate(<span class="built_in">DateTime</span> date, <span class="built_in">String</span> fmt) &#123;</span><br><span class="line">  DateFormat outputFormat = DateFormat(fmt);</span><br><span class="line">  <span class="keyword">return</span> outputFormat.format(date);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">String</span> _getTimeStringAutoShort2(<span class="built_in">int</span> timestamp, <span class="built_in">bool</span> mustIncludeTime) &#123;</span><br><span class="line">  <span class="comment">//当前日期</span></span><br><span class="line">  <span class="built_in">DateTime</span> currentDate = <span class="built_in">DateTime</span>.now();</span><br><span class="line">  <span class="built_in">int</span> currentYear = currentDate.year;</span><br><span class="line">  <span class="built_in">int</span> currentMonth = currentDate.month;</span><br><span class="line">  <span class="built_in">int</span> currentDateD = currentDate.day;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//传入的日期 millTime为毫秒级时间戳</span></span><br><span class="line">  <span class="built_in">DateTime</span> srcDate = <span class="built_in">DateTime</span>.fromMillisecondsSinceEpoch(timestamp);</span><br><span class="line">  <span class="built_in">int</span> srcYear = srcDate.year;</span><br><span class="line">  <span class="built_in">int</span> srcMonth = srcDate.month;</span><br><span class="line">  <span class="built_in">int</span> srcDateD = srcDate.day;</span><br><span class="line"></span><br><span class="line">  <span class="comment">///<span class="language-markdown">结果</span></span></span><br><span class="line">  <span class="built_in">String</span> ret = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> timeExtraStr =</span><br><span class="line">      mustIncludeTime ? <span class="string">&quot; &quot;</span> + _formatDate(srcDate, <span class="string">&quot;HH:mm&quot;</span>) : <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (srcYear == currentYear) &#123;</span><br><span class="line">    <span class="comment">///<span class="language-markdown">当年</span></span></span><br><span class="line">    <span class="built_in">int</span> currentTimestamp = currentDate.millisecondsSinceEpoch;</span><br><span class="line">    <span class="built_in">int</span> srcTimestamp = timestamp;</span><br><span class="line">    <span class="comment">// 相差时间（单位：毫秒）</span></span><br><span class="line">    <span class="built_in">int</span> deltaTime = (currentTimestamp - srcTimestamp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当天（月份和日期一致才是）</span></span><br><span class="line">    <span class="keyword">if</span> (currentMonth == srcMonth &amp;&amp; currentDateD == srcDateD) &#123;</span><br><span class="line">      ret = _formatDate(srcDate, <span class="string">&quot;HH:mm&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 当年 &amp;&amp; 当天之外的时间（即昨天及以前的时间）</span></span><br><span class="line">      <span class="comment">// 昨天（以“现在”的时候为基准-1天）</span></span><br><span class="line">      <span class="built_in">DateTime</span> yesterdayDate =</span><br><span class="line">          <span class="built_in">DateTime</span>.fromMillisecondsSinceEpoch(currentTimestamp - <span class="number">86400000</span> * <span class="number">1</span>);</span><br><span class="line">      <span class="comment">// 前天（以“现在”的时候为基准-2天）</span></span><br><span class="line">      <span class="built_in">DateTime</span> beforeYesterdayDate =</span><br><span class="line">          <span class="built_in">DateTime</span>.fromMillisecondsSinceEpoch(currentTimestamp - <span class="number">86400000</span> * <span class="number">2</span>);</span><br><span class="line">      <span class="comment">// 用目标日期的“月”和“天”跟上方计算出来的“昨天”进行比较，是最为准确的（如果用时间戳差值</span></span><br><span class="line">      <span class="comment">// 的形式，是不准确的，比如：现在时刻是2019年02月22日1:00、而srcDate是2019年02月21日23:00，</span></span><br><span class="line">      <span class="comment">// 这两者间只相差2小时，直接用“deltaTime/(3600 * 1000)” &gt; 24小时来判断是否昨天，就完全是扯蛋的逻辑了）</span></span><br><span class="line">      <span class="keyword">if</span> (srcMonth == (yesterdayDate.month) &amp;&amp; srcDateD == yesterdayDate.day) &#123;</span><br><span class="line">        ret = <span class="string">&quot;昨天&quot;</span> + timeExtraStr; <span class="comment">// -1d</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (srcMonth == (beforeYesterdayDate.month) &amp;&amp;</span><br><span class="line">          srcDateD == beforeYesterdayDate.day) &#123;</span><br><span class="line">        <span class="comment">// “前天”判断逻辑同上</span></span><br><span class="line">        ret = <span class="string">&quot;前天&quot;</span> + timeExtraStr; <span class="comment">// -2d</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 跟当前时间相差的小时数</span></span><br><span class="line">        <span class="keyword">var</span> deltaHour = (deltaTime / (<span class="number">3600</span> * <span class="number">1000</span>));</span><br><span class="line">        <span class="comment">// 如果小于或等 7*24小时就显示星期几</span></span><br><span class="line">        <span class="keyword">if</span> (deltaHour &lt;= <span class="number">7</span> * <span class="number">24</span>) &#123;</span><br><span class="line">          <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; weekday = [];</span><br><span class="line">          weekday.addAll([<span class="string">&quot;星期一&quot;</span>, <span class="string">&quot;星期二&quot;</span>, <span class="string">&quot;星期三&quot;</span>, <span class="string">&quot;星期四&quot;</span>, <span class="string">&quot;星期五&quot;</span>, <span class="string">&quot;星期六&quot;</span>, <span class="string">&quot;星期日&quot;</span>]);</span><br><span class="line">          <span class="comment">// 取出当前是星期几</span></span><br><span class="line">          <span class="keyword">var</span> weedayDesc = weekday[srcDate.weekday - <span class="number">1</span>];</span><br><span class="line">          ret = weedayDesc + timeExtraStr;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 否则直接显示完整日期时间</span></span><br><span class="line">          ret = _formatDate(srcDate, <span class="string">&quot;yyyy年M月d日&quot;</span>) + timeExtraStr;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">///<span class="language-markdown">往年</span></span></span><br><span class="line">    ret = _formatDate(srcDate, <span class="string">&quot;yyyy年M月d日&quot;</span>) + timeExtraStr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">聊天页面时间展示的最小差</span></span></span><br><span class="line"><span class="built_in">bool</span> check2TimeGap(<span class="built_in">int</span> t1, <span class="built_in">int</span> t2) &#123;</span><br><span class="line">  <span class="keyword">if</span> ((t1 - t2).abs() &gt; <span class="number">1000</span> * <span class="number">60</span> * <span class="number">5</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> 向新收到的消息列表时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> [msg] 新收到的消息</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> [curStartTime] 最近一条消息的时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line"><span class="built_in">List</span> msgListTimeHook(<span class="built_in">List</span> msgList) &#123;</span><br><span class="line">  <span class="built_in">List</span> result = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; msgList.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> item = msgList[i];</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">      item[<span class="string">&quot;viewTime&quot;</span>] = _getTimeStringAutoShort2(item[<span class="string">&quot;time&quot;</span>], <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (check2TimeGap(item[<span class="string">&quot;time&quot;</span>], msgList[i - <span class="number">1</span>][<span class="string">&quot;time&quot;</span>])) &#123;</span><br><span class="line">      item[<span class="string">&quot;viewTime&quot;</span>] = _getTimeStringAutoShort2(item[<span class="string">&quot;time&quot;</span>], <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    result.add(item);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> 向新收到的消息列表时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> </span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> * @msg 新收到的消息</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> @curStartTime 最近一条消息的时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> </span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line">msgAloneTimeHook(msg, curStartTime) &#123;</span><br><span class="line">  <span class="comment">// if(!curStartTime)&#123;</span></span><br><span class="line">  <span class="comment">//     msg.viewTime=_getTimeStringAutoShort2(item.time, true)</span></span><br><span class="line">  <span class="comment">// &#125;else&#123;</span></span><br><span class="line">  <span class="comment">//     if (check2TimeGap(msg.time,curStartTime)) &#123;</span></span><br><span class="line">  <span class="comment">//         msg.viewTime=_getTimeStringAutoShort2(item.time, true)</span></span><br><span class="line">  <span class="comment">//     &#125;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="comment">// return msg</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基本使用如下</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">  <span class="keyword">var</span> mes = [</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息12&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1630113816000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息11&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1661649816000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息11&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664090674000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息周一&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664177074000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息前天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664263474000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息1&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664381016000</span>&#125;,</span><br><span class="line">  ];</span><br><span class="line">  <span class="comment">// _getTimeStringAutoShort2(1664380797000, true);</span></span><br><span class="line">  <span class="keyword">var</span> a = msgListTimeHook(mes);</span><br><span class="line">  <span class="built_in">print</span>(a);</span><br><span class="line">  <span class="comment">// 用于聊天内容界面时</span></span><br><span class="line">  <span class="keyword">var</span> b = _getTimeStringAutoShort2(<span class="number">1550789954260</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">///<span class="language-markdown">用于会话列表“消息”界面时</span></span></span><br><span class="line">  <span class="keyword">var</span> c = _getTimeStringAutoShort2(<span class="number">1550789954260</span>, <span class="keyword">false</span>);</span><br><span class="line">  <span class="built_in">print</span>(a);</span><br><span class="line">  <span class="built_in">print</span>(b);</span><br><span class="line">  <span class="built_in">print</span>(c);</span><br><span class="line">  <span class="comment">// mes.forEach((i) &#123;</span></span><br><span class="line">  <span class="comment">//   _getTimeStringAutoShort2(i[&quot;time&quot;] as int, true);</span></span><br><span class="line">  <span class="comment">// &#125;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大概结果如下下面返回的结果并非使用上面的数据</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息12&#x27;</span>, <span class="attr">time</span>: <span class="number">1630113816000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;2021年8月28日 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息11&#x27;</span>, <span class="attr">time</span>: <span class="number">1661649816000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;2022年8月28日 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息10.5&#x27;</span>, <span class="attr">time</span>: <span class="number">1664159074000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;星期一 10:24&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息10&#x27;</span>, <span class="attr">time</span>: <span class="number">1664328216000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息9&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息8&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息7&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息6&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息5&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378676000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息4&#x27;</span>, <span class="attr">time</span>: <span class="number">1664379876000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:44&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息3&#x27;</span>, <span class="attr">time</span>: <span class="number">1664379936000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息2&#x27;</span>, <span class="attr">time</span>: <span class="number">1664380797000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:59&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息1&#x27;</span>, <span class="attr">time</span>: <span class="number">1664381016000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-1&#x27;</span>, <span class="attr">time</span>: <span class="number">1664440902124</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;16:41&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-2&#x27;</span>, <span class="attr">time</span>: <span class="number">1664440962124</span> &#125;</span><br><span class="line">]</span><br><span class="line">&#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-3&#x27;</span>, <span class="attr">time</span>: <span class="number">1664441027131</span> &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;值得一提的是微信会根据手机系统的时间制度（24小时，12小时）展示的不一样的时间&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;比如同一天 早上的11:30&lt;/p&gt;
&lt;p&gt;24小时制 11:30&lt;/p&gt;
&lt;p&gt;12小时制 上午 11:30&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;下面时间为毫秒&lt;/p&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="im" scheme="https://tabbycute.github.io/tags/im/"/>
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
</feed>
