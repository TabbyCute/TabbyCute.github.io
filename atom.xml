<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>TabbyBlog</title>
  
  <subtitle>TabbyBlog的个人主页和一些技术博客的分享。</subtitle>
  <link href="https://tabbycute.github.io/atom.xml" rel="self"/>
  
  <link href="https://tabbycute.github.io/"/>
  <updated>2022-11-07T14:29:47.049Z</updated>
  <id>https://tabbycute.github.io/</id>
  
  <author>
    <name>TabbyBlog</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>前端换肤解决方案及其思路</title>
    <link href="https://tabbycute.github.io/2022/10/25/20221025%E5%89%8D%E7%AB%AF%E6%8D%A2%E8%82%A4%E6%80%9D%E8%B7%AF/"/>
    <id>https://tabbycute.github.io/2022/10/25/20221025%E5%89%8D%E7%AB%AF%E6%8D%A2%E8%82%A4%E6%80%9D%E8%B7%AF/</id>
    <published>2022-10-24T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.049Z</updated>
    
    <content type="html"><![CDATA[<h3 id="CSS变量实现"><a href="#CSS变量实现" class="headerlink" title="CSS变量实现"></a>CSS变量实现</h3><p>没什么好说的简单</p><blockquote><p>使用stylus注意</p><p>–fill-1:#222;（正常）</p><p>–fill-1: #222;（可能报错）</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">change</span>=(<span class="params">theme</span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> html=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;body&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">html.<span class="title function_">setAttribute</span>(<span class="string">&quot;data-theme&quot;</span>,theme)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;change(&#x27;light&#x27;)&quot;</span>&gt;</span>主题颜色亮色<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;change(&#x27;dark&#x27;)&quot;</span>&gt;</span>主题颜色暗色<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;bg&quot;</span>&gt;</span>测试文字啊阿达瓦大大<span class="tag">&lt;<span class="name">i</span>&gt;</span>家中的<span class="tag">&lt;/<span class="name">i</span>&gt;</span>王阿达瓦<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">&quot;stylus&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    //默认</span></span><br><span class="line"><span class="language-css"><span class="selector-pseudo">:root</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--fill-1</span>:<span class="number">#ffffff</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--text</span>:<span class="number">#3c3c3c</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--text-1</span>:<span class="number">#757575</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--text-2</span>:<span class="number">#222</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-large</span>:<span class="number">18px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-large-x</span>:<span class="number">22px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-medium</span>:<span class="number">14px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-medium-x</span>:<span class="number">16px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-small-s</span>:<span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-small</span>:<span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-attr">[data-theme=<span class="string">&quot;dark&quot;</span>]</span> &#123;</span></span><br><span class="line"><span class="language-css"><span class="attr">--fill-1</span>:<span class="number">#222</span>;</span></span><br><span class="line"><span class="language-css"><span class="attr">--text</span>:<span class="number">#fff</span>;</span></span><br><span class="line"><span class="language-css"><span class="attr">--text-1</span>:<span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.3</span>);</span></span><br><span class="line"><span class="language-css"><span class="attr">--text-2</span>:<span class="number">#ffcd32</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.bg</span></span></span><br><span class="line"><span class="language-css"><span class="attribute">transition-duration</span>: <span class="number">0.5s</span></span></span><br><span class="line"><span class="language-css">height: <span class="number">100px</span></span></span><br><span class="line"><span class="language-css">background <span class="built_in">var</span>(--fill-<span class="number">1</span>);</span></span><br><span class="line"><span class="language-css"><span class="attribute">color</span>: <span class="built_in">var</span>(--text-<span class="number">2</span>);</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="js动态"><a href="#js动态" class="headerlink" title="js动态"></a>js动态</h3><p>使用覆盖样式实现与scss变量实现会把多套皮肤的样式都编译到一个css文件里面，如果有多套皮肤样式，这个文件是会非常大的。</p><p>为了解决这样的问题，就自然的想出了拆分scss的实现，，通过编译工具与构建工具编译出多套皮肤css。或者使用网络地址。</p><p>通过js动态的link对应的皮肤样式</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> theme = <span class="regexp">/\bt=(\w+)/</span>.<span class="title function_">exec</span>(location.<span class="property">search</span>);</span><br><span class="line">theme = theme ? theme[<span class="number">1</span>] : <span class="string">&quot;light&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">changeTheme</span>(theme);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">changeTheme</span>(<span class="params">theme</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> head = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;head&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;link&quot;</span>);</span><br><span class="line">    link.<span class="property">dataset</span>.<span class="property">type</span> = <span class="string">&quot;theme&quot;</span>;</span><br><span class="line">    link.<span class="property">href</span> = <span class="string">&quot;assets/css/theme-&quot;</span> + theme + <span class="string">&quot;/pages/home/home.css&quot;</span>;</span><br><span class="line">    link.<span class="property">rel</span> = <span class="string">&quot;stylesheet&quot;</span>;</span><br><span class="line">    link.<span class="property">type</span> = <span class="string">&quot;text/css&quot;</span>;</span><br><span class="line">    head.<span class="title function_">appendChild</span>(link);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ElementUI换肤"><a href="#ElementUI换肤" class="headerlink" title="ElementUI换肤"></a>ElementUI换肤</h3><p>ElementUI的实现原理，通过预设的配置，颜色计算出颜色和生成正则，获取所有的style标签，拿到标签中的字符串，在去用正则替换字符串中的颜色，在设置回去。</p><p>为了考虑重复设置可以给style标签添加个标记</p><p>这个实现方式正如他官方所说相当暴力莫得感情！！！同时自己写的颜色也会被替换掉</p><blockquote><p><a href="https://github.com/ianstormtaylor/css-color-function">颜色计算</a></p><p><a href="https://www.runoob.com/js/js-obj-regexp.html">前端正则</a></p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">Color</span> <span class="keyword">from</span> <span class="string">&quot;css-color-function&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> current=<span class="string">&quot;default&quot;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> formulaes = [</span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&quot;0&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">exp</span>: <span class="string">&quot;color(primary)&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&quot;aaa&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">exp</span>: <span class="string">&quot;color(textColor)&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&quot;bbb&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">exp</span>: <span class="string">&quot;color(btn)&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">];</span></span><br><span class="line"><span class="language-javascript"><span class="comment">///多个主题</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> themes=&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">default</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;primary&quot;</span>:<span class="string">&quot;#DC143C&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;textColor&quot;</span>:<span class="string">&quot;#BBFFAA&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;btn&quot;</span>:<span class="string">&quot;#2F4F4F&quot;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t1</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;primary&quot;</span>:<span class="string">&quot;#FFD700&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;textColor&quot;</span>:<span class="string">&quot;#000000&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;btn&quot;</span>:<span class="string">&quot;#000080&quot;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t2</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;primary&quot;</span>:<span class="string">&quot;#2F4F4F&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;textColor&quot;</span>:<span class="string">&quot;#FFFFFF&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;btn&quot;</span>:<span class="string">&quot;#adff2f&quot;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">computedColors</span> = (<span class="params">colors</span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">return</span> formulaes.<span class="title function_">map</span>(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> value = f.<span class="property">exp</span></span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">replace</span>(<span class="regexp">/primary/g</span>, colors.<span class="property">primary</span>)</span></span><br><span class="line"><span class="language-javascript">    .<span class="property">replace</span> (<span class="regexp">/textColor/g</span>,colors.<span class="property">textColor</span>)</span></span><br><span class="line"><span class="language-javascript">    .<span class="property">replace</span> (<span class="regexp">/btn/g</span>,colors.<span class="property">btn</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> <span class="title class_">Color</span>.<span class="title function_">convert</span>(value);</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">PageInit</span>=(<span class="params"></span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(themes).<span class="title function_">forEach</span>(<span class="function"><span class="params">k</span>=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> initColorCluster=[...<span class="title class_">Object</span>.<span class="title function_">values</span>(themes[k]),...<span class="title function_">computedColors</span>(themes[k])]</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> initStyleReg=initColorCluster.<span class="title function_">join</span>(<span class="string">&quot;|&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">      .<span class="title function_">replace</span>(<span class="regexp">/\(/g</span>, <span class="string">&quot;\\(&quot;</span>) <span class="comment">// 括号的转义</span></span></span><br><span class="line"><span class="language-javascript">      .<span class="title function_">replace</span>(<span class="regexp">/\)/g</span>, <span class="string">&quot;\\)&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">      .<span class="title function_">replace</span>(<span class="regexp">/0\./g</span>, <span class="string">&quot;.&quot;</span>); <span class="comment">// 这里替换是因为默认的css中计算出来的值透明度会缺省0，</span></span></span><br><span class="line"><span class="language-javascript">    themes[k].<span class="property">_initColorCluster</span>=initColorCluster</span></span><br><span class="line"><span class="language-javascript">    themes[k].<span class="property">_initStyleReg</span>=initStyleReg</span></span><br><span class="line"><span class="language-javascript">  &#125;)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="title class_">PageInit</span>()</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">changeTheme</span> = (<span class="params">t</span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> cT=themes[current],</span></span><br><span class="line"><span class="language-javascript">        tT=themes[t];</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> styles = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;style&quot;</span>)).<span class="title function_">filter</span>(<span class="function">(<span class="params">style</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 找到需要进行替换的style标签</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> text = style.<span class="property">innerText</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">`<span class="subst">$&#123;cT._initStyleReg&#125;</span>`</span>, <span class="string">&quot;i&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span> re.<span class="title function_">test</span>(text);</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///生成正则</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">`<span class="subst">$&#123;cT._initStyleReg&#125;</span>`</span>, <span class="string">&quot;ig&quot;</span>); <span class="comment">// 老的颜色簇正则，全局替换，且不区分大小写</span></span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">    styles.<span class="title function_">forEach</span>(<span class="function">(<span class="params">style</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> &#123; innerText &#125; = style;</span></span><br><span class="line"><span class="language-javascript">      style.<span class="property">innerHTML</span> = innerText.<span class="title function_">replace</span>(re, <span class="function">(<span class="params">match</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">///通过小写检查  rgba(0,0,0,.5) 替换成0.5 兼容好</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> index = cT.<span class="property">_initColorCluster</span>.<span class="title function_">indexOf</span>(match.<span class="title function_">toLowerCase</span>().<span class="title function_">replace</span>(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;0.&quot;</span>));</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">///通过大写写检查</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (index === -<span class="number">1</span>)index = cT.<span class="property">_initColorCluster</span>.<span class="title function_">indexOf</span>(match.<span class="title function_">toUpperCase</span>().<span class="title function_">replace</span>(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;0.&quot;</span>));</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 进行替换</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> tT.<span class="property">_initColorCluster</span>[index].<span class="title function_">toLowerCase</span>().<span class="title function_">replace</span>(<span class="regexp">/0\./g</span>, <span class="string">&quot;.&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      &#125;);</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// console.log(style.innerHTML)</span></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// style.setAttribute(&quot;class&quot;, &quot;so-ui-react-theme&quot;);</span></span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">    current=t;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;当前主题：%s&quot;</span>,current)</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">change</span>=(<span class="params"></span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">if</span>(current===<span class="string">&quot;default&quot;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">changeTheme</span>(<span class="string">&quot;t1&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(current===<span class="string">&quot;t1&quot;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">changeTheme</span>(<span class="string">&quot;t2&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">changeTheme</span>(<span class="string">&quot;default&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// componentDidMount();</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;a b&quot;</span>&gt;</span>testaaaaaai<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;b c&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;change&quot;</span>&gt;</span>更换颜色<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.a</span>&#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>: <span class="number">#DC143C</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.b</span>&#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">color</span>: <span class="number">#BBFFAA</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.c</span>&#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>:<span class="number">#2F4F4F</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="less实现换肤"><a href="#less实现换肤" class="headerlink" title="less实现换肤"></a>less实现换肤</h3><p>感觉less实现的很优雅</p><p>设置默认样式，原来它会找到所有如下的less样式标签，并且使用已编译的css同步创建 style 标签。</p><p>相当于在原来的基础上生成一个一模一样的style样式表添加到页面中。也就是说他需要一个模板。如果放在src里面他会被编译成css，无法成为模板。</p><p>我们这里把这个模板放到项目主目录的public中去。。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/public/test<span class="selector-class">.less</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@primary-color</span>: red;</span><br><span class="line"><span class="keyword">@bg-color</span>: blue;</span><br><span class="line"><span class="selector-class">.test-block</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">20px</span> auto;</span><br><span class="line">  <span class="attribute">color</span>: @primary-color;</span><br><span class="line">  <span class="attribute">background</span>: @bg-color;</span><br><span class="line">  <span class="selector-class">.block2</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: aquamarine;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>修改项目模板文件index.html，添加lessjs，也可以搞成本地的的，我这里为了方便直接添加cdn的</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">type</span>=<span class="string">&quot;image/svg+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/vite.svg&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vite + Vue<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet/less&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/test.less&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">less</span> = &#123;<span class="attr">async</span>:<span class="literal">true</span>,&#125;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/less.js/2.7.3/less.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/src/main.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>页面简单使用</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> themes=&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t1</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@primary-color&quot;</span>: <span class="string">&quot;#8b0000&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@bg-color&quot;</span>: <span class="string">&quot;#2f4f4f&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t2</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@primary-color&quot;</span>: <span class="string">&quot;#ffa500&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@bg-color&quot;</span>: <span class="string">&quot;#c0c0c0&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t3</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@primary-color&quot;</span>:<span class="string">&quot;#000080&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@bg-color&quot;</span>: <span class="string">&quot;#000000&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">onchange</span>=(<span class="params">t</span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">console</span>.<span class="title function_">log</span>(themes[t])</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">window</span>.<span class="property">less</span>.<span class="title function_">modifyVars</span>(themes[t]).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;修改成功&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;onchange(&#x27;t1&#x27;)&quot;</span>&gt;</span>改变哦<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;onchange(&#x27;t2&#x27;)&quot;</span>&gt;</span>改变哦<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;onchange(&#x27;t3&#x27;)&quot;</span>&gt;</span>改变哦<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;test-block&quot;</span>&gt;</span>testaaaaaai<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="其他思路"><a href="#其他思路" class="headerlink" title="其他思路"></a>其他思路</h3><p>vuex，自定义指令等等实现起来应该也很不错。理论上他们也能获得较高的自定义程度，颜色，背景图等等等。</p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;CSS变量实现&quot;&gt;&lt;a href=&quot;#CSS变量实现&quot; class=&quot;headerlink&quot; title=&quot;CSS变量实现&quot;&gt;&lt;/a&gt;CSS变量实现&lt;/h3&gt;&lt;p&gt;没什么好说的简单&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;使用stylus注意&lt;/p&gt;
&lt;p&gt;–fill-1:#222;（正常）&lt;/p&gt;
&lt;p&gt;–fill-1: #222;（可能报错）&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="vue" scheme="https://tabbycute.github.io/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>flutter极光推送集成华为(鸿蒙)厂商通道</title>
    <link href="https://tabbycute.github.io/2022/10/05/20221005flutter%E9%9B%86%E6%88%90%E5%8D%8E%E4%B8%BA%E6%8E%A8%E9%80%81/"/>
    <id>https://tabbycute.github.io/2022/10/05/20221005flutter%E9%9B%86%E6%88%90%E5%8D%8E%E4%B8%BA%E6%8E%A8%E9%80%81/</id>
    <published>2022-10-04T16:00:00.000Z</published>
    <updated>2022-12-07T14:17:58.960Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>flutter插件<a href="https://pub.flutter-io.cn/packages/jpush_flutter">jpush_flutter: 2.2.5</a>,<a href="https://github.com/jpush/jpush-flutter-plugin">github</a></p><p>华为推送证书<a href="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html#/myProject/99536292102686645/97458334310914890?appId=107234249">agconnect-services.json导出地址</a></p><p>极光<a href="https://www.jiguang.cn/portal/#/dev/newOverview">开发者平台</a></p><p>客户端sdk集成<a href="https://docs.jiguang.cn/jpush/client/Android/android_sdk">官方文档</a></p><p>客户端华为厂商通道集成<a href="https://docs.jiguang.cn/jpush/client/Android/android_3rd_guide#%E9%85%8D%E7%BD%AE-mavencentral-%E6%94%AF%E6%8C%81-1">官方文档</a></p><p>极光推送<a href="https://www.jiguang.cn/portal/#/push/app/bffe9289b1b2f16861869be9/config_manage/check/message">排查工具</a></p><p>com.huawei.hms:push:X.X.X.XXX<a href="https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/service-introduction-0000001050040060">推送服务（Push Kit）</a>是华为提供的消息推送平台，建立了从云端到终端的消息推送通道。您通过集成推送服务，可以向客户端应用实时推送消息，构筑良好的用户关系，提升用户的感知度和活跃度。</p><p>com.huawei.hms:push:X.X.X.XXX推送服务<a href="https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/android-app-version-0000001074227861#section527519181712">版本及其历史版本</a></p><p>com.huawei.agconnect:agcp:X.X.X.XXX<a href="https://developer.huawei.com/consumer/cn/doc/development/AppGallery-connect-Guides/agc-apm-android-releasenotes-0000001052887266">华为分析服务（Analytics Kit）</a>是针对移动应用、Web、快应用、快游戏、小程序等产品的一站式用户行为分析平台，贴合业务场景，提供数据采集、数据管理、数据分析、数据应用的一体化解决方案，驱动企业实现精准拉新、产品优化、精益运营、业务增长。</p><p><a href="https://docs.jiguang.cn/jpush/client/Android/android_sdk">极光推送官方</a>客户端集成，包括荣耀，OPPO，等等需要引入aar包，<strong>极光文档可能会更新，需要留意观看，</strong>看着他文档来就OK</p></blockquote><h3 id="极光推送基础集成"><a href="#极光推送基础集成" class="headerlink" title="极光推送基础集成"></a>极光推送基础集成</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">class MyHomePage extends StatefulWidget &#123;</span><br><span class="line">  const MyHomePage(&#123;super.key, required this.title&#125;);</span><br><span class="line">  final String title;</span><br><span class="line">  @override</span><br><span class="line">  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();</span><br><span class="line">&#125;</span><br><span class="line">class _MyHomePageState extends State&lt;MyHomePage&gt; &#123;</span><br><span class="line">  JPush jpush = new JPush();</span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              try &#123;</span><br><span class="line">                //Map&lt;String, dynamic&gt; message</span><br><span class="line">                jpush.addEventHandler(onReceiveNotification: (message) async &#123;</span><br><span class="line">                  print(&quot;jpush flutter onReceiveNotification: $&#123;json.encode(message)&#125;&quot;);</span><br><span class="line">                &#125;, onOpenNotification: (message) async &#123;</span><br><span class="line">                &#125;, onReceiveMessage: (message) async &#123;</span><br><span class="line">                  print(&quot;jpush flutter onReceiveMessage: $&#123;json.encode(message)&#125;&quot;);</span><br><span class="line">                &#125;, onReceiveNotificationAuthorization: (message) async &#123;</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125; on PlatformException &#123;</span><br><span class="line">                print(&quot;jpush Failed to get platform version.&quot;);</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              jpush.setup(</span><br><span class="line">                appKey: &quot;bffe9289**********61869be9&quot;,</span><br><span class="line">                channel: &quot;developer-default&quot;,</span><br><span class="line">                production: false,</span><br><span class="line">                debug: false, // 设置是否打印 debug 日志</span><br><span class="line">              );</span><br><span class="line"></span><br><span class="line">              jpush.applyPushAuthority(NotificationSettingsIOS(</span><br><span class="line">                sound: true,</span><br><span class="line">                alert: true,</span><br><span class="line">                badge: true,</span><br><span class="line">              ));</span><br><span class="line"></span><br><span class="line">              jpush.getRegistrationID().then((rid) &#123;</span><br><span class="line">                print(&quot;jpush flutter get registration id : $rid&quot;);</span><br><span class="line">              &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;, child: Text(&quot;setup&quot;)),</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              jpush.applyPushAuthority();</span><br><span class="line">            &#125;, child: Text(&quot;apply&quot;)),</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              jpush.isNotificationEnabled().then((bool value) &#123;</span><br><span class="line">                print(&quot;jpush 通知授权是否打开: $value&quot;);</span><br><span class="line">              &#125;).catchError((onError) &#123;</span><br><span class="line">                print(&quot;jpush 通知授权是否打开: $&#123;onError.toString()&#125;&quot;);</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;, child: Text(&quot;通知&quot;)),</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              jpush.setAlias(&quot;1000*****&quot;).then((map) &#123; </span><br><span class="line">                print(&quot;==setAlias==$&#123;map&#125;==&quot;);</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;, child: Text(&quot;setAlias&quot;))</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="厂商通道集成"><a href="#厂商通道集成" class="headerlink" title="厂商通道集成"></a>厂商通道集成</h3><blockquote><p>gradle:6.7</p><p>distributionUrl=https://services.gradle.org/distributions/gradle-6.7-all.zip</p><p>android/build.gradle———-classpath com.android.tools.build:gradle:4.1.3</p><p>jpush_flutter: 2.2.5 Jcore版本:3.2.2  Jpush版本: 4.6.4   (可以在flutter的插件地址Changelog中查看)</p></blockquote><h4 id="android-build-gradle加上如下代码"><a href="#android-build-gradle加上如下代码" class="headerlink" title="android/build.gradle加上如下代码"></a>android/build.gradle加上如下代码</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    ext.kotlin_version = <span class="string">&#x27;1.6.10&#x27;</span></span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line"><span class="comment">// 加上如下代码</span></span><br><span class="line">        maven &#123;url <span class="string">&#x27;https://developer.huawei.com/repo/&#x27;</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;com.android.tools.build:gradle:4.1.3&#x27;</span></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加上如下代码</span></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;com.huawei.agconnect:agcp:1.4.2.300&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line"><span class="comment">// 加上如下代码</span></span><br><span class="line">        maven &#123; url <span class="string">&#x27;https://developer.huawei.com/repo/&#x27;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="agconnect-services-json放入到-android-app-中"><a href="#agconnect-services-json放入到-android-app-中" class="headerlink" title="agconnect-services.json放入到**android/app/**中"></a>agconnect-services.json放入到**android/app/**中</h4><h4 id="进入到android-app-build-gradle"><a href="#进入到android-app-build-gradle" class="headerlink" title="进入到android/app/build.gradle"></a>进入到<strong>android/app/build.gradle</strong></h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line">apply plugin: <span class="string">&#x27;kotlin-android&#x27;</span></span><br><span class="line">apply <span class="keyword">from</span>: <span class="string">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br><span class="line"><span class="comment">// 加上如下代码（位置随意）</span></span><br><span class="line">apply plugin: <span class="string">&#x27;com.huawei.agconnect&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="引入厂商sdk"><a href="#引入厂商sdk" class="headerlink" title="引入厂商sdk"></a>引入厂商sdk</h4><p>极光厂商插件版本与接入 JPush 版本保持一致，下同，jpush版本可以在极光推送<a href="https://www.jiguang.cn/portal/#/push/app/bffe9289b1b2f16861869be9/config_manage/check/message">排查工具</a>中查看</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="comment">// 接入华为厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;com.huawei.hms:push:5.3.0.301&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:huawei:4.4.5&#x27;</span><span class="comment">// 极光厂商插件版本与接入 JPush 版本保持一致，下同</span></span><br><span class="line">    <span class="comment">// 接入小米厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:xiaomi:4.4.5&#x27;</span></span><br><span class="line">    <span class="comment">// 接入 FCM 厂商</span></span><br><span class="line"><span class="comment">// implementation &#x27;com.google.firebase:firebase-messaging:21.0.1&#x27;</span></span><br><span class="line"><span class="comment">// implementation &#x27;cn.jiguang.sdk.plugin:fcm:4.0.0&#x27;</span></span><br><span class="line">    <span class="comment">// 接入魅族厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:meizu:4.4.5&#x27;</span></span><br><span class="line">    <span class="comment">// 接入 VIVO 厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:vivo:4.4.5&#x27;</span></span><br><span class="line">    <span class="comment">// 接入 OPPO 厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:oppo:4.4.5&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修改AndroidManifest-xml"><a href="#修改AndroidManifest-xml" class="headerlink" title="修改AndroidManifest.xml"></a>修改AndroidManifest.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> </span></span><br><span class="line"><span class="tag">···</span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    ···&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">       ···</span></span><br><span class="line"><span class="tag">       <span class="attr">tools:replace</span>=<span class="string">&quot;android:label&quot;</span></span></span><br></pre></td></tr></table></figure><h3 id="版本升级"><a href="#版本升级" class="headerlink" title="版本升级"></a>版本升级</h3><p><strong>‘com.huawei.agconnect:agcp:1.5.2.300’</strong> 这个版本是IDE自动提示我的如果版本不对他运行可能会报错!!!!,开头给力地址可以查找自己对应的版本</p><p><strong>‘com.huawei.hms:push:5.3.0.301’</strong> 开头给力地址可以查找自己对应的版本</p><blockquote><p>gradle:7.4</p><p>distributionUrl=https://services.gradle.org/distributions/gradle-7.4-all.zip</p><p>android/build.gradle———-classpath ‘com.android.tools.build:gradle:7.1.2’</p><p>jpush_flutter: 2.4.0 Jpush版本: 4.8.4 (可以在flutter的插件地址Changelog中查看)</p><p>aar的包位于android/app/libs/***.aar</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">...</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath &#x27;com.android.tools.build:gradle:7.1.2&#x27;</span><br><span class="line">        classpath &quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span><br><span class="line"></span><br><span class="line">// 加上如下代码  </span><br><span class="line">        classpath &#x27;com.huawei.agconnect:agcp:1.5.2.300&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    // 接入华为厂商</span><br><span class="line">    implementation &#x27;com.huawei.hms:push:5.3.0.301&#x27;</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:huawei:4.8.4&#x27;// 极光厂商插件版本与接入 JPush 版本保持一致，下同</span><br><span class="line">    // 接入小米厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:xiaomi:4.8.4&#x27;</span><br><span class="line">    // 接入魅族厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:meizu:4.8.4&#x27;</span><br><span class="line">    // 接入 VIVO 厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:vivo:4.8.4&#x27;</span><br><span class="line">    // 接入 OPPO 厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:oppo:4.8.4&#x27;</span><br><span class="line">    implementation(name: &#x27;com.heytap.msp-push-3.1.0&#x27;, ext: &#x27;aar&#x27;)</span><br><span class="line">    //以下为 OPPO 3.1.0 aar需要依赖</span><br><span class="line">    implementation &#x27;com.google.code.gson:gson:2.6.2&#x27;</span><br><span class="line">    implementation &#x27;commons-codec:commons-codec:1.6&#x27;</span><br><span class="line">    implementation &#x27;androidx.annotation:annotation:1.1.0&#x27;</span><br><span class="line">    //荣耀</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:honor:4.8.4&#x27;</span><br><span class="line">    implementation(name: &#x27;HonorPushSDK-7.0.1.103&#x27;, ext: &#x27;aar&#x27;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;flutter插件&lt;a href=&quot;https://pub.flutter-io.cn/packages/jpush_flutter&quot;&gt;jpush_flutter: 2.2.5&lt;/a&gt;,&lt;a href=&quot;https://github.com/jpush/jpush-flutter-plugin&quot;&gt;github&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;华为推送证书&lt;a href=&quot;https://developer.huawei.com/consumer/cn/service/josp/agc/index.html#/myProject/99536292102686645/97458334310914890?appId=107234249&quot;&gt;agconnect-services.json导出地址&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;极光&lt;a href=&quot;https://www.jiguang.cn/portal/#/dev/newOverview&quot;&gt;开发者平台&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;客户端sdk集成&lt;a href=&quot;https://docs.jiguang.cn/jpush/client/Android/android_sdk&quot;&gt;官方文档&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;客户端华为厂商通道集成&lt;a href=&quot;https://docs.jiguang.cn/jpush/client/Android/android_3rd_guide#%E9%85%8D%E7%BD%AE-mavencentral-%E6%94%AF%E6%8C%81-1&quot;&gt;官方文档&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;极光推送&lt;a href=&quot;https://www.jiguang.cn/portal/#/push/app/bffe9289b1b2f16861869be9/config_manage/check/message&quot;&gt;排查工具&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;com.huawei.hms:push:X.X.X.XXX&lt;a href=&quot;https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/service-introduction-0000001050040060&quot;&gt;推送服务（Push Kit）&lt;/a&gt;是华为提供的消息推送平台，建立了从云端到终端的消息推送通道。您通过集成推送服务，可以向客户端应用实时推送消息，构筑良好的用户关系，提升用户的感知度和活跃度。&lt;/p&gt;
&lt;p&gt;com.huawei.hms:push:X.X.X.XXX推送服务&lt;a href=&quot;https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/android-app-version-0000001074227861#section527519181712&quot;&gt;版本及其历史版本&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;com.huawei.agconnect:agcp:X.X.X.XXX&lt;a href=&quot;https://developer.huawei.com/consumer/cn/doc/development/AppGallery-connect-Guides/agc-apm-android-releasenotes-0000001052887266&quot;&gt;华为分析服务（Analytics Kit）&lt;/a&gt;是针对移动应用、Web、快应用、快游戏、小程序等产品的一站式用户行为分析平台，贴合业务场景，提供数据采集、数据管理、数据分析、数据应用的一体化解决方案，驱动企业实现精准拉新、产品优化、精益运营、业务增长。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.jiguang.cn/jpush/client/Android/android_sdk&quot;&gt;极光推送官方&lt;/a&gt;客户端集成，包括荣耀，OPPO，等等需要引入aar包，&lt;strong&gt;极光文档可能会更新，需要留意观看，&lt;/strong&gt;看着他文档来就OK&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;极光推送基础集成&quot;&gt;&lt;a href=&quot;#极光推送基础集成&quot; class=&quot;headerlink&quot; title=&quot;极光推送基础集成&quot;&gt;&lt;/a&gt;极光推送基础集成&lt;/h3&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;class MyHomePage extends StatefulWidget &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  const MyHomePage(&amp;#123;super.key, required this.title&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  final String title;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  @override&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  State&amp;lt;MyHomePage&amp;gt; createState() =&amp;gt; _MyHomePageState();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;class _MyHomePageState extends State&amp;lt;MyHomePage&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  JPush jpush = new JPush();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  @override&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Widget build(BuildContext context) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    return Scaffold(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      appBar: AppBar(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        title: Text(widget.title),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      ),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      body: Center(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        child: Column(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          mainAxisAlignment: MainAxisAlignment.center,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          children: &amp;lt;Widget&amp;gt;[&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ElevatedButton(onPressed:()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                //Map&amp;lt;String, dynamic&amp;gt; message&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                jpush.addEventHandler(onReceiveNotification: (message) async &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  print(&amp;quot;jpush flutter onReceiveNotification: $&amp;#123;json.encode(message)&amp;#125;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;, onOpenNotification: (message) async &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;, onReceiveMessage: (message) async &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  print(&amp;quot;jpush flutter onReceiveMessage: $&amp;#123;json.encode(message)&amp;#125;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;, onReceiveNotificationAuthorization: (message) async &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125; on PlatformException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;jpush Failed to get platform version.&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.setup(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                appKey: &amp;quot;bffe9289**********61869be9&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                channel: &amp;quot;developer-default&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                production: false,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                debug: false, // 设置是否打印 debug 日志&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.applyPushAuthority(NotificationSettingsIOS(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                sound: true,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                alert: true,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                badge: true,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              ));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.getRegistrationID().then((rid) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;jpush flutter get registration id : $rid&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;, child: Text(&amp;quot;setup&amp;quot;)),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ElevatedButton(onPressed:()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.applyPushAuthority();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;, child: Text(&amp;quot;apply&amp;quot;)),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ElevatedButton(onPressed:()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.isNotificationEnabled().then((bool value) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;jpush 通知授权是否打开: $value&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;).catchError((onError) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;jpush 通知授权是否打开: $&amp;#123;onError.toString()&amp;#125;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;, child: Text(&amp;quot;通知&amp;quot;)),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ElevatedButton(onPressed:()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.setAlias(&amp;quot;1000*****&amp;quot;).then((map) &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;==setAlias==$&amp;#123;map&amp;#125;==&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;, child: Text(&amp;quot;setAlias&amp;quot;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          ],&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      ),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
    <category term="极光推送" scheme="https://tabbycute.github.io/tags/%E6%9E%81%E5%85%89%E6%8E%A8%E9%80%81/"/>
    
  </entry>
  
  <entry>
    <title>etcd集群的搭建</title>
    <link href="https://tabbycute.github.io/2022/09/25/20220925etcd%E7%9A%84%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"/>
    <id>https://tabbycute.github.io/2022/09/25/20220925etcd%E7%9A%84%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/</id>
    <published>2022-09-24T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.048Z</updated>
    
    <content type="html"><![CDATA[<p>etcd安装不说了详情请看上篇文章</p><h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><h4 id="节点1"><a href="#节点1" class="headerlink" title="节点1"></a>节点1</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd --name etcd_t_0 --initial-advertise-peer-urls http://119.91.206.195:2380 \</span><br><span class="line">  --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --advertise-client-urls http://119.91.206.195:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd_t_0=http://119.91.206.195:2380,etcd_t_1=http://1.117.72.9:2380,etcd_t_2=http://47.92.80.135:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir /var/lib/etcd5/</span><br></pre></td></tr></table></figure><h4 id="节点2"><a href="#节点2" class="headerlink" title="节点2"></a>节点2</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd --name etcd_t_1 --initial-advertise-peer-urls http://1.117.72.9:2380 \</span><br><span class="line">  --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --advertise-client-urls http://1.117.72.9:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd_t_0=http://119.91.206.195:2380,etcd_t_1=http://1.117.72.9:2380,etcd_t_2=http://47.92.80.135:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir /var/lib/etcd5/</span><br></pre></td></tr></table></figure><h4 id="节点3"><a href="#节点3" class="headerlink" title="节点3"></a>节点3</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd --name etcd_t_2 --initial-advertise-peer-urls http://47.92.80.135:2380 \</span><br><span class="line">  --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --advertise-client-urls http://47.92.80.135:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd_t_0=http://119.91.206.195:2380,etcd_t_1=http://1.117.72.9:2380,etcd_t_2=http://47.92.80.135:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir /var/lib/etcd5/</span><br></pre></td></tr></table></figure><h3 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h3><ul><li><p>查看集群成员</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member list --write-out=table</span></span><br><span class="line">+------------------+---------+----------+----------------------------+----------------------------+</span><br><span class="line">|        ID        | STATUS  |   NAME   |         PEER ADDRS         |        CLIENT ADDRS        |</span><br><span class="line">+------------------+---------+----------+----------------------------+----------------------------+</span><br><span class="line">| 362499433afddc14 | started | etcd_t_1 | http://1.117.72.9:2380     | http://1.117.72.9:2379     |</span><br><span class="line">| e4258ae59dee9dc3 | started | etcd_t_0 | http://119.91.206.195:2380 | http://119.91.206.195:2379 |</span><br><span class="line">| feb1217e15f7013f | started | etcd_t_2 | http://47.92.80.135:2380   | http://47.92.80.135:2379   |</span><br><span class="line">+------------------+---------+----------+----------------------------+----------------------------+</span><br></pre></td></tr></table></figure></li><li><p>查看集群健康</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl --endpoints=119.91.206.195:2380,1.117.72.9:2380,47.92.80.135:2380 endpoint health</span></span><br><span class="line">1.117.72.9:2380 is healthy: successfully committed proposal: took = 87.35868ms</span><br><span class="line">47.92.80.135:2380 is healthy: successfully committed proposal: took = 111.468497ms</span><br><span class="line">119.91.206.195:2380 is healthy: successfully committed proposal: took = 101.468497ms</span><br></pre></td></tr></table></figure></li><li><p>查看集群状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl --endpoints=119.91.206.195:2380,1.117.72.9:2380,47.92.80.135:2380 endpoint status --write-out=table</span></span><br><span class="line">+---------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">|     ENDPOINT        |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">| 1.117.72.9:2380     | 362499433afddc14 | 3.3.11  | 20 kB   | <span class="literal">false</span>     |        15 |          9 |</span><br><span class="line">| 47.92.80.135:2380   | feb1217e15f7013f | 3.3.11  | 16 kB   | <span class="literal">false</span>     |        15 |          9 |</span><br><span class="line">| 119.91.206.195:2380 | e4258ae59dee9dc3 | 3.3.11  | 16 kB   | <span class="literal">true</span>      |        15 |          9 |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+-----------+------------+</span><br></pre></td></tr></table></figure></li><li><p>删除一个节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member remove 362499433afddc14</span></span><br><span class="line">Member 362499433afddc14 removed from cluster 51573d7cfd299893</span><br></pre></td></tr></table></figure></li><li><p>加入一个节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member add etcd_t_1 --peer-urls=http://1.117.72.9:2380</span></span><br><span class="line">Member c4356e396bf22311 added to cluster 51573d7cfd299893</span><br><span class="line"></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd_t_1&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd_t_1=http://1.117.72.9:2380,etcd_t_0=http://119.91.206.195:2380,etcd_t_2=http://47.92.80.135:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;existing&quot;</span></span><br></pre></td></tr></table></figure><p>新节点启动的时候使用以上输出的配置启动一定注意参数</p></li><li><p>故障主机加入节点</p></li></ul><p>故障的etcd主机：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop etcd</span><br></pre></td></tr></table></figure><p>移除故障节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member remove 362499433afddc14</span></span><br><span class="line">Member 362499433afddc14 removed from cluster 51573d7cfd299893</span><br></pre></td></tr></table></figure><p>查询集群成员</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+------------------+-----------+----------+----------------------------+----------------------------+</span><br><span class="line">|        ID        |  STATUS   |   NAME   |         PEER ADDRS         |        CLIENT ADDRS        |</span><br><span class="line">+------------------+-----------+----------+----------------------------+----------------------------+</span><br><span class="line">| 50466d8335f8506a | unstarted |          | http://1.117.72.9:2380     |                            |</span><br><span class="line">| e4258ae59dee9dc3 | started   | etcd_t_0 | http://119.91.206.195:2380 | http://119.91.206.195:2379 |</span><br><span class="line">| feb1217e15f7013f | started   | etcd_t_2 | http://47.92.80.135:2380   | http://47.92.80.135:2379   |</span><br><span class="line">+------------------+-----------+----------+----------------------------+----------------------------+</span><br></pre></td></tr></table></figure><p>正常的etcd主机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member add etcd_t_1 --peer-urls=http://1.117.72.9:2380</span></span><br><span class="line">Member c4356e396bf22311 added to cluster 51573d7cfd299893</span><br><span class="line"></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd_t_1&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd_t_1=http://1.117.72.9:2380,etcd_t_0=http://119.91.206.195:2380,etcd_t_2=http://47.92.80.135:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;existing&quot;</span></span><br></pre></td></tr></table></figure><p>故障的etcd主机，启动etcd后，再查看etcd状态：</p><blockquote><p>一定要去修改故障主机的配置为：ETCD_INITIAL_CLUSTER_STATE=”existing”</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先删除错误节点的数据</span></span><br><span class="line"><span class="built_in">rm</span> -rf /var/lib/etcd/member</span><br><span class="line">systemctl start etcd</span><br><span class="line"><span class="comment"># 等待一会，这时候会同步数据，稍等再查看节点状态</span></span><br><span class="line">etcdctl endpoint health</span><br><span class="line">127.0.0.1:2379 is healthy: successfully committed proposal: took = 24.52485ms</span><br></pre></td></tr></table></figure><p>到这里，etcd故障节点修复完毕</p><h3 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h3><ul><li>这是集群中使用的etcd版本不一致的提示(<strong>这很有可能到导致集群不健康，至少我这个版本会，后来我全是yum install etcd</strong>)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2022-09-25 21:59:44.187212 W | etcdserver: the <span class="built_in">local</span> etcd version 3.1.5 is not up-to-date</span><br><span class="line">2022-09-25 21:59:44.187217 W | etcdserver: member feb1217e15f7013f has a higher version 3.3.11</span><br></pre></td></tr></table></figure></li><li>如果在一个目录启动过etcd，要启动新的集群或者其他的新的实例，最好换个目录，他可能会导致无法启动。暴力点rm -rf ******</li><li>故障的etcd主机，一定要去修改故障主机的配置为：ETCD_INITIAL_CLUSTER_STATE=existing</li><li>注意如果是前面修复过坏节点，下次启动集群的时候也不需要去修改坏节点的ETCD_INITIAL_CLUSTER_STATE=new</li><li>不同版本的etcd命令可能不一样，比如：添加节点</li><li>设置成existing，必须确保在启动时候其他member是存活的（peer端口），否则启动失败。用在扩容新实例的启动。设置成new，用在cluster已知member的启动。</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;etcd安装不说了详情请看上篇文章&lt;/p&gt;
&lt;h3 id=&quot;启动服务&quot;&gt;&lt;a href=&quot;#启动服务&quot; class=&quot;headerlink&quot; title=&quot;启动服务&quot;&gt;&lt;/a&gt;启动服务&lt;/h3&gt;&lt;h4 id=&quot;节点1&quot;&gt;&lt;a href=&quot;#节点1&quot; class=&quot;headerlink&quot; title=&quot;节点1&quot;&gt;&lt;/a&gt;节点1&lt;/h4&gt;</summary>
    
    
    
    <category term="linux" scheme="https://tabbycute.github.io/categories/linux/"/>
    
    
    <category term="linux" scheme="https://tabbycute.github.io/tags/linux/"/>
    
    <category term="etcd" scheme="https://tabbycute.github.io/tags/etcd/"/>
    
  </entry>
  
  <entry>
    <title>etcd单节点安装和golang的简单使用</title>
    <link href="https://tabbycute.github.io/2022/09/18/20220918etcd%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85%E5%92%8Cgolang%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
    <id>https://tabbycute.github.io/2022/09/18/20220918etcd%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85%E5%92%8Cgolang%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</id>
    <published>2022-09-17T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.048Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装golang"><a href="#安装golang" class="headerlink" title="安装golang"></a>安装golang</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install golang</span><br></pre></td></tr></table></figure><h2 id="etcd单节点安装"><a href="#etcd单节点安装" class="headerlink" title="etcd单节点安装"></a>etcd单节点安装</h2><h3 id="源码包安装"><a href="#源码包安装" class="headerlink" title="源码包安装"></a>源码包安装</h3><h4 id="下载etcd"><a href="#下载etcd" class="headerlink" title="下载etcd"></a>下载etcd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.1.5/etcd-v3.1.5-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><h4 id="解压-etcd-v3-1-5-linux-amd64-tar-gz-压缩文件"><a href="#解压-etcd-v3-1-5-linux-amd64-tar-gz-压缩文件" class="headerlink" title="解压 etcd-v3.1.5-linux-amd64.tar.gz 压缩文件"></a>解压 etcd-v3.1.5-linux-amd64.tar.gz 压缩文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf etcd-v3.1.5-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><h4 id="将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。"><a href="#将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。" class="headerlink" title="将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。"></a>将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//进入文件夹</span><br><span class="line"><span class="built_in">cd</span> etcd-v3.1.5-linux-amd64/</span><br><span class="line">//将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。</span><br><span class="line"><span class="built_in">mv</span> etcd* /usr/local/bin</span><br></pre></td></tr></table></figure><h4 id="修改使用的api等级"><a href="#修改使用的api等级" class="headerlink" title="修改使用的api等级"></a>修改使用的api等级</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><h4 id="查看版本信息"><a href="#查看版本信息" class="headerlink" title="查看版本信息"></a>查看版本信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">etcdctl v</span><br><span class="line"></span><br><span class="line">etcdctl version: 3.1.5</span><br><span class="line">API version: 3.1</span><br><span class="line"></span><br><span class="line">etcd --version</span><br><span class="line"></span><br><span class="line">etcd Version: 3.1.5</span><br><span class="line">Git SHA: 2cf9e51</span><br><span class="line">Go Version: go1.10.3</span><br><span class="line">Go OS/Arch: linux/amd64</span><br></pre></td></tr></table></figure><h4 id="创建etcd数据存放位置"><a href="#创建etcd数据存放位置" class="headerlink" title="创建etcd数据存放位置"></a>创建etcd数据存放位置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 数据存放位置的文件夹</span><br><span class="line"><span class="built_in">mkdir</span> -p /var/lib/etcd/</span><br></pre></td></tr></table></figure><h4 id="创建启动文件"><a href="#创建启动文件" class="headerlink" title="创建启动文件"></a>创建启动文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/systemd/system/etcd.service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//复制以下即可</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Etcd Server</span></span><br><span class="line"><span class="string">Documentation=https://github.com/coreos/etcd</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">User=root</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">Environment=ETCD_NAME=etcd_test_1</span></span><br><span class="line"><span class="string">Environment=ETCD_DATA_DIR=/var/lib/etcd/</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/etcd</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">RestartSec=10s</span></span><br><span class="line"><span class="string">LimitNOFILE=40000</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h4 id="重新加载配置-amp-amp-开机启动-amp-amp-启动-etcd"><a href="#重新加载配置-amp-amp-开机启动-amp-amp-启动-etcd" class="headerlink" title="重新加载配置 &amp;&amp; 开机启动 &amp;&amp; 启动 etcd"></a>重新加载配置 &amp;&amp; 开机启动 &amp;&amp; 启动 etcd</h4><h5 id="启动etcd"><a href="#启动etcd" class="headerlink" title="启动etcd"></a>启动etcd</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> etcd &amp;&amp; systemctl start etcd</span><br><span class="line">//成功如下</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/etcd.service to /etc/systemd/system/etcd.service.</span><br></pre></td></tr></table></figure><h5 id="开机启动设置状态，状态-enabled"><a href="#开机启动设置状态，状态-enabled" class="headerlink" title="开机启动设置状态，状态 enabled"></a>开机启动设置状态，状态 enabled</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files etcd.service</span><br><span class="line"></span><br><span class="line">//成功如下</span><br><span class="line">UNIT FILE    STATE </span><br><span class="line">etcd.service enabled</span><br><span class="line"> </span><br><span class="line">1 unit files listed.</span><br></pre></td></tr></table></figure><h5 id="查看-etcd-状态"><a href="#查看-etcd-状态" class="headerlink" title="查看 etcd 状态"></a>查看 etcd 状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl show etcd.service</span><br></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">etcdctl put mykey <span class="string">&quot;this is etcd2&quot;</span></span><br><span class="line">OK</span><br><span class="line">etcdctl get mykey</span><br><span class="line">mykey</span><br><span class="line">this is etcd</span><br></pre></td></tr></table></figure><h4 id="外网连接"><a href="#外网连接" class="headerlink" title="外网连接"></a>外网连接</h4><p>当然，etcd默认本地访问。如果需要远程访问需要在配置文件（/etc/etcd.conf 上面创建的文件）中加上如下操作。注意如果上面一行不是字符串需要加个</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Type=notify</span><br><span class="line">Environment=ETCD_NAME=etcd_test_1</span><br><span class="line">Environment=ETCD_DATA_DIR=/var/lib/etcd/</span><br><span class="line"></span><br><span class="line">Environment=ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379</span><br><span class="line">Environment=ETCD_ADVERTISE_CLIENT_URLS=http://0.0.0.0:2379</span><br><span class="line">或者直接使用本机</span><br><span class="line">Environment=ETCD_LISTEN_CLIENT_URLS=http://1.117.72.92:2379</span><br><span class="line">Environment=ETCD_ADVERTISE_CLIENT_URLS=http://1.117.72.92:2379</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ExecStart=/usr/local/bin/etcd</span><br></pre></td></tr></table></figure><p><strong>如果当前已经启动了修改的配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启生效</span></span><br><span class="line">systemctl restart etcd</span><br><span class="line"><span class="comment"># 重启生效</span></span><br><span class="line">systemctl stop etcd</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> etcd &amp;&amp; systemctl start etcd</span><br></pre></td></tr></table></figure><h4 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h4><ul><li>–name：方便理解的节点名称，默认为 default，在集群中应该保持唯一，可以使用 hostname</li><li>–data-dir：服务运行数据保存的路径，默认为 ${name}.etcd</li><li>–snapshot-count：指定有多少事务（transaction）被提交时，触发截取快照保存到磁盘</li><li>–heartbeat-interval：leader 多久发送一次心跳到 followers。默认值是 100ms</li><li>–eletion-timeout：重新投票的超时时间，如果follower在该时间间隔没有收到心跳包，会触发重新投票，默认为 1000 ms</li><li>–listen-peer-urls：和同伴通信的地址，比如 <a href="http://ip:2380，如果有多个，使用逗号分隔。需要所有节点都能够访问，所以不要使用">http://ip:2380，如果有多个，使用逗号分隔。需要所有节点都能够访问，所以不要使用</a> localhost</li><li>–listen-client-urls：对外提供服务的地址：比如 <a href="http://ip:2379,http://127.0.0.1:2379，客户端会连接到这里和etcd交互">http://ip:2379,http://127.0.0.1:2379，客户端会连接到这里和etcd交互</a></li><li>–advertise-client-urls：对外公告的该节点客户端监听地址，这个值会告诉集群中其他节点</li><li>–initial-advertise-peer-urls：该节点同伴监听地址，这个值会告诉集群中其他节点</li><li>–initial-cluster：集群中所有节点的信息，格式为 node1=<a href="http://ip1:2380,node2=http://ip2:2380,…。需要注意的是，这里的">http://ip1:2380,node2=http://ip2:2380,…。需要注意的是，这里的</a> node1 是节点的–name指定的名字；后面的ip1:2380 是–initial-advertise-peer-urls 指定的值</li><li>–initial-cluster-state：新建集群的时候，这个值为 new；假如已经存在的集群，这个值为existing</li><li>–initial-cluster-token：创建集群的token，这个值每个集群保持唯一。这样的话，如果你要重新创建集群，即使配置和之前一样，也会再次生成新的集群和节点 uuid；否则会导致多个集群之间的冲突，造成未知的错误<br></li></ul><p>这些选项，与上面我们配置文件里的配置一一对应，如ETCD_INITIAL_CLUSTER等同于–inital-cluster, ETCD_INITIAL_CLUSTER_STATE等同于–initial-cluster-state。</p><blockquote><p>所有以–init开头的配置都是在第一次启动etcd集群的时候才会用到，后续节点的重启会被忽略，如–initial-cluseter参数。所以当成功初始化了一个etcd集群以后，就不再需要这个参数或环境变量了。</p></blockquote><h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl stop etcd</span><br><span class="line">etcdctl member list//查看节点</span><br></pre></td></tr></table></figure><h4 id="报错收集"><a href="#报错收集" class="headerlink" title="报错收集"></a>报错收集</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">No <span class="built_in">help</span> topic <span class="keyword">for</span> ‘put’</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_API=3 解决</span><br></pre></td></tr></table></figure><h3 id="etcd-git官方安装脚本"><a href="#etcd-git官方安装脚本" class="headerlink" title="etcd git官方安装脚本"></a>etcd git官方安装脚本</h3><blockquote><p><a href="https://github.com/etcd-io/etcd/releases">https://github.com/etcd-io/etcd/releases</a><br>继续从 &lt;&lt;将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中&gt;&gt; 开始</p></blockquote><h3 id="etcd-yum安装"><a href="#etcd-yum安装" class="headerlink" title="etcd yum安装"></a>etcd yum安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install etcd</span><br><span class="line"></span><br><span class="line">//继续从 &lt;&lt;修改使用的api等级&gt;&gt; 开始</span><br></pre></td></tr></table></figure><h2 id="安装etcd-webui"><a href="#安装etcd-webui" class="headerlink" title="安装etcd webui"></a>安装etcd webui</h2><ul><li>记得启动Etcd服务。</li><li>先安装node，git环境，然后clone。</li><li>安装node可以到 <a href="http://nodejs.cn/download/%E4%B8%8B%E8%BD%BD%E5%AF%B9%E5%BA%94%E7%9A%84">http://nodejs.cn/download/下载对应的</a> node 版本。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/henszey/etcd-browser.git</span><br><span class="line">cd etcd-browser/</span><br><span class="line">vim server.js  </span><br></pre></td></tr></table></figure>编辑server.js，修改内容如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var etcdHost = process.env.ETCD_HOST || &#x27;127.0.0.1&#x27;;  # etcd 主机IP</span><br><span class="line">var etcdPort = process.env.ETCD_PORT || 2379;          # etcd 主机端口</span><br><span class="line">var serverPort = process.env.SERVER_PORT || 8000;      # etcd-browser 监听端口</span><br></pre></td></tr></table></figure>然后启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node server.js</span><br></pre></td></tr></table></figure>访问：<a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a></li></ul><h2 id="go连接etcd和一些操作"><a href="#go连接etcd和一些操作" class="headerlink" title="go连接etcd和一些操作"></a>go连接etcd和一些操作</h2><h3 id="put-get的简单操作示例"><a href="#put-get的简单操作示例" class="headerlink" title="put/get的简单操作示例"></a>put/get的简单操作示例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;go.etcd.io/etcd/client/v3&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="comment">// handle error!</span></span><br><span class="line">      fmt.Printf(<span class="string">&quot;connect to etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line">   <span class="comment">// put</span></span><br><span class="line">   ctx, cancel := context.WithTimeout(context.Background(), <span class="number">3</span>*time.Second)</span><br><span class="line">   _, err = cli.Put(ctx, <span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v1&quot;</span>)</span><br><span class="line">   cancel()</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;put to etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// get</span></span><br><span class="line">   ctx, cancel = context.WithTimeout(context.Background(), <span class="number">3</span>*time.Second)</span><br><span class="line">   resp, err := cli.Get(ctx, <span class="string">&quot;k1&quot;</span>)</span><br><span class="line">   cancel()</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;get from etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">for</span> _, ev := <span class="keyword">range</span> resp.Kvs &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;%s:%s\n&quot;</span>, ev.Key, ev.Value)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="watch的使用"><a href="#watch的使用" class="headerlink" title="watch的使用"></a>watch的使用</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;go.etcd.io/etcd/client/v3&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;connect to etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line">   <span class="comment">// watch key:q1mi change</span></span><br><span class="line">   rch := cli.Watch(context.Background(), <span class="string">&quot;k1&quot;</span>) <span class="comment">// &lt;-chan WatchResponse</span></span><br><span class="line">   <span class="keyword">for</span> wresp := <span class="keyword">range</span> rch &#123;</span><br><span class="line">      <span class="keyword">for</span> _, ev := <span class="keyword">range</span> wresp.Events &#123;</span><br><span class="line">         fmt.Printf(<span class="string">&quot;Type: %s Key:%s Value:%s\n&quot;</span>, ev.Type, ev.Kv.Key, ev.Kv.Value)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在同级的目录下cmd进入(下面操作是在windows上进行的，因为方便)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcdctl.exe --endpoints=http://127.0.0.1:2379 put k1 <span class="string">&quot;xixixixix&quot;</span></span><br><span class="line">etcdctl.exe --endpoints=http://127.0.0.1:2379 del k1</span><br><span class="line">etcdctl.exe --endpoints=http://127.0.0.1:2379 put k1 <span class="string">&quot;dsb3&quot;</span></span><br></pre></td></tr></table></figure><h3 id="lease租约的使用"><a href="#lease租约的使用" class="headerlink" title="lease租约的使用"></a>lease租约的使用</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;go.etcd.io/etcd/client/v3&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: time.Second * <span class="number">5</span>,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success.&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 创建一个5秒的租约</span></span><br><span class="line">   resp, err := cli.Grant(context.TODO(), <span class="number">5</span>)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(resp.ID)</span><br><span class="line">   <span class="comment">// 5秒钟之后, /aaaa/ 这个key就会被移除</span></span><br><span class="line">   _, err = cli.Put(context.TODO(), <span class="string">&quot;/aaaa/&quot;</span>, <span class="string">&quot;dsb&quot;</span>, clientv3.WithLease(resp.ID))</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   time.Sleep(time.Second * <span class="number">6</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="keepAlive"><a href="#keepAlive" class="headerlink" title="keepAlive"></a>keepAlive</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: time.Second * <span class="number">5</span>,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success.&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">   resp, err := cli.Grant(context.TODO(), <span class="number">5</span>)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   _, err = cli.Put(context.TODO(), <span class="string">&quot;/aaaa/&quot;</span>, <span class="string">&quot;dsb&quot;</span>, clientv3.WithLease(resp.ID))</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// the key &#x27;foo&#x27; will be kept forever</span></span><br><span class="line">   ch, kaerr := cli.KeepAlive(context.TODO(), resp.ID)</span><br><span class="line">   <span class="keyword">if</span> kaerr != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      ka := &lt;-ch</span><br><span class="line">      fmt.Println(<span class="string">&quot;ttl:&quot;</span>, ka.TTL)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;安装golang&quot;&gt;&lt;a href=&quot;#安装golang&quot; class=&quot;headerlink&quot; title=&quot;安装golang&quot;&gt;&lt;/a&gt;安装golang&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install golang&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;etcd单节点安装&quot;&gt;&lt;a href=&quot;#etcd单节点安装&quot; class=&quot;headerlink&quot; title=&quot;etcd单节点安装&quot;&gt;&lt;/a&gt;etcd单节点安装&lt;/h2&gt;</summary>
    
    
    
    <category term="linux" scheme="https://tabbycute.github.io/categories/linux/"/>
    
    
    <category term="golang" scheme="https://tabbycute.github.io/tags/golang/"/>
    
    <category term="linux" scheme="https://tabbycute.github.io/tags/linux/"/>
    
    <category term="etcd" scheme="https://tabbycute.github.io/tags/etcd/"/>
    
  </entry>
  
  <entry>
    <title>查看yum软件的安装目录</title>
    <link href="https://tabbycute.github.io/2022/06/10/20220610docker%E7%9A%84%E5%AE%89%E8%A3%85/"/>
    <id>https://tabbycute.github.io/2022/06/10/20220610docker%E7%9A%84%E5%AE%89%E8%A3%85/</id>
    <published>2022-06-09T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.048Z</updated>
    
    <content type="html"><![CDATA[<h3 id="官网推荐安装"><a href="#官网推荐安装" class="headerlink" title="官网推荐安装"></a>官网推荐安装</h3><hr><ul><li>卸载旧版本<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">      docker-client \</span><br><span class="line">      docker-client-latest \</span><br><span class="line">      docker-common \</span><br><span class="line">      docker-latest \</span><br><span class="line">      docker-latest-logrotate \</span><br><span class="line">      docker-logrotate \</span><br><span class="line">      docker-engine</span><br><span class="line"><span class="comment">#卸载 Docker Engine、CLI、Containerd 和 Docker Compose 软件包：</span></span><br><span class="line">yum remove docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br><span class="line"><span class="comment">#主机上的映像、容器、卷或自定义配置文件不会自动删除。要删除所有映像、容器和卷：</span></span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/docker</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/containerd</span><br></pre></td></tr></table></figure></li></ul><h3 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h3><hr><ul><li>设置存储库。安装yum-utils包（提供yum-config-manager 实用程序）并设置存储库。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils</span><br><span class="line"></span><br><span class="line">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment">#可以使用阿里源，最好选这个</span></span><br><span class="line">yum-config-manager --add-repo=http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">yum makecache <span class="comment">#重新构建缓存</span></span><br><span class="line"></span><br><span class="line">yum repolist &#123;all|enabled|disabled&#125;             <span class="comment">#列出所有/已启用/已禁用的yum源</span></span><br><span class="line">yum --disablerepo=repo                          <span class="comment">#临时禁用某个repo源</span></span><br><span class="line">yum --enablerepo=repo                          <span class="comment">#解除禁用某个repo源</span></span><br></pre></td></tr></table></figure><ul><li>安装 Docker 引擎。安装最新版本的 Docker Engine、containerd 和 Docker Compose </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure><ul><li>要安装特定版本的 Docker Engine，请在 repo 中列出可用版本，然后选择并安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | <span class="built_in">sort</span> -r</span><br><span class="line"></span><br><span class="line">docker-ce.x86_64 3:18.09.1-3.el7 docker-ce-stable </span><br><span class="line">docker-ce.x86_64 3:18.09.0-3.el7 docker-ce-stable </span><br><span class="line">docker-ce.x86_64 18.06.1.ce-3.el7 docker-ce-stable</span><br><span class="line">docker-ce.x86_64 18.06.0.ce-3.el7 docker-ce-stable</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>安装。具体的版本可以选择</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认安装</span></span><br><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br><span class="line"><span class="comment">#可以选择版本</span></span><br><span class="line">sudo yum install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure><ul><li>结束</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start docker       <span class="comment">#启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker      <span class="comment">#开机启动</span></span><br><span class="line">docker version                    <span class="comment">#查看版本</span></span><br><span class="line">docker run hello-world            <span class="comment">#示例进项</span></span><br></pre></td></tr></table></figure><blockquote><p>如果超时了切换一下yum源<br>yum-config-manager –add-repo <a href="http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo">http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</a></p></blockquote><h3 id="官网脚本安装"><a href="#官网脚本安装" class="headerlink" title="官网脚本安装"></a>官网脚本安装</h3><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com -o get-docker.sh</span><br><span class="line"></span><br><span class="line">sudo sh get-docker.sh</span><br><span class="line">或者</span><br><span class="line">sudo DRY_RUN=1 sh ./get-docker.sh</span><br></pre></td></tr></table></figure><h3 id="安装gcc"><a href="#安装gcc" class="headerlink" title="安装gcc"></a>安装gcc</h3><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc</span><br><span class="line">yum -y install gcc c++</span><br></pre></td></tr></table></figure><h3 id="镜像加速"><a href="#镜像加速" class="headerlink" title="镜像加速"></a>镜像加速</h3><hr><ul><li>创建 /etc/docker</li><li>加入地址</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;https://mirror.ccs.tencentyun.com&quot;</span></span><br><span class="line">     ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;官网推荐安装&quot;&gt;&lt;a href=&quot;#官网推荐安装&quot; class=&quot;headerlink&quot; title=&quot;官网推荐安装&quot;&gt;&lt;/a&gt;官网推荐安装&lt;/h3&gt;&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;卸载旧版本&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum remove docker \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      docker-client \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      docker-client-latest \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      docker-common \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      docker-latest \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      docker-latest-logrotate \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      docker-logrotate \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      docker-engine&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#卸载 Docker Engine、CLI、Containerd 和 Docker Compose 软件包：&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum remove docker-ce docker-ce-cli containerd.io docker-compose-plugin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#主机上的映像、容器、卷或自定义配置文件不会自动删除。要删除所有映像、容器和卷：&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo &lt;span class=&quot;built_in&quot;&gt;rm&lt;/span&gt; -rf /var/lib/docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo &lt;span class=&quot;built_in&quot;&gt;rm&lt;/span&gt; -rf /var/lib/containerd&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="docker" scheme="https://tabbycute.github.io/categories/docker/"/>
    
    
    <category term="linux" scheme="https://tabbycute.github.io/tags/linux/"/>
    
    <category term="docker" scheme="https://tabbycute.github.io/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>IM项目中electron对文件加密的方案设计与落地</title>
    <link href="https://tabbycute.github.io/2022/05/08/20220508IM%E9%A1%B9%E7%9B%AE%E4%B8%ADelectron%E5%AF%B9%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E7%9A%84%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E4%B8%8E%E8%90%BD%E5%9C%B0/"/>
    <id>https://tabbycute.github.io/2022/05/08/20220508IM%E9%A1%B9%E7%9B%AE%E4%B8%ADelectron%E5%AF%B9%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E7%9A%84%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E4%B8%8E%E8%90%BD%E5%9C%B0/</id>
    <published>2022-05-07T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.047Z</updated>
    
    <content type="html"><![CDATA[<p>文本加密很好实现，但是文件加密就稍微麻烦点。</p><p>但是我的预期加密的规则需要兼容老版本能够分辨出老版本未加密的文件，因为我们用户还可能查看老版本的聊天记录。能够分别不同版本规则的加密文件。文件不能全加密，效率要高。加密过后的文件大小，不能太大，要节约oss资源控制成本，这里我改成了一个参，可以手动设置加密后的文件新增的大小。视情况而定。</p><p>最终的加密路线如下：</p><p><img src="%22assets/img/202202041.png%22"></p><p>核心代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TBFileRules</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> checkHeadSign=[<span class="string">&quot;abcdabcdabcdabc&quot;</span>,<span class="string">&quot;abcdabcdabcdabcd&quot;</span>]                     <span class="comment">///解密时使用。是否符合解密文件。</span></span><br><span class="line">    <span class="keyword">static</span> headSign=&#123;<span class="attr">sign</span>:<span class="string">&quot;abcdabcdabcdabcd&quot;</span>,<span class="attr">headLen</span>:<span class="number">1024</span>/<span class="number">2</span>&#125;                        <span class="comment">///加密时使用。标记为加密文件。对象编译过后的字节长度不能超过50</span></span><br><span class="line">    <span class="keyword">static</span> appKey=<span class="string">&quot;tabby&quot;</span>                                                           <span class="comment">///appkey</span></span><br><span class="line">    <span class="keyword">static</span> encDataLen=<span class="number">1024</span>*<span class="number">10</span>;                                                      <span class="comment">///加密的长度，文件小于这个长度全加密 默认只加密10kb</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; -sgin:app签名</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -headLen:文件头的总长度</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileLen:文件的原长</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileEncLen:文件加密后总体的长度（不含头）</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileDataLen:加密段加密前的长度</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileDataEncLen:加密段加密后的长度</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileEncStart:加密后加密段开始的位置（不含头）</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; -ext:预留拓展字段</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">generateHeaderByte</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> &#123;fileLen,fileEncLen,fileDataLen,fileDataEncLen,fileEncStart,ext&#125;=opt;</span><br><span class="line">        <span class="keyword">let</span> header=&#123;&#125;</span><br><span class="line">        header.<span class="property">sgin</span>=<span class="title class_">TBFileRules</span>.<span class="property">appKey</span>;                     <span class="comment">///32 位app签名</span></span><br><span class="line">        header.<span class="property">headLenSign</span>=<span class="number">50</span>;                              <span class="comment">///加密标识的长度</span></span><br><span class="line">        header.<span class="property">headLen</span>=<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>.<span class="property">headLen</span>;        <span class="comment">///文件头的总长度</span></span><br><span class="line">        header.<span class="property">fileLen</span>=fileLen;                             <span class="comment">///文件的原长</span></span><br><span class="line">        header.<span class="property">fileEncLen</span>=fileEncLen;                       <span class="comment">///文件加密后总体的长度（不含头）</span></span><br><span class="line">        header.<span class="property">fileDataLen</span>=fileDataLen;                     <span class="comment">///加密段加密前的长度</span></span><br><span class="line">        header.<span class="property">fileDataEncLen</span>=fileDataEncLen;               <span class="comment">///加密段加密后的长度</span></span><br><span class="line">        header.<span class="property">fileEncStart</span>=fileEncStart;                   <span class="comment">///加密后加密段开始的位置（不含头）</span></span><br><span class="line">        header.<span class="property">ext</span>=ext;                                     <span class="comment">///预留拓展字段</span></span><br><span class="line">        <span class="comment">// console.log(header)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">TBFileRules</span>.<span class="title function_">strToByte</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(header))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        检查是否为加密文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Uint8Array</span>&#125; -source:源文件</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">checkIsEncFile</span>(<span class="params">source</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> headSign=<span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">TBFileRules</span>.<span class="title function_">byteToStr</span>(<span class="title class_">TBFileRules</span>.<span class="title function_">unshif0</span>(source.<span class="title function_">slice</span>(<span class="number">0</span>,<span class="number">50</span>))))</span><br><span class="line">            <span class="keyword">if</span>(<span class="title class_">TBFileRules</span>.<span class="property">checkHeadSign</span>.<span class="title function_">indexOf</span>(headSign.<span class="property">sign</span>)&gt;-<span class="number">1</span>)<span class="keyword">return</span> headSign</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        加密文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">CryptoJSTB</span>&#125; -cjstb:CryptoJSTB 实例</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Uint8Array</span>&#125; -source:源文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125;     -ext:拓展</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">encData</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> &#123;cjstb,source,ext&#125;=opt</span><br><span class="line"></span><br><span class="line">            source=<span class="title class_">Array</span>.<span class="title function_">from</span>(source)</span><br><span class="line">            <span class="keyword">if</span>(!ext)ext=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> encDataU8=[],                               <span class="comment">//加密前的加密段</span></span><br><span class="line">                fileEnd=<span class="title class_">TBFileRules</span>.<span class="property">encDataLen</span>,             <span class="comment">//加密结束的位置</span></span><br><span class="line">                encDataSourceU8=[],                         <span class="comment">//加密后的加密段</span></span><br><span class="line">                sourceOtherData=[],                         <span class="comment">//未加密的部分</span></span><br><span class="line">                sourceEecData=[];                           <span class="comment">//未加密的部分</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(fileEnd&gt;source.<span class="property">length</span>)fileEnd=source.<span class="property">length</span></span><br><span class="line">            <span class="keyword">else</span> sourceOtherData=source.<span class="title function_">slice</span>(fileEnd)</span><br><span class="line"></span><br><span class="line">            encDataU8=source.<span class="title function_">slice</span>(<span class="number">0</span>,fileEnd)</span><br><span class="line">            encDataSourceU8=cjstb.<span class="title function_">encByteAES</span>(encDataU8)</span><br><span class="line">            sourceEecData=[...encDataSourceU8,...sourceOtherData]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> headerParams = <span class="title class_">TBFileRules</span>.<span class="title function_">generateHeaderByte</span>(&#123;</span><br><span class="line">                <span class="attr">fileLen</span>:source.<span class="property">length</span>,</span><br><span class="line">                <span class="attr">fileEncLen</span>:sourceEecData.<span class="property">length</span>,</span><br><span class="line">                <span class="attr">fileDataLen</span>:encDataU8.<span class="property">length</span>,</span><br><span class="line">                <span class="attr">fileDataEncLen</span>:encDataSourceU8.<span class="property">length</span>,</span><br><span class="line">                ext</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">var</span> headerSign = <span class="title class_">TBFileRules</span>.<span class="title function_">strToByte</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(headerSign.<span class="property">length</span>&lt;=<span class="number">50</span>)&#123;</span><br><span class="line">                <span class="keyword">let</span> ent=[]</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">50</span>-headerSign.<span class="property">length</span>;i++)&#123;ent.<span class="title function_">push</span>(<span class="number">0</span>)&#125;</span><br><span class="line">                headerSign=[...headerSign,...ent]</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_">reject</span>(&#123;<span class="attr">code</span>:<span class="number">0</span>,<span class="attr">msg</span>:<span class="string">&quot;headerSign.length  too long 50&quot;</span>&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> head=[...headerSign,...headerParams]</span><br><span class="line">           </span><br><span class="line">            <span class="keyword">if</span>(head.<span class="property">length</span>&lt;<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>.<span class="property">headLen</span>)&#123;</span><br><span class="line">                <span class="keyword">let</span> ent=[]</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>.<span class="property">headLen</span>-head.<span class="property">length</span>;i++)&#123;ent.<span class="title function_">push</span>(<span class="number">0</span>)&#125;</span><br><span class="line">                head=[...head,...ent]</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_">reject</span>(&#123;<span class="attr">code</span>:<span class="number">0</span>,<span class="attr">msg</span>:<span class="string">&quot;File head too long&quot;</span>&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_">resolve</span>(&#123;<span class="attr">code</span>:<span class="number">1</span>,<span class="attr">data</span>:<span class="keyword">new</span> <span class="title class_">Uint8Array</span>([...head,...sourceEecData])&#125;)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        解密密文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">CryptoJSTB</span>&#125; -cjstb:CryptoJSTB 实例</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Uint8Array</span>&#125; -source:源文件</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">decData</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> &#123;source,cjstb&#125;=opt</span><br><span class="line">            source=<span class="title class_">Array</span>.<span class="title function_">from</span>(source)</span><br><span class="line">            <span class="keyword">var</span> headSign=<span class="title class_">TBFileRules</span>.<span class="title function_">checkIsEncFile</span>(source)</span><br><span class="line">            <span class="keyword">if</span>(!headSign)&#123;</span><br><span class="line">                <span class="title function_">reject</span>(&#123;<span class="attr">code</span>:<span class="number">0</span>,<span class="attr">msg</span>:<span class="string">&quot;Failed to parse file&quot;</span>&#125;)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> headParamsByte = source.<span class="title function_">slice</span>(<span class="number">50</span>,headSign.<span class="property">headLen</span>)</span><br><span class="line">            <span class="keyword">var</span> headParamsByteUnfit0 = <span class="title class_">TBFileRules</span>.<span class="title function_">unshif0</span>(headParamsByte)</span><br><span class="line">            <span class="keyword">var</span> headParams = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">TBFileRules</span>.<span class="title function_">byteToStr</span>(headParamsByteUnfit0))</span><br><span class="line">            <span class="keyword">var</span> encData=source.<span class="title function_">slice</span>(headSign.<span class="property">headLen</span>,headSign.<span class="property">headLen</span> + headParams.<span class="property">fileDataEncLen</span>)</span><br><span class="line">            <span class="keyword">var</span> otherData=source.<span class="title function_">slice</span>(headSign.<span class="property">headLen</span> + headParams.<span class="property">fileDataEncLen</span>)</span><br><span class="line">            <span class="keyword">var</span> decData=cjstb.<span class="title function_">decByteAES</span>(encData)</span><br><span class="line">            <span class="title function_">resolve</span>(&#123;</span><br><span class="line">                <span class="attr">code</span>:<span class="number">1</span>,</span><br><span class="line">                <span class="attr">params</span>:headParams,</span><br><span class="line">                <span class="attr">data</span>:<span class="keyword">new</span> <span class="title class_">Uint8Array</span>([...decData,...otherData])</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        文件转u8</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">file</span>&#125;</span></span><br><span class="line"><span class="comment">        <span class="doctag">@return</span> &#123;<span class="type">Promise&lt;Uint8Array&gt;</span>&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">fileToUint8</span>(<span class="params">file</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span><br><span class="line">            reader.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;<span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(e.<span class="property">target</span>.<span class="property">result</span>))&#125;</span><br><span class="line">            reader.<span class="title function_">readAsArrayBuffer</span>(file);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">saveFile</span>(<span class="params">uint8List,fileName</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> blob=<span class="keyword">new</span> <span class="title class_">Blob</span>([uint8List]);</span><br><span class="line">        <span class="keyword">const</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">        link.<span class="property">href</span> = <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span><br><span class="line">        link.<span class="property">download</span> = fileName;</span><br><span class="line">        link.<span class="title function_">click</span>();</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">revokeObjectURL</span>(link.<span class="property">href</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">///去除字节最后的0</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">unshif0</span>(<span class="params">list</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> data=[...list]</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;list.<span class="property">length</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(data[data.<span class="property">length</span>-<span class="number">1</span>])<span class="keyword">return</span> data</span><br><span class="line">            <span class="keyword">else</span> data.<span class="title function_">pop</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">strToByte</span>(<span class="params">str</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line">        <span class="keyword">var</span> len, c;</span><br><span class="line">        len = str.<span class="property">length</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            c = str.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">            <span class="keyword">if</span> (c &gt;= <span class="number">0x010000</span> &amp;&amp; c &lt;= <span class="number">0x10FFFF</span>) &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">18</span>) &amp; <span class="number">0x07</span>) | <span class="number">0xF0</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>((c &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &gt;= <span class="number">0x000800</span> &amp;&amp; c &lt;= <span class="number">0x00FFFF</span>) &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x0F</span>) | <span class="number">0xE0</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>((c &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &gt;= <span class="number">0x000080</span> &amp;&amp; c &lt;= <span class="number">0x0007FF</span>) &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x1F</span>) | <span class="number">0xC0</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>((c &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(c &amp; <span class="number">0xFF</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">byteToStr</span>(<span class="params">utf8Bytes</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> unicodeStr =<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> pos = <span class="number">0</span>; pos &lt; utf8Bytes.<span class="property">length</span>;)&#123;</span><br><span class="line">            <span class="keyword">var</span> flag= utf8Bytes[pos];</span><br><span class="line">            <span class="keyword">var</span> unicode = <span class="number">0</span> ;</span><br><span class="line">            <span class="keyword">if</span> ((flag &gt;&gt;&gt;<span class="number">7</span>) === <span class="number">0</span> ) &#123;</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(utf8Bytes[pos]);</span><br><span class="line">                pos += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xFC</span>) === <span class="number">0xFC</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x3</span>) &lt;&lt; <span class="number">30</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">24</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">18</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">3</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">12</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">4</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">5</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xF8</span>) === <span class="number">0xF8</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x7</span>) &lt;&lt; <span class="number">24</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">18</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">12</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">3</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">4</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xF0</span>) === <span class="number">0xF0</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0xF</span>) &lt;&lt; <span class="number">18</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">12</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">3</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xE0</span>) === <span class="number">0xE0</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x1F</span>) &lt;&lt; <span class="number">12</span>;;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xC0</span>) === <span class="number">0xC0</span> )&#123; <span class="comment">//110</span></span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(utf8Bytes[pos]);</span><br><span class="line">                pos += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> unicodeStr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试demo <a href="https://github.com/TabbyCute/web_libs/tree/main/demos/crypto-js-bigfile">https://github.com/TabbyCute/web_libs/tree/main/demos/crypto-js-bigfile</a></p><p>项目使用 <a href="https://github.com/TabbyCute/web_libs/tree/main/libs/crypto-js-bigfile">https://github.com/TabbyCute/web_libs/tree/main/libs/crypto-js-bigfile</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;文本加密很好实现，但是文件加密就稍微麻烦点。&lt;/p&gt;
&lt;p&gt;但是我的预期加密的规则需要兼容老版本能够分辨出老版本未加密的文件，因为我们用户还可能查看老版本的聊天记录。能够分别不同版本规则的加密文件。文件不能全加密，效率要高。加密过后的文件大小，不能太大，要节约oss资源控制成本，这里我改成了一个参，可以手动设置加密后的文件新增的大小。视情况而定。&lt;/p&gt;
&lt;p&gt;最终的加密路线如下：&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="cryptojs" scheme="https://tabbycute.github.io/tags/cryptojs/"/>
    
    <category term="im" scheme="https://tabbycute.github.io/tags/im/"/>
    
  </entry>
  
  <entry>
    <title>查看yum软件的安装目录</title>
    <link href="https://tabbycute.github.io/2022/05/01/20220601%E6%9F%A5%E7%9C%8Byum%E5%AE%89%E8%A3%85%E7%9A%84%E8%BD%AF%E4%BB%B6%E4%BD%8D%E7%BD%AE/"/>
    <id>https://tabbycute.github.io/2022/05/01/20220601%E6%9F%A5%E7%9C%8Byum%E5%AE%89%E8%A3%85%E7%9A%84%E8%BD%AF%E4%BB%B6%E4%BD%8D%E7%BD%AE/</id>
    <published>2022-04-30T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.047Z</updated>
    
    <content type="html"><![CDATA[<p>今天使用yum 安装了一个软件，后来没有找到路径</p><p>1、首先安装一个redis</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># yum install redis</span></span><br></pre></td></tr></table></figure><p>2、查找redis的安装包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># rpm -qa|grep redis</span></span><br><span class="line">redis-3.2.10-2.el7.x86_64</span><br><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure><p>3、查找安装包的安装路径</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># rpm -ql redis-3.2.10-2.el7.x86_64</span></span><br><span class="line">/etc/logrotate.d/redis</span><br><span class="line">/etc/redis-sentinel.conf</span><br><span class="line">/etc/redis.conf</span><br><span class="line">/etc/systemd/system/redis-sentinel.service.d</span><br><span class="line">/etc/systemd/system/redis-sentinel.service.d/limit.conf</span><br><span class="line">/etc/systemd/system/redis.service.d</span><br><span class="line">/etc/systemd/system/redis.service.d/limit.conf</span><br><span class="line">/usr/bin/redis-benchmark</span><br><span class="line">/usr/bin/redis-check-aof</span><br><span class="line">/usr/bin/redis-check-rdb</span><br><span class="line">/usr/bin/redis-cli</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;今天使用yum 安装了一个软件，后来没有找到路径&lt;/p&gt;
&lt;p&gt;1、首先安装一个redis&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@iZbp1eem925ojwyx17ao9kZ ~]&lt;span class=&quot;comment&quot;&gt;# yum install redis&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="linux" scheme="https://tabbycute.github.io/categories/linux/"/>
    
    
    <category term="linux" scheme="https://tabbycute.github.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>IM聊天页面消息时间的展示(Flutter)</title>
    <link href="https://tabbycute.github.io/2022/04/25/20220425IM%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2%E6%B6%88%E6%81%AF%E6%97%B6%E9%97%B4%E7%9A%84%E5%B1%95%E7%A4%BAFlutter/"/>
    <id>https://tabbycute.github.io/2022/04/25/20220425IM%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2%E6%B6%88%E6%81%AF%E6%97%B6%E9%97%B4%E7%9A%84%E5%B1%95%E7%A4%BAFlutter/</id>
    <published>2022-04-24T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.047Z</updated>
    
    <content type="html"><![CDATA[<p>值得一提的是微信会根据手机系统的时间制度（24小时，12小时）展示的不一样的时间</p><blockquote><p>比如同一天 早上的11:30</p><p>24小时制 11:30</p><p>12小时制 上午 11:30</p></blockquote><p>下面时间为毫秒</p><p>数据结构因项目而异，请根据自己的项目适当更改</p><blockquote><p>dependencies: {intl: ^0.17.0}</p></blockquote><p>核心代码如下</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:intl/intl.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">String</span> _formatDate(<span class="built_in">DateTime</span> date, <span class="built_in">String</span> fmt) &#123;</span><br><span class="line">  DateFormat outputFormat = DateFormat(fmt);</span><br><span class="line">  <span class="keyword">return</span> outputFormat.format(date);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">String</span> _getTimeStringAutoShort2(<span class="built_in">int</span> timestamp, <span class="built_in">bool</span> mustIncludeTime) &#123;</span><br><span class="line">  <span class="comment">//当前日期</span></span><br><span class="line">  <span class="built_in">DateTime</span> currentDate = <span class="built_in">DateTime</span>.now();</span><br><span class="line">  <span class="built_in">int</span> currentYear = currentDate.year;</span><br><span class="line">  <span class="built_in">int</span> currentMonth = currentDate.month;</span><br><span class="line">  <span class="built_in">int</span> currentDateD = currentDate.day;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//传入的日期 millTime为毫秒级时间戳</span></span><br><span class="line">  <span class="built_in">DateTime</span> srcDate = <span class="built_in">DateTime</span>.fromMillisecondsSinceEpoch(timestamp);</span><br><span class="line">  <span class="built_in">int</span> srcYear = srcDate.year;</span><br><span class="line">  <span class="built_in">int</span> srcMonth = srcDate.month;</span><br><span class="line">  <span class="built_in">int</span> srcDateD = srcDate.day;</span><br><span class="line"></span><br><span class="line">  <span class="comment">///<span class="language-markdown">结果</span></span></span><br><span class="line">  <span class="built_in">String</span> ret = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> timeExtraStr =</span><br><span class="line">      mustIncludeTime ? <span class="string">&quot; &quot;</span> + _formatDate(srcDate, <span class="string">&quot;HH:mm&quot;</span>) : <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (srcYear == currentYear) &#123;</span><br><span class="line">    <span class="comment">///<span class="language-markdown">当年</span></span></span><br><span class="line">    <span class="built_in">int</span> currentTimestamp = currentDate.millisecondsSinceEpoch;</span><br><span class="line">    <span class="built_in">int</span> srcTimestamp = timestamp;</span><br><span class="line">    <span class="comment">// 相差时间（单位：毫秒）</span></span><br><span class="line">    <span class="built_in">int</span> deltaTime = (currentTimestamp - srcTimestamp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当天（月份和日期一致才是）</span></span><br><span class="line">    <span class="keyword">if</span> (currentMonth == srcMonth &amp;&amp; currentDateD == srcDateD) &#123;</span><br><span class="line">      ret = _formatDate(srcDate, <span class="string">&quot;HH:mm&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 当年 &amp;&amp; 当天之外的时间（即昨天及以前的时间）</span></span><br><span class="line">      <span class="comment">// 昨天（以“现在”的时候为基准-1天）</span></span><br><span class="line">      <span class="built_in">DateTime</span> yesterdayDate =</span><br><span class="line">          <span class="built_in">DateTime</span>.fromMillisecondsSinceEpoch(currentTimestamp - <span class="number">86400000</span> * <span class="number">1</span>);</span><br><span class="line">      <span class="comment">// 前天（以“现在”的时候为基准-2天）</span></span><br><span class="line">      <span class="built_in">DateTime</span> beforeYesterdayDate =</span><br><span class="line">          <span class="built_in">DateTime</span>.fromMillisecondsSinceEpoch(currentTimestamp - <span class="number">86400000</span> * <span class="number">2</span>);</span><br><span class="line">      <span class="comment">// 用目标日期的“月”和“天”跟上方计算出来的“昨天”进行比较，是最为准确的（如果用时间戳差值</span></span><br><span class="line">      <span class="comment">// 的形式，是不准确的，比如：现在时刻是2019年02月22日1:00、而srcDate是2019年02月21日23:00，</span></span><br><span class="line">      <span class="comment">// 这两者间只相差2小时，直接用“deltaTime/(3600 * 1000)” &gt; 24小时来判断是否昨天，就完全是扯蛋的逻辑了）</span></span><br><span class="line">      <span class="keyword">if</span> (srcMonth == (yesterdayDate.month) &amp;&amp; srcDateD == yesterdayDate.day) &#123;</span><br><span class="line">        ret = <span class="string">&quot;昨天&quot;</span> + timeExtraStr; <span class="comment">// -1d</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (srcMonth == (beforeYesterdayDate.month) &amp;&amp;</span><br><span class="line">          srcDateD == beforeYesterdayDate.day) &#123;</span><br><span class="line">        <span class="comment">// “前天”判断逻辑同上</span></span><br><span class="line">        ret = <span class="string">&quot;前天&quot;</span> + timeExtraStr; <span class="comment">// -2d</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 跟当前时间相差的小时数</span></span><br><span class="line">        <span class="keyword">var</span> deltaHour = (deltaTime / (<span class="number">3600</span> * <span class="number">1000</span>));</span><br><span class="line">        <span class="comment">// 如果小于或等 7*24小时就显示星期几</span></span><br><span class="line">        <span class="keyword">if</span> (deltaHour &lt;= <span class="number">7</span> * <span class="number">24</span>) &#123;</span><br><span class="line">          <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; weekday = [];</span><br><span class="line">          weekday.addAll([<span class="string">&quot;星期一&quot;</span>, <span class="string">&quot;星期二&quot;</span>, <span class="string">&quot;星期三&quot;</span>, <span class="string">&quot;星期四&quot;</span>, <span class="string">&quot;星期五&quot;</span>, <span class="string">&quot;星期六&quot;</span>, <span class="string">&quot;星期日&quot;</span>]);</span><br><span class="line">          <span class="comment">// 取出当前是星期几</span></span><br><span class="line">          <span class="keyword">var</span> weedayDesc = weekday[srcDate.weekday - <span class="number">1</span>];</span><br><span class="line">          ret = weedayDesc + timeExtraStr;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 否则直接显示完整日期时间</span></span><br><span class="line">          ret = _formatDate(srcDate, <span class="string">&quot;yyyy年M月d日&quot;</span>) + timeExtraStr;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">///<span class="language-markdown">往年</span></span></span><br><span class="line">    ret = _formatDate(srcDate, <span class="string">&quot;yyyy年M月d日&quot;</span>) + timeExtraStr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">聊天页面时间展示的最小差</span></span></span><br><span class="line"><span class="built_in">bool</span> check2TimeGap(<span class="built_in">int</span> t1, <span class="built_in">int</span> t2) &#123;</span><br><span class="line">  <span class="keyword">if</span> ((t1 - t2).abs() &gt; <span class="number">1000</span> * <span class="number">60</span> * <span class="number">5</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> 向新收到的消息列表时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> [msg] 新收到的消息</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> [curStartTime] 最近一条消息的时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line"><span class="built_in">List</span> msgListTimeHook(<span class="built_in">List</span> msgList) &#123;</span><br><span class="line">  <span class="built_in">List</span> result = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; msgList.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> item = msgList[i];</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">      item[<span class="string">&quot;viewTime&quot;</span>] = _getTimeStringAutoShort2(item[<span class="string">&quot;time&quot;</span>], <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (check2TimeGap(item[<span class="string">&quot;time&quot;</span>], msgList[i - <span class="number">1</span>][<span class="string">&quot;time&quot;</span>])) &#123;</span><br><span class="line">      item[<span class="string">&quot;viewTime&quot;</span>] = _getTimeStringAutoShort2(item[<span class="string">&quot;time&quot;</span>], <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    result.add(item);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> 向新收到的消息列表时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> </span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> * @msg 新收到的消息</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> @curStartTime 最近一条消息的时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> </span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line">msgAloneTimeHook(msg, curStartTime) &#123;</span><br><span class="line">  <span class="comment">// if(!curStartTime)&#123;</span></span><br><span class="line">  <span class="comment">//     msg.viewTime=_getTimeStringAutoShort2(item.time, true)</span></span><br><span class="line">  <span class="comment">// &#125;else&#123;</span></span><br><span class="line">  <span class="comment">//     if (check2TimeGap(msg.time,curStartTime)) &#123;</span></span><br><span class="line">  <span class="comment">//         msg.viewTime=_getTimeStringAutoShort2(item.time, true)</span></span><br><span class="line">  <span class="comment">//     &#125;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="comment">// return msg</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基本使用如下</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">  <span class="keyword">var</span> mes = [</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息12&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1630113816000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息11&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1661649816000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息11&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664090674000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息周一&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664177074000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息前天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664263474000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息1&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664381016000</span>&#125;,</span><br><span class="line">  ];</span><br><span class="line">  <span class="comment">// _getTimeStringAutoShort2(1664380797000, true);</span></span><br><span class="line">  <span class="keyword">var</span> a = msgListTimeHook(mes);</span><br><span class="line">  <span class="built_in">print</span>(a);</span><br><span class="line">  <span class="comment">// 用于聊天内容界面时</span></span><br><span class="line">  <span class="keyword">var</span> b = _getTimeStringAutoShort2(<span class="number">1550789954260</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">///<span class="language-markdown">用于会话列表“消息”界面时</span></span></span><br><span class="line">  <span class="keyword">var</span> c = _getTimeStringAutoShort2(<span class="number">1550789954260</span>, <span class="keyword">false</span>);</span><br><span class="line">  <span class="built_in">print</span>(a);</span><br><span class="line">  <span class="built_in">print</span>(b);</span><br><span class="line">  <span class="built_in">print</span>(c);</span><br><span class="line">  <span class="comment">// mes.forEach((i) &#123;</span></span><br><span class="line">  <span class="comment">//   _getTimeStringAutoShort2(i[&quot;time&quot;] as int, true);</span></span><br><span class="line">  <span class="comment">// &#125;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大概结果如下下面返回的结果并非使用上面的数据</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息12&#x27;</span>, <span class="attr">time</span>: <span class="number">1630113816000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;2021年8月28日 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息11&#x27;</span>, <span class="attr">time</span>: <span class="number">1661649816000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;2022年8月28日 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息10.5&#x27;</span>, <span class="attr">time</span>: <span class="number">1664159074000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;星期一 10:24&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息10&#x27;</span>, <span class="attr">time</span>: <span class="number">1664328216000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息9&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息8&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息7&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息6&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息5&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378676000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息4&#x27;</span>, <span class="attr">time</span>: <span class="number">1664379876000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:44&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息3&#x27;</span>, <span class="attr">time</span>: <span class="number">1664379936000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息2&#x27;</span>, <span class="attr">time</span>: <span class="number">1664380797000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:59&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息1&#x27;</span>, <span class="attr">time</span>: <span class="number">1664381016000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-1&#x27;</span>, <span class="attr">time</span>: <span class="number">1664440902124</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;16:41&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-2&#x27;</span>, <span class="attr">time</span>: <span class="number">1664440962124</span> &#125;</span><br><span class="line">]</span><br><span class="line">&#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-3&#x27;</span>, <span class="attr">time</span>: <span class="number">1664441027131</span> &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;值得一提的是微信会根据手机系统的时间制度（24小时，12小时）展示的不一样的时间&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;比如同一天 早上的11:30&lt;/p&gt;
&lt;p&gt;24小时制 11:30&lt;/p&gt;
&lt;p&gt;12小时制 上午 11:30&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;下面时间为毫秒&lt;/p&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="im" scheme="https://tabbycute.github.io/tags/im/"/>
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
  <entry>
    <title>IM聊天页面消息时间的展示(web)</title>
    <link href="https://tabbycute.github.io/2022/04/20/20220420IM%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2%E6%B6%88%E6%81%AF%E6%97%B6%E9%97%B4%E7%9A%84%E5%B1%95%E7%A4%BAweb/"/>
    <id>https://tabbycute.github.io/2022/04/20/20220420IM%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2%E6%B6%88%E6%81%AF%E6%97%B6%E9%97%B4%E7%9A%84%E5%B1%95%E7%A4%BAweb/</id>
    <published>2022-04-19T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.046Z</updated>
    
    <content type="html"><![CDATA[<p>值得一提的是微信会根据手机系统的时间制度（24小时，12小时）展示的不一样的时间</p><blockquote><p>比如同一天 早上的11:30</p><p>24小时制 11:30</p><p>12小时制 上午 11:30</p></blockquote><p>下面时间为毫秒</p><p>数据结构因项目而异</p><p>核心代码如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对Date的扩展，将 Date 转化为指定格式的String。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，</span></span><br><span class="line"><span class="comment"> *  年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  【示例】：</span></span><br><span class="line"><span class="comment"> *  common.formatDate(new Date(), &#x27;yyyy-MM-dd hh:mm:ss.S&#x27;) ==&gt; 2006-07-02 08:09:04.423</span></span><br><span class="line"><span class="comment"> *  common.formatDate(new Date(), &#x27;yyyy-M-d h:m:s.S&#x27;)      ==&gt; 2006-7-2 8:9:4.18</span></span><br><span class="line"><span class="comment"> *  common.formatDate(new Date(), &#x27;hh:mm:ss.S&#x27;)            ==&gt; 08:09:04.423</span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> _formatDate = <span class="keyword">function</span> (<span class="params">date, fmt</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> o = &#123;</span><br><span class="line">        <span class="string">&quot;M+&quot;</span>: date.<span class="title function_">getMonth</span>() + <span class="number">1</span>, <span class="comment">//月份</span></span><br><span class="line">        <span class="string">&quot;d+&quot;</span>: date.<span class="title function_">getDate</span>(), <span class="comment">//日</span></span><br><span class="line">        <span class="string">&quot;h+&quot;</span>: date.<span class="title function_">getHours</span>(), <span class="comment">//小时</span></span><br><span class="line">        <span class="string">&quot;m+&quot;</span>: date.<span class="title function_">getMinutes</span>(), <span class="comment">//分</span></span><br><span class="line">        <span class="string">&quot;s+&quot;</span>: date.<span class="title function_">getSeconds</span>(), <span class="comment">//秒</span></span><br><span class="line">        <span class="string">&quot;q+&quot;</span>: <span class="title class_">Math</span>.<span class="title function_">floor</span>((date.<span class="title function_">getMonth</span>() + <span class="number">3</span>) / <span class="number">3</span>), <span class="comment">//季度</span></span><br><span class="line">        <span class="string">&quot;S&quot;</span>: date.<span class="title function_">getMilliseconds</span>() <span class="comment">//毫秒</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/(y+)/</span>.<span class="title function_">test</span>(fmt)) fmt = fmt.<span class="title function_">replace</span>(<span class="title class_">RegExp</span>.<span class="property">$1</span>, (date.<span class="title function_">getFullYear</span>() + <span class="string">&quot;&quot;</span>).<span class="title function_">substr</span>(<span class="number">4</span> - <span class="title class_">RegExp</span>.<span class="property">$1</span>.<span class="property">length</span>));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> o)</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">&quot;(&quot;</span> + k + <span class="string">&quot;)&quot;</span>).<span class="title function_">test</span>(fmt)) fmt = fmt.<span class="title function_">replace</span>(<span class="title class_">RegExp</span>.<span class="property">$1</span>, (<span class="title class_">RegExp</span>.<span class="property">$1</span>.<span class="property">length</span> == <span class="number">1</span>) ? (o[k]) : ((<span class="string">&quot;00&quot;</span> + o[k]).<span class="title function_">substr</span>((<span class="string">&quot;&quot;</span> + o[k]).<span class="property">length</span>)));</span><br><span class="line">    <span class="keyword">return</span> fmt;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 仿照微信中的消息时间显示逻辑，将时间戳（单位：毫秒）转换为友好的显示格式.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1）7天之内的日期显示逻辑是：今天、昨天(-1d)、前天(-2d)、星期？（只显示总计7天之内的星期数，即&lt;=-4d）；</span></span><br><span class="line"><span class="comment"> * 2）7天之外（即&gt;7天）的逻辑：直接显示完整日期时间。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[long]</span>&#125; timestamp 时间戳（单位：毫秒），形如：1550789954260</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">boolean</span>&#125; mustIncludeTime true表示输出的格式里一定会包含“时间:分钟”</span></span><br><span class="line"><span class="comment"> * ，否则不包含（参考微信，不包含时分的情况，用于首页“消息”中显示时）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> _getTimeStringAutoShort2 = <span class="keyword">function</span> (<span class="params">timestamp, mustIncludeTime</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前时间</span></span><br><span class="line">    <span class="keyword">var</span> currentDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="comment">// 目标判断时间</span></span><br><span class="line">    <span class="keyword">var</span> srcDate = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="built_in">parseInt</span>(timestamp));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> currentYear = currentDate.<span class="title function_">getFullYear</span>();</span><br><span class="line">    <span class="keyword">var</span> currentMonth = (currentDate.<span class="title function_">getMonth</span>() + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">var</span> currentDateD = currentDate.<span class="title function_">getDate</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> srcYear = srcDate.<span class="title function_">getFullYear</span>();</span><br><span class="line">    <span class="keyword">var</span> srcMonth = (srcDate.<span class="title function_">getMonth</span>() + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">var</span> srcDateD = srcDate.<span class="title function_">getDate</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> ret = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 要额外显示的时间分钟</span></span><br><span class="line">    <span class="keyword">var</span> timeExtraStr = (mustIncludeTime ? <span class="string">&quot; &quot;</span> + <span class="title function_">_formatDate</span>(srcDate, <span class="string">&quot;hh:mm&quot;</span>) : <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当年</span></span><br><span class="line">    <span class="keyword">if</span> (currentYear == srcYear) &#123;</span><br><span class="line">        <span class="keyword">var</span> currentTimestamp = currentDate.<span class="title function_">getTime</span>();</span><br><span class="line">        <span class="keyword">var</span> srcTimestamp = timestamp;</span><br><span class="line">        <span class="comment">// 相差时间（单位：毫秒）</span></span><br><span class="line">        <span class="keyword">var</span> deltaTime = (currentTimestamp - srcTimestamp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当天（月份和日期一致才是）</span></span><br><span class="line">        <span class="keyword">if</span> (currentMonth == srcMonth &amp;&amp; currentDateD == srcDateD) &#123;</span><br><span class="line">                ret = <span class="title function_">_formatDate</span>(srcDate, <span class="string">&quot;hh:mm&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 当年 &amp;&amp; 当天之外的时间（即昨天及以前的时间）</span></span><br><span class="line">            <span class="comment">// 昨天（以“现在”的时候为基准-1天）</span></span><br><span class="line">            <span class="keyword">var</span> yesterdayDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">            yesterdayDate.<span class="title function_">setDate</span>(yesterdayDate.<span class="title function_">getDate</span>() - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 前天（以“现在”的时候为基准-2天）</span></span><br><span class="line">            <span class="keyword">var</span> beforeYesterdayDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">            beforeYesterdayDate.<span class="title function_">setDate</span>(beforeYesterdayDate.<span class="title function_">getDate</span>() - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 用目标日期的“月”和“天”跟上方计算出来的“昨天”进行比较，是最为准确的（如果用时间戳差值</span></span><br><span class="line">            <span class="comment">// 的形式，是不准确的，比如：现在时刻是2019年02月22日1:00、而srcDate是2019年02月21日23:00，</span></span><br><span class="line">            <span class="comment">// 这两者间只相差2小时，直接用“deltaTime/(3600 * 1000)” &gt; 24小时来判断是否昨天，就完全是扯蛋的逻辑了）</span></span><br><span class="line">            <span class="keyword">if</span> (srcMonth == (yesterdayDate.<span class="title function_">getMonth</span>() + <span class="number">1</span>) &amp;&amp; srcDateD == yesterdayDate.<span class="title function_">getDate</span>())</span><br><span class="line">                ret = <span class="string">&quot;昨天&quot;</span> + timeExtraStr; <span class="comment">// -1d</span></span><br><span class="line">            <span class="comment">// “前天”判断逻辑同上</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (srcMonth == (beforeYesterdayDate.<span class="title function_">getMonth</span>() + <span class="number">1</span>) &amp;&amp; srcDateD == beforeYesterdayDate.<span class="title function_">getDate</span>())&#123;</span><br><span class="line">                ret = <span class="string">&quot;前天&quot;</span> + timeExtraStr; <span class="comment">// -2d</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 跟当前时间相差的小时数</span></span><br><span class="line">                <span class="keyword">var</span> deltaHour = (deltaTime / (<span class="number">3600</span> * <span class="number">1000</span>));</span><br><span class="line">                <span class="comment">// 如果小于或等 7*24小时就显示星期几</span></span><br><span class="line">                <span class="keyword">if</span> (deltaHour &lt;= <span class="number">7</span> * <span class="number">24</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> weekday = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">7</span>);</span><br><span class="line">                    weekday[<span class="number">0</span>] = <span class="string">&quot;星期日&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">1</span>] = <span class="string">&quot;星期一&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">2</span>] = <span class="string">&quot;星期二&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">3</span>] = <span class="string">&quot;星期三&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">4</span>] = <span class="string">&quot;星期四&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">5</span>] = <span class="string">&quot;星期五&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">6</span>] = <span class="string">&quot;星期六&quot;</span>;</span><br><span class="line">                    <span class="comment">// 取出当前是星期几</span></span><br><span class="line">                    <span class="keyword">var</span> weedayDesc = weekday[srcDate.<span class="title function_">getDay</span>()];</span><br><span class="line">                    ret = weedayDesc + timeExtraStr;</span><br><span class="line">                &#125; <span class="keyword">else</span>&#123;<span class="comment">// 否则直接显示完整日期时间</span></span><br><span class="line">                    ret = <span class="title function_">_formatDate</span>(srcDate, <span class="string">&quot;yyyy年M月d日&quot;</span>) + timeExtraStr;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 往年</span></span><br><span class="line">        ret = <span class="title function_">_formatDate</span>(srcDate, <span class="string">&quot;yyyy年M月d日&quot;</span>) + timeExtraStr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">///聊天页面时间展示的最小差</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check2TimeGap</span>(<span class="params">t1, t2</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">abs</span>(t1 - t2) &gt; <span class="number">1000</span> * <span class="number">60</span> * <span class="number">5</span>) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 向新收到的消息列表时间</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@msg</span> 新收到的消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@curStartTime</span> 最近一条消息的时间</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">msgListTimeHook</span>(<span class="params">msgList,startTime</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> result=[]</span><br><span class="line">    msgList.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">            item.<span class="property">viewTime</span>=<span class="title function_">_getTimeStringAutoShort2</span>(item.<span class="property">time</span>, <span class="literal">true</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">check2TimeGap</span>(item.<span class="property">time</span>, mes[index-<span class="number">1</span>].<span class="property">time</span>)) &#123;</span><br><span class="line">            item.<span class="property">viewTime</span>=<span class="title function_">_getTimeStringAutoShort2</span>(item.<span class="property">time</span>, <span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        result.<span class="title function_">push</span>(item)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 向新收到的消息列表时间</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@msg</span> 新收到的消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@curStartTime</span> 最近一条消息的时间</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">msgAloneTimeHook</span>(<span class="params">msg,curStartTime</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!curStartTime)&#123;</span><br><span class="line">        msg.<span class="property">viewTime</span>=<span class="title function_">_getTimeStringAutoShort2</span>(item.<span class="property">time</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">check2TimeGap</span>(msg.<span class="property">time</span>,curStartTime)) &#123;</span><br><span class="line">            msg.<span class="property">viewTime</span>=<span class="title function_">_getTimeStringAutoShort2</span>(item.<span class="property">time</span>, <span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基本使用如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息12&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1630113816000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息11&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1661649816000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息10.5&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664159074000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息10&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664328216000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息9&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378616000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息8&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378616000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息7&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378616000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息6&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378616000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息5&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378676000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息4&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664379876000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息3&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664379936000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息2&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664380797000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息1&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664381016000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息-1&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">valueOf</span>()-<span class="number">125</span>*<span class="number">1000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息-2&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">valueOf</span>()-<span class="number">65</span>*<span class="number">1000</span></span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">///向消息列表中添加时间</span></span><br><span class="line">mes=<span class="title function_">msgListTimeHook</span>(mes)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(mes)</span><br><span class="line"><span class="comment">///收到消息时判断是否需要展示时间</span></span><br><span class="line"><span class="keyword">var</span> curStartTime=mes[mes.<span class="property">length</span>-<span class="number">1</span>].<span class="property">time</span></span><br><span class="line"><span class="keyword">var</span> newmsg=<span class="title function_">msgAloneTimeHook</span>(&#123;</span><br><span class="line">    <span class="attr">m</span>: <span class="string">&quot;我是一条消息-3&quot;</span>,</span><br><span class="line">    <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">valueOf</span>()</span><br><span class="line">&#125;,curStartTime)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newmsg)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于聊天内容界面时</span></span><br><span class="line"><span class="title function_">_getTimeStringAutoShort2</span>(<span class="number">1550789954260</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="comment">///用于会话列表“消息”界面时</span></span><br><span class="line"><span class="title function_">_getTimeStringAutoShort2</span>(<span class="number">1550789954260</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>结果如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息12&#x27;</span>, <span class="attr">time</span>: <span class="number">1630113816000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;2021年8月28日 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息11&#x27;</span>, <span class="attr">time</span>: <span class="number">1661649816000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;2022年8月28日 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息10.5&#x27;</span>, <span class="attr">time</span>: <span class="number">1664159074000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;星期一 10:24&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息10&#x27;</span>, <span class="attr">time</span>: <span class="number">1664328216000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息9&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息8&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息7&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息6&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息5&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378676000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息4&#x27;</span>, <span class="attr">time</span>: <span class="number">1664379876000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:44&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息3&#x27;</span>, <span class="attr">time</span>: <span class="number">1664379936000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息2&#x27;</span>, <span class="attr">time</span>: <span class="number">1664380797000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:59&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息1&#x27;</span>, <span class="attr">time</span>: <span class="number">1664381016000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-1&#x27;</span>, <span class="attr">time</span>: <span class="number">1664440902124</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;16:41&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-2&#x27;</span>, <span class="attr">time</span>: <span class="number">1664440962124</span> &#125;</span><br><span class="line">]</span><br><span class="line">&#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-3&#x27;</span>, <span class="attr">time</span>: <span class="number">1664441027131</span> &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;值得一提的是微信会根据手机系统的时间制度（24小时，12小时）展示的不一样的时间&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;比如同一天 早上的11:30&lt;/p&gt;
&lt;p&gt;24小时制 11:30&lt;/p&gt;
&lt;p&gt;12小时制 上午 11:30&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;下面时间为毫秒&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="im" scheme="https://tabbycute.github.io/tags/im/"/>
    
  </entry>
  
  <entry>
    <title>在vue的data中调用computed的属性异常</title>
    <link href="https://tabbycute.github.io/2022/01/02/20220102%E5%9C%A8vue%E7%9A%84data%E4%B8%AD%E8%B0%83%E7%94%A8computed%E7%9A%84%E5%B1%9E%E6%80%A7%E5%BC%82%E5%B8%B8/"/>
    <id>https://tabbycute.github.io/2022/01/02/20220102%E5%9C%A8vue%E7%9A%84data%E4%B8%AD%E8%B0%83%E7%94%A8computed%E7%9A%84%E5%B1%9E%E6%80%A7%E5%BC%82%E5%B8%B8/</id>
    <published>2022-01-01T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.046Z</updated>
    
    <content type="html"><![CDATA[<p>先看问题</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">data</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line"><span class="attr">name</span>:<span class="variable language_">this</span>.<span class="property">nickname</span> <span class="comment">//undefined</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">computed</span>:&#123;</span><br><span class="line"><span class="title function_">nickname</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;1111&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这里很容易想到是执行顺序的问题，computed中的属性和data中的属性最终都会加载到app这个实例下。</p><p>如果data中的实例属性被创建完成的时候，computed中的实例属性还没被创建，很明显，在data中获取到computed中的属性必定是undefined…</p><p>解决方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">name</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">nickname</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用name() 或者直接在computed中对data中的属性赋值，因为此时data已经初始化。</span></span><br></pre></td></tr></table></figure><p>看似简单实际有很多小伙伴都不知道。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;先看问题&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title function_&quot;&gt;data&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;:&lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;nickname&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;//undefined&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;computed&lt;/span&gt;:&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;title function_&quot;&gt;nickname&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;1111&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在这里很容易想到是执行顺序的问题，computed中的属性和data中的属性最终都会加载到app这个实例下。&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="vue" scheme="https://tabbycute.github.io/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>Google Face web端登录</title>
    <link href="https://tabbycute.github.io/2021/12/20/20211220GoogleFaceweb%E7%AB%AF%E7%99%BB%E5%BD%95/"/>
    <id>https://tabbycute.github.io/2021/12/20/20211220GoogleFaceweb%E7%AB%AF%E7%99%BB%E5%BD%95/</id>
    <published>2021-12-19T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.046Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Google"><a href="#Google" class="headerlink" title="Google"></a>Google</h4><hr><ul><li>一定要使用最新的文档。<a href="https://developers.google.com/identity/gsi/web/guides/migration">https://developers.google.com/identity/gsi/web/guides/migration</a></li><li>控制台 <a href="https://console.cloud.google.com/apis/dashboard?project=tabbyceshi">https://console.cloud.google.com/apis/dashboard?project=tabbyceshi</a></li><li>应用 <a href="https://console.cloud.google.com/apis/credentials?project=tabbyceshi&amp;supportedpurview=project">https://console.cloud.google.com/apis/credentials?project=tabbyceshi&amp;supportedpurview=project</a></li></ul><p>测试demo</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;meta name=&quot;google-signin-client_id&quot; content=&quot;466619277311-sk2aoc77hg88lm4llvk74cbiq63utk9i.apps.googleusercontent.com&quot;&gt; --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;script src=&quot;https://accounts.google.com/gsi/client&quot; async defer&gt;&lt;/script&gt; --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;div class=&quot;g-signin2&quot; data-onsuccess=&quot;onSignIn&quot;&gt;222&lt;/div&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://accounts.google.com/gsi/client&quot;</span> <span class="attr">async</span> <span class="attr">defer</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;g_id_onload&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-login_uri</span>=<span class="string">&quot;http://localhost:5500/google.html&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-auto_prompt</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-client_id</span>=<span class="string">&quot;541694494382-p228lh72cbf9smp0greo8kekhvetkep3.apps.googleusercontent.com&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-callback</span>=<span class="string">&quot;handleCredentialResponse&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g_id_signin&quot;</span> <span class="attr">data-type</span>=<span class="string">&quot;standard&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handleCredentialResponse</span>(<span class="params">e</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>简易使用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">class</span> <span class="title class_">GoogleSDK</span> &#123;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">appendHtmlDOM</span>(<span class="params">attrs=[],dom=<span class="string">&#x27;script&#x27;</span></span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,_</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="keyword">var</span> body = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;body&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(dom);</span><br><span class="line">attrs.<span class="title function_">forEach</span>(<span class="function"><span class="params">i</span>=&gt;</span>&#123;script.<span class="title function_">setAttribute</span>(i.<span class="property">key</span>,i.<span class="property">value</span>)&#125;)</span><br><span class="line">body.<span class="title function_">appendChild</span>(script);</span><br><span class="line">script.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;<span class="title function_">resolve</span>()&#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">async</span> <span class="title class_">GetAaccessToken</span>(client_id) &#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="keyword">await</span> <span class="title class_">GoogleSDK</span>.<span class="title function_">appendHtmlDOM</span>([</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;src&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;https://accounts.google.com/gsi/client&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;type&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;text/javascript&quot;</span>&#125;,</span><br><span class="line">])</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">var</span> client= google.<span class="property">accounts</span>.<span class="property">oauth2</span>.<span class="title function_">initTokenClient</span>(&#123;</span><br><span class="line">client_id,</span><br><span class="line"><span class="attr">scope</span>: <span class="string">&#x27;https://www.googleapis.com/auth/calendar.readonly \ https://www.googleapis.com/auth/contacts.readonly&#x27;</span>,</span><br><span class="line"><span class="attr">callback</span>: <span class="function">(<span class="params">tokenResponse</span>) =&gt;</span> &#123;<span class="title function_">resolve</span>(tokenResponse)&#125;,</span><br><span class="line">&#125;);</span><br><span class="line">client.<span class="title function_">requestAccessToken</span>();</span><br><span class="line">&#125;)</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">revokeToken</span>(<span class="params">access_token</span>) &#123;</span><br><span class="line">google.<span class="property">accounts</span>.<span class="property">oauth2</span>.<span class="title function_">revoke</span>(access_token, <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;access token revoked&#x27;</span>) &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">async</span> <span class="title class_">UserLogin</span>(client_id) &#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">await</span> <span class="title class_">GoogleSDK</span>.<span class="title function_">appendHtmlDOM</span>([</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;src&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;https://accounts.google.com/gsi/client&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;type&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;text/javascript&quot;</span>&#125;,</span><br><span class="line">])</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">千万别放在有v-if的操作里面！！！</span></span><br><span class="line"><span class="comment">window.handleCredentialResponse=function(e)&#123;</span></span><br><span class="line"><span class="comment">console.log(e)</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">//需要写在html里面</span></span><br><span class="line"><span class="comment">&lt;div id=&quot;g_id_onload&quot;</span></span><br><span class="line"><span class="comment">data-login_uri=&quot;http://localhost:5500/google.html&quot;</span></span><br><span class="line"><span class="comment">data-auto_prompt=&quot;false&quot;</span></span><br><span class="line"><span class="comment">data-client_id=&quot;******&quot;</span></span><br><span class="line"><span class="comment">data-callback=&quot;handleCredentialResponse&quot;&gt;</span></span><br><span class="line"><span class="comment">&lt;/div&gt;</span></span><br><span class="line"><span class="comment">//点击即可登录，触发上面的handleCredentialResponse</span></span><br><span class="line"><span class="comment">&lt;div class=&quot;g_id_signin&quot; data-type=&quot;standard&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>相关报错。先尝试清缓存。如果是 vue/react 把 <script src="https://accounts.google.com/gsi/client" async defer></script> 放在模板文件的head里面</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Uncaught dw</span><br><span class="line"></span><br><span class="line">不能用127.0.0.1</span><br><span class="line">可以切换成http://localhost:**********</span><br></pre></td></tr></table></figure><p><img src="/assets/img/202112201.png"><br><img src="/assets/img/202112202.png"></p><h4 id="FaceBook"><a href="#FaceBook" class="headerlink" title="FaceBook"></a>FaceBook</h4><hr><ul><li>开发者 <a href="https://developers.facebook.com/docs/development/register?locale=zh_CN">https://developers.facebook.com/docs/development/register?locale=zh_CN</a></li><li>应用 <a href="https://developers.facebook.com/apps/?show_reminder=true">https://developers.facebook.com/apps/?show_reminder=true</a></li><li>白名单 <a href="https://developers.facebook.com/apps/1531808977238106/gaming-login/settings/">https://developers.facebook.com/apps/1531808977238106/gaming-login/settings/</a><br>demo<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Facebook Login JavaScript Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">checkLoginState</span>(<span class="params"></span>) &#123;               <span class="comment">// Called when a person is finished with the Login Button.</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable constant_">FB</span>.<span class="title function_">getLoginStatus</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;   <span class="comment">// See the onlogin handler</span></span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="property">fbAsyncInit</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable constant_">FB</span>.<span class="title function_">init</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">appId</span>: <span class="string">&#x27;**********&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">cookie</span>: <span class="literal">true</span>,                     <span class="comment">// Enable cookies to allow the server to access the session.</span></span></span><br><span class="line"><span class="language-javascript">                <span class="attr">xfbml</span>: <span class="literal">true</span>,                     <span class="comment">// Parse social plugins on this webpage.</span></span></span><br><span class="line"><span class="language-javascript">                <span class="attr">version</span>: <span class="string">&#x27;v14.0&#x27;</span>                  <span class="comment">// Use this Graph API version for this call.</span></span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            <span class="variable constant_">FB</span>.<span class="title function_">getLoginStatus</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;   <span class="comment">// Called after the JS SDK has been initialized.</span></span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(response);               <span class="comment">// The current login status of the person.</span></span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//   function testAPI() &#123;                      // Testing Graph API after login.  See statusChangeCallback() for when this call is made.</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//     console.log(&#x27;Welcome!  Fetching your information.... &#x27;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//     FB.api(&#x27;/me&#x27;, function(response) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//       console.log(&#x27;Successful login for: &#x27; + response.name);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//       document.getElementById(&#x27;status&#x27;).innerHTML = &#x27;Thanks for logging in, &#x27; + response.name + &#x27;!&#x27;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//     &#125;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//   &#125;</span></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- The JS SDK Login Button --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fb:login-button</span> <span class="attr">scope</span>=<span class="string">&quot;public_profile,email&quot;</span> <span class="attr">onlogin</span>=<span class="string">&quot;checkLoginState();&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">fb:login-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;status&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Load the JS SDK asynchronously --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">async</span> <span class="attr">defer</span> <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://connect.facebook.net/en_US/sdk.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>简易使用<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FaceBookSDK</span> &#123;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">appendJSscript</span>(<span class="params">attrs=[]</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,_</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">var</span> body = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;body&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">attrs.<span class="title function_">forEach</span>(<span class="function"><span class="params">i</span>=&gt;</span>&#123;script.<span class="title function_">setAttribute</span>(i.<span class="property">key</span>,i.<span class="property">value</span>)&#125;)</span><br><span class="line">body.<span class="title function_">appendChild</span>(script);</span><br><span class="line">script.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;<span class="title function_">resolve</span>()&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">async</span> <span class="title class_">FBLogin</span>(appId) &#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="keyword">await</span> <span class="title class_">FaceBookSDK</span>.<span class="title function_">appendJSscript</span>([</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;src&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;https://connect.facebook.net/en_US/sdk.js&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;type&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;text/javascript&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;crossorigin&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;anonymous&quot;</span>&#125;,</span><br><span class="line">])</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">fbAsyncInit</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable constant_">FB</span>.<span class="title function_">init</span>(&#123;appId,<span class="attr">cookie</span>:<span class="literal">true</span>,<span class="attr">xfbml</span>:<span class="literal">true</span>,<span class="attr">version</span>:<span class="string">&#x27;v14.0&#x27;</span>&#125;);</span><br><span class="line"><span class="variable constant_">FB</span>.<span class="title function_">getLoginStatus</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;</span><br><span class="line"><span class="variable constant_">FB</span>.<span class="title function_">login</span>(<span class="keyword">function</span>(<span class="params">a</span>) &#123;</span><br><span class="line"><span class="title function_">resolve</span>(a)</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="title class_">FaceBookSDK</span>.<span class="title class_">FBLogin</span>(<span class="string">&quot;*****&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">e</span>=&gt;</span>&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <summary type="html">&lt;h4 id=&quot;Google&quot;&gt;&lt;a href=&quot;#Google&quot; class=&quot;headerlink&quot; title=&quot;Google&quot;&gt;&lt;/a&gt;Google&lt;/h4&gt;&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;一定要使用最新的文档。&lt;a href=&quot;https://developers.google.com/identity/gsi/web/guides/migration&quot;&gt;https://developers.google.com/identity/gsi/web/guides/migration&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;控制台 &lt;a href=&quot;https://console.cloud.google.com/apis/dashboard?project=tabbyceshi&quot;&gt;https://console.cloud.google.com/apis/dashboard?project=tabbyceshi&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;应用 &lt;a href=&quot;https://console.cloud.google.com/apis/credentials?project=tabbyceshi&amp;amp;supportedpurview=project&quot;&gt;https://console.cloud.google.com/apis/credentials?project=tabbyceshi&amp;amp;supportedpurview=project&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="Google Sign" scheme="https://tabbycute.github.io/tags/Google-Sign/"/>
    
    <category term="Face Sign" scheme="https://tabbycute.github.io/tags/Face-Sign/"/>
    
  </entry>
  
  <entry>
    <title>flutter类中的构造函数</title>
    <link href="https://tabbycute.github.io/2021/12/09/20211219flutter%E7%B1%BB%E4%B8%AD%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/"/>
    <id>https://tabbycute.github.io/2021/12/09/20211219flutter%E7%B1%BB%E4%B8%AD%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/</id>
    <published>2021-12-08T16:00:00.000Z</published>
    <updated>2023-01-05T12:09:46.514Z</updated>
    
    <content type="html"><![CDATA[<h3 id="传统的构造函数"><a href="#传统的构造函数" class="headerlink" title="传统的构造函数"></a>传统的构造函数</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line"><span class="built_in">int</span> age = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> id = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">String?</span> name=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">Student(<span class="built_in">int</span> age, <span class="built_in">int</span> id) &#123;</span><br><span class="line"><span class="keyword">this</span>.age = age;</span><br><span class="line"><span class="keyword">this</span>.id = id;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="命名构造函数"><a href="#命名构造函数" class="headerlink" title="命名构造函数"></a>命名构造函数</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line"><span class="built_in">int?</span> age = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int?</span> id = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">String?</span> name=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">Student(<span class="keyword">this</span>.age, <span class="keyword">this</span>.id,);</span><br><span class="line"></span><br><span class="line">Student.fromJson(<span class="built_in">Map</span> data) &#123;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;命名构造函数&#x27;</span>);</span><br><span class="line"><span class="keyword">this</span>.name=data[<span class="string">&quot;name&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b=Student.fromJson(&#123;<span class="string">&quot;firstName&quot;</span>:<span class="string">&quot;AAAAA&quot;</span>&#125;);</span><br><span class="line"><span class="built_in">print</span>(b.firstName);<span class="comment">///<span class="language-markdown">AAAAA</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>Student.fromJson 不固定也可以叫Student.fromJson1，Student.fromJson2</p></blockquote><h3 id="继承构造函数的执行顺序"><a href="#继承构造函数的执行顺序" class="headerlink" title="继承构造函数的执行顺序"></a>继承构造函数的执行顺序</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String?</span> firstName;</span><br><span class="line">  Student()&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;in Student con&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Student.fromJson(<span class="built_in">Map</span> data) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;in Student&#x27;</span>);</span><br><span class="line">    <span class="keyword">this</span>.firstName=data[<span class="string">&quot;firstName&quot;</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jone</span> <span class="keyword">extends</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">   Jone()&#123;</span><br><span class="line">     <span class="built_in">print</span>(<span class="string">&#x27;in Jone con&#x27;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">  Jone.fromJson(<span class="built_in">Map</span> data) : <span class="keyword">super</span>.fromJson(data) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;in Jone&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b=Student.fromJson(&#123;<span class="string">&quot;firstName&quot;</span>:<span class="string">&quot;AAAAA&quot;</span>&#125;);</span><br><span class="line"><span class="built_in">print</span>(b.firstName);</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">in Student</span></span></span><br><span class="line"><span class="comment">///<span class="language-markdown">AAAAA</span></span></span><br></pre></td></tr></table></figure><ul><li>调用初始化列表（初始化列表就是在构造函数执行之前执行的代码，和调用父类的构造函数一样，也使用：操作符，如下所示：）<blockquote><p>下面：后面的赋值就是出初始化列表</p></blockquote><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Point.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">double</span>&gt; json)</span><br><span class="line">    : x = json[<span class="string">&#x27;x&#x27;</span>]!,</span><br><span class="line">      y = json[<span class="string">&#x27;y&#x27;</span>]! &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;In Point.fromJson(): (<span class="subst">$x</span>, <span class="subst">$y</span>)&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>调用父类的构造函数</li><li>调用自己的构造函数</li></ul><h3 id="重定向构造函数"><a href="#重定向构造函数" class="headerlink" title="重定向构造函数"></a>重定向构造函数</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">  <span class="built_in">double</span> x, y;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 主构造函数</span></span><br><span class="line">  Point(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 构造函数</span></span><br><span class="line">  Point.formJson(<span class="built_in">double</span> x)&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重定向到主构造函数</span></span><br><span class="line">  Point.alongXAxis(<span class="built_in">double</span> x) : <span class="keyword">this</span>(x, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 重定向到formJson构造函数</span></span><br><span class="line">  Point.alongXAxis2(<span class="built_in">double</span> x) : <span class="keyword">this</span>.formJson(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="工厂构造函数"><a href="#工厂构造函数" class="headerlink" title="工厂构造函数"></a>工厂构造函数</h3><p>默认情况下，dart类中的构造函数返回的是该类的<strong>新实例</strong>，但是我们在实际的应用中可能会对返回的对象做些选择，比如从缓存中返回已经存在的对象，或者返回该类具体的实现子类。为了实现这样的功能，dart中专门有一个Factory关键字，使用Factory的构造函数叫做工厂构造函数。</p><p>那么问题来了，factory构造函数和普通构造函数到底有什么区别呢?最大的区别就是普通构造函数是没有返回值的，而factory构造函数需要一个返回值。</p><blockquote><p>Map.putIfAbsent方法回顾，下面备用</p></blockquote><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Map</span> user = &#123; <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Tom&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b=user.putIfAbsent(<span class="string">&#x27;job&#x27;</span>, () =&gt; <span class="string">&#x27;engineer&#x27;</span>);</span><br><span class="line"><span class="built_in">print</span>(user);</span><br><span class="line"><span class="built_in">print</span>(b);</span><br><span class="line"></span><br><span class="line">b=user.putIfAbsent(<span class="string">&#x27;job&#x27;</span>, () =&gt; <span class="string">&#x27;engineer22222222222&#x27;</span>);</span><br><span class="line"><span class="built_in">print</span>(user);</span><br><span class="line"><span class="built_in">print</span>(b);</span><br><span class="line">  </span><br><span class="line"><span class="comment">//     &#123;name: Tom, age: 20, job: engineer&#125;</span></span><br><span class="line"><span class="comment">//     engineer</span></span><br><span class="line"><span class="comment">//     &#123;name: Tom, age: 20, job: engineer&#125;</span></span><br><span class="line"><span class="comment">//     engineer</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure><p>例子</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    Student stu0 = Student(<span class="string">&quot;dart0&quot;</span>,<span class="number">99</span>);</span><br><span class="line">    Student stu1 = Student(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    Student stu2 = Student(<span class="string">&quot;dart&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    Student stu3 = Student.fromJson(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dart&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">3</span>&#125;);</span><br><span class="line">    Student stu4 = Student.fromJson2(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dart&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">4</span>&#125;);</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>); </span><br><span class="line">    <span class="comment">// 使用 Student() 工厂构造函数 和 Student.fromJson(&#123;&#125;) 工厂构造函数创建出来的对象是同一个对象</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu0, stu1));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu1, stu2));  <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu2, stu3));  <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu3, stu4));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>);</span><br><span class="line">    <span class="built_in">print</span>(stu1.age);  <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">print</span>(stu2.age);  <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">print</span>(stu3.age);  <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">print</span>(stu4.age);  <span class="comment">// 10</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>);</span><br><span class="line"><span class="built_in">print</span>(stu0.hashCode);<span class="comment">///<span class="language-markdown">595483760</span></span></span><br><span class="line"><span class="built_in">print</span>(stu1.hashCode);<span class="comment">///<span class="language-markdown">959865253</span></span></span><br><span class="line"><span class="built_in">print</span>(stu2.hashCode);<span class="comment">///<span class="language-markdown">959865253</span></span></span><br><span class="line"><span class="built_in">print</span>(stu3.hashCode);<span class="comment">///<span class="language-markdown">959865253</span></span></span><br><span class="line"><span class="built_in">print</span>(stu4.hashCode);<span class="comment">///<span class="language-markdown">730863203</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="built_in">String?</span> name;</span><br><span class="line">    <span class="built_in">int</span> age=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> _cache = &lt;<span class="built_in">String</span>, Student&gt;&#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> test = &lt;<span class="built_in">int</span>&gt;[];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 工厂构造函数</span></span><br><span class="line">    <span class="keyword">factory</span> Student(<span class="built_in">String</span> name,<span class="built_in">int</span> age) &#123;</span><br><span class="line">        test.add(age);</span><br><span class="line">        <span class="built_in">print</span>(test);</span><br><span class="line">        Student s =_cache.putIfAbsent(name, () =&gt; Student.useForFactory(name,age));</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 工厂构造函数</span></span><br><span class="line">    <span class="keyword">factory</span> Student.fromJson(<span class="built_in">Map</span> json) &#123;</span><br><span class="line">        <span class="keyword">return</span> Student(json[<span class="string">&#x27;name&#x27;</span>],json[<span class="string">&#x27;age&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 命名构造函数</span></span><br><span class="line">    Student.fromJson2(<span class="built_in">Map</span> json):name=json[<span class="string">&quot;json&quot;</span>],age=<span class="number">10</span>;</span><br><span class="line">  </span><br><span class="line">    Student.useForFactory(<span class="keyword">this</span>.name,<span class="keyword">this</span>.age);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如上的例子<strong>伪解释</strong>一下</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">先声明一下，比如我们声明了一个Student类，<span class="keyword">static</span> <span class="keyword">final</span> _cache 我们需要把他解读成一个全局单独的变量(或者说应用的一块单独内存)，上面特地加了<span class="keyword">static</span> <span class="keyword">final</span> test = &lt;<span class="built_in">int</span>&gt;[] 更加清晰明了。</span><br><span class="line"></span><br><span class="line">Student(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>) 向全局单独的变量_cache存入了一个键值对 &#123; <span class="string">&quot;dart&quot;</span> ：Student.useForFactory(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>)&#125;</span><br><span class="line"></span><br><span class="line">Student(<span class="string">&quot;dart&quot;</span>,<span class="number">2</span>) 则 不会！！！继续向全局单独的变量_cache存入了一个键值对，因为_cache中的键 <span class="string">&quot;dart&quot;</span> 已经存在了，所以他会直接返回Student.useForFactory(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>)，这里使用的是<span class="built_in">Map</span>.putIfAbsent实现。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> 反例</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    Student stu1 = Student(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    Student stu2 = Student(<span class="string">&quot;dart&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    Student stu3 = Student.fromJson(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dart&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">3</span>&#125;);</span><br><span class="line">    Student stu4 = Student.fromJson2(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dart&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">4</span>&#125;);</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>); </span><br><span class="line">    <span class="comment">// 使用 Student() 工厂构造函数 和 Student.fromJson(&#123;&#125;) 工厂构造函数创建出来的对象是同一个对象</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu1, stu2));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu2, stu3));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu3, stu4));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>);</span><br><span class="line">    <span class="built_in">print</span>(stu1.age);  <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">print</span>(stu2.age);  <span class="comment">// 2</span></span><br><span class="line">    <span class="built_in">print</span>(stu3.age);  <span class="comment">// 3</span></span><br><span class="line">    <span class="built_in">print</span>(stu4.age);  <span class="comment">// 10</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="built_in">String?</span> name;</span><br><span class="line">    <span class="built_in">int</span> age=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> _cache = &lt;<span class="built_in">String</span>, Student&gt;&#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 工厂构造函数</span></span><br><span class="line">    <span class="keyword">factory</span> Student(<span class="built_in">String</span> name,<span class="built_in">int</span> age) &#123;</span><br><span class="line">        <span class="keyword">return</span> Student.useForFactory(name,age);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 工厂构造函数</span></span><br><span class="line">    <span class="keyword">factory</span> Student.fromJson(<span class="built_in">Map</span> json) &#123;</span><br><span class="line">        <span class="keyword">return</span> Student(json[<span class="string">&#x27;name&#x27;</span>],json[<span class="string">&#x27;age&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 命名构造函数</span></span><br><span class="line">    Student.fromJson2(<span class="built_in">Map</span> json):name=json[<span class="string">&quot;json&quot;</span>],age=<span class="number">10</span>;</span><br><span class="line">  </span><br><span class="line">    Student.useForFactory(<span class="keyword">this</span>.name,<span class="keyword">this</span>.age);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>当然工厂构造函数也能实现单例</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> Singleton _singleton = Singleton.internal();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> Singleton() =&gt; _singleton;</span><br><span class="line"></span><br><span class="line">  Singleton.internal();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Singleton s1=Singleton();</span><br><span class="line">Singleton s2=Singleton();</span><br><span class="line"><span class="built_in">print</span>(identical(s1, s2));<span class="comment">///<span class="language-markdown">true</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>注意，dart中只能有一个未命名的构造函数，对应命名函数来说，名字不能够重复，否则会报The default constructor is already defined异常。所以如果你再给Student加一个未命名构造函数：Student(this.name)因为已经有了 factory Student(String name)</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;传统的构造函数&quot;&gt;&lt;a href=&quot;#传统的构造函数&quot; class=&quot;headerlink&quot; title=&quot;传统的构造函数&quot;&gt;&lt;/a&gt;传统的构造函数&lt;/h3&gt;&lt;figure class=&quot;highlight dart&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Student&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt; age = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt; id = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;built_in&quot;&gt;String?&lt;/span&gt; name=&lt;span class=&quot;string&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Student(&lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt; age, &lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt; id) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.age = age;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.id = id;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;命名构造函数&quot;&gt;&lt;a href=&quot;#命名构造函数&quot; class=&quot;headerlink&quot; title=&quot;命名构造函数&quot;&gt;&lt;/a&gt;命名构造函数&lt;/h3&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
  <entry>
    <title>浏览器的文件加密解密</title>
    <link href="https://tabbycute.github.io/2021/10/02/20211024%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86/"/>
    <id>https://tabbycute.github.io/2021/10/02/20211024%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86/</id>
    <published>2021-10-01T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.045Z</updated>
    
    <content type="html"><![CDATA[<p>对文件加/解密路线</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file -&gt; buffer -&gt; uint8list -&gt; wordArray(crypto-js辅助类型) -&gt; 加/解密后的wordArray -&gt; uint8list</span><br></pre></td></tr></table></figure><p>可以根据业务需求uint8list 转 buffer 或者 blob等</p><p>demo</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        *&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">40px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">button</span>&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: block;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">300px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">120px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;inp&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;encFn()&quot;</span>&gt;</span>加解密字符串<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;decFn()&quot;</span>&gt;</span>加解密文件<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;img&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;crypto-js/crypto-js.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript"><span class="keyword">class</span> <span class="title class_">CryptoJSTB</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    iv=<span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    key=<span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    mode= <span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">    padding=<span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">static</span> <span class="title function_">fromJson</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> intance = <span class="keyword">new</span> <span class="title class_">CryptoJSTB</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> &#123;iv,key,mode,padding&#125; = opt</span></span><br><span class="line"><span class="language-javascript">        intance.<span class="property">iv</span>=iv;</span></span><br><span class="line"><span class="language-javascript">        intance.<span class="property">key</span>=key;</span></span><br><span class="line"><span class="language-javascript">        intance.<span class="property">mode</span>=mode||<span class="title class_">CryptoJS</span>.<span class="property">mode</span>.<span class="property">CBC</span>;</span></span><br><span class="line"><span class="language-javascript">        intance.<span class="property">padding</span>=padding||<span class="title class_">CryptoJS</span>.<span class="property">pad</span>.<span class="property">Pkcs7</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> intance</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///加密字符串</span></span></span><br><span class="line"><span class="language-javascript">    encStrAES (plainText) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> options = &#123;<span class="attr">iv</span>:<span class="variable language_">this</span>.<span class="property">iv</span>,<span class="attr">mode</span>:<span class="variable language_">this</span>.<span class="property">mode</span>,<span class="attr">padding</span>:<span class="variable language_">this</span>.<span class="property">padding</span>&#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> words = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(plainText)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> encrypted = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">encrypt</span>(words,<span class="variable language_">this</span>.<span class="property">key</span>,options)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Base64</span>.<span class="title function_">stringify</span>(encrypted.<span class="property">ciphertext</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///解密字符串</span></span></span><br><span class="line"><span class="language-javascript">    decStrAES (plainText) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> options = &#123;<span class="attr">iv</span>:<span class="variable language_">this</span>.<span class="property">iv</span>,<span class="attr">mode</span>:<span class="variable language_">this</span>.<span class="property">mode</span>,<span class="attr">padding</span>:<span class="variable language_">this</span>.<span class="property">padding</span>&#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">///加密的时候导出的base64，这里也用base64解析</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> base64 = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Base64</span>.<span class="title function_">parse</span>(plainText)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> src = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Base64</span>.<span class="title function_">stringify</span>(base64)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> decrypt = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(src, <span class="variable language_">this</span>.<span class="property">key</span>, options)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> decryptedStr = decrypt.<span class="title function_">toString</span>(<span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> decryptedStr.<span class="title function_">toString</span>()</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///加密字节</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">encByteAES</span>(<span class="params">plainText</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> wordArray = <span class="variable language_">this</span>.<span class="title class_">Uint8ToW</span>(plainText);   <span class="comment">// Uint8Array-&gt;WordArray</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> options = &#123;<span class="attr">iv</span>:<span class="variable language_">this</span>.<span class="property">iv</span>,<span class="attr">mode</span>:<span class="variable language_">this</span>.<span class="property">mode</span>,<span class="attr">padding</span>:<span class="variable language_">this</span>.<span class="property">padding</span>&#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> res = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">encrypt</span>(wordArray, <span class="variable language_">this</span>.<span class="property">key</span>,options).<span class="property">ciphertext</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title class_">WToUint8</span>(res)                   <span class="comment">// WordArray-&gt;Uint8Array</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///解密字节</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">decByteAES</span>(<span class="params">plainText</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> wordArray = <span class="variable language_">this</span>.<span class="title class_">Uint8ToW</span>(plainText);   <span class="comment">// Uint8Array-&gt;WordArray</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> options = &#123;<span class="attr">iv</span>:<span class="variable language_">this</span>.<span class="property">iv</span>,<span class="attr">mode</span>:<span class="variable language_">this</span>.<span class="property">mode</span>,<span class="attr">padding</span>:<span class="variable language_">this</span>.<span class="property">padding</span>&#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> content = <span class="title class_">CryptoJS</span>.<span class="property">lib</span>.<span class="property">CipherParams</span>.<span class="title function_">create</span>(&#123;<span class="attr">ciphertext</span>:wordArray&#125;)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> res = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(content, <span class="variable language_">this</span>.<span class="property">key</span>,options)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title class_">WToUint8</span>(res)                   <span class="comment">// WordArray-&gt;Uint8Array</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//类型转换</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//Uint8Array -&gt; wordArray</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">Uint8ToW</span>(u8) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> len = u8.<span class="property">length</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> words= [];</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i += <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            words[i &gt;&gt;&gt; <span class="number">2</span>] |= (u8[i] &amp; <span class="number">0xff</span>) &lt;&lt; (<span class="number">24</span> - (i % <span class="number">4</span>) * <span class="number">8</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> res = <span class="title class_">CryptoJS</span>.<span class="property">lib</span>.<span class="property">WordArray</span>.<span class="title function_">create</span>(words, len);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> res;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//wordArray -&gt; Uint8Array</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">WToUint8</span>(wordArray)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> &#123; words &#125; = wordArray;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> &#123; sigBytes &#125; = wordArray;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> u8 = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(sigBytes);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; sigBytes; i += <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> byte = (words[i &gt;&gt;&gt; <span class="number">2</span>] &gt;&gt;&gt; (<span class="number">24</span> - (i % <span class="number">4</span>) * <span class="number">8</span>)) &amp; <span class="number">0xff</span>;</span></span><br><span class="line"><span class="language-javascript">            u8[i] = byte;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> u8;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///文件转u8</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">static</span> <span class="title function_">fileToUint8</span>(<span class="params">file</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span></span><br><span class="line"><span class="language-javascript">            reader.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;<span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(e.<span class="property">target</span>.<span class="property">result</span>))&#125;</span></span><br><span class="line"><span class="language-javascript">            reader.<span class="title function_">readAsArrayBuffer</span>(file);</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///文件保存</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">static</span> <span class="title function_">saveFile</span>(<span class="params">uint8List,fileName</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> blob=<span class="keyword">new</span> <span class="title class_">Blob</span>([uint8List]);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;a&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        link.<span class="property">href</span> = <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span></span><br><span class="line"><span class="language-javascript">        link.<span class="property">download</span> = fileName;</span></span><br><span class="line"><span class="language-javascript">        link.<span class="title function_">click</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">revokeObjectURL</span>(link.<span class="property">href</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">///实例化</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> keyStr=<span class="string">&quot;abcdabcdabcdabcd&quot;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> content=<span class="string">&quot;123456789aaaa啊我的哇打多阿瓦达&quot;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> c=<span class="title class_">CryptoJSTB</span>.<span class="title function_">fromJson</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">key</span>: <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(keyStr),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">iv</span>: <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(keyStr),</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">///字符串加解密测试</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">encFn</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> encStr=c.<span class="title function_">encStrAES</span>(content)</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(encStr)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> decStr=c.<span class="title function_">decStrAES</span>(encStr)</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(decStr)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">///文件加解密测试，！！！！！！！！！请先选择文件！！！！！！测试用的是图片，方便查看</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">decFn</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///先将文件读取为字节</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> file = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#inp&quot;</span>).<span class="property">files</span>[<span class="number">0</span>]</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///加解密测试</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">CryptoJSTB</span>.<span class="title function_">fileToUint8</span>(file).<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(result)</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">///加密</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> encByte=c.<span class="title function_">encByteAES</span>(result)</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(encByte)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> decByte=c.<span class="title function_">decByteAES</span>(encByte)</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(decByte)</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">showImg</span>(decByte)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">showImg</span>(<span class="params">u8</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> blob=<span class="keyword">new</span> <span class="title class_">Blob</span>([u8]);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> src =  <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> img=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#img&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">    img.<span class="property">src</span> = src</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;对文件加/解密路线&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;file -&amp;gt; buffer -&amp;gt; uint8list -&amp;gt; wordArray(crypto-js辅助类型) -&amp;gt; 加/解密后的wordArray -&amp;gt; uint8list&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可以根据业务需求uint8list 转 buffer 或者 blob等&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="cryptojs" scheme="https://tabbycute.github.io/tags/cryptojs/"/>
    
  </entry>
  
  <entry>
    <title>win下WebAssembly环境安装和尝试(Golang)</title>
    <link href="https://tabbycute.github.io/2021/10/02/20211111win%E4%B8%8BWebAssembly%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E5%92%8C%E5%B0%9D%E8%AF%95/"/>
    <id>https://tabbycute.github.io/2021/10/02/20211111win%E4%B8%8BWebAssembly%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E5%92%8C%E5%B0%9D%E8%AF%95/</id>
    <published>2021-10-01T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.045Z</updated>
    
    <content type="html"><![CDATA[<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><ul><li>安装 Git。</li><li>安装cmake。<a href="https://cmake.org/download/">https://cmake.org/download/</a></li><li>安装vs。<a href="https://visualstudio.microsoft.com/zh-hans/downloads/">https://visualstudio.microsoft.com/zh-hans/downloads/</a></li><li>Python 2.7.x，在 Linux 和 OS X上，很可能已经装好了。<a href="https://www.python.org/downloads/release/python-2716/">https://www.python.org/downloads/release/python-2716/</a> 下载Windows x86-64 MSI installer for AMD64/EM64T/x64   python -V<h4 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/juj/emsdk.git</span><br><span class="line">//如果速度很慢可以直接去git下载代码</span><br></pre></td></tr></table></figure><h4 id="安装各种工具"><a href="#安装各种工具" class="headerlink" title="安装各种工具"></a>安装各种工具</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ./emsdk</span><br><span class="line">emsdk install latest</span><br></pre></td></tr></table></figure><h4 id="生成-emscripten-文件，激活配置"><a href="#生成-emscripten-文件，激活配置" class="headerlink" title="生成 ~/.emscripten 文件，激活配置"></a>生成 ~/.emscripten 文件，激活配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emsdk activate latest</span><br></pre></td></tr></table></figure><blockquote><p>双击emsdk目录下的emsdk_env.bat文件配置环境变量</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">这里可能会报错</span><br><span class="line">The changes made to environment variables only apply to the currently running shell instance. Use the &#x27;emsdk_env.bat&#x27; to re-enter this environment later, or if you&#x27;d like to permanently register this environment permanently, rerun this command with the option --permanent.</span><br><span class="line">&#x27;xftp&#x27; 不是内部或.............，也不是可运行的程序...........</span><br><span class="line"></span><br><span class="line">解决</span><br><span class="line">先查看pyhon的是否在全局可用</span><br><span class="line"></span><br><span class="line">然后在按照上面的运行</span><br><span class="line"></span><br><span class="line">emsdk_env.bat --permanent</span><br></pre></td></tr></table></figure><h4 id="查看是否已经安装完成"><a href="#查看是否已经安装完成" class="headerlink" title="查看是否已经安装完成"></a>查看是否已经安装完成</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emcc -v</span><br></pre></td></tr></table></figure><h4 id="查看全局是否可用，如果不能用单独设置环境变量。"><a href="#查看全局是否可用，如果不能用单独设置环境变量。" class="headerlink" title="查看全局是否可用，如果不能用单独设置环境变量。"></a>查看全局是否可用，如果不能用单独设置环境变量。</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 具体的变量的按照自己的目录来</span><br><span class="line"># 单独设置的环境变量，我这里是windows环境</span><br><span class="line">EMSDK=D:\workspace\emsdk\emsdk</span><br><span class="line">EMSDK_NODE=%EMSDK%\node\14.15.5_64bit\bin\node.exe</span><br><span class="line">EMSDK_PYTHON=%EMSDK%\python\3.9.2-1_64bit\python.exe</span><br><span class="line"></span><br><span class="line"># PATH中也要添加环境变量</span><br><span class="line">%EMSDK%</span><br><span class="line">%EMSDK%\upstream\emscripten</span><br><span class="line">%EMSDK%\node\14.15.5_64bit\bin</span><br></pre></td></tr></table></figure><h4 id="编译第一个wasm文件"><a href="#编译第一个wasm文件" class="headerlink" title="编译第一个wasm文件"></a>编译第一个wasm文件</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;emscripten/emscripten.h&gt;</span></span></span><br><span class="line"><span class="comment">// 一旦WASM模块被加载，main()中的代码就会执行</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;WebAssembly 的环境已经搭好了\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 返回1-6之间的一随机数</span></span><br><span class="line"><span class="type">int</span> EMSCRIPTEN_KEEPALIVE <span class="title function_">roll_dice</span><span class="params">()</span> &#123;</span><br><span class="line">    srand ( time(<span class="literal">NULL</span>) );</span><br><span class="line">    <span class="keyword">return</span> rand() % <span class="number">6</span> + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">然后用命令行工具定位到这个文件夹，执行：</span><br><span class="line">emcc index.c -s WASM=<span class="number">1</span> -O3 -o index.js</span><br><span class="line"></span><br><span class="line">等待片刻之后，你就能够看见生成了两个新文件：</span><br><span class="line">index.js</span><br><span class="line">index.wasm</span><br><span class="line"></span><br><span class="line">你可以用html引入这个index.js试试（index.wasm必须和index.js在同一路径下）</span><br><span class="line">vscode 使用 open with live server</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>WebAssembly 支持不仅限于 C、C++和 Rust。许多开发人员也在努力纳入对其他语言的支持。以下是当前支持的语言列表。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">C/C++</span><br><span class="line">Rust</span><br><span class="line">AssemblyScript（类似 TypeScript 的语法）</span><br><span class="line">C#</span><br><span class="line">F#</span><br><span class="line">Go</span><br><span class="line">Kotlin</span><br><span class="line">Swift</span><br><span class="line">D</span><br><span class="line">Pascal</span><br><span class="line">Zig</span><br></pre></td></tr></table></figure>Golang-webassembly编译及其错误解决<blockquote><p>出现”syscall/js”引入报错的时候（Build constraints exclude all the Go files in ‘E:/GoSdk/go1.18.1/src/syscall/js’），如下方式即可解决。详情参考：<a href="https://www.jetbrains.com/help/go/webassembly-project.html%E3%80%82">https://www.jetbrains.com/help/go/webassembly-project.html。</a></p></blockquote></li></ul><p><img src="/assets/img/202111111.png"><br><img src="/assets/img/202111112.png"></p><p>使用</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;syscall/js&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fibFunc</span><span class="params">(this js.Value, args []js.Value)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;我是Golang中的的方法&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">0</span>)</span><br><span class="line">   js.Global().Set(<span class="string">&quot;fibFunc&quot;</span>, js.FuncOf(fibFunc))</span><br><span class="line">   &lt;-done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行需要引入特定的js依赖。</p><blockquote><p>wasm_exec.js文件是框架自带的js驱动wasm(golang)的引擎<br>wasm_exec.html是自带的一个测试demo<br>别删了~~~</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E:\GoSdk\go1<span class="number">.18</span><span class="number">.1</span>\misc\wasm\wasm_exec.js</span><br><span class="line">E:\GoSdk\go1<span class="number">.18</span><span class="number">.1</span>\misc\wasm\wasm_exec.html   <span class="comment">//一个运行实例</span></span><br></pre></td></tr></table></figure><p>运行demo</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">目录结构</span><br><span class="line">/wasm_exec.js</span><br><span class="line">/wasm_exec.html</span><br><span class="line">/test.wasm</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">Copyright 2018 The Go Authors. All rights reserved.</span></span><br><span class="line"><span class="comment">Use of this source code is governed by a BSD-style</span></span><br><span class="line"><span class="comment">license that can be found in the LICENSE file.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Go wasm<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;wasm_exec.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">fibFunc</span>())&#125;,<span class="number">5000</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//这里是判断是否允许加载 wasm 文件的 JavaScript API</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (!<span class="title class_">WebAssembly</span>.<span class="property">instantiateStreaming</span>) &#123; <span class="comment">// polyfill</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title class_">WebAssembly</span>.<span class="property">instantiateStreaming</span> = <span class="keyword">async</span> (resp, importObject) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> source = <span class="keyword">await</span> (<span class="keyword">await</span> resp).<span class="title function_">arrayBuffer</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(source, importObject);</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> go = <span class="keyword">new</span> <span class="title class_">Go</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> mod, inst;</span></span><br><span class="line"><span class="language-javascript">        <span class="title class_">WebAssembly</span>.<span class="title function_">instantiateStreaming</span>(<span class="title function_">fetch</span>(<span class="string">&quot;test.wasm&quot;</span>), go.<span class="property">importObject</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            mod = result.<span class="property">module</span>;</span></span><br><span class="line"><span class="language-javascript">            inst = result.<span class="property">instance</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;runButton&quot;</span>).<span class="property">disabled</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">run</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">clear</span>();</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">await</span> go.<span class="title function_">run</span>(inst);</span></span><br><span class="line"><span class="language-javascript">            inst = <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(mod, go.<span class="property">importObject</span>); <span class="comment">// reset instance</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//代码是不会走到这里来的因为go main中阻塞了。</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&quot;run();&quot;</span> <span class="attr">id</span>=<span class="string">&quot;runButton&quot;</span> <span class="attr">style</span>=<span class="string">&quot;font-size: 100px;&quot;</span>&gt;</span>Run<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//Console</span><br><span class="line"></span><br><span class="line">Console was cleared</span><br><span class="line">我是Golang中的的方法</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h4 id=&quot;准备工作&quot;&gt;&lt;a href=&quot;#准备工作&quot; class=&quot;headerlink&quot; title=&quot;准备工作&quot;&gt;&lt;/a&gt;准备工作&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;安装 Git。&lt;/li&gt;
&lt;li&gt;安装cmake。&lt;a href=&quot;https://cmake.org/download/&quot;&gt;https://cmake.org/download/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;安装vs。&lt;a href=&quot;https://visualstudio.microsoft.com/zh-hans/downloads/&quot;&gt;https://visualstudio.microsoft.com/zh-hans/downloads/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Python 2.7.x，在 Linux 和 OS X上，很可能已经装好了。&lt;a href=&quot;https://www.python.org/downloads/release/python-2716/&quot;&gt;https://www.python.org/downloads/release/python-2716/&lt;/a&gt; 下载Windows x86-64 MSI installer for AMD64/EM64T/x64   python -V&lt;h4 id=&quot;安装环境&quot;&gt;&lt;a href=&quot;#安装环境&quot; class=&quot;headerlink&quot; title=&quot;安装环境&quot;&gt;&lt;/a&gt;安装环境&lt;/h4&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git clone https://github.com/juj/emsdk.git&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;//如果速度很慢可以直接去git下载代码&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;安装各种工具&quot;&gt;&lt;a href=&quot;#安装各种工具&quot; class=&quot;headerlink&quot; title=&quot;安装各种工具&quot;&gt;&lt;/a&gt;安装各种工具&lt;/h4&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cd ./emsdk&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;emsdk install latest&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;生成-emscripten-文件，激活配置&quot;&gt;&lt;a href=&quot;#生成-emscripten-文件，激活配置&quot; class=&quot;headerlink&quot; title=&quot;生成 ~/.emscripten 文件，激活配置&quot;&gt;&lt;/a&gt;生成 ~/.emscripten 文件，激活配置&lt;/h4&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;emsdk activate latest&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;双击emsdk目录下的emsdk_env.bat文件配置环境变量&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;这里可能会报错&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;The changes made to environment variables only apply to the currently running shell instance. Use the &amp;#x27;emsdk_env.bat&amp;#x27; to re-enter this environment later, or if you&amp;#x27;d like to permanently register this environment permanently, rerun this command with the option --permanent.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#x27;xftp&amp;#x27; 不是内部或.............，也不是可运行的程序...........&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;解决&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;先查看pyhon的是否在全局可用&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;然后在按照上面的运行&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;emsdk_env.bat --permanent&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;查看是否已经安装完成&quot;&gt;&lt;a href=&quot;#查看是否已经安装完成&quot; class=&quot;headerlink&quot; title=&quot;查看是否已经安装完成&quot;&gt;&lt;/a&gt;查看是否已经安装完成&lt;/h4&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;emcc -v&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;查看全局是否可用，如果不能用单独设置环境变量。&quot;&gt;&lt;a href=&quot;#查看全局是否可用，如果不能用单独设置环境变量。&quot; class=&quot;headerlink&quot; title=&quot;查看全局是否可用，如果不能用单独设置环境变量。&quot;&gt;&lt;/a&gt;查看全局是否可用，如果不能用单独设置环境变量。&lt;/h4&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# 具体的变量的按照自己的目录来&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 单独设置的环境变量，我这里是windows环境&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EMSDK=D:\workspace\emsdk\emsdk&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EMSDK_NODE=%EMSDK%\node\14.15.5_64bit\bin\node.exe&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EMSDK_PYTHON=%EMSDK%\python\3.9.2-1_64bit\python.exe&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# PATH中也要添加环境变量&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;%EMSDK%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;%EMSDK%\upstream\emscripten&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;%EMSDK%\node\14.15.5_64bit\bin&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;编译第一个wasm文件&quot;&gt;&lt;a href=&quot;#编译第一个wasm文件&quot; class=&quot;headerlink&quot; title=&quot;编译第一个wasm文件&quot;&gt;&lt;/a&gt;编译第一个wasm文件&lt;/h4&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;time.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;emscripten/emscripten.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 一旦WASM模块被加载，main()中的代码就会执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; argc, &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; ** argv)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;WebAssembly 的环境已经搭好了\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 返回1-6之间的一随机数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; EMSCRIPTEN_KEEPALIVE &lt;span class=&quot;title function_&quot;&gt;roll_dice&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    srand ( time(&lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; rand() % &lt;span class=&quot;number&quot;&gt;6&lt;/span&gt; + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;然后用命令行工具定位到这个文件夹，执行：&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;emcc index.c -s WASM=&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; -O3 -o index.js&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;等待片刻之后，你就能够看见生成了两个新文件：&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;index.js&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;index.wasm&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;你可以用html引入这个index.js试试（index.wasm必须和index.js在同一路径下）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vscode 使用 open with live server&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;WebAssembly 支持不仅限于 C、C++和 Rust。许多开发人员也在努力纳入对其他语言的支持。以下是当前支持的语言列表。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;C/C++&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Rust&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;AssemblyScript（类似 TypeScript 的语法）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;C#&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;F#&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Go&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Kotlin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Swift&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;D&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Pascal&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Zig&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
Golang-webassembly编译及其错误解决&lt;blockquote&gt;
&lt;p&gt;出现”syscall/js”引入报错的时候（Build constraints exclude all the Go files in ‘E:/GoSdk/go1.18.1/src/syscall/js’），如下方式即可解决。详情参考：&lt;a href=&quot;https://www.jetbrains.com/help/go/webassembly-project.html%E3%80%82&quot;&gt;https://www.jetbrains.com/help/go/webassembly-project.html。&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/assets/img/202111111.png&quot;&gt;&lt;br&gt;&lt;img src=&quot;/assets/img/202111112.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="golang" scheme="https://tabbycute.github.io/tags/golang/"/>
    
    <category term="webAssembly" scheme="https://tabbycute.github.io/tags/webAssembly/"/>
    
  </entry>
  
  <entry>
    <title>Mac M1 flutter环境从装机到真机保姆级教程</title>
    <link href="https://tabbycute.github.io/2021/10/02/20220625M1%E6%90%AD%E5%BB%BAflutter%E7%8E%AF%E5%A2%83/"/>
    <id>https://tabbycute.github.io/2021/10/02/20220625M1%E6%90%AD%E5%BB%BAflutter%E7%8E%AF%E5%A2%83/</id>
    <published>2021-10-01T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.048Z</updated>
    
    <content type="html"><![CDATA[<h2 id="flutter环境的安装"><a href="#flutter环境的安装" class="headerlink" title="flutter环境的安装"></a>flutter环境的安装</h2><h3 id="安装Android-Studio"><a href="#安装Android-Studio" class="headerlink" title="安装Android Studio"></a>安装Android Studio</h3><p>这个没什么好说的傻瓜式安装，需要注意的是Mac的可能会选择多个版本，M1一定要选<strong>arm</strong>架构的，这个很重要。</p><p>确保能运行一个空白的项目起来。</p><h3 id="安装Flutter"><a href="#安装Flutter" class="headerlink" title="安装Flutter"></a>安装Flutter</h3><p>下载flutterSDK。M1一定要选择<strong>arm64</strong>的版本sdk！！！</p><blockquote><p>(<a href="https://docs.flutter.dev/development/tools/sdk/releases?tab=macos#macos">https://docs.flutter.dev/development/tools/sdk/releases?tab=macos#macos</a>)</p></blockquote><p>解压到某个目录，我这里解压的目录是</p><blockquote><p>/Users/bz/FlutterSDK</p></blockquote><p>导出环境变量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PUB_HOSTED_URL=https://pub.flutter-io.cn</span><br><span class="line"><span class="built_in">export</span> FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn</span><br><span class="line">// 上面两个为国内镜像，下面为sdk的环境变量</span><br><span class="line"><span class="built_in">export</span> PATH=/Users/bz/FlutterSDK/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><h3 id="解决重启电脑命令失效"><a href="#解决重启电脑命令失效" class="headerlink" title="解决重启电脑命令失效"></a>解决重启电脑命令失效</h3><p>完成了上面的步骤，现在在命令行运行flutter doctor应该是可以的。但是有个问题，当你重启电脑再次到命令行里面运行flutter doctor会提示命令不存在。</p><ul><li>向 ~/.bash_profile文件中添加（如果不存在就先创建）<blockquote><p>下面的 export PATH=/Users/bz/FlutterSDK/bin:$PATH 取决于你上面安装sdk的位置</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo vi ~/.bash_profile</span><br><span class="line">//添加如下</span><br><span class="line"><span class="built_in">export</span> PUB_HOSTED_URL=https://pub.flutter-io.cn</span><br><span class="line"><span class="built_in">export</span> FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn</span><br><span class="line"><span class="built_in">export</span> PATH=/Users/bz/FlutterSDK/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure></li><li>刷新此文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure></li><li>执行flutter doctor。</li></ul><blockquote><p>现在是每次开机都需要执行source ~/.bash_profile才能正常使用bash_profile里的命令</p></blockquote><ul><li>在~/.zshrc（如果没有就添加）添加 source ~/.bash_profile<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.zshrc</span><br><span class="line">//添加如下</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure></li></ul><h2 id="安装homebrew"><a href="#安装homebrew" class="headerlink" title="安装homebrew"></a>安装homebrew</h2><h3 id="下载homebrew仓库"><a href="#下载homebrew仓库" class="headerlink" title="下载homebrew仓库"></a>下载homebrew仓库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /opt/Homebrew</span><br><span class="line">sudo git <span class="built_in">clone</span> https://mirrors.ustc.edu.cn/brew.git /opt/Homebrew</span><br></pre></td></tr></table></figure><h3 id="下载homebrew-core仓库"><a href="#下载homebrew-core仓库" class="headerlink" title="下载homebrew-core仓库"></a>下载homebrew-core仓库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /opt/Homebrew/Library/Taps/homebrew/homebrew-core</span><br><span class="line">sudo git <span class="built_in">clone</span> https://mirrors.ustc.edu.cn/homebrew-core.git /opt/Homebrew/Library/Taps/homebrew/homebrew-core</span><br></pre></td></tr></table></figure><h3 id="只将可执行文件放在PATH搜索路径中"><a href="#只将可执行文件放在PATH搜索路径中" class="headerlink" title="只将可执行文件放在PATH搜索路径中"></a>只将可执行文件放在PATH搜索路径中</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /opt/bin</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/opt/bin</span><br><span class="line">sudo <span class="built_in">ln</span> -s /opt/Homebrew/bin/brew /opt/bin/brew</span><br></pre></td></tr></table></figure><h3 id="var目录下存放锁"><a href="#var目录下存放锁" class="headerlink" title="var目录下存放锁"></a>var目录下存放锁</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /opt/var/Homebrew</span><br><span class="line"></span><br><span class="line">//该目录存放可能的配置文件，无则创建</span><br><span class="line">sudo <span class="built_in">mkdir</span> /opt/etc</span><br></pre></td></tr></table></figure><h3 id="改变目录权限"><a href="#改变目录权限" class="headerlink" title="改变目录权限"></a>改变目录权限</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> -R $(<span class="built_in">whoami</span>) /opt/Homebrew</span><br><span class="line">sudo <span class="built_in">chown</span> -R $(<span class="built_in">whoami</span>) /opt/etc</span><br></pre></td></tr></table></figure><h3 id="验证是否安装成功"><a href="#验证是否安装成功" class="headerlink" title="验证是否安装成功"></a>验证是否安装成功</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew update</span><br></pre></td></tr></table></figure><p>如果提示命令不存在，就在~/.bash_profile中添加，完了记得。source ~/.bash_profile</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/opt/Homebrew/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><blockquote><p>此路径取决于你安装的位置。/opt/Homebrew/bin目录下有个brew可执行文件，可以先执行./brew v 检查是否有问题，添加好了过后就执行</p></blockquote><h2 id="安装cocoapods"><a href="#安装cocoapods" class="headerlink" title="安装cocoapods"></a>安装cocoapods</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">brew install cocoapods</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://mirrors.tuna.tsinghua.edu.cn/git/CocoaPods/Specs.git ~/.cocoapods/repos/master</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>进入flutter项目的ios中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod install</span><br></pre></td></tr></table></figure><blockquote><p>中途拉库的时候可能会失败，然后重复拉<br>有可能会报错提示pod repo update，直接执行pod repo update就ok<br>老项目记得删除 Podfile.lock .</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;flutter环境的安装&quot;&gt;&lt;a href=&quot;#flutter环境的安装&quot; class=&quot;headerlink&quot; title=&quot;flutter环境的安装&quot;&gt;&lt;/a&gt;flutter环境的安装&lt;/h2&gt;&lt;h3 id=&quot;安装Android-Studio&quot;&gt;&lt;a href=&quot;#安装Android-Studio&quot; class=&quot;headerlink&quot; title=&quot;安装Android Studio&quot;&gt;&lt;/a&gt;安装Android Studio&lt;/h3&gt;&lt;p&gt;这个没什么好说的傻瓜式安装，需要注意的是Mac的可能会选择多个版本，M1一定要选&lt;strong&gt;arm&lt;/strong&gt;架构的，这个很重要。&lt;/p&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
  <entry>
    <title>在vue3中pinia页面刷新数据丢失的解决办法</title>
    <link href="https://tabbycute.github.io/2021/09/20/20210920%E5%9C%A8vue3%E4%B8%ADpinia%E9%A1%B5%E9%9D%A2%E5%88%B7%E6%96%B0%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/"/>
    <id>https://tabbycute.github.io/2021/09/20/20210920%E5%9C%A8vue3%E4%B8%ADpinia%E9%A1%B5%E9%9D%A2%E5%88%B7%E6%96%B0%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/</id>
    <published>2021-09-19T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.045Z</updated>
    
    <content type="html"><![CDATA[<p>pinia不多介绍。官方文档<a href="https://pinia.vuejs.org/introduction.html">https://pinia.vuejs.org/introduction.html</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install pinia@next</span><br></pre></td></tr></table></figure><p>在vue2中 插件 pinia-plugin-persist 可以辅助实现数据持久化功能。<a href="https://seb-l.github.io/pinia-plugin-persist/%E3%80%82">https://seb-l.github.io/pinia-plugin-persist/。</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i pinia-plugin-persist --save</span><br></pre></td></tr></table></figure><p>但是在这个插件只能在vue2中使用，vue3还未适配。。。</p><p>只有自己实现一个建议的状态存储了。</p><p>使用如下先创建一个简单的状态管理user.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&quot;pinia&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineStore</span>(&#123;</span><br><span class="line">   <span class="attr">id</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">   <span class="attr">state</span>: <span class="function">()=&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">mkey</span>:<span class="string">&quot;/home&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>:&#123;&#125;</span><br><span class="line">   &#125;),</span><br><span class="line">   <span class="attr">actions</span>:&#123;</span><br><span class="line">       <span class="title function_">countPlusOne</span>(<span class="params"></span>) &#123;</span><br><span class="line">         <span class="variable language_">this</span>.<span class="property">count</span>++;</span><br><span class="line">       &#125;,</span><br><span class="line">   &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>创建piniaPluginPersist.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;user&#125; <span class="keyword">from</span> <span class="string">&quot;@/store/index.js&quot;</span></span><br><span class="line"><span class="keyword">var</span> catchList=[</span><br><span class="line">   <span class="string">&quot;[object String]&quot;</span>,</span><br><span class="line">   <span class="string">&quot;[object Number]&quot;</span>,</span><br><span class="line">   <span class="string">&quot;[object Boolean]&quot;</span>,</span><br><span class="line">   <span class="string">&quot;[object Array]&quot;</span>,</span><br><span class="line">   <span class="string">&quot;[object Object]&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取对象集</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setPiniaObj</span>(<span class="params">stores=[]</span>)&#123;</span><br><span class="line">   <span class="keyword">var</span> itemsObj=&#123;&#125;  <span class="comment">//key模块名称,value模块对象</span></span><br><span class="line">   stores.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">var</span> key=item.<span class="property">$id</span></span><br><span class="line">      <span class="keyword">var</span> value=&#123;&#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> item)&#123;</span><br><span class="line">         <span class="keyword">if</span>(catchList.<span class="title function_">includes</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(item[k]))&amp;&amp;(k!=<span class="string">&quot;$id&quot;</span>))&#123;</span><br><span class="line">            value[k]=item[k]</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      itemsObj[key]=value</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">return</span> itemsObj</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">persistPinia</span> = (<span class="params"><span class="variable language_">window</span></span>) =&gt;&#123;</span><br><span class="line">   <span class="comment">//设置缓存</span></span><br><span class="line">   <span class="keyword">var</span> catchStore = sessionStorage.<span class="title function_">getItem</span>(<span class="string">&quot;_piniaPluginPersist&quot;</span>)</span><br><span class="line">   <span class="keyword">if</span>(catchStore)&#123;</span><br><span class="line">      catchStore=<span class="title class_">JSON</span>.<span class="title function_">parse</span>(catchStore)</span><br><span class="line">      <span class="keyword">var</span> storeArr = [<span class="title function_">user</span>()]</span><br><span class="line">      storeArr.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">         <span class="keyword">var</span> data=catchStore[item.<span class="property">$id</span>]</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> item)&#123;</span><br><span class="line">            <span class="keyword">if</span>(item[k]!==<span class="literal">undefined</span>&amp;&amp;(k!=<span class="string">&quot;$id&quot;</span>))&#123;item[k]=data[k]&#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      sessionStorage.<span class="title function_">removeItem</span>(<span class="string">&quot;_piniaPluginPersist&quot;</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//监听刷新</span></span><br><span class="line">   <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;beforeunload&quot;</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;222&quot;</span>)</span><br><span class="line">      <span class="keyword">var</span> storeObj=<span class="title function_">setPiniaObj</span>([<span class="title function_">user</span>()])</span><br><span class="line">      sessionStorage.<span class="title function_">setItem</span>(<span class="string">&quot;_piniaPluginPersist&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(storeObj))</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mainjs全局挂在函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; persistPinia &#125; <span class="keyword">from</span> <span class="string">&quot;@/utils/piniaPluginPersist.js&quot;</span></span><br><span class="line">app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">$persistPinia</span>=persistPinia</span><br></pre></td></tr></table></figure><p>在App.vue中使用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;getCurrentInstance , reactive &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> &#123; proxy &#125; = <span class="title function_">getCurrentInstance</span>();</span><br><span class="line">proxy.<span class="title function_">persistPinia</span>(<span class="variable language_">window</span>);</span><br></pre></td></tr></table></figure><p>解决</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;pinia不多介绍。官方文档&lt;a href=&quot;https://pinia.vuejs.org/introduction.html&quot;&gt;https://pinia.vuejs.org/introduction.html&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;npm install pinia@next&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在vue2中 插件 pinia-plugin-persist 可以辅助实现数据持久化功能。&lt;a href=&quot;https://seb-l.github.io/pinia-plugin-persist/%E3%80%82&quot;&gt;https://seb-l.github.io/pinia-plugin-persist/。&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="vue" scheme="https://tabbycute.github.io/tags/vue/"/>
    
    <category term="pinia" scheme="https://tabbycute.github.io/tags/pinia/"/>
    
  </entry>
  
  <entry>
    <title>有关parseInt第二个参数的一些问题</title>
    <link href="https://tabbycute.github.io/2021/07/05/20210705%E6%9C%89%E5%85%B3parseInt%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/"/>
    <id>https://tabbycute.github.io/2021/07/05/20210705%E6%9C%89%E5%85%B3parseInt%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/</id>
    <published>2021-07-04T16:00:00.000Z</published>
    <updated>2022-12-07T14:17:58.959Z</updated>
    
    <content type="html"><![CDATA[<p>最近在网上看了一个面试题，如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>,<span class="string">&quot;3&quot;</span>].<span class="title function_">map</span>(<span class="built_in">parseInt</span>)</span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;1&quot;</span>,<span class="number">0</span>)</span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;2&quot;</span>,<span class="number">1</span>)</span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;3&quot;</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>相信答案不必多说</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>,<span class="title class_">NaN</span>,<span class="title class_">NaN</span>]</span><br></pre></td></tr></table></figure><p>那么问题来了，经过计算，2通过一进制解析是能得到数字的，3通过二进制解析也是是能得到数字的，为什么会是NaN呢？</p><p>分析如下：</p><p>parseInt(“3”,2)基数为2，合适的数字为0,1，但是3大于0和1，所以返回为NaN;</p><p>我又尝试了一些其他的数字，发现问题不止如此，出现了如下情况</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;16&quot;</span>,<span class="number">2</span>) <span class="comment">//1</span></span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;18&quot;</span>,<span class="number">2</span>) <span class="comment">//1</span></span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;19&quot;</span>,<span class="number">2</span>) <span class="comment">//1</span></span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;195&quot;</span>,<span class="number">2</span>) <span class="comment">//1</span></span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;95&quot;</span>,<span class="number">2</span>) <span class="comment">//NaN</span></span><br></pre></td></tr></table></figure><p>因为基数为2，合适的数字只有0,1，所以走到了9或者8或者6就不会往后面继续解析直接返回，解析就停止了，实际解析的只有1，实际是在执行parseInt(“1”,2)</p><p>如果第一个都不符合那么直接返回NaN</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">parseInt</span>(<span class="string">&#x27;dsff984&#x27;</span>,<span class="number">16</span>)  <span class="comment">// 13</span></span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&#x27;d66&#x27;</span>,<span class="number">16</span>)  <span class="comment">// 3430</span></span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&#x27;ddff984&#x27;</span>,<span class="number">16</span>)  <span class="comment">// 14548838</span></span><br></pre></td></tr></table></figure><p>因为十进制最大的数字是9,但是到了十一进制往上，最大的数字是两位数了，这当然不行，所以从10开始往上，就用字母代替。</p><p>a==10,b==11,c=12,d=13  ……  z==35；所以parseInt的第二个参数必须要规定在2~36之间。注意还有个一进制</p><p>再看看上面这道问题，在16进制中，最大的数字是15，对应字母也就是f，超过f的字母也就超出了16进制的解析范围。</p><p>‘dsff984’的第一个字符是d，也就是十进制中的13，第二个字符s，代表十进制中的28，这显然超出了16进制的解析范围，所以s和它之后的字符都会被parseInt自动忽略，所以我们得到13。<br>‘d66’的第一个字符是d，也就是十进制中的13，(13<em>16²)+(6</em>16)+(6*16°)=3430<br>‘ddff984’ 参照上面</p><p>**parseInt(x,y)将y进制数x转化成普通数字(十进制)**如果x不是一个合格的y进制数就会采取措施，导致上面的情况，多提一句parseFloat只接受一个参数，只能使用十进制去解析。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近在网上看了一个面试题，如下&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[&lt;span class=&quot;string&quot;&gt;&amp;quot;1&amp;quot;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&amp;quot;2&amp;quot;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&amp;quot;3&amp;quot;&lt;/span&gt;].&lt;span class=&quot;title function_&quot;&gt;map&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;parseInt&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;parseInt&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;1&amp;quot;&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;parseInt&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;2&amp;quot;&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;parseInt&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;3&amp;quot;&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;相信答案不必多说&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
  </entry>
  
  <entry>
    <title>HTTP的进阶和理解</title>
    <link href="https://tabbycute.github.io/2021/07/01/20210710HTTP%E7%9A%84%E8%BF%9B%E9%98%B6%E5%92%8C%E7%90%86%E8%A7%A3/"/>
    <id>https://tabbycute.github.io/2021/07/01/20210710HTTP%E7%9A%84%E8%BF%9B%E9%98%B6%E5%92%8C%E7%90%86%E8%A7%A3/</id>
    <published>2021-06-30T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.045Z</updated>
    
    <content type="html"><![CDATA[<h3 id="GET和POST请求的区别"><a href="#GET和POST请求的区别" class="headerlink" title="GET和POST请求的区别"></a>GET和POST请求的区别</h3><ul><li>长度限制：GET会限制长度,POST不会</li><li>实际上 HTTP 协议规范并没有对 GET 方法请求的 url 长度进行限制，是浏览器及服务器的限制。</li><li>IE大约2083个字符，chrome大约 8192 个字符，其他浏览器大于 8192 个字符。主流的服务器对 get 方法中 url 的长度限制也大于等于8192个字符。</li><li>应用场景： GET 用于获取数据, POST 用于提交数据</li><li>安全性： GET 将参数放入 url 中，不太安全，因为url 会被保留在历史记录中。</li><li>报文格式： GET 请求的报文中实体部分为空，POST 请求的报文中实体部分为向发送的数据。</li><li>请求长度： GET 请求发送数据时的长度会根据浏览器的限制而不同。</li><li>是否缓存： 浏览器一般会对 GET 请求缓存，但很少对 POST 请求缓存。</li><li>参数类型： POST 的参数传递支持更多的数据类型。</li></ul><h3 id="HTTP，HTTP1-0，HTTP2-0-的部分区别"><a href="#HTTP，HTTP1-0，HTTP2-0-的部分区别" class="headerlink" title="HTTP，HTTP1.0，HTTP2.0 的部分区别"></a>HTTP，HTTP1.0，HTTP2.0 的部分区别</h3><p>超文本传输安全协议（Hypertext Transfer Protocol Secure，简称：HTTPS）是一种通过计算机网络进行安全通信的传输协议。HTTPS 经由 HTTP 进行通信，利用 SSL/TLS 来加密数据包。HTTPS 的主要目的是提供对网站服务器的身份认证，保护交换数据的隐私与完整性。</p><p>HTTP协议采用明文传输信息，存在信息窃听、信息篡改和信息劫持的风险，而协议TLS/SSL具有身份验证、信息加密和完整性校验的功能，可以避免此类问题发生。</p><p>安全层的主要职责就是对发起的 HTTP 请求的数据进行加密操作和对接收到的HTTP的内容进行解密操作。</p><h3 id="HTTPS是如何保证安全的"><a href="#HTTPS是如何保证安全的" class="headerlink" title="HTTPS是如何保证安全的"></a>HTTPS是如何保证安全的</h3><p>结合两种加密⽅式，将对称加密的密钥使⽤⾮对称加密的公钥进⾏加密，然后发送出去，接收⽅使⽤私钥进⾏解密得到对称加密的密钥，然后双⽅可以使⽤对称加密来进⾏沟通。<br>此时⼜带来⼀个问题，中间⼈问题：</p><p>如果此时在客户端和服务器之间存在⼀个中间⼈,这个中间⼈只需要把原本双⽅通信互发的公钥,换成⾃⼰的公钥,这样中间⼈就可以轻松解密通信双⽅所发送的所有数据。<br>所以这个时候需要⼀个安全的第三⽅颁发证书（CA），证明身份的身份，防⽌被中间⼈攻击。 证书中包括：签发者、证书⽤途、使⽤者公钥、使⽤者私钥、使⽤者的 Hash 算法、证书到期时间等。</p><p>但是问题来了，如果中间⼈篡改了证书，那么身份证明是不是就⽆效了？这个证明就⽩买了，这个时候需要⼀个新的技术，数字签名。</p><p>数字签名就是⽤ CA ⾃带的 Hash 算法对证书的内容进⾏ HASH 得到⼀个摘要，再⽤ CA 的私钥加密，最终组成数字签名。当别⼈把他的证书发过来的时候,我再⽤同样的 Hash 算法,再次⽣成消息摘要，然后⽤ CA 的公钥对数字签名解密,得到 CA 创建的消息摘要,两者⼀⽐,就知道中间有没有被⼈篡改了。这个时候就能最⼤程度保证通信的安全了。</p><h3 id="HTTP，HTTP1-0，HTTP2-0-的部分区别-1"><a href="#HTTP，HTTP1-0，HTTP2-0-的部分区别-1" class="headerlink" title="HTTP，HTTP1.0，HTTP2.0 的部分区别"></a>HTTP，HTTP1.0，HTTP2.0 的部分区别</h3><p>队头阻塞是由 HTTP 基本的“请求 - 应答”模型所导致的。HTTP 规定报文必须是“一发一收”，这就形成了一个先进先出的“串行”队列。队列里的请求是没有优先级的，只有入队的先后顺序，排在最前面的请求会被最优先处理。如果队首的请求因为处理的太慢耽误了时间，那么队列里后面的所有请求也不得不跟着一起等待，结果就是其他的请求承担了不应有的时间成本，造成了队头堵塞的现象。</p><h3 id="HTTP和HTTPS请求的区别"><a href="#HTTP和HTTPS请求的区别" class="headerlink" title="HTTP和HTTPS请求的区别"></a>HTTP和HTTPS请求的区别</h3><ul><li>HTTP 协议信息是明文传输的，HTTPS 则是具有安全性的 SSL 加密传输协议；</li><li>HTTP 协议端口是 80，HTTPS 协议端口是 443；</li><li>HTTP 协议连接很简单，是无状态的；HTTPS 协议是有 SSL 和 HTTP 协议构建的可进行加密传输、身份认证的网络协议，比 HTTP 更加安全。</li></ul><h3 id="HTTP状态码"><a href="#HTTP状态码" class="headerlink" title="HTTP状态码"></a>HTTP状态码</h3><table><thead><tr><th>类别</th><th>原因</th><th>描述</th></tr></thead><tbody><tr><td>1xx</td><td>Informational(信息性状态码)</td><td>接受的请求正在处理</td></tr><tr><td>2xx</td><td>Success(成功状态码)</td><td>请求正常处理完毕</td></tr><tr><td>3xx</td><td>Redirection(重定向状态码)</td><td>需要进行附加操作一完成请求</td></tr><tr><td>4xx</td><td>Client Error (客户端错误状态码)</td><td>服务器无法处理请求</td></tr><tr><td>5xx</td><td>Server Error(服务器错误状态码)</td><td>服务器处理请求出错</td></tr></tbody></table><ul><li>200 OK 表示客户端发来的请求被服务器端正常处理了。</li><li>204 No Content 表示客户端发送的请求已经在服务器端正常处理了，但是没有返回的内容，响应报文中不包含实体的主体部分。一般在只需要从客户端往服务器端发送信息，而服务器端不需要往客户端发送内容时使用。</li><li>206 Partial Content 表示客户端进行了范围请求，而服务器端执行了这部分的 GET 请求。响应报文中包含由 Content-Range 指定范围的实体内容。</li><li>301 永久重定向 表示请求的资源已经被分配了新的 URI，以后应使用资源指定的 URI。新的 URI 会在 HTTP 响应头中的 Location 首部字段指定。若用户已经把原来的URI保存为书签，此时会按照 Location 中新的URI重新保存该书签。同时，搜索引擎在抓取新内容的同时也将旧的网址替换为重定向之后的网址。使用场景<ul><li>当我们想换个域名，旧的域名不再使用时，用户访问旧域名时用301就重定向到新的域名。其实也是告诉搜索引擎收录的域名需要对新的域名进行收录。</li><li>在搜索引擎的搜索结果中出现了不带www的域名，而带www的域名却没有收录，这个时候可以用301重定向来告诉搜索引擎我们目标的域名是哪一个。</li></ul></li><li>302 临时重定向 表示请求的资源被分配到了新的 URI，希望用户（本次）能使用新的 URI 访问资源。和 301 Moved Permanently 状态码相似，但是 302 代表的资源不是被永久重定向，只是临时性质的。也就是说已移动的资源对应的 URI 将来还有可能发生改变。若用户把 URI 保存成书签，但不会像 301 状态码出现时那样去更新书签，而是仍旧保留返回 302 状态码的页面对应的 URI。同时，搜索引擎会抓取新的内容而保留旧的网址。因为服务器返回302代码，搜索引擎认为新的网址只是暂时的。使用场景<ul><li>当我们在做活动时，登录到首页自动重定向，进入活动页面。</li><li>未登陆的用户访问用户中心重定向到登录页面。</li><li>访问404页面重新定向到首页。</li></ul></li><li>304 Not Modified 浏览器缓存相关。 表示客户端发送附带条件的请求时，服务器端允许请求访问资源，但未满足条件的情况。</li><li>304 状态码返回时，不包含任何响应的主体部分。304 虽然被划分在 3XX 类别中，但是和重定向没有关系。带条件的请求（HTTP 条件请求）：使用 GET方法 请求，请求报文中包含（if-match、if-none-match、if-modified-since、if-unmodified-since、if-range）中任意首部。</li><li>304并不是一种错误，而是告诉客户端有缓存，直接使用缓存中的数据。返回页面的只有头部信息，是没有内容部分的，这样在一定程度上提高了网页的性能。</li><li>400 Bad Request 表示请求报文中存在语法错误。当错误发生时，需修改请求的内容后再次发送请求。另外，浏览器会像 200 OK 一样对待该状态码。</li><li>401 Unauthorized 表示发送的请求需要有通过 HTTP 认证(BASIC 认证、DIGEST 认证)的认证信息。若之前已进行过一次请求，则表示用户认证失败, 比如登录失败</li><li>403 Forbidden 表示请求资源的访问被服务器拒绝了，服务器端没有必要给出详细理由，但是可以在响应报文实体的主体中进行说明。进入该状态后，不能再继续进行验证。该访问是永久禁止的，并且与应用逻辑密切相关。</li><li>404 Not Found 表示服务器上无法找到请求的资源。</li><li>405 Method Not Allowed 表示客户端请求的方法虽然能被服务器识别，但是服务器禁止使用该方法。客户端可以通过 OPTIONS 方法（预检）来查看服务器允许的访问方法, 如下Access-Control-Allow-Methods: GET,HEAD,PUT,PATCH,POST,DELETE</li><li>500 Internal Server Error 表示服务器端在执行请求时发生了错误。例如出现了 Bug</li><li>502 Bad Gateway 表示扮演网关或代理角色的服务器，从上游服务器中接收到的响应是无效的。注意，502 错误通常不是客户端能够修复的，而是需要由途经的 Web 服务器或者代理服务器对其进行修复。以下情况会出现502：</li><li>503 Service Unavailable 表示服务器暂时处于超负载或正在进行停机维护，现在无法处理请求。使用场景：<ul><li>服务器停机维护时，主动用503响应请求；</li><li>nginx 设置限速，超过限速，会返回503。</li></ul></li><li>504 Gateway Timeout 表示网关或者代理的服务器无法在规定的时间内获得想要的响应。他是HTTP 1.1中新加入的。使用场景：代码执行时间超时，或者发生了死循环。</li></ul><h3 id="浏览器中输入URL按下回车后发生了什么"><a href="#浏览器中输入URL按下回车后发生了什么" class="headerlink" title="浏览器中输入URL按下回车后发生了什么"></a>浏览器中输入URL按下回车后发生了什么</h3><p>解析URL： 首先会对 URL 进行解析，分析所需要使用的传输协议和请求的资源的路径。会对非法字符进行转义</p><p>缓存判断： 如果存在有效的缓存, 就直接使用缓存，否则向服务器发起新的请求。</p><p>DNS解析： 此步骤主要是获取IP地址, 具体步骤：本地是否有缓存-&gt;否-&gt;本地 DNS 服务器是否有缓存-&gt;否-&gt;向根域名服务器发起请求-&gt;得到IP地址</p><p>获取MAC地址： 获取目标网址的 MAC( 局域网地址) 地址, 主要是需要判断目标地址与当前机器是否在同一个子网, 不在就需要网关转发。<br>TCP三次握手： 建立 TCP 连接。</p><p>HTTPS握手： 如果使用的是 HTTPS 协议，在通信前还存在 TLS 的一个四次握手的过程。首先由客户端向服务器端发送使用的协议的版本号、一个随机数和可以使用的加密方法。服务器端收到后，确认加密的方法，也向客户端发送一个随机数和自己的数字证书。客户端收到后，首先检查数字证书是否有效，如果有效，则再生成一个随机数，并使用证书中的公钥对随机数加密，然后发送给服务器端，并且还会提供一个前面所有内容的 hash 值供服务器端检验。服务器端接收后，使用自己的私钥对数据解密，同时向客户端发送一个前面所有内容的 hash 值供客户端检验。这个时候双方都有了三个随机数，按照之前所约定的加密方法，使用这三个随机数生成一把秘钥，以后双方通信前，就使用这个秘钥对数据进行加密后再传输。下面看详解</p><p>返回数据： 当页面请求发送到服务器端后，服务器端会返回一个 html 文件作为响应，浏览器接收到响应后，开始对 html 文件进行解析，开始页面的渲染过程。</p><p>页面渲染： 浏览器首先会根据 html 文件构建 DOM 树，根据解析到的 css 文件构建 CSSOM 树，如果遇到 script 标签，则判端是否含有 defer 或者 async 属性，要不然 script 的加载和执行会造成页面的渲染的阻塞。当 DOM 树和 CSSOM 树建立好后，根据它们来构建渲染树。渲染树构建好后，会根据渲染树来进行布局。布局完成后，最后使用浏览器的 UI 接口对页面进行绘制。这个时候整个页面就显示出来了。</p><p>TCP四次挥手： 最后一步是 TCP 断开连接的四次挥手过程。若客户端认为数据发送完成，则它需要向服务端发送连接释放请求。服务端收到连接释放请求后，会告诉应用层要释放 TCP 链接。然后会发送 ACK 包，并进入 CLOSE_WAIT 状态，此时表明客户端到服务端的连接已经释放，不再接收客户端发的数据了。但是因为 TCP 连接是双向的，所以服务端仍旧可以发送数据给客户端。服务端如果此时还有没发完的数据会继续发送，完毕后会向客户端发送连接释放请求，然后服务端便进入 LAST-ACK 状态。客户端收到释放请求后，向服务端发送确认应答，此时客户端进入 TIME-WAIT 状态。该状态会持续 2MSL（最大段生存期，指报文段在网络中生存的时间，超时会被抛弃） 时间，若该时间段内没有服务端的重发请求的话，就进入 CLOSED 状态。当服务端收到确认应答后，也便进入 CLOSED 状态。</p><h3 id="HTTPS通信-握手-过程"><a href="#HTTPS通信-握手-过程" class="headerlink" title="HTTPS通信(握手)过程"></a>HTTPS通信(握手)过程</h3><p>客户端向服务器发起请求，请求中包含使用的协议版本号、生成的一个随机数、以及客户端支持的加密方法。<br>服务器端接收到请求后，确认双方使用的加密方法、并给出服务器的证书、以及一个服务器生成的随机数。<br>客户端确认服务器证书有效后，生成一个新的随机数，并使用数字证书中的公钥，加密这个随机数，然后发给服 务器。并且还会提供一个前面所有内容的 hash 的值，用来供服务器检验。<br>服务器使用自己的私钥，来解密客户端发送过来的随机数。并提供前面所有内容的 hash 值来供客户端检验。<br>客户端和服务器端根据约定的加密方法使用前面的三个随机数，生成对话秘钥，以后的对话过程都使用这个秘钥来加密信息。</p><h3 id="HTTP三次握手"><a href="#HTTP三次握手" class="headerlink" title="HTTP三次握手"></a>HTTP三次握手</h3><p>三次握手（Three-way Handshake）其实就是指建立一个 TCP 连接时，需要客户端和服务器总共发送3个包。进行三次握手的主要作用就是为了确认双方的接收能力和发送能力是否正常、指定自己的初始化序列号为后面的可靠性传送做准备。实质上其实就是连接服务器指定端口，建立 TCP 连接，并同步连接双方的序列号和确认号，交换 TCP 窗口大小信息。<br>刚开始客户端处于 Closed 的状态，服务端处于 Listen 状态。<br>第一次握手： 客户端给服务端发一个 SYN 报文，并指明客户端的初始化序列号 ISN，此时客户端处于 SYN_SEND 状态。<br>第二次握手： 服务器收到客户端的 SYN 报文之后，会以自己的 SYN 报文作为应答，并且也是指定了自己的初始化序列号 ISN。同时会把客户端的 ISN + 1 作为ACK 的值，表示自己已经收到了客户端的 SYN，此时服务器处于 SYN_REVD 的状态。<br>第三次握手： 客户端收到 SYN 报文之后，会发送一个 ACK 报文，当然，也是一样把服务器的 ISN + 1 作为 ACK 的值，表示已经收到了服务端的 SYN 报文，此时客户端处于 ESTABLISHED 状态。服务器收到 ACK 报文之后，也处于 ESTABLISHED 状态，此时，双方已建立起了连接。<br>那为什么要三次握手呢？两次不行吗？<br>为了确认双方的接收能力和发送能力都正常<br>如果是用两次握手，则会出现下面这种情况：</p><blockquote><p>如客户端发出连接请求，但因连接请求报文丢失而未收到确认，于是客户端再重传一次连接请求。后来收到了确认，建立了连接。数据传输完毕后，就释放了连接，客户端共发出了两个连接请求报文段，其中第一个丢失，第二个到达了服务端，但是第一个丢失的报文段只是在某些网络结点长时间滞留了，延误到连接释放以后的某个时间才到达服务端，此时服务端误认为客户端又发出一次新的连接请求，于是就向客户端发出确认报文段，同意建立连接，不采用三次握手，只要服务端发出确认，就建立新的连接了，此时客户端忽略服务端发来的确认，也不发送数据，则服务端一致等待客户端发送数据，浪费资源。</p></blockquote><p>TCP 三次握手的建立连接的过程就是相互确认初始序号的过程，告诉对方，什么样序号的报文段能够被正确接收。 第三次握手的作用是客户端对服务器端的初始序号的确认。如果只使用两次握手，那么服务器就没有办法知道自己的序号是否已被确认。同时这样也是为了防止失效的请求报文段被服务器接收，而出现错误的情况。</p><h3 id="HTTP四次挥手"><a href="#HTTP四次挥手" class="headerlink" title="HTTP四次挥手"></a>HTTP四次挥手</h3><p>第一次挥手： 客户端会发送一个 FIN 报文，报文中会指定一个序列号。此时客户端处于 FIN_WAIT1 状态。</p><blockquote><p>即发出连接释放报文段（FIN=1，序号seq=u），并停止再发送数据，主动关闭TCP连接，进入FIN_WAIT1（终止等待1）状态，等待服务端的确认。</p></blockquote><p>第二次挥手： 服务端收到 FIN 之后，会发送 ACK 报文，且把客户端的序列号值 +1 作为 ACK 报文的序列号值，表明已经收到客户端的报文了，此时服务端处于 CLOSE_WAIT 状态。</p><blockquote><p>即服务端收到连接释放报文段后即发出确认报文段（ACK=1，确认号ack=u+1，序号seq=v），服务端进入CLOSE_WAIT（关闭等待）状态，此时的TCP处于半关闭状态，客户端到服务端的连接释放。客户端收到服务端的确认后，进入FIN_WAIT2（终止等待2）状态，等待服务端发出的连接释放报文段。</p></blockquote><p>第三次挥手： 如果服务端也想断开连接了，和客户端的第一次挥手一样，发给 FIN 报文，且指定一个序列号。此时服务端处于 LAST_ACK 的状态。</p><blockquote><p>即服务端没有要向客户端发出的数据，服务端发出连接释放报文段（FIN=1，ACK=1，序号seq=w，确认号ack=u+1），服务端进入LAST_ACK（最后确认）状态，等待客户端的确认。</p></blockquote><p>第四次挥手： 客户端收到 FIN 之后，一样发送一个 ACK 报文作为应答，且把服务端的序列号值 +1 作为自己 ACK 报文的序列号值，此时客户端处于 TIME_WAIT 状态。需要过一阵</p><blockquote><p>以确保服务端收到自己的 ACK 报文之后才会进入 CLOSED 状态，服务端收到 ACK 报文之后，就处于关闭连接了，处于 CLOSED 状态。即客户端收到服务端的连接释放报文段后，对此发出确认报文段（ACK=1，seq=u+1，ack=w+1），客户端进入TIME_WAIT（时间等待）状态。此时TCP未释放掉，需要经过时间等待计时器设置的时间2MSL后，客户端才进入CLOSED状态。</p></blockquote><p>为什么需要四次挥手呢？</p><p>因为当服务端收到客户端的SYN连接请求报文后，可以直接发送SYN+ACK报文。其中ACK报文是用来应答的，SYN报文是用来同步的。但是关闭连接时，当服务端收到FIN报文时，很可能并不会立即关闭SOCKET，所以只能先回复一个ACK报文，告诉客户端，“你发的FIN报文我收到了”。只有等到我服务端所有的报文都发送完了，我才能发送FIN报文，因此不能一起发送，故需要四次挥手。</p><p>TCP 使用四次挥手的原因是因为 TCP 的连接是全双工的，所以需要双方分别释放到对方的连接，单独一方的连接释放，只代表不能再向对方发送数据，连接处于的是半释放的状态。<br>最后一次挥手中，客户端会等待一段时间再关闭的原因，是为了防止发送给服务器的确认报文段丢失或者出错，从而导致服务器端不能正常关闭。</p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;GET和POST请求的区别&quot;&gt;&lt;a href=&quot;#GET和POST请求的区别&quot; class=&quot;headerlink&quot; title=&quot;GET和POST请求的区别&quot;&gt;&lt;/a&gt;GET和POST请求的区别&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;长度限制：GET会限制长度,POST不会&lt;/li&gt;
&lt;li&gt;实际上 HTTP 协议规范并没有对 GET 方法请求的 url 长度进行限制，是浏览器及服务器的限制。&lt;/li&gt;
&lt;li&gt;IE大约2083个字符，chrome大约 8192 个字符，其他浏览器大于 8192 个字符。主流的服务器对 get 方法中 url 的长度限制也大于等于8192个字符。&lt;/li&gt;
&lt;li&gt;应用场景： GET 用于获取数据, POST 用于提交数据&lt;/li&gt;
&lt;li&gt;安全性： GET 将参数放入 url 中，不太安全，因为url 会被保留在历史记录中。&lt;/li&gt;
&lt;li&gt;报文格式： GET 请求的报文中实体部分为空，POST 请求的报文中实体部分为向发送的数据。&lt;/li&gt;
&lt;li&gt;请求长度： GET 请求发送数据时的长度会根据浏览器的限制而不同。&lt;/li&gt;
&lt;li&gt;是否缓存： 浏览器一般会对 GET 请求缓存，但很少对 POST 请求缓存。&lt;/li&gt;
&lt;li&gt;参数类型： POST 的参数传递支持更多的数据类型。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;HTTP，HTTP1-0，HTTP2-0-的部分区别&quot;&gt;&lt;a href=&quot;#HTTP，HTTP1-0，HTTP2-0-的部分区别&quot; class=&quot;headerlink&quot; title=&quot;HTTP，HTTP1.0，HTTP2.0 的部分区别&quot;&gt;&lt;/a&gt;HTTP，HTTP1.0，HTTP2.0 的部分区别&lt;/h3&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="http" scheme="https://tabbycute.github.io/tags/http/"/>
    
  </entry>
  
  <entry>
    <title>前端对二进制深入剖析</title>
    <link href="https://tabbycute.github.io/2021/06/01/20210601%E5%89%8D%E7%AB%AF%E5%AF%B9%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%9A%84%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/"/>
    <id>https://tabbycute.github.io/2021/06/01/20210601%E5%89%8D%E7%AB%AF%E5%AF%B9%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%9A%84%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/</id>
    <published>2021-05-31T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.044Z</updated>
    
    <content type="html"><![CDATA[<p>自我感觉一直对浏览器的二进制操作比,文件操作,以及其他的io读写等较迷糊。今天开个专场彻底搞清。</p><h3 id="blob"><a href="#blob" class="headerlink" title="blob"></a>blob</h3><p>Blob 对象表示一个不可变、原始数据的类文件对象。Blob 表示的不一定是JavaScript原生格式的数据。Blob对象本质上是js中的一个对象，里面可以储存大量的二进制编码格式的数据，<strong>我们不可以直接操作他</strong>。</p><h4 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h4><p>var aBlob = new Blob( array, options );</p><ul><li>array .可以是如下<ul><li>ArrayBuffer</li><li>ArrayBufferView</li><li>Blob</li><li>DOMString(DOMStrings 会被编码为 UTF-8。)</li></ul></li><li>options 是一个可选的BlobPropertyBag字典，它可能会指定如下两个属性<ul><li>type，默认值为 “”，它代表了将会被放入到 blob 中的数组内容的 MIME 类型。</li><li>endings，默认值为”transparent”，用于指定包含行结束符\n的字符串如何被写入。它是以下两个值中的一个：”native”，代表行结束符会被更改为适合宿主操作系统文件系统的换行符，或者 “transparent”，代表会保持 blob 中保存的结束符不变 非标准<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> aFileParts = [<span class="string">&#x27;&lt;a id=&quot;a&quot;&gt;&lt;b id=&quot;b&quot;&gt;hey!&lt;/b&gt;&lt;/a&gt;&#x27;</span>]; <span class="comment">// 一个包含 DOMString 的数组</span></span><br><span class="line"><span class="keyword">var</span> oMyBlob = <span class="keyword">new</span> <span class="title class_">Blob</span>(aFileParts, &#123;type : <span class="string">&#x27;text/html&#x27;</span>&#125;); <span class="comment">// 得到 blob</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = &#123;<span class="attr">hello</span>: <span class="string">&#x27;我tm看看行不行&#x27;</span>&#125;;</span><br><span class="line"><span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj)],&#123;<span class="attr">type</span>:<span class="string">&#x27;application/json&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">32</span>);</span><br><span class="line"><span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([ab]); <span class="comment">// 注意必须包裹[]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//base64转Blob</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dataURLtoBlob</span>(<span class="params">base64Str</span>) &#123;</span><br><span class="line"><span class="comment">// data:image/jpeg;base64,/9j/4AAQSkZJR...</span></span><br><span class="line"><span class="keyword">var</span> arr =base64Str.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>),</span><br><span class="line">mime = arr[<span class="number">0</span>].<span class="title function_">match</span>(<span class="regexp">/:(.*?);/</span>)[<span class="number">1</span>],</span><br><span class="line">bstr = <span class="title function_">atob</span>(arr[<span class="number">1</span>]),  <span class="comment">//atob() //ASCII to Base64  ,  btoa() //Base64 to ASCII</span></span><br><span class="line">n = bstr.<span class="property">length</span>,</span><br><span class="line">u8arr = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(n);</span><br><span class="line"><span class="keyword">while</span> (n--) &#123;</span><br><span class="line">u8arr[n] = bstr.<span class="title function_">charCodeAt</span>(n);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Blob</span>([u8arr], &#123; <span class="attr">type</span>: mime &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//还有读出的文件</span></span><br></pre></td></tr></table></figure>demo<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;<span class="attr">hello</span>: <span class="string">&#x27;我tm看看行不行&#x27;</span>&#125;;</span><br><span class="line"><span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj)],&#123;<span class="attr">type</span>:<span class="string">&#x27;application/json&#x27;</span>&#125;);</span><br></pre></td></tr></table></figure><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4></li></ul></li><li>Blob.prototype.size 只读。Blob 对象中所包含数据的大小（字节）。</li><li>Blob.prototype.type 只读。一个字符串，表明该 Blob 对象所包含数据的 MIME 类型。如果类型未知，则该值为空字符串。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(blob.<span class="property">size</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(blob.<span class="property">tpye</span>)</span><br></pre></td></tr></table></figure></li></ul><h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><ul><li>Blob.prototype.text() 返回一个 promise，其会兑现一个包含 Blob 所有内容的 UTF-8 格式的字符串。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">blob.<span class="title function_">text</span>().<span class="title function_">then</span>(<span class="params">t=&gt;<span class="variable language_">console</span>.log(t)</span>)</span><br><span class="line">&#123;<span class="string">&quot;hello&quot;</span>:<span class="string">&quot;我tm看看行不行&quot;</span>&#125;</span><br></pre></td></tr></table></figure></li><li>Blob.prototype.slice() 返回一个新的 Blob 对象，包含了源 Blob 对象中指定范围内的数据。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> b=blob.<span class="title function_">slice</span>(<span class="number">0</span>,<span class="number">18</span>)</span><br><span class="line">b.<span class="title function_">text</span>().<span class="title function_">then</span>(<span class="params">t=&gt;<span class="variable language_">console</span>.log(t)</span>)</span><br><span class="line">&#123;<span class="string">&quot;hello&quot;</span>:<span class="string">&quot;我tm看</span></span><br></pre></td></tr></table></figure></li><li>Blob.prototype.arrayBuffer() 返回一个 promise，其会兑现一个包含 Blob 所有内容的二进制格式的 <strong>ArrayBuffer</strong> （下面详解）。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bufferPromise = blob.<span class="title function_">arrayBuffer</span>();</span><br><span class="line">blob.<span class="title function_">arrayBuffer</span>().<span class="title function_">then</span>(<span class="function"><span class="params">buffer</span> =&gt;</span> <span class="comment">/* 处理 ArrayBuffer 数据的代码……*/</span>);</span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">await</span> blob.<span class="title function_">arrayBuffer</span>();</span><br></pre></td></tr></table></figure></li><li>Blob.prototype.stream() 返回一个能读取 Blob 内容的 ReadableStream。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stream= blob.<span class="title function_">stream</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stream)</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">Response</span>(stream,&#123;<span class="attr">headers</span>:&#123;<span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;text/html&#x27;</span> &#125;&#125;).<span class="title function_">text</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">text</span>=&gt;</span>&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(text)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li></ul><h3 id="File"><a href="#File" class="headerlink" title="File"></a>File</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=<span class="string">&quot;file&quot;</span> id=<span class="string">&quot;file&quot;</span>&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;img&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#file&quot;</span>).<span class="title function_">addEventListener</span>(<span class="string">&quot;change&quot;</span>, <span class="keyword">function</span> (<span class="params">File</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="property">target</span>.<span class="property">files</span>[<span class="number">0</span>])</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">getFile</span>(<span class="title class_">File</span>.<span class="property">target</span>.<span class="property">files</span>[<span class="number">0</span>])</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">function</span> <span class="title function_">getFile</span>(<span class="params">File</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="property">lastModified</span>)      <span class="comment">//返回当前 File 对象所引用文件最后修改时间，自 UNIX 时间起始值（1970 年 1 月 1 日 00:00:00 UTC）以来的毫秒数。</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="property">lastModifiedDate</span>)  <span class="comment">//返回当前 File 对象所引用文件最后修改时间的 Date 对象。</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="property">name</span>)              <span class="comment">//返回当前 File 对象所引用文件的名字。</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="property">size</span>)              <span class="comment">//返回文件的大小。</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="property">webkitRelativePath</span>)<span class="comment">//返回 File 相关的 path 或 URL。</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="property">type</span>)              <span class="comment">//返回文件的 多用途互联网邮件扩展类型（MIME Type）由第三个参数中的type决定</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="comment">///File 接口没有定义任何方法，但是它从 Blob 接口继承了以下方法</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="number">1000</span>))<span class="comment">//</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">1664593283489</span></span><br><span class="line"><span class="language-xml">Sat Oct 01 2022 11:01:23 GMT+0800 (中国标准时间)</span></span><br><span class="line"><span class="language-xml">1.jpg</span></span><br><span class="line"><span class="language-xml">123637</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">image/jpeg</span></span><br><span class="line"><span class="language-xml">Blob &#123;size: 1000, type: &#x27;&#x27;&#125;</span></span><br></pre></td></tr></table></figure><h3 id="FileReader"><a href="#FileReader" class="headerlink" title="FileReader"></a>FileReader</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">File</span> = <span class="keyword">new</span> <span class="title class_">File</span>([],<span class="string">&quot;./imgs/1.jpg&quot;</span>,&#123;<span class="attr">type</span>:<span class="string">&quot;image/jpg&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printFile</span>(<span class="params">file</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span><br><span class="line">  reader.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params">evt</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(evt);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(reader.<span class="property">error</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(reader.<span class="property">readyState</span>);<span class="comment">//0还没有加载任何数据。1数据正在被加载。2已完成全部的读取请求。</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(reader.<span class="property">result</span>);<span class="comment">///===evt.target.result</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>readAsArrayBuffer(blob/File)<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ProgressEvent</span> &#123;<span class="attr">isTrusted</span>: <span class="literal">true</span>, <span class="attr">lengthComputable</span>: <span class="literal">true</span>, <span class="attr">loaded</span>: <span class="number">123637</span>, <span class="attr">total</span>: <span class="number">123637</span>, <span class="attr">type</span>: <span class="string">&#x27;load&#x27;</span>, …&#125;</span><br><span class="line"><span class="literal">null</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="title class_">ArrayBuffer</span>(<span class="number">123637</span>)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ProgressEvent</span> &#123;<span class="attr">isTrusted</span>: <span class="literal">true</span>, <span class="attr">lengthComputable</span>: <span class="literal">true</span>, <span class="attr">loaded</span>: <span class="number">123637</span>, <span class="attr">total</span>: <span class="number">123637</span>, <span class="attr">type</span>: <span class="string">&#x27;load&#x27;</span>, …&#125;</span><br><span class="line"><span class="literal">null</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="title class_">ArrayBuffer</span>(<span class="number">123637</span>)</span><br></pre></td></tr></table></figure></li><li>readAsBinaryString(blob/File) 该特性是非标准的，请尽量不要在生产环境中使用它！</li><li>readAsDataURL(blob/File) 读出base64<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ProgressEvent</span> &#123;<span class="attr">isTrusted</span>: <span class="literal">true</span>, <span class="attr">lengthComputable</span>: <span class="literal">true</span>, <span class="attr">loaded</span>: <span class="number">2233</span>, <span class="attr">total</span>: <span class="number">2233</span>, <span class="attr">type</span>: <span class="string">&#x27;load&#x27;</span>, …&#125;</span><br><span class="line"><span class="literal">null</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="attr">data</span>:application/octet-stream;base64,/u3+7QAAAAIAAAABAAAAAQAGMTIzNDU2AAABc1Z=</span><br></pre></td></tr></table></figure></li><li>readAsText(blob/File) 读出字符串</li></ul><h3 id="ArrayBuffer"><a href="#ArrayBuffer" class="headerlink" title="ArrayBuffer"></a>ArrayBuffer</h3><p>ArrayBuffer表示二进制数据的原始缓冲区，用于存储不同类型化数组的数据。<strong>我们无法直接读取或写入 ArrayBuffer</strong>，但是可以根据需要将其传递到类型化数组 TypedArray 或 DataView 视图来操作二进制数据</p><p>浏览器中以现有数据获取 ArrayBuffer 或者创建一个空buffer</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;<span class="attr">hello</span>: <span class="string">&#x27;我tm看看行不行&#x27;</span>&#125;;</span><br><span class="line"><span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj)],&#123;<span class="attr">type</span>:<span class="string">&#x27;application/json&#x27;</span>&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(blob.<span class="property">buffer</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b0 =  <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;bwGO8X5gdaM5dsV@&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b0)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">0x15</span>,<span class="number">0xFF</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x34</span>,<span class="number">0xAB</span>,<span class="number">0x11</span>];</span><br><span class="line"><span class="keyword">var</span> u8 = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(arr);</span><br><span class="line"><span class="keyword">var</span> ab = u8.<span class="property">buffer</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ab); <span class="comment">// ab为要解析的ArrayBuffer</span></span><br></pre></td></tr></table></figure><p>以其他现有数据获取查看文档<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">MDN传送门</a></p><ul><li>length，缓冲区的长度，每个字节的值默认都是0。如果无法分配请求数目的字节，则将引发异常。</li><li>byteLength。 只读属性，用于获取到ArrayBuffer实例的长度（以字节为单位）。 如果分配的内存较大，可能会分配失败，所以可以通过校验长度来判断是否分配成功。</li><li>slice()。将内存区域的一部分，拷贝生成一个新的ArrayBuffer对象，与blob的slice方式类似。除了slice方法，ArrayBuffer对象不提供任何直接读写内存的方法，只允许在其上方建立视图，然后通过视图进行读写。</li><li>isView()。这是个静态方法！返回一个布尔值。表示参数是否为ArrayBuffer的视图实例，即是否为TypedArray或DataView实例。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="title class_">ArrayBuffer</span>.<span class="title function_">isView</span>(buffer) <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> file = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;file&quot;</span>).<span class="property">files</span>[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span><br><span class="line">reader.<span class="title function_">readAsArrayBuffer</span>(file)</span><br><span class="line">reader.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> data = e.<span class="property">target</span>.<span class="property">result</span>; </span><br><span class="line">    <span class="title class_">ArrayBuffer</span>.<span class="title function_">isView</span>(data) <span class="comment">// false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> i32 = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(buffer);</span><br><span class="line"><span class="title class_">ArrayBuffer</span>.<span class="title function_">isView</span>(i32) <span class="comment">// true</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="ReadableStream"><a href="#ReadableStream" class="headerlink" title="ReadableStream"></a>ReadableStream</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream/ReadableStream">ReadableStream</a>这个用的不是很我也只是了解下，做个记录，需要的时候在回来看看文档。😳</p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Streams_API">流操作API</a>中的ReadableStream 接口呈现了一个可读取的二进制流操作。</p><ul><li>ReadableStream.locked。一个可读流最多可以有一个激活的 reader，并且直到被释放之前都是锁定到该 reader。可以使用 ReadableStream.getReader() 方法获取 reader 然后使用 reader 的 releaseLock() 方法释放可读流。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> stream = <span class="keyword">new</span> <span class="title class_">ReadableStream</span>(&#123;...&#125;);</span><br><span class="line"><span class="keyword">const</span> reader = stream.<span class="title function_">getReader</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stream.<span class="property">locked</span>)</span><br><span class="line"><span class="comment">// 应返回 true，表示流已经锁定到了一个 reader</span></span><br></pre></td></tr></table></figure></li><li>getReader() 接口的 getReader() 方法会创建一个 reader，并将流锁定。只有当前 reader 将流释放后，其他 reader 才能使用。</li><li>cancel() 用于在不再需要来自它的任何数据的情况下（即使仍有排队等待的数据块）完全结束一个流。</li><li>pipeThrough() 方法提供了一种链式的方式，将当前流通过转换流或者其它任何一对可写/可读的流进行管道传输。</li><li>pipeTo() 方法通过管道将当前的 ReadableStream 中的数据传递给给定的 WritableStream 并且返回一个 Promise，promise 在传输成功完成时兑现，在遇到任何错误时则会被拒绝。</li><li>tee() 方法对当前的可读流进行拷贝（tees），返回包含两个 ReadableStream 实例分支的数组。<br>简单示例<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;http://127.0.0.1:8080/ping&#x27;</span>)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// response.text().then(res=&gt;&#123;console.log(res)&#125;)//可以直接取值，但是下面要演示</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(response)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">body: ReadableStream</span></span><br><span class="line"><span class="comment">bodyUsed: true</span></span><br><span class="line"><span class="comment">headers: Headers &#123;&#125;</span></span><br><span class="line"><span class="comment">ok: true</span></span><br><span class="line"><span class="comment">redirected: false</span></span><br><span class="line"><span class="comment">status: 200</span></span><br><span class="line"><span class="comment">statusText: &quot;OK&quot;</span></span><br><span class="line"><span class="comment">type: &quot;cors&quot;</span></span><br><span class="line"><span class="comment">url: &quot;http://127.0.0.1:8080/ping&quot;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">return</span> response.<span class="property">body</span></span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">(<span class="params">body</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">const</span> reader = body.<span class="title function_">getReader</span>();<span class="comment">///这里的body本身就是一个ReadableStream</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(reader)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">closed: Promise &#123;&lt;fulfilled&gt;: undefined&#125;</span></span><br><span class="line"><span class="comment">[[Prototype]]: ReadableStreamDefaultReader</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//构造一个新的ReadableStream</span></span><br><span class="line"><span class="keyword">const</span> newReadableStream=<span class="keyword">new</span> <span class="title class_">ReadableStream</span>(&#123;</span><br><span class="line"><span class="title function_">start</span>(<span class="params">controller</span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(controller)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">desiredSize: 0</span></span><br><span class="line"><span class="comment">[[Prototype]]: ReadableStreamDefaultController</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">push</span>(<span class="params"></span>) &#123;</span><br><span class="line">reader.<span class="title function_">read</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; done, value &#125;</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (done) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;写入流完成&#x27;</span>, done);</span><br><span class="line">controller.<span class="title function_">close</span>();<span class="comment">///关闭此流</span></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;开始写入流&quot;</span>)</span><br><span class="line">controller.<span class="title function_">enqueue</span>(value);<span class="comment">///将给定的块排入关联的流。</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(done, value);</span><br><span class="line"><span class="title function_">push</span>();<span class="comment">///在执行一次，如果已经完成则关闭此流</span></span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">push</span>();<span class="comment">///开始从body的流写入此流</span></span><br><span class="line">&#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">return</span> newReadableStream</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">(<span class="params">stream</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stream)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">locked: false</span></span><br><span class="line"><span class="comment">[[Prototype]]: ReadableStream</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(stream, &#123;<span class="attr">headers</span>:&#123;<span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;text/html&#x27;</span>&#125;&#125;).<span class="title function_">text</span>();</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(result); &#125;);<span class="comment">///&#123;&quot;message&quot;:&quot;pong&quot;&#125;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="TypedArray"><a href="#TypedArray" class="headerlink" title="TypedArray"></a>TypedArray</h3><p>ArrayBuffer对象作为内存区域，可以存放多种类型的数据。同一段内存，不同数据有不同的解读方式，这就叫做“视图”（view）。ArrayBuffer有两种视图，一种是 TypedArray视图，另一种是DataView视图。前者的数组成员都是同一种数据类型，后者的数组成员可以是不同种的数据类型。</p><h4 id="TypedArray视图共有9种类型，每一种视图都是一种构造函数。"><a href="#TypedArray视图共有9种类型，每一种视图都是一种构造函数。" class="headerlink" title="TypedArray视图共有9种类型，每一种视图都是一种构造函数。"></a>TypedArray视图共有9种类型，每一种视图都是一种构造函数。</h4><table><thead><tr><th>名称</th><th>类型</th><th>大小</th></tr></thead><tbody><tr><td>Int8Array</td><td>8位有符号整型</td><td>长度1个字节</td></tr><tr><td>Uint8Array</td><td>8位无符号整型</td><td>长度1个字节</td></tr><tr><td>Uint8ClampedArray</td><td>8位无符号整型</td><td>长度1个字节，溢出取极值</td></tr><tr><td>Int16Array</td><td>16位有符号整型</td><td>长度2个字节。</td></tr><tr><td>Uint16Array</td><td>16位无符号整型，</td><td>长度2个字节。</td></tr><tr><td>Int32Array</td><td>32位有符号整型</td><td>长度4个字节</td></tr><tr><td>Uint32Array</td><td>32位无符号整型</td><td>长度4个字节</td></tr><tr><td>Float32Array</td><td>32位浮点型</td><td>长度4个字节</td></tr><tr><td>Float64Array</td><td>64位浮点型</td><td>长度8个字节</td></tr></tbody></table><h4 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h4><p>这几个构造函数生成的实例都是<strong>类数组</strong>。</p><ul><li>也都是有length属性（注意与byteLength区分）</li><li>都能用取下标的方式（[]）获取单个数据，</li><li>所有数组的方法（无contact方法）都能使用。</li></ul><p>普通数组与TypedArray类数组的差异主要在以下方面。</p><ul><li>TypedArray数组中所有成员，都是同一种类型的。</li><li>TypedArray数组的成员是连续的，不会有空位。</li><li>TypedArray数组成员的默认值为0。比如，new Array(10)返回一个普通数组，里面没有任何成员，只是10个空位；new Uint8Array(10)返回一个TypedArray数组，里面10个成员都是0。</li><li>TypedArray数组只是一层视图，本身不储存数据，它的数据都储存在底层的ArrayBuffer对象之中，要获取底层对象必须使用buffer属性（prototype）。</li></ul><h4 id="TypedArray构造函数。"><a href="#TypedArray构造函数。" class="headerlink" title="TypedArray构造函数。"></a>TypedArray构造函数。</h4><p>这九种构造函数，可以生产不同类型的数据实例。</p><ul><li>TypedArray(buffer, byteOffset, length)。 byteOffset必须与所要建立的数据类型一致，否则会报错。 同一个TypedArray中，可以建立多个不同的数据视图。<ul><li>buffer（必需）：视图对应的底层ArrayBuffer对象。</li><li>byteOffset（可选）：视图开始的字节序号，默认从0开始。</li><li>length（可选）：视图包含的数据个数，默认直到本段内存区域结束。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个8字节的ArrayBuffer</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="comment">// 创建一个指向b的Int32视图，开始于字节0，直到缓冲区的末尾 </span></span><br><span class="line"><span class="keyword">var</span> v1 = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(b);</span><br><span class="line"><span class="comment">// 创建一个指向b的Uint8视图，开始于字节2，直到缓冲区的末尾 </span></span><br><span class="line"><span class="keyword">var</span> v2 = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(b, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// 创建一个指向b的Int16视图，开始于字节2，长度为2 </span></span><br><span class="line"><span class="keyword">var</span> v3 = <span class="keyword">new</span> <span class="title class_">Int16Array</span>(b, <span class="number">2</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure></li></ul></li><li>TypedArray(length)。还可以通过直接 new 构造函数的方式直接使用。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fa64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(<span class="number">8</span>);</span><br><span class="line">fa64[<span class="number">0</span>] = <span class="number">10</span>;</span><br><span class="line">fa64[<span class="number">1</span>] = <span class="number">20</span>;</span><br><span class="line">fa64[<span class="number">2</span>] = fa64[<span class="number">0</span>] + fa64[<span class="number">1</span>];</span><br></pre></td></tr></table></figure></li><li>TypedArray(typedArray)。参数也可以是其他 typedArray。注意，此时生成的新数组，只是复制了参数数组的值，对应的底层内存是不一样的。新数组会开辟一段新的内存储存数据，不会在原数组的内存之上建立视图。如果想基于同一段内存，构造不同的视图，可以采用下面的写法。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> typedArray = <span class="keyword">new</span> <span class="title class_">Int8Array</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">4</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//理解如下</span></span><br><span class="line"><span class="keyword">var</span> x = <span class="keyword">new</span> <span class="title class_">Int8Array</span>([<span class="number">1</span>, <span class="number">1</span>]);</span><br><span class="line"><span class="keyword">var</span> y = <span class="keyword">new</span> <span class="title class_">Int8Array</span>(x);</span><br><span class="line">x[<span class="number">0</span>]</span><br><span class="line">y[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">x[<span class="number">0</span>] = <span class="number">2</span>;</span><br><span class="line">y[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果想基于同一段内存，构造不同的视图，可以采用下面的写法。</span></span><br><span class="line"><span class="keyword">var</span> x = <span class="keyword">new</span> <span class="title class_">Int8Array</span>([<span class="number">1</span>, <span class="number">1</span>]);</span><br><span class="line"><span class="keyword">var</span> y = <span class="keyword">new</span> <span class="title class_">Int8Array</span>(x.<span class="property">buffer</span>);</span><br><span class="line">x[<span class="number">0</span>]</span><br><span class="line">y[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">x[<span class="number">0</span>] = <span class="number">2</span>;</span><br><span class="line">y[<span class="number">0</span>]</span><br></pre></td></tr></table></figure></li><li>TypedArray(arrayLikeObject)。构造函数的参数也可以是一个普通数组，TypedArray 数组也可以转换回普通数组。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> typedArray = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]);</span><br><span class="line"><span class="keyword">var</span> normalArray = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(typedArray);</span><br></pre></td></tr></table></figure></li></ul><h4 id="BYTES-PER-ELEMENT-属性。"><a href="#BYTES-PER-ELEMENT-属性。" class="headerlink" title="BYTES_PER_ELEMENT 属性。"></a>BYTES_PER_ELEMENT 属性。</h4><p>每一种视图的构造函数，都有一个 BYTES_PER_ELEMENT 属性，表示这种数据类型占据的字节数。这个属性在 TypedArray 实例上也能获取，即有 TypedArray.prototype.BYTES_PER_ELEMENT。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Int8Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="title class_">Uint8Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="title class_">Int16Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="title class_">Uint16Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="title class_">Int32Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="title class_">Uint32Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="title class_">Float32Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="title class_">Float64Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br></pre></td></tr></table></figure><h4 id="TypedArray-原型属性"><a href="#TypedArray-原型属性" class="headerlink" title="TypedArray 原型属性"></a>TypedArray 原型属性</h4><ul><li>TypedArray.prototype.buffer。前面我们也用到了，返回整段内存区域对应的 ArrayBuffer 对象。该属性为只读属性。视图对象和 b 视图对象，对应同一个 ArrayBuffer 对象，即同一段内存。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title class_">Float32Array</span>(<span class="number">64</span>);</span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(a.<span class="property">buffer</span>);</span><br></pre></td></tr></table></figure></li><li>TypedArray.prototype.length。该属性表示 TypedArray 数组含有多少个成员。注意将 byteLength 属性和 length 属性区分，前者是字节长度，后者是成员长度。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title class_">Int16Array</span>(<span class="number">90</span>);</span><br><span class="line">a.<span class="property">length</span>            <span class="comment">// 90 </span></span><br><span class="line">a.<span class="property">byteLength</span>        <span class="comment">// 180</span></span><br></pre></td></tr></table></figure></li><li>TypedArray.prototype.byteLength，TypedArray.prototype.byteOffset。byteLength 属性返回 TypedArray 数组占据的内存长度，单位为字节。byteOffset 属性返回 TypedArray 数组从底层 ArrayBuffer 对象的哪个字节开始。这两个属性都是只读属性。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> v1 = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(b);</span><br><span class="line"><span class="keyword">var</span> v2 = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(b, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">var</span> v3 = <span class="keyword">new</span> <span class="title class_">Int16Array</span>(b, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">v1.<span class="property">byteLength</span>        <span class="comment">// 8</span></span><br><span class="line">v2.<span class="property">byteLength</span>        <span class="comment">// 6</span></span><br><span class="line">v3.<span class="property">byteLength</span>        <span class="comment">// 4</span></span><br><span class="line"></span><br><span class="line">v1.<span class="property">byteOffset</span>        <span class="comment">// 0</span></span><br><span class="line">v2.<span class="property">byteOffset</span>        <span class="comment">// 2</span></span><br><span class="line">v3.<span class="property">byteOffset</span>        <span class="comment">// 2</span></span><br></pre></td></tr></table></figure></li><li>TypedArray.prototype.set()。TypedArray 数组的 set 方法用于复制数组（普通数组或 TypedArray 数组），也就是将一段内容完全复制到另一段内存。set 方法还可以接受第二个参数，表示从 b 对象的哪一个成员开始复制 a 对象。它是整段内存的复制，比一个个拷贝成员的那种复制快得多。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title class_">Uint16Array</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title class_">Uint16Array</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">b.<span class="title function_">set</span>(a, <span class="number">2</span>)</span><br></pre></td></tr></table></figure></li><li>TypedArray.prototype.subarray()。subarray 方法是对于 TypedArray 数组的一部分，再建立一个新的视图。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title class_">Uint16Array</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> b = a.<span class="title function_">subarray</span>(<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">a.<span class="property">byteLength</span></span><br><span class="line">b.<span class="property">byteLength</span></span><br></pre></td></tr></table></figure></li><li>TypedArray.prototype.slice()。类似于数组的 slice 方法，可以返回一个指定位置的新的 TypedArray 实例。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ui8 = <span class="title class_">Uint8Array</span>.<span class="title function_">of</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">ui8.<span class="title function_">slice</span>(-<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li><li>TypedArray.of()。该方法用于将参数转为一个 TypedArray 实例。</li><li>TypedArray.from()。静态方法 from 接受一个可遍历的数据结构（比如数组）作为参数，返回一个基于这个结构的 TypedArray 实例。</li></ul><h4 id="溢出问题"><a href="#溢出问题" class="headerlink" title="溢出问题"></a>溢出问题</h4><p>有一种特殊的 Uint8ClampedArray 类型，凡是发生正向溢出，该值一律等于当前数据类型的最大值，即 255；如果发生负向溢出，该值一律等于当前数据类型的最小值，即 0。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> uint8c = <span class="keyword">new</span> <span class="title class_">Uint8ClampedArray</span>(<span class="number">1</span>);</span><br><span class="line">uint8c[<span class="number">0</span>] = <span class="number">256</span>;</span><br><span class="line">uint8c[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">uint8c[<span class="number">0</span>] = -<span class="number">1</span>;</span><br><span class="line">uint8c[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">而另外的其他类型，都会出现溢出情况，</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> int8 = <span class="keyword">new</span> <span class="title class_">Int8Array</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">int8[<span class="number">0</span>] = <span class="number">128</span>;</span><br><span class="line">int8[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">int8[<span class="number">0</span>] = -<span class="number">129</span>;</span><br><span class="line">int8[<span class="number">0</span>]</span><br></pre></td></tr></table></figure><h3 id="复合视图"><a href="#复合视图" class="headerlink" title="复合视图"></a>复合视图</h3><ul><li><p>由于视图的构造函数可以指定起始位置和长度，所以在同一段内存之中，可以依次存放不同类型的数据，这叫做 “复合视图”。下面代码将一个 24 字节长度的 ArrayBuffer 对象，分成三个部分，字节 0 到字节 3 是 1 个 32 位无符号整数，字节 4 到字节 19 是 16 个 8 位整数，字节 20 到字节 23 是 1 个 32 位浮点数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">24</span>);</span><br><span class="line"><span class="keyword">var</span> idView = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(buffer, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">var</span> usernameView = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buffer, <span class="number">4</span>, <span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> amountDueView = <span class="keyword">new</span> <span class="title class_">Float32Array</span>(buffer, <span class="number">20</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure></li><li><p>如果一段数据包括多种类型（比如服务器传来的 HTTP 数据），这时除了建立 ArrayBuffer 对象的复合视图以外，还可以通过 DataView 视图进行操作。 DataView 视图本身也是构造函数，接受一个 ArrayBuffer 对象作为参数，生成视图。</p></li><li><p>DataView(ArrayBuffer buffer [, 字节起始位置 [, 长度]]);</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">24</span>);</span><br><span class="line"><span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="title class_">DataView</span>(buffer);</span><br></pre></td></tr></table></figure></li><li><p>DataView 实例有以下属性，含义与 TypedArray 实例的同名方法相同。</p><ul><li>DataView.prototype.buffer：返回对应的 ArrayBuffer 对象</li><li>DataView.prototype.byteLength：返回占据的内存字节长度</li><li>DataView.prototype.byteOffset：返回当前视图从对应的 ArrayBuffer 对象的哪个字节开始</li></ul></li><li><p>DataView 实例提供 8 个方法读取内存。</p><ul><li>getInt8：读取 1 个字节，返回一个 8 位整数。</li><li>getUint8：读取 1 个字节，返回一个无符号的 8 位整数。</li><li>getInt16：读取 2 个字节，返回一个 16 位整数。</li><li>getUint16：读取 2 个字节，返回一个无符号的 16 位整数。</li><li>getInt32：读取 4 个字节，返回一个 32 位整数。</li><li>getUint32：读取 4 个字节，返回一个无符号的 32 位整数。</li><li>getFloat32：读取 4 个字节，返回一个 32 位浮点数。</li><li>getFloat64：读取 8 个字节，返回一个 64 位浮点数。</li></ul></li><li><p>这一系列 get 方法的参数都是一个字节序号（不能是负数，否则会报错），表示从哪个字节开始读取。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">24</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="title class_">DataView</span>(buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> v1 = dv.<span class="title function_">getUint8</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> v2 = dv.<span class="title function_">getUint16</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> v3 = dv.<span class="title function_">getUint16</span>(<span class="number">3</span>);</span><br></pre></td></tr></table></figure><p>如果一次读取两个或两个以上字节，就必须明确数据的存储方式，到底是小端字节序还是大端字节序。默认情况下，DataView 的 get 方法使用大端字节序解读数据，如果需要使用小端字节序解读，必须在 get 方法的第二个参数指定 true。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> v1 = dv.<span class="title function_">getUint16</span>(<span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> v2 = dv.<span class="title function_">getUint16</span>(<span class="number">3</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> v3 = dv.<span class="title function_">getUint16</span>(<span class="number">3</span>);</span><br></pre></td></tr></table></figure></li><li><p>DataView 视图提供 8 个方法写入内存。</p><ul><li>setInt8：写入 1 个字节的 8 位整数。</li><li>setUint8：写入 1 个字节的 8 位无符号整数。</li><li>setInt16：写入 2 个字节的 16 位整数。</li><li>setUint16：写入 2 个字节的 16 位无符号整数。</li><li>setInt32：写入 4 个字节的 32 位整数。</li><li>setUint32：写入 4 个字节的 32 位无符号整数。</li><li>setFloat32：写入 4 个字节的 32 位浮点数。</li><li>setFloat64：写入 8 个字节的 64 位浮点数。<br>这一系列 set 方法，接受两个参数，第一个参数是字节序号，表示从哪个字节开始写入，第二个参数为写入的数据。对于那些写入两个或两个以上字节的方法，需要指定第三个参数，false 或者 undefined 表示使用大端字节序写入，true 表示使用小端字节序写入。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dv.<span class="title function_">setInt32</span>(<span class="number">0</span>, <span class="number">25</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">dv.<span class="title function_">setInt32</span>(<span class="number">4</span>, <span class="number">25</span>);</span><br><span class="line"></span><br><span class="line">dv.<span class="title function_">setFloat32</span>(<span class="number">8</span>, <span class="number">2.5</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果不确定正在使用的计算机的字节序，可以采用下面的判断方式</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> littleEndian = (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">DataView</span>(buffer).<span class="title function_">setInt16</span>(<span class="number">0</span>, <span class="number">256</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Int16Array</span>(buffer)[<span class="number">0</span>] === <span class="number">256</span>;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;自我感觉一直对浏览器的二进制操作比,文件操作,以及其他的io读写等较迷糊。今天开个专场彻底搞清。&lt;/p&gt;
&lt;h3 id=&quot;blob&quot;&gt;&lt;a href=&quot;#blob&quot; class=&quot;headerlink&quot; title=&quot;blob&quot;&gt;&lt;/a&gt;blob&lt;/h3&gt;&lt;p&gt;Blob 对象表示一个不可变、原始数据的类文件对象。Blob 表示的不一定是JavaScript原生格式的数据。Blob对象本质上是js中的一个对象，里面可以储存大量的二进制编码格式的数据，&lt;strong&gt;我们不可以直接操作他&lt;/strong&gt;。&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
  </entry>
  
  <entry>
    <title>nuxt服务端的打包部署</title>
    <link href="https://tabbycute.github.io/2021/05/04/20210504nuxt%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E6%89%93%E5%8C%85%E9%83%A8%E7%BD%B2/"/>
    <id>https://tabbycute.github.io/2021/05/04/20210504nuxt%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E6%89%93%E5%8C%85%E9%83%A8%E7%BD%B2/</id>
    <published>2021-05-03T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.044Z</updated>
    
    <content type="html"><![CDATA[<blockquote><h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br><span class="line">npm run generat</span><br><span class="line"></span><br><span class="line">如果是想做ssr，那就npm run build，然后npm start把项目服务起起来就行了，</span><br><span class="line">如果只是想做静态页面，那就npm run generat，然后通过静态服务器部署</span><br><span class="line"></span><br><span class="line">server: &#123;</span><br><span class="line">  port: 3000, // default: 3000</span><br><span class="line">  host: &#x27;0.0.0.0&#x27; // 在服务器上监听所有</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">所以我采用</span><br><span class="line"></span><br><span class="line">npm run build</span><br><span class="line"></span><br><span class="line">打包过后的产物</span><br><span class="line"></span><br><span class="line">.nuxt</span><br><span class="line">static</span><br><span class="line">package.json</span><br><span class="line">nuxt.config.js</span><br></pre></td></tr></table></figure><blockquote><h4 id="服务器安装node"><a href="#服务器安装node" class="headerlink" title="服务器安装node"></a>服务器安装node</h4></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install nodejs npm -y</span><br><span class="line">node --version</span><br><span class="line">npm --version</span><br></pre></td></tr></table></figure><h4 id="更换npm淘宝源（可跳过）"><a href="#更换npm淘宝源（可跳过）" class="headerlink" title="更换npm淘宝源（可跳过）"></a>更换npm淘宝源（可跳过）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">全局配置切换到淘宝源：</span><br><span class="line">npm config set registry https://registry.npm.taobao.org</span><br><span class="line">全局配置切换到官方源：</span><br><span class="line">npm config set registry http://www.npmjs.org</span><br><span class="line">检测是否切换到了淘宝源：</span><br><span class="line">npm info underscore</span><br><span class="line"></span><br><span class="line">//安装依赖</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure><blockquote><h4 id="启动项目"><a href="#启动项目" class="headerlink" title="启动项目"></a>启动项目</h4></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run start</span><br></pre></td></tr></table></figure><blockquote><h4 id="使用pm2开启进程守护"><a href="#使用pm2开启进程守护" class="headerlink" title="使用pm2开启进程守护"></a>使用pm2开启进程守护</h4></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">npm install pm2 -g</span><br><span class="line">安装</span><br><span class="line">pm2 update</span><br><span class="line">更新版本</span><br><span class="line">pm2 list</span><br><span class="line">显示所有进程状态</span><br><span class="line">pm2 monit</span><br><span class="line">监视所有进程</span><br><span class="line">pm2 log</span><br><span class="line">显示所有进程日志</span><br><span class="line">pm2 stop all</span><br><span class="line">停止所有进程</span><br><span class="line">pm2 restart all</span><br><span class="line">重启所有进程</span><br><span class="line">pm2 reload all</span><br><span class="line">0 秒停机重载进程 (用于 NETWORKED 进程)</span><br><span class="line">pm2 stop name</span><br><span class="line">停止指定的进程，name为标识</span><br><span class="line">pm2 restart name</span><br><span class="line">重启指定的进程，name为标识</span><br><span class="line">pm2 startup</span><br><span class="line">产生 init 脚本 保持进程活着</span><br><span class="line">pm2 web</span><br><span class="line">运行健壮的 computer API endpoint (http://localhost:9615)</span><br><span class="line">pm2 delete name</span><br><span class="line">杀死指定的进程，name为标识</span><br><span class="line">pm2 delete all</span><br><span class="line">杀死全部进程</span><br></pre></td></tr></table></figure><blockquote><h4 id="运行项目"><a href="#运行项目" class="headerlink" title="运行项目"></a>运行项目</h4></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pm2 start npm --name &quot;app&quot; -- start</span><br><span class="line">//进入到博客运行目录下</span><br><span class="line">pm2 start npm --name blog -- start</span><br><span class="line">app是pm2的进程的名字</span><br></pre></td></tr></table></figure><p><img src="/assets/img/202209201102.png" alt="成功部署后如图"></p><blockquote><h4 id="访问项目"><a href="#访问项目" class="headerlink" title="访问项目"></a>访问项目</h4></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http</span>:<span class="comment">//106.52.222.26:3001</span></span><br><span class="line">这里的端口来源于</span><br><span class="line">nuxt.<span class="property">config</span>.<span class="property">json</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">server</span>: &#123; <span class="comment">// 部署到线上nginx配置</span></span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;0.0.0.0&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="number">3001</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：如果数据是直接访问的服务器json文件，json文件改变了过后，但是页面中请求数据未改变，重启下进程就好了 pm2 reload all。</p><p>举个栗子。他的vuex中，存在一个值(普通的值，不存在什么权限判断啥的)，项目部署的时候不存在，如果接口请求过一次，那么vuex中这个值就已经存在，其他的用户进入页面的时候就不需要请求。</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;h4 id=&quot;打包&quot;&gt;&lt;a href=&quot;#打包&quot; class=&quot;headerlink&quot; title=&quot;打包&quot;&gt;&lt;/a&gt;打包&lt;/h4&gt;&lt;/blockquote&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;npm run build&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm run generat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;如果是想做ssr，那就npm run build，然后npm start把项目服务起起来就行了，&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;如果只是想做静态页面，那就npm run generat，然后通过静态服务器部署&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;server: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  port: 3000, // default: 3000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  host: &amp;#x27;0.0.0.0&amp;#x27; // 在服务器上监听所有&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;所以我采用&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm run build&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;打包过后的产物&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.nuxt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;static&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;package.json&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nuxt.config.js&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;h4 id=&quot;服务器安装node&quot;&gt;&lt;a href=&quot;#服务器安装node&quot; class=&quot;headerlink&quot; title=&quot;服务器安装node&quot;&gt;&lt;/a&gt;服务器安装node&lt;/h4&gt;&lt;/blockquote&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="nuxtjs" scheme="https://tabbycute.github.io/tags/nuxtjs/"/>
    
    <category term="vue" scheme="https://tabbycute.github.io/tags/vue/"/>
    
  </entry>
  
</feed>
