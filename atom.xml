<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>TabbyBlog</title>
  
  <subtitle>TabbyBlog的个人主页和一些技术博客的分享。</subtitle>
  <link href="https://tabbycute.github.io/atom.xml" rel="self"/>
  
  <link href="https://tabbycute.github.io/"/>
  <updated>2023-02-02T12:16:53.286Z</updated>
  <id>https://tabbycute.github.io/</id>
  
  <author>
    <name>TabbyBlog</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>flutter通过本地服务访问静态文件</title>
    <link href="https://tabbycute.github.io/2023/02/02/20230202flutter%E9%80%9A%E8%BF%87%E6%9C%AC%E5%9C%B0%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6/"/>
    <id>https://tabbycute.github.io/2023/02/02/20230202flutter%E9%80%9A%E8%BF%87%E6%9C%AC%E5%9C%B0%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6/</id>
    <published>2023-02-01T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.286Z</updated>
    
    <content type="html"><![CDATA[<p>最近遇到一个需求，给我一个h5的页面，让我直接放在app内，用webview静态访问。</p><p>这个需求本身没什么问题，但是他这个项目比较特殊是个three.js搞得任务模型，双击在浏览器打开直接就报错。</p><p>因为这个项目需要使用本地服务启动！通过本地服务来访问路径</p><p>准备三个包</p><blockquote><p>jaguar_flutter_asset: ^3.0.0      开启本地服务<br>webview_flutter: ^4.0.2        webview<br>dio: ^4.0.6                    网络访问。测试用！</p></blockquote><h3 id="注册静态文件"><a href="#注册静态文件" class="headerlink" title="注册静态文件"></a>注册静态文件</h3><p>把项目拷贝的到项目的静态目录下，并且在pubspec.yaml中注册这个项目<strong>所有的文件夹</strong>是所有的！！！否则你的项目可能会跑不起来！！！一定要是所有</p><img src="/assets/img/202302021.png" alt="目录示例" class="cImgSizeWS50"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> assets:</span><br><span class="line">...</span><br><span class="line">   - assets/web/models/</span><br><span class="line">   - assets/web/models/obj/</span><br><span class="line">   - assets/web/models/obj/male02/</span><br><span class="line">...</span><br></pre></td></tr></table></figure><blockquote><p>实际项目，目录是很多的，层级也多，手动写，难免丢失，我是用的shell脚本遍历生成的</p></blockquote><h3 id="页面使用"><a href="#页面使用" class="headerlink" title="页面使用"></a>页面使用</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHomePage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> MyHomePage(&#123;Key? key, <span class="keyword">required</span> <span class="keyword">this</span>.title&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> title;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyHomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyHomePage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">void</span> loadData() <span class="keyword">async</span>&#123;</span><br><span class="line">    <span class="keyword">final</span> server = Jaguar(address:<span class="string">&quot;127.0.0.1&quot;</span>,port: <span class="number">8000</span>);</span><br><span class="line">    server.addRoute(serveFlutterAssets());</span><br><span class="line">    <span class="keyword">await</span> server.serve(logRequests: <span class="keyword">true</span>);</span><br><span class="line">    server.log.onRecord.listen((r) =&gt; <span class="built_in">print</span>(r));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> Future.delayed(<span class="built_in">Duration</span>(seconds: <span class="number">1</span>));</span><br><span class="line">    <span class="comment">///<span class="language-markdown">测试用</span></span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> response = <span class="keyword">await</span> Dio().<span class="keyword">get</span>(<span class="string">&#x27;http://127.0.0.1:8000/web/webgl_loader_obj_mtl.html&#x27;</span>);</span><br><span class="line">      <span class="built_in">print</span>(response);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="built_in">print</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    loadView();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  WebViewController? controller;</span><br><span class="line"></span><br><span class="line">  loadView()<span class="keyword">async</span>&#123;</span><br><span class="line">    controller=WebViewController()</span><br><span class="line">    ..setJavaScriptMode(JavaScriptMode.unrestricted)</span><br><span class="line">    ..setBackgroundColor(<span class="keyword">const</span> Color(<span class="number">0x00000000</span>))</span><br><span class="line">    ..loadRequest(<span class="built_in">Uri</span>.parse(<span class="string">&#x27;http://127.0.0.1:8000/web/webgl_loader_obj_mtl.html&#x27;</span>));</span><br><span class="line">    setState(() &#123;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> implement initState</span></span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    loadData();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body:controller==null?Container():WebViewWidget(controller: controller!),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我测试的是安卓平台（公司的测试机！真机！）！现在访问页面访问不了，用dio请求下看看能否拿到页面，结果如下：</p><img src="/assets/img/202302022.png" alt="dio请求结果" class="cImgSizeWS50"><p>然后我怀疑是<a href="http://127.0.0.1:8000这个地址的原因，查了一下果然">http://127.0.0.1:8000这个地址的原因，查了一下果然</a>~</p><h4 id="安卓配置"><a href="#安卓配置" class="headerlink" title="安卓配置"></a>安卓配置</h4><ul><li>在下创建/android/app/src/main/res/xml/network_security_config.xml文件，填上配置内容：</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">network-security-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">base-config</span> <span class="attr">cleartextTrafficPermitted</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">trust-anchors</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">certificates</span> <span class="attr">src</span>=<span class="string">&quot;system&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">certificates</span> <span class="attr">src</span>=<span class="string">&quot;user&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">trust-anchors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">base-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network-security-config</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>修改android/app/src/main/AndroidManifest.xml，在application节点加入以下两个属性即可：</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;demoimg&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;$&#123;applicationName&#125;&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">&lt;!<span class="attr">--添加如下--</span>&gt;</span></span><br><span class="line">        android:usesCleartextTraffic=&quot;true&quot;</span><br><span class="line">        android:networkSecurityConfig=&quot;@xml/network_security_config&quot;</span><br><span class="line"></span><br><span class="line">        android:icon=&quot;@mipmap/ic_launcher&quot;&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br></pre></td></tr></table></figure><p>重新访问OK。ios未知！！！</p><img src="/assets/img/202302023.png" alt="" class="cImgSizeWS50">]]></content>
    
    
    <summary type="html">&lt;p&gt;最近遇到一个需求，给我一个h5的页面，让我直接放在app内，用webview静态访问。&lt;/p&gt;
&lt;p&gt;这个需求本身没什么问题，但是他这个项目比较特殊是个three.js搞得任务模型，双击在浏览器打开直接就报错。&lt;/p&gt;
&lt;p&gt;因为这个项目需要使用本地服务启动！通过本地服务来访问路径&lt;/p&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
  <entry>
    <title>某众点评的商户数据爬取</title>
    <link href="https://tabbycute.github.io/2023/01/30/20230130%E6%9F%90%E4%BC%97%E7%82%B9%E8%AF%84%E7%9A%84%E5%95%86%E6%88%B7%E6%95%B0%E6%8D%AE%E7%88%AC%E5%8F%96/"/>
    <id>https://tabbycute.github.io/2023/01/30/20230130%E6%9F%90%E4%BC%97%E7%82%B9%E8%AF%84%E7%9A%84%E5%95%86%E6%88%B7%E6%95%B0%E6%8D%AE%E7%88%AC%E5%8F%96/</id>
    <published>2023-01-29T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.286Z</updated>
    
    <content type="html"><![CDATA[<p>最近需要获取某众点评的商户数据需求就是搜索某个分类，然后获取每家店的电话地址服务评分等等各种信息；</p><p>选择地区，登录，在网站里面拿token，uuid，cookie什么的就不过多赘述；</p><p>这里只是演示分析过程实际使用根据自己需求更改，请求过多可能会导致部分接口暂时性无法访问；</p><p>前提部分准备</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Fileds = <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>)<span class="comment">///商家结果分页列表错误的集合</span></span><br><span class="line"><span class="keyword">var</span> ShopIdList = <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>)<span class="comment">///商家id集合</span></span><br><span class="line"><span class="keyword">var</span> ShopInfo = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)<span class="comment">///商家信息结果：店铺名称，类型，地址，电话，营业时间，其他...</span></span><br><span class="line"><span class="keyword">var</span> ShopPrice = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)<span class="comment">///商家信息结果：星级，评分，评论数量，人均价格，其他...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="comment">///搜索商家结果分页列表</span></span><br><span class="line"><span class="keyword">const</span> url = <span class="string">&quot;https://www.dianping.com/search/keyword/3/0_%E5%AE%A0%E7%89%A9/o3&quot;</span></span><br><span class="line"><span class="keyword">const</span> token = <span class="string">&quot;&quot;</span><span class="comment">///用户token</span></span><br><span class="line"><span class="keyword">const</span> uuid = <span class="string">&quot;uuid&quot;</span><span class="comment">///用户uuid</span></span><br><span class="line"><span class="keyword">const</span> cityId = <span class="string">&quot;3&quot;</span><span class="comment">///城市id</span></span><br><span class="line"><span class="keyword">const</span> mainCategoryId = <span class="string">&quot;25147&quot;</span><span class="comment">///分类id</span></span><br><span class="line"><span class="keyword">const</span> cookie = <span class="string">&quot;cookie&quot;</span><span class="comment">///用户cookie</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RequestPage</span><span class="params">(u <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">req, _ := http.NewRequest(<span class="string">&quot;GET&quot;</span>, u, <span class="literal">nil</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Cookie&quot;</span>, cookie)</span><br><span class="line">req.Header.Set(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;*/*&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Host&quot;</span>, <span class="string">&quot;www.dianping.com&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept-Encoding&quot;</span>, <span class="string">&quot;gzip, deflate, br&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;keep-alive&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-mobile&quot;</span>, <span class="string">&quot;?0&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-platform&quot;</span>, <span class="string">&quot;Windows&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Dest&quot;</span>, <span class="string">&quot;document&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Mode&quot;</span>, <span class="string">&quot;navigate&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Site&quot;</span>, <span class="string">&quot;same-origin&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-User&quot;</span>, <span class="string">&quot;?1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua&quot;</span>, <span class="string">`Not_A Brand;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;109&quot;, &quot;Chromium&quot;;v=109`</span>)</span><br><span class="line"></span><br><span class="line">resp, err := (&amp;http.Client&#123;&#125;).Do(req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">///可能会乱码，所以还是判断下好的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bodyReader io.Reader</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> resp.Header.Get(<span class="string">&quot;Content-Encoding&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;gzip&quot;</span>:</span><br><span class="line">bodyReader, err = gzip.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;deflate&quot;</span>:</span><br><span class="line">bodyReader = flate.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">bodyReader = resp.Body</span><br><span class="line">&#125;</span><br><span class="line">respByte, _ := ioutil.ReadAll(bodyReader)</span><br><span class="line">fmt.Println(<span class="type">string</span>(respByte))</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(respByte) &gt; <span class="number">150000</span> &#123;</span><br><span class="line">GetShopIdSlice(respByte[<span class="number">150000</span>:])</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">Fileds=<span class="built_in">append</span>(Fileds,u)</span><br><span class="line">wg.Done()</span><br><span class="line">fmt.Println(u + <span class="string">&quot;错误&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Find</span><span class="params">(slice []<span class="type">string</span>, val <span class="type">string</span>)</span></span> (<span class="type">int</span>, <span class="type">bool</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> i, item := <span class="keyword">range</span> slice &#123;</span><br><span class="line"><span class="keyword">if</span> item == val &#123;</span><br><span class="line"><span class="keyword">return</span> i, <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetShopIdSlice</span><span class="params">(data []<span class="type">byte</span>)</span></span> &#123;</span><br><span class="line">re, _ := regexp.Compile(<span class="string">`&quot;[A-Za-z0-9]&#123;16&#125;&quot;`</span>)</span><br><span class="line">all := re.FindAll(data, <span class="number">-1</span>)</span><br><span class="line"><span class="keyword">for</span> _, bytes := <span class="keyword">range</span> all &#123;</span><br><span class="line">key := strings.Replace(<span class="type">string</span>(bytes), <span class="string">`&quot;`</span>, <span class="string">``</span>, <span class="number">-1</span>)</span><br><span class="line">fmt.Println(key)</span><br><span class="line"><span class="keyword">if</span> _, found := Find(ShopIdList, key); !found &#123;</span><br><span class="line">ShopIdList = <span class="built_in">append</span>(ShopIdList, key)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetShopInfo</span><span class="params">(id <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">curl := fmt.Sprintf(<span class="string">&quot;https://www.dianping.com/ajax/json/shopDynamic/basicHideInfo?shopId=%v&amp;_token=%v&amp;uuid=%v&amp;platform=1&amp;partner=150&amp;optimusCode=10&amp;originUrl=https://www.dianping.com/shop/%v&quot;</span>, id, token, uuid, id)</span><br><span class="line"></span><br><span class="line">req, _ := http.NewRequest(<span class="string">&quot;GET&quot;</span>, curl, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">req.Header.Set(<span class="string">&quot;Cookie&quot;</span>, cookie)</span><br><span class="line">req.Header.Set(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;*/*&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Host&quot;</span>, <span class="string">&quot;www.dianping.com&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept-Encoding&quot;</span>, <span class="string">&quot;gzip, deflate, br&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;keep-alive&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-mobile&quot;</span>, <span class="string">&quot;?0&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-platform&quot;</span>, <span class="string">&quot;Windows&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Dest&quot;</span>, <span class="string">&quot;document&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Mode&quot;</span>, <span class="string">&quot;navigate&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Site&quot;</span>, <span class="string">&quot;same-origin&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-User&quot;</span>, <span class="string">&quot;?1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua&quot;</span>, <span class="string">`Not_A Brand;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;109&quot;, &quot;Chromium&quot;;v=109`</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//req.Header.Set(&quot;Content-Length&quot;, &quot;231&quot;)</span></span><br><span class="line"></span><br><span class="line">resp, err := (&amp;http.Client&#123;&#125;).Do(req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;错误--&quot;</span>,id)</span><br><span class="line">wg.Done()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">///可能会乱码，所以还是判断下好的</span></span><br><span class="line"><span class="keyword">var</span> bodyReader io.Reader</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> resp.Header.Get(<span class="string">&quot;Content-Encoding&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;gzip&quot;</span>:</span><br><span class="line">bodyReader, err = gzip.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;deflate&quot;</span>:</span><br><span class="line">bodyReader = flate.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">bodyReader = resp.Body</span><br><span class="line">&#125;</span><br><span class="line">respByte, _ := ioutil.ReadAll(bodyReader)</span><br><span class="line">ShopInfo[id] = <span class="type">string</span>(respByte)</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetShopPrice</span><span class="params">(id <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">curl := fmt.Sprintf(<span class="string">&quot;https://www.dianping.com/ajax/json/shopDynamic/reviewAndStar?shopId=%v&amp;cityId=%v&amp;mainCategoryId=%v&amp;_token=%v&amp;uuid=%v&amp;platform=1&amp;partner=150&amp;optimusCode=10&amp;originUrl=https://www.dianping.com/shop/%v&quot;</span>,</span><br><span class="line">id,</span><br><span class="line">cityId,</span><br><span class="line">mainCategoryId,</span><br><span class="line">token,</span><br><span class="line">uuid,</span><br><span class="line">id)</span><br><span class="line"></span><br><span class="line">fmt.Println(curl)</span><br><span class="line"></span><br><span class="line">req, _ := http.NewRequest(<span class="string">&quot;GET&quot;</span>, curl, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">req.Header.Set(<span class="string">&quot;Cookie&quot;</span>, cookie)</span><br><span class="line">req.Header.Set(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;*/*&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Host&quot;</span>, <span class="string">&quot;www.dianping.com&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept-Encoding&quot;</span>, <span class="string">&quot;gzip, deflate, br&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;keep-alive&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-mobile&quot;</span>, <span class="string">&quot;?0&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-platform&quot;</span>, <span class="string">&quot;Windows&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Dest&quot;</span>, <span class="string">&quot;document&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Mode&quot;</span>, <span class="string">&quot;navigate&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Site&quot;</span>, <span class="string">&quot;same-origin&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-User&quot;</span>, <span class="string">&quot;?1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua&quot;</span>, <span class="string">`Not_A Brand;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;109&quot;, &quot;Chromium&quot;;v=109`</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//req.Header.Set(&quot;Content-Length&quot;, &quot;231&quot;)</span></span><br><span class="line"></span><br><span class="line">resp, err := (&amp;http.Client&#123;&#125;).Do(req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;错误--&quot;</span>,id)</span><br><span class="line">wg.Done()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">///可能会乱码，所以还是判断下好的</span></span><br><span class="line"><span class="keyword">var</span> bodyReader io.Reader</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> resp.Header.Get(<span class="string">&quot;Content-Encoding&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;gzip&quot;</span>:</span><br><span class="line">bodyReader, err = gzip.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;deflate&quot;</span>:</span><br><span class="line">bodyReader = flate.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">bodyReader = resp.Body</span><br><span class="line">&#125;</span><br><span class="line">respByte, _ := ioutil.ReadAll(bodyReader)</span><br><span class="line">ShopPrice[id] = <span class="type">string</span>(respByte)</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///存储结果json</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetInfoFile</span><span class="params">(filePath <span class="type">string</span>, t <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">file, err := os.OpenFile(filePath, os.O_WRONLY|os.O_CREATE, <span class="number">0666</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;文件打开失败&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//及时关闭file句柄</span></span><br><span class="line"><span class="keyword">defer</span> file.Close()</span><br><span class="line"><span class="comment">//写入文件时，使用带缓存的 *Writer</span></span><br><span class="line">write := bufio.NewWriter(file)</span><br><span class="line">write.WriteString(<span class="string">&quot;&#123; \n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> t &#123;</span><br><span class="line"><span class="keyword">if</span> strings.HasPrefix(v,<span class="string">&quot;&lt;html&gt;&quot;</span>)&#123;</span><br><span class="line">data := fmt.Sprintf(<span class="string">&quot;\&quot;%v\&quot;:%v,\n&quot;</span>, k, <span class="string">`&#123;&quot;msg&quot;:&quot;403 Forrbiden&quot;&#125;`</span>)</span><br><span class="line">write.WriteString(data)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">data := fmt.Sprintf(<span class="string">&quot;\&quot;%v\&quot;:%v,\n&quot;</span>, k, v)</span><br><span class="line">write.WriteString(data)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">write.WriteString(<span class="string">&quot;&#125; \n&quot;</span>)</span><br><span class="line"><span class="comment">//Flush将缓存的文件真正写入到文件中</span></span><br><span class="line">write.Flush()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///存储店铺id和失败的店铺url</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetInfoFile2</span><span class="params">(filePath <span class="type">string</span>, t []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">file, err := os.OpenFile(filePath, os.O_WRONLY|os.O_CREATE, <span class="number">0666</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;文件打开失败&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//及时关闭file句柄</span></span><br><span class="line"><span class="keyword">defer</span> file.Close()</span><br><span class="line"><span class="comment">//写入文件时，使用带缓存的 *Writer</span></span><br><span class="line">write := bufio.NewWriter(file)</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> t &#123;</span><br><span class="line">data := fmt.Sprintf(<span class="string">&quot;%v\n&quot;</span>,v)</span><br><span class="line">write.WriteString(data)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Flush将缓存的文件真正写入到文件中</span></span><br><span class="line">write.Flush()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>token,uuid,cityId,mainCategoryId,cookie可在<strong><a href="https://www.dianping.com/ajax/json/shopDynamic/reviewAndStar">https://www.dianping.com/ajax/json/shopDynamic/reviewAndStar</a></strong>参数获取</p></blockquote><p>下面开始部分步骤</p><ul><li>搜索某个分类收集所有商户的id（需要cookie），并写入到本地文件</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">main()&#123;</span><br><span class="line">wg.Add(<span class="number">50</span>)</span><br><span class="line">RequestPage(url)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">2</span>; i &lt; <span class="number">51</span>; i++ &#123;</span><br><span class="line">urll := fmt.Sprintf(<span class="string">&quot;%vp%v&quot;</span>, url, i)</span><br><span class="line">RequestPage(urll)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">SetInfoFile2(<span class="string">&quot;./ShopIdList.txt&quot;</span>,ShopIdList)</span><br><span class="line">SetInfoFile2(<span class="string">&quot;./Fileds.txt&quot;</span>,Fileds)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///ShopIdList 内为下格式</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">k7iqTA5NY3wKmZt6</span></span><br><span class="line"><span class="comment">k6MAqHVYeFjSSlHy</span></span><br><span class="line"><span class="comment">G8ir506MAEWwZTha</span></span><br><span class="line"><span class="comment">l4Z2t8wfoLfTBe66</span></span><br><span class="line"><span class="comment">l4xW5fnwhEUwarXb</span></span><br><span class="line"><span class="comment">l3oH7kNLYmaqIjQy</span></span><br><span class="line"><span class="comment">l3i0yhjr2vYIlIgG</span></span><br><span class="line"><span class="comment">Ga6HlnZT8cD8LGLn</span></span><br><span class="line"><span class="comment">k3zNWxI6HirLcY5P</span></span><br><span class="line"><span class="comment">H7EHl8np2n0SdI1g</span></span><br><span class="line"><span class="comment">GaPMQLKeBPOhEV8a</span></span><br><span class="line"><span class="comment">H1gT7NAaoUUvem6g</span></span><br><span class="line"><span class="comment">l5NBYrCIEaMVi8s4</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><ul><li>获取商家的各种信息</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">fi, err := os.Open(<span class="string">&quot;./ShopIdList.txt&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Error: %s\n&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> fi.Close()</span><br><span class="line"></span><br><span class="line">br := bufio.NewReader(fi)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">a, _, c := br.ReadLine()</span><br><span class="line"><span class="keyword">if</span> c == io.EOF &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">ShopIdList=<span class="built_in">append</span>(ShopIdList,<span class="type">string</span>(a))</span><br><span class="line"><span class="comment">//fmt.Println(string(a))</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;当前共有店铺：&quot;</span>,<span class="built_in">len</span>(ShopIdList))</span><br><span class="line">time.Sleep(time.Second*<span class="number">2</span>)</span><br><span class="line"><span class="comment">//测试一下，获取部分信息</span></span><br><span class="line"><span class="comment">//下面这个会出现非并发安全的错误，使用读写锁就好了，我这里只是测试一下能否获取数据</span></span><br><span class="line">a:=ShopIdList[:<span class="number">30</span>]</span><br><span class="line">wg.Add(<span class="built_in">len</span>(a)*<span class="number">2</span>)</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> a &#123;</span><br><span class="line"><span class="keyword">go</span> GetShopPrice(v)</span><br><span class="line"><span class="keyword">go</span> GetShopInfo(v)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">time.Sleep(time.Second*<span class="number">2</span>)</span><br><span class="line">SetInfoFile(<span class="string">&quot;./Ainfo.json&quot;</span>, ShopInfo)</span><br><span class="line">SetInfoFile(<span class="string">&quot;./Aprice.json&quot;</span>, ShopPrice)</span><br></pre></td></tr></table></figure><p>结果展示</p><img src="/assets/img/202301301.png" alt="Aprice.json" class="cImgSizeWS50"><img src="/assets/img/202301302.png" alt="Ainfo.json" class="cImgSizeWS50"><p>问题来了他的部分信息是html标签和一些代码</p><p>在网页审查他的元素</p><img src="/assets/img/202301303.png" ><p>原来是用了字体文件怪不得，网页复制都是乱码的</p><img src="/assets/img/202301304.png" alt="woff"><p>解决下载网页中所有的woff文件，然后把上面的json文件引入到html中循环展示，写点样式，就可以查看了</p><p>完结！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近需要获取某众点评的商户数据需求就是搜索某个分类，然后获取每家店的电话地址服务评分等等各种信息；&lt;/p&gt;
&lt;p&gt;选择地区，登录，在网站里面拿token，uuid，cookie什么的就不过多赘述；&lt;/p&gt;
&lt;p&gt;这里只是演示分析过程实际使用根据自己需求更改，请求过多可能会导致部分接口暂时性无法访问；&lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://tabbycute.github.io/categories/golang/"/>
    
    
    <category term="golang" scheme="https://tabbycute.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>imgly超强编辑器在flutter中的简单使用</title>
    <link href="https://tabbycute.github.io/2022/12/10/20221210imgly%E8%B6%85%E5%BC%BA%E5%9B%BE%E7%89%87%E7%BC%96%E8%BE%91%E8%A7%86%E9%A2%91%E7%BC%96%E8%BE%91%E5%88%9B%E6%84%8F%E7%BC%96%E8%BE%91%E4%BD%BF%E7%94%A8/"/>
    <id>https://tabbycute.github.io/2022/12/10/20221210imgly%E8%B6%85%E5%BC%BA%E5%9B%BE%E7%89%87%E7%BC%96%E8%BE%91%E8%A7%86%E9%A2%91%E7%BC%96%E8%BE%91%E5%88%9B%E6%84%8F%E7%BC%96%E8%BE%91%E4%BD%BF%E7%94%A8/</id>
    <published>2022-12-09T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.285Z</updated>
    
    <content type="html"><![CDATA[<p>先给出官网： <a href="https://img.ly/">https://img.ly/</a></p><p>flutter插件地址： <a href="https://pub.flutter-io.cn/packages/photo_editor_sdk">https://pub.flutter-io.cn/packages/photo_editor_sdk</a></p><p>下面开始集成（会需要一个选择图片的插件，这个自己解决，或者使用静态文件）</p><ul><li>通过打开 android/build.gradle 文件（不是 android/app/build.gradle）并更改以下块来添加 img.ly 存储库和插件：</li></ul><blockquote><p>为了更新适用于 Android 的 PhotoEditor SDK，请将版本字符串 10.3.1 替换为较新的版本。</p><p>如果版本和你pub的版本不对可能会报错，根据报错的版本来修改下面的插件版本就好了，去查看changelog</p></blockquote><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">-   ext.kotlin_version = <span class="string">&#x27;1.3.50&#x27;</span></span><br><span class="line">+   ext.kotlin_version = <span class="string">&#x27;1.5.32&#x27;</span> <span class="comment">// Minimum version.</span></span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        mavenCentral()</span><br><span class="line">+       maven &#123; url <span class="string">&quot;https://artifactory.img.ly/artifactory/imgly&quot;</span> &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">+       <span class="keyword">classpath</span> <span class="string">&#x27;ly.img.android.sdk:plugin:10.4.1&#x27;</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>仍然在 android/build.gradle 文件（不是 android/app/build.gradle）中，在底部添加这些行：</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        maven &#123; url <span class="string">&#x27;https://artifactory.img.ly/artifactory/imgly&#x27;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>android/build.gradle 完整配置如下</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    ext.kotlin_version = <span class="string">&#x27;1.6.10&#x27;</span></span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">        maven &#123; url <span class="string">&quot;https://artifactory.img.ly/artifactory/imgly&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;com.android.tools.build:gradle:7.1.2&#x27;</span></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;ly.img.android.sdk:plugin:10.4.1&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">        maven &#123; url <span class="string">&#x27;https://artifactory.img.ly/artifactory/imgly&#x27;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在 android/app/build.gradle 文件（不是 android/build.gradle）中，您需要将 minSdkVersion 修改为至少 21。我们还建议将 buildToolsVersion 更新为 31.0.0 或更高版本，并将 compileSdkVersion 更新为 31 或更高</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">compileSdkVersion <span class="number">33</span></span><br><span class="line">ndkVersion flutter.ndkVersion</span><br><span class="line">buildToolsVersion <span class="string">&quot;31.0.0&quot;</span></span><br><span class="line"></span><br><span class="line">compileOptions &#123;</span><br><span class="line"><span class="keyword">sourceCompatibility</span> JavaVersion.VERSION_1_8</span><br><span class="line"><span class="keyword">targetCompatibility</span> JavaVersion.VERSION_1_8</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">defaultConfig &#123;</span><br><span class="line">applicationId <span class="string">&quot;com.example.demoimg&quot;</span></span><br><span class="line">minSdkVersion <span class="number">22</span></span><br><span class="line">targetSdkVersion flutter.targetSdkVersion</span><br><span class="line">versionCode flutterVersionCode.<span class="keyword">toInteger</span>()</span><br><span class="line">versionName flutterVersionName</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>在同一个文件中，通过在应用插件下添加以下行来配置适用于 Android 的 PhotoEditor SDK</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> flutterVersionName = localProperties.getProperty(<span class="string">&#x27;flutter.versionName&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> (flutterVersionName == <span class="keyword">null</span>) &#123;</span><br><span class="line">    flutterVersionName = <span class="string">&#x27;1.0&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply plugin: <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line">apply plugin: <span class="string">&#x27;kotlin-android&#x27;</span></span><br><span class="line">apply <span class="keyword">from</span>: <span class="string">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///添加如下部分</span></span><br><span class="line">apply plugin: <span class="string">&#x27;ly.img.android.sdk&#x27;</span></span><br><span class="line">apply plugin: <span class="string">&#x27;kotlin-android&#x27;</span></span><br><span class="line">apply <span class="keyword">from</span>: <span class="string">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br><span class="line">imglyConfig &#123;</span><br><span class="line">    modules &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:text&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:focus&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:frame&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:brush&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:filter&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:sticker&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:overlay&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:transform&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:adjustment&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:text-design&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// This module is big, remove the serializer if you don&#x27;t need that feature.</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;backend:serializer&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remove the asset packs you don&#x27;t need, these are also big in size.</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:font-basic&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:frame-basic&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:filter-basic&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:overlay-basic&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:sticker-shapes&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:sticker-emoticons&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;backend:sticker-smart&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;backend:background-removal&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>flutter 使用</li></ul><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">获取一个图片</span></span></span><br><span class="line"><span class="keyword">final</span> <span class="built_in">List</span>&lt;AssetEntity&gt;? result = <span class="keyword">await</span> AssetPicker.pickAssets(context);</span><br><span class="line"><span class="built_in">print</span>(result?.first.relativePath);</span><br><span class="line"><span class="keyword">if</span>(result==<span class="keyword">null</span>)<span class="keyword">return</span>;</span><br><span class="line">File? f=<span class="keyword">await</span> result.first.file;</span><br><span class="line"><span class="keyword">if</span>(f==<span class="keyword">null</span>)<span class="keyword">return</span>;</span><br><span class="line"><span class="built_in">print</span>(f.path);</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">解除水印，免费版是有水印的，需要购买获取证书</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将不带扩展名的文件路径传递给unlockWithLicense函数以解锁 iOS 和 Android：</span></span><br><span class="line">PESDK.unlockWithLicense(<span class="string">&quot;assets/pesdk_license&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">传入一个图片地址</span></span></span><br><span class="line">PESDK.openEditor(image:f.path);</span><br></pre></td></tr></table></figure><img src="/assets/img/202212101.gif" alt="效果展示">]]></content>
    
    
    <summary type="html">&lt;p&gt;先给出官网： &lt;a href=&quot;https://img.ly/&quot;&gt;https://img.ly/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;flutter插件地址： &lt;a href=&quot;https://pub.flutter-io.cn/packages/photo_editor_sdk&quot;&gt;https://pub.flutter-io.cn/packages/photo_editor_sdk&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;下面开始集成（会需要一个选择图片的插件，这个自己解决，或者使用静态文件）&lt;/p&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
  <entry>
    <title>图片选择和图片编辑插件魔改以及iOS打包问题的解决</title>
    <link href="https://tabbycute.github.io/2022/12/05/20221205flutter%E6%8F%92%E4%BB%B6%E5%90%88%E5%B9%B6/"/>
    <id>https://tabbycute.github.io/2022/12/05/20221205flutter%E6%8F%92%E4%BB%B6%E5%90%88%E5%B9%B6/</id>
    <published>2022-12-04T16:00:00.000Z</published>
    <updated>2023-01-16T15:22:22.557Z</updated>
    
    <content type="html"><![CDATA[<p>最近在项目遇见一个需求，是选择图片。于是我在pub上面找了这款<a href="https://pub.flutter-io.cn/packages/wechat_assets_picker">仿微信图片视频选择插件</a>感觉还挺好的~</p><p>经过上线之后老板觉得不方便，微信比起来不能编辑图片，于是我有找了另一款<a href="https://pub.flutter-io.cn/packages/image_editor_dove">编辑图片的插件</a></p><p>现在好了，编辑图片和选择图片的功能都有了，但是他并不能像微信选择图片的那样在预览的时候编辑图片。没办法，只能硬着头皮在现在插件上改了。</p><div class="cImgBoxCenter"><img src="/assets/img/202212051.jpg" class="cImgSizeW325" alt="仿微信图片视频选择插件"><img src="/assets/img/202212052.gif" class="cImgSizeW325" alt="编辑图片的插件"></div><h3 id="集成插件"><a href="#集成插件" class="headerlink" title="集成插件"></a>集成插件</h3><p>要改代码我们需要把插件静态集成到我们的项目中。</p><p>首先在我们需要在本地找到插件需要在flutter的SDK目录下<strong>\.pub-cache\hosted\pub.dartlang.org</strong>找到我们的插件wechat_assets_picker-7.3.4（什么版本看你自己）</p><p>修改之前</p><p><img src="/assets/img/202212053.png"></p><p>修改之后</p><div class="cImgBoxCenter"><img src="/assets/img/202212054.png" alt=""><img src="/assets/img/202212055.png" alt=""></div><h3 id="使用插件"><a href="#使用插件" class="headerlink" title="使用插件"></a>使用插件</h3><p>在plugins/wechat_assets_picker****/pubspec.yaml中添加插件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">extended_image:</span> <span class="string">^6.2.0</span></span><br><span class="line"><span class="attr">photo_manager:</span> <span class="string">^2.1.4</span></span><br><span class="line"><span class="attr">provider:</span> <span class="string">^6.0.2</span></span><br><span class="line"><span class="attr">video_player:</span> <span class="string">^2.4.0</span></span><br><span class="line"><span class="attr">image_editor_dove:</span> <span class="string">^0.0.2</span></span><br></pre></td></tr></table></figure><p>修改代码第一个位置，需要添加一个按钮，在<strong>lib/src/delegates/asset_picker_viewer_builder_delegate.dart</strong>文件中对**Widget selectButton(BuildContext context)**次函数做如下修改</p><h5 id="进入编辑页面"><a href="#进入编辑页面" class="headerlink" title="进入编辑页面"></a>进入编辑页面</h5><ul><li>预览大图页面-&gt;图片编辑页面</li></ul><h5 id="编辑页面返回（这里是我的业务需求）"><a href="#编辑页面返回（这里是我的业务需求）" class="headerlink" title="编辑页面返回（这里是我的业务需求）"></a>编辑页面返回（这里是我的业务需求）</h5><ul><li>如果编辑的图片保存成功：图片编辑页面-&gt;预览大图页面-&gt;预览小图页面-&gt;业务页面</li><li>如果编辑的图片未保存：图片编辑页面-&gt;预览大图页面</li></ul><blockquote><p>注意这里需要统一一下路由返回参数 <strong>List&lt;AssetEntity&gt;?</strong></p></blockquote><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">Semantics(</span><br><span class="line">selected: isSelected,</span><br><span class="line">label: semanticsTextDelegate.select,</span><br><span class="line">onTap: () =&gt; onChangingSelected(context, asset, isSelected),</span><br><span class="line">onTapHint: semanticsTextDelegate.select,</span><br><span class="line">excludeSemantics: <span class="keyword">true</span>,</span><br><span class="line">child: Row(</span><br><span class="line">  mainAxisAlignment: MainAxisAlignment.spaceBetween,</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line"><span class="comment">/// <span class="language-markdown">下面是就是添加核心代码的地方</span></span></span><br><span class="line"><span class="keyword">if</span>(previewAssets[currentIndex].type==AssetType.image)InkWell(</span><br><span class="line">  child: Text(<span class="string">&quot;编辑&quot;</span>),</span><br><span class="line">  onTap: ()<span class="keyword">async</span>&#123;</span><br><span class="line">File? f=<span class="keyword">await</span> previewAssets[currentIndex].file;</span><br><span class="line">Directory? savePath=f?.parent;</span><br><span class="line"><span class="comment">/// <span class="language-markdown">预览大图页面-&gt;图片编辑页面</span></span></span><br><span class="line"><span class="keyword">var</span> data = <span class="keyword">await</span> Navigator.push(context, MaterialPageRoute(builder: (context) &#123;</span><br><span class="line">  <span class="keyword">return</span> ImageEditor(</span><br><span class="line">originImage:f!,</span><br><span class="line">savePath: savePath,</span><br><span class="line">  );</span><br><span class="line">&#125;));</span><br><span class="line"><span class="comment">/// <span class="language-markdown">如果编辑的图片保存成功：图片编辑页面-&gt;预览大图页面-&gt;预览小图页面-&gt;业务页面</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">如果编辑的图片保存成功：图片编辑页面-&gt;预览大图页面</span></span></span><br><span class="line"><span class="keyword">if</span> (data <span class="keyword">is</span> EditorImageResult) &#123;</span><br><span class="line">  <span class="built_in">List</span>&lt;AssetEntity&gt;? result=[];</span><br><span class="line">  result.add(AssetEntity(</span><br><span class="line">  width: data.imgWidth,</span><br><span class="line">  typeInt: <span class="number">0</span>,</span><br><span class="line">  height: data.imgHeight,</span><br><span class="line">  id:<span class="string">&quot;editImg&quot;</span>,</span><br><span class="line">  relativePath:data.newFile.path</span><br><span class="line">  ));</span><br><span class="line">  Navigator.pop(context,result);</span><br><span class="line">&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">),</span><br><span class="line">Row(</span><br><span class="line">  mainAxisAlignment: MainAxisAlignment.end,</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line"><span class="comment">///<span class="language-markdown">tabby</span></span></span><br><span class="line"><span class="keyword">if</span> (isAppleOS)</span><br><span class="line">  _appleOSSelectButton(c, isSelected, asset)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  _androidSelectButton(c, isSelected, asset),</span><br><span class="line"><span class="keyword">if</span> (!isAppleOS)</span><br><span class="line">  ScaleText(</span><br><span class="line">textDelegate.select,</span><br><span class="line">style: <span class="keyword">const</span> TextStyle(fontSize: <span class="number">17</span>, height: <span class="number">1</span>),</span><br><span class="line">semanticsLabel: semanticsTextDelegate.select,</span><br><span class="line">  ),</span><br><span class="line">  ],</span><br><span class="line">),</span><br><span class="line">  ],</span><br><span class="line">),</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src="/assets/img/202212056.gif" class="cImgSizeW325" alt="完美！nice"><h3 id="打包与发布"><a href="#打包与发布" class="headerlink" title="打包与发布"></a>打包与发布</h3><p>安卓打包非常完美，一点问题都没有。但是iOS上却有问题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bz@bdeMac-mini ios % pod install</span><br><span class="line">Analyzing dependencies</span><br><span class="line">[!] The name of the given podspec `image_editor` doesn&#x27;t match the expected one `image_editor_dove`</span><br><span class="line"></span><br><span class="line">[!] Automatically assigning platform `iOS` with version `13.0` on target `Runner` because no platform was specified. Please specify a platform for this target in your Podfile. See `https://guides.cocoapods.org/syntax/podfile.html#platform`.</span><br></pre></td></tr></table></figure><p>他说image_editor下面没有一个名为image_editor_dove，类型为podspec的文件</p><p>我们进入到ios/.symlinks/plugins/image_editor_dove路径下面，发现确实没有image_editor_dove.podspec，</p><p>但是有一个image_editor.podspec，试着将其重新命名为image_editor_dove.podspec，同时修改此文件中的s.name = ‘image_editor_dove’</p><p>pod install 可以正常执行了</p><p>项目运行的时候xcode又出现了一个错误</p><p><strong>image_editor-Swift.h 大概意思这个文件引入不进来，不存在</strong></p><p>ios/Classes/ImageEditorPlugin.m 中修改image_editor全都修改为image_editor_dove</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;ImageEditorPlugin.h&quot;</span><br><span class="line">#if __has_include(&lt;image_editor_dove/image_editor_dove-Swift.h&gt;)</span><br><span class="line">#import &lt;image_editor_dove/image_editor_dove-Swift.h&gt;</span><br><span class="line">#else</span><br><span class="line">// Support project import fallback if the generated compatibility header</span><br><span class="line">// is not copied when this plugin is created as a library.</span><br><span class="line">// https://forums.swift.org/t/swift-static-libraries-dont-copy-generated-objective-c-header/19816</span><br><span class="line">#import &quot;image_editor_dove-Swift.h&quot;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">@implementation ImageEditorPlugin</span><br><span class="line">+ (void)registerWithRegistrar:(NSObject&lt;FlutterPluginRegistrar&gt;*)registrar &#123;</span><br><span class="line">  [SwiftImageEditorPlugin registerWithRegistrar:registrar];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>打包成功！</p><p>猝！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近在项目遇见一个需求，是选择图片。于是我在pub上面找了这款&lt;a href=&quot;https://pub.flutter-io.cn/packages/wechat_assets_picker&quot;&gt;仿微信图片视频选择插件&lt;/a&gt;感觉还挺好的~&lt;/p&gt;
&lt;p&gt;经过上线之后老板觉得不方便，微信比起来不能编辑图片，于是我有找了另一款&lt;a href=&quot;https://pub.flutter-io.cn/packages/image_editor_dove&quot;&gt;编辑图片的插件&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;现在好了，编辑图片和选择图片的功能都有了，但是他并不能像微信选择图片的那样在预览的时候编辑图片。没办法，只能硬着头皮在现在插件上改了。&lt;/p&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
  <entry>
    <title>在React项目中IM富文本输入框</title>
    <link href="https://tabbycute.github.io/2022/11/15/20221115%E8%87%AA%E5%AE%9A%E4%B9%89im%E7%BC%96%E8%BE%91%E5%99%A8/"/>
    <id>https://tabbycute.github.io/2022/11/15/20221115%E8%87%AA%E5%AE%9A%E4%B9%89im%E7%BC%96%E8%BE%91%E5%99%A8/</id>
    <published>2022-11-14T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.284Z</updated>
    
    <content type="html"><![CDATA[<p>im中的编辑器实际上是一个富文本的编辑器改好的成品，找了很多都没有适合</p><p>最终还是自己找一个插件二次封装一下吧（基于<a href="https://www.kancloud.cn/liuwave/quill/1409423">quill</a>），实际上大部分富文本编辑器都是基于<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Global_attributes/contenteditable">contenteditable</a>的高度封装，有兴趣可以了解下。</p><p>需要@用户，表情就ok</p><p>先安装依赖</p><blockquote><p>npm i react-quill –save<br>“react-quill”: “^2.0.0”<br>npm i quill-image-drop-module –save<br>“quill-image-drop-module”: “^1.0.3”</p></blockquote><img src="/assets/img/202211151.gif" alt="效果展示"><p>核心代码(测试demo)</p><blockquote><p>还没写输入部分。js添加的内容测试下</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Quill</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react-quill&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;react-quill/dist/quill.snow.css&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ImageDrop</span> &#125; <span class="keyword">from</span> <span class="string">&quot;quill-image-drop-module&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;theme,<span class="title class_">Tooltip</span>&#125; <span class="keyword">from</span> <span class="string">&quot;antd&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;useEffect&#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">TalkVideoCall</span>,<span class="title class_">TalkSingCall</span>,<span class="title class_">TalkFile</span>,<span class="title class_">TalkPhotos</span>,<span class="title class_">TalkEmoji</span>,<span class="title class_">TalkAtIcon</span>,<span class="title class_">TalkPicture</span>,<span class="title class_">TalkVideo</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@/strings/imgs&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Gap</span> <span class="keyword">from</span> <span class="string">&quot;../gap.jsx&quot;</span>;</span><br><span class="line"><span class="comment">///拖拽图片</span></span><br><span class="line"><span class="title class_">Quill</span>.<span class="title function_">register</span>(<span class="string">&quot;modules/imageDrop&quot;</span>, <span class="title class_">ImageDrop</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">///去除剪贴板中文字的样式</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ClipboardTextHandler</span> = (<span class="params">node, delta</span>) =&gt; &#123;</span><br><span class="line">    delta.<span class="property">ops</span> = delta.<span class="property">ops</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">op</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">insert</span>: op.<span class="property">insert</span>,</span><br><span class="line">            <span class="comment">///修改插入图片的大小,当然这里肯定有些判断</span></span><br><span class="line">            <span class="comment">// attributes: &#123; width: &quot;50px&quot;, height: &quot;50px&quot; &#125;</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> delta;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 继承相关 https://kang-bing-kui.gitbook.io/quill/other/parchment</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///at用户插入</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Embed</span> = <span class="title class_">Quill</span>.<span class="keyword">import</span>(<span class="string">&quot;blots/embed&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MsgAtUser</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Embed</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">create</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(value.<span class="property">tagName</span>&amp;&amp;(value.<span class="property">tagName</span>.<span class="title function_">toLowerCase</span>()===<span class="string">&quot;at&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> node = <span class="variable language_">super</span>.<span class="title function_">create</span>();</span><br><span class="line">        node.<span class="property">innerText</span> = value.<span class="property">text</span>;</span><br><span class="line">        node.<span class="title function_">setAttribute</span>(<span class="string">&quot;id&quot;</span>, value.<span class="property">id</span>);</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">margin</span> = <span class="string">&quot;0 4px&quot;</span>;</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">fontWeight</span> = <span class="string">&quot;600&quot;</span>;</span><br><span class="line">        node.<span class="title function_">setAttribute</span>(<span class="string">&quot;contenteditable&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">///撤消操作</span></span><br><span class="line">    <span class="keyword">static</span> value=<span class="function">(<span class="params">node</span>)=&gt;</span>node</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">MsgAtUser</span>.<span class="property">blotName</span> = <span class="string">&quot;MsgAtUser&quot;</span>;</span><br><span class="line"><span class="title class_">MsgAtUser</span>.<span class="property">tagName</span> = <span class="string">&quot;at&quot;</span>;</span><br><span class="line"><span class="title class_">Quill</span>.<span class="title function_">register</span>(<span class="title class_">MsgAtUser</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">///表情</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MsgEmoji</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Embed</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">create</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;create&quot;</span>,value)</span><br><span class="line"></span><br><span class="line">        <span class="comment">///通过id判断是否需要格式化，防止误伤</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(value)===<span class="string">&quot;[object HTMLImageElement]&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> node = <span class="variable language_">super</span>.<span class="title function_">create</span>();</span><br><span class="line">        node.<span class="title function_">setAttribute</span>(<span class="string">&quot;src&quot;</span>, value.<span class="property">src</span>);</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">width</span> = <span class="string">&quot;16px&quot;</span>;</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">height</span> = <span class="string">&quot;16px&quot;</span>;</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&quot;red&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">///撤消操作</span></span><br><span class="line">    <span class="keyword">static</span> value=<span class="function"><span class="params">node</span>=&gt;</span>node</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">MsgEmoji</span>.<span class="property">blotName</span> = <span class="string">&quot;MsgEmoji&quot;</span>;</span><br><span class="line"><span class="title class_">MsgEmoji</span>.<span class="property">tagName</span> = <span class="string">&quot;img&quot;</span>;</span><br><span class="line"><span class="title class_">Quill</span>.<span class="title function_">register</span>(<span class="title class_">MsgEmoji</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">InputTools</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; token &#125; = theme.<span class="title function_">useToken</span>();</span><br><span class="line">    <span class="keyword">const</span> &#123;colorText,colorBorder&#125;=token;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">className</span>=<span class="string">&quot;flex-ltr-ac-js&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">style</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">width:</span>&quot;<span class="attr">100</span>%&quot;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">padding:</span>&quot;<span class="attr">12px</span> <span class="attr">15px</span> <span class="attr">0</span>&quot;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex-ltr-ac-js&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;alignItems:</span>&quot;<span class="attr">start</span>&quot;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;表情&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkEmoji</span> <span class="attr">size</span>=<span class="string">&#123;28&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Gap</span> <span class="attr">w</span>=<span class="string">&#123;16&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkPicture</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Gap</span> <span class="attr">w</span>=<span class="string">&#123;16&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkVideo</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Gap</span> <span class="attr">w</span>=<span class="string">&#123;16&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkFile</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;/*<span class="tag">&lt;<span class="name">TalkPhotos</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;/</span>&gt;</span>*/&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex-ltr-ac-js&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkVideoCall</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Gap</span> <span class="attr">w</span>=<span class="string">&#123;16&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkSingCall</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">ChatTalkInput</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; token &#125; = theme.<span class="title function_">useToken</span>();</span><br><span class="line">    <span class="keyword">const</span> &#123;colorBgContainer,colorBorder&#125;=token;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> quill=<span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        quill = <span class="keyword">new</span> <span class="title class_">Quill</span>(<span class="string">&quot;#editor&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">modules</span>: &#123;</span><br><span class="line">                <span class="attr">toolbar</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">clipboard</span>: &#123;</span><br><span class="line">                    <span class="attr">matchers</span>: [[<span class="title class_">Node</span>.<span class="property">ELEMENT_NODE</span>, <span class="title class_">ClipboardTextHandler</span>]],</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">theme</span>: <span class="string">&quot;snow&quot;</span>,</span><br><span class="line">            <span class="attr">imageDrop</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        quill.<span class="title function_">insertText</span>(<span class="number">0</span>,<span class="string">&quot;今天下午全都去开会&quot;</span>,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        <span class="comment">///插入at</span></span><br><span class="line">        quill.<span class="title function_">insertEmbed</span>(<span class="number">9</span>,<span class="string">&quot;MsgAtUser&quot;</span>,&#123; <span class="attr">text</span>: <span class="string">`@所有人`</span>, <span class="attr">id</span>: <span class="string">&quot;0&quot;</span> &#125;,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        quill.<span class="title function_">insertText</span>(<span class="number">10</span>,<span class="string">&quot;都要到&quot;</span>,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        <span class="comment">///插入表情</span></span><br><span class="line">        quill.<span class="title function_">insertEmbed</span>(<span class="number">0</span>,<span class="string">&quot;MsgEmoji&quot;</span>,&#123;<span class="attr">src</span>: <span class="string">&quot;https://www.w3school.com.cn/i/eg_tulip.jpg&quot;</span>, <span class="attr">code</span>: <span class="string">&quot;0&quot;</span> &#125;,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        quill.<span class="title function_">insertText</span>(<span class="number">0</span>,<span class="string">&quot;通知！！！！！！！&quot;</span>,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        <span class="comment">// quill.setSelection(1, Quill.sources.SILENT);</span></span><br><span class="line">    &#125;, []);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">///当输入框失去焦点，后如果输入框里面全是Embed，下次则无法聚焦！！！！只能重新聚焦</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">setSelection</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">        <span class="comment">///先要判断一下，防止误伤！！！</span></span><br><span class="line">        <span class="comment">// quill.setSelection(1, Quill.sources.SILENT);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">className</span>=<span class="string">&quot;flex-ttb-ac-js&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">style</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">height:</span>&quot;<span class="attr">230px</span>&quot;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">width:</span>&quot;<span class="attr">100</span>%&quot;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">border:</span>&quot;<span class="attr">none</span>&quot;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">InputTools</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;editor&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;setSelection&#125;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width:</span>&quot;<span class="attr">100</span>%&quot;,<span class="attr">height:</span>&quot;<span class="attr">100px</span>&quot;,<span class="attr">flex:</span>&quot;<span class="attr">1</span>&quot;,<span class="attr">border:</span>&quot;<span class="attr">none</span>&quot;&#125;&#125;&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;im中的编辑器实际上是一个富文本的编辑器改好的成品，找了很多都没有适合&lt;/p&gt;
&lt;p&gt;最终还是自己找一个插件二次封装一下吧（基于&lt;a href=&quot;https://www.kancloud.cn/liuwave/quill/1409423&quot;&gt;quill&lt;/a&gt;），实际上大部分富文本编辑器都是基于&lt;a href=&quot;https://developer.mozilla.org/zh-CN/docs/Web/HTML/Global_attributes/contenteditable&quot;&gt;contenteditable&lt;/a&gt;的高度封装，有兴趣可以了解下。&lt;/p&gt;
&lt;p&gt;需要@用户，表情就ok&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="react" scheme="https://tabbycute.github.io/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>浏览器中的模块化(ES Module,import-maps)</title>
    <link href="https://tabbycute.github.io/2022/11/11/20221111%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96/"/>
    <id>https://tabbycute.github.io/2022/11/11/20221111%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96/</id>
    <published>2022-11-10T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.284Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ES-Module"><a href="#ES-Module" class="headerlink" title="ES Module"></a>ES Module</h3><p>ES Module 是 JavaScript 模块化的官方标准， 目前主流的浏览器已经实现，不依赖任何第三方加载器 (Loader) 即可使用。</p><blockquote><p><a href="https://caniuse.com/mdn-javascript_statements_import">点击此链接查看最新的浏览器支持情况</a></p></blockquote><p>浏览器中只支持相对路径或者绝对路径下的 ES 模块 (./, ../, /, http://, https://) ， 同时也受服务器跨域请求策略、 HTTPS 策略的约束。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// my_func.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">my_func</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;script type=<span class="string">&quot;module&quot;</span>&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; my_func &#125; <span class="keyword">from</span> <span class="string">&#x27;./my_func.js&#x27;</span>;</span><br><span class="line"><span class="title function_">my_func</span>();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="import-maps"><a href="#import-maps" class="headerlink" title="import-maps"></a>import-maps</h3><p>import-maps 就是为了解决浏览器中的全局模块而出现的， 目前浏览器的支持情况如下图所示， 基于 Chromium 的浏览器已经实现这个功能。</p><p>这个script 标签必须放在 document 中的中第一个 type=”module” 标签之前（最好是在<head>中），以便在进行模块解析之前对它进行解析。</p><blockquote><p><a href="https://caniuse.com/import-maps">点击此链接查看最新的浏览器支持情况</a></p></blockquote><p>import-maps 使用 Json 的形式来定义浏览器中的全局模块：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;importmap&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;imports&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;three&quot;</span>: <span class="string">&quot;./build/three.module.js&quot;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;three/addons/&quot;</span>: <span class="string">&quot;./jsm/&quot;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;react-dom&quot;</span>: <span class="string">&quot;https://cdn.skypack.dev/react-dom&quot;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这个标签中应该是严格的json格式，注意逗号的使用，如下<strong>错误实例</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;importmap&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;imports&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;three&quot;</span>: <span class="string">&quot;./build/three.module.js&quot;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;three/addons/&quot;</span>: <span class="string">&quot;./jsm/&quot;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;react-dom&quot;</span>: <span class="string">&quot;https://cdn.skypack.dev/react-dom&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>上面逗号引起浏览器报错</p></blockquote><blockquote><p>Failed to resolve module specifier “vue”. Relative references must start with either “/“, “./“, or “../“.</p></blockquote><h3 id="在浏览器中使用-import-maps-和-ES-模块示例"><a href="#在浏览器中使用-import-maps-和-ES-模块示例" class="headerlink" title="在浏览器中使用 import-maps 和 ES 模块示例"></a>在浏览器中使用 import-maps 和 ES 模块示例</h3><ul><li>简单测试demo</li></ul><p>index.html<br>/web/aaa.js</p><blockquote><p>因为使用的本地的，记得本地服务启动</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const Test = ()=&gt;&#123;</span><br><span class="line">    console.log(&quot;sdadadada&quot;)</span><br><span class="line">&#125;</span><br><span class="line">export &#123; Test,&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-cn&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vue<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;root&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;importmap&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;imports&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;@t/&quot;</span>: <span class="string">&quot;./web/&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">import</span> &#123;<span class="title class_">Test</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;@t/aaa.js&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">Test</span>()</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>在浏览器中直接使用 ArcGIS JS API 4.20 提供的 ES 模块</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>ArcGIS JS API ES Module Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">id</span>=<span class="string">&quot;mapstyle-link&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://js.arcgis.com/4.20/@arcgis/core/assets/esri/themes/dark/main.css&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-tag">html</span>,<span class="selector-tag">body</span>,<span class="selector-id">#mapview</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">width</span>: <span class="number">100%</span>; <span class="attribute">height</span>: <span class="number">100%</span>; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>; <span class="attribute">overflow</span>: hidden;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css">  </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;mapview&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;importmap&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;imports&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;@arcgis/&quot;</span>: <span class="string">&quot;https://js.arcgis.com/4.20/@arcgis/&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> <span class="title class_">Map</span> <span class="keyword">from</span> <span class="string">&#x27;@arcgis/core/Map.js&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> <span class="title class_">MapView</span> <span class="keyword">from</span> <span class="string">&#x27;@arcgis/core/views/MapView.js&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> * <span class="keyword">as</span> intl <span class="keyword">from</span> <span class="string">&quot;@arcgis/core/intl.js&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">  intl.<span class="title function_">setLocale</span>(<span class="string">&#x27;zh-CN&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">basemap</span>: <span class="string">&#x27;dark-gray-vector&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">ground</span>: <span class="string">&#x27;world-elevation&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">MapView</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">container</span>: <span class="string">&#x27;mapview&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">map</span>: map,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">zoom</span>: <span class="number">7</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">center</span>: [<span class="number">113.2</span>, <span class="number">23.4</span>],</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">viewingMode</span>: <span class="string">&#x27;global&#x27;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;ES-Module&quot;&gt;&lt;a href=&quot;#ES-Module&quot; class=&quot;headerlink&quot; title=&quot;ES Module&quot;&gt;&lt;/a&gt;ES Module&lt;/h3&gt;&lt;p&gt;ES Module 是 JavaScript 模块化的官方标准， 目前主流的浏览器已经实现，不依赖任何第三方加载器 (Loader) 即可使用。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://caniuse.com/mdn-javascript_statements_import&quot;&gt;点击此链接查看最新的浏览器支持情况&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>前端换肤解决方案及其思路</title>
    <link href="https://tabbycute.github.io/2022/10/25/20221025%E5%89%8D%E7%AB%AF%E6%8D%A2%E8%82%A4%E6%80%9D%E8%B7%AF/"/>
    <id>https://tabbycute.github.io/2022/10/25/20221025%E5%89%8D%E7%AB%AF%E6%8D%A2%E8%82%A4%E6%80%9D%E8%B7%AF/</id>
    <published>2022-10-24T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.283Z</updated>
    
    <content type="html"><![CDATA[<h3 id="CSS变量实现"><a href="#CSS变量实现" class="headerlink" title="CSS变量实现"></a>CSS变量实现</h3><p>没什么好说的简单</p><blockquote><p>使用stylus注意</p><p>–fill-1:#222;（正常）</p><p>–fill-1: #222;（可能报错）</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">change</span>=(<span class="params">theme</span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> html=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;body&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">html.<span class="title function_">setAttribute</span>(<span class="string">&quot;data-theme&quot;</span>,theme)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;change(&#x27;light&#x27;)&quot;</span>&gt;</span>主题颜色亮色<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;change(&#x27;dark&#x27;)&quot;</span>&gt;</span>主题颜色暗色<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;bg&quot;</span>&gt;</span>测试文字啊阿达瓦大大<span class="tag">&lt;<span class="name">i</span>&gt;</span>家中的<span class="tag">&lt;/<span class="name">i</span>&gt;</span>王阿达瓦<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">&quot;stylus&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    //默认</span></span><br><span class="line"><span class="language-css"><span class="selector-pseudo">:root</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--fill-1</span>:<span class="number">#ffffff</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--text</span>:<span class="number">#3c3c3c</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--text-1</span>:<span class="number">#757575</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--text-2</span>:<span class="number">#222</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-large</span>:<span class="number">18px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-large-x</span>:<span class="number">22px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-medium</span>:<span class="number">14px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-medium-x</span>:<span class="number">16px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-small-s</span>:<span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-small</span>:<span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-attr">[data-theme=<span class="string">&quot;dark&quot;</span>]</span> &#123;</span></span><br><span class="line"><span class="language-css"><span class="attr">--fill-1</span>:<span class="number">#222</span>;</span></span><br><span class="line"><span class="language-css"><span class="attr">--text</span>:<span class="number">#fff</span>;</span></span><br><span class="line"><span class="language-css"><span class="attr">--text-1</span>:<span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.3</span>);</span></span><br><span class="line"><span class="language-css"><span class="attr">--text-2</span>:<span class="number">#ffcd32</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.bg</span></span></span><br><span class="line"><span class="language-css"><span class="attribute">transition-duration</span>: <span class="number">0.5s</span></span></span><br><span class="line"><span class="language-css">height: <span class="number">100px</span></span></span><br><span class="line"><span class="language-css">background <span class="built_in">var</span>(--fill-<span class="number">1</span>);</span></span><br><span class="line"><span class="language-css"><span class="attribute">color</span>: <span class="built_in">var</span>(--text-<span class="number">2</span>);</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="js动态"><a href="#js动态" class="headerlink" title="js动态"></a>js动态</h3><p>使用覆盖样式实现与scss变量实现会把多套皮肤的样式都编译到一个css文件里面，如果有多套皮肤样式，这个文件是会非常大的。</p><p>为了解决这样的问题，就自然的想出了拆分scss的实现，，通过编译工具与构建工具编译出多套皮肤css。或者使用网络地址。</p><p>通过js动态的link对应的皮肤样式</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> theme = <span class="regexp">/\bt=(\w+)/</span>.<span class="title function_">exec</span>(location.<span class="property">search</span>);</span><br><span class="line">theme = theme ? theme[<span class="number">1</span>] : <span class="string">&quot;light&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">changeTheme</span>(theme);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">changeTheme</span>(<span class="params">theme</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> head = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;head&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;link&quot;</span>);</span><br><span class="line">    link.<span class="property">dataset</span>.<span class="property">type</span> = <span class="string">&quot;theme&quot;</span>;</span><br><span class="line">    link.<span class="property">href</span> = <span class="string">&quot;assets/css/theme-&quot;</span> + theme + <span class="string">&quot;/pages/home/home.css&quot;</span>;</span><br><span class="line">    link.<span class="property">rel</span> = <span class="string">&quot;stylesheet&quot;</span>;</span><br><span class="line">    link.<span class="property">type</span> = <span class="string">&quot;text/css&quot;</span>;</span><br><span class="line">    head.<span class="title function_">appendChild</span>(link);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ElementUI换肤"><a href="#ElementUI换肤" class="headerlink" title="ElementUI换肤"></a>ElementUI换肤</h3><p>ElementUI的实现原理，通过预设的配置，颜色计算出颜色和生成正则，获取所有的style标签，拿到标签中的字符串，在去用正则替换字符串中的颜色，在设置回去。</p><p>为了考虑重复设置可以给style标签添加个标记</p><p>这个实现方式正如他官方所说相当暴力莫得感情！！！同时自己写的颜色也会被替换掉</p><blockquote><p><a href="https://github.com/ianstormtaylor/css-color-function">颜色计算</a></p><p><a href="https://www.runoob.com/js/js-obj-regexp.html">前端正则</a></p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">Color</span> <span class="keyword">from</span> <span class="string">&quot;css-color-function&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> current=<span class="string">&quot;default&quot;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> formulaes = [</span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&quot;0&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">exp</span>: <span class="string">&quot;color(primary)&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&quot;aaa&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">exp</span>: <span class="string">&quot;color(textColor)&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&quot;bbb&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">exp</span>: <span class="string">&quot;color(btn)&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">];</span></span><br><span class="line"><span class="language-javascript"><span class="comment">///多个主题</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> themes=&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">default</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;primary&quot;</span>:<span class="string">&quot;#DC143C&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;textColor&quot;</span>:<span class="string">&quot;#BBFFAA&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;btn&quot;</span>:<span class="string">&quot;#2F4F4F&quot;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t1</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;primary&quot;</span>:<span class="string">&quot;#FFD700&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;textColor&quot;</span>:<span class="string">&quot;#000000&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;btn&quot;</span>:<span class="string">&quot;#000080&quot;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t2</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;primary&quot;</span>:<span class="string">&quot;#2F4F4F&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;textColor&quot;</span>:<span class="string">&quot;#FFFFFF&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;btn&quot;</span>:<span class="string">&quot;#adff2f&quot;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">computedColors</span> = (<span class="params">colors</span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">return</span> formulaes.<span class="title function_">map</span>(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> value = f.<span class="property">exp</span></span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">replace</span>(<span class="regexp">/primary/g</span>, colors.<span class="property">primary</span>)</span></span><br><span class="line"><span class="language-javascript">    .<span class="property">replace</span> (<span class="regexp">/textColor/g</span>,colors.<span class="property">textColor</span>)</span></span><br><span class="line"><span class="language-javascript">    .<span class="property">replace</span> (<span class="regexp">/btn/g</span>,colors.<span class="property">btn</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> <span class="title class_">Color</span>.<span class="title function_">convert</span>(value);</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">PageInit</span>=(<span class="params"></span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(themes).<span class="title function_">forEach</span>(<span class="function"><span class="params">k</span>=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> initColorCluster=[...<span class="title class_">Object</span>.<span class="title function_">values</span>(themes[k]),...<span class="title function_">computedColors</span>(themes[k])]</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> initStyleReg=initColorCluster.<span class="title function_">join</span>(<span class="string">&quot;|&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">      .<span class="title function_">replace</span>(<span class="regexp">/\(/g</span>, <span class="string">&quot;\\(&quot;</span>) <span class="comment">// 括号的转义</span></span></span><br><span class="line"><span class="language-javascript">      .<span class="title function_">replace</span>(<span class="regexp">/\)/g</span>, <span class="string">&quot;\\)&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">      .<span class="title function_">replace</span>(<span class="regexp">/0\./g</span>, <span class="string">&quot;.&quot;</span>); <span class="comment">// 这里替换是因为默认的css中计算出来的值透明度会缺省0，</span></span></span><br><span class="line"><span class="language-javascript">    themes[k].<span class="property">_initColorCluster</span>=initColorCluster</span></span><br><span class="line"><span class="language-javascript">    themes[k].<span class="property">_initStyleReg</span>=initStyleReg</span></span><br><span class="line"><span class="language-javascript">  &#125;)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="title class_">PageInit</span>()</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">changeTheme</span> = (<span class="params">t</span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> cT=themes[current],</span></span><br><span class="line"><span class="language-javascript">        tT=themes[t];</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> styles = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;style&quot;</span>)).<span class="title function_">filter</span>(<span class="function">(<span class="params">style</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 找到需要进行替换的style标签</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> text = style.<span class="property">innerText</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">`<span class="subst">$&#123;cT._initStyleReg&#125;</span>`</span>, <span class="string">&quot;i&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span> re.<span class="title function_">test</span>(text);</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///生成正则</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">`<span class="subst">$&#123;cT._initStyleReg&#125;</span>`</span>, <span class="string">&quot;ig&quot;</span>); <span class="comment">// 老的颜色簇正则，全局替换，且不区分大小写</span></span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">    styles.<span class="title function_">forEach</span>(<span class="function">(<span class="params">style</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> &#123; innerText &#125; = style;</span></span><br><span class="line"><span class="language-javascript">      style.<span class="property">innerHTML</span> = innerText.<span class="title function_">replace</span>(re, <span class="function">(<span class="params">match</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">///通过小写检查  rgba(0,0,0,.5) 替换成0.5 兼容好</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> index = cT.<span class="property">_initColorCluster</span>.<span class="title function_">indexOf</span>(match.<span class="title function_">toLowerCase</span>().<span class="title function_">replace</span>(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;0.&quot;</span>));</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">///通过大写写检查</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (index === -<span class="number">1</span>)index = cT.<span class="property">_initColorCluster</span>.<span class="title function_">indexOf</span>(match.<span class="title function_">toUpperCase</span>().<span class="title function_">replace</span>(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;0.&quot;</span>));</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 进行替换</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> tT.<span class="property">_initColorCluster</span>[index].<span class="title function_">toLowerCase</span>().<span class="title function_">replace</span>(<span class="regexp">/0\./g</span>, <span class="string">&quot;.&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      &#125;);</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// console.log(style.innerHTML)</span></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// style.setAttribute(&quot;class&quot;, &quot;so-ui-react-theme&quot;);</span></span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">    current=t;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;当前主题：%s&quot;</span>,current)</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">change</span>=(<span class="params"></span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">if</span>(current===<span class="string">&quot;default&quot;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">changeTheme</span>(<span class="string">&quot;t1&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(current===<span class="string">&quot;t1&quot;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">changeTheme</span>(<span class="string">&quot;t2&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">changeTheme</span>(<span class="string">&quot;default&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// componentDidMount();</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;a b&quot;</span>&gt;</span>testaaaaaai<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;b c&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;change&quot;</span>&gt;</span>更换颜色<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.a</span>&#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>: <span class="number">#DC143C</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.b</span>&#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">color</span>: <span class="number">#BBFFAA</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.c</span>&#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>:<span class="number">#2F4F4F</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="less实现换肤"><a href="#less实现换肤" class="headerlink" title="less实现换肤"></a>less实现换肤</h3><p>感觉less实现的很优雅</p><p>设置默认样式，原来它会找到所有如下的less样式标签，并且使用已编译的css同步创建 style 标签。</p><p>相当于在原来的基础上生成一个一模一样的style样式表添加到页面中。也就是说他需要一个模板。如果放在src里面他会被编译成css，无法成为模板。</p><p>我们这里把这个模板放到项目主目录的public中去。。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/public/test<span class="selector-class">.less</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@primary-color</span>: red;</span><br><span class="line"><span class="keyword">@bg-color</span>: blue;</span><br><span class="line"><span class="selector-class">.test-block</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">20px</span> auto;</span><br><span class="line">  <span class="attribute">color</span>: @primary-color;</span><br><span class="line">  <span class="attribute">background</span>: @bg-color;</span><br><span class="line">  <span class="selector-class">.block2</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: aquamarine;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>修改项目模板文件index.html，添加lessjs，也可以搞成本地的的，我这里为了方便直接添加cdn的</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">type</span>=<span class="string">&quot;image/svg+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/vite.svg&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vite + Vue<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet/less&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/test.less&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">less</span> = &#123;<span class="attr">async</span>:<span class="literal">true</span>,&#125;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/less.js/2.7.3/less.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/src/main.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>页面简单使用</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> themes=&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t1</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@primary-color&quot;</span>: <span class="string">&quot;#8b0000&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@bg-color&quot;</span>: <span class="string">&quot;#2f4f4f&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t2</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@primary-color&quot;</span>: <span class="string">&quot;#ffa500&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@bg-color&quot;</span>: <span class="string">&quot;#c0c0c0&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t3</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@primary-color&quot;</span>:<span class="string">&quot;#000080&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@bg-color&quot;</span>: <span class="string">&quot;#000000&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">onchange</span>=(<span class="params">t</span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">console</span>.<span class="title function_">log</span>(themes[t])</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">window</span>.<span class="property">less</span>.<span class="title function_">modifyVars</span>(themes[t]).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;修改成功&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;onchange(&#x27;t1&#x27;)&quot;</span>&gt;</span>改变哦<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;onchange(&#x27;t2&#x27;)&quot;</span>&gt;</span>改变哦<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;onchange(&#x27;t3&#x27;)&quot;</span>&gt;</span>改变哦<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;test-block&quot;</span>&gt;</span>testaaaaaai<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="其他思路"><a href="#其他思路" class="headerlink" title="其他思路"></a>其他思路</h3><p>vuex，自定义指令等等实现起来应该也很不错。理论上他们也能获得较高的自定义程度，颜色，背景图等等等。</p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;CSS变量实现&quot;&gt;&lt;a href=&quot;#CSS变量实现&quot; class=&quot;headerlink&quot; title=&quot;CSS变量实现&quot;&gt;&lt;/a&gt;CSS变量实现&lt;/h3&gt;&lt;p&gt;没什么好说的简单&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;使用stylus注意&lt;/p&gt;
&lt;p&gt;–fill-1:#222;（正常）&lt;/p&gt;
&lt;p&gt;–fill-1: #222;（可能报错）&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="vue" scheme="https://tabbycute.github.io/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>flutter极光推送集成华为(鸿蒙)厂商通道</title>
    <link href="https://tabbycute.github.io/2022/10/05/20221005flutter%E9%9B%86%E6%88%90%E5%8D%8E%E4%B8%BA%E6%8E%A8%E9%80%81/"/>
    <id>https://tabbycute.github.io/2022/10/05/20221005flutter%E9%9B%86%E6%88%90%E5%8D%8E%E4%B8%BA%E6%8E%A8%E9%80%81/</id>
    <published>2022-10-04T16:00:00.000Z</published>
    <updated>2022-12-07T14:17:58.960Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>flutter插件<a href="https://pub.flutter-io.cn/packages/jpush_flutter">jpush_flutter: 2.2.5</a>,<a href="https://github.com/jpush/jpush-flutter-plugin">github</a></p><p>华为推送证书<a href="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html#/myProject/99536292102686645/97458334310914890?appId=107234249">agconnect-services.json导出地址</a></p><p>极光<a href="https://www.jiguang.cn/portal/#/dev/newOverview">开发者平台</a></p><p>客户端sdk集成<a href="https://docs.jiguang.cn/jpush/client/Android/android_sdk">官方文档</a></p><p>客户端华为厂商通道集成<a href="https://docs.jiguang.cn/jpush/client/Android/android_3rd_guide#%E9%85%8D%E7%BD%AE-mavencentral-%E6%94%AF%E6%8C%81-1">官方文档</a></p><p>极光推送<a href="https://www.jiguang.cn/portal/#/push/app/bffe9289b1b2f16861869be9/config_manage/check/message">排查工具</a></p><p>com.huawei.hms:push:X.X.X.XXX<a href="https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/service-introduction-0000001050040060">推送服务（Push Kit）</a>是华为提供的消息推送平台，建立了从云端到终端的消息推送通道。您通过集成推送服务，可以向客户端应用实时推送消息，构筑良好的用户关系，提升用户的感知度和活跃度。</p><p>com.huawei.hms:push:X.X.X.XXX推送服务<a href="https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/android-app-version-0000001074227861#section527519181712">版本及其历史版本</a></p><p>com.huawei.agconnect:agcp:X.X.X.XXX<a href="https://developer.huawei.com/consumer/cn/doc/development/AppGallery-connect-Guides/agc-apm-android-releasenotes-0000001052887266">华为分析服务（Analytics Kit）</a>是针对移动应用、Web、快应用、快游戏、小程序等产品的一站式用户行为分析平台，贴合业务场景，提供数据采集、数据管理、数据分析、数据应用的一体化解决方案，驱动企业实现精准拉新、产品优化、精益运营、业务增长。</p><p><a href="https://docs.jiguang.cn/jpush/client/Android/android_sdk">极光推送官方</a>客户端集成，包括荣耀，OPPO，等等需要引入aar包，<strong>极光文档可能会更新，需要留意观看，</strong>看着他文档来就OK</p></blockquote><h3 id="极光推送基础集成"><a href="#极光推送基础集成" class="headerlink" title="极光推送基础集成"></a>极光推送基础集成</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">class MyHomePage extends StatefulWidget &#123;</span><br><span class="line">  const MyHomePage(&#123;super.key, required this.title&#125;);</span><br><span class="line">  final String title;</span><br><span class="line">  @override</span><br><span class="line">  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();</span><br><span class="line">&#125;</span><br><span class="line">class _MyHomePageState extends State&lt;MyHomePage&gt; &#123;</span><br><span class="line">  JPush jpush = new JPush();</span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              try &#123;</span><br><span class="line">                //Map&lt;String, dynamic&gt; message</span><br><span class="line">                jpush.addEventHandler(onReceiveNotification: (message) async &#123;</span><br><span class="line">                  print(&quot;jpush flutter onReceiveNotification: $&#123;json.encode(message)&#125;&quot;);</span><br><span class="line">                &#125;, onOpenNotification: (message) async &#123;</span><br><span class="line">                &#125;, onReceiveMessage: (message) async &#123;</span><br><span class="line">                  print(&quot;jpush flutter onReceiveMessage: $&#123;json.encode(message)&#125;&quot;);</span><br><span class="line">                &#125;, onReceiveNotificationAuthorization: (message) async &#123;</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125; on PlatformException &#123;</span><br><span class="line">                print(&quot;jpush Failed to get platform version.&quot;);</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              jpush.setup(</span><br><span class="line">                appKey: &quot;bffe9289**********61869be9&quot;,</span><br><span class="line">                channel: &quot;developer-default&quot;,</span><br><span class="line">                production: false,</span><br><span class="line">                debug: false, // 设置是否打印 debug 日志</span><br><span class="line">              );</span><br><span class="line"></span><br><span class="line">              jpush.applyPushAuthority(NotificationSettingsIOS(</span><br><span class="line">                sound: true,</span><br><span class="line">                alert: true,</span><br><span class="line">                badge: true,</span><br><span class="line">              ));</span><br><span class="line"></span><br><span class="line">              jpush.getRegistrationID().then((rid) &#123;</span><br><span class="line">                print(&quot;jpush flutter get registration id : $rid&quot;);</span><br><span class="line">              &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;, child: Text(&quot;setup&quot;)),</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              jpush.applyPushAuthority();</span><br><span class="line">            &#125;, child: Text(&quot;apply&quot;)),</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              jpush.isNotificationEnabled().then((bool value) &#123;</span><br><span class="line">                print(&quot;jpush 通知授权是否打开: $value&quot;);</span><br><span class="line">              &#125;).catchError((onError) &#123;</span><br><span class="line">                print(&quot;jpush 通知授权是否打开: $&#123;onError.toString()&#125;&quot;);</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;, child: Text(&quot;通知&quot;)),</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              jpush.setAlias(&quot;1000*****&quot;).then((map) &#123; </span><br><span class="line">                print(&quot;==setAlias==$&#123;map&#125;==&quot;);</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;, child: Text(&quot;setAlias&quot;))</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="厂商通道集成"><a href="#厂商通道集成" class="headerlink" title="厂商通道集成"></a>厂商通道集成</h3><blockquote><p>gradle:6.7</p><p>distributionUrl=https://services.gradle.org/distributions/gradle-6.7-all.zip</p><p>android/build.gradle———-classpath com.android.tools.build:gradle:4.1.3</p><p>jpush_flutter: 2.2.5 Jcore版本:3.2.2  Jpush版本: 4.6.4   (可以在flutter的插件地址Changelog中查看)</p></blockquote><h4 id="android-build-gradle加上如下代码"><a href="#android-build-gradle加上如下代码" class="headerlink" title="android/build.gradle加上如下代码"></a>android/build.gradle加上如下代码</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    ext.kotlin_version = <span class="string">&#x27;1.6.10&#x27;</span></span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line"><span class="comment">// 加上如下代码</span></span><br><span class="line">        maven &#123;url <span class="string">&#x27;https://developer.huawei.com/repo/&#x27;</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;com.android.tools.build:gradle:4.1.3&#x27;</span></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加上如下代码</span></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;com.huawei.agconnect:agcp:1.4.2.300&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line"><span class="comment">// 加上如下代码</span></span><br><span class="line">        maven &#123; url <span class="string">&#x27;https://developer.huawei.com/repo/&#x27;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="agconnect-services-json放入到-android-app-中"><a href="#agconnect-services-json放入到-android-app-中" class="headerlink" title="agconnect-services.json放入到**android/app/**中"></a>agconnect-services.json放入到**android/app/**中</h4><h4 id="进入到android-app-build-gradle"><a href="#进入到android-app-build-gradle" class="headerlink" title="进入到android/app/build.gradle"></a>进入到<strong>android/app/build.gradle</strong></h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line">apply plugin: <span class="string">&#x27;kotlin-android&#x27;</span></span><br><span class="line">apply <span class="keyword">from</span>: <span class="string">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br><span class="line"><span class="comment">// 加上如下代码（位置随意）</span></span><br><span class="line">apply plugin: <span class="string">&#x27;com.huawei.agconnect&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="引入厂商sdk"><a href="#引入厂商sdk" class="headerlink" title="引入厂商sdk"></a>引入厂商sdk</h4><p>极光厂商插件版本与接入 JPush 版本保持一致，下同，jpush版本可以在极光推送<a href="https://www.jiguang.cn/portal/#/push/app/bffe9289b1b2f16861869be9/config_manage/check/message">排查工具</a>中查看</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="comment">// 接入华为厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;com.huawei.hms:push:5.3.0.301&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:huawei:4.4.5&#x27;</span><span class="comment">// 极光厂商插件版本与接入 JPush 版本保持一致，下同</span></span><br><span class="line">    <span class="comment">// 接入小米厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:xiaomi:4.4.5&#x27;</span></span><br><span class="line">    <span class="comment">// 接入 FCM 厂商</span></span><br><span class="line"><span class="comment">// implementation &#x27;com.google.firebase:firebase-messaging:21.0.1&#x27;</span></span><br><span class="line"><span class="comment">// implementation &#x27;cn.jiguang.sdk.plugin:fcm:4.0.0&#x27;</span></span><br><span class="line">    <span class="comment">// 接入魅族厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:meizu:4.4.5&#x27;</span></span><br><span class="line">    <span class="comment">// 接入 VIVO 厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:vivo:4.4.5&#x27;</span></span><br><span class="line">    <span class="comment">// 接入 OPPO 厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:oppo:4.4.5&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修改AndroidManifest-xml"><a href="#修改AndroidManifest-xml" class="headerlink" title="修改AndroidManifest.xml"></a>修改AndroidManifest.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> </span></span><br><span class="line"><span class="tag">···</span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    ···&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">       ···</span></span><br><span class="line"><span class="tag">       <span class="attr">tools:replace</span>=<span class="string">&quot;android:label&quot;</span></span></span><br></pre></td></tr></table></figure><h3 id="版本升级"><a href="#版本升级" class="headerlink" title="版本升级"></a>版本升级</h3><p><strong>‘com.huawei.agconnect:agcp:1.5.2.300’</strong> 这个版本是IDE自动提示我的如果版本不对他运行可能会报错!!!!,开头给力地址可以查找自己对应的版本</p><p><strong>‘com.huawei.hms:push:5.3.0.301’</strong> 开头给力地址可以查找自己对应的版本</p><blockquote><p>gradle:7.4</p><p>distributionUrl=https://services.gradle.org/distributions/gradle-7.4-all.zip</p><p>android/build.gradle———-classpath ‘com.android.tools.build:gradle:7.1.2’</p><p>jpush_flutter: 2.4.0 Jpush版本: 4.8.4 (可以在flutter的插件地址Changelog中查看)</p><p>aar的包位于android/app/libs/***.aar</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">...</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath &#x27;com.android.tools.build:gradle:7.1.2&#x27;</span><br><span class="line">        classpath &quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span><br><span class="line"></span><br><span class="line">// 加上如下代码  </span><br><span class="line">        classpath &#x27;com.huawei.agconnect:agcp:1.5.2.300&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    // 接入华为厂商</span><br><span class="line">    implementation &#x27;com.huawei.hms:push:5.3.0.301&#x27;</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:huawei:4.8.4&#x27;// 极光厂商插件版本与接入 JPush 版本保持一致，下同</span><br><span class="line">    // 接入小米厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:xiaomi:4.8.4&#x27;</span><br><span class="line">    // 接入魅族厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:meizu:4.8.4&#x27;</span><br><span class="line">    // 接入 VIVO 厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:vivo:4.8.4&#x27;</span><br><span class="line">    // 接入 OPPO 厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:oppo:4.8.4&#x27;</span><br><span class="line">    implementation(name: &#x27;com.heytap.msp-push-3.1.0&#x27;, ext: &#x27;aar&#x27;)</span><br><span class="line">    //以下为 OPPO 3.1.0 aar需要依赖</span><br><span class="line">    implementation &#x27;com.google.code.gson:gson:2.6.2&#x27;</span><br><span class="line">    implementation &#x27;commons-codec:commons-codec:1.6&#x27;</span><br><span class="line">    implementation &#x27;androidx.annotation:annotation:1.1.0&#x27;</span><br><span class="line">    //荣耀</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:honor:4.8.4&#x27;</span><br><span class="line">    implementation(name: &#x27;HonorPushSDK-7.0.1.103&#x27;, ext: &#x27;aar&#x27;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;flutter插件&lt;a href=&quot;https://pub.flutter-io.cn/packages/jpush_flutter&quot;&gt;jpush_flutter: 2.2.5&lt;/a&gt;,&lt;a href=&quot;https://github.com/jpush/jpush-flutter-plugin&quot;&gt;github&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;华为推送证书&lt;a href=&quot;https://developer.huawei.com/consumer/cn/service/josp/agc/index.html#/myProject/99536292102686645/97458334310914890?appId=107234249&quot;&gt;agconnect-services.json导出地址&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;极光&lt;a href=&quot;https://www.jiguang.cn/portal/#/dev/newOverview&quot;&gt;开发者平台&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;客户端sdk集成&lt;a href=&quot;https://docs.jiguang.cn/jpush/client/Android/android_sdk&quot;&gt;官方文档&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;客户端华为厂商通道集成&lt;a href=&quot;https://docs.jiguang.cn/jpush/client/Android/android_3rd_guide#%E9%85%8D%E7%BD%AE-mavencentral-%E6%94%AF%E6%8C%81-1&quot;&gt;官方文档&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;极光推送&lt;a href=&quot;https://www.jiguang.cn/portal/#/push/app/bffe9289b1b2f16861869be9/config_manage/check/message&quot;&gt;排查工具&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;com.huawei.hms:push:X.X.X.XXX&lt;a href=&quot;https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/service-introduction-0000001050040060&quot;&gt;推送服务（Push Kit）&lt;/a&gt;是华为提供的消息推送平台，建立了从云端到终端的消息推送通道。您通过集成推送服务，可以向客户端应用实时推送消息，构筑良好的用户关系，提升用户的感知度和活跃度。&lt;/p&gt;
&lt;p&gt;com.huawei.hms:push:X.X.X.XXX推送服务&lt;a href=&quot;https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/android-app-version-0000001074227861#section527519181712&quot;&gt;版本及其历史版本&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;com.huawei.agconnect:agcp:X.X.X.XXX&lt;a href=&quot;https://developer.huawei.com/consumer/cn/doc/development/AppGallery-connect-Guides/agc-apm-android-releasenotes-0000001052887266&quot;&gt;华为分析服务（Analytics Kit）&lt;/a&gt;是针对移动应用、Web、快应用、快游戏、小程序等产品的一站式用户行为分析平台，贴合业务场景，提供数据采集、数据管理、数据分析、数据应用的一体化解决方案，驱动企业实现精准拉新、产品优化、精益运营、业务增长。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.jiguang.cn/jpush/client/Android/android_sdk&quot;&gt;极光推送官方&lt;/a&gt;客户端集成，包括荣耀，OPPO，等等需要引入aar包，&lt;strong&gt;极光文档可能会更新，需要留意观看，&lt;/strong&gt;看着他文档来就OK&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;极光推送基础集成&quot;&gt;&lt;a href=&quot;#极光推送基础集成&quot; class=&quot;headerlink&quot; title=&quot;极光推送基础集成&quot;&gt;&lt;/a&gt;极光推送基础集成&lt;/h3&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;class MyHomePage extends StatefulWidget &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  const MyHomePage(&amp;#123;super.key, required this.title&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  final String title;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  @override&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  State&amp;lt;MyHomePage&amp;gt; createState() =&amp;gt; _MyHomePageState();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;class _MyHomePageState extends State&amp;lt;MyHomePage&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  JPush jpush = new JPush();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  @override&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Widget build(BuildContext context) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    return Scaffold(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      appBar: AppBar(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        title: Text(widget.title),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      ),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      body: Center(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        child: Column(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          mainAxisAlignment: MainAxisAlignment.center,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          children: &amp;lt;Widget&amp;gt;[&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ElevatedButton(onPressed:()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                //Map&amp;lt;String, dynamic&amp;gt; message&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                jpush.addEventHandler(onReceiveNotification: (message) async &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  print(&amp;quot;jpush flutter onReceiveNotification: $&amp;#123;json.encode(message)&amp;#125;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;, onOpenNotification: (message) async &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;, onReceiveMessage: (message) async &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  print(&amp;quot;jpush flutter onReceiveMessage: $&amp;#123;json.encode(message)&amp;#125;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;, onReceiveNotificationAuthorization: (message) async &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125; on PlatformException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;jpush Failed to get platform version.&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.setup(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                appKey: &amp;quot;bffe9289**********61869be9&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                channel: &amp;quot;developer-default&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                production: false,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                debug: false, // 设置是否打印 debug 日志&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.applyPushAuthority(NotificationSettingsIOS(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                sound: true,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                alert: true,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                badge: true,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              ));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.getRegistrationID().then((rid) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;jpush flutter get registration id : $rid&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;, child: Text(&amp;quot;setup&amp;quot;)),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ElevatedButton(onPressed:()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.applyPushAuthority();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;, child: Text(&amp;quot;apply&amp;quot;)),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ElevatedButton(onPressed:()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.isNotificationEnabled().then((bool value) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;jpush 通知授权是否打开: $value&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;).catchError((onError) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;jpush 通知授权是否打开: $&amp;#123;onError.toString()&amp;#125;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;, child: Text(&amp;quot;通知&amp;quot;)),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ElevatedButton(onPressed:()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              jpush.setAlias(&amp;quot;1000*****&amp;quot;).then((map) &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(&amp;quot;==setAlias==$&amp;#123;map&amp;#125;==&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;, child: Text(&amp;quot;setAlias&amp;quot;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          ],&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      ),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
    <category term="极光推送" scheme="https://tabbycute.github.io/tags/%E6%9E%81%E5%85%89%E6%8E%A8%E9%80%81/"/>
    
  </entry>
  
  <entry>
    <title>etcd集群的搭建</title>
    <link href="https://tabbycute.github.io/2022/09/25/20220925etcd%E7%9A%84%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"/>
    <id>https://tabbycute.github.io/2022/09/25/20220925etcd%E7%9A%84%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/</id>
    <published>2022-09-24T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.048Z</updated>
    
    <content type="html"><![CDATA[<p>etcd安装不说了详情请看上篇文章</p><h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><h4 id="节点1"><a href="#节点1" class="headerlink" title="节点1"></a>节点1</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd --name etcd_t_0 --initial-advertise-peer-urls http://119.91.206.195:2380 \</span><br><span class="line">  --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --advertise-client-urls http://119.91.206.195:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd_t_0=http://119.91.206.195:2380,etcd_t_1=http://1.117.72.9:2380,etcd_t_2=http://47.92.80.135:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir /var/lib/etcd5/</span><br></pre></td></tr></table></figure><h4 id="节点2"><a href="#节点2" class="headerlink" title="节点2"></a>节点2</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd --name etcd_t_1 --initial-advertise-peer-urls http://1.117.72.9:2380 \</span><br><span class="line">  --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --advertise-client-urls http://1.117.72.9:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd_t_0=http://119.91.206.195:2380,etcd_t_1=http://1.117.72.9:2380,etcd_t_2=http://47.92.80.135:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir /var/lib/etcd5/</span><br></pre></td></tr></table></figure><h4 id="节点3"><a href="#节点3" class="headerlink" title="节点3"></a>节点3</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd --name etcd_t_2 --initial-advertise-peer-urls http://47.92.80.135:2380 \</span><br><span class="line">  --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --advertise-client-urls http://47.92.80.135:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd_t_0=http://119.91.206.195:2380,etcd_t_1=http://1.117.72.9:2380,etcd_t_2=http://47.92.80.135:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir /var/lib/etcd5/</span><br></pre></td></tr></table></figure><h3 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h3><ul><li><p>查看集群成员</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member list --write-out=table</span></span><br><span class="line">+------------------+---------+----------+----------------------------+----------------------------+</span><br><span class="line">|        ID        | STATUS  |   NAME   |         PEER ADDRS         |        CLIENT ADDRS        |</span><br><span class="line">+------------------+---------+----------+----------------------------+----------------------------+</span><br><span class="line">| 362499433afddc14 | started | etcd_t_1 | http://1.117.72.9:2380     | http://1.117.72.9:2379     |</span><br><span class="line">| e4258ae59dee9dc3 | started | etcd_t_0 | http://119.91.206.195:2380 | http://119.91.206.195:2379 |</span><br><span class="line">| feb1217e15f7013f | started | etcd_t_2 | http://47.92.80.135:2380   | http://47.92.80.135:2379   |</span><br><span class="line">+------------------+---------+----------+----------------------------+----------------------------+</span><br></pre></td></tr></table></figure></li><li><p>查看集群健康</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl --endpoints=119.91.206.195:2380,1.117.72.9:2380,47.92.80.135:2380 endpoint health</span></span><br><span class="line">1.117.72.9:2380 is healthy: successfully committed proposal: took = 87.35868ms</span><br><span class="line">47.92.80.135:2380 is healthy: successfully committed proposal: took = 111.468497ms</span><br><span class="line">119.91.206.195:2380 is healthy: successfully committed proposal: took = 101.468497ms</span><br></pre></td></tr></table></figure></li><li><p>查看集群状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl --endpoints=119.91.206.195:2380,1.117.72.9:2380,47.92.80.135:2380 endpoint status --write-out=table</span></span><br><span class="line">+---------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">|     ENDPOINT        |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">| 1.117.72.9:2380     | 362499433afddc14 | 3.3.11  | 20 kB   | <span class="literal">false</span>     |        15 |          9 |</span><br><span class="line">| 47.92.80.135:2380   | feb1217e15f7013f | 3.3.11  | 16 kB   | <span class="literal">false</span>     |        15 |          9 |</span><br><span class="line">| 119.91.206.195:2380 | e4258ae59dee9dc3 | 3.3.11  | 16 kB   | <span class="literal">true</span>      |        15 |          9 |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+-----------+------------+</span><br></pre></td></tr></table></figure></li><li><p>删除一个节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member remove 362499433afddc14</span></span><br><span class="line">Member 362499433afddc14 removed from cluster 51573d7cfd299893</span><br></pre></td></tr></table></figure></li><li><p>加入一个节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member add etcd_t_1 --peer-urls=http://1.117.72.9:2380</span></span><br><span class="line">Member c4356e396bf22311 added to cluster 51573d7cfd299893</span><br><span class="line"></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd_t_1&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd_t_1=http://1.117.72.9:2380,etcd_t_0=http://119.91.206.195:2380,etcd_t_2=http://47.92.80.135:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;existing&quot;</span></span><br></pre></td></tr></table></figure><p>新节点启动的时候使用以上输出的配置启动一定注意参数</p></li><li><p>故障主机加入节点</p></li></ul><p>故障的etcd主机：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop etcd</span><br></pre></td></tr></table></figure><p>移除故障节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member remove 362499433afddc14</span></span><br><span class="line">Member 362499433afddc14 removed from cluster 51573d7cfd299893</span><br></pre></td></tr></table></figure><p>查询集群成员</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+------------------+-----------+----------+----------------------------+----------------------------+</span><br><span class="line">|        ID        |  STATUS   |   NAME   |         PEER ADDRS         |        CLIENT ADDRS        |</span><br><span class="line">+------------------+-----------+----------+----------------------------+----------------------------+</span><br><span class="line">| 50466d8335f8506a | unstarted |          | http://1.117.72.9:2380     |                            |</span><br><span class="line">| e4258ae59dee9dc3 | started   | etcd_t_0 | http://119.91.206.195:2380 | http://119.91.206.195:2379 |</span><br><span class="line">| feb1217e15f7013f | started   | etcd_t_2 | http://47.92.80.135:2380   | http://47.92.80.135:2379   |</span><br><span class="line">+------------------+-----------+----------+----------------------------+----------------------------+</span><br></pre></td></tr></table></figure><p>正常的etcd主机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member add etcd_t_1 --peer-urls=http://1.117.72.9:2380</span></span><br><span class="line">Member c4356e396bf22311 added to cluster 51573d7cfd299893</span><br><span class="line"></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd_t_1&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd_t_1=http://1.117.72.9:2380,etcd_t_0=http://119.91.206.195:2380,etcd_t_2=http://47.92.80.135:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;existing&quot;</span></span><br></pre></td></tr></table></figure><p>故障的etcd主机，启动etcd后，再查看etcd状态：</p><blockquote><p>一定要去修改故障主机的配置为：ETCD_INITIAL_CLUSTER_STATE=”existing”</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先删除错误节点的数据</span></span><br><span class="line"><span class="built_in">rm</span> -rf /var/lib/etcd/member</span><br><span class="line">systemctl start etcd</span><br><span class="line"><span class="comment"># 等待一会，这时候会同步数据，稍等再查看节点状态</span></span><br><span class="line">etcdctl endpoint health</span><br><span class="line">127.0.0.1:2379 is healthy: successfully committed proposal: took = 24.52485ms</span><br></pre></td></tr></table></figure><p>到这里，etcd故障节点修复完毕</p><h3 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h3><ul><li>这是集群中使用的etcd版本不一致的提示(<strong>这很有可能到导致集群不健康，至少我这个版本会，后来我全是yum install etcd</strong>)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2022-09-25 21:59:44.187212 W | etcdserver: the <span class="built_in">local</span> etcd version 3.1.5 is not up-to-date</span><br><span class="line">2022-09-25 21:59:44.187217 W | etcdserver: member feb1217e15f7013f has a higher version 3.3.11</span><br></pre></td></tr></table></figure></li><li>如果在一个目录启动过etcd，要启动新的集群或者其他的新的实例，最好换个目录，他可能会导致无法启动。暴力点rm -rf ******</li><li>故障的etcd主机，一定要去修改故障主机的配置为：ETCD_INITIAL_CLUSTER_STATE=existing</li><li>注意如果是前面修复过坏节点，下次启动集群的时候也不需要去修改坏节点的ETCD_INITIAL_CLUSTER_STATE=new</li><li>不同版本的etcd命令可能不一样，比如：添加节点</li><li>设置成existing，必须确保在启动时候其他member是存活的（peer端口），否则启动失败。用在扩容新实例的启动。设置成new，用在cluster已知member的启动。</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;etcd安装不说了详情请看上篇文章&lt;/p&gt;
&lt;h3 id=&quot;启动服务&quot;&gt;&lt;a href=&quot;#启动服务&quot; class=&quot;headerlink&quot; title=&quot;启动服务&quot;&gt;&lt;/a&gt;启动服务&lt;/h3&gt;&lt;h4 id=&quot;节点1&quot;&gt;&lt;a href=&quot;#节点1&quot; class=&quot;headerlink&quot; title=&quot;节点1&quot;&gt;&lt;/a&gt;节点1&lt;/h4&gt;</summary>
    
    
    
    <category term="linux" scheme="https://tabbycute.github.io/categories/linux/"/>
    
    
    <category term="linux" scheme="https://tabbycute.github.io/tags/linux/"/>
    
    <category term="etcd" scheme="https://tabbycute.github.io/tags/etcd/"/>
    
  </entry>
  
  <entry>
    <title>etcd单节点安装和golang的简单使用</title>
    <link href="https://tabbycute.github.io/2022/09/18/20220918etcd%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85%E5%92%8Cgolang%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
    <id>https://tabbycute.github.io/2022/09/18/20220918etcd%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85%E5%92%8Cgolang%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</id>
    <published>2022-09-17T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.282Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装golang"><a href="#安装golang" class="headerlink" title="安装golang"></a>安装golang</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install golang</span><br></pre></td></tr></table></figure><h2 id="etcd单节点安装"><a href="#etcd单节点安装" class="headerlink" title="etcd单节点安装"></a>etcd单节点安装</h2><h3 id="源码包安装"><a href="#源码包安装" class="headerlink" title="源码包安装"></a>源码包安装</h3><h4 id="下载etcd"><a href="#下载etcd" class="headerlink" title="下载etcd"></a>下载etcd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.1.5/etcd-v3.1.5-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><h4 id="解压-etcd-v3-1-5-linux-amd64-tar-gz-压缩文件"><a href="#解压-etcd-v3-1-5-linux-amd64-tar-gz-压缩文件" class="headerlink" title="解压 etcd-v3.1.5-linux-amd64.tar.gz 压缩文件"></a>解压 etcd-v3.1.5-linux-amd64.tar.gz 压缩文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf etcd-v3.1.5-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><h4 id="将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。"><a href="#将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。" class="headerlink" title="将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。"></a>将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//进入文件夹</span><br><span class="line"><span class="built_in">cd</span> etcd-v3.1.5-linux-amd64/</span><br><span class="line">//将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。</span><br><span class="line"><span class="built_in">mv</span> etcd* /usr/local/bin</span><br></pre></td></tr></table></figure><h4 id="修改使用的api等级"><a href="#修改使用的api等级" class="headerlink" title="修改使用的api等级"></a>修改使用的api等级</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><h4 id="查看版本信息"><a href="#查看版本信息" class="headerlink" title="查看版本信息"></a>查看版本信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">etcdctl v</span><br><span class="line"></span><br><span class="line">etcdctl version: 3.1.5</span><br><span class="line">API version: 3.1</span><br><span class="line"></span><br><span class="line">etcd --version</span><br><span class="line"></span><br><span class="line">etcd Version: 3.1.5</span><br><span class="line">Git SHA: 2cf9e51</span><br><span class="line">Go Version: go1.10.3</span><br><span class="line">Go OS/Arch: linux/amd64</span><br></pre></td></tr></table></figure><h4 id="创建etcd数据存放位置"><a href="#创建etcd数据存放位置" class="headerlink" title="创建etcd数据存放位置"></a>创建etcd数据存放位置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 数据存放位置的文件夹</span><br><span class="line"><span class="built_in">mkdir</span> -p /var/lib/etcd/</span><br></pre></td></tr></table></figure><h4 id="创建启动文件"><a href="#创建启动文件" class="headerlink" title="创建启动文件"></a>创建启动文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/systemd/system/etcd.service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//复制以下即可</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Etcd Server</span></span><br><span class="line"><span class="string">Documentation=https://github.com/coreos/etcd</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">User=root</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">Environment=ETCD_NAME=etcd_test_1</span></span><br><span class="line"><span class="string">Environment=ETCD_DATA_DIR=/var/lib/etcd/</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/etcd</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">RestartSec=10s</span></span><br><span class="line"><span class="string">LimitNOFILE=40000</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h4 id="重新加载配置-amp-amp-开机启动-amp-amp-启动-etcd"><a href="#重新加载配置-amp-amp-开机启动-amp-amp-启动-etcd" class="headerlink" title="重新加载配置 &amp;&amp; 开机启动 &amp;&amp; 启动 etcd"></a>重新加载配置 &amp;&amp; 开机启动 &amp;&amp; 启动 etcd</h4><h5 id="启动etcd"><a href="#启动etcd" class="headerlink" title="启动etcd"></a>启动etcd</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> etcd &amp;&amp; systemctl start etcd</span><br><span class="line">//成功如下</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/etcd.service to /etc/systemd/system/etcd.service.</span><br></pre></td></tr></table></figure><h5 id="开机启动设置状态，状态-enabled"><a href="#开机启动设置状态，状态-enabled" class="headerlink" title="开机启动设置状态，状态 enabled"></a>开机启动设置状态，状态 enabled</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files etcd.service</span><br><span class="line"></span><br><span class="line">//成功如下</span><br><span class="line">UNIT FILE    STATE </span><br><span class="line">etcd.service enabled</span><br><span class="line"> </span><br><span class="line">1 unit files listed.</span><br></pre></td></tr></table></figure><h5 id="查看-etcd-状态"><a href="#查看-etcd-状态" class="headerlink" title="查看 etcd 状态"></a>查看 etcd 状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl show etcd.service</span><br></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">etcdctl put mykey <span class="string">&quot;this is etcd2&quot;</span></span><br><span class="line">OK</span><br><span class="line">etcdctl get mykey</span><br><span class="line">mykey</span><br><span class="line">this is etcd</span><br></pre></td></tr></table></figure><h4 id="外网连接"><a href="#外网连接" class="headerlink" title="外网连接"></a>外网连接</h4><p>当然，etcd默认本地访问。如果需要远程访问需要在配置文件（/etc/etcd.conf 上面创建的文件）中加上如下操作。注意如果上面一行不是字符串需要加个</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Type=notify</span><br><span class="line">Environment=ETCD_NAME=etcd_test_1</span><br><span class="line">Environment=ETCD_DATA_DIR=/var/lib/etcd/</span><br><span class="line"></span><br><span class="line">Environment=ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379</span><br><span class="line">Environment=ETCD_ADVERTISE_CLIENT_URLS=http://0.0.0.0:2379</span><br><span class="line">或者直接使用本机</span><br><span class="line">Environment=ETCD_LISTEN_CLIENT_URLS=http://1.117.72.92:2379</span><br><span class="line">Environment=ETCD_ADVERTISE_CLIENT_URLS=http://1.117.72.92:2379</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ExecStart=/usr/local/bin/etcd</span><br></pre></td></tr></table></figure><p><strong>如果当前已经启动了修改的配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启生效</span></span><br><span class="line">systemctl restart etcd</span><br><span class="line"><span class="comment"># 重启生效</span></span><br><span class="line">systemctl stop etcd</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> etcd &amp;&amp; systemctl start etcd</span><br></pre></td></tr></table></figure><h4 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h4><ul><li>–name：方便理解的节点名称，默认为 default，在集群中应该保持唯一，可以使用 hostname</li><li>–data-dir：服务运行数据保存的路径，默认为 ${name}.etcd</li><li>–snapshot-count：指定有多少事务（transaction）被提交时，触发截取快照保存到磁盘</li><li>–heartbeat-interval：leader 多久发送一次心跳到 followers。默认值是 100ms</li><li>–eletion-timeout：重新投票的超时时间，如果follower在该时间间隔没有收到心跳包，会触发重新投票，默认为 1000 ms</li><li>–listen-peer-urls：和同伴通信的地址，比如 <a href="http://ip:2380，如果有多个，使用逗号分隔。需要所有节点都能够访问，所以不要使用">http://ip:2380，如果有多个，使用逗号分隔。需要所有节点都能够访问，所以不要使用</a> localhost</li><li>–listen-client-urls：对外提供服务的地址：比如 <a href="http://ip:2379,http://127.0.0.1:2379，客户端会连接到这里和etcd交互">http://ip:2379,http://127.0.0.1:2379，客户端会连接到这里和etcd交互</a></li><li>–advertise-client-urls：对外公告的该节点客户端监听地址，这个值会告诉集群中其他节点</li><li>–initial-advertise-peer-urls：该节点同伴监听地址，这个值会告诉集群中其他节点</li><li>–initial-cluster：集群中所有节点的信息，格式为 node1=<a href="http://ip1:2380,node2=http://ip2:2380,…。需要注意的是，这里的">http://ip1:2380,node2=http://ip2:2380,…。需要注意的是，这里的</a> node1 是节点的–name指定的名字；后面的ip1:2380 是–initial-advertise-peer-urls 指定的值</li><li>–initial-cluster-state：新建集群的时候，这个值为 new；假如已经存在的集群，这个值为existing</li><li>–initial-cluster-token：创建集群的token，这个值每个集群保持唯一。这样的话，如果你要重新创建集群，即使配置和之前一样，也会再次生成新的集群和节点 uuid；否则会导致多个集群之间的冲突，造成未知的错误<br></li></ul><p>这些选项，与上面我们配置文件里的配置一一对应，如ETCD_INITIAL_CLUSTER等同于–inital-cluster, ETCD_INITIAL_CLUSTER_STATE等同于–initial-cluster-state。</p><blockquote><p>所有以–init开头的配置都是在第一次启动etcd集群的时候才会用到，后续节点的重启会被忽略，如–initial-cluseter参数。所以当成功初始化了一个etcd集群以后，就不再需要这个参数或环境变量了。</p></blockquote><h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl stop etcd</span><br><span class="line">etcdctl member list//查看节点</span><br></pre></td></tr></table></figure><h4 id="报错收集"><a href="#报错收集" class="headerlink" title="报错收集"></a>报错收集</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">No <span class="built_in">help</span> topic <span class="keyword">for</span> ‘put’</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_API=3 解决</span><br></pre></td></tr></table></figure><h3 id="etcd-git官方安装脚本"><a href="#etcd-git官方安装脚本" class="headerlink" title="etcd git官方安装脚本"></a>etcd git官方安装脚本</h3><blockquote><p><a href="https://github.com/etcd-io/etcd/releases">https://github.com/etcd-io/etcd/releases</a><br>继续从 &lt;&lt;将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中&gt;&gt; 开始</p></blockquote><h3 id="etcd-yum安装"><a href="#etcd-yum安装" class="headerlink" title="etcd yum安装"></a>etcd yum安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install etcd</span><br><span class="line"></span><br><span class="line">//继续从 &lt;&lt;修改使用的api等级&gt;&gt; 开始</span><br></pre></td></tr></table></figure><h2 id="安装etcd-webui"><a href="#安装etcd-webui" class="headerlink" title="安装etcd webui"></a>安装etcd webui</h2><ul><li>记得启动Etcd服务。</li><li>先安装node，git环境，然后clone。</li><li>安装node可以到 <a href="http://nodejs.cn/download/%E4%B8%8B%E8%BD%BD%E5%AF%B9%E5%BA%94%E7%9A%84">http://nodejs.cn/download/下载对应的</a> node 版本。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/henszey/etcd-browser.git</span><br><span class="line">cd etcd-browser/</span><br><span class="line">vim server.js  </span><br></pre></td></tr></table></figure>编辑server.js，修改内容如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var etcdHost = process.env.ETCD_HOST || &#x27;127.0.0.1&#x27;;  # etcd 主机IP</span><br><span class="line">var etcdPort = process.env.ETCD_PORT || 2379;          # etcd 主机端口</span><br><span class="line">var serverPort = process.env.SERVER_PORT || 8000;      # etcd-browser 监听端口</span><br></pre></td></tr></table></figure>然后启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node server.js</span><br></pre></td></tr></table></figure>访问：<a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a></li></ul><h2 id="go连接etcd和一些操作"><a href="#go连接etcd和一些操作" class="headerlink" title="go连接etcd和一些操作"></a>go连接etcd和一些操作</h2><h3 id="put-get的简单操作示例"><a href="#put-get的简单操作示例" class="headerlink" title="put/get的简单操作示例"></a>put/get的简单操作示例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;go.etcd.io/etcd/client/v3&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="comment">// handle error!</span></span><br><span class="line">      fmt.Printf(<span class="string">&quot;connect to etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line">   <span class="comment">// put</span></span><br><span class="line">   ctx, cancel := context.WithTimeout(context.Background(), <span class="number">3</span>*time.Second)</span><br><span class="line">   _, err = cli.Put(ctx, <span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v1&quot;</span>)</span><br><span class="line">   cancel()</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;put to etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// get</span></span><br><span class="line">   ctx, cancel = context.WithTimeout(context.Background(), <span class="number">3</span>*time.Second)</span><br><span class="line">   resp, err := cli.Get(ctx, <span class="string">&quot;k1&quot;</span>)</span><br><span class="line">   cancel()</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;get from etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">for</span> _, ev := <span class="keyword">range</span> resp.Kvs &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;%s:%s\n&quot;</span>, ev.Key, ev.Value)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="watch的使用"><a href="#watch的使用" class="headerlink" title="watch的使用"></a>watch的使用</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;go.etcd.io/etcd/client/v3&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;connect to etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line">   <span class="comment">// watch key:q1mi change</span></span><br><span class="line">   rch := cli.Watch(context.Background(), <span class="string">&quot;k1&quot;</span>) <span class="comment">// &lt;-chan WatchResponse</span></span><br><span class="line">   <span class="keyword">for</span> wresp := <span class="keyword">range</span> rch &#123;</span><br><span class="line">      <span class="keyword">for</span> _, ev := <span class="keyword">range</span> wresp.Events &#123;</span><br><span class="line">         fmt.Printf(<span class="string">&quot;Type: %s Key:%s Value:%s\n&quot;</span>, ev.Type, ev.Kv.Key, ev.Kv.Value)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在同级的目录下cmd进入(下面操作是在windows上进行的，因为方便)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcdctl.exe --endpoints=http://127.0.0.1:2379 put k1 <span class="string">&quot;xixixixix&quot;</span></span><br><span class="line">etcdctl.exe --endpoints=http://127.0.0.1:2379 del k1</span><br><span class="line">etcdctl.exe --endpoints=http://127.0.0.1:2379 put k1 <span class="string">&quot;dsb3&quot;</span></span><br></pre></td></tr></table></figure><h3 id="lease租约的使用"><a href="#lease租约的使用" class="headerlink" title="lease租约的使用"></a>lease租约的使用</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;go.etcd.io/etcd/client/v3&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: time.Second * <span class="number">5</span>,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success.&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 创建一个5秒的租约</span></span><br><span class="line">   resp, err := cli.Grant(context.TODO(), <span class="number">5</span>)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(resp.ID)</span><br><span class="line">   <span class="comment">// 5秒钟之后, /aaaa/ 这个key就会被移除</span></span><br><span class="line">   _, err = cli.Put(context.TODO(), <span class="string">&quot;/aaaa/&quot;</span>, <span class="string">&quot;dsb&quot;</span>, clientv3.WithLease(resp.ID))</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   time.Sleep(time.Second * <span class="number">6</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="keepAlive"><a href="#keepAlive" class="headerlink" title="keepAlive"></a>keepAlive</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: time.Second * <span class="number">5</span>,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success.&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">   resp, err := cli.Grant(context.TODO(), <span class="number">5</span>)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   _, err = cli.Put(context.TODO(), <span class="string">&quot;/aaaa/&quot;</span>, <span class="string">&quot;dsb&quot;</span>, clientv3.WithLease(resp.ID))</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// the key &#x27;foo&#x27; will be kept forever</span></span><br><span class="line">   ch, kaerr := cli.KeepAlive(context.TODO(), resp.ID)</span><br><span class="line">   <span class="keyword">if</span> kaerr != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      ka := &lt;-ch</span><br><span class="line">      fmt.Println(<span class="string">&quot;ttl:&quot;</span>, ka.TTL)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;安装golang&quot;&gt;&lt;a href=&quot;#安装golang&quot; class=&quot;headerlink&quot; title=&quot;安装golang&quot;&gt;&lt;/a&gt;安装golang&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install golang&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;etcd单节点安装&quot;&gt;&lt;a href=&quot;#etcd单节点安装&quot; class=&quot;headerlink&quot; title=&quot;etcd单节点安装&quot;&gt;&lt;/a&gt;etcd单节点安装&lt;/h2&gt;</summary>
    
    
    
    <category term="golang" scheme="https://tabbycute.github.io/categories/golang/"/>
    
    
    <category term="golang" scheme="https://tabbycute.github.io/tags/golang/"/>
    
    <category term="linux" scheme="https://tabbycute.github.io/tags/linux/"/>
    
    <category term="etcd" scheme="https://tabbycute.github.io/tags/etcd/"/>
    
  </entry>
  
  <entry>
    <title>查看yum软件的安装目录</title>
    <link href="https://tabbycute.github.io/2022/06/10/20220610docker%E7%9A%84%E5%AE%89%E8%A3%85/"/>
    <id>https://tabbycute.github.io/2022/06/10/20220610docker%E7%9A%84%E5%AE%89%E8%A3%85/</id>
    <published>2022-06-09T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.048Z</updated>
    
    <content type="html"><![CDATA[<h3 id="官网推荐安装"><a href="#官网推荐安装" class="headerlink" title="官网推荐安装"></a>官网推荐安装</h3><hr><ul><li>卸载旧版本<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">      docker-client \</span><br><span class="line">      docker-client-latest \</span><br><span class="line">      docker-common \</span><br><span class="line">      docker-latest \</span><br><span class="line">      docker-latest-logrotate \</span><br><span class="line">      docker-logrotate \</span><br><span class="line">      docker-engine</span><br><span class="line"><span class="comment">#卸载 Docker Engine、CLI、Containerd 和 Docker Compose 软件包：</span></span><br><span class="line">yum remove docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br><span class="line"><span class="comment">#主机上的映像、容器、卷或自定义配置文件不会自动删除。要删除所有映像、容器和卷：</span></span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/docker</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/containerd</span><br></pre></td></tr></table></figure></li></ul><h3 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h3><hr><ul><li>设置存储库。安装yum-utils包（提供yum-config-manager 实用程序）并设置存储库。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils</span><br><span class="line"></span><br><span class="line">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment">#可以使用阿里源，最好选这个</span></span><br><span class="line">yum-config-manager --add-repo=http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">yum makecache <span class="comment">#重新构建缓存</span></span><br><span class="line"></span><br><span class="line">yum repolist &#123;all|enabled|disabled&#125;             <span class="comment">#列出所有/已启用/已禁用的yum源</span></span><br><span class="line">yum --disablerepo=repo                          <span class="comment">#临时禁用某个repo源</span></span><br><span class="line">yum --enablerepo=repo                          <span class="comment">#解除禁用某个repo源</span></span><br></pre></td></tr></table></figure><ul><li>安装 Docker 引擎。安装最新版本的 Docker Engine、containerd 和 Docker Compose </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure><ul><li>要安装特定版本的 Docker Engine，请在 repo 中列出可用版本，然后选择并安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | <span class="built_in">sort</span> -r</span><br><span class="line"></span><br><span class="line">docker-ce.x86_64 3:18.09.1-3.el7 docker-ce-stable </span><br><span class="line">docker-ce.x86_64 3:18.09.0-3.el7 docker-ce-stable </span><br><span class="line">docker-ce.x86_64 18.06.1.ce-3.el7 docker-ce-stable</span><br><span class="line">docker-ce.x86_64 18.06.0.ce-3.el7 docker-ce-stable</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>安装。具体的版本可以选择</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认安装</span></span><br><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br><span class="line"><span class="comment">#可以选择版本</span></span><br><span class="line">sudo yum install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure><ul><li>结束</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start docker       <span class="comment">#启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker      <span class="comment">#开机启动</span></span><br><span class="line">docker version                    <span class="comment">#查看版本</span></span><br><span class="line">docker run hello-world            <span class="comment">#示例进项</span></span><br></pre></td></tr></table></figure><blockquote><p>如果超时了切换一下yum源<br>yum-config-manager –add-repo <a href="http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo">http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</a></p></blockquote><h3 id="官网脚本安装"><a href="#官网脚本安装" class="headerlink" title="官网脚本安装"></a>官网脚本安装</h3><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com -o get-docker.sh</span><br><span class="line"></span><br><span class="line">sudo sh get-docker.sh</span><br><span class="line">或者</span><br><span class="line">sudo DRY_RUN=1 sh ./get-docker.sh</span><br></pre></td></tr></table></figure><h3 id="安装gcc"><a href="#安装gcc" class="headerlink" title="安装gcc"></a>安装gcc</h3><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc</span><br><span class="line">yum -y install gcc c++</span><br></pre></td></tr></table></figure><h3 id="镜像加速"><a href="#镜像加速" class="headerlink" title="镜像加速"></a>镜像加速</h3><hr><ul><li>创建 /etc/docker</li><li>加入地址</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;https://mirror.ccs.tencentyun.com&quot;</span></span><br><span class="line">     ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;官网推荐安装&quot;&gt;&lt;a href=&quot;#官网推荐安装&quot; class=&quot;headerlink&quot; title=&quot;官网推荐安装&quot;&gt;&lt;/a&gt;官网推荐安装&lt;/h3&gt;&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;卸载旧版本&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum remove docker \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      docker-client \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      docker-client-latest \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      docker-common \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      docker-latest \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      docker-latest-logrotate \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      docker-logrotate \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      docker-engine&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#卸载 Docker Engine、CLI、Containerd 和 Docker Compose 软件包：&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum remove docker-ce docker-ce-cli containerd.io docker-compose-plugin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#主机上的映像、容器、卷或自定义配置文件不会自动删除。要删除所有映像、容器和卷：&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo &lt;span class=&quot;built_in&quot;&gt;rm&lt;/span&gt; -rf /var/lib/docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo &lt;span class=&quot;built_in&quot;&gt;rm&lt;/span&gt; -rf /var/lib/containerd&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="docker" scheme="https://tabbycute.github.io/categories/docker/"/>
    
    
    <category term="linux" scheme="https://tabbycute.github.io/tags/linux/"/>
    
    <category term="docker" scheme="https://tabbycute.github.io/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>IM项目中electron对文件加密的方案设计与落地</title>
    <link href="https://tabbycute.github.io/2022/05/08/20220508IM%E9%A1%B9%E7%9B%AE%E4%B8%ADelectron%E5%AF%B9%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E7%9A%84%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E4%B8%8E%E8%90%BD%E5%9C%B0/"/>
    <id>https://tabbycute.github.io/2022/05/08/20220508IM%E9%A1%B9%E7%9B%AE%E4%B8%ADelectron%E5%AF%B9%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E7%9A%84%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E4%B8%8E%E8%90%BD%E5%9C%B0/</id>
    <published>2022-05-07T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.047Z</updated>
    
    <content type="html"><![CDATA[<p>文本加密很好实现，但是文件加密就稍微麻烦点。</p><p>但是我的预期加密的规则需要兼容老版本能够分辨出老版本未加密的文件，因为我们用户还可能查看老版本的聊天记录。能够分别不同版本规则的加密文件。文件不能全加密，效率要高。加密过后的文件大小，不能太大，要节约oss资源控制成本，这里我改成了一个参，可以手动设置加密后的文件新增的大小。视情况而定。</p><p>最终的加密路线如下：</p><p><img src="%22assets/img/202202041.png%22"></p><p>核心代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TBFileRules</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> checkHeadSign=[<span class="string">&quot;abcdabcdabcdabc&quot;</span>,<span class="string">&quot;abcdabcdabcdabcd&quot;</span>]                     <span class="comment">///解密时使用。是否符合解密文件。</span></span><br><span class="line">    <span class="keyword">static</span> headSign=&#123;<span class="attr">sign</span>:<span class="string">&quot;abcdabcdabcdabcd&quot;</span>,<span class="attr">headLen</span>:<span class="number">1024</span>/<span class="number">2</span>&#125;                        <span class="comment">///加密时使用。标记为加密文件。对象编译过后的字节长度不能超过50</span></span><br><span class="line">    <span class="keyword">static</span> appKey=<span class="string">&quot;tabby&quot;</span>                                                           <span class="comment">///appkey</span></span><br><span class="line">    <span class="keyword">static</span> encDataLen=<span class="number">1024</span>*<span class="number">10</span>;                                                      <span class="comment">///加密的长度，文件小于这个长度全加密 默认只加密10kb</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; -sgin:app签名</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -headLen:文件头的总长度</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileLen:文件的原长</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileEncLen:文件加密后总体的长度（不含头）</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileDataLen:加密段加密前的长度</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileDataEncLen:加密段加密后的长度</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileEncStart:加密后加密段开始的位置（不含头）</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; -ext:预留拓展字段</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">generateHeaderByte</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> &#123;fileLen,fileEncLen,fileDataLen,fileDataEncLen,fileEncStart,ext&#125;=opt;</span><br><span class="line">        <span class="keyword">let</span> header=&#123;&#125;</span><br><span class="line">        header.<span class="property">sgin</span>=<span class="title class_">TBFileRules</span>.<span class="property">appKey</span>;                     <span class="comment">///32 位app签名</span></span><br><span class="line">        header.<span class="property">headLenSign</span>=<span class="number">50</span>;                              <span class="comment">///加密标识的长度</span></span><br><span class="line">        header.<span class="property">headLen</span>=<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>.<span class="property">headLen</span>;        <span class="comment">///文件头的总长度</span></span><br><span class="line">        header.<span class="property">fileLen</span>=fileLen;                             <span class="comment">///文件的原长</span></span><br><span class="line">        header.<span class="property">fileEncLen</span>=fileEncLen;                       <span class="comment">///文件加密后总体的长度（不含头）</span></span><br><span class="line">        header.<span class="property">fileDataLen</span>=fileDataLen;                     <span class="comment">///加密段加密前的长度</span></span><br><span class="line">        header.<span class="property">fileDataEncLen</span>=fileDataEncLen;               <span class="comment">///加密段加密后的长度</span></span><br><span class="line">        header.<span class="property">fileEncStart</span>=fileEncStart;                   <span class="comment">///加密后加密段开始的位置（不含头）</span></span><br><span class="line">        header.<span class="property">ext</span>=ext;                                     <span class="comment">///预留拓展字段</span></span><br><span class="line">        <span class="comment">// console.log(header)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">TBFileRules</span>.<span class="title function_">strToByte</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(header))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        检查是否为加密文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Uint8Array</span>&#125; -source:源文件</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">checkIsEncFile</span>(<span class="params">source</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> headSign=<span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">TBFileRules</span>.<span class="title function_">byteToStr</span>(<span class="title class_">TBFileRules</span>.<span class="title function_">unshif0</span>(source.<span class="title function_">slice</span>(<span class="number">0</span>,<span class="number">50</span>))))</span><br><span class="line">            <span class="keyword">if</span>(<span class="title class_">TBFileRules</span>.<span class="property">checkHeadSign</span>.<span class="title function_">indexOf</span>(headSign.<span class="property">sign</span>)&gt;-<span class="number">1</span>)<span class="keyword">return</span> headSign</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        加密文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">CryptoJSTB</span>&#125; -cjstb:CryptoJSTB 实例</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Uint8Array</span>&#125; -source:源文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125;     -ext:拓展</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">encData</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> &#123;cjstb,source,ext&#125;=opt</span><br><span class="line"></span><br><span class="line">            source=<span class="title class_">Array</span>.<span class="title function_">from</span>(source)</span><br><span class="line">            <span class="keyword">if</span>(!ext)ext=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> encDataU8=[],                               <span class="comment">//加密前的加密段</span></span><br><span class="line">                fileEnd=<span class="title class_">TBFileRules</span>.<span class="property">encDataLen</span>,             <span class="comment">//加密结束的位置</span></span><br><span class="line">                encDataSourceU8=[],                         <span class="comment">//加密后的加密段</span></span><br><span class="line">                sourceOtherData=[],                         <span class="comment">//未加密的部分</span></span><br><span class="line">                sourceEecData=[];                           <span class="comment">//未加密的部分</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(fileEnd&gt;source.<span class="property">length</span>)fileEnd=source.<span class="property">length</span></span><br><span class="line">            <span class="keyword">else</span> sourceOtherData=source.<span class="title function_">slice</span>(fileEnd)</span><br><span class="line"></span><br><span class="line">            encDataU8=source.<span class="title function_">slice</span>(<span class="number">0</span>,fileEnd)</span><br><span class="line">            encDataSourceU8=cjstb.<span class="title function_">encByteAES</span>(encDataU8)</span><br><span class="line">            sourceEecData=[...encDataSourceU8,...sourceOtherData]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> headerParams = <span class="title class_">TBFileRules</span>.<span class="title function_">generateHeaderByte</span>(&#123;</span><br><span class="line">                <span class="attr">fileLen</span>:source.<span class="property">length</span>,</span><br><span class="line">                <span class="attr">fileEncLen</span>:sourceEecData.<span class="property">length</span>,</span><br><span class="line">                <span class="attr">fileDataLen</span>:encDataU8.<span class="property">length</span>,</span><br><span class="line">                <span class="attr">fileDataEncLen</span>:encDataSourceU8.<span class="property">length</span>,</span><br><span class="line">                ext</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">var</span> headerSign = <span class="title class_">TBFileRules</span>.<span class="title function_">strToByte</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(headerSign.<span class="property">length</span>&lt;=<span class="number">50</span>)&#123;</span><br><span class="line">                <span class="keyword">let</span> ent=[]</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">50</span>-headerSign.<span class="property">length</span>;i++)&#123;ent.<span class="title function_">push</span>(<span class="number">0</span>)&#125;</span><br><span class="line">                headerSign=[...headerSign,...ent]</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_">reject</span>(&#123;<span class="attr">code</span>:<span class="number">0</span>,<span class="attr">msg</span>:<span class="string">&quot;headerSign.length  too long 50&quot;</span>&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> head=[...headerSign,...headerParams]</span><br><span class="line">           </span><br><span class="line">            <span class="keyword">if</span>(head.<span class="property">length</span>&lt;<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>.<span class="property">headLen</span>)&#123;</span><br><span class="line">                <span class="keyword">let</span> ent=[]</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>.<span class="property">headLen</span>-head.<span class="property">length</span>;i++)&#123;ent.<span class="title function_">push</span>(<span class="number">0</span>)&#125;</span><br><span class="line">                head=[...head,...ent]</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_">reject</span>(&#123;<span class="attr">code</span>:<span class="number">0</span>,<span class="attr">msg</span>:<span class="string">&quot;File head too long&quot;</span>&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_">resolve</span>(&#123;<span class="attr">code</span>:<span class="number">1</span>,<span class="attr">data</span>:<span class="keyword">new</span> <span class="title class_">Uint8Array</span>([...head,...sourceEecData])&#125;)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        解密密文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">CryptoJSTB</span>&#125; -cjstb:CryptoJSTB 实例</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Uint8Array</span>&#125; -source:源文件</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">decData</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> &#123;source,cjstb&#125;=opt</span><br><span class="line">            source=<span class="title class_">Array</span>.<span class="title function_">from</span>(source)</span><br><span class="line">            <span class="keyword">var</span> headSign=<span class="title class_">TBFileRules</span>.<span class="title function_">checkIsEncFile</span>(source)</span><br><span class="line">            <span class="keyword">if</span>(!headSign)&#123;</span><br><span class="line">                <span class="title function_">reject</span>(&#123;<span class="attr">code</span>:<span class="number">0</span>,<span class="attr">msg</span>:<span class="string">&quot;Failed to parse file&quot;</span>&#125;)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> headParamsByte = source.<span class="title function_">slice</span>(<span class="number">50</span>,headSign.<span class="property">headLen</span>)</span><br><span class="line">            <span class="keyword">var</span> headParamsByteUnfit0 = <span class="title class_">TBFileRules</span>.<span class="title function_">unshif0</span>(headParamsByte)</span><br><span class="line">            <span class="keyword">var</span> headParams = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">TBFileRules</span>.<span class="title function_">byteToStr</span>(headParamsByteUnfit0))</span><br><span class="line">            <span class="keyword">var</span> encData=source.<span class="title function_">slice</span>(headSign.<span class="property">headLen</span>,headSign.<span class="property">headLen</span> + headParams.<span class="property">fileDataEncLen</span>)</span><br><span class="line">            <span class="keyword">var</span> otherData=source.<span class="title function_">slice</span>(headSign.<span class="property">headLen</span> + headParams.<span class="property">fileDataEncLen</span>)</span><br><span class="line">            <span class="keyword">var</span> decData=cjstb.<span class="title function_">decByteAES</span>(encData)</span><br><span class="line">            <span class="title function_">resolve</span>(&#123;</span><br><span class="line">                <span class="attr">code</span>:<span class="number">1</span>,</span><br><span class="line">                <span class="attr">params</span>:headParams,</span><br><span class="line">                <span class="attr">data</span>:<span class="keyword">new</span> <span class="title class_">Uint8Array</span>([...decData,...otherData])</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        文件转u8</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">file</span>&#125;</span></span><br><span class="line"><span class="comment">        <span class="doctag">@return</span> &#123;<span class="type">Promise&lt;Uint8Array&gt;</span>&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">fileToUint8</span>(<span class="params">file</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span><br><span class="line">            reader.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;<span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(e.<span class="property">target</span>.<span class="property">result</span>))&#125;</span><br><span class="line">            reader.<span class="title function_">readAsArrayBuffer</span>(file);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">saveFile</span>(<span class="params">uint8List,fileName</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> blob=<span class="keyword">new</span> <span class="title class_">Blob</span>([uint8List]);</span><br><span class="line">        <span class="keyword">const</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">        link.<span class="property">href</span> = <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span><br><span class="line">        link.<span class="property">download</span> = fileName;</span><br><span class="line">        link.<span class="title function_">click</span>();</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">revokeObjectURL</span>(link.<span class="property">href</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">///去除字节最后的0</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">unshif0</span>(<span class="params">list</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> data=[...list]</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;list.<span class="property">length</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(data[data.<span class="property">length</span>-<span class="number">1</span>])<span class="keyword">return</span> data</span><br><span class="line">            <span class="keyword">else</span> data.<span class="title function_">pop</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">strToByte</span>(<span class="params">str</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line">        <span class="keyword">var</span> len, c;</span><br><span class="line">        len = str.<span class="property">length</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            c = str.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">            <span class="keyword">if</span> (c &gt;= <span class="number">0x010000</span> &amp;&amp; c &lt;= <span class="number">0x10FFFF</span>) &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">18</span>) &amp; <span class="number">0x07</span>) | <span class="number">0xF0</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>((c &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &gt;= <span class="number">0x000800</span> &amp;&amp; c &lt;= <span class="number">0x00FFFF</span>) &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x0F</span>) | <span class="number">0xE0</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>((c &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &gt;= <span class="number">0x000080</span> &amp;&amp; c &lt;= <span class="number">0x0007FF</span>) &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x1F</span>) | <span class="number">0xC0</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>((c &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(c &amp; <span class="number">0xFF</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">byteToStr</span>(<span class="params">utf8Bytes</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> unicodeStr =<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> pos = <span class="number">0</span>; pos &lt; utf8Bytes.<span class="property">length</span>;)&#123;</span><br><span class="line">            <span class="keyword">var</span> flag= utf8Bytes[pos];</span><br><span class="line">            <span class="keyword">var</span> unicode = <span class="number">0</span> ;</span><br><span class="line">            <span class="keyword">if</span> ((flag &gt;&gt;&gt;<span class="number">7</span>) === <span class="number">0</span> ) &#123;</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(utf8Bytes[pos]);</span><br><span class="line">                pos += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xFC</span>) === <span class="number">0xFC</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x3</span>) &lt;&lt; <span class="number">30</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">24</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">18</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">3</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">12</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">4</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">5</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xF8</span>) === <span class="number">0xF8</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x7</span>) &lt;&lt; <span class="number">24</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">18</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">12</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">3</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">4</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xF0</span>) === <span class="number">0xF0</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0xF</span>) &lt;&lt; <span class="number">18</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">12</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">3</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xE0</span>) === <span class="number">0xE0</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x1F</span>) &lt;&lt; <span class="number">12</span>;;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xC0</span>) === <span class="number">0xC0</span> )&#123; <span class="comment">//110</span></span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(utf8Bytes[pos]);</span><br><span class="line">                pos += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> unicodeStr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试demo <a href="https://github.com/TabbyCute/web_libs/tree/main/demos/crypto-js-bigfile">https://github.com/TabbyCute/web_libs/tree/main/demos/crypto-js-bigfile</a></p><p>项目使用 <a href="https://github.com/TabbyCute/web_libs/tree/main/libs/crypto-js-bigfile">https://github.com/TabbyCute/web_libs/tree/main/libs/crypto-js-bigfile</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;文本加密很好实现，但是文件加密就稍微麻烦点。&lt;/p&gt;
&lt;p&gt;但是我的预期加密的规则需要兼容老版本能够分辨出老版本未加密的文件，因为我们用户还可能查看老版本的聊天记录。能够分别不同版本规则的加密文件。文件不能全加密，效率要高。加密过后的文件大小，不能太大，要节约oss资源控制成本，这里我改成了一个参，可以手动设置加密后的文件新增的大小。视情况而定。&lt;/p&gt;
&lt;p&gt;最终的加密路线如下：&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="cryptojs" scheme="https://tabbycute.github.io/tags/cryptojs/"/>
    
    <category term="im" scheme="https://tabbycute.github.io/tags/im/"/>
    
  </entry>
  
  <entry>
    <title>查看yum软件的安装目录</title>
    <link href="https://tabbycute.github.io/2022/05/01/20220601%E6%9F%A5%E7%9C%8Byum%E5%AE%89%E8%A3%85%E7%9A%84%E8%BD%AF%E4%BB%B6%E4%BD%8D%E7%BD%AE/"/>
    <id>https://tabbycute.github.io/2022/05/01/20220601%E6%9F%A5%E7%9C%8Byum%E5%AE%89%E8%A3%85%E7%9A%84%E8%BD%AF%E4%BB%B6%E4%BD%8D%E7%BD%AE/</id>
    <published>2022-04-30T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.047Z</updated>
    
    <content type="html"><![CDATA[<p>今天使用yum 安装了一个软件，后来没有找到路径</p><p>1、首先安装一个redis</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># yum install redis</span></span><br></pre></td></tr></table></figure><p>2、查找redis的安装包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># rpm -qa|grep redis</span></span><br><span class="line">redis-3.2.10-2.el7.x86_64</span><br><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure><p>3、查找安装包的安装路径</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># rpm -ql redis-3.2.10-2.el7.x86_64</span></span><br><span class="line">/etc/logrotate.d/redis</span><br><span class="line">/etc/redis-sentinel.conf</span><br><span class="line">/etc/redis.conf</span><br><span class="line">/etc/systemd/system/redis-sentinel.service.d</span><br><span class="line">/etc/systemd/system/redis-sentinel.service.d/limit.conf</span><br><span class="line">/etc/systemd/system/redis.service.d</span><br><span class="line">/etc/systemd/system/redis.service.d/limit.conf</span><br><span class="line">/usr/bin/redis-benchmark</span><br><span class="line">/usr/bin/redis-check-aof</span><br><span class="line">/usr/bin/redis-check-rdb</span><br><span class="line">/usr/bin/redis-cli</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;今天使用yum 安装了一个软件，后来没有找到路径&lt;/p&gt;
&lt;p&gt;1、首先安装一个redis&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@iZbp1eem925ojwyx17ao9kZ ~]&lt;span class=&quot;comment&quot;&gt;# yum install redis&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="linux" scheme="https://tabbycute.github.io/categories/linux/"/>
    
    
    <category term="linux" scheme="https://tabbycute.github.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>IM聊天页面消息时间的展示(Flutter)</title>
    <link href="https://tabbycute.github.io/2022/04/25/20220425IM%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2%E6%B6%88%E6%81%AF%E6%97%B6%E9%97%B4%E7%9A%84%E5%B1%95%E7%A4%BAFlutter/"/>
    <id>https://tabbycute.github.io/2022/04/25/20220425IM%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2%E6%B6%88%E6%81%AF%E6%97%B6%E9%97%B4%E7%9A%84%E5%B1%95%E7%A4%BAFlutter/</id>
    <published>2022-04-24T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.047Z</updated>
    
    <content type="html"><![CDATA[<p>值得一提的是微信会根据手机系统的时间制度（24小时，12小时）展示的不一样的时间</p><blockquote><p>比如同一天 早上的11:30</p><p>24小时制 11:30</p><p>12小时制 上午 11:30</p></blockquote><p>下面时间为毫秒</p><p>数据结构因项目而异，请根据自己的项目适当更改</p><blockquote><p>dependencies: {intl: ^0.17.0}</p></blockquote><p>核心代码如下</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:intl/intl.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">String</span> _formatDate(<span class="built_in">DateTime</span> date, <span class="built_in">String</span> fmt) &#123;</span><br><span class="line">  DateFormat outputFormat = DateFormat(fmt);</span><br><span class="line">  <span class="keyword">return</span> outputFormat.format(date);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">String</span> _getTimeStringAutoShort2(<span class="built_in">int</span> timestamp, <span class="built_in">bool</span> mustIncludeTime) &#123;</span><br><span class="line">  <span class="comment">//当前日期</span></span><br><span class="line">  <span class="built_in">DateTime</span> currentDate = <span class="built_in">DateTime</span>.now();</span><br><span class="line">  <span class="built_in">int</span> currentYear = currentDate.year;</span><br><span class="line">  <span class="built_in">int</span> currentMonth = currentDate.month;</span><br><span class="line">  <span class="built_in">int</span> currentDateD = currentDate.day;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//传入的日期 millTime为毫秒级时间戳</span></span><br><span class="line">  <span class="built_in">DateTime</span> srcDate = <span class="built_in">DateTime</span>.fromMillisecondsSinceEpoch(timestamp);</span><br><span class="line">  <span class="built_in">int</span> srcYear = srcDate.year;</span><br><span class="line">  <span class="built_in">int</span> srcMonth = srcDate.month;</span><br><span class="line">  <span class="built_in">int</span> srcDateD = srcDate.day;</span><br><span class="line"></span><br><span class="line">  <span class="comment">///<span class="language-markdown">结果</span></span></span><br><span class="line">  <span class="built_in">String</span> ret = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> timeExtraStr =</span><br><span class="line">      mustIncludeTime ? <span class="string">&quot; &quot;</span> + _formatDate(srcDate, <span class="string">&quot;HH:mm&quot;</span>) : <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (srcYear == currentYear) &#123;</span><br><span class="line">    <span class="comment">///<span class="language-markdown">当年</span></span></span><br><span class="line">    <span class="built_in">int</span> currentTimestamp = currentDate.millisecondsSinceEpoch;</span><br><span class="line">    <span class="built_in">int</span> srcTimestamp = timestamp;</span><br><span class="line">    <span class="comment">// 相差时间（单位：毫秒）</span></span><br><span class="line">    <span class="built_in">int</span> deltaTime = (currentTimestamp - srcTimestamp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当天（月份和日期一致才是）</span></span><br><span class="line">    <span class="keyword">if</span> (currentMonth == srcMonth &amp;&amp; currentDateD == srcDateD) &#123;</span><br><span class="line">      ret = _formatDate(srcDate, <span class="string">&quot;HH:mm&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 当年 &amp;&amp; 当天之外的时间（即昨天及以前的时间）</span></span><br><span class="line">      <span class="comment">// 昨天（以“现在”的时候为基准-1天）</span></span><br><span class="line">      <span class="built_in">DateTime</span> yesterdayDate =</span><br><span class="line">          <span class="built_in">DateTime</span>.fromMillisecondsSinceEpoch(currentTimestamp - <span class="number">86400000</span> * <span class="number">1</span>);</span><br><span class="line">      <span class="comment">// 前天（以“现在”的时候为基准-2天）</span></span><br><span class="line">      <span class="built_in">DateTime</span> beforeYesterdayDate =</span><br><span class="line">          <span class="built_in">DateTime</span>.fromMillisecondsSinceEpoch(currentTimestamp - <span class="number">86400000</span> * <span class="number">2</span>);</span><br><span class="line">      <span class="comment">// 用目标日期的“月”和“天”跟上方计算出来的“昨天”进行比较，是最为准确的（如果用时间戳差值</span></span><br><span class="line">      <span class="comment">// 的形式，是不准确的，比如：现在时刻是2019年02月22日1:00、而srcDate是2019年02月21日23:00，</span></span><br><span class="line">      <span class="comment">// 这两者间只相差2小时，直接用“deltaTime/(3600 * 1000)” &gt; 24小时来判断是否昨天，就完全是扯蛋的逻辑了）</span></span><br><span class="line">      <span class="keyword">if</span> (srcMonth == (yesterdayDate.month) &amp;&amp; srcDateD == yesterdayDate.day) &#123;</span><br><span class="line">        ret = <span class="string">&quot;昨天&quot;</span> + timeExtraStr; <span class="comment">// -1d</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (srcMonth == (beforeYesterdayDate.month) &amp;&amp;</span><br><span class="line">          srcDateD == beforeYesterdayDate.day) &#123;</span><br><span class="line">        <span class="comment">// “前天”判断逻辑同上</span></span><br><span class="line">        ret = <span class="string">&quot;前天&quot;</span> + timeExtraStr; <span class="comment">// -2d</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 跟当前时间相差的小时数</span></span><br><span class="line">        <span class="keyword">var</span> deltaHour = (deltaTime / (<span class="number">3600</span> * <span class="number">1000</span>));</span><br><span class="line">        <span class="comment">// 如果小于或等 7*24小时就显示星期几</span></span><br><span class="line">        <span class="keyword">if</span> (deltaHour &lt;= <span class="number">7</span> * <span class="number">24</span>) &#123;</span><br><span class="line">          <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; weekday = [];</span><br><span class="line">          weekday.addAll([<span class="string">&quot;星期一&quot;</span>, <span class="string">&quot;星期二&quot;</span>, <span class="string">&quot;星期三&quot;</span>, <span class="string">&quot;星期四&quot;</span>, <span class="string">&quot;星期五&quot;</span>, <span class="string">&quot;星期六&quot;</span>, <span class="string">&quot;星期日&quot;</span>]);</span><br><span class="line">          <span class="comment">// 取出当前是星期几</span></span><br><span class="line">          <span class="keyword">var</span> weedayDesc = weekday[srcDate.weekday - <span class="number">1</span>];</span><br><span class="line">          ret = weedayDesc + timeExtraStr;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 否则直接显示完整日期时间</span></span><br><span class="line">          ret = _formatDate(srcDate, <span class="string">&quot;yyyy年M月d日&quot;</span>) + timeExtraStr;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">///<span class="language-markdown">往年</span></span></span><br><span class="line">    ret = _formatDate(srcDate, <span class="string">&quot;yyyy年M月d日&quot;</span>) + timeExtraStr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">聊天页面时间展示的最小差</span></span></span><br><span class="line"><span class="built_in">bool</span> check2TimeGap(<span class="built_in">int</span> t1, <span class="built_in">int</span> t2) &#123;</span><br><span class="line">  <span class="keyword">if</span> ((t1 - t2).abs() &gt; <span class="number">1000</span> * <span class="number">60</span> * <span class="number">5</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> 向新收到的消息列表时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> [msg] 新收到的消息</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> [curStartTime] 最近一条消息的时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line"><span class="built_in">List</span> msgListTimeHook(<span class="built_in">List</span> msgList) &#123;</span><br><span class="line">  <span class="built_in">List</span> result = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; msgList.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> item = msgList[i];</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">      item[<span class="string">&quot;viewTime&quot;</span>] = _getTimeStringAutoShort2(item[<span class="string">&quot;time&quot;</span>], <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (check2TimeGap(item[<span class="string">&quot;time&quot;</span>], msgList[i - <span class="number">1</span>][<span class="string">&quot;time&quot;</span>])) &#123;</span><br><span class="line">      item[<span class="string">&quot;viewTime&quot;</span>] = _getTimeStringAutoShort2(item[<span class="string">&quot;time&quot;</span>], <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    result.add(item);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> 向新收到的消息列表时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> </span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> * @msg 新收到的消息</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> @curStartTime 最近一条消息的时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> </span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line">msgAloneTimeHook(msg, curStartTime) &#123;</span><br><span class="line">  <span class="comment">// if(!curStartTime)&#123;</span></span><br><span class="line">  <span class="comment">//     msg.viewTime=_getTimeStringAutoShort2(item.time, true)</span></span><br><span class="line">  <span class="comment">// &#125;else&#123;</span></span><br><span class="line">  <span class="comment">//     if (check2TimeGap(msg.time,curStartTime)) &#123;</span></span><br><span class="line">  <span class="comment">//         msg.viewTime=_getTimeStringAutoShort2(item.time, true)</span></span><br><span class="line">  <span class="comment">//     &#125;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="comment">// return msg</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基本使用如下</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">  <span class="keyword">var</span> mes = [</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息12&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1630113816000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息11&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1661649816000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息11&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664090674000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息周一&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664177074000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息前天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664263474000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息1&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664381016000</span>&#125;,</span><br><span class="line">  ];</span><br><span class="line">  <span class="comment">// _getTimeStringAutoShort2(1664380797000, true);</span></span><br><span class="line">  <span class="keyword">var</span> a = msgListTimeHook(mes);</span><br><span class="line">  <span class="built_in">print</span>(a);</span><br><span class="line">  <span class="comment">// 用于聊天内容界面时</span></span><br><span class="line">  <span class="keyword">var</span> b = _getTimeStringAutoShort2(<span class="number">1550789954260</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">///<span class="language-markdown">用于会话列表“消息”界面时</span></span></span><br><span class="line">  <span class="keyword">var</span> c = _getTimeStringAutoShort2(<span class="number">1550789954260</span>, <span class="keyword">false</span>);</span><br><span class="line">  <span class="built_in">print</span>(a);</span><br><span class="line">  <span class="built_in">print</span>(b);</span><br><span class="line">  <span class="built_in">print</span>(c);</span><br><span class="line">  <span class="comment">// mes.forEach((i) &#123;</span></span><br><span class="line">  <span class="comment">//   _getTimeStringAutoShort2(i[&quot;time&quot;] as int, true);</span></span><br><span class="line">  <span class="comment">// &#125;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大概结果如下下面返回的结果并非使用上面的数据</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息12&#x27;</span>, <span class="attr">time</span>: <span class="number">1630113816000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;2021年8月28日 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息11&#x27;</span>, <span class="attr">time</span>: <span class="number">1661649816000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;2022年8月28日 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息10.5&#x27;</span>, <span class="attr">time</span>: <span class="number">1664159074000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;星期一 10:24&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息10&#x27;</span>, <span class="attr">time</span>: <span class="number">1664328216000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息9&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息8&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息7&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息6&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息5&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378676000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息4&#x27;</span>, <span class="attr">time</span>: <span class="number">1664379876000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:44&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息3&#x27;</span>, <span class="attr">time</span>: <span class="number">1664379936000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息2&#x27;</span>, <span class="attr">time</span>: <span class="number">1664380797000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:59&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息1&#x27;</span>, <span class="attr">time</span>: <span class="number">1664381016000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-1&#x27;</span>, <span class="attr">time</span>: <span class="number">1664440902124</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;16:41&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-2&#x27;</span>, <span class="attr">time</span>: <span class="number">1664440962124</span> &#125;</span><br><span class="line">]</span><br><span class="line">&#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-3&#x27;</span>, <span class="attr">time</span>: <span class="number">1664441027131</span> &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;值得一提的是微信会根据手机系统的时间制度（24小时，12小时）展示的不一样的时间&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;比如同一天 早上的11:30&lt;/p&gt;
&lt;p&gt;24小时制 11:30&lt;/p&gt;
&lt;p&gt;12小时制 上午 11:30&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;下面时间为毫秒&lt;/p&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="im" scheme="https://tabbycute.github.io/tags/im/"/>
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
  <entry>
    <title>IM聊天页面消息时间的展示(web)</title>
    <link href="https://tabbycute.github.io/2022/04/20/20220420IM%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2%E6%B6%88%E6%81%AF%E6%97%B6%E9%97%B4%E7%9A%84%E5%B1%95%E7%A4%BAweb/"/>
    <id>https://tabbycute.github.io/2022/04/20/20220420IM%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2%E6%B6%88%E6%81%AF%E6%97%B6%E9%97%B4%E7%9A%84%E5%B1%95%E7%A4%BAweb/</id>
    <published>2022-04-19T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.046Z</updated>
    
    <content type="html"><![CDATA[<p>值得一提的是微信会根据手机系统的时间制度（24小时，12小时）展示的不一样的时间</p><blockquote><p>比如同一天 早上的11:30</p><p>24小时制 11:30</p><p>12小时制 上午 11:30</p></blockquote><p>下面时间为毫秒</p><p>数据结构因项目而异</p><p>核心代码如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对Date的扩展，将 Date 转化为指定格式的String。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，</span></span><br><span class="line"><span class="comment"> *  年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  【示例】：</span></span><br><span class="line"><span class="comment"> *  common.formatDate(new Date(), &#x27;yyyy-MM-dd hh:mm:ss.S&#x27;) ==&gt; 2006-07-02 08:09:04.423</span></span><br><span class="line"><span class="comment"> *  common.formatDate(new Date(), &#x27;yyyy-M-d h:m:s.S&#x27;)      ==&gt; 2006-7-2 8:9:4.18</span></span><br><span class="line"><span class="comment"> *  common.formatDate(new Date(), &#x27;hh:mm:ss.S&#x27;)            ==&gt; 08:09:04.423</span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> _formatDate = <span class="keyword">function</span> (<span class="params">date, fmt</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> o = &#123;</span><br><span class="line">        <span class="string">&quot;M+&quot;</span>: date.<span class="title function_">getMonth</span>() + <span class="number">1</span>, <span class="comment">//月份</span></span><br><span class="line">        <span class="string">&quot;d+&quot;</span>: date.<span class="title function_">getDate</span>(), <span class="comment">//日</span></span><br><span class="line">        <span class="string">&quot;h+&quot;</span>: date.<span class="title function_">getHours</span>(), <span class="comment">//小时</span></span><br><span class="line">        <span class="string">&quot;m+&quot;</span>: date.<span class="title function_">getMinutes</span>(), <span class="comment">//分</span></span><br><span class="line">        <span class="string">&quot;s+&quot;</span>: date.<span class="title function_">getSeconds</span>(), <span class="comment">//秒</span></span><br><span class="line">        <span class="string">&quot;q+&quot;</span>: <span class="title class_">Math</span>.<span class="title function_">floor</span>((date.<span class="title function_">getMonth</span>() + <span class="number">3</span>) / <span class="number">3</span>), <span class="comment">//季度</span></span><br><span class="line">        <span class="string">&quot;S&quot;</span>: date.<span class="title function_">getMilliseconds</span>() <span class="comment">//毫秒</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/(y+)/</span>.<span class="title function_">test</span>(fmt)) fmt = fmt.<span class="title function_">replace</span>(<span class="title class_">RegExp</span>.<span class="property">$1</span>, (date.<span class="title function_">getFullYear</span>() + <span class="string">&quot;&quot;</span>).<span class="title function_">substr</span>(<span class="number">4</span> - <span class="title class_">RegExp</span>.<span class="property">$1</span>.<span class="property">length</span>));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> o)</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">&quot;(&quot;</span> + k + <span class="string">&quot;)&quot;</span>).<span class="title function_">test</span>(fmt)) fmt = fmt.<span class="title function_">replace</span>(<span class="title class_">RegExp</span>.<span class="property">$1</span>, (<span class="title class_">RegExp</span>.<span class="property">$1</span>.<span class="property">length</span> == <span class="number">1</span>) ? (o[k]) : ((<span class="string">&quot;00&quot;</span> + o[k]).<span class="title function_">substr</span>((<span class="string">&quot;&quot;</span> + o[k]).<span class="property">length</span>)));</span><br><span class="line">    <span class="keyword">return</span> fmt;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 仿照微信中的消息时间显示逻辑，将时间戳（单位：毫秒）转换为友好的显示格式.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1）7天之内的日期显示逻辑是：今天、昨天(-1d)、前天(-2d)、星期？（只显示总计7天之内的星期数，即&lt;=-4d）；</span></span><br><span class="line"><span class="comment"> * 2）7天之外（即&gt;7天）的逻辑：直接显示完整日期时间。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[long]</span>&#125; timestamp 时间戳（单位：毫秒），形如：1550789954260</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">boolean</span>&#125; mustIncludeTime true表示输出的格式里一定会包含“时间:分钟”</span></span><br><span class="line"><span class="comment"> * ，否则不包含（参考微信，不包含时分的情况，用于首页“消息”中显示时）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> _getTimeStringAutoShort2 = <span class="keyword">function</span> (<span class="params">timestamp, mustIncludeTime</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前时间</span></span><br><span class="line">    <span class="keyword">var</span> currentDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="comment">// 目标判断时间</span></span><br><span class="line">    <span class="keyword">var</span> srcDate = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="built_in">parseInt</span>(timestamp));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> currentYear = currentDate.<span class="title function_">getFullYear</span>();</span><br><span class="line">    <span class="keyword">var</span> currentMonth = (currentDate.<span class="title function_">getMonth</span>() + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">var</span> currentDateD = currentDate.<span class="title function_">getDate</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> srcYear = srcDate.<span class="title function_">getFullYear</span>();</span><br><span class="line">    <span class="keyword">var</span> srcMonth = (srcDate.<span class="title function_">getMonth</span>() + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">var</span> srcDateD = srcDate.<span class="title function_">getDate</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> ret = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 要额外显示的时间分钟</span></span><br><span class="line">    <span class="keyword">var</span> timeExtraStr = (mustIncludeTime ? <span class="string">&quot; &quot;</span> + <span class="title function_">_formatDate</span>(srcDate, <span class="string">&quot;hh:mm&quot;</span>) : <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当年</span></span><br><span class="line">    <span class="keyword">if</span> (currentYear == srcYear) &#123;</span><br><span class="line">        <span class="keyword">var</span> currentTimestamp = currentDate.<span class="title function_">getTime</span>();</span><br><span class="line">        <span class="keyword">var</span> srcTimestamp = timestamp;</span><br><span class="line">        <span class="comment">// 相差时间（单位：毫秒）</span></span><br><span class="line">        <span class="keyword">var</span> deltaTime = (currentTimestamp - srcTimestamp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当天（月份和日期一致才是）</span></span><br><span class="line">        <span class="keyword">if</span> (currentMonth == srcMonth &amp;&amp; currentDateD == srcDateD) &#123;</span><br><span class="line">                ret = <span class="title function_">_formatDate</span>(srcDate, <span class="string">&quot;hh:mm&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 当年 &amp;&amp; 当天之外的时间（即昨天及以前的时间）</span></span><br><span class="line">            <span class="comment">// 昨天（以“现在”的时候为基准-1天）</span></span><br><span class="line">            <span class="keyword">var</span> yesterdayDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">            yesterdayDate.<span class="title function_">setDate</span>(yesterdayDate.<span class="title function_">getDate</span>() - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 前天（以“现在”的时候为基准-2天）</span></span><br><span class="line">            <span class="keyword">var</span> beforeYesterdayDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">            beforeYesterdayDate.<span class="title function_">setDate</span>(beforeYesterdayDate.<span class="title function_">getDate</span>() - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 用目标日期的“月”和“天”跟上方计算出来的“昨天”进行比较，是最为准确的（如果用时间戳差值</span></span><br><span class="line">            <span class="comment">// 的形式，是不准确的，比如：现在时刻是2019年02月22日1:00、而srcDate是2019年02月21日23:00，</span></span><br><span class="line">            <span class="comment">// 这两者间只相差2小时，直接用“deltaTime/(3600 * 1000)” &gt; 24小时来判断是否昨天，就完全是扯蛋的逻辑了）</span></span><br><span class="line">            <span class="keyword">if</span> (srcMonth == (yesterdayDate.<span class="title function_">getMonth</span>() + <span class="number">1</span>) &amp;&amp; srcDateD == yesterdayDate.<span class="title function_">getDate</span>())</span><br><span class="line">                ret = <span class="string">&quot;昨天&quot;</span> + timeExtraStr; <span class="comment">// -1d</span></span><br><span class="line">            <span class="comment">// “前天”判断逻辑同上</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (srcMonth == (beforeYesterdayDate.<span class="title function_">getMonth</span>() + <span class="number">1</span>) &amp;&amp; srcDateD == beforeYesterdayDate.<span class="title function_">getDate</span>())&#123;</span><br><span class="line">                ret = <span class="string">&quot;前天&quot;</span> + timeExtraStr; <span class="comment">// -2d</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 跟当前时间相差的小时数</span></span><br><span class="line">                <span class="keyword">var</span> deltaHour = (deltaTime / (<span class="number">3600</span> * <span class="number">1000</span>));</span><br><span class="line">                <span class="comment">// 如果小于或等 7*24小时就显示星期几</span></span><br><span class="line">                <span class="keyword">if</span> (deltaHour &lt;= <span class="number">7</span> * <span class="number">24</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> weekday = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">7</span>);</span><br><span class="line">                    weekday[<span class="number">0</span>] = <span class="string">&quot;星期日&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">1</span>] = <span class="string">&quot;星期一&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">2</span>] = <span class="string">&quot;星期二&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">3</span>] = <span class="string">&quot;星期三&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">4</span>] = <span class="string">&quot;星期四&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">5</span>] = <span class="string">&quot;星期五&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">6</span>] = <span class="string">&quot;星期六&quot;</span>;</span><br><span class="line">                    <span class="comment">// 取出当前是星期几</span></span><br><span class="line">                    <span class="keyword">var</span> weedayDesc = weekday[srcDate.<span class="title function_">getDay</span>()];</span><br><span class="line">                    ret = weedayDesc + timeExtraStr;</span><br><span class="line">                &#125; <span class="keyword">else</span>&#123;<span class="comment">// 否则直接显示完整日期时间</span></span><br><span class="line">                    ret = <span class="title function_">_formatDate</span>(srcDate, <span class="string">&quot;yyyy年M月d日&quot;</span>) + timeExtraStr;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 往年</span></span><br><span class="line">        ret = <span class="title function_">_formatDate</span>(srcDate, <span class="string">&quot;yyyy年M月d日&quot;</span>) + timeExtraStr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">///聊天页面时间展示的最小差</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check2TimeGap</span>(<span class="params">t1, t2</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">abs</span>(t1 - t2) &gt; <span class="number">1000</span> * <span class="number">60</span> * <span class="number">5</span>) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 向新收到的消息列表时间</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@msg</span> 新收到的消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@curStartTime</span> 最近一条消息的时间</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">msgListTimeHook</span>(<span class="params">msgList,startTime</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> result=[]</span><br><span class="line">    msgList.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">            item.<span class="property">viewTime</span>=<span class="title function_">_getTimeStringAutoShort2</span>(item.<span class="property">time</span>, <span class="literal">true</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">check2TimeGap</span>(item.<span class="property">time</span>, mes[index-<span class="number">1</span>].<span class="property">time</span>)) &#123;</span><br><span class="line">            item.<span class="property">viewTime</span>=<span class="title function_">_getTimeStringAutoShort2</span>(item.<span class="property">time</span>, <span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        result.<span class="title function_">push</span>(item)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 向新收到的消息列表时间</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@msg</span> 新收到的消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@curStartTime</span> 最近一条消息的时间</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">msgAloneTimeHook</span>(<span class="params">msg,curStartTime</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!curStartTime)&#123;</span><br><span class="line">        msg.<span class="property">viewTime</span>=<span class="title function_">_getTimeStringAutoShort2</span>(item.<span class="property">time</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">check2TimeGap</span>(msg.<span class="property">time</span>,curStartTime)) &#123;</span><br><span class="line">            msg.<span class="property">viewTime</span>=<span class="title function_">_getTimeStringAutoShort2</span>(item.<span class="property">time</span>, <span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基本使用如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息12&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1630113816000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息11&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1661649816000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息10.5&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664159074000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息10&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664328216000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息9&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378616000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息8&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378616000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息7&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378616000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息6&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378616000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息5&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378676000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息4&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664379876000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息3&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664379936000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息2&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664380797000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息1&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664381016000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息-1&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">valueOf</span>()-<span class="number">125</span>*<span class="number">1000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息-2&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">valueOf</span>()-<span class="number">65</span>*<span class="number">1000</span></span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">///向消息列表中添加时间</span></span><br><span class="line">mes=<span class="title function_">msgListTimeHook</span>(mes)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(mes)</span><br><span class="line"><span class="comment">///收到消息时判断是否需要展示时间</span></span><br><span class="line"><span class="keyword">var</span> curStartTime=mes[mes.<span class="property">length</span>-<span class="number">1</span>].<span class="property">time</span></span><br><span class="line"><span class="keyword">var</span> newmsg=<span class="title function_">msgAloneTimeHook</span>(&#123;</span><br><span class="line">    <span class="attr">m</span>: <span class="string">&quot;我是一条消息-3&quot;</span>,</span><br><span class="line">    <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">valueOf</span>()</span><br><span class="line">&#125;,curStartTime)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newmsg)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于聊天内容界面时</span></span><br><span class="line"><span class="title function_">_getTimeStringAutoShort2</span>(<span class="number">1550789954260</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="comment">///用于会话列表“消息”界面时</span></span><br><span class="line"><span class="title function_">_getTimeStringAutoShort2</span>(<span class="number">1550789954260</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>结果如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息12&#x27;</span>, <span class="attr">time</span>: <span class="number">1630113816000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;2021年8月28日 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息11&#x27;</span>, <span class="attr">time</span>: <span class="number">1661649816000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;2022年8月28日 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息10.5&#x27;</span>, <span class="attr">time</span>: <span class="number">1664159074000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;星期一 10:24&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息10&#x27;</span>, <span class="attr">time</span>: <span class="number">1664328216000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息9&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息8&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息7&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息6&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息5&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378676000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息4&#x27;</span>, <span class="attr">time</span>: <span class="number">1664379876000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:44&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息3&#x27;</span>, <span class="attr">time</span>: <span class="number">1664379936000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息2&#x27;</span>, <span class="attr">time</span>: <span class="number">1664380797000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:59&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息1&#x27;</span>, <span class="attr">time</span>: <span class="number">1664381016000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-1&#x27;</span>, <span class="attr">time</span>: <span class="number">1664440902124</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;16:41&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-2&#x27;</span>, <span class="attr">time</span>: <span class="number">1664440962124</span> &#125;</span><br><span class="line">]</span><br><span class="line">&#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-3&#x27;</span>, <span class="attr">time</span>: <span class="number">1664441027131</span> &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;值得一提的是微信会根据手机系统的时间制度（24小时，12小时）展示的不一样的时间&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;比如同一天 早上的11:30&lt;/p&gt;
&lt;p&gt;24小时制 11:30&lt;/p&gt;
&lt;p&gt;12小时制 上午 11:30&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;下面时间为毫秒&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="im" scheme="https://tabbycute.github.io/tags/im/"/>
    
  </entry>
  
  <entry>
    <title>在vue的data中调用computed的属性异常</title>
    <link href="https://tabbycute.github.io/2022/01/02/20220102%E5%9C%A8vue%E7%9A%84data%E4%B8%AD%E8%B0%83%E7%94%A8computed%E7%9A%84%E5%B1%9E%E6%80%A7%E5%BC%82%E5%B8%B8/"/>
    <id>https://tabbycute.github.io/2022/01/02/20220102%E5%9C%A8vue%E7%9A%84data%E4%B8%AD%E8%B0%83%E7%94%A8computed%E7%9A%84%E5%B1%9E%E6%80%A7%E5%BC%82%E5%B8%B8/</id>
    <published>2022-01-01T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.046Z</updated>
    
    <content type="html"><![CDATA[<p>先看问题</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">data</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line"><span class="attr">name</span>:<span class="variable language_">this</span>.<span class="property">nickname</span> <span class="comment">//undefined</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">computed</span>:&#123;</span><br><span class="line"><span class="title function_">nickname</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;1111&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这里很容易想到是执行顺序的问题，computed中的属性和data中的属性最终都会加载到app这个实例下。</p><p>如果data中的实例属性被创建完成的时候，computed中的实例属性还没被创建，很明显，在data中获取到computed中的属性必定是undefined…</p><p>解决方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">name</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">nickname</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用name() 或者直接在computed中对data中的属性赋值，因为此时data已经初始化。</span></span><br></pre></td></tr></table></figure><p>看似简单实际有很多小伙伴都不知道。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;先看问题&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title function_&quot;&gt;data&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;:&lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;nickname&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;//undefined&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;computed&lt;/span&gt;:&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;title function_&quot;&gt;nickname&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;1111&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在这里很容易想到是执行顺序的问题，computed中的属性和data中的属性最终都会加载到app这个实例下。&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="vue" scheme="https://tabbycute.github.io/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>Google Face web端登录</title>
    <link href="https://tabbycute.github.io/2021/12/20/20211220GoogleFaceweb%E7%AB%AF%E7%99%BB%E5%BD%95/"/>
    <id>https://tabbycute.github.io/2021/12/20/20211220GoogleFaceweb%E7%AB%AF%E7%99%BB%E5%BD%95/</id>
    <published>2021-12-19T16:00:00.000Z</published>
    <updated>2022-11-07T14:29:47.046Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Google"><a href="#Google" class="headerlink" title="Google"></a>Google</h4><hr><ul><li>一定要使用最新的文档。<a href="https://developers.google.com/identity/gsi/web/guides/migration">https://developers.google.com/identity/gsi/web/guides/migration</a></li><li>控制台 <a href="https://console.cloud.google.com/apis/dashboard?project=tabbyceshi">https://console.cloud.google.com/apis/dashboard?project=tabbyceshi</a></li><li>应用 <a href="https://console.cloud.google.com/apis/credentials?project=tabbyceshi&amp;supportedpurview=project">https://console.cloud.google.com/apis/credentials?project=tabbyceshi&amp;supportedpurview=project</a></li></ul><p>测试demo</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;meta name=&quot;google-signin-client_id&quot; content=&quot;466619277311-sk2aoc77hg88lm4llvk74cbiq63utk9i.apps.googleusercontent.com&quot;&gt; --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;script src=&quot;https://accounts.google.com/gsi/client&quot; async defer&gt;&lt;/script&gt; --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;div class=&quot;g-signin2&quot; data-onsuccess=&quot;onSignIn&quot;&gt;222&lt;/div&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://accounts.google.com/gsi/client&quot;</span> <span class="attr">async</span> <span class="attr">defer</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;g_id_onload&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-login_uri</span>=<span class="string">&quot;http://localhost:5500/google.html&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-auto_prompt</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-client_id</span>=<span class="string">&quot;541694494382-p228lh72cbf9smp0greo8kekhvetkep3.apps.googleusercontent.com&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-callback</span>=<span class="string">&quot;handleCredentialResponse&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g_id_signin&quot;</span> <span class="attr">data-type</span>=<span class="string">&quot;standard&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handleCredentialResponse</span>(<span class="params">e</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>简易使用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">class</span> <span class="title class_">GoogleSDK</span> &#123;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">appendHtmlDOM</span>(<span class="params">attrs=[],dom=<span class="string">&#x27;script&#x27;</span></span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,_</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="keyword">var</span> body = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;body&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(dom);</span><br><span class="line">attrs.<span class="title function_">forEach</span>(<span class="function"><span class="params">i</span>=&gt;</span>&#123;script.<span class="title function_">setAttribute</span>(i.<span class="property">key</span>,i.<span class="property">value</span>)&#125;)</span><br><span class="line">body.<span class="title function_">appendChild</span>(script);</span><br><span class="line">script.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;<span class="title function_">resolve</span>()&#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">async</span> <span class="title class_">GetAaccessToken</span>(client_id) &#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="keyword">await</span> <span class="title class_">GoogleSDK</span>.<span class="title function_">appendHtmlDOM</span>([</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;src&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;https://accounts.google.com/gsi/client&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;type&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;text/javascript&quot;</span>&#125;,</span><br><span class="line">])</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">var</span> client= google.<span class="property">accounts</span>.<span class="property">oauth2</span>.<span class="title function_">initTokenClient</span>(&#123;</span><br><span class="line">client_id,</span><br><span class="line"><span class="attr">scope</span>: <span class="string">&#x27;https://www.googleapis.com/auth/calendar.readonly \ https://www.googleapis.com/auth/contacts.readonly&#x27;</span>,</span><br><span class="line"><span class="attr">callback</span>: <span class="function">(<span class="params">tokenResponse</span>) =&gt;</span> &#123;<span class="title function_">resolve</span>(tokenResponse)&#125;,</span><br><span class="line">&#125;);</span><br><span class="line">client.<span class="title function_">requestAccessToken</span>();</span><br><span class="line">&#125;)</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">revokeToken</span>(<span class="params">access_token</span>) &#123;</span><br><span class="line">google.<span class="property">accounts</span>.<span class="property">oauth2</span>.<span class="title function_">revoke</span>(access_token, <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;access token revoked&#x27;</span>) &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">async</span> <span class="title class_">UserLogin</span>(client_id) &#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">await</span> <span class="title class_">GoogleSDK</span>.<span class="title function_">appendHtmlDOM</span>([</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;src&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;https://accounts.google.com/gsi/client&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;type&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;text/javascript&quot;</span>&#125;,</span><br><span class="line">])</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">千万别放在有v-if的操作里面！！！</span></span><br><span class="line"><span class="comment">window.handleCredentialResponse=function(e)&#123;</span></span><br><span class="line"><span class="comment">console.log(e)</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">//需要写在html里面</span></span><br><span class="line"><span class="comment">&lt;div id=&quot;g_id_onload&quot;</span></span><br><span class="line"><span class="comment">data-login_uri=&quot;http://localhost:5500/google.html&quot;</span></span><br><span class="line"><span class="comment">data-auto_prompt=&quot;false&quot;</span></span><br><span class="line"><span class="comment">data-client_id=&quot;******&quot;</span></span><br><span class="line"><span class="comment">data-callback=&quot;handleCredentialResponse&quot;&gt;</span></span><br><span class="line"><span class="comment">&lt;/div&gt;</span></span><br><span class="line"><span class="comment">//点击即可登录，触发上面的handleCredentialResponse</span></span><br><span class="line"><span class="comment">&lt;div class=&quot;g_id_signin&quot; data-type=&quot;standard&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>相关报错。先尝试清缓存。如果是 vue/react 把 <script src="https://accounts.google.com/gsi/client" async defer></script> 放在模板文件的head里面</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Uncaught dw</span><br><span class="line"></span><br><span class="line">不能用127.0.0.1</span><br><span class="line">可以切换成http://localhost:**********</span><br></pre></td></tr></table></figure><p><img src="/assets/img/202112201.png"><br><img src="/assets/img/202112202.png"></p><h4 id="FaceBook"><a href="#FaceBook" class="headerlink" title="FaceBook"></a>FaceBook</h4><hr><ul><li>开发者 <a href="https://developers.facebook.com/docs/development/register?locale=zh_CN">https://developers.facebook.com/docs/development/register?locale=zh_CN</a></li><li>应用 <a href="https://developers.facebook.com/apps/?show_reminder=true">https://developers.facebook.com/apps/?show_reminder=true</a></li><li>白名单 <a href="https://developers.facebook.com/apps/1531808977238106/gaming-login/settings/">https://developers.facebook.com/apps/1531808977238106/gaming-login/settings/</a><br>demo<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Facebook Login JavaScript Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">checkLoginState</span>(<span class="params"></span>) &#123;               <span class="comment">// Called when a person is finished with the Login Button.</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable constant_">FB</span>.<span class="title function_">getLoginStatus</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;   <span class="comment">// See the onlogin handler</span></span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="property">fbAsyncInit</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable constant_">FB</span>.<span class="title function_">init</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">appId</span>: <span class="string">&#x27;**********&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">cookie</span>: <span class="literal">true</span>,                     <span class="comment">// Enable cookies to allow the server to access the session.</span></span></span><br><span class="line"><span class="language-javascript">                <span class="attr">xfbml</span>: <span class="literal">true</span>,                     <span class="comment">// Parse social plugins on this webpage.</span></span></span><br><span class="line"><span class="language-javascript">                <span class="attr">version</span>: <span class="string">&#x27;v14.0&#x27;</span>                  <span class="comment">// Use this Graph API version for this call.</span></span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            <span class="variable constant_">FB</span>.<span class="title function_">getLoginStatus</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;   <span class="comment">// Called after the JS SDK has been initialized.</span></span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(response);               <span class="comment">// The current login status of the person.</span></span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//   function testAPI() &#123;                      // Testing Graph API after login.  See statusChangeCallback() for when this call is made.</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//     console.log(&#x27;Welcome!  Fetching your information.... &#x27;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//     FB.api(&#x27;/me&#x27;, function(response) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//       console.log(&#x27;Successful login for: &#x27; + response.name);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//       document.getElementById(&#x27;status&#x27;).innerHTML = &#x27;Thanks for logging in, &#x27; + response.name + &#x27;!&#x27;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//     &#125;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//   &#125;</span></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- The JS SDK Login Button --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fb:login-button</span> <span class="attr">scope</span>=<span class="string">&quot;public_profile,email&quot;</span> <span class="attr">onlogin</span>=<span class="string">&quot;checkLoginState();&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">fb:login-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;status&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Load the JS SDK asynchronously --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">async</span> <span class="attr">defer</span> <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://connect.facebook.net/en_US/sdk.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>简易使用<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FaceBookSDK</span> &#123;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">appendJSscript</span>(<span class="params">attrs=[]</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,_</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">var</span> body = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;body&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">attrs.<span class="title function_">forEach</span>(<span class="function"><span class="params">i</span>=&gt;</span>&#123;script.<span class="title function_">setAttribute</span>(i.<span class="property">key</span>,i.<span class="property">value</span>)&#125;)</span><br><span class="line">body.<span class="title function_">appendChild</span>(script);</span><br><span class="line">script.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;<span class="title function_">resolve</span>()&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">async</span> <span class="title class_">FBLogin</span>(appId) &#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="keyword">await</span> <span class="title class_">FaceBookSDK</span>.<span class="title function_">appendJSscript</span>([</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;src&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;https://connect.facebook.net/en_US/sdk.js&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;type&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;text/javascript&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;crossorigin&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;anonymous&quot;</span>&#125;,</span><br><span class="line">])</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">fbAsyncInit</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable constant_">FB</span>.<span class="title function_">init</span>(&#123;appId,<span class="attr">cookie</span>:<span class="literal">true</span>,<span class="attr">xfbml</span>:<span class="literal">true</span>,<span class="attr">version</span>:<span class="string">&#x27;v14.0&#x27;</span>&#125;);</span><br><span class="line"><span class="variable constant_">FB</span>.<span class="title function_">getLoginStatus</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;</span><br><span class="line"><span class="variable constant_">FB</span>.<span class="title function_">login</span>(<span class="keyword">function</span>(<span class="params">a</span>) &#123;</span><br><span class="line"><span class="title function_">resolve</span>(a)</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="title class_">FaceBookSDK</span>.<span class="title class_">FBLogin</span>(<span class="string">&quot;*****&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">e</span>=&gt;</span>&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <summary type="html">&lt;h4 id=&quot;Google&quot;&gt;&lt;a href=&quot;#Google&quot; class=&quot;headerlink&quot; title=&quot;Google&quot;&gt;&lt;/a&gt;Google&lt;/h4&gt;&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;一定要使用最新的文档。&lt;a href=&quot;https://developers.google.com/identity/gsi/web/guides/migration&quot;&gt;https://developers.google.com/identity/gsi/web/guides/migration&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;控制台 &lt;a href=&quot;https://console.cloud.google.com/apis/dashboard?project=tabbyceshi&quot;&gt;https://console.cloud.google.com/apis/dashboard?project=tabbyceshi&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;应用 &lt;a href=&quot;https://console.cloud.google.com/apis/credentials?project=tabbyceshi&amp;amp;supportedpurview=project&quot;&gt;https://console.cloud.google.com/apis/credentials?project=tabbyceshi&amp;amp;supportedpurview=project&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="Google Sign" scheme="https://tabbycute.github.io/tags/Google-Sign/"/>
    
    <category term="Face Sign" scheme="https://tabbycute.github.io/tags/Face-Sign/"/>
    
  </entry>
  
  <entry>
    <title>dart类中的构造函数</title>
    <link href="https://tabbycute.github.io/2021/12/09/20211219flutter%E7%B1%BB%E4%B8%AD%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/"/>
    <id>https://tabbycute.github.io/2021/12/09/20211219flutter%E7%B1%BB%E4%B8%AD%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/</id>
    <published>2021-12-08T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.281Z</updated>
    
    <content type="html"><![CDATA[<h3 id="传统的构造函数"><a href="#传统的构造函数" class="headerlink" title="传统的构造函数"></a>传统的构造函数</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line"><span class="built_in">int</span> age = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> id = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">String?</span> name=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">Student(<span class="built_in">int</span> age, <span class="built_in">int</span> id) &#123;</span><br><span class="line"><span class="keyword">this</span>.age = age;</span><br><span class="line"><span class="keyword">this</span>.id = id;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="命名构造函数"><a href="#命名构造函数" class="headerlink" title="命名构造函数"></a>命名构造函数</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line"><span class="built_in">int?</span> age = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int?</span> id = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">String?</span> name=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">Student(<span class="keyword">this</span>.age, <span class="keyword">this</span>.id,);</span><br><span class="line"></span><br><span class="line">Student.fromJson(<span class="built_in">Map</span> data) &#123;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;命名构造函数&#x27;</span>);</span><br><span class="line"><span class="keyword">this</span>.name=data[<span class="string">&quot;name&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b=Student.fromJson(&#123;<span class="string">&quot;firstName&quot;</span>:<span class="string">&quot;AAAAA&quot;</span>&#125;);</span><br><span class="line"><span class="built_in">print</span>(b.firstName);<span class="comment">///<span class="language-markdown">AAAAA</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>Student.fromJson 不固定也可以叫Student.fromJson1，Student.fromJson2</p></blockquote><h3 id="继承构造函数的执行顺序"><a href="#继承构造函数的执行顺序" class="headerlink" title="继承构造函数的执行顺序"></a>继承构造函数的执行顺序</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String?</span> firstName;</span><br><span class="line">  Student()&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;in Student con&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Student.fromJson(<span class="built_in">Map</span> data) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;in Student&#x27;</span>);</span><br><span class="line">    <span class="keyword">this</span>.firstName=data[<span class="string">&quot;firstName&quot;</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jone</span> <span class="keyword">extends</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">   Jone()&#123;</span><br><span class="line">     <span class="built_in">print</span>(<span class="string">&#x27;in Jone con&#x27;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">  Jone.fromJson(<span class="built_in">Map</span> data) : <span class="keyword">super</span>.fromJson(data) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;in Jone&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b=Student.fromJson(&#123;<span class="string">&quot;firstName&quot;</span>:<span class="string">&quot;AAAAA&quot;</span>&#125;);</span><br><span class="line"><span class="built_in">print</span>(b.firstName);</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">in Student</span></span></span><br><span class="line"><span class="comment">///<span class="language-markdown">AAAAA</span></span></span><br></pre></td></tr></table></figure><ul><li>调用初始化列表（初始化列表就是在构造函数执行之前执行的代码，和调用父类的构造函数一样，也使用：操作符，如下所示：）<blockquote><p>下面：后面的赋值就是出初始化列表</p></blockquote><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Point.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">double</span>&gt; json)</span><br><span class="line">    : x = json[<span class="string">&#x27;x&#x27;</span>]!,</span><br><span class="line">      y = json[<span class="string">&#x27;y&#x27;</span>]! &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;In Point.fromJson(): (<span class="subst">$x</span>, <span class="subst">$y</span>)&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>调用父类的构造函数</li><li>调用自己的构造函数</li></ul><h3 id="重定向构造函数"><a href="#重定向构造函数" class="headerlink" title="重定向构造函数"></a>重定向构造函数</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">  <span class="built_in">double</span> x, y;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 主构造函数</span></span><br><span class="line">  Point(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 构造函数</span></span><br><span class="line">  Point.formJson(<span class="built_in">double</span> x)&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重定向到主构造函数</span></span><br><span class="line">  Point.alongXAxis(<span class="built_in">double</span> x) : <span class="keyword">this</span>(x, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 重定向到formJson构造函数</span></span><br><span class="line">  Point.alongXAxis2(<span class="built_in">double</span> x) : <span class="keyword">this</span>.formJson(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="工厂构造函数"><a href="#工厂构造函数" class="headerlink" title="工厂构造函数"></a>工厂构造函数</h3><p>默认情况下，dart类中的构造函数返回的是该类的<strong>新实例</strong>，但是我们在实际的应用中可能会对返回的对象做些选择，比如从缓存中返回已经存在的对象，或者返回该类具体的实现子类。为了实现这样的功能，dart中专门有一个Factory关键字，使用Factory的构造函数叫做工厂构造函数。</p><p>那么问题来了，factory构造函数和普通构造函数到底有什么区别呢?最大的区别就是普通构造函数是没有返回值的，而factory构造函数需要一个返回值。</p><blockquote><p>Map.putIfAbsent方法回顾，下面备用</p></blockquote><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Map</span> user = &#123; <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Tom&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b=user.putIfAbsent(<span class="string">&#x27;job&#x27;</span>, () =&gt; <span class="string">&#x27;engineer&#x27;</span>);</span><br><span class="line"><span class="built_in">print</span>(user);</span><br><span class="line"><span class="built_in">print</span>(b);</span><br><span class="line"></span><br><span class="line">b=user.putIfAbsent(<span class="string">&#x27;job&#x27;</span>, () =&gt; <span class="string">&#x27;engineer22222222222&#x27;</span>);</span><br><span class="line"><span class="built_in">print</span>(user);</span><br><span class="line"><span class="built_in">print</span>(b);</span><br><span class="line">  </span><br><span class="line"><span class="comment">//     &#123;name: Tom, age: 20, job: engineer&#125;</span></span><br><span class="line"><span class="comment">//     engineer</span></span><br><span class="line"><span class="comment">//     &#123;name: Tom, age: 20, job: engineer&#125;</span></span><br><span class="line"><span class="comment">//     engineer</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure><p>例子</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    Student stu0 = Student(<span class="string">&quot;dart0&quot;</span>,<span class="number">99</span>);</span><br><span class="line">    Student stu1 = Student(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    Student stu2 = Student(<span class="string">&quot;dart&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    Student stu3 = Student.fromJson(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dart&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">3</span>&#125;);</span><br><span class="line">    Student stu4 = Student.fromJson2(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dart&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">4</span>&#125;);</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>); </span><br><span class="line">    <span class="comment">// 使用 Student() 工厂构造函数 和 Student.fromJson(&#123;&#125;) 工厂构造函数创建出来的对象是同一个对象</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu0, stu1));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu1, stu2));  <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu2, stu3));  <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu3, stu4));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>);</span><br><span class="line">    <span class="built_in">print</span>(stu1.age);  <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">print</span>(stu2.age);  <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">print</span>(stu3.age);  <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">print</span>(stu4.age);  <span class="comment">// 10</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>);</span><br><span class="line"><span class="built_in">print</span>(stu0.hashCode);<span class="comment">///<span class="language-markdown">595483760</span></span></span><br><span class="line"><span class="built_in">print</span>(stu1.hashCode);<span class="comment">///<span class="language-markdown">959865253</span></span></span><br><span class="line"><span class="built_in">print</span>(stu2.hashCode);<span class="comment">///<span class="language-markdown">959865253</span></span></span><br><span class="line"><span class="built_in">print</span>(stu3.hashCode);<span class="comment">///<span class="language-markdown">959865253</span></span></span><br><span class="line"><span class="built_in">print</span>(stu4.hashCode);<span class="comment">///<span class="language-markdown">730863203</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="built_in">String?</span> name;</span><br><span class="line">    <span class="built_in">int</span> age=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> _cache = &lt;<span class="built_in">String</span>, Student&gt;&#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> test = &lt;<span class="built_in">int</span>&gt;[];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 工厂构造函数</span></span><br><span class="line">    <span class="keyword">factory</span> Student(<span class="built_in">String</span> name,<span class="built_in">int</span> age) &#123;</span><br><span class="line">        test.add(age);</span><br><span class="line">        <span class="built_in">print</span>(test);</span><br><span class="line">        Student s =_cache.putIfAbsent(name, () =&gt; Student.useForFactory(name,age));</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 工厂构造函数</span></span><br><span class="line">    <span class="keyword">factory</span> Student.fromJson(<span class="built_in">Map</span> json) &#123;</span><br><span class="line">        <span class="keyword">return</span> Student(json[<span class="string">&#x27;name&#x27;</span>],json[<span class="string">&#x27;age&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 命名构造函数</span></span><br><span class="line">    Student.fromJson2(<span class="built_in">Map</span> json):name=json[<span class="string">&quot;json&quot;</span>],age=<span class="number">10</span>;</span><br><span class="line">  </span><br><span class="line">    Student.useForFactory(<span class="keyword">this</span>.name,<span class="keyword">this</span>.age);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如上的例子<strong>伪解释</strong>一下</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">先声明一下，比如我们声明了一个Student类，<span class="keyword">static</span> <span class="keyword">final</span> _cache 我们需要把他解读成一个全局单独的变量(或者说应用的一块单独内存)，上面特地加了<span class="keyword">static</span> <span class="keyword">final</span> test = &lt;<span class="built_in">int</span>&gt;[] 更加清晰明了。</span><br><span class="line"></span><br><span class="line">Student(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>) 向全局单独的变量_cache存入了一个键值对 &#123; <span class="string">&quot;dart&quot;</span> ：Student.useForFactory(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>)&#125;</span><br><span class="line"></span><br><span class="line">Student(<span class="string">&quot;dart&quot;</span>,<span class="number">2</span>) 则 不会！！！继续向全局单独的变量_cache存入了一个键值对，因为_cache中的键 <span class="string">&quot;dart&quot;</span> 已经存在了，所以他会直接返回Student.useForFactory(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>)，这里使用的是<span class="built_in">Map</span>.putIfAbsent实现。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> 反例</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    Student stu1 = Student(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    Student stu2 = Student(<span class="string">&quot;dart&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    Student stu3 = Student.fromJson(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dart&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">3</span>&#125;);</span><br><span class="line">    Student stu4 = Student.fromJson2(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dart&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">4</span>&#125;);</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>); </span><br><span class="line">    <span class="comment">// 使用 Student() 工厂构造函数 和 Student.fromJson(&#123;&#125;) 工厂构造函数创建出来的对象是同一个对象</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu1, stu2));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu2, stu3));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu3, stu4));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>);</span><br><span class="line">    <span class="built_in">print</span>(stu1.age);  <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">print</span>(stu2.age);  <span class="comment">// 2</span></span><br><span class="line">    <span class="built_in">print</span>(stu3.age);  <span class="comment">// 3</span></span><br><span class="line">    <span class="built_in">print</span>(stu4.age);  <span class="comment">// 10</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="built_in">String?</span> name;</span><br><span class="line">    <span class="built_in">int</span> age=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> _cache = &lt;<span class="built_in">String</span>, Student&gt;&#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 工厂构造函数</span></span><br><span class="line">    <span class="keyword">factory</span> Student(<span class="built_in">String</span> name,<span class="built_in">int</span> age) &#123;</span><br><span class="line">        <span class="keyword">return</span> Student.useForFactory(name,age);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 工厂构造函数</span></span><br><span class="line">    <span class="keyword">factory</span> Student.fromJson(<span class="built_in">Map</span> json) &#123;</span><br><span class="line">        <span class="keyword">return</span> Student(json[<span class="string">&#x27;name&#x27;</span>],json[<span class="string">&#x27;age&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 命名构造函数</span></span><br><span class="line">    Student.fromJson2(<span class="built_in">Map</span> json):name=json[<span class="string">&quot;json&quot;</span>],age=<span class="number">10</span>;</span><br><span class="line">  </span><br><span class="line">    Student.useForFactory(<span class="keyword">this</span>.name,<span class="keyword">this</span>.age);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>工厂构造函数实现单例</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> Singleton _singleton = Singleton.internal();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> Singleton() =&gt; _singleton;</span><br><span class="line"></span><br><span class="line">  Singleton.internal();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Singleton s1=Singleton();</span><br><span class="line">Singleton s2=Singleton();</span><br><span class="line"><span class="built_in">print</span>(identical(s1, s2));<span class="comment">///<span class="language-markdown">true</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>注意，dart中只能有一个未命名的构造函数，对应命名函数来说，名字不能够重复，否则会报The default constructor is already defined异常。所以如果你再给Student加一个未命名构造函数：Student(this.name)因为已经有了 factory Student(String name)</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;传统的构造函数&quot;&gt;&lt;a href=&quot;#传统的构造函数&quot; class=&quot;headerlink&quot; title=&quot;传统的构造函数&quot;&gt;&lt;/a&gt;传统的构造函数&lt;/h3&gt;&lt;figure class=&quot;highlight dart&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Student&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt; age = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt; id = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;built_in&quot;&gt;String?&lt;/span&gt; name=&lt;span class=&quot;string&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Student(&lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt; age, &lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt; id) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.age = age;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.id = id;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;命名构造函数&quot;&gt;&lt;a href=&quot;#命名构造函数&quot; class=&quot;headerlink&quot; title=&quot;命名构造函数&quot;&gt;&lt;/a&gt;命名构造函数&lt;/h3&gt;</summary>
    
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/categories/flutter/"/>
    
    
    <category term="flutter" scheme="https://tabbycute.github.io/tags/flutter/"/>
    
  </entry>
  
  <entry>
    <title>浏览器的文件加密解密</title>
    <link href="https://tabbycute.github.io/2021/10/02/20211024%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86/"/>
    <id>https://tabbycute.github.io/2021/10/02/20211024%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86/</id>
    <published>2021-10-01T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.279Z</updated>
    
    <content type="html"><![CDATA[<p>对文件加/解密路线</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file -&gt; buffer -&gt; uint8list -&gt; wordArray(crypto-js辅助类型) -&gt; 加/解密后的wordArray -&gt; uint8list</span><br></pre></td></tr></table></figure><p>可以根据业务需求uint8list 转 buffer 或者 blob等</p><p>demo</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        *&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">40px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">button</span>&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: block;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">300px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">120px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;inp&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;encFn()&quot;</span>&gt;</span>加解密字符串<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;decFn()&quot;</span>&gt;</span>加解密文件<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;img&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;crypto-js/crypto-js.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript"><span class="keyword">class</span> <span class="title class_">CryptoJSTB</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    iv=<span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    key=<span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    mode= <span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">    padding=<span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">static</span> <span class="title function_">fromJson</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> intance = <span class="keyword">new</span> <span class="title class_">CryptoJSTB</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> &#123;iv,key,mode,padding&#125; = opt</span></span><br><span class="line"><span class="language-javascript">        intance.<span class="property">iv</span>=iv;</span></span><br><span class="line"><span class="language-javascript">        intance.<span class="property">key</span>=key;</span></span><br><span class="line"><span class="language-javascript">        intance.<span class="property">mode</span>=mode||<span class="title class_">CryptoJS</span>.<span class="property">mode</span>.<span class="property">CBC</span>;</span></span><br><span class="line"><span class="language-javascript">        intance.<span class="property">padding</span>=padding||<span class="title class_">CryptoJS</span>.<span class="property">pad</span>.<span class="property">Pkcs7</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> intance</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///加密字符串</span></span></span><br><span class="line"><span class="language-javascript">    encStrAES (plainText) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> options = &#123;<span class="attr">iv</span>:<span class="variable language_">this</span>.<span class="property">iv</span>,<span class="attr">mode</span>:<span class="variable language_">this</span>.<span class="property">mode</span>,<span class="attr">padding</span>:<span class="variable language_">this</span>.<span class="property">padding</span>&#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> words = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(plainText)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> encrypted = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">encrypt</span>(words,<span class="variable language_">this</span>.<span class="property">key</span>,options)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Base64</span>.<span class="title function_">stringify</span>(encrypted.<span class="property">ciphertext</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///解密字符串</span></span></span><br><span class="line"><span class="language-javascript">    decStrAES (plainText) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> options = &#123;<span class="attr">iv</span>:<span class="variable language_">this</span>.<span class="property">iv</span>,<span class="attr">mode</span>:<span class="variable language_">this</span>.<span class="property">mode</span>,<span class="attr">padding</span>:<span class="variable language_">this</span>.<span class="property">padding</span>&#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">///加密的时候导出的base64，这里也用base64解析</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> base64 = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Base64</span>.<span class="title function_">parse</span>(plainText)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> src = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Base64</span>.<span class="title function_">stringify</span>(base64)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> decrypt = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(src, <span class="variable language_">this</span>.<span class="property">key</span>, options)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> decryptedStr = decrypt.<span class="title function_">toString</span>(<span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> decryptedStr.<span class="title function_">toString</span>()</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///加密字节</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">encByteAES</span>(<span class="params">plainText</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> wordArray = <span class="variable language_">this</span>.<span class="title class_">Uint8ToW</span>(plainText);   <span class="comment">// Uint8Array-&gt;WordArray</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> options = &#123;<span class="attr">iv</span>:<span class="variable language_">this</span>.<span class="property">iv</span>,<span class="attr">mode</span>:<span class="variable language_">this</span>.<span class="property">mode</span>,<span class="attr">padding</span>:<span class="variable language_">this</span>.<span class="property">padding</span>&#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> res = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">encrypt</span>(wordArray, <span class="variable language_">this</span>.<span class="property">key</span>,options).<span class="property">ciphertext</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title class_">WToUint8</span>(res)                   <span class="comment">// WordArray-&gt;Uint8Array</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///解密字节</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">decByteAES</span>(<span class="params">plainText</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> wordArray = <span class="variable language_">this</span>.<span class="title class_">Uint8ToW</span>(plainText);   <span class="comment">// Uint8Array-&gt;WordArray</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> options = &#123;<span class="attr">iv</span>:<span class="variable language_">this</span>.<span class="property">iv</span>,<span class="attr">mode</span>:<span class="variable language_">this</span>.<span class="property">mode</span>,<span class="attr">padding</span>:<span class="variable language_">this</span>.<span class="property">padding</span>&#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> content = <span class="title class_">CryptoJS</span>.<span class="property">lib</span>.<span class="property">CipherParams</span>.<span class="title function_">create</span>(&#123;<span class="attr">ciphertext</span>:wordArray&#125;)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> res = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(content, <span class="variable language_">this</span>.<span class="property">key</span>,options)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title class_">WToUint8</span>(res)                   <span class="comment">// WordArray-&gt;Uint8Array</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//类型转换</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//Uint8Array -&gt; wordArray</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">Uint8ToW</span>(u8) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> len = u8.<span class="property">length</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> words= [];</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i += <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            words[i &gt;&gt;&gt; <span class="number">2</span>] |= (u8[i] &amp; <span class="number">0xff</span>) &lt;&lt; (<span class="number">24</span> - (i % <span class="number">4</span>) * <span class="number">8</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> res = <span class="title class_">CryptoJS</span>.<span class="property">lib</span>.<span class="property">WordArray</span>.<span class="title function_">create</span>(words, len);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> res;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//wordArray -&gt; Uint8Array</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">WToUint8</span>(wordArray)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> &#123; words &#125; = wordArray;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> &#123; sigBytes &#125; = wordArray;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> u8 = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(sigBytes);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; sigBytes; i += <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> byte = (words[i &gt;&gt;&gt; <span class="number">2</span>] &gt;&gt;&gt; (<span class="number">24</span> - (i % <span class="number">4</span>) * <span class="number">8</span>)) &amp; <span class="number">0xff</span>;</span></span><br><span class="line"><span class="language-javascript">            u8[i] = byte;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> u8;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///文件转u8</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">static</span> <span class="title function_">fileToUint8</span>(<span class="params">file</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span></span><br><span class="line"><span class="language-javascript">            reader.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;<span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(e.<span class="property">target</span>.<span class="property">result</span>))&#125;</span></span><br><span class="line"><span class="language-javascript">            reader.<span class="title function_">readAsArrayBuffer</span>(file);</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///文件保存</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">static</span> <span class="title function_">saveFile</span>(<span class="params">uint8List,fileName</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> blob=<span class="keyword">new</span> <span class="title class_">Blob</span>([uint8List]);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;a&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        link.<span class="property">href</span> = <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span></span><br><span class="line"><span class="language-javascript">        link.<span class="property">download</span> = fileName;</span></span><br><span class="line"><span class="language-javascript">        link.<span class="title function_">click</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">revokeObjectURL</span>(link.<span class="property">href</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">///实例化</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> keyStr=<span class="string">&quot;abcdabcdabcdabcd&quot;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> content=<span class="string">&quot;123456789aaaa啊我的哇打多阿瓦达&quot;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> c=<span class="title class_">CryptoJSTB</span>.<span class="title function_">fromJson</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">key</span>: <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(keyStr),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">iv</span>: <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(keyStr),</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">///字符串加解密测试</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">encFn</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> encStr=c.<span class="title function_">encStrAES</span>(content)</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(encStr)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> decStr=c.<span class="title function_">decStrAES</span>(encStr)</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(decStr)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">///文件加解密测试，！！！！！！！！！请先选择文件！！！！！！测试用的是图片，方便查看</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">decFn</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///先将文件读取为字节</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> file = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#inp&quot;</span>).<span class="property">files</span>[<span class="number">0</span>]</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///加解密测试</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">CryptoJSTB</span>.<span class="title function_">fileToUint8</span>(file).<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(result)</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">///加密</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> encByte=c.<span class="title function_">encByteAES</span>(result)</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(encByte)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> decByte=c.<span class="title function_">decByteAES</span>(encByte)</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(decByte)</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">showImg</span>(decByte)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">showImg</span>(<span class="params">u8</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> blob=<span class="keyword">new</span> <span class="title class_">Blob</span>([u8]);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> src =  <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> img=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#img&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">    img.<span class="property">src</span> = src</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;对文件加/解密路线&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;file -&amp;gt; buffer -&amp;gt; uint8list -&amp;gt; wordArray(crypto-js辅助类型) -&amp;gt; 加/解密后的wordArray -&amp;gt; uint8list&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可以根据业务需求uint8list 转 buffer 或者 blob等&lt;/p&gt;</summary>
    
    
    
    <category term="web前端" scheme="https://tabbycute.github.io/categories/web%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="https://tabbycute.github.io/tags/js/"/>
    
    <category term="web前端" scheme="https://tabbycute.github.io/tags/web%E5%89%8D%E7%AB%AF/"/>
    
    <category term="cryptojs" scheme="https://tabbycute.github.io/tags/cryptojs/"/>
    
  </entry>
  
  <entry>
    <title>win下WebAssembly环境安装和尝试(Golang)</title>
    <link href="https://tabbycute.github.io/2021/10/02/20211111win%E4%B8%8BWebAssembly%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E5%92%8C%E5%B0%9D%E8%AF%95/"/>
    <id>https://tabbycute.github.io/2021/10/02/20211111win%E4%B8%8BWebAssembly%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E5%92%8C%E5%B0%9D%E8%AF%95/</id>
    <published>2021-10-01T16:00:00.000Z</published>
    <updated>2023-02-02T12:16:53.280Z</updated>
    
    <content type="html"><![CDATA[<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><ul><li>安装 Git。</li><li>安装cmake。<a href="https://cmake.org/download/">https://cmake.org/download/</a></li><li>安装vs。<a href="https://visualstudio.microsoft.com/zh-hans/downloads/">https://visualstudio.microsoft.com/zh-hans/downloads/</a></li><li>Python 2.7.x，在 Linux 和 OS X上，很可能已经装好了。<a href="https://www.python.org/downloads/release/python-2716/">https://www.python.org/downloads/release/python-2716/</a> 下载Windows x86-64 MSI installer for AMD64/EM64T/x64   python -V<h4 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/juj/emsdk.git</span><br><span class="line">//如果速度很慢可以直接去git下载代码</span><br></pre></td></tr></table></figure><h4 id="安装各种工具"><a href="#安装各种工具" class="headerlink" title="安装各种工具"></a>安装各种工具</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ./emsdk</span><br><span class="line">emsdk install latest</span><br></pre></td></tr></table></figure><h4 id="生成-emscripten-文件，激活配置"><a href="#生成-emscripten-文件，激活配置" class="headerlink" title="生成 ~/.emscripten 文件，激活配置"></a>生成 ~/.emscripten 文件，激活配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emsdk activate latest</span><br></pre></td></tr></table></figure><blockquote><p>双击emsdk目录下的emsdk_env.bat文件配置环境变量</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">这里可能会报错</span><br><span class="line">The changes made to environment variables only apply to the currently running shell instance. Use the &#x27;emsdk_env.bat&#x27; to re-enter this environment later, or if you&#x27;d like to permanently register this environment permanently, rerun this command with the option --permanent.</span><br><span class="line">&#x27;xftp&#x27; 不是内部或.............，也不是可运行的程序...........</span><br><span class="line"></span><br><span class="line">解决</span><br><span class="line">先查看pyhon的是否在全局可用</span><br><span class="line"></span><br><span class="line">然后在按照上面的运行</span><br><span class="line"></span><br><span class="line">emsdk_env.bat --permanent</span><br></pre></td></tr></table></figure><h4 id="查看是否已经安装完成"><a href="#查看是否已经安装完成" class="headerlink" title="查看是否已经安装完成"></a>查看是否已经安装完成</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emcc -v</span><br></pre></td></tr></table></figure><h4 id="查看全局是否可用，如果不能用单独设置环境变量。"><a href="#查看全局是否可用，如果不能用单独设置环境变量。" class="headerlink" title="查看全局是否可用，如果不能用单独设置环境变量。"></a>查看全局是否可用，如果不能用单独设置环境变量。</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 具体的变量的按照自己的目录来</span><br><span class="line"># 单独设置的环境变量，我这里是windows环境</span><br><span class="line">EMSDK=D:\workspace\emsdk\emsdk</span><br><span class="line">EMSDK_NODE=%EMSDK%\node\14.15.5_64bit\bin\node.exe</span><br><span class="line">EMSDK_PYTHON=%EMSDK%\python\3.9.2-1_64bit\python.exe</span><br><span class="line"></span><br><span class="line"># PATH中也要添加环境变量</span><br><span class="line">%EMSDK%</span><br><span class="line">%EMSDK%\upstream\emscripten</span><br><span class="line">%EMSDK%\node\14.15.5_64bit\bin</span><br></pre></td></tr></table></figure><h4 id="编译第一个wasm文件"><a href="#编译第一个wasm文件" class="headerlink" title="编译第一个wasm文件"></a>编译第一个wasm文件</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;emscripten/emscripten.h&gt;</span></span></span><br><span class="line"><span class="comment">// 一旦WASM模块被加载，main()中的代码就会执行</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;WebAssembly 的环境已经搭好了\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 返回1-6之间的一随机数</span></span><br><span class="line"><span class="type">int</span> EMSCRIPTEN_KEEPALIVE <span class="title function_">roll_dice</span><span class="params">()</span> &#123;</span><br><span class="line">    srand ( time(<span class="literal">NULL</span>) );</span><br><span class="line">    <span class="keyword">return</span> rand() % <span class="number">6</span> + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">然后用命令行工具定位到这个文件夹，执行：</span><br><span class="line">emcc index.c -s WASM=<span class="number">1</span> -O3 -o index.js</span><br><span class="line"></span><br><span class="line">等待片刻之后，你就能够看见生成了两个新文件：</span><br><span class="line">index.js</span><br><span class="line">index.wasm</span><br><span class="line"></span><br><span class="line">你可以用html引入这个index.js试试（index.wasm必须和index.js在同一路径下）</span><br><span class="line">vscode 使用 open with live server</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>WebAssembly 支持不仅限于 C、C++和 Rust。许多开发人员也在努力纳入对其他语言的支持。以下是当前支持的语言列表。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">C/C++</span><br><span class="line">Rust</span><br><span class="line">AssemblyScript（类似 TypeScript 的语法）</span><br><span class="line">C#</span><br><span class="line">F#</span><br><span class="line">Go</span><br><span class="line">Kotlin</span><br><span class="line">Swift</span><br><span class="line">D</span><br><span class="line">Pascal</span><br><span class="line">Zig</span><br></pre></td></tr></table></figure>Golang-webassembly编译及其错误解决<blockquote><p>出现”syscall/js”引入报错的时候（Build constraints exclude all the Go files in ‘E:/GoSdk/go1.18.1/src/syscall/js’），如下方式即可解决。详情参考：<a href="https://www.jetbrains.com/help/go/webassembly-project.html%E3%80%82">https://www.jetbrains.com/help/go/webassembly-project.html。</a></p></blockquote></li></ul><p><img src="/assets/img/202111111.png"><br><img src="/assets/img/202111112.png"></p><p>使用</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;syscall/js&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fibFunc</span><span class="params">(this js.Value, args []js.Value)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;我是Golang中的的方法&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">0</span>)</span><br><span class="line">   js.Global().Set(<span class="string">&quot;fibFunc&quot;</span>, js.FuncOf(fibFunc))</span><br><span class="line">   &lt;-done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行需要引入特定的js依赖。</p><blockquote><p>wasm_exec.js文件是框架自带的js驱动wasm(golang)的引擎<br>wasm_exec.html是自带的一个测试demo<br>别删了~~~</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E:\GoSdk\go1<span class="number">.18</span><span class="number">.1</span>\misc\wasm\wasm_exec.js</span><br><span class="line">E:\GoSdk\go1<span class="number">.18</span><span class="number">.1</span>\misc\wasm\wasm_exec.html   <span class="comment">//一个运行实例</span></span><br></pre></td></tr></table></figure><p>运行demo</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">目录结构</span><br><span class="line">/wasm_exec.js</span><br><span class="line">/wasm_exec.html</span><br><span class="line">/test.wasm</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">Copyright 2018 The Go Authors. All rights reserved.</span></span><br><span class="line"><span class="comment">Use of this source code is governed by a BSD-style</span></span><br><span class="line"><span class="comment">license that can be found in the LICENSE file.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Go wasm<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;wasm_exec.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">fibFunc</span>())&#125;,<span class="number">5000</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//这里是判断是否允许加载 wasm 文件的 JavaScript API</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (!<span class="title class_">WebAssembly</span>.<span class="property">instantiateStreaming</span>) &#123; <span class="comment">// polyfill</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title class_">WebAssembly</span>.<span class="property">instantiateStreaming</span> = <span class="keyword">async</span> (resp, importObject) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> source = <span class="keyword">await</span> (<span class="keyword">await</span> resp).<span class="title function_">arrayBuffer</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(source, importObject);</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> go = <span class="keyword">new</span> <span class="title class_">Go</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> mod, inst;</span></span><br><span class="line"><span class="language-javascript">        <span class="title class_">WebAssembly</span>.<span class="title function_">instantiateStreaming</span>(<span class="title function_">fetch</span>(<span class="string">&quot;test.wasm&quot;</span>), go.<span class="property">importObject</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            mod = result.<span class="property">module</span>;</span></span><br><span class="line"><span class="language-javascript">            inst = result.<span class="property">instance</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;runButton&quot;</span>).<span class="property">disabled</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">run</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">clear</span>();</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">await</span> go.<span class="title function_">run</span>(inst);</span></span><br><span class="line"><span class="language-javascript">            inst = <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(mod, go.<span class="property">importObject</span>); <span class="comment">// reset instance</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//代码是不会走到这里来的因为go main中阻塞了。</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&quot;run();&quot;</span> <span class="attr">id</span>=<span class="string">&quot;runButton&quot;</span> <span class="attr">style</span>=<span class="string">&quot;font-size: 100px;&quot;</span>&gt;</span>Run<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//Console</span><br><span class="line"></span><br><span class="line">Console was cleared</span><br><span class="line">我是Golang中的的方法</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h4 id=&quot;准备工作&quot;&gt;&lt;a href=&quot;#准备工作&quot; class=&quot;headerlink&quot; title=&quot;准备工作&quot;&gt;&lt;/a&gt;准备工作&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;安装 Git。&lt;/li&gt;
&lt;li&gt;安装cmake。&lt;a href=&quot;https://cmake.org/download/&quot;&gt;https://cmake.org/download/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;安装vs。&lt;a href=&quot;https://visualstudio.microsoft.com/zh-hans/downloads/&quot;&gt;https://visualstudio.microsoft.com/zh-hans/downloads/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Python 2.7.x，在 Linux 和 OS X上，很可能已经装好了。&lt;a href=&quot;https://www.python.org/downloads/release/python-2716/&quot;&gt;https://www.python.org/downloads/release/python-2716/&lt;/a&gt; 下载Windows x86-64 MSI installer for AMD64/EM64T/x64   python -V&lt;h4 id=&quot;安装环境&quot;&gt;&lt;a href=&quot;#安装环境&quot; class=&quot;headerlink&quot; title=&quot;安装环境&quot;&gt;&lt;/a&gt;安装环境&lt;/h4&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git clone https://github.com/juj/emsdk.git&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;//如果速度很慢可以直接去git下载代码&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;安装各种工具&quot;&gt;&lt;a href=&quot;#安装各种工具&quot; class=&quot;headerlink&quot; title=&quot;安装各种工具&quot;&gt;&lt;/a&gt;安装各种工具&lt;/h4&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cd ./emsdk&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;emsdk install latest&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;生成-emscripten-文件，激活配置&quot;&gt;&lt;a href=&quot;#生成-emscripten-文件，激活配置&quot; class=&quot;headerlink&quot; title=&quot;生成 ~/.emscripten 文件，激活配置&quot;&gt;&lt;/a&gt;生成 ~/.emscripten 文件，激活配置&lt;/h4&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;emsdk activate latest&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;双击emsdk目录下的emsdk_env.bat文件配置环境变量&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;这里可能会报错&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;The changes made to environment variables only apply to the currently running shell instance. Use the &amp;#x27;emsdk_env.bat&amp;#x27; to re-enter this environment later, or if you&amp;#x27;d like to permanently register this environment permanently, rerun this command with the option --permanent.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#x27;xftp&amp;#x27; 不是内部或.............，也不是可运行的程序...........&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;解决&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;先查看pyhon的是否在全局可用&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;然后在按照上面的运行&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;emsdk_env.bat --permanent&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;查看是否已经安装完成&quot;&gt;&lt;a href=&quot;#查看是否已经安装完成&quot; class=&quot;headerlink&quot; title=&quot;查看是否已经安装完成&quot;&gt;&lt;/a&gt;查看是否已经安装完成&lt;/h4&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;emcc -v&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;查看全局是否可用，如果不能用单独设置环境变量。&quot;&gt;&lt;a href=&quot;#查看全局是否可用，如果不能用单独设置环境变量。&quot; class=&quot;headerlink&quot; title=&quot;查看全局是否可用，如果不能用单独设置环境变量。&quot;&gt;&lt;/a&gt;查看全局是否可用，如果不能用单独设置环境变量。&lt;/h4&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# 具体的变量的按照自己的目录来&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 单独设置的环境变量，我这里是windows环境&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EMSDK=D:\workspace\emsdk\emsdk&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EMSDK_NODE=%EMSDK%\node\14.15.5_64bit\bin\node.exe&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EMSDK_PYTHON=%EMSDK%\python\3.9.2-1_64bit\python.exe&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# PATH中也要添加环境变量&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;%EMSDK%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;%EMSDK%\upstream\emscripten&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;%EMSDK%\node\14.15.5_64bit\bin&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;编译第一个wasm文件&quot;&gt;&lt;a href=&quot;#编译第一个wasm文件&quot; class=&quot;headerlink&quot; title=&quot;编译第一个wasm文件&quot;&gt;&lt;/a&gt;编译第一个wasm文件&lt;/h4&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;time.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;emscripten/emscripten.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 一旦WASM模块被加载，main()中的代码就会执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; argc, &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; ** argv)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;WebAssembly 的环境已经搭好了\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 返回1-6之间的一随机数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; EMSCRIPTEN_KEEPALIVE &lt;span class=&quot;title function_&quot;&gt;roll_dice&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    srand ( time(&lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; rand() % &lt;span class=&quot;number&quot;&gt;6&lt;/span&gt; + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;然后用命令行工具定位到这个文件夹，执行：&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;emcc index.c -s WASM=&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; -O3 -o index.js&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;等待片刻之后，你就能够看见生成了两个新文件：&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;index.js&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;index.wasm&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;你可以用html引入这个index.js试试（index.wasm必须和index.js在同一路径下）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vscode 使用 open with live server&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;WebAssembly 支持不仅限于 C、C++和 Rust。许多开发人员也在努力纳入对其他语言的支持。以下是当前支持的语言列表。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;C/C++&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Rust&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;AssemblyScript（类似 TypeScript 的语法）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;C#&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;F#&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Go&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Kotlin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Swift&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;D&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Pascal&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Zig&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
Golang-webassembly编译及其错误解决&lt;blockquote&gt;
&lt;p&gt;出现”syscall/js”引入报错的时候（Build constraints exclude all the Go files in ‘E:/GoSdk/go1.18.1/src/syscall/js’），如下方式即可解决。详情参考：&lt;a href=&quot;https://www.jetbrains.com/help/go/webassembly-project.html%E3%80%82&quot;&gt;https://www.jetbrains.com/help/go/webassembly-project.html。&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/assets/img/202111111.png&quot;&gt;&lt;br&gt;&lt;img src=&quot;/assets/img/202111112.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://tabbycute.github.io/categories/golang/"/>
    
    
    <category term="golang" scheme="https://tabbycute.github.io/tags/golang/"/>
    
    <category term="webAssembly" scheme="https://tabbycute.github.io/tags/webAssembly/"/>
    
  </entry>
  
</feed>
