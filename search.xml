<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>腾讯云COS前端临时token直传</title>
      <link href="/2023/04/15/20230415COS%E5%89%8D%E7%AB%AF%E7%9B%B4%E4%BC%A0/"/>
      <url>/2023/04/15/20230415COS%E5%89%8D%E7%AB%AF%E7%9B%B4%E4%BC%A0/</url>
      
        <content type="html"><![CDATA[<h3 id="服务端获取临时秘钥"><a href="#服务端获取临时秘钥" class="headerlink" title="服务端获取临时秘钥"></a>服务端获取临时秘钥</h3><p><a href="https://cloud.tencent.com/document/product/436/14048">golang获取cos临时秘钥官方文档</a></p><h3 id="前端直传"><a href="#前端直传" class="headerlink" title="前端直传"></a>前端直传</h3><h4 id="普通项目"><a href="#普通项目" class="headerlink" title="普通项目"></a>普通项目</h4><p><a href="https://github.com/tencentyun/cos-js-sdk-v5">cos-js-sdk-v5地址</a>或者<a href="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js">CDN地址引入</a><a href="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js">https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js</a></p><ul><li>示例<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;file-selector&quot;</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> <span class="title class_">XCosSecurityToken</span>=<span class="string">&quot;3PCM60BvU7Rn6i5X9uPq6hni4MR0a7a545dc67e23d015d82bf311650ba22ab6S7pP-3AVNt1ob9zN8BdkGSFDF5r0KeAIvl3JAWayfA4M-z5K5JzzlHY_aU-XAi8y8DVLHPq61kYFEzQvCQ2wgbSDjWNwXH3V6QYEZvW2BtHpEFU87ME4h9geXrFXucln3a4cwCW_VWDzvHc07rhYbTOjYY0Iv5QfCvgrAtqmlgYN4i6G0DNOW-77-cePbwYPY9edzZH2LNCjdvFGEpWVAuta5KzGjEetyN2GvsexFq2pHVxZmNu6zEcEQ4_sS1EcTRtv86h75KGjbunbrrkpNV6uoTgE6gdy49QoOWbkMZeVczPzM2QyTpwi7P8tfIDvc4NapoD6GxJIbHvrW4PiUbpi0loHC5HFdswPFJn7UiR_uw8ZOpIBcI_MGvBx5nJBMgiw5YFABcb0JQqO8f6BKBZRE7BFPAx8BmUiD_UuTF8SsyLUKEcAzCwEFqXovI2c6eBJtBxh8wpDj86mh3YCNL90gMWL2MOC_wp4aye46NS-WbUFEJcVaEaSSghYJ8KMIkzaGpl_qoZyw8iOOu7DPDHj7V_J02FJLR239k0io4nwZm-1yL7fui12ufqm3gVqYYNtkm6FUQGA8Gj0cw58eEgNZyx3bUxuWuHHT7tMk0rQQWbMUJrKPqhFvvZ-dtSCf_-6gzpXXq-L1WqtOTEv4shv6Oe6hvV8dOfuf5QzcBigoqE50H1LUf0WsBAoJhJNqCrX8wc14cFsi52Mb50H35T86ccynx10G52m8JaKuCGl8MdGAoH2nf7sUoNzfalm&quot;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="title class_">XCosSecurityToken</span>=<span class="string">&quot;3PCMV60vU7Rn6i5X9uPq6hni4MR0a7a2d3bc587bab11a530d40f363a977d412S7pP-3AVNt1ob9zN8BdkGXMZQHasR3fm0UnpYU65oT3T2fAH92lRKCRYTjA4h4LGp3bgp4o0eaKBRPr2KmYdVfKwH0h1-TRU8VF05qpgbqw1gv_ty-A0ovUNFLJCX5-2O8eARmOdl8jt6bQHvEfcsy4xfAwy_to-y7Ax3ErdjqJ5cTsaKWr5ru85bW7nPJH945hyqRHX1nduwGlYlIn4GztlVB2W-EbrjnKAti8P-HKY4JWD7kxS3UjB1yQm5QBNcM5lY6xyyS-pat_nmm7pqyegU_P7VWcIT587o_OUTC_lLJPD9S0nLYygB_7VWITWOCZcGd_Yfhj5pQR4L0ByMMTHqkvG3B3JVl2j8EKKZOpDXUtzBqznCVw9bDp87F5AwDtE0RQSLzoqBK-Dd68d5leqk_nULqPAMQPjmu2YUApI2X81Lsz6VioD7HNwRxegPPa1Ik53X89nFAh6GhKVouw0cQjDvj39SpHeVAvH8TL0S4muRborXqkmyLhqrgY98NZOVr0TIeoV-KEbxKgbciRe18sMowJ7jsmmuy3iI_FGRL97pDmNFWX4vMkVS9R4&quot;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> <span class="title class_">TmpSecretKey</span> = <span class="string">&quot;NpEEntHyD9X/TzdXg9muRnB8obxtUzeKePT3QPX820=&quot;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> <span class="title class_">TmpSecretId</span> = <span class="string">&quot;AKIDxKFyybjsuzxhTg-5WvrZhuTQ5xKxrivElSB81ySz9KKl1qK1_O5yglpWqD7kf_&quot;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> <span class="title class_">StartTime</span> = <span class="number">1664288985</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> <span class="title class_">ExpiredTime</span> = <span class="number">1664292585</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> <span class="title class_">Bucket</span> = <span class="string">&#x27;test9-1314103605&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> <span class="title class_">Region</span> = <span class="string">&#x27;ap-chengdu&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 初始化实例</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> cos = <span class="keyword">new</span> <span class="title function_">COS</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">getAuthorization</span>: <span class="keyword">function</span> (<span class="params">options, callback</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">callback</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">TmpSecretId</span>: <span class="title class_">TmpSecretId</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">TmpSecretKey</span>: <span class="title class_">TmpSecretKey</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">XCosSecurityToken</span>: <span class="title class_">XCosSecurityToken</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">StartTime</span>: <span class="title class_">StartTime</span>, <span class="comment">// 时间戳，单位秒，如：1580000000，建议返回服务器时间作为签名的开始时间，避免用户浏览器本地时间偏差过大导致签名错误</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">ExpiredTime</span>:<span class="title class_">ExpiredTime</span>, <span class="comment">// 时间戳，单位秒，如：1580000900</span></span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 监听选文件</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;file-selector&#x27;</span>).<span class="property">onchange</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> file = <span class="variable language_">this</span>.<span class="property">files</span>[<span class="number">0</span>];</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (!file) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 分片上传文件</span></span></span><br><span class="line"><span class="language-javascript">            cos.<span class="title function_">sliceUploadFile</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">Bucket</span>: <span class="title class_">Bucket</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">Region</span>: <span class="title class_">Region</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">Key</span>: <span class="string">&quot;test/&quot;</span>+file.<span class="property">name</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">Body</span>: file,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">onHashProgress</span>: <span class="keyword">function</span> (<span class="params">progressData</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;校验中&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(progressData));</span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">onProgress</span>: <span class="keyword">function</span> (<span class="params">progressData</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;上传中&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(progressData));</span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">            &#125;, <span class="keyword">function</span> (<span class="params">err, data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(err, data);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="微信小程序前端直传"><a href="#微信小程序前端直传" class="headerlink" title="微信小程序前端直传"></a>微信小程序前端直传</h4><p><a href="https://github.com/tencentyun/cos-wx-sdk-v5">微信小程序前端直传SDK</a></p><ul><li>示例<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">把 demo/lib/cos-wx-sdk-v5.<span class="property">js</span> 复制到自己小程序项目代码里，在需要上传文件的地方贴以下代码</span><br><span class="line">把 demo/lib/cos-wx-sdk-v5.<span class="property">js</span> 复制到自己小程序项目代码里，在需要上传文件的地方贴以下代码</span><br><span class="line">把 demo/lib/cos-wx-sdk-v5.<span class="property">js</span> 复制到自己小程序项目代码里，在需要上传文件的地方贴以下代码</span><br><span class="line">很重要</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存储桶名称，由bucketname-appid 组成，appid必须填入，可以在COS控制台查看存储桶名称。 https://console.cloud.tencent.com/cos5/bucket</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Bucket</span> = <span class="string">&#x27;test-1250000000&#x27;</span>;</span><br><span class="line"><span class="comment">// 存储桶Region可以在COS控制台指定存储桶的概览页查看 https://console.cloud.tencent.com/cos5/bucket/ </span></span><br><span class="line"><span class="comment">// 关于地域的详情见 https://cloud.tencent.com/document/product/436/6224</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Region</span> = <span class="string">&#x27;ap-guangzhou&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化实例</span></span><br><span class="line"><span class="keyword">var</span> cos = <span class="keyword">new</span> <span class="title function_">COS</span>(&#123;</span><br><span class="line">    <span class="attr">getAuthorization</span>: <span class="keyword">function</span> (<span class="params">options, callback</span>) &#123;</span><br><span class="line">        <span class="comment">// 异步获取签名</span></span><br><span class="line">        wx.<span class="title function_">request</span>(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;https://example.com/sts.php&#x27;</span>, <span class="comment">// 步骤二提供的签名接口</span></span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="title class_">Method</span>: options.<span class="property">Method</span>,</span><br><span class="line">                <span class="title class_">Key</span>: options.<span class="property">Key</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">dataType</span>: <span class="string">&#x27;text&#x27;</span>,</span><br><span class="line">            <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">result</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> data = result.<span class="property">data</span>;</span><br><span class="line">                <span class="title function_">callback</span>(&#123;</span><br><span class="line">                    <span class="title class_">TmpSecretId</span>: data.<span class="property">credentials</span> &amp;&amp; data.<span class="property">credentials</span>.<span class="property">tmpSecretId</span>,</span><br><span class="line">                    <span class="title class_">TmpSecretKey</span>: data.<span class="property">credentials</span> &amp;&amp; data.<span class="property">credentials</span>.<span class="property">tmpSecretKey</span>,</span><br><span class="line">                    <span class="title class_">XCosSecurityToken</span>: data.<span class="property">credentials</span> &amp;&amp; data.<span class="property">credentials</span>.<span class="property">sessionToken</span>,</span><br><span class="line">                    <span class="title class_">ExpiredTime</span>: data.<span class="property">expiredTime</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择文件</span></span><br><span class="line">wx.<span class="title function_">chooseImage</span>(&#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">1</span>, <span class="comment">// 默认9</span></span><br><span class="line">    <span class="attr">sizeType</span>: [<span class="string">&#x27;original&#x27;</span>], <span class="comment">// 可以指定是原图还是压缩图，默认用原图</span></span><br><span class="line">    <span class="attr">sourceType</span>: [<span class="string">&#x27;album&#x27;</span>, <span class="string">&#x27;camera&#x27;</span>], <span class="comment">// 可以指定来源是相册还是相机，默认二者都有</span></span><br><span class="line">    <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> filePath = res.<span class="property">tempFiles</span>[<span class="number">0</span>].<span class="property">path</span>;</span><br><span class="line">        <span class="keyword">var</span> filename = filePath.<span class="title function_">substr</span>(filePath.<span class="title function_">lastIndexOf</span>(<span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line">        cos.<span class="title function_">postObject</span>(&#123;</span><br><span class="line">            <span class="title class_">Bucket</span>: <span class="title class_">Bucket</span>,</span><br><span class="line">            <span class="title class_">Region</span>: <span class="title class_">Region</span>,</span><br><span class="line">            <span class="title class_">Key</span>: filename,</span><br><span class="line">            <span class="title class_">FilePath</span>: filePath,</span><br><span class="line">            <span class="attr">onProgress</span>: <span class="keyword">function</span> (<span class="params">info</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(info));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">function</span> (<span class="params">err, data</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(err || data);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li>封装<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///实际引入</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">COS</span> = <span class="built_in">require</span>(<span class="string">&#x27;./cos-wx-sdk-v5.js&#x27;</span>);</span><br><span class="line"><span class="comment">///这个必须引入，否则找不到文件</span></span><br><span class="line"><span class="comment">///这个必须引入，否则找不到文件</span></span><br><span class="line"><span class="comment">///这个必须引入，否则找不到文件</span></span><br><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">&#x27;./cos-wx-sdk-v5.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Credential</span> &#123;</span><br><span class="line"><span class="title class_">TmpSecretId</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="title class_">TmpSecretKey</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="title class_">XCosSecurityToken</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="title class_">StartTime</span>=<span class="number">0</span></span><br><span class="line"><span class="title class_">ExpiredTime</span>=<span class="number">0</span></span><br><span class="line"><span class="title class_">Bucket</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="title class_">Region</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="title class_">BucketPath</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">obj=&#123;&#125;</span>)&#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">TmpSecretId</span>=obj.<span class="property">TmpSecretId</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">TmpSecretKey</span>=obj.<span class="property">TmpSecretKey</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">XCosSecurityToken</span>=obj.<span class="property">XCosSecurityToken</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">StartTime</span>=obj.<span class="property">StartTime</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">ExpiredTime</span>=obj.<span class="property">ExpiredTime</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">Bucket</span>=obj.<span class="property">Bucket</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">Region</span>=obj.<span class="property">Region</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">BucketPath</span>=obj.<span class="property">BucketPath</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getFileNameByPath</span>=(<span class="params">filePath</span>)=&gt;&#123;</span><br><span class="line"><span class="keyword">return</span> filePath.<span class="title function_">match</span>(<span class="regexp">/[^/]*$/</span>)[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"><span class="doctag">@process</span> [function] 进度回调</span></span><br><span class="line"><span class="comment"><span class="doctag">@done</span> [function] 结果回调</span></span><br><span class="line"><span class="comment"><span class="doctag">@filePath</span> string 文件路径</span></span><br><span class="line"><span class="comment"><span class="doctag">@filename</span> string 文件名称 ，可不传</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">COSSingle</span> = (<span class="params">obj=&#123;&#125;</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">let</span> &#123;cre,filePath,done,process,filename&#125;=obj</span><br><span class="line"><span class="comment">// 初始化实例</span></span><br><span class="line"><span class="keyword">var</span> cos = <span class="keyword">new</span> <span class="title function_">COS</span>(&#123;</span><br><span class="line"><span class="attr">getAuthorization</span>: <span class="keyword">function</span> (<span class="params">options, callback</span>) &#123;</span><br><span class="line"><span class="title function_">callback</span>(&#123;</span><br><span class="line"><span class="title class_">TmpSecretId</span>: cre.<span class="property">TmpSecretId</span>,</span><br><span class="line"><span class="title class_">TmpSecretKey</span>: cre.<span class="property">TmpSecretKey</span>,</span><br><span class="line"><span class="title class_">XCosSecurityToken</span>: cre.<span class="property">XCosSecurityToken</span>,</span><br><span class="line"><span class="title class_">StartTime</span>: cre.<span class="property">StartTime</span>, <span class="comment">// 时间戳，单位秒，如：1580000000，建议返回服务器时间作为签名的开始时间，避免用户浏览器本地时间偏差过大导致签名错误</span></span><br><span class="line"><span class="title class_">ExpiredTime</span>: cre.<span class="property">ExpiredTime</span>, <span class="comment">// 时间戳，单位秒，如：1580000900</span></span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">if</span>(!filename)&#123;filename=<span class="title function_">getFileNameByPath</span>(filePath)&#125;</span><br><span class="line">cos.<span class="title function_">postObject</span>(&#123;</span><br><span class="line"><span class="title class_">Bucket</span>: cre.<span class="property">Bucket</span>,</span><br><span class="line"><span class="title class_">Region</span>: cre.<span class="property">Region</span>,</span><br><span class="line"><span class="title class_">Key</span>: cre.<span class="property">BucketPath</span>+filename,</span><br><span class="line"><span class="title class_">FilePath</span>: filePath,</span><br><span class="line"><span class="attr">onProgress</span>: <span class="keyword">function</span> (<span class="params">info</span>) &#123;process&amp;&amp;<span class="title function_">process</span>(info)&#125;</span><br><span class="line">&#125;, <span class="keyword">function</span> (<span class="params">err, data</span>) &#123;</span><br><span class="line">done&amp;&amp;<span class="title function_">done</span>(err,data)</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">COSMultiple</span> = (<span class="params">cre=<span class="keyword">new</span> Credential(),Files=[]</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="comment">// 初始化实例</span></span><br><span class="line"><span class="keyword">var</span> cos = <span class="keyword">new</span> <span class="title function_">COS</span>(&#123;</span><br><span class="line"><span class="attr">getAuthorization</span>: <span class="keyword">function</span> (<span class="params">options, callback</span>) &#123;</span><br><span class="line"><span class="title function_">callback</span>(&#123;</span><br><span class="line"><span class="title class_">TmpSecretId</span>: cre.<span class="property">TmpSecretId</span>,</span><br><span class="line"><span class="title class_">TmpSecretKey</span>: cre.<span class="property">TmpSecretKey</span>,</span><br><span class="line"><span class="title class_">XCosSecurityToken</span>: cre.<span class="property">XCosSecurityToken</span>,</span><br><span class="line"><span class="title class_">StartTime</span>: cre.<span class="property">StartTime</span>, <span class="comment">// 时间戳，单位秒，如：1580000000，建议返回服务器时间作为签名的开始时间，避免用户浏览器本地时间偏差过大导致签名错误</span></span><br><span class="line"><span class="title class_">ExpiredTime</span>: cre.<span class="property">ExpiredTime</span>, <span class="comment">// 时间戳，单位秒，如：1580000900</span></span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UpItem</span>(<span class="params">filePath,filename</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">sle,reject</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(!filename)&#123;filename=<span class="title function_">getFileNameByPath</span>(filePath)&#125;</span><br><span class="line">cos.<span class="title function_">postObject</span>(&#123;</span><br><span class="line"><span class="title class_">Bucket</span>: cre.<span class="property">Bucket</span>,</span><br><span class="line"><span class="title class_">Region</span>: cre.<span class="property">Region</span>,</span><br><span class="line"><span class="title class_">Key</span>: cre.<span class="property">BucketPath</span>+filename,</span><br><span class="line"><span class="title class_">FilePath</span>: filePath,</span><br><span class="line"><span class="attr">onProgress</span>: <span class="keyword">function</span> (<span class="params">info</span>) &#123;&#125;</span><br><span class="line">&#125;, <span class="keyword">function</span> (<span class="params">err, data</span>) &#123;</span><br><span class="line"><span class="title function_">sle</span>(&#123;err, data&#125;);</span><br><span class="line"><span class="comment">// done&amp;&amp;done(err,data)</span></span><br><span class="line">&#125;);</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>(<span class="title class_">Files</span>.<span class="title function_">map</span>(<span class="function"><span class="params">i</span>=&gt;</span><span class="title class_">UpItem</span>(i.<span class="property">filePath</span>,i.<span class="property">filename</span>))).<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line"><span class="title function_">resolve</span>(res)</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">e</span>=&gt;</span>&#123;</span><br><span class="line"><span class="title function_">reject</span>(e)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>使用<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">测试使用</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">COSSingle</span>,<span class="title class_">COSMultiple</span>,<span class="title class_">Credential</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;@/pkg/cos/index.js&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">upload</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line"><span class="keyword">var</span> cre= <span class="keyword">new</span> <span class="title class_">Credential</span>(&#123;</span><br><span class="line"><span class="title class_">TmpSecretId</span>:<span class="string">&quot;AKIDC5DKwFpmKLYEV4jkyB6MzHSA2RJBwQuCowagLCXuU-8gjebR3mKRreLCoGI77y&quot;</span>,</span><br><span class="line"><span class="title class_">TmpSecretKey</span>:<span class="string">&quot;pcqawQkKxJz9dTWg+5ndBLVowHW/is1S6J+jBtY4M=&quot;</span>,</span><br><span class="line"><span class="title class_">XCosSecurityToken</span>:<span class="string">&quot;d7YzDoYn03sPOuolg9Zj17hWJ6oTBqXa876a52cdb6c39574696f11dabb4dcc1MxnevotTIlzOwvElw6cIdIMEEuPMs642ww2kn3WvepO0jK1rE8JC6iZb9xT9_r8eJwpEitqqpCDedHEoYQ-zf0HM9DsbSI-t3iuDnVunzxr2qwKo4RGa6CMyotXMkYvnDsuDWVHLfY47GWEcXGpaXV2Oqco3zX3KOilU9AzA7Q0FjIlx4bGOYGUEmuquqbjAvz_USAdxjYCdq1Ia5x8nv-JYb0xEQfK79UrwFU87fu8n-kVhIaOWofbMj9EwSOYpCjn_LRxvYxnObV6PB9ytbuj20QRjtVmFVBLcrY5qlXw29UhU0IttCc7a2xxCNNQq5shQIZeaDoew6gS1gQMKgwUQLP9hE-2OPLHTq15T7miB2orMDEOHK-4aCFGZCKABLvHGaQFisE7bQ0DwNNpSeJI6R_sf2-PSgP4nfE6HUxTSLaigHlBEBkIwnNydcJoTZIjcHiVT2dA4u6t9O2sd5EOAeopRaI7dEKQykBHeJojaIg4oOHL6t2IkSZX4eW8Caml9J7dPN20wufjwOU_IVbZLuDG79Gyj2TjAuFSxsq5lORoempn3RTL6dU9YW5_k0b5eQq6VMQ-9u-EJWf6n9iwvXv0BUe3qMcyF1sC2O8-qAm4MBx1rTGRNCUeOx0f&quot;</span>,</span><br><span class="line"><span class="title class_">StartTime</span>:<span class="number">1686408158</span>,</span><br><span class="line"><span class="title class_">ExpiredTime</span>:<span class="number">1686415358</span>,</span><br><span class="line"><span class="title class_">Bucket</span>:<span class="string">&quot;test2-1257289329&quot;</span>,</span><br><span class="line"><span class="title class_">Region</span>:<span class="string">&quot;ap-chengdu&quot;</span>,</span><br><span class="line"><span class="title class_">BucketPath</span>:<span class="string">&quot;test/&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">///筛选掉已经上传的，和组织数据对象[&#123;filePath,filename&#125;]</span></span><br><span class="line"><span class="comment">///up是未上传的文件</span></span><br><span class="line"><span class="keyword">var</span> target=fdata.<span class="property">value</span>.<span class="title function_">map</span>(<span class="function"><span class="params">i</span>=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(i.<span class="property">up</span>===<span class="literal">false</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line"><span class="attr">filePath</span>:i.<span class="property">tempFilePath</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">///单个上传</span></span><br><span class="line"><span class="comment">// COSSingle(&#123;</span></span><br><span class="line"><span class="comment">// cre,</span></span><br><span class="line"><span class="comment">// filePath:target[0].filePath,</span></span><br><span class="line"><span class="comment">// done:function(err,data)&#123;</span></span><br><span class="line"><span class="comment">// if(!err)&#123;</span></span><br><span class="line"><span class="comment">// ///上传成功</span></span><br><span class="line"><span class="comment">// console.log(err,data)</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">///多个文件上传</span></span><br><span class="line"><span class="comment">// COSMultiple(cre,target).then(res=&gt;&#123;</span></span><br><span class="line"><span class="comment">// console.log(&quot;成功&quot;)</span></span><br><span class="line"><span class="comment">// console.log(res)</span></span><br><span class="line"><span class="comment">// &#125;).catch(e=&gt;&#123;</span></span><br><span class="line"><span class="comment">// console.log(e)</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>如果是uniapp，可以把cos-wx-sdk-v5.js中的<strong>wx.uploadFile</strong> 改成 <strong>uni.uploadFile</strong>代码<img src="/assets/img/2023041503.png" alt=""></li></ul><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p>有时候会报403的错，那是因为腾讯云后台配置问题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;Code&gt;AccessDenied&lt;/Code&gt;</span><br><span class="line">&lt;Message&gt;Access Denied.&lt;/Message&gt;</span><br></pre></td></tr></table></figure><p>修改一下COS存储桶权限配置<br><img src="/assets/img/2023041502.png" alt="COS存储桶权限配置示例"><br>访问报错修改<br><img src="/assets/img/2023041501.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> COS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>widget截图和获取widget尺寸</title>
      <link href="/2023/03/15/20230315widget%E6%88%AA%E5%9B%BE%E5%92%8C%E8%8E%B7%E5%8F%96widget%E5%B0%BA%E5%AF%B8/"/>
      <url>/2023/03/15/20230315widget%E6%88%AA%E5%9B%BE%E5%92%8C%E8%8E%B7%E5%8F%96widget%E5%B0%BA%E5%AF%B8/</url>
      
        <content type="html"><![CDATA[<p>对widget进行截图</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GlobalKey globalKey = GlobalKey();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RepaintBoundary(</span><br><span class="line">key: globalKey,</span><br><span class="line">child: QrImage(</span><br><span class="line">data: logic.buildQRContent(),</span><br><span class="line">size: <span class="number">134.</span>h,</span><br><span class="line">backgroundColor: Colors.white,</span><br><span class="line">),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">Future saveImg () <span class="keyword">async</span> &#123;</span><br><span class="line">    RenderRepaintBoundary boundary = globalKey.currentContext?.findRenderObject() <span class="keyword">as</span> RenderRepaintBoundary;</span><br><span class="line">    ui.Image image = <span class="keyword">await</span> boundary.toImage(pixelRatio: <span class="number">10.0</span>);</span><br><span class="line">    ByteData? byteData = <span class="keyword">await</span> image.toByteData(format: ui.ImageByteFormat.png);</span><br><span class="line">    Uint8List? pngBytes = byteData?.buffer.asUint8List();</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">设置图片保存的路径</span></span></span><br><span class="line">    <span class="built_in">String?</span> rootPath=DataPersistence.getAppRootPath()!;</span><br><span class="line"><span class="built_in">String</span> filePath=<span class="string">&quot;<span class="subst">$rootPath</span><span class="subst">$&#123;DateTime.now().microsecondsSinceEpoch&#125;</span>.jpg&quot;</span>;</span><br><span class="line">File file = File(filePath);</span><br><span class="line"><span class="comment">///<span class="language-markdown">保存图片</span></span></span><br><span class="line">file.writeAsBytesSync(pngBytes!,flush:<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取widget的尺寸，位置啥的</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GlobalKey globalKey = GlobalKey();</span><br><span class="line"></span><br><span class="line">RenderBox? renderBox = globalKey.currentContext?.findRenderObject() <span class="keyword">as</span> RenderBox;</span><br><span class="line"><span class="built_in">print</span>(renderBox.size.height);</span><br><span class="line"><span class="built_in">print</span>(renderBox.size.width);</span><br><span class="line"><span class="keyword">var</span> offset = renderBox.localToGlobal(Offset.zero); <span class="comment">//组件坐标</span></span><br><span class="line"><span class="comment">// var underOffset = renderBox?.localToGlobal(Offset(0.0, renderBox.size.height)); //组件下方坐标</span></span><br><span class="line"><span class="built_in">print</span>(offset.dx);</span><br><span class="line"><span class="built_in">print</span>(offset.dy);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> flutter </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>List&lt;String&gt;与String互转</title>
      <link href="/2023/02/23/20230223DartList%E5%92%8CString%E4%BA%92%E8%BD%AC/"/>
      <url>/2023/02/23/20230223DartList%E5%92%8CString%E4%BA%92%E8%BD%AC/</url>
      
        <content type="html"><![CDATA[<p>例1</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:convert&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line"><span class="comment">//1.List转为String</span></span><br><span class="line">  <span class="keyword">var</span> l1 = &lt;<span class="built_in">String</span>&gt;[<span class="string">&#x27;adaadad&#x27;</span>, <span class="string">&#x27;adaadad&#x27;</span>];</span><br><span class="line">  <span class="built_in">String</span> s = JsonEncoder().convert(l1);</span><br><span class="line">  <span class="built_in">print</span>(s);</span><br><span class="line"><span class="comment">//2.String转回List</span></span><br><span class="line">  <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; l2 = &lt;<span class="built_in">String</span>&gt;[];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> value <span class="keyword">in</span> JsonDecoder().convert(s)) &#123;</span><br><span class="line">    l2.add(value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">print</span>(l2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>例2</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">String</span> s =<span class="string">&#x27;[&#123;&quot;sessionID&quot;:&quot;10000002&quot;,&quot;sessionKey&quot;:&quot;d44caf6bd7184aeb&quot;,&quot;sessionType&quot;:1&#125;]&#x27;</span>;</span><br><span class="line">  <span class="built_in">List</span>&lt;<span class="built_in">Map</span>&gt; l1 = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> value <span class="keyword">in</span> JsonDecoder().convert(s)) &#123;</span><br><span class="line">    <span class="built_in">print</span>(value[<span class="string">&quot;sessionID&quot;</span>]);</span><br><span class="line">    l1.add(value);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">print</span>(l1[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> flutter </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flutter插件开发(集成本地sdk)</title>
      <link href="/2023/02/08/20230208flutter%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/"/>
      <url>/2023/02/08/20230208flutter%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<p>平台：Android，iOS；</p><p>都使用本地的sdk，解决编译器默认语法报错；</p><p>准备工作先创建插件项目安装环境什么的不需要过多介绍；</p><h3 id="安卓"><a href="#安卓" class="headerlink" title="安卓"></a>安卓</h3><h4 id="配置引入调用"><a href="#配置引入调用" class="headerlink" title="配置引入调用"></a>配置引入调用</h4><ul><li>先在android/libs引入aar包</li></ul><img src="/assets/img/202302081.png" alt="" class="cImgSizeWS30"><blockquote><p>插件中的android目录下的层级和普通项目中的android目录下的层级不太一样</p></blockquote><ul><li>在android/build.gradle里面做一些更改</li></ul><img src="/assets/img/202302082.png" alt="" class="cImgSizeWS30"><blockquote><p>api ‘io.openim:core-sdk:2.3.5-t08@aar’<br>实际路径为 ***/android/libs/core-sdk-2.3.5-t08.aar<br>***/android/libs/core-sdk.aar</p></blockquote><ul><li>然后在项目调用方法</li></ul><img src="/assets/img/202302083.png" alt="" class="cImgSizeWS30"><img src="/assets/img/202302085.png" alt="方法调用" class="cImgSizeWS30"><img src="/assets/img/202302084.png" alt="" class="cImgSizeWS30"><img src="/assets/img/202302086.png" alt="方法调用" class="cImgSizeWS30"><ul><li><p>编写平台通道(创建插件项目自动项目中自带)</p></li><li><p>然后就可以测试下。</p></li></ul><h4 id="语法错误解决"><a href="#语法错误解决" class="headerlink" title="语法错误解决"></a>语法错误解决</h4><p>可能你的项目会出现语法错误一直爆红，利用local.properties中的flutter.sdk路径来；</p><img src="/assets/img/202302088.png" alt="报红" class="cImgSizeWS50"><ul><li>android/local.properties下面添加fluttersdk路径（根据自己电脑环境来配置）</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sdk.dir</span>=<span class="string">C:\\Users\\DELL\\AppData\\Local\\Android\\Sdk</span></span><br><span class="line"><span class="attr">flutter.sdk</span>=<span class="string">G:\\flutterDev\\flutter   #根据自己电脑环境来配置</span></span><br></pre></td></tr></table></figure><ul><li>我们在android/build.gradle文件中，编写读取flutter.sdk的代码，最后使用compileOnly files依赖本地的flutter库</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取local.properties配置文件</span></span><br><span class="line"><span class="keyword">def</span> localProperties = <span class="keyword">new</span> Properties()</span><br><span class="line"><span class="keyword">def</span> localPropertiesFile = rootProject.<span class="keyword">file</span>(<span class="string">&#x27;local.properties&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> (localPropertiesFile.exists()) &#123;</span><br><span class="line">    localPropertiesFile.<span class="keyword">withReader</span>(<span class="string">&#x27;UTF-8&#x27;</span>) &#123; reader -&gt;</span><br><span class="line">        localProperties.load(reader)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取flutter的sdk路径</span></span><br><span class="line"><span class="keyword">def</span> flutterRoot = localProperties.getProperty(<span class="string">&#x27;flutter.sdk&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> (flutterRoot == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> GradleException(<span class="string">&quot;Flutter SDK not found. Define location with flutter.sdk in the local.properties file.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    compileOnly files(<span class="string">&quot;$flutterRoot/bin/cache/artifacts/engine/android-arm/flutter.jar&quot;</span>)</span><br><span class="line">    api <span class="string">&#x27;io.openim:core-sdk:2.3.5-t08@aar&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>打开android目录(直接file-open)，打开了过后会同步更新然后就ok；同步有点久。。。</li></ul><blockquote><p>我出现了没有gradle的错误，我自己复制了一份过来</p></blockquote><img src="/assets/img/202302089.png" alt="" class="cImgSizeWS30"><p>解决完成！</p><img src="/assets/img/202302087.png" alt="解决过后" class="cImgSizeWS50"><h3 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h3><p>准备工作可以参考安卓</p><p>使用mac进入到example的ios中在xcode中打开</p><p>首先项目先正常运行起来；</p><p>用我们自己的****.xcframework去替换从远程拉下来的文件；</p><blockquote><p>对iOS比较陌生，暂时不会直接在本地使用，后期学习下才行<br>这里的插件不并不是我们自己的，是一个线上版本的修改版</p></blockquote><img src="/assets/img/2023020810.png" alt="文件" class="cImgSizeWS30"><p>主要是替换掉他就ok；</p><p>报错1：<br><img src="/assets/img/2023020811.png" alt="报错1" ><br><img src="/assets/img/2023020812.png" alt="解决"></p>]]></content>
      
      
      <categories>
          
          <category> flutter </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flutter通过本地服务访问静态文件</title>
      <link href="/2023/02/02/20230202flutter%E9%80%9A%E8%BF%87%E6%9C%AC%E5%9C%B0%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6/"/>
      <url>/2023/02/02/20230202flutter%E9%80%9A%E8%BF%87%E6%9C%AC%E5%9C%B0%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<p>最近遇到一个需求，给我一个h5的页面，让我直接放在app内，用webview静态访问。</p><p>这个需求本身没什么问题，但是他这个项目比较特殊是个three.js搞得任务模型，双击在浏览器打开直接就报错。</p><p>因为这个项目需要使用本地服务启动！通过本地服务来访问路径</p><p>准备三个包</p><blockquote><p>jaguar_flutter_asset: ^3.0.0      开启本地服务<br>webview_flutter: ^4.0.2        webview<br>dio: ^4.0.6                    网络访问。测试用！</p></blockquote><h3 id="注册静态文件"><a href="#注册静态文件" class="headerlink" title="注册静态文件"></a>注册静态文件</h3><p>把项目拷贝的到项目的静态目录下，并且在pubspec.yaml中注册这个项目<strong>所有的文件夹</strong>是所有的！！！否则你的项目可能会跑不起来！！！一定要是所有</p><img src="/assets/img/202302021.png" alt="目录示例" class="cImgSizeWS50"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> assets:</span><br><span class="line">...</span><br><span class="line">   - assets/web/models/</span><br><span class="line">   - assets/web/models/obj/</span><br><span class="line">   - assets/web/models/obj/male02/</span><br><span class="line">...</span><br></pre></td></tr></table></figure><blockquote><p>实际项目，目录是很多的，层级也多，手动写，难免丢失，我是用的shell脚本遍历生成的</p></blockquote><h3 id="页面使用"><a href="#页面使用" class="headerlink" title="页面使用"></a>页面使用</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHomePage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> MyHomePage(&#123;Key? key, <span class="keyword">required</span> <span class="keyword">this</span>.title&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> title;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyHomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyHomePage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">void</span> loadData() <span class="keyword">async</span>&#123;</span><br><span class="line">    <span class="keyword">final</span> server = Jaguar(address:<span class="string">&quot;127.0.0.1&quot;</span>,port: <span class="number">8000</span>);</span><br><span class="line">    server.addRoute(serveFlutterAssets());</span><br><span class="line">    <span class="keyword">await</span> server.serve(logRequests: <span class="keyword">true</span>);</span><br><span class="line">    server.log.onRecord.listen((r) =&gt; <span class="built_in">print</span>(r));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> Future.delayed(<span class="built_in">Duration</span>(seconds: <span class="number">1</span>));</span><br><span class="line">    <span class="comment">///<span class="language-markdown">测试用</span></span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> response = <span class="keyword">await</span> Dio().<span class="keyword">get</span>(<span class="string">&#x27;http://127.0.0.1:8000/web/webgl_loader_obj_mtl.html&#x27;</span>);</span><br><span class="line">      <span class="built_in">print</span>(response);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="built_in">print</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    loadView();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  WebViewController? controller;</span><br><span class="line"></span><br><span class="line">  loadView()<span class="keyword">async</span>&#123;</span><br><span class="line">    controller=WebViewController()</span><br><span class="line">    ..setJavaScriptMode(JavaScriptMode.unrestricted)</span><br><span class="line">    ..setBackgroundColor(<span class="keyword">const</span> Color(<span class="number">0x00000000</span>))</span><br><span class="line">    ..loadRequest(<span class="built_in">Uri</span>.parse(<span class="string">&#x27;http://127.0.0.1:8000/web/webgl_loader_obj_mtl.html&#x27;</span>));</span><br><span class="line">    setState(() &#123;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> implement initState</span></span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    loadData();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body:controller==null?Container():WebViewWidget(controller: controller!),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我测试的是安卓平台（公司的测试机！真机！）！现在访问页面访问不了，用dio请求下看看能否拿到页面，结果如下：</p><img src="/assets/img/202302022.png" alt="dio请求结果" class="cImgSizeWS50"><p>然后我怀疑是<a href="http://127.0.0.1:8000这个地址的原因，查了一下果然">http://127.0.0.1:8000这个地址的原因，查了一下果然</a>~</p><h4 id="安卓配置"><a href="#安卓配置" class="headerlink" title="安卓配置"></a>安卓配置</h4><ul><li>在下创建/android/app/src/main/res/xml/network_security_config.xml文件，填上配置内容：</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">network-security-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">base-config</span> <span class="attr">cleartextTrafficPermitted</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">trust-anchors</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">certificates</span> <span class="attr">src</span>=<span class="string">&quot;system&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">certificates</span> <span class="attr">src</span>=<span class="string">&quot;user&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">trust-anchors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">base-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network-security-config</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>修改android/app/src/main/AndroidManifest.xml，在application节点加入以下两个属性即可：</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;demoimg&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;$&#123;applicationName&#125;&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">&lt;!<span class="attr">--添加如下--</span>&gt;</span></span><br><span class="line">        android:usesCleartextTraffic=&quot;true&quot;</span><br><span class="line">        android:networkSecurityConfig=&quot;@xml/network_security_config&quot;</span><br><span class="line"></span><br><span class="line">        android:icon=&quot;@mipmap/ic_launcher&quot;&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br></pre></td></tr></table></figure><p>重新访问OK。ios未知！！！</p><img src="/assets/img/202302023.png" alt="" class="cImgSizeWS50">]]></content>
      
      
      <categories>
          
          <category> flutter </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>某众点评的商户数据爬取</title>
      <link href="/2023/01/30/20230130%E6%9F%90%E4%BC%97%E7%82%B9%E8%AF%84%E7%9A%84%E5%95%86%E6%88%B7%E6%95%B0%E6%8D%AE%E7%88%AC%E5%8F%96/"/>
      <url>/2023/01/30/20230130%E6%9F%90%E4%BC%97%E7%82%B9%E8%AF%84%E7%9A%84%E5%95%86%E6%88%B7%E6%95%B0%E6%8D%AE%E7%88%AC%E5%8F%96/</url>
      
        <content type="html"><![CDATA[<p>最近需要获取某众点评的商户数据需求就是搜索某个分类，然后获取每家店的电话地址服务评分等等各种信息；</p><p>选择地区，登录，在网站里面拿token，uuid，cookie什么的就不过多赘述；</p><p>这里只是演示分析过程实际使用根据自己需求更改，请求过多可能会导致部分接口暂时性无法访问；</p><p>前提部分准备</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Fileds = <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>)<span class="comment">///商家结果分页列表错误的集合</span></span><br><span class="line"><span class="keyword">var</span> ShopIdList = <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>)<span class="comment">///商家id集合</span></span><br><span class="line"><span class="keyword">var</span> ShopInfo = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)<span class="comment">///商家信息结果：店铺名称，类型，地址，电话，营业时间，其他...</span></span><br><span class="line"><span class="keyword">var</span> ShopPrice = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)<span class="comment">///商家信息结果：星级，评分，评论数量，人均价格，其他...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="comment">///搜索商家结果分页列表</span></span><br><span class="line"><span class="keyword">const</span> url = <span class="string">&quot;https://www.dianping.com/search/keyword/3/0_%E5%AE%A0%E7%89%A9/o3&quot;</span></span><br><span class="line"><span class="keyword">const</span> token = <span class="string">&quot;&quot;</span><span class="comment">///用户token</span></span><br><span class="line"><span class="keyword">const</span> uuid = <span class="string">&quot;uuid&quot;</span><span class="comment">///用户uuid</span></span><br><span class="line"><span class="keyword">const</span> cityId = <span class="string">&quot;3&quot;</span><span class="comment">///城市id</span></span><br><span class="line"><span class="keyword">const</span> mainCategoryId = <span class="string">&quot;25147&quot;</span><span class="comment">///分类id</span></span><br><span class="line"><span class="keyword">const</span> cookie = <span class="string">&quot;cookie&quot;</span><span class="comment">///用户cookie</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RequestPage</span><span class="params">(u <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">req, _ := http.NewRequest(<span class="string">&quot;GET&quot;</span>, u, <span class="literal">nil</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Cookie&quot;</span>, cookie)</span><br><span class="line">req.Header.Set(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;*/*&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Host&quot;</span>, <span class="string">&quot;www.dianping.com&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept-Encoding&quot;</span>, <span class="string">&quot;gzip, deflate, br&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;keep-alive&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-mobile&quot;</span>, <span class="string">&quot;?0&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-platform&quot;</span>, <span class="string">&quot;Windows&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Dest&quot;</span>, <span class="string">&quot;document&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Mode&quot;</span>, <span class="string">&quot;navigate&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Site&quot;</span>, <span class="string">&quot;same-origin&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-User&quot;</span>, <span class="string">&quot;?1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua&quot;</span>, <span class="string">`Not_A Brand;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;109&quot;, &quot;Chromium&quot;;v=109`</span>)</span><br><span class="line"></span><br><span class="line">resp, err := (&amp;http.Client&#123;&#125;).Do(req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">///可能会乱码，所以还是判断下好的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bodyReader io.Reader</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> resp.Header.Get(<span class="string">&quot;Content-Encoding&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;gzip&quot;</span>:</span><br><span class="line">bodyReader, err = gzip.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;deflate&quot;</span>:</span><br><span class="line">bodyReader = flate.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">bodyReader = resp.Body</span><br><span class="line">&#125;</span><br><span class="line">respByte, _ := ioutil.ReadAll(bodyReader)</span><br><span class="line">fmt.Println(<span class="type">string</span>(respByte))</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(respByte) &gt; <span class="number">150000</span> &#123;</span><br><span class="line">GetShopIdSlice(respByte[<span class="number">150000</span>:])</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">Fileds=<span class="built_in">append</span>(Fileds,u)</span><br><span class="line">wg.Done()</span><br><span class="line">fmt.Println(u + <span class="string">&quot;错误&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Find</span><span class="params">(slice []<span class="type">string</span>, val <span class="type">string</span>)</span></span> (<span class="type">int</span>, <span class="type">bool</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> i, item := <span class="keyword">range</span> slice &#123;</span><br><span class="line"><span class="keyword">if</span> item == val &#123;</span><br><span class="line"><span class="keyword">return</span> i, <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetShopIdSlice</span><span class="params">(data []<span class="type">byte</span>)</span></span> &#123;</span><br><span class="line">re, _ := regexp.Compile(<span class="string">`&quot;[A-Za-z0-9]&#123;16&#125;&quot;`</span>)</span><br><span class="line">all := re.FindAll(data, <span class="number">-1</span>)</span><br><span class="line"><span class="keyword">for</span> _, bytes := <span class="keyword">range</span> all &#123;</span><br><span class="line">key := strings.Replace(<span class="type">string</span>(bytes), <span class="string">`&quot;`</span>, <span class="string">``</span>, <span class="number">-1</span>)</span><br><span class="line">fmt.Println(key)</span><br><span class="line"><span class="keyword">if</span> _, found := Find(ShopIdList, key); !found &#123;</span><br><span class="line">ShopIdList = <span class="built_in">append</span>(ShopIdList, key)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetShopInfo</span><span class="params">(id <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">curl := fmt.Sprintf(<span class="string">&quot;https://www.dianping.com/ajax/json/shopDynamic/basicHideInfo?shopId=%v&amp;_token=%v&amp;uuid=%v&amp;platform=1&amp;partner=150&amp;optimusCode=10&amp;originUrl=https://www.dianping.com/shop/%v&quot;</span>, id, token, uuid, id)</span><br><span class="line"></span><br><span class="line">req, _ := http.NewRequest(<span class="string">&quot;GET&quot;</span>, curl, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">req.Header.Set(<span class="string">&quot;Cookie&quot;</span>, cookie)</span><br><span class="line">req.Header.Set(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;*/*&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Host&quot;</span>, <span class="string">&quot;www.dianping.com&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept-Encoding&quot;</span>, <span class="string">&quot;gzip, deflate, br&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;keep-alive&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-mobile&quot;</span>, <span class="string">&quot;?0&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-platform&quot;</span>, <span class="string">&quot;Windows&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Dest&quot;</span>, <span class="string">&quot;document&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Mode&quot;</span>, <span class="string">&quot;navigate&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Site&quot;</span>, <span class="string">&quot;same-origin&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-User&quot;</span>, <span class="string">&quot;?1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua&quot;</span>, <span class="string">`Not_A Brand;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;109&quot;, &quot;Chromium&quot;;v=109`</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//req.Header.Set(&quot;Content-Length&quot;, &quot;231&quot;)</span></span><br><span class="line"></span><br><span class="line">resp, err := (&amp;http.Client&#123;&#125;).Do(req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;错误--&quot;</span>,id)</span><br><span class="line">wg.Done()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">///可能会乱码，所以还是判断下好的</span></span><br><span class="line"><span class="keyword">var</span> bodyReader io.Reader</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> resp.Header.Get(<span class="string">&quot;Content-Encoding&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;gzip&quot;</span>:</span><br><span class="line">bodyReader, err = gzip.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;deflate&quot;</span>:</span><br><span class="line">bodyReader = flate.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">bodyReader = resp.Body</span><br><span class="line">&#125;</span><br><span class="line">respByte, _ := ioutil.ReadAll(bodyReader)</span><br><span class="line">ShopInfo[id] = <span class="type">string</span>(respByte)</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetShopPrice</span><span class="params">(id <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">curl := fmt.Sprintf(<span class="string">&quot;https://www.dianping.com/ajax/json/shopDynamic/reviewAndStar?shopId=%v&amp;cityId=%v&amp;mainCategoryId=%v&amp;_token=%v&amp;uuid=%v&amp;platform=1&amp;partner=150&amp;optimusCode=10&amp;originUrl=https://www.dianping.com/shop/%v&quot;</span>,</span><br><span class="line">id,</span><br><span class="line">cityId,</span><br><span class="line">mainCategoryId,</span><br><span class="line">token,</span><br><span class="line">uuid,</span><br><span class="line">id)</span><br><span class="line"></span><br><span class="line">fmt.Println(curl)</span><br><span class="line"></span><br><span class="line">req, _ := http.NewRequest(<span class="string">&quot;GET&quot;</span>, curl, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">req.Header.Set(<span class="string">&quot;Cookie&quot;</span>, cookie)</span><br><span class="line">req.Header.Set(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;*/*&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Host&quot;</span>, <span class="string">&quot;www.dianping.com&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Accept-Encoding&quot;</span>, <span class="string">&quot;gzip, deflate, br&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;keep-alive&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-mobile&quot;</span>, <span class="string">&quot;?0&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua-platform&quot;</span>, <span class="string">&quot;Windows&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Dest&quot;</span>, <span class="string">&quot;document&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Mode&quot;</span>, <span class="string">&quot;navigate&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-Site&quot;</span>, <span class="string">&quot;same-origin&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Sec-Fetch-User&quot;</span>, <span class="string">&quot;?1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;sec-ch-ua&quot;</span>, <span class="string">`Not_A Brand;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;109&quot;, &quot;Chromium&quot;;v=109`</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//req.Header.Set(&quot;Content-Length&quot;, &quot;231&quot;)</span></span><br><span class="line"></span><br><span class="line">resp, err := (&amp;http.Client&#123;&#125;).Do(req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;错误--&quot;</span>,id)</span><br><span class="line">wg.Done()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">///可能会乱码，所以还是判断下好的</span></span><br><span class="line"><span class="keyword">var</span> bodyReader io.Reader</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> resp.Header.Get(<span class="string">&quot;Content-Encoding&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;gzip&quot;</span>:</span><br><span class="line">bodyReader, err = gzip.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;deflate&quot;</span>:</span><br><span class="line">bodyReader = flate.NewReader(resp.Body)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">bodyReader = resp.Body</span><br><span class="line">&#125;</span><br><span class="line">respByte, _ := ioutil.ReadAll(bodyReader)</span><br><span class="line">ShopPrice[id] = <span class="type">string</span>(respByte)</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///存储结果json</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetInfoFile</span><span class="params">(filePath <span class="type">string</span>, t <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">file, err := os.OpenFile(filePath, os.O_WRONLY|os.O_CREATE, <span class="number">0666</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;文件打开失败&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//及时关闭file句柄</span></span><br><span class="line"><span class="keyword">defer</span> file.Close()</span><br><span class="line"><span class="comment">//写入文件时，使用带缓存的 *Writer</span></span><br><span class="line">write := bufio.NewWriter(file)</span><br><span class="line">write.WriteString(<span class="string">&quot;&#123; \n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> t &#123;</span><br><span class="line"><span class="keyword">if</span> strings.HasPrefix(v,<span class="string">&quot;&lt;html&gt;&quot;</span>)&#123;</span><br><span class="line">data := fmt.Sprintf(<span class="string">&quot;\&quot;%v\&quot;:%v,\n&quot;</span>, k, <span class="string">`&#123;&quot;msg&quot;:&quot;403 Forrbiden&quot;&#125;`</span>)</span><br><span class="line">write.WriteString(data)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">data := fmt.Sprintf(<span class="string">&quot;\&quot;%v\&quot;:%v,\n&quot;</span>, k, v)</span><br><span class="line">write.WriteString(data)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">write.WriteString(<span class="string">&quot;&#125; \n&quot;</span>)</span><br><span class="line"><span class="comment">//Flush将缓存的文件真正写入到文件中</span></span><br><span class="line">write.Flush()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///存储店铺id和失败的店铺url</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetInfoFile2</span><span class="params">(filePath <span class="type">string</span>, t []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">file, err := os.OpenFile(filePath, os.O_WRONLY|os.O_CREATE, <span class="number">0666</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;文件打开失败&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//及时关闭file句柄</span></span><br><span class="line"><span class="keyword">defer</span> file.Close()</span><br><span class="line"><span class="comment">//写入文件时，使用带缓存的 *Writer</span></span><br><span class="line">write := bufio.NewWriter(file)</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> t &#123;</span><br><span class="line">data := fmt.Sprintf(<span class="string">&quot;%v\n&quot;</span>,v)</span><br><span class="line">write.WriteString(data)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Flush将缓存的文件真正写入到文件中</span></span><br><span class="line">write.Flush()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>token,uuid,cityId,mainCategoryId,cookie可在<strong><a href="https://www.dianping.com/ajax/json/shopDynamic/reviewAndStar">https://www.dianping.com/ajax/json/shopDynamic/reviewAndStar</a></strong>参数获取</p></blockquote><p>下面开始部分步骤</p><ul><li>搜索某个分类收集所有商户的id（需要cookie），并写入到本地文件</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">main()&#123;</span><br><span class="line">wg.Add(<span class="number">50</span>)</span><br><span class="line">RequestPage(url)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">2</span>; i &lt; <span class="number">51</span>; i++ &#123;</span><br><span class="line">urll := fmt.Sprintf(<span class="string">&quot;%vp%v&quot;</span>, url, i)</span><br><span class="line">RequestPage(urll)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">SetInfoFile2(<span class="string">&quot;./ShopIdList.txt&quot;</span>,ShopIdList)</span><br><span class="line">SetInfoFile2(<span class="string">&quot;./Fileds.txt&quot;</span>,Fileds)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///ShopIdList 内为下格式</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">k7iqTA5NY3wKmZt6</span></span><br><span class="line"><span class="comment">k6MAqHVYeFjSSlHy</span></span><br><span class="line"><span class="comment">G8ir506MAEWwZTha</span></span><br><span class="line"><span class="comment">l4Z2t8wfoLfTBe66</span></span><br><span class="line"><span class="comment">l4xW5fnwhEUwarXb</span></span><br><span class="line"><span class="comment">l3oH7kNLYmaqIjQy</span></span><br><span class="line"><span class="comment">l3i0yhjr2vYIlIgG</span></span><br><span class="line"><span class="comment">Ga6HlnZT8cD8LGLn</span></span><br><span class="line"><span class="comment">k3zNWxI6HirLcY5P</span></span><br><span class="line"><span class="comment">H7EHl8np2n0SdI1g</span></span><br><span class="line"><span class="comment">GaPMQLKeBPOhEV8a</span></span><br><span class="line"><span class="comment">H1gT7NAaoUUvem6g</span></span><br><span class="line"><span class="comment">l5NBYrCIEaMVi8s4</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><ul><li>获取商家的各种信息</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">fi, err := os.Open(<span class="string">&quot;./ShopIdList.txt&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Error: %s\n&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> fi.Close()</span><br><span class="line"></span><br><span class="line">br := bufio.NewReader(fi)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">a, _, c := br.ReadLine()</span><br><span class="line"><span class="keyword">if</span> c == io.EOF &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">ShopIdList=<span class="built_in">append</span>(ShopIdList,<span class="type">string</span>(a))</span><br><span class="line"><span class="comment">//fmt.Println(string(a))</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;当前共有店铺：&quot;</span>,<span class="built_in">len</span>(ShopIdList))</span><br><span class="line">time.Sleep(time.Second*<span class="number">2</span>)</span><br><span class="line"><span class="comment">//测试一下，获取部分信息</span></span><br><span class="line"><span class="comment">//下面这个会出现非并发安全的错误，使用读写锁就好了，我这里只是测试一下能否获取数据</span></span><br><span class="line">a:=ShopIdList[:<span class="number">30</span>]</span><br><span class="line">wg.Add(<span class="built_in">len</span>(a)*<span class="number">2</span>)</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> a &#123;</span><br><span class="line"><span class="keyword">go</span> GetShopPrice(v)</span><br><span class="line"><span class="keyword">go</span> GetShopInfo(v)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">time.Sleep(time.Second*<span class="number">2</span>)</span><br><span class="line">SetInfoFile(<span class="string">&quot;./Ainfo.json&quot;</span>, ShopInfo)</span><br><span class="line">SetInfoFile(<span class="string">&quot;./Aprice.json&quot;</span>, ShopPrice)</span><br></pre></td></tr></table></figure><p>结果展示</p><img src="/assets/img/202301301.png" alt="Aprice.json" class="cImgSizeWS50"><img src="/assets/img/202301302.png" alt="Ainfo.json" class="cImgSizeWS50"><p>问题来了他的部分信息是html标签和一些代码</p><p>在网页审查他的元素</p><img src="/assets/img/202301303.png" ><p>原来是用了字体文件怪不得，网页复制都是乱码的</p><img src="/assets/img/202301304.png" alt="woff"><p>解决下载网页中所有的woff文件，然后把上面的json文件引入到html中循环展示，写点样式，就可以查看了</p><p>完结！</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>imgly超强编辑器在flutter中的简单使用</title>
      <link href="/2022/12/10/20221210imgly%E8%B6%85%E5%BC%BA%E5%9B%BE%E7%89%87%E7%BC%96%E8%BE%91%E8%A7%86%E9%A2%91%E7%BC%96%E8%BE%91%E5%88%9B%E6%84%8F%E7%BC%96%E8%BE%91%E4%BD%BF%E7%94%A8/"/>
      <url>/2022/12/10/20221210imgly%E8%B6%85%E5%BC%BA%E5%9B%BE%E7%89%87%E7%BC%96%E8%BE%91%E8%A7%86%E9%A2%91%E7%BC%96%E8%BE%91%E5%88%9B%E6%84%8F%E7%BC%96%E8%BE%91%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>先给出官网： <a href="https://img.ly/">https://img.ly/</a></p><p>flutter插件地址： <a href="https://pub.flutter-io.cn/packages/photo_editor_sdk">https://pub.flutter-io.cn/packages/photo_editor_sdk</a></p><p>下面开始集成（会需要一个选择图片的插件，这个自己解决，或者使用静态文件）</p><ul><li>通过打开 android/build.gradle 文件（不是 android/app/build.gradle）并更改以下块来添加 img.ly 存储库和插件：</li></ul><blockquote><p>为了更新适用于 Android 的 PhotoEditor SDK，请将版本字符串 10.3.1 替换为较新的版本。</p><p>如果版本和你pub的版本不对可能会报错，根据报错的版本来修改下面的插件版本就好了，去查看changelog</p></blockquote><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">-   ext.kotlin_version = <span class="string">&#x27;1.3.50&#x27;</span></span><br><span class="line">+   ext.kotlin_version = <span class="string">&#x27;1.5.32&#x27;</span> <span class="comment">// Minimum version.</span></span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        mavenCentral()</span><br><span class="line">+       maven &#123; url <span class="string">&quot;https://artifactory.img.ly/artifactory/imgly&quot;</span> &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">+       <span class="keyword">classpath</span> <span class="string">&#x27;ly.img.android.sdk:plugin:10.4.1&#x27;</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>仍然在 android/build.gradle 文件（不是 android/app/build.gradle）中，在底部添加这些行：</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        maven &#123; url <span class="string">&#x27;https://artifactory.img.ly/artifactory/imgly&#x27;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>android/build.gradle 完整配置如下</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    ext.kotlin_version = <span class="string">&#x27;1.6.10&#x27;</span></span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">        maven &#123; url <span class="string">&quot;https://artifactory.img.ly/artifactory/imgly&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;com.android.tools.build:gradle:7.1.2&#x27;</span></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;ly.img.android.sdk:plugin:10.4.1&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">        maven &#123; url <span class="string">&#x27;https://artifactory.img.ly/artifactory/imgly&#x27;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在 android/app/build.gradle 文件（不是 android/build.gradle）中，您需要将 minSdkVersion 修改为至少 21。我们还建议将 buildToolsVersion 更新为 31.0.0 或更高版本，并将 compileSdkVersion 更新为 31 或更高</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">compileSdkVersion <span class="number">33</span></span><br><span class="line">ndkVersion flutter.ndkVersion</span><br><span class="line">buildToolsVersion <span class="string">&quot;31.0.0&quot;</span></span><br><span class="line"></span><br><span class="line">compileOptions &#123;</span><br><span class="line"><span class="keyword">sourceCompatibility</span> JavaVersion.VERSION_1_8</span><br><span class="line"><span class="keyword">targetCompatibility</span> JavaVersion.VERSION_1_8</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">defaultConfig &#123;</span><br><span class="line">applicationId <span class="string">&quot;com.example.demoimg&quot;</span></span><br><span class="line">minSdkVersion <span class="number">22</span></span><br><span class="line">targetSdkVersion flutter.targetSdkVersion</span><br><span class="line">versionCode flutterVersionCode.<span class="keyword">toInteger</span>()</span><br><span class="line">versionName flutterVersionName</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>在同一个文件中，通过在应用插件下添加以下行来配置适用于 Android 的 PhotoEditor SDK</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> flutterVersionName = localProperties.getProperty(<span class="string">&#x27;flutter.versionName&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> (flutterVersionName == <span class="keyword">null</span>) &#123;</span><br><span class="line">    flutterVersionName = <span class="string">&#x27;1.0&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply plugin: <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line">apply plugin: <span class="string">&#x27;kotlin-android&#x27;</span></span><br><span class="line">apply <span class="keyword">from</span>: <span class="string">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///添加如下部分</span></span><br><span class="line">apply plugin: <span class="string">&#x27;ly.img.android.sdk&#x27;</span></span><br><span class="line">apply plugin: <span class="string">&#x27;kotlin-android&#x27;</span></span><br><span class="line">apply <span class="keyword">from</span>: <span class="string">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br><span class="line">imglyConfig &#123;</span><br><span class="line">    modules &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:text&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:focus&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:frame&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:brush&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:filter&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:sticker&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:overlay&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:transform&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:adjustment&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;ui:text-design&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// This module is big, remove the serializer if you don&#x27;t need that feature.</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;backend:serializer&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remove the asset packs you don&#x27;t need, these are also big in size.</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:font-basic&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:frame-basic&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:filter-basic&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:overlay-basic&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:sticker-shapes&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;assets:sticker-emoticons&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;backend:sticker-smart&#x27;</span></span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;backend:background-removal&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>flutter 使用</li></ul><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">获取一个图片</span></span></span><br><span class="line"><span class="keyword">final</span> <span class="built_in">List</span>&lt;AssetEntity&gt;? result = <span class="keyword">await</span> AssetPicker.pickAssets(context);</span><br><span class="line"><span class="built_in">print</span>(result?.first.relativePath);</span><br><span class="line"><span class="keyword">if</span>(result==<span class="keyword">null</span>)<span class="keyword">return</span>;</span><br><span class="line">File? f=<span class="keyword">await</span> result.first.file;</span><br><span class="line"><span class="keyword">if</span>(f==<span class="keyword">null</span>)<span class="keyword">return</span>;</span><br><span class="line"><span class="built_in">print</span>(f.path);</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">解除水印，免费版是有水印的，需要购买获取证书</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将不带扩展名的文件路径传递给unlockWithLicense函数以解锁 iOS 和 Android：</span></span><br><span class="line">PESDK.unlockWithLicense(<span class="string">&quot;assets/pesdk_license&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">传入一个图片地址</span></span></span><br><span class="line">PESDK.openEditor(image:f.path);</span><br></pre></td></tr></table></figure><img src="/assets/img/202212101.gif" alt="效果展示">]]></content>
      
      
      <categories>
          
          <category> flutter </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>图片选择和图片编辑插件魔改以及iOS打包问题的解决</title>
      <link href="/2022/12/05/20221205flutter%E6%8F%92%E4%BB%B6%E5%90%88%E5%B9%B6/"/>
      <url>/2022/12/05/20221205flutter%E6%8F%92%E4%BB%B6%E5%90%88%E5%B9%B6/</url>
      
        <content type="html"><![CDATA[<p>最近在项目遇见一个需求，是选择图片。于是我在pub上面找了这款<a href="https://pub.flutter-io.cn/packages/wechat_assets_picker">仿微信图片视频选择插件</a>感觉还挺好的~</p><p>经过上线之后老板觉得不方便，微信比起来不能编辑图片，于是我有找了另一款<a href="https://pub.flutter-io.cn/packages/image_editor_dove">编辑图片的插件</a></p><p>现在好了，编辑图片和选择图片的功能都有了，但是他并不能像微信选择图片的那样在预览的时候编辑图片。没办法，只能硬着头皮在现在插件上改了。</p><div class="cImgBoxCenter"><img src="/assets/img/202212051.jpg" class="cImgSizeW325" alt="仿微信图片视频选择插件"><img src="/assets/img/202212052.gif" class="cImgSizeW325" alt="编辑图片的插件"></div><h3 id="集成插件"><a href="#集成插件" class="headerlink" title="集成插件"></a>集成插件</h3><p>要改代码我们需要把插件静态集成到我们的项目中。</p><p>首先在我们需要在本地找到插件需要在flutter的SDK目录下<strong>\.pub-cache\hosted\pub.dartlang.org</strong>找到我们的插件wechat_assets_picker-7.3.4（什么版本看你自己）</p><p>修改之前</p><p><img src="/assets/img/202212053.png"></p><p>修改之后</p><div class="cImgBoxCenter"><img src="/assets/img/202212054.png" alt=""><img src="/assets/img/202212055.png" alt=""></div><h3 id="使用插件"><a href="#使用插件" class="headerlink" title="使用插件"></a>使用插件</h3><p>在plugins/wechat_assets_picker****/pubspec.yaml中添加插件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">extended_image:</span> <span class="string">^6.2.0</span></span><br><span class="line"><span class="attr">photo_manager:</span> <span class="string">^2.1.4</span></span><br><span class="line"><span class="attr">provider:</span> <span class="string">^6.0.2</span></span><br><span class="line"><span class="attr">video_player:</span> <span class="string">^2.4.0</span></span><br><span class="line"><span class="attr">image_editor_dove:</span> <span class="string">^0.0.2</span></span><br></pre></td></tr></table></figure><p>修改代码第一个位置，需要添加一个按钮，在<strong>lib/src/delegates/asset_picker_viewer_builder_delegate.dart</strong>文件中对**Widget selectButton(BuildContext context)**次函数做如下修改</p><h5 id="进入编辑页面"><a href="#进入编辑页面" class="headerlink" title="进入编辑页面"></a>进入编辑页面</h5><ul><li>预览大图页面-&gt;图片编辑页面</li></ul><h5 id="编辑页面返回（这里是我的业务需求）"><a href="#编辑页面返回（这里是我的业务需求）" class="headerlink" title="编辑页面返回（这里是我的业务需求）"></a>编辑页面返回（这里是我的业务需求）</h5><ul><li>如果编辑的图片保存成功：图片编辑页面-&gt;预览大图页面-&gt;预览小图页面-&gt;业务页面</li><li>如果编辑的图片未保存：图片编辑页面-&gt;预览大图页面</li></ul><blockquote><p>注意这里需要统一一下路由返回参数 <strong>List&lt;AssetEntity&gt;?</strong></p></blockquote><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">Semantics(</span><br><span class="line">selected: isSelected,</span><br><span class="line">label: semanticsTextDelegate.select,</span><br><span class="line">onTap: () =&gt; onChangingSelected(context, asset, isSelected),</span><br><span class="line">onTapHint: semanticsTextDelegate.select,</span><br><span class="line">excludeSemantics: <span class="keyword">true</span>,</span><br><span class="line">child: Row(</span><br><span class="line">  mainAxisAlignment: MainAxisAlignment.spaceBetween,</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line"><span class="comment">/// <span class="language-markdown">下面是就是添加核心代码的地方</span></span></span><br><span class="line"><span class="keyword">if</span>(previewAssets[currentIndex].type==AssetType.image)InkWell(</span><br><span class="line">  child: Text(<span class="string">&quot;编辑&quot;</span>),</span><br><span class="line">  onTap: ()<span class="keyword">async</span>&#123;</span><br><span class="line">File? f=<span class="keyword">await</span> previewAssets[currentIndex].file;</span><br><span class="line">Directory? savePath=f?.parent;</span><br><span class="line"><span class="comment">/// <span class="language-markdown">预览大图页面-&gt;图片编辑页面</span></span></span><br><span class="line"><span class="keyword">var</span> data = <span class="keyword">await</span> Navigator.push(context, MaterialPageRoute(builder: (context) &#123;</span><br><span class="line">  <span class="keyword">return</span> ImageEditor(</span><br><span class="line">originImage:f!,</span><br><span class="line">savePath: savePath,</span><br><span class="line">  );</span><br><span class="line">&#125;));</span><br><span class="line"><span class="comment">/// <span class="language-markdown">如果编辑的图片保存成功：图片编辑页面-&gt;预览大图页面-&gt;预览小图页面-&gt;业务页面</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">如果编辑的图片保存成功：图片编辑页面-&gt;预览大图页面</span></span></span><br><span class="line"><span class="keyword">if</span> (data <span class="keyword">is</span> EditorImageResult) &#123;</span><br><span class="line">  <span class="built_in">List</span>&lt;AssetEntity&gt;? result=[];</span><br><span class="line">  result.add(AssetEntity(</span><br><span class="line">  width: data.imgWidth,</span><br><span class="line">  typeInt: <span class="number">0</span>,</span><br><span class="line">  height: data.imgHeight,</span><br><span class="line">  id:<span class="string">&quot;editImg&quot;</span>,</span><br><span class="line">  relativePath:data.newFile.path</span><br><span class="line">  ));</span><br><span class="line">  Navigator.pop(context,result);</span><br><span class="line">&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">),</span><br><span class="line">Row(</span><br><span class="line">  mainAxisAlignment: MainAxisAlignment.end,</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line"><span class="comment">///<span class="language-markdown">tabby</span></span></span><br><span class="line"><span class="keyword">if</span> (isAppleOS)</span><br><span class="line">  _appleOSSelectButton(c, isSelected, asset)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  _androidSelectButton(c, isSelected, asset),</span><br><span class="line"><span class="keyword">if</span> (!isAppleOS)</span><br><span class="line">  ScaleText(</span><br><span class="line">textDelegate.select,</span><br><span class="line">style: <span class="keyword">const</span> TextStyle(fontSize: <span class="number">17</span>, height: <span class="number">1</span>),</span><br><span class="line">semanticsLabel: semanticsTextDelegate.select,</span><br><span class="line">  ),</span><br><span class="line">  ],</span><br><span class="line">),</span><br><span class="line">  ],</span><br><span class="line">),</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src="/assets/img/202212056.gif" class="cImgSizeW325" alt="完美！nice"><h3 id="打包与发布"><a href="#打包与发布" class="headerlink" title="打包与发布"></a>打包与发布</h3><p>安卓打包非常完美，一点问题都没有。但是iOS上却有问题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bz@bdeMac-mini ios % pod install</span><br><span class="line">Analyzing dependencies</span><br><span class="line">[!] The name of the given podspec `image_editor` doesn&#x27;t match the expected one `image_editor_dove`</span><br><span class="line"></span><br><span class="line">[!] Automatically assigning platform `iOS` with version `13.0` on target `Runner` because no platform was specified. Please specify a platform for this target in your Podfile. See `https://guides.cocoapods.org/syntax/podfile.html#platform`.</span><br></pre></td></tr></table></figure><p>他说image_editor下面没有一个名为image_editor_dove，类型为podspec的文件</p><p>我们进入到ios/.symlinks/plugins/image_editor_dove路径下面，发现确实没有image_editor_dove.podspec，</p><p>但是有一个image_editor.podspec，试着将其重新命名为image_editor_dove.podspec，同时修改此文件中的s.name = ‘image_editor_dove’</p><p>pod install 可以正常执行了</p><p>项目运行的时候xcode又出现了一个错误</p><p><strong>image_editor-Swift.h 大概意思这个文件引入不进来，不存在</strong></p><p>ios/Classes/ImageEditorPlugin.m 中修改image_editor全都修改为image_editor_dove</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;ImageEditorPlugin.h&quot;</span><br><span class="line">#if __has_include(&lt;image_editor_dove/image_editor_dove-Swift.h&gt;)</span><br><span class="line">#import &lt;image_editor_dove/image_editor_dove-Swift.h&gt;</span><br><span class="line">#else</span><br><span class="line">// Support project import fallback if the generated compatibility header</span><br><span class="line">// is not copied when this plugin is created as a library.</span><br><span class="line">// https://forums.swift.org/t/swift-static-libraries-dont-copy-generated-objective-c-header/19816</span><br><span class="line">#import &quot;image_editor_dove-Swift.h&quot;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">@implementation ImageEditorPlugin</span><br><span class="line">+ (void)registerWithRegistrar:(NSObject&lt;FlutterPluginRegistrar&gt;*)registrar &#123;</span><br><span class="line">  [SwiftImageEditorPlugin registerWithRegistrar:registrar];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>打包成功！</p><p>猝！</p>]]></content>
      
      
      <categories>
          
          <category> flutter </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在React项目中IM富文本输入框</title>
      <link href="/2022/11/15/20221115%E8%87%AA%E5%AE%9A%E4%B9%89im%E7%BC%96%E8%BE%91%E5%99%A8/"/>
      <url>/2022/11/15/20221115%E8%87%AA%E5%AE%9A%E4%B9%89im%E7%BC%96%E8%BE%91%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<p>im中的编辑器实际上是一个富文本的编辑器改好的成品，找了很多都没有适合</p><p>最终还是自己找一个插件二次封装一下吧（基于<a href="https://www.kancloud.cn/liuwave/quill/1409423">quill</a>），实际上大部分富文本编辑器都是基于<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Global_attributes/contenteditable">contenteditable</a>的高度封装，有兴趣可以了解下。</p><p>需要@用户，表情就ok</p><p>先安装依赖</p><blockquote><p>npm i react-quill –save<br>“react-quill”: “^2.0.0”<br>npm i quill-image-drop-module –save<br>“quill-image-drop-module”: “^1.0.3”</p></blockquote><img src="/assets/img/202211151.gif" alt="效果展示"><p>核心代码(测试demo)</p><blockquote><p>还没写输入部分。js添加的内容测试下</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Quill</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react-quill&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;react-quill/dist/quill.snow.css&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ImageDrop</span> &#125; <span class="keyword">from</span> <span class="string">&quot;quill-image-drop-module&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;theme,<span class="title class_">Tooltip</span>&#125; <span class="keyword">from</span> <span class="string">&quot;antd&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;useEffect&#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">TalkVideoCall</span>,<span class="title class_">TalkSingCall</span>,<span class="title class_">TalkFile</span>,<span class="title class_">TalkPhotos</span>,<span class="title class_">TalkEmoji</span>,<span class="title class_">TalkAtIcon</span>,<span class="title class_">TalkPicture</span>,<span class="title class_">TalkVideo</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@/strings/imgs&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Gap</span> <span class="keyword">from</span> <span class="string">&quot;../gap.jsx&quot;</span>;</span><br><span class="line"><span class="comment">///拖拽图片</span></span><br><span class="line"><span class="title class_">Quill</span>.<span class="title function_">register</span>(<span class="string">&quot;modules/imageDrop&quot;</span>, <span class="title class_">ImageDrop</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">///去除剪贴板中文字的样式</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ClipboardTextHandler</span> = (<span class="params">node, delta</span>) =&gt; &#123;</span><br><span class="line">    delta.<span class="property">ops</span> = delta.<span class="property">ops</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">op</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">insert</span>: op.<span class="property">insert</span>,</span><br><span class="line">            <span class="comment">///修改插入图片的大小,当然这里肯定有些判断</span></span><br><span class="line">            <span class="comment">// attributes: &#123; width: &quot;50px&quot;, height: &quot;50px&quot; &#125;</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> delta;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 继承相关 https://kang-bing-kui.gitbook.io/quill/other/parchment</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///at用户插入</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Embed</span> = <span class="title class_">Quill</span>.<span class="keyword">import</span>(<span class="string">&quot;blots/embed&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MsgAtUser</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Embed</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">create</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(value.<span class="property">tagName</span>&amp;&amp;(value.<span class="property">tagName</span>.<span class="title function_">toLowerCase</span>()===<span class="string">&quot;at&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> node = <span class="variable language_">super</span>.<span class="title function_">create</span>();</span><br><span class="line">        node.<span class="property">innerText</span> = value.<span class="property">text</span>;</span><br><span class="line">        node.<span class="title function_">setAttribute</span>(<span class="string">&quot;id&quot;</span>, value.<span class="property">id</span>);</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">margin</span> = <span class="string">&quot;0 4px&quot;</span>;</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">fontWeight</span> = <span class="string">&quot;600&quot;</span>;</span><br><span class="line">        node.<span class="title function_">setAttribute</span>(<span class="string">&quot;contenteditable&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">///撤消操作</span></span><br><span class="line">    <span class="keyword">static</span> value=<span class="function">(<span class="params">node</span>)=&gt;</span>node</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">MsgAtUser</span>.<span class="property">blotName</span> = <span class="string">&quot;MsgAtUser&quot;</span>;</span><br><span class="line"><span class="title class_">MsgAtUser</span>.<span class="property">tagName</span> = <span class="string">&quot;at&quot;</span>;</span><br><span class="line"><span class="title class_">Quill</span>.<span class="title function_">register</span>(<span class="title class_">MsgAtUser</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">///表情</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MsgEmoji</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Embed</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">create</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;create&quot;</span>,value)</span><br><span class="line"></span><br><span class="line">        <span class="comment">///通过id判断是否需要格式化，防止误伤</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(value)===<span class="string">&quot;[object HTMLImageElement]&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> node = <span class="variable language_">super</span>.<span class="title function_">create</span>();</span><br><span class="line">        node.<span class="title function_">setAttribute</span>(<span class="string">&quot;src&quot;</span>, value.<span class="property">src</span>);</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">width</span> = <span class="string">&quot;16px&quot;</span>;</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">height</span> = <span class="string">&quot;16px&quot;</span>;</span><br><span class="line">        node.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&quot;red&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">///撤消操作</span></span><br><span class="line">    <span class="keyword">static</span> value=<span class="function"><span class="params">node</span>=&gt;</span>node</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">MsgEmoji</span>.<span class="property">blotName</span> = <span class="string">&quot;MsgEmoji&quot;</span>;</span><br><span class="line"><span class="title class_">MsgEmoji</span>.<span class="property">tagName</span> = <span class="string">&quot;img&quot;</span>;</span><br><span class="line"><span class="title class_">Quill</span>.<span class="title function_">register</span>(<span class="title class_">MsgEmoji</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">InputTools</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; token &#125; = theme.<span class="title function_">useToken</span>();</span><br><span class="line">    <span class="keyword">const</span> &#123;colorText,colorBorder&#125;=token;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">className</span>=<span class="string">&quot;flex-ltr-ac-js&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">style</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">width:</span>&quot;<span class="attr">100</span>%&quot;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">padding:</span>&quot;<span class="attr">12px</span> <span class="attr">15px</span> <span class="attr">0</span>&quot;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex-ltr-ac-js&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;alignItems:</span>&quot;<span class="attr">start</span>&quot;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;表情&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkEmoji</span> <span class="attr">size</span>=<span class="string">&#123;28&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Gap</span> <span class="attr">w</span>=<span class="string">&#123;16&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkPicture</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Gap</span> <span class="attr">w</span>=<span class="string">&#123;16&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkVideo</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Gap</span> <span class="attr">w</span>=<span class="string">&#123;16&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkFile</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;/*<span class="tag">&lt;<span class="name">TalkPhotos</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;/</span>&gt;</span>*/&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex-ltr-ac-js&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkVideoCall</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Gap</span> <span class="attr">w</span>=<span class="string">&#123;16&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">&quot;文件&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">TalkSingCall</span> <span class="attr">size</span>=<span class="string">&#123;26&#125;</span> <span class="attr">color</span>=<span class="string">&#123;colorText&#125;</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Tooltip</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">ChatTalkInput</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; token &#125; = theme.<span class="title function_">useToken</span>();</span><br><span class="line">    <span class="keyword">const</span> &#123;colorBgContainer,colorBorder&#125;=token;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> quill=<span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        quill = <span class="keyword">new</span> <span class="title class_">Quill</span>(<span class="string">&quot;#editor&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">modules</span>: &#123;</span><br><span class="line">                <span class="attr">toolbar</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">clipboard</span>: &#123;</span><br><span class="line">                    <span class="attr">matchers</span>: [[<span class="title class_">Node</span>.<span class="property">ELEMENT_NODE</span>, <span class="title class_">ClipboardTextHandler</span>]],</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">theme</span>: <span class="string">&quot;snow&quot;</span>,</span><br><span class="line">            <span class="attr">imageDrop</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        quill.<span class="title function_">insertText</span>(<span class="number">0</span>,<span class="string">&quot;今天下午全都去开会&quot;</span>,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        <span class="comment">///插入at</span></span><br><span class="line">        quill.<span class="title function_">insertEmbed</span>(<span class="number">9</span>,<span class="string">&quot;MsgAtUser&quot;</span>,&#123; <span class="attr">text</span>: <span class="string">`@所有人`</span>, <span class="attr">id</span>: <span class="string">&quot;0&quot;</span> &#125;,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        quill.<span class="title function_">insertText</span>(<span class="number">10</span>,<span class="string">&quot;都要到&quot;</span>,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        <span class="comment">///插入表情</span></span><br><span class="line">        quill.<span class="title function_">insertEmbed</span>(<span class="number">0</span>,<span class="string">&quot;MsgEmoji&quot;</span>,&#123;<span class="attr">src</span>: <span class="string">&quot;https://www.w3school.com.cn/i/eg_tulip.jpg&quot;</span>, <span class="attr">code</span>: <span class="string">&quot;0&quot;</span> &#125;,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        quill.<span class="title function_">insertText</span>(<span class="number">0</span>,<span class="string">&quot;通知！！！！！！！&quot;</span>,<span class="title class_">Quill</span>.<span class="property">sources</span>.<span class="property">USER</span>);</span><br><span class="line">        <span class="comment">// quill.setSelection(1, Quill.sources.SILENT);</span></span><br><span class="line">    &#125;, []);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">///当输入框失去焦点，后如果输入框里面全是Embed，下次则无法聚焦！！！！只能重新聚焦</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">setSelection</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">        <span class="comment">///先要判断一下，防止误伤！！！</span></span><br><span class="line">        <span class="comment">// quill.setSelection(1, Quill.sources.SILENT);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">className</span>=<span class="string">&quot;flex-ttb-ac-js&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">style</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">height:</span>&quot;<span class="attr">230px</span>&quot;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">width:</span>&quot;<span class="attr">100</span>%&quot;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">border:</span>&quot;<span class="attr">none</span>&quot;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">InputTools</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;editor&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;setSelection&#125;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width:</span>&quot;<span class="attr">100</span>%&quot;,<span class="attr">height:</span>&quot;<span class="attr">100px</span>&quot;,<span class="attr">flex:</span>&quot;<span class="attr">1</span>&quot;,<span class="attr">border:</span>&quot;<span class="attr">none</span>&quot;&#125;&#125;&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浏览器中的模块化(ES Module,import-maps)</title>
      <link href="/2022/11/11/20221111%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96/"/>
      <url>/2022/11/11/20221111%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h3 id="ES-Module"><a href="#ES-Module" class="headerlink" title="ES Module"></a>ES Module</h3><p>ES Module 是 JavaScript 模块化的官方标准， 目前主流的浏览器已经实现，不依赖任何第三方加载器 (Loader) 即可使用。</p><blockquote><p><a href="https://caniuse.com/mdn-javascript_statements_import">点击此链接查看最新的浏览器支持情况</a></p></blockquote><p>浏览器中只支持相对路径或者绝对路径下的 ES 模块 (./, ../, /, http://, https://) ， 同时也受服务器跨域请求策略、 HTTPS 策略的约束。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// my_func.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">my_func</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;script type=<span class="string">&quot;module&quot;</span>&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; my_func &#125; <span class="keyword">from</span> <span class="string">&#x27;./my_func.js&#x27;</span>;</span><br><span class="line"><span class="title function_">my_func</span>();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="import-maps"><a href="#import-maps" class="headerlink" title="import-maps"></a>import-maps</h3><p>import-maps 就是为了解决浏览器中的全局模块而出现的， 目前浏览器的支持情况如下图所示， 基于 Chromium 的浏览器已经实现这个功能。</p><p>这个script 标签必须放在 document 中的中第一个 type=”module” 标签之前（最好是在<head>中），以便在进行模块解析之前对它进行解析。</p><blockquote><p><a href="https://caniuse.com/import-maps">点击此链接查看最新的浏览器支持情况</a></p></blockquote><p>import-maps 使用 Json 的形式来定义浏览器中的全局模块：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;importmap&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;imports&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;three&quot;</span>: <span class="string">&quot;./build/three.module.js&quot;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;three/addons/&quot;</span>: <span class="string">&quot;./jsm/&quot;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;react-dom&quot;</span>: <span class="string">&quot;https://cdn.skypack.dev/react-dom&quot;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这个标签中应该是严格的json格式，注意逗号的使用，如下<strong>错误实例</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;importmap&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;imports&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;three&quot;</span>: <span class="string">&quot;./build/three.module.js&quot;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;three/addons/&quot;</span>: <span class="string">&quot;./jsm/&quot;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="string">&quot;react-dom&quot;</span>: <span class="string">&quot;https://cdn.skypack.dev/react-dom&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>上面逗号引起浏览器报错</p></blockquote><blockquote><p>Failed to resolve module specifier “vue”. Relative references must start with either “/“, “./“, or “../“.</p></blockquote><h3 id="在浏览器中使用-import-maps-和-ES-模块示例"><a href="#在浏览器中使用-import-maps-和-ES-模块示例" class="headerlink" title="在浏览器中使用 import-maps 和 ES 模块示例"></a>在浏览器中使用 import-maps 和 ES 模块示例</h3><ul><li>简单测试demo</li></ul><p>index.html<br>/web/aaa.js</p><blockquote><p>因为使用的本地的，记得本地服务启动</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const Test = ()=&gt;&#123;</span><br><span class="line">    console.log(&quot;sdadadada&quot;)</span><br><span class="line">&#125;</span><br><span class="line">export &#123; Test,&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-cn&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vue<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;root&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;importmap&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;imports&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;@t/&quot;</span>: <span class="string">&quot;./web/&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">import</span> &#123;<span class="title class_">Test</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;@t/aaa.js&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">Test</span>()</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>在浏览器中直接使用 ArcGIS JS API 4.20 提供的 ES 模块</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>ArcGIS JS API ES Module Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">id</span>=<span class="string">&quot;mapstyle-link&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://js.arcgis.com/4.20/@arcgis/core/assets/esri/themes/dark/main.css&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-tag">html</span>,<span class="selector-tag">body</span>,<span class="selector-id">#mapview</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">width</span>: <span class="number">100%</span>; <span class="attribute">height</span>: <span class="number">100%</span>; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>; <span class="attribute">overflow</span>: hidden;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css">  </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;mapview&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;importmap&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;imports&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;@arcgis/&quot;</span>: <span class="string">&quot;https://js.arcgis.com/4.20/@arcgis/&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> <span class="title class_">Map</span> <span class="keyword">from</span> <span class="string">&#x27;@arcgis/core/Map.js&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> <span class="title class_">MapView</span> <span class="keyword">from</span> <span class="string">&#x27;@arcgis/core/views/MapView.js&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> * <span class="keyword">as</span> intl <span class="keyword">from</span> <span class="string">&quot;@arcgis/core/intl.js&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">  intl.<span class="title function_">setLocale</span>(<span class="string">&#x27;zh-CN&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">basemap</span>: <span class="string">&#x27;dark-gray-vector&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">ground</span>: <span class="string">&#x27;world-elevation&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">MapView</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">container</span>: <span class="string">&#x27;mapview&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">map</span>: map,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">zoom</span>: <span class="number">7</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">center</span>: [<span class="number">113.2</span>, <span class="number">23.4</span>],</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">viewingMode</span>: <span class="string">&#x27;global&#x27;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端换肤解决方案及其思路</title>
      <link href="/2022/10/25/20221025%E5%89%8D%E7%AB%AF%E6%8D%A2%E8%82%A4%E6%80%9D%E8%B7%AF/"/>
      <url>/2022/10/25/20221025%E5%89%8D%E7%AB%AF%E6%8D%A2%E8%82%A4%E6%80%9D%E8%B7%AF/</url>
      
        <content type="html"><![CDATA[<h3 id="CSS变量实现"><a href="#CSS变量实现" class="headerlink" title="CSS变量实现"></a>CSS变量实现</h3><p>没什么好说的简单</p><blockquote><p>使用stylus注意</p><p>–fill-1:#222;（正常）</p><p>–fill-1: #222;（可能报错）</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">change</span>=(<span class="params">theme</span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> html=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;body&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">html.<span class="title function_">setAttribute</span>(<span class="string">&quot;data-theme&quot;</span>,theme)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;change(&#x27;light&#x27;)&quot;</span>&gt;</span>主题颜色亮色<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;change(&#x27;dark&#x27;)&quot;</span>&gt;</span>主题颜色暗色<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;bg&quot;</span>&gt;</span>测试文字啊阿达瓦大大<span class="tag">&lt;<span class="name">i</span>&gt;</span>家中的<span class="tag">&lt;/<span class="name">i</span>&gt;</span>王阿达瓦<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">&quot;stylus&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    //默认</span></span><br><span class="line"><span class="language-css"><span class="selector-pseudo">:root</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--fill-1</span>:<span class="number">#ffffff</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--text</span>:<span class="number">#3c3c3c</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--text-1</span>:<span class="number">#757575</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--text-2</span>:<span class="number">#222</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-large</span>:<span class="number">18px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-large-x</span>:<span class="number">22px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-medium</span>:<span class="number">14px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-medium-x</span>:<span class="number">16px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-small-s</span>:<span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attr">--font-size-small</span>:<span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-attr">[data-theme=<span class="string">&quot;dark&quot;</span>]</span> &#123;</span></span><br><span class="line"><span class="language-css"><span class="attr">--fill-1</span>:<span class="number">#222</span>;</span></span><br><span class="line"><span class="language-css"><span class="attr">--text</span>:<span class="number">#fff</span>;</span></span><br><span class="line"><span class="language-css"><span class="attr">--text-1</span>:<span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.3</span>);</span></span><br><span class="line"><span class="language-css"><span class="attr">--text-2</span>:<span class="number">#ffcd32</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.bg</span></span></span><br><span class="line"><span class="language-css"><span class="attribute">transition-duration</span>: <span class="number">0.5s</span></span></span><br><span class="line"><span class="language-css">height: <span class="number">100px</span></span></span><br><span class="line"><span class="language-css">background <span class="built_in">var</span>(--fill-<span class="number">1</span>);</span></span><br><span class="line"><span class="language-css"><span class="attribute">color</span>: <span class="built_in">var</span>(--text-<span class="number">2</span>);</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="js动态"><a href="#js动态" class="headerlink" title="js动态"></a>js动态</h3><p>使用覆盖样式实现与scss变量实现会把多套皮肤的样式都编译到一个css文件里面，如果有多套皮肤样式，这个文件是会非常大的。</p><p>为了解决这样的问题，就自然的想出了拆分scss的实现，，通过编译工具与构建工具编译出多套皮肤css。或者使用网络地址。</p><p>通过js动态的link对应的皮肤样式</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> theme = <span class="regexp">/\bt=(\w+)/</span>.<span class="title function_">exec</span>(location.<span class="property">search</span>);</span><br><span class="line">theme = theme ? theme[<span class="number">1</span>] : <span class="string">&quot;light&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">changeTheme</span>(theme);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">changeTheme</span>(<span class="params">theme</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> head = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;head&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;link&quot;</span>);</span><br><span class="line">    link.<span class="property">dataset</span>.<span class="property">type</span> = <span class="string">&quot;theme&quot;</span>;</span><br><span class="line">    link.<span class="property">href</span> = <span class="string">&quot;assets/css/theme-&quot;</span> + theme + <span class="string">&quot;/pages/home/home.css&quot;</span>;</span><br><span class="line">    link.<span class="property">rel</span> = <span class="string">&quot;stylesheet&quot;</span>;</span><br><span class="line">    link.<span class="property">type</span> = <span class="string">&quot;text/css&quot;</span>;</span><br><span class="line">    head.<span class="title function_">appendChild</span>(link);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ElementUI换肤"><a href="#ElementUI换肤" class="headerlink" title="ElementUI换肤"></a>ElementUI换肤</h3><p>ElementUI的实现原理，通过预设的配置，颜色计算出颜色和生成正则，获取所有的style标签，拿到标签中的字符串，在去用正则替换字符串中的颜色，在设置回去。</p><p>为了考虑重复设置可以给style标签添加个标记</p><p>这个实现方式正如他官方所说相当暴力莫得感情！！！同时自己写的颜色也会被替换掉</p><blockquote><p><a href="https://github.com/ianstormtaylor/css-color-function">颜色计算</a></p><p><a href="https://www.runoob.com/js/js-obj-regexp.html">前端正则</a></p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> <span class="title class_">Color</span> <span class="keyword">from</span> <span class="string">&quot;css-color-function&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> current=<span class="string">&quot;default&quot;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> formulaes = [</span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&quot;0&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">exp</span>: <span class="string">&quot;color(primary)&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&quot;aaa&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">exp</span>: <span class="string">&quot;color(textColor)&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">&quot;bbb&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">exp</span>: <span class="string">&quot;color(btn)&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">];</span></span><br><span class="line"><span class="language-javascript"><span class="comment">///多个主题</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> themes=&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">default</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;primary&quot;</span>:<span class="string">&quot;#DC143C&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;textColor&quot;</span>:<span class="string">&quot;#BBFFAA&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;btn&quot;</span>:<span class="string">&quot;#2F4F4F&quot;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t1</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;primary&quot;</span>:<span class="string">&quot;#FFD700&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;textColor&quot;</span>:<span class="string">&quot;#000000&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;btn&quot;</span>:<span class="string">&quot;#000080&quot;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t2</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;primary&quot;</span>:<span class="string">&quot;#2F4F4F&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;textColor&quot;</span>:<span class="string">&quot;#FFFFFF&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;btn&quot;</span>:<span class="string">&quot;#adff2f&quot;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">computedColors</span> = (<span class="params">colors</span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">return</span> formulaes.<span class="title function_">map</span>(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> value = f.<span class="property">exp</span></span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">replace</span>(<span class="regexp">/primary/g</span>, colors.<span class="property">primary</span>)</span></span><br><span class="line"><span class="language-javascript">    .<span class="property">replace</span> (<span class="regexp">/textColor/g</span>,colors.<span class="property">textColor</span>)</span></span><br><span class="line"><span class="language-javascript">    .<span class="property">replace</span> (<span class="regexp">/btn/g</span>,colors.<span class="property">btn</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> <span class="title class_">Color</span>.<span class="title function_">convert</span>(value);</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">PageInit</span>=(<span class="params"></span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(themes).<span class="title function_">forEach</span>(<span class="function"><span class="params">k</span>=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> initColorCluster=[...<span class="title class_">Object</span>.<span class="title function_">values</span>(themes[k]),...<span class="title function_">computedColors</span>(themes[k])]</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> initStyleReg=initColorCluster.<span class="title function_">join</span>(<span class="string">&quot;|&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">      .<span class="title function_">replace</span>(<span class="regexp">/\(/g</span>, <span class="string">&quot;\\(&quot;</span>) <span class="comment">// 括号的转义</span></span></span><br><span class="line"><span class="language-javascript">      .<span class="title function_">replace</span>(<span class="regexp">/\)/g</span>, <span class="string">&quot;\\)&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">      .<span class="title function_">replace</span>(<span class="regexp">/0\./g</span>, <span class="string">&quot;.&quot;</span>); <span class="comment">// 这里替换是因为默认的css中计算出来的值透明度会缺省0，</span></span></span><br><span class="line"><span class="language-javascript">    themes[k].<span class="property">_initColorCluster</span>=initColorCluster</span></span><br><span class="line"><span class="language-javascript">    themes[k].<span class="property">_initStyleReg</span>=initStyleReg</span></span><br><span class="line"><span class="language-javascript">  &#125;)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="title class_">PageInit</span>()</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">changeTheme</span> = (<span class="params">t</span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> cT=themes[current],</span></span><br><span class="line"><span class="language-javascript">        tT=themes[t];</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> styles = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;style&quot;</span>)).<span class="title function_">filter</span>(<span class="function">(<span class="params">style</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 找到需要进行替换的style标签</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> text = style.<span class="property">innerText</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">`<span class="subst">$&#123;cT._initStyleReg&#125;</span>`</span>, <span class="string">&quot;i&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span> re.<span class="title function_">test</span>(text);</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///生成正则</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">`<span class="subst">$&#123;cT._initStyleReg&#125;</span>`</span>, <span class="string">&quot;ig&quot;</span>); <span class="comment">// 老的颜色簇正则，全局替换，且不区分大小写</span></span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">    styles.<span class="title function_">forEach</span>(<span class="function">(<span class="params">style</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> &#123; innerText &#125; = style;</span></span><br><span class="line"><span class="language-javascript">      style.<span class="property">innerHTML</span> = innerText.<span class="title function_">replace</span>(re, <span class="function">(<span class="params">match</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">///通过小写检查  rgba(0,0,0,.5) 替换成0.5 兼容好</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> index = cT.<span class="property">_initColorCluster</span>.<span class="title function_">indexOf</span>(match.<span class="title function_">toLowerCase</span>().<span class="title function_">replace</span>(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;0.&quot;</span>));</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">///通过大写写检查</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (index === -<span class="number">1</span>)index = cT.<span class="property">_initColorCluster</span>.<span class="title function_">indexOf</span>(match.<span class="title function_">toUpperCase</span>().<span class="title function_">replace</span>(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;0.&quot;</span>));</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 进行替换</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> tT.<span class="property">_initColorCluster</span>[index].<span class="title function_">toLowerCase</span>().<span class="title function_">replace</span>(<span class="regexp">/0\./g</span>, <span class="string">&quot;.&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      &#125;);</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// console.log(style.innerHTML)</span></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// style.setAttribute(&quot;class&quot;, &quot;so-ui-react-theme&quot;);</span></span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">    current=t;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;当前主题：%s&quot;</span>,current)</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">change</span>=(<span class="params"></span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">if</span>(current===<span class="string">&quot;default&quot;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">changeTheme</span>(<span class="string">&quot;t1&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(current===<span class="string">&quot;t1&quot;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">changeTheme</span>(<span class="string">&quot;t2&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">changeTheme</span>(<span class="string">&quot;default&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// componentDidMount();</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;a b&quot;</span>&gt;</span>testaaaaaai<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;b c&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;change&quot;</span>&gt;</span>更换颜色<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.a</span>&#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>: <span class="number">#DC143C</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.b</span>&#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">color</span>: <span class="number">#BBFFAA</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.c</span>&#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>:<span class="number">#2F4F4F</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="less实现换肤"><a href="#less实现换肤" class="headerlink" title="less实现换肤"></a>less实现换肤</h3><p>感觉less实现的很优雅</p><p>设置默认样式，原来它会找到所有如下的less样式标签，并且使用已编译的css同步创建 style 标签。</p><p>相当于在原来的基础上生成一个一模一样的style样式表添加到页面中。也就是说他需要一个模板。如果放在src里面他会被编译成css，无法成为模板。</p><p>我们这里把这个模板放到项目主目录的public中去。。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/public/test<span class="selector-class">.less</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@primary-color</span>: red;</span><br><span class="line"><span class="keyword">@bg-color</span>: blue;</span><br><span class="line"><span class="selector-class">.test-block</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">20px</span> auto;</span><br><span class="line">  <span class="attribute">color</span>: @primary-color;</span><br><span class="line">  <span class="attribute">background</span>: @bg-color;</span><br><span class="line">  <span class="selector-class">.block2</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: aquamarine;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>修改项目模板文件index.html，添加lessjs，也可以搞成本地的的，我这里为了方便直接添加cdn的</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">type</span>=<span class="string">&quot;image/svg+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/vite.svg&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vite + Vue<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet/less&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/test.less&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">less</span> = &#123;<span class="attr">async</span>:<span class="literal">true</span>,&#125;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/less.js/2.7.3/less.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/src/main.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>页面简单使用</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> themes=&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t1</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@primary-color&quot;</span>: <span class="string">&quot;#8b0000&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@bg-color&quot;</span>: <span class="string">&quot;#2f4f4f&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t2</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@primary-color&quot;</span>: <span class="string">&quot;#ffa500&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@bg-color&quot;</span>: <span class="string">&quot;#c0c0c0&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">t3</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@primary-color&quot;</span>:<span class="string">&quot;#000080&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;@bg-color&quot;</span>: <span class="string">&quot;#000000&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">onchange</span>=(<span class="params">t</span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">console</span>.<span class="title function_">log</span>(themes[t])</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">window</span>.<span class="property">less</span>.<span class="title function_">modifyVars</span>(themes[t]).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;修改成功&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;onchange(&#x27;t1&#x27;)&quot;</span>&gt;</span>改变哦<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;onchange(&#x27;t2&#x27;)&quot;</span>&gt;</span>改变哦<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;onchange(&#x27;t3&#x27;)&quot;</span>&gt;</span>改变哦<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;test-block&quot;</span>&gt;</span>testaaaaaai<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="其他思路"><a href="#其他思路" class="headerlink" title="其他思路"></a>其他思路</h3><p>vuex，自定义指令等等实现起来应该也很不错。理论上他们也能获得较高的自定义程度，颜色，背景图等等等。</p>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flutter极光推送集成华为(鸿蒙)厂商通道</title>
      <link href="/2022/10/05/20221005flutter%E9%9B%86%E6%88%90%E5%8D%8E%E4%B8%BA%E6%8E%A8%E9%80%81/"/>
      <url>/2022/10/05/20221005flutter%E9%9B%86%E6%88%90%E5%8D%8E%E4%B8%BA%E6%8E%A8%E9%80%81/</url>
      
        <content type="html"><![CDATA[<blockquote><p>flutter插件<a href="https://pub.flutter-io.cn/packages/jpush_flutter">jpush_flutter: 2.2.5</a>,<a href="https://github.com/jpush/jpush-flutter-plugin">github</a></p><p>华为推送证书<a href="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html#/myProject/99536292102686645/97458334310914890?appId=107234249">agconnect-services.json导出地址</a></p><p>极光<a href="https://www.jiguang.cn/portal/#/dev/newOverview">开发者平台</a></p><p>客户端sdk集成<a href="https://docs.jiguang.cn/jpush/client/Android/android_sdk">官方文档</a></p><p>客户端华为厂商通道集成<a href="https://docs.jiguang.cn/jpush/client/Android/android_3rd_guide#%E9%85%8D%E7%BD%AE-mavencentral-%E6%94%AF%E6%8C%81-1">官方文档</a></p><p>极光推送<a href="https://www.jiguang.cn/portal/#/push/app/bffe9289b1b2f16861869be9/config_manage/check/message">排查工具</a></p><p>com.huawei.hms:push:X.X.X.XXX<a href="https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/service-introduction-0000001050040060">推送服务（Push Kit）</a>是华为提供的消息推送平台，建立了从云端到终端的消息推送通道。您通过集成推送服务，可以向客户端应用实时推送消息，构筑良好的用户关系，提升用户的感知度和活跃度。</p><p>com.huawei.hms:push:X.X.X.XXX推送服务<a href="https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/android-app-version-0000001074227861#section527519181712">版本及其历史版本</a></p><p>com.huawei.agconnect:agcp:X.X.X.XXX<a href="https://developer.huawei.com/consumer/cn/doc/development/AppGallery-connect-Guides/agc-apm-android-releasenotes-0000001052887266">华为分析服务（Analytics Kit）</a>是针对移动应用、Web、快应用、快游戏、小程序等产品的一站式用户行为分析平台，贴合业务场景，提供数据采集、数据管理、数据分析、数据应用的一体化解决方案，驱动企业实现精准拉新、产品优化、精益运营、业务增长。</p><p><a href="https://docs.jiguang.cn/jpush/client/Android/android_sdk">极光推送官方</a>客户端集成，包括荣耀，OPPO，等等需要引入aar包，<strong>极光文档可能会更新，需要留意观看，</strong>看着他文档来就OK</p></blockquote><h3 id="极光推送基础集成"><a href="#极光推送基础集成" class="headerlink" title="极光推送基础集成"></a>极光推送基础集成</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">class MyHomePage extends StatefulWidget &#123;</span><br><span class="line">  const MyHomePage(&#123;super.key, required this.title&#125;);</span><br><span class="line">  final String title;</span><br><span class="line">  @override</span><br><span class="line">  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();</span><br><span class="line">&#125;</span><br><span class="line">class _MyHomePageState extends State&lt;MyHomePage&gt; &#123;</span><br><span class="line">  JPush jpush = new JPush();</span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              try &#123;</span><br><span class="line">                //Map&lt;String, dynamic&gt; message</span><br><span class="line">                jpush.addEventHandler(onReceiveNotification: (message) async &#123;</span><br><span class="line">                  print(&quot;jpush flutter onReceiveNotification: $&#123;json.encode(message)&#125;&quot;);</span><br><span class="line">                &#125;, onOpenNotification: (message) async &#123;</span><br><span class="line">                &#125;, onReceiveMessage: (message) async &#123;</span><br><span class="line">                  print(&quot;jpush flutter onReceiveMessage: $&#123;json.encode(message)&#125;&quot;);</span><br><span class="line">                &#125;, onReceiveNotificationAuthorization: (message) async &#123;</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125; on PlatformException &#123;</span><br><span class="line">                print(&quot;jpush Failed to get platform version.&quot;);</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              jpush.setup(</span><br><span class="line">                appKey: &quot;bffe9289**********61869be9&quot;,</span><br><span class="line">                channel: &quot;developer-default&quot;,</span><br><span class="line">                production: false,</span><br><span class="line">                debug: false, // 设置是否打印 debug 日志</span><br><span class="line">              );</span><br><span class="line"></span><br><span class="line">              jpush.applyPushAuthority(NotificationSettingsIOS(</span><br><span class="line">                sound: true,</span><br><span class="line">                alert: true,</span><br><span class="line">                badge: true,</span><br><span class="line">              ));</span><br><span class="line"></span><br><span class="line">              jpush.getRegistrationID().then((rid) &#123;</span><br><span class="line">                print(&quot;jpush flutter get registration id : $rid&quot;);</span><br><span class="line">              &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;, child: Text(&quot;setup&quot;)),</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              jpush.applyPushAuthority();</span><br><span class="line">            &#125;, child: Text(&quot;apply&quot;)),</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              jpush.isNotificationEnabled().then((bool value) &#123;</span><br><span class="line">                print(&quot;jpush 通知授权是否打开: $value&quot;);</span><br><span class="line">              &#125;).catchError((onError) &#123;</span><br><span class="line">                print(&quot;jpush 通知授权是否打开: $&#123;onError.toString()&#125;&quot;);</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;, child: Text(&quot;通知&quot;)),</span><br><span class="line">            ElevatedButton(onPressed:()&#123;</span><br><span class="line">              jpush.setAlias(&quot;1000*****&quot;).then((map) &#123; </span><br><span class="line">                print(&quot;==setAlias==$&#123;map&#125;==&quot;);</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;, child: Text(&quot;setAlias&quot;))</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="厂商通道集成"><a href="#厂商通道集成" class="headerlink" title="厂商通道集成"></a>厂商通道集成</h3><blockquote><p>gradle:6.7</p><p>distributionUrl=https://services.gradle.org/distributions/gradle-6.7-all.zip</p><p>android/build.gradle———-classpath com.android.tools.build:gradle:4.1.3</p><p>jpush_flutter: 2.2.5 Jcore版本:3.2.2  Jpush版本: 4.6.4   (可以在flutter的插件地址Changelog中查看)</p></blockquote><h4 id="android-build-gradle加上如下代码"><a href="#android-build-gradle加上如下代码" class="headerlink" title="android/build.gradle加上如下代码"></a>android/build.gradle加上如下代码</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    ext.kotlin_version = <span class="string">&#x27;1.6.10&#x27;</span></span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line"><span class="comment">// 加上如下代码</span></span><br><span class="line">        maven &#123;url <span class="string">&#x27;https://developer.huawei.com/repo/&#x27;</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;com.android.tools.build:gradle:4.1.3&#x27;</span></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加上如下代码</span></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;com.huawei.agconnect:agcp:1.4.2.300&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line"><span class="comment">// 加上如下代码</span></span><br><span class="line">        maven &#123; url <span class="string">&#x27;https://developer.huawei.com/repo/&#x27;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="agconnect-services-json放入到-android-app-中"><a href="#agconnect-services-json放入到-android-app-中" class="headerlink" title="agconnect-services.json放入到**android/app/**中"></a>agconnect-services.json放入到**android/app/**中</h4><h4 id="进入到android-app-build-gradle"><a href="#进入到android-app-build-gradle" class="headerlink" title="进入到android/app/build.gradle"></a>进入到<strong>android/app/build.gradle</strong></h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line">apply plugin: <span class="string">&#x27;kotlin-android&#x27;</span></span><br><span class="line">apply <span class="keyword">from</span>: <span class="string">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br><span class="line"><span class="comment">// 加上如下代码（位置随意）</span></span><br><span class="line">apply plugin: <span class="string">&#x27;com.huawei.agconnect&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="引入厂商sdk"><a href="#引入厂商sdk" class="headerlink" title="引入厂商sdk"></a>引入厂商sdk</h4><p>极光厂商插件版本与接入 JPush 版本保持一致，下同，jpush版本可以在极光推送<a href="https://www.jiguang.cn/portal/#/push/app/bffe9289b1b2f16861869be9/config_manage/check/message">排查工具</a>中查看</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="comment">// 接入华为厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;com.huawei.hms:push:5.3.0.301&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:huawei:4.4.5&#x27;</span><span class="comment">// 极光厂商插件版本与接入 JPush 版本保持一致，下同</span></span><br><span class="line">    <span class="comment">// 接入小米厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:xiaomi:4.4.5&#x27;</span></span><br><span class="line">    <span class="comment">// 接入 FCM 厂商</span></span><br><span class="line"><span class="comment">// implementation &#x27;com.google.firebase:firebase-messaging:21.0.1&#x27;</span></span><br><span class="line"><span class="comment">// implementation &#x27;cn.jiguang.sdk.plugin:fcm:4.0.0&#x27;</span></span><br><span class="line">    <span class="comment">// 接入魅族厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:meizu:4.4.5&#x27;</span></span><br><span class="line">    <span class="comment">// 接入 VIVO 厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:vivo:4.4.5&#x27;</span></span><br><span class="line">    <span class="comment">// 接入 OPPO 厂商</span></span><br><span class="line">    implementation <span class="string">&#x27;cn.jiguang.sdk.plugin:oppo:4.4.5&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修改AndroidManifest-xml"><a href="#修改AndroidManifest-xml" class="headerlink" title="修改AndroidManifest.xml"></a>修改AndroidManifest.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> </span></span><br><span class="line"><span class="tag">···</span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    ···&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">       ···</span></span><br><span class="line"><span class="tag">       <span class="attr">tools:replace</span>=<span class="string">&quot;android:label&quot;</span></span></span><br></pre></td></tr></table></figure><h3 id="版本升级"><a href="#版本升级" class="headerlink" title="版本升级"></a>版本升级</h3><p><strong>‘com.huawei.agconnect:agcp:1.5.2.300’</strong> 这个版本是IDE自动提示我的如果版本不对他运行可能会报错!!!!,开头给力地址可以查找自己对应的版本</p><p><strong>‘com.huawei.hms:push:5.3.0.301’</strong> 开头给力地址可以查找自己对应的版本</p><blockquote><p>gradle:7.4</p><p>distributionUrl=https://services.gradle.org/distributions/gradle-7.4-all.zip</p><p>android/build.gradle———-classpath ‘com.android.tools.build:gradle:7.1.2’</p><p>jpush_flutter: 2.4.0 Jpush版本: 4.8.4 (可以在flutter的插件地址Changelog中查看)</p><p>aar的包位于android/app/libs/***.aar</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">...</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath &#x27;com.android.tools.build:gradle:7.1.2&#x27;</span><br><span class="line">        classpath &quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span><br><span class="line"></span><br><span class="line">// 加上如下代码  </span><br><span class="line">        classpath &#x27;com.huawei.agconnect:agcp:1.5.2.300&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    // 接入华为厂商</span><br><span class="line">    implementation &#x27;com.huawei.hms:push:5.3.0.301&#x27;</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:huawei:4.8.4&#x27;// 极光厂商插件版本与接入 JPush 版本保持一致，下同</span><br><span class="line">    // 接入小米厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:xiaomi:4.8.4&#x27;</span><br><span class="line">    // 接入魅族厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:meizu:4.8.4&#x27;</span><br><span class="line">    // 接入 VIVO 厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:vivo:4.8.4&#x27;</span><br><span class="line">    // 接入 OPPO 厂商</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:oppo:4.8.4&#x27;</span><br><span class="line">    implementation(name: &#x27;com.heytap.msp-push-3.1.0&#x27;, ext: &#x27;aar&#x27;)</span><br><span class="line">    //以下为 OPPO 3.1.0 aar需要依赖</span><br><span class="line">    implementation &#x27;com.google.code.gson:gson:2.6.2&#x27;</span><br><span class="line">    implementation &#x27;commons-codec:commons-codec:1.6&#x27;</span><br><span class="line">    implementation &#x27;androidx.annotation:annotation:1.1.0&#x27;</span><br><span class="line">    //荣耀</span><br><span class="line">    implementation &#x27;cn.jiguang.sdk.plugin:honor:4.8.4&#x27;</span><br><span class="line">    implementation(name: &#x27;HonorPushSDK-7.0.1.103&#x27;, ext: &#x27;aar&#x27;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> flutter </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flutter </tag>
            
            <tag> 极光推送 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>etcd集群的搭建</title>
      <link href="/2022/09/25/20220925etcd%E7%9A%84%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"/>
      <url>/2022/09/25/20220925etcd%E7%9A%84%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<p>etcd安装不说了详情请看上篇文章</p><h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><h4 id="节点1"><a href="#节点1" class="headerlink" title="节点1"></a>节点1</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd --name etcd_t_0 --initial-advertise-peer-urls http://119.91.206.195:2380 \</span><br><span class="line">  --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --advertise-client-urls http://119.91.206.195:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd_t_0=http://119.91.206.195:2380,etcd_t_1=http://1.117.72.9:2380,etcd_t_2=http://47.92.80.135:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir /var/lib/etcd5/</span><br></pre></td></tr></table></figure><h4 id="节点2"><a href="#节点2" class="headerlink" title="节点2"></a>节点2</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd --name etcd_t_1 --initial-advertise-peer-urls http://1.117.72.9:2380 \</span><br><span class="line">  --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --advertise-client-urls http://1.117.72.9:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd_t_0=http://119.91.206.195:2380,etcd_t_1=http://1.117.72.9:2380,etcd_t_2=http://47.92.80.135:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir /var/lib/etcd5/</span><br></pre></td></tr></table></figure><h4 id="节点3"><a href="#节点3" class="headerlink" title="节点3"></a>节点3</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd --name etcd_t_2 --initial-advertise-peer-urls http://47.92.80.135:2380 \</span><br><span class="line">  --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --advertise-client-urls http://47.92.80.135:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd_t_0=http://119.91.206.195:2380,etcd_t_1=http://1.117.72.9:2380,etcd_t_2=http://47.92.80.135:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir /var/lib/etcd5/</span><br></pre></td></tr></table></figure><h3 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h3><ul><li><p>查看集群成员</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member list --write-out=table</span></span><br><span class="line">+------------------+---------+----------+----------------------------+----------------------------+</span><br><span class="line">|        ID        | STATUS  |   NAME   |         PEER ADDRS         |        CLIENT ADDRS        |</span><br><span class="line">+------------------+---------+----------+----------------------------+----------------------------+</span><br><span class="line">| 362499433afddc14 | started | etcd_t_1 | http://1.117.72.9:2380     | http://1.117.72.9:2379     |</span><br><span class="line">| e4258ae59dee9dc3 | started | etcd_t_0 | http://119.91.206.195:2380 | http://119.91.206.195:2379 |</span><br><span class="line">| feb1217e15f7013f | started | etcd_t_2 | http://47.92.80.135:2380   | http://47.92.80.135:2379   |</span><br><span class="line">+------------------+---------+----------+----------------------------+----------------------------+</span><br></pre></td></tr></table></figure></li><li><p>查看集群健康</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl --endpoints=119.91.206.195:2380,1.117.72.9:2380,47.92.80.135:2380 endpoint health</span></span><br><span class="line">1.117.72.9:2380 is healthy: successfully committed proposal: took = 87.35868ms</span><br><span class="line">47.92.80.135:2380 is healthy: successfully committed proposal: took = 111.468497ms</span><br><span class="line">119.91.206.195:2380 is healthy: successfully committed proposal: took = 101.468497ms</span><br></pre></td></tr></table></figure></li><li><p>查看集群状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl --endpoints=119.91.206.195:2380,1.117.72.9:2380,47.92.80.135:2380 endpoint status --write-out=table</span></span><br><span class="line">+---------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">|     ENDPOINT        |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">| 1.117.72.9:2380     | 362499433afddc14 | 3.3.11  | 20 kB   | <span class="literal">false</span>     |        15 |          9 |</span><br><span class="line">| 47.92.80.135:2380   | feb1217e15f7013f | 3.3.11  | 16 kB   | <span class="literal">false</span>     |        15 |          9 |</span><br><span class="line">| 119.91.206.195:2380 | e4258ae59dee9dc3 | 3.3.11  | 16 kB   | <span class="literal">true</span>      |        15 |          9 |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+-----------+------------+</span><br></pre></td></tr></table></figure></li><li><p>删除一个节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member remove 362499433afddc14</span></span><br><span class="line">Member 362499433afddc14 removed from cluster 51573d7cfd299893</span><br></pre></td></tr></table></figure></li><li><p>加入一个节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member add etcd_t_1 --peer-urls=http://1.117.72.9:2380</span></span><br><span class="line">Member c4356e396bf22311 added to cluster 51573d7cfd299893</span><br><span class="line"></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd_t_1&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd_t_1=http://1.117.72.9:2380,etcd_t_0=http://119.91.206.195:2380,etcd_t_2=http://47.92.80.135:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;existing&quot;</span></span><br></pre></td></tr></table></figure><p>新节点启动的时候使用以上输出的配置启动一定注意参数</p></li><li><p>故障主机加入节点</p></li></ul><p>故障的etcd主机：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop etcd</span><br></pre></td></tr></table></figure><p>移除故障节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member remove 362499433afddc14</span></span><br><span class="line">Member 362499433afddc14 removed from cluster 51573d7cfd299893</span><br></pre></td></tr></table></figure><p>查询集群成员</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+------------------+-----------+----------+----------------------------+----------------------------+</span><br><span class="line">|        ID        |  STATUS   |   NAME   |         PEER ADDRS         |        CLIENT ADDRS        |</span><br><span class="line">+------------------+-----------+----------+----------------------------+----------------------------+</span><br><span class="line">| 50466d8335f8506a | unstarted |          | http://1.117.72.9:2380     |                            |</span><br><span class="line">| e4258ae59dee9dc3 | started   | etcd_t_0 | http://119.91.206.195:2380 | http://119.91.206.195:2379 |</span><br><span class="line">| feb1217e15f7013f | started   | etcd_t_2 | http://47.92.80.135:2380   | http://47.92.80.135:2379   |</span><br><span class="line">+------------------+-----------+----------+----------------------------+----------------------------+</span><br></pre></td></tr></table></figure><p>正常的etcd主机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-14-centos ~]<span class="comment"># etcdctl member add etcd_t_1 --peer-urls=http://1.117.72.9:2380</span></span><br><span class="line">Member c4356e396bf22311 added to cluster 51573d7cfd299893</span><br><span class="line"></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd_t_1&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd_t_1=http://1.117.72.9:2380,etcd_t_0=http://119.91.206.195:2380,etcd_t_2=http://47.92.80.135:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;existing&quot;</span></span><br></pre></td></tr></table></figure><p>故障的etcd主机，启动etcd后，再查看etcd状态：</p><blockquote><p>一定要去修改故障主机的配置为：ETCD_INITIAL_CLUSTER_STATE=”existing”</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先删除错误节点的数据</span></span><br><span class="line"><span class="built_in">rm</span> -rf /var/lib/etcd/member</span><br><span class="line">systemctl start etcd</span><br><span class="line"><span class="comment"># 等待一会，这时候会同步数据，稍等再查看节点状态</span></span><br><span class="line">etcdctl endpoint health</span><br><span class="line">127.0.0.1:2379 is healthy: successfully committed proposal: took = 24.52485ms</span><br></pre></td></tr></table></figure><p>到这里，etcd故障节点修复完毕</p><h3 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h3><ul><li>这是集群中使用的etcd版本不一致的提示(<strong>这很有可能到导致集群不健康，至少我这个版本会，后来我全是yum install etcd</strong>)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2022-09-25 21:59:44.187212 W | etcdserver: the <span class="built_in">local</span> etcd version 3.1.5 is not up-to-date</span><br><span class="line">2022-09-25 21:59:44.187217 W | etcdserver: member feb1217e15f7013f has a higher version 3.3.11</span><br></pre></td></tr></table></figure></li><li>如果在一个目录启动过etcd，要启动新的集群或者其他的新的实例，最好换个目录，他可能会导致无法启动。暴力点rm -rf ******</li><li>故障的etcd主机，一定要去修改故障主机的配置为：ETCD_INITIAL_CLUSTER_STATE=existing</li><li>注意如果是前面修复过坏节点，下次启动集群的时候也不需要去修改坏节点的ETCD_INITIAL_CLUSTER_STATE=new</li><li>不同版本的etcd命令可能不一样，比如：添加节点</li><li>设置成existing，必须确保在启动时候其他member是存活的（peer端口），否则启动失败。用在扩容新实例的启动。设置成new，用在cluster已知member的启动。</li></ul>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> etcd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>etcd单节点安装和golang的简单使用</title>
      <link href="/2022/09/18/20220918etcd%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85%E5%92%8Cgolang%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
      <url>/2022/09/18/20220918etcd%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85%E5%92%8Cgolang%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="安装golang"><a href="#安装golang" class="headerlink" title="安装golang"></a>安装golang</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install golang</span><br></pre></td></tr></table></figure><h2 id="etcd单节点安装"><a href="#etcd单节点安装" class="headerlink" title="etcd单节点安装"></a>etcd单节点安装</h2><h3 id="源码包安装"><a href="#源码包安装" class="headerlink" title="源码包安装"></a>源码包安装</h3><h4 id="下载etcd"><a href="#下载etcd" class="headerlink" title="下载etcd"></a>下载etcd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.1.5/etcd-v3.1.5-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><h4 id="解压-etcd-v3-1-5-linux-amd64-tar-gz-压缩文件"><a href="#解压-etcd-v3-1-5-linux-amd64-tar-gz-压缩文件" class="headerlink" title="解压 etcd-v3.1.5-linux-amd64.tar.gz 压缩文件"></a>解压 etcd-v3.1.5-linux-amd64.tar.gz 压缩文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf etcd-v3.1.5-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><h4 id="将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。"><a href="#将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。" class="headerlink" title="将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。"></a>将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//进入文件夹</span><br><span class="line"><span class="built_in">cd</span> etcd-v3.1.5-linux-amd64/</span><br><span class="line">//将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中。</span><br><span class="line"><span class="built_in">mv</span> etcd* /usr/local/bin</span><br></pre></td></tr></table></figure><h4 id="修改使用的api等级"><a href="#修改使用的api等级" class="headerlink" title="修改使用的api等级"></a>修改使用的api等级</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><h4 id="查看版本信息"><a href="#查看版本信息" class="headerlink" title="查看版本信息"></a>查看版本信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">etcdctl v</span><br><span class="line"></span><br><span class="line">etcdctl version: 3.1.5</span><br><span class="line">API version: 3.1</span><br><span class="line"></span><br><span class="line">etcd --version</span><br><span class="line"></span><br><span class="line">etcd Version: 3.1.5</span><br><span class="line">Git SHA: 2cf9e51</span><br><span class="line">Go Version: go1.10.3</span><br><span class="line">Go OS/Arch: linux/amd64</span><br></pre></td></tr></table></figure><h4 id="创建etcd数据存放位置"><a href="#创建etcd数据存放位置" class="headerlink" title="创建etcd数据存放位置"></a>创建etcd数据存放位置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 数据存放位置的文件夹</span><br><span class="line"><span class="built_in">mkdir</span> -p /var/lib/etcd/</span><br></pre></td></tr></table></figure><h4 id="创建启动文件"><a href="#创建启动文件" class="headerlink" title="创建启动文件"></a>创建启动文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/systemd/system/etcd.service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//复制以下即可</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Etcd Server</span></span><br><span class="line"><span class="string">Documentation=https://github.com/coreos/etcd</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">User=root</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">Environment=ETCD_NAME=etcd_test_1</span></span><br><span class="line"><span class="string">Environment=ETCD_DATA_DIR=/var/lib/etcd/</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/etcd</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">RestartSec=10s</span></span><br><span class="line"><span class="string">LimitNOFILE=40000</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h4 id="重新加载配置-amp-amp-开机启动-amp-amp-启动-etcd"><a href="#重新加载配置-amp-amp-开机启动-amp-amp-启动-etcd" class="headerlink" title="重新加载配置 &amp;&amp; 开机启动 &amp;&amp; 启动 etcd"></a>重新加载配置 &amp;&amp; 开机启动 &amp;&amp; 启动 etcd</h4><h5 id="启动etcd"><a href="#启动etcd" class="headerlink" title="启动etcd"></a>启动etcd</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> etcd &amp;&amp; systemctl start etcd</span><br><span class="line">//成功如下</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/etcd.service to /etc/systemd/system/etcd.service.</span><br></pre></td></tr></table></figure><h5 id="开机启动设置状态，状态-enabled"><a href="#开机启动设置状态，状态-enabled" class="headerlink" title="开机启动设置状态，状态 enabled"></a>开机启动设置状态，状态 enabled</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files etcd.service</span><br><span class="line"></span><br><span class="line">//成功如下</span><br><span class="line">UNIT FILE    STATE </span><br><span class="line">etcd.service enabled</span><br><span class="line"> </span><br><span class="line">1 unit files listed.</span><br></pre></td></tr></table></figure><h5 id="查看-etcd-状态"><a href="#查看-etcd-状态" class="headerlink" title="查看 etcd 状态"></a>查看 etcd 状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl show etcd.service</span><br></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">etcdctl put mykey <span class="string">&quot;this is etcd2&quot;</span></span><br><span class="line">OK</span><br><span class="line">etcdctl get mykey</span><br><span class="line">mykey</span><br><span class="line">this is etcd</span><br></pre></td></tr></table></figure><h4 id="外网连接"><a href="#外网连接" class="headerlink" title="外网连接"></a>外网连接</h4><p>当然，etcd默认本地访问。如果需要远程访问需要在配置文件（/etc/etcd.conf 上面创建的文件）中加上如下操作。注意如果上面一行不是字符串需要加个</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Type=notify</span><br><span class="line">Environment=ETCD_NAME=etcd_test_1</span><br><span class="line">Environment=ETCD_DATA_DIR=/var/lib/etcd/</span><br><span class="line"></span><br><span class="line">Environment=ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379</span><br><span class="line">Environment=ETCD_ADVERTISE_CLIENT_URLS=http://0.0.0.0:2379</span><br><span class="line">或者直接使用本机</span><br><span class="line">Environment=ETCD_LISTEN_CLIENT_URLS=http://1.117.72.92:2379</span><br><span class="line">Environment=ETCD_ADVERTISE_CLIENT_URLS=http://1.117.72.92:2379</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ExecStart=/usr/local/bin/etcd</span><br></pre></td></tr></table></figure><p><strong>如果当前已经启动了修改的配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启生效</span></span><br><span class="line">systemctl restart etcd</span><br><span class="line"><span class="comment"># 重启生效</span></span><br><span class="line">systemctl stop etcd</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> etcd &amp;&amp; systemctl start etcd</span><br></pre></td></tr></table></figure><h4 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h4><ul><li>–name：方便理解的节点名称，默认为 default，在集群中应该保持唯一，可以使用 hostname</li><li>–data-dir：服务运行数据保存的路径，默认为 ${name}.etcd</li><li>–snapshot-count：指定有多少事务（transaction）被提交时，触发截取快照保存到磁盘</li><li>–heartbeat-interval：leader 多久发送一次心跳到 followers。默认值是 100ms</li><li>–eletion-timeout：重新投票的超时时间，如果follower在该时间间隔没有收到心跳包，会触发重新投票，默认为 1000 ms</li><li>–listen-peer-urls：和同伴通信的地址，比如 <a href="http://ip:2380，如果有多个，使用逗号分隔。需要所有节点都能够访问，所以不要使用">http://ip:2380，如果有多个，使用逗号分隔。需要所有节点都能够访问，所以不要使用</a> localhost</li><li>–listen-client-urls：对外提供服务的地址：比如 <a href="http://ip:2379,http://127.0.0.1:2379，客户端会连接到这里和etcd交互">http://ip:2379,http://127.0.0.1:2379，客户端会连接到这里和etcd交互</a></li><li>–advertise-client-urls：对外公告的该节点客户端监听地址，这个值会告诉集群中其他节点</li><li>–initial-advertise-peer-urls：该节点同伴监听地址，这个值会告诉集群中其他节点</li><li>–initial-cluster：集群中所有节点的信息，格式为 node1=<a href="http://ip1:2380,node2=http://ip2:2380,…。需要注意的是，这里的">http://ip1:2380,node2=http://ip2:2380,…。需要注意的是，这里的</a> node1 是节点的–name指定的名字；后面的ip1:2380 是–initial-advertise-peer-urls 指定的值</li><li>–initial-cluster-state：新建集群的时候，这个值为 new；假如已经存在的集群，这个值为existing</li><li>–initial-cluster-token：创建集群的token，这个值每个集群保持唯一。这样的话，如果你要重新创建集群，即使配置和之前一样，也会再次生成新的集群和节点 uuid；否则会导致多个集群之间的冲突，造成未知的错误<br></li></ul><p>这些选项，与上面我们配置文件里的配置一一对应，如ETCD_INITIAL_CLUSTER等同于–inital-cluster, ETCD_INITIAL_CLUSTER_STATE等同于–initial-cluster-state。</p><blockquote><p>所有以–init开头的配置都是在第一次启动etcd集群的时候才会用到，后续节点的重启会被忽略，如–initial-cluseter参数。所以当成功初始化了一个etcd集群以后，就不再需要这个参数或环境变量了。</p></blockquote><h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl stop etcd</span><br><span class="line">etcdctl member list//查看节点</span><br></pre></td></tr></table></figure><h4 id="报错收集"><a href="#报错收集" class="headerlink" title="报错收集"></a>报错收集</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">No <span class="built_in">help</span> topic <span class="keyword">for</span> ‘put’</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_API=3 解决</span><br></pre></td></tr></table></figure><h3 id="etcd-git官方安装脚本"><a href="#etcd-git官方安装脚本" class="headerlink" title="etcd git官方安装脚本"></a>etcd git官方安装脚本</h3><blockquote><p><a href="https://github.com/etcd-io/etcd/releases">https://github.com/etcd-io/etcd/releases</a><br>继续从 &lt;&lt;将文件夹中etcd和etcdctl两个文件添加可执行文件路径到环境变量PATH中&gt;&gt; 开始</p></blockquote><h3 id="etcd-yum安装"><a href="#etcd-yum安装" class="headerlink" title="etcd yum安装"></a>etcd yum安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install etcd</span><br><span class="line"></span><br><span class="line">//继续从 &lt;&lt;修改使用的api等级&gt;&gt; 开始</span><br></pre></td></tr></table></figure><h2 id="安装etcd-webui"><a href="#安装etcd-webui" class="headerlink" title="安装etcd webui"></a>安装etcd webui</h2><ul><li>记得启动Etcd服务。</li><li>先安装node，git环境，然后clone。</li><li>安装node可以到 <a href="http://nodejs.cn/download/%E4%B8%8B%E8%BD%BD%E5%AF%B9%E5%BA%94%E7%9A%84">http://nodejs.cn/download/下载对应的</a> node 版本。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/henszey/etcd-browser.git</span><br><span class="line">cd etcd-browser/</span><br><span class="line">vim server.js  </span><br></pre></td></tr></table></figure>编辑server.js，修改内容如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var etcdHost = process.env.ETCD_HOST || &#x27;127.0.0.1&#x27;;  # etcd 主机IP</span><br><span class="line">var etcdPort = process.env.ETCD_PORT || 2379;          # etcd 主机端口</span><br><span class="line">var serverPort = process.env.SERVER_PORT || 8000;      # etcd-browser 监听端口</span><br></pre></td></tr></table></figure>然后启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node server.js</span><br></pre></td></tr></table></figure>访问：<a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a></li></ul><h2 id="go连接etcd和一些操作"><a href="#go连接etcd和一些操作" class="headerlink" title="go连接etcd和一些操作"></a>go连接etcd和一些操作</h2><h3 id="put-get的简单操作示例"><a href="#put-get的简单操作示例" class="headerlink" title="put/get的简单操作示例"></a>put/get的简单操作示例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;go.etcd.io/etcd/client/v3&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="comment">// handle error!</span></span><br><span class="line">      fmt.Printf(<span class="string">&quot;connect to etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line">   <span class="comment">// put</span></span><br><span class="line">   ctx, cancel := context.WithTimeout(context.Background(), <span class="number">3</span>*time.Second)</span><br><span class="line">   _, err = cli.Put(ctx, <span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v1&quot;</span>)</span><br><span class="line">   cancel()</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;put to etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// get</span></span><br><span class="line">   ctx, cancel = context.WithTimeout(context.Background(), <span class="number">3</span>*time.Second)</span><br><span class="line">   resp, err := cli.Get(ctx, <span class="string">&quot;k1&quot;</span>)</span><br><span class="line">   cancel()</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;get from etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">for</span> _, ev := <span class="keyword">range</span> resp.Kvs &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;%s:%s\n&quot;</span>, ev.Key, ev.Value)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="watch的使用"><a href="#watch的使用" class="headerlink" title="watch的使用"></a>watch的使用</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;go.etcd.io/etcd/client/v3&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;connect to etcd failed, err:%v\n&quot;</span>, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line">   <span class="comment">// watch key:q1mi change</span></span><br><span class="line">   rch := cli.Watch(context.Background(), <span class="string">&quot;k1&quot;</span>) <span class="comment">// &lt;-chan WatchResponse</span></span><br><span class="line">   <span class="keyword">for</span> wresp := <span class="keyword">range</span> rch &#123;</span><br><span class="line">      <span class="keyword">for</span> _, ev := <span class="keyword">range</span> wresp.Events &#123;</span><br><span class="line">         fmt.Printf(<span class="string">&quot;Type: %s Key:%s Value:%s\n&quot;</span>, ev.Type, ev.Kv.Key, ev.Kv.Value)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在同级的目录下cmd进入(下面操作是在windows上进行的，因为方便)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcdctl.exe --endpoints=http://127.0.0.1:2379 put k1 <span class="string">&quot;xixixixix&quot;</span></span><br><span class="line">etcdctl.exe --endpoints=http://127.0.0.1:2379 del k1</span><br><span class="line">etcdctl.exe --endpoints=http://127.0.0.1:2379 put k1 <span class="string">&quot;dsb3&quot;</span></span><br></pre></td></tr></table></figure><h3 id="lease租约的使用"><a href="#lease租约的使用" class="headerlink" title="lease租约的使用"></a>lease租约的使用</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;go.etcd.io/etcd/client/v3&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: time.Second * <span class="number">5</span>,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success.&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 创建一个5秒的租约</span></span><br><span class="line">   resp, err := cli.Grant(context.TODO(), <span class="number">5</span>)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(resp.ID)</span><br><span class="line">   <span class="comment">// 5秒钟之后, /aaaa/ 这个key就会被移除</span></span><br><span class="line">   _, err = cli.Put(context.TODO(), <span class="string">&quot;/aaaa/&quot;</span>, <span class="string">&quot;dsb&quot;</span>, clientv3.WithLease(resp.ID))</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   time.Sleep(time.Second * <span class="number">6</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="keepAlive"><a href="#keepAlive" class="headerlink" title="keepAlive"></a>keepAlive</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">      Endpoints:   []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;,</span><br><span class="line">      DialTimeout: time.Second * <span class="number">5</span>,</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Println(<span class="string">&quot;connect to etcd success.&quot;</span>)</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">   resp, err := cli.Grant(context.TODO(), <span class="number">5</span>)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   _, err = cli.Put(context.TODO(), <span class="string">&quot;/aaaa/&quot;</span>, <span class="string">&quot;dsb&quot;</span>, clientv3.WithLease(resp.ID))</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// the key &#x27;foo&#x27; will be kept forever</span></span><br><span class="line">   ch, kaerr := cli.KeepAlive(context.TODO(), resp.ID)</span><br><span class="line">   <span class="keyword">if</span> kaerr != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      ka := &lt;-ch</span><br><span class="line">      fmt.Println(<span class="string">&quot;ttl:&quot;</span>, ka.TTL)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
            <tag> linux </tag>
            
            <tag> etcd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker安装mysql</title>
      <link href="/2022/06/14/20220614docker%E5%AE%89%E8%A3%85mysql/"/>
      <url>/2022/06/14/20220614docker%E5%AE%89%E8%A3%85mysql/</url>
      
        <content type="html"><![CDATA[<p>注意自己的mysql镜像版本</p><p>docker版本20.10.14 </p><p>单机模式</p><ul><li>拉取镜像</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql</span><br></pre></td></tr></table></figure><ul><li>运行容器<blockquote><p>需要把数据库的数据映射到主机（否则容器关闭数据丢失）且，下次使用同样的映射命令创建容器，数据能继续使用</p></blockquote></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p=13306:3306 --privileged=<span class="literal">true</span> \</span><br><span class="line">-v /usr/mysql/log:/var/log/mysql \</span><br><span class="line">-v /usr/mysql/data:/var/lib/mysql \</span><br><span class="line">-v /usr/mysql/conf:/etc/mysql/conf.d \</span><br><span class="line">--name=tabbymysql2 \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=bb123456 \</span><br><span class="line">mysql</span><br></pre></td></tr></table></figure><h4 id="报错解决"><a href="#报错解决" class="headerlink" title="报错解决"></a>报错解决</h4><ul><li>不同版本的映射可能不同比如：5.7</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- /app/mysql/db:/var/lib/mysql</span><br><span class="line">- /app/mysql/conf/my.cnf:/etc/my.cnf</span><br><span class="line">- /app/mysql/init:/docker-entrypoint-init.d</span><br></pre></td></tr></table></figure><ul><li>可能会出现查询乱码</li></ul><p>需要修改数据的默认字符集</p><p>docker的mysql默认字符集是拉丁还是其他的（如下方法查看），会导致中文乱码，navicat查看不会乱码，因为navicat工具自带功能utf8</p><blockquote><p>mysql -uroot -p<br>SHOW VARIABLES LIKE ‘character%’;</p></blockquote><p>解决方法：</p><p>在宿主机中修改配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/mysql/conf/my.cnf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">default_character_set=utf8</span><br><span class="line">[mysqld]</span><br><span class="line">collation_server = utf8_general_ci</span><br><span class="line">character_set_server = utf8</span><br></pre></td></tr></table></figure><p>简单的测试一下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#重启容器</span></span><br><span class="line">docker restart b4f981975015</span><br><span class="line"><span class="comment">#进入容器</span></span><br><span class="line"><span class="comment">#进入sql</span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"><span class="comment">#测试：</span></span><br><span class="line">create database test2;</span><br><span class="line">insert into t1 values(1,<span class="string">&quot;zs&quot;</span>);</span><br><span class="line"><span class="comment">#navicat中：</span></span><br><span class="line">INSERT into test2.t1 VALUES(3,<span class="string">&quot;张三&quot;</span>);</span><br><span class="line"><span class="comment">#docker查询</span></span><br><span class="line">SELECT * FROM t1;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker安装redis及redis集群</title>
      <link href="/2022/06/12/20220612docker%E5%AE%89%E8%A3%85redis%E5%8F%8Aredis%E9%9B%86%E7%BE%A4/"/>
      <url>/2022/06/12/20220612docker%E5%AE%89%E8%A3%85redis%E5%8F%8Aredis%E9%9B%86%E7%BE%A4/</url>
      
        <content type="html"><![CDATA[<p>需要自己准备一个redis.conf文件</p><p>redis中文官方网站：<a href="http://www.redis.cn/download.html">http://www.redis.cn/download.html</a> 下载解压然后获取文件</p><p>docker版本20.10.14 </p><h3 id="单机模式"><a href="#单机模式" class="headerlink" title="单机模式"></a>单机模式</h3><ul><li><p>获取docker镜像</p><blockquote><p>docker pull redis</p></blockquote></li><li><p>修改准备好的redis.conf文件</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span> 127.0.0.1  修改后  <span class="comment"># bind 127.0.0.1</span></span><br><span class="line">protected-mode <span class="built_in">yes</span> 修改后 protected-mode no</span><br><span class="line"><span class="comment">#设置密码，他这个没有写，随便找一行加上</span></span><br><span class="line">requirepass myPassword修改后 requirepass bb123456</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个配置不能为yes ，他会和docker的 -d 参数冲突</span></span><br><span class="line">daemonize no</span><br><span class="line"></span><br><span class="line"><span class="comment">#redis持久化随意</span></span><br><span class="line">appendonly no</span><br></pre></td></tr></table></figure><ul><li>把上面的文件放入某个目录</li></ul><p>我这里放入 /usr/redis/redis.conf</p><ul><li>启动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p=16379:6379 --name=testredis --privileged=<span class="literal">true</span> \</span><br><span class="line">-v /usr/redis/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-v /usr/redis/data:/data \</span><br><span class="line">redis redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure><h3 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h3><h4 id="启动多个redis（可以在多个服务器上或者在一个上）"><a href="#启动多个redis（可以在多个服务器上或者在一个上）" class="headerlink" title="启动多个redis（可以在多个服务器上或者在一个上）"></a>启动多个redis（可以在多个服务器上或者在一个上）</h4><p>创建并运行docker容器实例</p><blockquote><p>–name redis-node-6 容器名字<br>–net host 使用宿主机的IP和端口，默认<br>–privileged=true 获取宿主机root用户权限<br>-v /data/redis/share/redis-node-6:/data 容器卷，宿主机地址:docker内部地址<br>redis:6.0.8 redis镜像和版本号<br>–cluster-enabled yes 开启redis集群<br>–appendonly yes 开启持久化<br>–port 6386 redis端口号</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name=redis-node-1 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode1:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6381</span><br><span class="line">docker run -d --name=redis-node-2 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode2:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6382</span><br><span class="line">docker run -d --name=redis-node-3 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode3:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6383</span><br><span class="line">docker run -d --name=redis-node-4 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode4:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6384</span><br><span class="line">docker run -d --name=redis-node-5 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode5:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6385</span><br><span class="line">docker run -d --name=redis-node-6 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode6:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6386</span><br></pre></td></tr></table></figure><h4 id="构建集群关系与测试"><a href="#构建集群关系与测试" class="headerlink" title="构建集群关系与测试"></a>构建集群关系与测试</h4><ul><li>随机选取一个节点作为主节点,并进入容器</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it redis-node-1 /bin/bash -it</span><br></pre></td></tr></table></figure><ul><li>构建集群</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create 1.117.72.9:6381 \</span><br><span class="line">1.117.72.9:6382 \</span><br><span class="line">1.117.72.9:6383 \</span><br><span class="line">1.117.72.9:6384 \</span><br><span class="line">1.117.72.9:6385 \</span><br><span class="line">1.117.72.9:6386 \</span><br><span class="line">--cluster-replicas 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入yes</span></span><br><span class="line"><span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重新进入第一个节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-node-1 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用redis</span></span><br><span class="line">redis-cli -p 6381</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看集群状态</span></span><br><span class="line">127.0.0.1:6381&gt; cluster info</span><br><span class="line"><span class="comment">#查看集群节点，当前配置会返回三主三从</span></span><br><span class="line">127.0.0.1:6381&gt; cluster nodes</span><br><span class="line"></span><br><span class="line"><span class="comment">#存储测试</span></span><br><span class="line">127.0.0.1:6381&gt; <span class="built_in">set</span> k1 v1</span><br><span class="line">(error) MOVED 12706 1.117.72.9:6383</span><br><span class="line">127.0.0.1:6381&gt; <span class="built_in">set</span> k2 v2</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment">#上面失败了是因为我在node1节点中，因为node1的节点槽位0-5460，但是存储k1的时候分配的槽位为12706，高于当前节点的5460所以存不进去、</span></span><br><span class="line"><span class="comment">#上面是单机使用redis，应该使用集群模式进入</span></span><br><span class="line">redis-cli -p 6381 -c</span><br><span class="line"></span><br><span class="line"><span class="comment">#清空redis</span></span><br><span class="line">FLUSHALL</span><br><span class="line"></span><br><span class="line"><span class="comment">#存储测试</span></span><br><span class="line">127.0.0.1:6381&gt; <span class="built_in">set</span> k1 v1</span><br><span class="line">-&gt; Redirected to slot [12706] located at 1.117.72.9:6383</span><br><span class="line">OK</span><br><span class="line">1.117.72.9:6383&gt; </span><br><span class="line"></span><br><span class="line"><span class="comment">#Redirected to slot [12706] located at 1.117.72.9:6383  这里k1分配的槽位为12706，但是他会配重定向到合适的节点</span></span><br><span class="line"><span class="comment">#同时还给我跳到了这个节点上</span></span><br></pre></td></tr></table></figure><ul><li>查看集群信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入一个节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-node-1 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看信息</span></span><br><span class="line">redis-cli --cluster check 1.117.72.9:6382</span><br><span class="line"></span><br><span class="line">root@VM-4-14-centos:/data<span class="comment"># redis-cli --cluster check 1.117.72.9:6382</span></span><br><span class="line">1.117.72.9:6382 (544721f6...) -&gt; 0 keys | 5462 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6383 (893773f4...) -&gt; 1 keys | 5461 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6381 (ea6144e4...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line">[OK] 1 keys <span class="keyword">in</span> 3 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 1.117.72.9:6382)</span><br><span class="line">M: 544721f66ef390e6536bd7314e0f367b776fa369 1.117.72.9:6382</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 821e7809ebd937c7abfc25460ddeba1e22587ac2 1.117.72.9:6385</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates ea6144e47cd29369eceaf3406cc51b85daa672a4</span><br><span class="line">S: 0ac5588e0826bfe7242e193150404412360c5197 1.117.72.9:6386</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 544721f66ef390e6536bd7314e0f367b776fa369</span><br><span class="line">M: 893773f4b7f1e15f0477056c4895aad7d6076ca4 1.117.72.9:6383</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 60a5f33a6ae6c4dc892613e0243b3bb371b6fc70 1.117.72.9:6384</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 893773f4b7f1e15f0477056c4895aad7d6076ca4</span><br><span class="line">M: ea6144e47cd29369eceaf3406cc51b85daa672a4 1.117.72.9:6381</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure><h4 id="主从容错切换分析与实现"><a href="#主从容错切换分析与实现" class="headerlink" title="主从容错切换分析与实现"></a>主从容错切换分析与实现</h4><ul><li>当前的三主三从</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1       5</span><br><span class="line"></span><br><span class="line">2       6</span><br><span class="line"></span><br><span class="line">3       4</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>停止节点1</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1[X]    5</span><br><span class="line"></span><br><span class="line">2       6</span><br><span class="line"></span><br><span class="line">3       4</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>过一分钟左右，进入节点2查看集群节点，可以看到1对应的5直接成为了master</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker stop redis-node-1</span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-node-2 /bin/bash</span><br><span class="line"></span><br><span class="line">redis-cli -p 6382 -c</span><br><span class="line"></span><br><span class="line">127.0.0.1:6382&gt; cluster nodes</span><br><span class="line">544721f66ef390e6536bd7314e0f367b776fa369 10.0.4.14:6382@16382 myself,master - 0 1665762114000 2 connected 5461-10922</span><br><span class="line">821e7809ebd937c7abfc25460ddeba1e22587ac2 1.117.72.9:6385@16385 master - 0 1665762115241 7 connected 0-5460</span><br><span class="line">0ac5588e0826bfe7242e193150404412360c5197 1.117.72.9:6386@16386 slave 544721f66ef390e6536bd7314e0f367b776fa369 0 1665762112000 2 connected</span><br><span class="line">893773f4b7f1e15f0477056c4895aad7d6076ca4 1.117.72.9:6383@16383 master - 0 1665762114000 3 connected 10923-16383</span><br><span class="line">60a5f33a6ae6c4dc892613e0243b3bb371b6fc70 1.117.72.9:6384@16384 slave 893773f4b7f1e15f0477056c4895aad7d6076ca4 0 1665762114240 3 connected</span><br><span class="line">ea6144e47cd29369eceaf3406cc51b85daa672a4 1.117.72.9:6381@16381 master,fail - 1665761820440 1665761816433 1 disconnected</span><br></pre></td></tr></table></figure><ul><li>重新启动节点1，可以看到节点5任然是master，节点1变成了slave</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5       1</span><br><span class="line"></span><br><span class="line">2       6</span><br><span class="line"></span><br><span class="line">3       4</span><br></pre></td></tr></table></figure><ul><li>如果你还行让节点1为主机，节点5成从机，那么就先停掉，节点5，在启动节点5….</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker start redis-node-1</span><br><span class="line"></span><br><span class="line">127.0.0.1:6382&gt; cluster nodes</span><br><span class="line">544721f66ef390e6536bd7314e0f367b776fa369 10.0.4.14:6382@16382 myself,master - 0 1665762514000 2 connected 5461-10922</span><br><span class="line">821e7809ebd937c7abfc25460ddeba1e22587ac2 1.117.72.9:6385@16385 master - 0 1665762517279 7 connected 0-5460</span><br><span class="line">0ac5588e0826bfe7242e193150404412360c5197 1.117.72.9:6386@16386 slave 544721f66ef390e6536bd7314e0f367b776fa369 0 1665762516000 2 connected</span><br><span class="line">893773f4b7f1e15f0477056c4895aad7d6076ca4 1.117.72.9:6383@16383 master - 0 1665762516000 3 connected 10923-16383</span><br><span class="line">60a5f33a6ae6c4dc892613e0243b3bb371b6fc70 1.117.72.9:6384@16384 slave 893773f4b7f1e15f0477056c4895aad7d6076ca4 0 1665762515000 3 connected</span><br><span class="line">ea6144e47cd29369eceaf3406cc51b85daa672a4 1.117.72.9:6381@16381 slave 821e7809ebd937c7abfc25460ddeba1e22587ac2 0 1665762516278 7 connected</span><br></pre></td></tr></table></figure><h4 id="redis集群扩容"><a href="#redis集群扩容" class="headerlink" title="redis集群扩容"></a>redis集群扩容</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5       1</span><br><span class="line"></span><br><span class="line">2       6</span><br><span class="line"></span><br><span class="line">3       4</span><br></pre></td></tr></table></figure><p>我这里使用的是其他的服务器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先增加两个节点</span></span><br><span class="line">docker run -d --name=redis-node-7 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode7:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6387</span><br><span class="line">docker run -d --name=redis-node-8 --net=host --privileged=<span class="literal">true</span> -v /usr/redis/redisnode8:/data redis:6.0.8 --cluster-enabled <span class="built_in">yes</span> --appendonly <span class="built_in">yes</span> --port 6388</span><br><span class="line"><span class="comment">#进入节点7</span></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-node-7 /bin/bash</span><br><span class="line"><span class="comment">#将新增的6387作为master节点加入集群</span></span><br><span class="line"><span class="comment">#6387就是将要作为master新增节点</span></span><br><span class="line"><span class="comment">#1.117.72.9:6385就是原来集群节点里面的领路人，相当于47.92.80.135:6387拜拜1.117.72.9:6385的码头从而找到组织加入集群</span></span><br><span class="line">redis-cli --cluster add-node 47.92.80.135:6387 1.117.72.9:6385</span><br><span class="line"></span><br><span class="line"><span class="comment">#在节点1中查看集群状态，并且重新分配槽号（其实随便在哪个节点中，只不是通过某个机器执行集群命令，随意）</span></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-node-1 /bin/bas</span><br><span class="line"></span><br><span class="line">redis-cli --cluster check 127.0.0.1:6381</span><br><span class="line"><span class="comment">#可以发现节点7虽然是master但是没有分配槽位</span></span><br><span class="line"></span><br><span class="line">47.92.80.135:6387 (27313d8b...) -&gt; 0 keys | 0 slots | 0 slaves.</span><br><span class="line">1.117.72.9:6383 (893773f4...) -&gt; 1 keys | 5461 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6382 (544721f6...) -&gt; 0 keys | 5462 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6385 (821e7809...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line">[OK] 1 keys <span class="keyword">in</span> 4 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:6381)</span><br><span class="line">S: ea6144e47cd29369eceaf3406cc51b85daa672a4 127.0.0.1:6381</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 821e7809ebd937c7abfc25460ddeba1e22587ac2</span><br><span class="line">M: 27313d8b85918737d08e068ef0c1eecf7d82211b 47.92.80.135:6387</span><br><span class="line">   slots: (0 slots) master</span><br><span class="line">M: 893773f4b7f1e15f0477056c4895aad7d6076ca4 1.117.72.9:6383</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 60a5f33a6ae6c4dc892613e0243b3bb371b6fc70 1.117.72.9:6384</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 893773f4b7f1e15f0477056c4895aad7d6076ca4</span><br><span class="line">S: 0ac5588e0826bfe7242e193150404412360c5197 1.117.72.9:6386</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 544721f66ef390e6536bd7314e0f367b776fa369</span><br><span class="line">M: 544721f66ef390e6536bd7314e0f367b776fa369 1.117.72.9:6382</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 821e7809ebd937c7abfc25460ddeba1e22587ac2 1.117.72.9:6385</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#在节点7中重新分配槽位（其实随便在哪个节点中，只不是通过某个机器执行集群命令，随意）</span></span><br><span class="line">redis-cli --cluster reshard 1.117.72.9:6385</span><br><span class="line"></span><br><span class="line"><span class="comment">#你想要移动多少槽位</span></span><br><span class="line"><span class="comment">#我这里分配的是4096 = 16383 / master数量</span></span><br><span class="line">How many slots <span class="keyword">do</span> you want to move (from 1 to 16384)? 4096</span><br><span class="line"></span><br><span class="line"><span class="comment">#需要移动到那一个节点上面（ID）</span></span><br><span class="line">what is the receiving node ID? 27313d8b85918737d08e068ef0c1eecf7d8221</span><br><span class="line"></span><br><span class="line"><span class="comment">#all 为自动分配，第二种方式为手动分配。</span></span><br><span class="line">Please enter all the <span class="built_in">source</span> node IDs.</span><br><span class="line">Type <span class="string">&#x27;all&#x27;</span> to use all the nodes as <span class="built_in">source</span> nodes <span class="keyword">for</span> the <span class="built_in">hash</span> slots.</span><br><span class="line">Type <span class="string">&#x27;done&#x27;</span> once you entered all the <span class="built_in">source</span> nodes IDs.</span><br><span class="line"></span><br><span class="line"><span class="comment">#我这里选择all</span></span><br><span class="line">Source node <span class="comment">#1: all</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#中途会输入yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#完了过后重新查看分配的结果</span></span><br><span class="line"></span><br><span class="line">root@tabby-aliyun:/data<span class="comment"># redis-cli --cluster check 127.0.0.1:6387</span></span><br><span class="line">127.0.0.1:6387 (27313d8b...) -&gt; 0 keys | 4096 slots | 0 slaves.</span><br><span class="line">1.117.72.9:6382 (544721f6...) -&gt; 0 keys | 4096 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6385 (821e7809...) -&gt; 0 keys | 4096 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6383 (893773f4...) -&gt; 1 keys | 4096 slots | 1 slaves.</span><br><span class="line">[OK] 1 keys <span class="keyword">in</span> 4 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:6387)</span><br><span class="line">M: 27313d8b85918737d08e068ef0c1eecf7d82211b 127.0.0.1:6387</span><br><span class="line">   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master</span><br><span class="line">S: ea6144e47cd29369eceaf3406cc51b85daa672a4 1.117.72.9:6381</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 821e7809ebd937c7abfc25460ddeba1e22587ac2</span><br><span class="line">M: 544721f66ef390e6536bd7314e0f367b776fa369 1.117.72.9:6382</span><br><span class="line">   slots:[6827-10922] (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 821e7809ebd937c7abfc25460ddeba1e22587ac2 1.117.72.9:6385</span><br><span class="line">   slots:[1365-5460] (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 60a5f33a6ae6c4dc892613e0243b3bb371b6fc70 1.117.72.9:6384</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 893773f4b7f1e15f0477056c4895aad7d6076ca4</span><br><span class="line">S: 0ac5588e0826bfe7242e193150404412360c5197 1.117.72.9:6386</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 544721f66ef390e6536bd7314e0f367b776fa369</span><br><span class="line">M: 893773f4b7f1e15f0477056c4895aad7d6076ca4 1.117.72.9:6383</span><br><span class="line">   slots:[12288-16383] (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"></span><br><span class="line"><span class="comment">#对边前后的变化，可以看出他的节点并不是重新分配，而是从每个节点上抽出一点点给新节点</span></span><br><span class="line">47.92.80.135:6387 (27313d8b...) -&gt; 0 keys | 0 slots | 0 slaves.</span><br><span class="line">1.117.72.9:6383 (893773f4...) -&gt; 1 keys | 5461 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6382 (544721f6...) -&gt; 0 keys | 5462 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6385 (821e7809...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line"></span><br><span class="line">127.0.0.1:6387 (27313d8b...) -&gt; 0 keys | 4096 slots | 0 slaves.</span><br><span class="line">1.117.72.9:6382 (544721f6...) -&gt; 0 keys | 4096 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6385 (821e7809...) -&gt; 0 keys | 4096 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6383 (893773f4...) -&gt; 1 keys | 4096 slots | 1 slaves.</span><br><span class="line"></span><br><span class="line">M: 27313d8b85918737d08e068ef0c1eecf7d82211b 47.92.80.135:6387</span><br><span class="line">   slots: (0 slots) master</span><br><span class="line"></span><br><span class="line">M: 27313d8b85918737d08e068ef0c1eecf7d82211b 127.0.0.1:6387</span><br><span class="line">   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master</span><br><span class="line"></span><br><span class="line"><span class="comment">#给节点7挂载从机47.92.80.135:6388</span></span><br><span class="line">redis-cli --cluster add-node 47.92.80.135:6388 47.92.80.135:6387 --cluster-slave --cluster-master-id 27313d8b85918737d08e068ef0c1eecf7d82211b</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="redis集群缩容"><a href="#redis集群缩容" class="headerlink" title="redis集群缩容"></a>redis集群缩容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">7       8</span><br><span class="line"></span><br><span class="line">5       1</span><br><span class="line"></span><br><span class="line">2       6</span><br><span class="line"></span><br><span class="line">3       4</span><br><span class="line"></span><br><span class="line">将6388，6387从集群删除</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入节点5</span></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-node-5 /bin./bash</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看集群状态</span></span><br><span class="line">redis-cli --cluster check 127.0.0.1:6387</span><br><span class="line"></span><br><span class="line"><span class="comment">#拿到节点7和8</span></span><br><span class="line">S: b4ca84a31f5fc5129f6e201e8db85dad2d256b21 47.92.80.135:6388</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 27313d8b85918737d08e068ef0c1eecf7d82211b</span><br><span class="line">M: 27313d8b85918737d08e068ef0c1eecf7d82211b 47.92.80.135:6387</span><br><span class="line">   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">   </span><br><span class="line"><span class="comment">#删除从节点8</span></span><br><span class="line">redis-cli --cluster del-node 47.92.80.135:6388 b4ca84a31f5fc5129f6e201e8db85dad2d256b21</span><br><span class="line">&gt;&gt;&gt; Removing node b4ca84a31f5fc5129f6e201e8db85dad2d256b21 from cluster 47.92.80.135:6388</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.</span><br><span class="line"></span><br><span class="line"><span class="comment">#检查一下是否已经删除</span></span><br><span class="line"><span class="comment">#清空6387的槽号，重新分配给6385（只不是通过6385机器执行集群命令，随意）</span></span><br><span class="line"><span class="comment">#通过6385执行命令</span></span><br><span class="line">redis-cli --cluster reshard 1.117.72.9:6385</span><br><span class="line"></span><br><span class="line"><span class="comment">#把6387上的4096个槽位移除</span></span><br><span class="line">How many slots <span class="keyword">do</span> you want to move (from 1 to 16384)? 4096</span><br><span class="line"></span><br><span class="line"><span class="comment">#6387的id</span></span><br><span class="line">What is the receiving node ID? 821e7809ebd937c7abfc25460ddeba1e22587ac2</span><br><span class="line">Please enter all the <span class="built_in">source</span> node IDs.</span><br><span class="line">  Type <span class="string">&#x27;all&#x27;</span> to use all the nodes as <span class="built_in">source</span> nodes <span class="keyword">for</span> the <span class="built_in">hash</span> slots.</span><br><span class="line">  Type <span class="string">&#x27;done&#x27;</span> once you entered all the <span class="built_in">source</span> nodes IDs.</span><br><span class="line">  </span><br><span class="line"><span class="comment">#移动到6385上，这里是6385的id</span></span><br><span class="line">Source node <span class="comment">#1: 27313d8b85918737d08e068ef0c1eecf7d82211b</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#输入done</span></span><br><span class="line">Source node <span class="comment">#2: done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#输入yes</span></span><br><span class="line"><span class="comment">#检查集群的状态</span></span><br><span class="line"></span><br><span class="line">root@VM-4-14-centos:/data<span class="comment"># redis-cli --cluster check 1.117.72.9:6385</span></span><br><span class="line">1.117.72.9:6385 (821e7809...) -&gt; 0 keys | 8192 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6383 (893773f4...) -&gt; 1 keys | 4096 slots | 1 slaves.</span><br><span class="line">1.117.72.9:6382 (544721f6...) -&gt; 0 keys | 4096 slots | 1 slaves.</span><br><span class="line">47.92.80.135:6387 (27313d8b...) -&gt; 0 keys | 0 slots | 0 slaves.</span><br><span class="line"></span><br><span class="line"><span class="comment">#4096个槽位都指给6381，它变成了8192个槽位，相当于全部都给6381了，不然要输入3次，一锅端</span></span><br><span class="line"><span class="comment">#如果你需要平均分配给剩下的主机，那么要重新分配三次</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#删除6387</span></span><br><span class="line">redis-cli --cluster del-node 47.92.80.135:6387 27313d8b85918737d08e068ef0c1eecf7d82211b</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Removing node 27313d8b85918737d08e068ef0c1eecf7d82211b from cluster 47.92.80.135:6387</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker及相关的安装</title>
      <link href="/2022/06/10/20220610docker%E7%9A%84%E5%AE%89%E8%A3%85/"/>
      <url>/2022/06/10/20220610docker%E7%9A%84%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<p>centos 7.9</p><p>docker-compose根据自己情况安装</p><p>yum选择自己合适的</p><h3 id="官网推荐安装"><a href="#官网推荐安装" class="headerlink" title="官网推荐安装"></a>官网推荐安装</h3><hr><ul><li>卸载旧版本<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">      docker-client \</span><br><span class="line">      docker-client-latest \</span><br><span class="line">      docker-common \</span><br><span class="line">      docker-latest \</span><br><span class="line">      docker-latest-logrotate \</span><br><span class="line">      docker-logrotate \</span><br><span class="line">      docker-engine</span><br><span class="line"><span class="comment">#卸载 Docker Engine、CLI、Containerd 和 Docker Compose 软件包：</span></span><br><span class="line">yum remove docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br><span class="line"><span class="comment">#主机上的映像、容器、卷或自定义配置文件不会自动删除。要删除所有映像、容器和卷：</span></span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/docker</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/containerd</span><br></pre></td></tr></table></figure></li></ul><h3 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h3><hr><ul><li>设置存储库。安装yum-utils包（提供yum-config-manager 实用程序）并设置存储库。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置源</span></span><br><span class="line"><span class="comment">#可以使用阿里源，最好选这个</span></span><br><span class="line">yum-config-manager --add-repo=http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment">#官方</span></span><br><span class="line">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">yum makecache <span class="comment">#重新构建缓存</span></span><br><span class="line"></span><br><span class="line">yum repolist &#123;all|enabled|disabled&#125;             <span class="comment">#列出所有/已启用/已禁用的yum源</span></span><br><span class="line">yum --disablerepo=repo                          <span class="comment">#临时禁用某个repo源</span></span><br><span class="line">yum --enablerepo=repo                          <span class="comment">#解除禁用某个repo源</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>安装 Docker 引擎。安装最新版本的 Docker Engine、containerd 和 Docker Compose </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure><ul><li>要安装特定版本的 Docker Engine，请在 repo 中列出可用版本，然后选择并安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | <span class="built_in">sort</span> -r</span><br><span class="line"></span><br><span class="line">docker-ce.x86_64            3:20.10.19-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:20.10.18-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:20.10.17-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:20.10.16-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:20.10.15-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:20.10.14-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:20.10.1-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:20.10.13-3.el7                    docker-ce-stable</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>安装。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认安装</span></span><br><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br><span class="line"><span class="comment">#可以选择版本</span></span><br><span class="line">sudo yum install docker-ce-20.10.14 docker-ce-cli-20.10.14 containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure><ul><li>结束</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start docker       <span class="comment">#启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker      <span class="comment">#开机启动</span></span><br><span class="line">docker version                    <span class="comment">#查看版本</span></span><br><span class="line">docker run hello-world            <span class="comment">#示例进项</span></span><br></pre></td></tr></table></figure><blockquote><p>出现报错</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;Transaction check error:</span><br><span class="line"> file /usr/libexec/docker/cli-plugins/docker-buildx from install of docker-ce-cli-1:20.10.14-3.el7.x86_64 conflicts with file from package docker-buildx-plugin-0:0.10.2-1.el7.x86_64</span><br><span class="line">Error Summary</span><br></pre></td></tr></table></figure><p>用 yum list installed | grep docker 查看，<br>然后删除相关的 rpm -e docker-buildx-plugin.x86_64 , rpm -e *** , rpm -e *** </p></blockquote><h3 id="官网脚本安装"><a href="#官网脚本安装" class="headerlink" title="官网脚本安装"></a>官网脚本安装</h3><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com -o get-docker.sh</span><br><span class="line"></span><br><span class="line">sudo sh get-docker.sh</span><br><span class="line">或者</span><br><span class="line">sudo DRY_RUN=1 sh ./get-docker.sh</span><br></pre></td></tr></table></figure><blockquote><p>官网主站 <a href="https://docs.docker.com/">https://docs.docker.com/</a><br>历史版本 <a href="https://download.docker.com/linux/static/stable/x86_64/">https://download.docker.com/linux/static/stable/x86_64/</a><br>镜像 <a href="https://hub.docker.com/search?q=">https://hub.docker.com/search?q=</a><br>官网安装 <a href="https://docs.docker.com/engine/install/centos/">https://docs.docker.com/engine/install/centos/</a></p></blockquote><h3 id="docker-compose安装"><a href="#docker-compose安装" class="headerlink" title="docker-compose安装"></a>docker-compose安装</h3><h4 id="官方安装"><a href="#官方安装" class="headerlink" title="官方安装"></a>官方安装</h4><ul><li><p>官网选择版本 <a href="https://github.com/docker/compose/releases">https://github.com/docker/compose/releases</a> </p></li><li><p>以下命令手动修改版本号,例如1.24.1</p><blockquote><p>curl -L <a href="https://github.com/docker/compose/releases/download/1.24.1/docker-compose-%60uname">https://github.com/docker/compose/releases/download/1.24.1/docker-compose-`uname</a> -s<code>-</code>uname -m` -o /usr/local/bin/docker-compose</p></blockquote></li><li><p>添加执行权限chmod +x /usr/local/bin/docker-compose</p></li><li><p>检查docker compose版本docker-compose version</p></li></ul><h4 id="手动安装"><a href="#手动安装" class="headerlink" title="手动安装"></a>手动安装</h4><ul><li><p>官网选择版本 <a href="https://github.com/docker/compose/releases">https://github.com/docker/compose/releases</a> </p></li><li><p>选择相应版本,下载docker-compose-Linux-x86_64到本地或者服务器中</p></li><li><p>更名为docker-compose,并移动到 /usr/local/bin 目录下 </p></li><li><p>添加执行权限chmod +x /usr/local/bin/docker-compose</p></li><li><p>检查docker compose版本docker-compose version</p></li></ul><h3 id="安装gcc"><a href="#安装gcc" class="headerlink" title="安装gcc"></a>安装gcc</h3><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc</span><br><span class="line">yum -y install gcc c++</span><br></pre></td></tr></table></figure><h3 id="镜像加速"><a href="#镜像加速" class="headerlink" title="镜像加速"></a>镜像加速</h3><hr><ul><li>创建 /etc/docker</li><li>加入地址</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;https://mirror.ccs.tencentyun.com&quot;</span></span><br><span class="line">     ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IM项目中electron对文件加密的方案设计与落地</title>
      <link href="/2022/05/08/20220508IM%E9%A1%B9%E7%9B%AE%E4%B8%ADelectron%E5%AF%B9%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E7%9A%84%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E4%B8%8E%E8%90%BD%E5%9C%B0/"/>
      <url>/2022/05/08/20220508IM%E9%A1%B9%E7%9B%AE%E4%B8%ADelectron%E5%AF%B9%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E7%9A%84%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E4%B8%8E%E8%90%BD%E5%9C%B0/</url>
      
        <content type="html"><![CDATA[<p>文本加密很好实现，但是文件加密就稍微麻烦点。</p><p>但是我的预期加密的规则需要兼容老版本能够分辨出老版本未加密的文件，因为我们用户还可能查看老版本的聊天记录。能够分别不同版本规则的加密文件。文件不能全加密，效率要高。加密过后的文件大小，不能太大，要节约oss资源控制成本，这里我改成了一个参，可以手动设置加密后的文件新增的大小。视情况而定。</p><p>最终的加密路线如下：</p><p><img src="%22assets/img/202202041.png%22"></p><p>核心代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TBFileRules</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> checkHeadSign=[<span class="string">&quot;abcdabcdabcdabc&quot;</span>,<span class="string">&quot;abcdabcdabcdabcd&quot;</span>]                     <span class="comment">///解密时使用。是否符合解密文件。</span></span><br><span class="line">    <span class="keyword">static</span> headSign=&#123;<span class="attr">sign</span>:<span class="string">&quot;abcdabcdabcdabcd&quot;</span>,<span class="attr">headLen</span>:<span class="number">1024</span>/<span class="number">2</span>&#125;                        <span class="comment">///加密时使用。标记为加密文件。对象编译过后的字节长度不能超过50</span></span><br><span class="line">    <span class="keyword">static</span> appKey=<span class="string">&quot;tabby&quot;</span>                                                           <span class="comment">///appkey</span></span><br><span class="line">    <span class="keyword">static</span> encDataLen=<span class="number">1024</span>*<span class="number">10</span>;                                                      <span class="comment">///加密的长度，文件小于这个长度全加密 默认只加密10kb</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; -sgin:app签名</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -headLen:文件头的总长度</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileLen:文件的原长</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileEncLen:文件加密后总体的长度（不含头）</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileDataLen:加密段加密前的长度</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileDataEncLen:加密段加密后的长度</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; -fileEncStart:加密后加密段开始的位置（不含头）</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; -ext:预留拓展字段</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">generateHeaderByte</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> &#123;fileLen,fileEncLen,fileDataLen,fileDataEncLen,fileEncStart,ext&#125;=opt;</span><br><span class="line">        <span class="keyword">let</span> header=&#123;&#125;</span><br><span class="line">        header.<span class="property">sgin</span>=<span class="title class_">TBFileRules</span>.<span class="property">appKey</span>;                     <span class="comment">///32 位app签名</span></span><br><span class="line">        header.<span class="property">headLenSign</span>=<span class="number">50</span>;                              <span class="comment">///加密标识的长度</span></span><br><span class="line">        header.<span class="property">headLen</span>=<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>.<span class="property">headLen</span>;        <span class="comment">///文件头的总长度</span></span><br><span class="line">        header.<span class="property">fileLen</span>=fileLen;                             <span class="comment">///文件的原长</span></span><br><span class="line">        header.<span class="property">fileEncLen</span>=fileEncLen;                       <span class="comment">///文件加密后总体的长度（不含头）</span></span><br><span class="line">        header.<span class="property">fileDataLen</span>=fileDataLen;                     <span class="comment">///加密段加密前的长度</span></span><br><span class="line">        header.<span class="property">fileDataEncLen</span>=fileDataEncLen;               <span class="comment">///加密段加密后的长度</span></span><br><span class="line">        header.<span class="property">fileEncStart</span>=fileEncStart;                   <span class="comment">///加密后加密段开始的位置（不含头）</span></span><br><span class="line">        header.<span class="property">ext</span>=ext;                                     <span class="comment">///预留拓展字段</span></span><br><span class="line">        <span class="comment">// console.log(header)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">TBFileRules</span>.<span class="title function_">strToByte</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(header))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        检查是否为加密文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Uint8Array</span>&#125; -source:源文件</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">checkIsEncFile</span>(<span class="params">source</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> headSign=<span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">TBFileRules</span>.<span class="title function_">byteToStr</span>(<span class="title class_">TBFileRules</span>.<span class="title function_">unshif0</span>(source.<span class="title function_">slice</span>(<span class="number">0</span>,<span class="number">50</span>))))</span><br><span class="line">            <span class="keyword">if</span>(<span class="title class_">TBFileRules</span>.<span class="property">checkHeadSign</span>.<span class="title function_">indexOf</span>(headSign.<span class="property">sign</span>)&gt;-<span class="number">1</span>)<span class="keyword">return</span> headSign</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        加密文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">CryptoJSTB</span>&#125; -cjstb:CryptoJSTB 实例</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Uint8Array</span>&#125; -source:源文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125;     -ext:拓展</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">encData</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> &#123;cjstb,source,ext&#125;=opt</span><br><span class="line"></span><br><span class="line">            source=<span class="title class_">Array</span>.<span class="title function_">from</span>(source)</span><br><span class="line">            <span class="keyword">if</span>(!ext)ext=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> encDataU8=[],                               <span class="comment">//加密前的加密段</span></span><br><span class="line">                fileEnd=<span class="title class_">TBFileRules</span>.<span class="property">encDataLen</span>,             <span class="comment">//加密结束的位置</span></span><br><span class="line">                encDataSourceU8=[],                         <span class="comment">//加密后的加密段</span></span><br><span class="line">                sourceOtherData=[],                         <span class="comment">//未加密的部分</span></span><br><span class="line">                sourceEecData=[];                           <span class="comment">//未加密的部分</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(fileEnd&gt;source.<span class="property">length</span>)fileEnd=source.<span class="property">length</span></span><br><span class="line">            <span class="keyword">else</span> sourceOtherData=source.<span class="title function_">slice</span>(fileEnd)</span><br><span class="line"></span><br><span class="line">            encDataU8=source.<span class="title function_">slice</span>(<span class="number">0</span>,fileEnd)</span><br><span class="line">            encDataSourceU8=cjstb.<span class="title function_">encByteAES</span>(encDataU8)</span><br><span class="line">            sourceEecData=[...encDataSourceU8,...sourceOtherData]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> headerParams = <span class="title class_">TBFileRules</span>.<span class="title function_">generateHeaderByte</span>(&#123;</span><br><span class="line">                <span class="attr">fileLen</span>:source.<span class="property">length</span>,</span><br><span class="line">                <span class="attr">fileEncLen</span>:sourceEecData.<span class="property">length</span>,</span><br><span class="line">                <span class="attr">fileDataLen</span>:encDataU8.<span class="property">length</span>,</span><br><span class="line">                <span class="attr">fileDataEncLen</span>:encDataSourceU8.<span class="property">length</span>,</span><br><span class="line">                ext</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">var</span> headerSign = <span class="title class_">TBFileRules</span>.<span class="title function_">strToByte</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(headerSign.<span class="property">length</span>&lt;=<span class="number">50</span>)&#123;</span><br><span class="line">                <span class="keyword">let</span> ent=[]</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">50</span>-headerSign.<span class="property">length</span>;i++)&#123;ent.<span class="title function_">push</span>(<span class="number">0</span>)&#125;</span><br><span class="line">                headerSign=[...headerSign,...ent]</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_">reject</span>(&#123;<span class="attr">code</span>:<span class="number">0</span>,<span class="attr">msg</span>:<span class="string">&quot;headerSign.length  too long 50&quot;</span>&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> head=[...headerSign,...headerParams]</span><br><span class="line">           </span><br><span class="line">            <span class="keyword">if</span>(head.<span class="property">length</span>&lt;<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>.<span class="property">headLen</span>)&#123;</span><br><span class="line">                <span class="keyword">let</span> ent=[]</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="title class_">TBFileRules</span>.<span class="property">headSign</span>.<span class="property">headLen</span>-head.<span class="property">length</span>;i++)&#123;ent.<span class="title function_">push</span>(<span class="number">0</span>)&#125;</span><br><span class="line">                head=[...head,...ent]</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_">reject</span>(&#123;<span class="attr">code</span>:<span class="number">0</span>,<span class="attr">msg</span>:<span class="string">&quot;File head too long&quot;</span>&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_">resolve</span>(&#123;<span class="attr">code</span>:<span class="number">1</span>,<span class="attr">data</span>:<span class="keyword">new</span> <span class="title class_">Uint8Array</span>([...head,...sourceEecData])&#125;)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        解密密文件</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">CryptoJSTB</span>&#125; -cjstb:CryptoJSTB 实例</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">Uint8Array</span>&#125; -source:源文件</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">decData</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> &#123;source,cjstb&#125;=opt</span><br><span class="line">            source=<span class="title class_">Array</span>.<span class="title function_">from</span>(source)</span><br><span class="line">            <span class="keyword">var</span> headSign=<span class="title class_">TBFileRules</span>.<span class="title function_">checkIsEncFile</span>(source)</span><br><span class="line">            <span class="keyword">if</span>(!headSign)&#123;</span><br><span class="line">                <span class="title function_">reject</span>(&#123;<span class="attr">code</span>:<span class="number">0</span>,<span class="attr">msg</span>:<span class="string">&quot;Failed to parse file&quot;</span>&#125;)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> headParamsByte = source.<span class="title function_">slice</span>(<span class="number">50</span>,headSign.<span class="property">headLen</span>)</span><br><span class="line">            <span class="keyword">var</span> headParamsByteUnfit0 = <span class="title class_">TBFileRules</span>.<span class="title function_">unshif0</span>(headParamsByte)</span><br><span class="line">            <span class="keyword">var</span> headParams = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">TBFileRules</span>.<span class="title function_">byteToStr</span>(headParamsByteUnfit0))</span><br><span class="line">            <span class="keyword">var</span> encData=source.<span class="title function_">slice</span>(headSign.<span class="property">headLen</span>,headSign.<span class="property">headLen</span> + headParams.<span class="property">fileDataEncLen</span>)</span><br><span class="line">            <span class="keyword">var</span> otherData=source.<span class="title function_">slice</span>(headSign.<span class="property">headLen</span> + headParams.<span class="property">fileDataEncLen</span>)</span><br><span class="line">            <span class="keyword">var</span> decData=cjstb.<span class="title function_">decByteAES</span>(encData)</span><br><span class="line">            <span class="title function_">resolve</span>(&#123;</span><br><span class="line">                <span class="attr">code</span>:<span class="number">1</span>,</span><br><span class="line">                <span class="attr">params</span>:headParams,</span><br><span class="line">                <span class="attr">data</span>:<span class="keyword">new</span> <span class="title class_">Uint8Array</span>([...decData,...otherData])</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        文件转u8</span></span><br><span class="line"><span class="comment">        <span class="doctag">@param</span> &#123;<span class="type">file</span>&#125;</span></span><br><span class="line"><span class="comment">        <span class="doctag">@return</span> &#123;<span class="type">Promise&lt;Uint8Array&gt;</span>&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">fileToUint8</span>(<span class="params">file</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span><br><span class="line">            reader.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;<span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(e.<span class="property">target</span>.<span class="property">result</span>))&#125;</span><br><span class="line">            reader.<span class="title function_">readAsArrayBuffer</span>(file);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">saveFile</span>(<span class="params">uint8List,fileName</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> blob=<span class="keyword">new</span> <span class="title class_">Blob</span>([uint8List]);</span><br><span class="line">        <span class="keyword">const</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">        link.<span class="property">href</span> = <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span><br><span class="line">        link.<span class="property">download</span> = fileName;</span><br><span class="line">        link.<span class="title function_">click</span>();</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">revokeObjectURL</span>(link.<span class="property">href</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">///去除字节最后的0</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">unshif0</span>(<span class="params">list</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> data=[...list]</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;list.<span class="property">length</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(data[data.<span class="property">length</span>-<span class="number">1</span>])<span class="keyword">return</span> data</span><br><span class="line">            <span class="keyword">else</span> data.<span class="title function_">pop</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">strToByte</span>(<span class="params">str</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line">        <span class="keyword">var</span> len, c;</span><br><span class="line">        len = str.<span class="property">length</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            c = str.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">            <span class="keyword">if</span> (c &gt;= <span class="number">0x010000</span> &amp;&amp; c &lt;= <span class="number">0x10FFFF</span>) &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">18</span>) &amp; <span class="number">0x07</span>) | <span class="number">0xF0</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>((c &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &gt;= <span class="number">0x000800</span> &amp;&amp; c &lt;= <span class="number">0x00FFFF</span>) &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x0F</span>) | <span class="number">0xE0</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>((c &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &gt;= <span class="number">0x000080</span> &amp;&amp; c &lt;= <span class="number">0x0007FF</span>) &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(((c &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x1F</span>) | <span class="number">0xC0</span>);</span><br><span class="line">                bytes.<span class="title function_">push</span>((c &amp; <span class="number">0x3F</span>) | <span class="number">0x80</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bytes.<span class="title function_">push</span>(c &amp; <span class="number">0xFF</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">byteToStr</span>(<span class="params">utf8Bytes</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> unicodeStr =<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> pos = <span class="number">0</span>; pos &lt; utf8Bytes.<span class="property">length</span>;)&#123;</span><br><span class="line">            <span class="keyword">var</span> flag= utf8Bytes[pos];</span><br><span class="line">            <span class="keyword">var</span> unicode = <span class="number">0</span> ;</span><br><span class="line">            <span class="keyword">if</span> ((flag &gt;&gt;&gt;<span class="number">7</span>) === <span class="number">0</span> ) &#123;</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(utf8Bytes[pos]);</span><br><span class="line">                pos += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xFC</span>) === <span class="number">0xFC</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x3</span>) &lt;&lt; <span class="number">30</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">24</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">18</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">3</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">12</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">4</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">5</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xF8</span>) === <span class="number">0xF8</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x7</span>) &lt;&lt; <span class="number">24</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">18</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">12</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">3</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">4</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xF0</span>) === <span class="number">0xF0</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0xF</span>) &lt;&lt; <span class="number">18</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">12</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">3</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xE0</span>) === <span class="number">0xE0</span> )&#123;</span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x1F</span>) &lt;&lt; <span class="number">12</span>;;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">2</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flag &amp;<span class="number">0xC0</span>) === <span class="number">0xC0</span> )&#123; <span class="comment">//110</span></span><br><span class="line">                unicode = (utf8Bytes[pos] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                unicode |= (utf8Bytes[pos+<span class="number">1</span>] &amp; <span class="number">0x3F</span>);</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(unicode) ;</span><br><span class="line">                pos += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                unicodeStr+= <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(utf8Bytes[pos]);</span><br><span class="line">                pos += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> unicodeStr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试demo <a href="https://github.com/TabbyCute/web_libs/tree/main/demos/crypto-js-bigfile">https://github.com/TabbyCute/web_libs/tree/main/demos/crypto-js-bigfile</a></p><p>项目使用 <a href="https://github.com/TabbyCute/web_libs/tree/main/libs/crypto-js-bigfile">https://github.com/TabbyCute/web_libs/tree/main/libs/crypto-js-bigfile</a></p>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
            <tag> cryptojs </tag>
            
            <tag> im </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>查看yum软件的安装目录</title>
      <link href="/2022/05/01/20220601%E6%9F%A5%E7%9C%8Byum%E5%AE%89%E8%A3%85%E7%9A%84%E8%BD%AF%E4%BB%B6%E4%BD%8D%E7%BD%AE/"/>
      <url>/2022/05/01/20220601%E6%9F%A5%E7%9C%8Byum%E5%AE%89%E8%A3%85%E7%9A%84%E8%BD%AF%E4%BB%B6%E4%BD%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>今天使用yum 安装了一个软件，后来没有找到路径</p><p>1、首先安装一个redis</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># yum install redis</span></span><br></pre></td></tr></table></figure><p>2、查找redis的安装包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># rpm -qa|grep redis</span></span><br><span class="line">redis-3.2.10-2.el7.x86_64</span><br><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure><p>3、查找安装包的安装路径</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@iZbp1eem925ojwyx17ao9kZ ~]<span class="comment"># rpm -ql redis-3.2.10-2.el7.x86_64</span></span><br><span class="line">/etc/logrotate.d/redis</span><br><span class="line">/etc/redis-sentinel.conf</span><br><span class="line">/etc/redis.conf</span><br><span class="line">/etc/systemd/system/redis-sentinel.service.d</span><br><span class="line">/etc/systemd/system/redis-sentinel.service.d/limit.conf</span><br><span class="line">/etc/systemd/system/redis.service.d</span><br><span class="line">/etc/systemd/system/redis.service.d/limit.conf</span><br><span class="line">/usr/bin/redis-benchmark</span><br><span class="line">/usr/bin/redis-check-aof</span><br><span class="line">/usr/bin/redis-check-rdb</span><br><span class="line">/usr/bin/redis-cli</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IM聊天页面消息时间的展示(Flutter)</title>
      <link href="/2022/04/25/20220425IM%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2%E6%B6%88%E6%81%AF%E6%97%B6%E9%97%B4%E7%9A%84%E5%B1%95%E7%A4%BAFlutter/"/>
      <url>/2022/04/25/20220425IM%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2%E6%B6%88%E6%81%AF%E6%97%B6%E9%97%B4%E7%9A%84%E5%B1%95%E7%A4%BAFlutter/</url>
      
        <content type="html"><![CDATA[<p>值得一提的是微信会根据手机系统的时间制度（24小时，12小时）展示的不一样的时间</p><blockquote><p>比如同一天 早上的11:30</p><p>24小时制 11:30</p><p>12小时制 上午 11:30</p></blockquote><p>下面时间为毫秒</p><p>数据结构因项目而异，请根据自己的项目适当更改</p><blockquote><p>dependencies: {intl: ^0.17.0}</p></blockquote><p>核心代码如下</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:intl/intl.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">String</span> _formatDate(<span class="built_in">DateTime</span> date, <span class="built_in">String</span> fmt) &#123;</span><br><span class="line">  DateFormat outputFormat = DateFormat(fmt);</span><br><span class="line">  <span class="keyword">return</span> outputFormat.format(date);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">String</span> _getTimeStringAutoShort2(<span class="built_in">int</span> timestamp, <span class="built_in">bool</span> mustIncludeTime) &#123;</span><br><span class="line">  <span class="comment">//当前日期</span></span><br><span class="line">  <span class="built_in">DateTime</span> currentDate = <span class="built_in">DateTime</span>.now();</span><br><span class="line">  <span class="built_in">int</span> currentYear = currentDate.year;</span><br><span class="line">  <span class="built_in">int</span> currentMonth = currentDate.month;</span><br><span class="line">  <span class="built_in">int</span> currentDateD = currentDate.day;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//传入的日期 millTime为毫秒级时间戳</span></span><br><span class="line">  <span class="built_in">DateTime</span> srcDate = <span class="built_in">DateTime</span>.fromMillisecondsSinceEpoch(timestamp);</span><br><span class="line">  <span class="built_in">int</span> srcYear = srcDate.year;</span><br><span class="line">  <span class="built_in">int</span> srcMonth = srcDate.month;</span><br><span class="line">  <span class="built_in">int</span> srcDateD = srcDate.day;</span><br><span class="line"></span><br><span class="line">  <span class="comment">///<span class="language-markdown">结果</span></span></span><br><span class="line">  <span class="built_in">String</span> ret = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> timeExtraStr =</span><br><span class="line">      mustIncludeTime ? <span class="string">&quot; &quot;</span> + _formatDate(srcDate, <span class="string">&quot;HH:mm&quot;</span>) : <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (srcYear == currentYear) &#123;</span><br><span class="line">    <span class="comment">///<span class="language-markdown">当年</span></span></span><br><span class="line">    <span class="built_in">int</span> currentTimestamp = currentDate.millisecondsSinceEpoch;</span><br><span class="line">    <span class="built_in">int</span> srcTimestamp = timestamp;</span><br><span class="line">    <span class="comment">// 相差时间（单位：毫秒）</span></span><br><span class="line">    <span class="built_in">int</span> deltaTime = (currentTimestamp - srcTimestamp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当天（月份和日期一致才是）</span></span><br><span class="line">    <span class="keyword">if</span> (currentMonth == srcMonth &amp;&amp; currentDateD == srcDateD) &#123;</span><br><span class="line">      ret = _formatDate(srcDate, <span class="string">&quot;HH:mm&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 当年 &amp;&amp; 当天之外的时间（即昨天及以前的时间）</span></span><br><span class="line">      <span class="comment">// 昨天（以“现在”的时候为基准-1天）</span></span><br><span class="line">      <span class="built_in">DateTime</span> yesterdayDate =</span><br><span class="line">          <span class="built_in">DateTime</span>.fromMillisecondsSinceEpoch(currentTimestamp - <span class="number">86400000</span> * <span class="number">1</span>);</span><br><span class="line">      <span class="comment">// 前天（以“现在”的时候为基准-2天）</span></span><br><span class="line">      <span class="built_in">DateTime</span> beforeYesterdayDate =</span><br><span class="line">          <span class="built_in">DateTime</span>.fromMillisecondsSinceEpoch(currentTimestamp - <span class="number">86400000</span> * <span class="number">2</span>);</span><br><span class="line">      <span class="comment">// 用目标日期的“月”和“天”跟上方计算出来的“昨天”进行比较，是最为准确的（如果用时间戳差值</span></span><br><span class="line">      <span class="comment">// 的形式，是不准确的，比如：现在时刻是2019年02月22日1:00、而srcDate是2019年02月21日23:00，</span></span><br><span class="line">      <span class="comment">// 这两者间只相差2小时，直接用“deltaTime/(3600 * 1000)” &gt; 24小时来判断是否昨天，就完全是扯蛋的逻辑了）</span></span><br><span class="line">      <span class="keyword">if</span> (srcMonth == (yesterdayDate.month) &amp;&amp; srcDateD == yesterdayDate.day) &#123;</span><br><span class="line">        ret = <span class="string">&quot;昨天&quot;</span> + timeExtraStr; <span class="comment">// -1d</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (srcMonth == (beforeYesterdayDate.month) &amp;&amp;</span><br><span class="line">          srcDateD == beforeYesterdayDate.day) &#123;</span><br><span class="line">        <span class="comment">// “前天”判断逻辑同上</span></span><br><span class="line">        ret = <span class="string">&quot;前天&quot;</span> + timeExtraStr; <span class="comment">// -2d</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 跟当前时间相差的小时数</span></span><br><span class="line">        <span class="keyword">var</span> deltaHour = (deltaTime / (<span class="number">3600</span> * <span class="number">1000</span>));</span><br><span class="line">        <span class="comment">// 如果小于或等 7*24小时就显示星期几</span></span><br><span class="line">        <span class="keyword">if</span> (deltaHour &lt;= <span class="number">7</span> * <span class="number">24</span>) &#123;</span><br><span class="line">          <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; weekday = [];</span><br><span class="line">          weekday.addAll([<span class="string">&quot;星期一&quot;</span>, <span class="string">&quot;星期二&quot;</span>, <span class="string">&quot;星期三&quot;</span>, <span class="string">&quot;星期四&quot;</span>, <span class="string">&quot;星期五&quot;</span>, <span class="string">&quot;星期六&quot;</span>, <span class="string">&quot;星期日&quot;</span>]);</span><br><span class="line">          <span class="comment">// 取出当前是星期几</span></span><br><span class="line">          <span class="keyword">var</span> weedayDesc = weekday[srcDate.weekday - <span class="number">1</span>];</span><br><span class="line">          ret = weedayDesc + timeExtraStr;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 否则直接显示完整日期时间</span></span><br><span class="line">          ret = _formatDate(srcDate, <span class="string">&quot;yyyy年M月d日&quot;</span>) + timeExtraStr;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">///<span class="language-markdown">往年</span></span></span><br><span class="line">    ret = _formatDate(srcDate, <span class="string">&quot;yyyy年M月d日&quot;</span>) + timeExtraStr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">聊天页面时间展示的最小差</span></span></span><br><span class="line"><span class="built_in">bool</span> check2TimeGap(<span class="built_in">int</span> t1, <span class="built_in">int</span> t2) &#123;</span><br><span class="line">  <span class="keyword">if</span> ((t1 - t2).abs() &gt; <span class="number">1000</span> * <span class="number">60</span> * <span class="number">5</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="language-markdown">/**</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> 向新收到的消息列表时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> [msg] 新收到的消息</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> [curStartTime] 最近一条消息的时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line"><span class="built_in">List</span> msgListTimeHook(<span class="built_in">List</span> msgList) &#123;</span><br><span class="line">  <span class="built_in">List</span> result = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; msgList.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> item = msgList[i];</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">      item[<span class="string">&quot;viewTime&quot;</span>] = _getTimeStringAutoShort2(item[<span class="string">&quot;time&quot;</span>], <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (check2TimeGap(item[<span class="string">&quot;time&quot;</span>], msgList[i - <span class="number">1</span>][<span class="string">&quot;time&quot;</span>])) &#123;</span><br><span class="line">      item[<span class="string">&quot;viewTime&quot;</span>] = _getTimeStringAutoShort2(item[<span class="string">&quot;time&quot;</span>], <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    result.add(item);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="language-markdown"><span class="emphasis">/*</span>*</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> 向新收到的消息列表时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> </span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> * @msg 新收到的消息</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> @curStartTime 最近一条消息的时间</span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"><span class="bullet"> *</span> </span></span></span><br><span class="line"><span class="language-markdown"><span class="comment"> <span class="emphasis">*/</span></span></span></span><br><span class="line">msgAloneTimeHook(msg, curStartTime) &#123;</span><br><span class="line">  <span class="comment">// if(!curStartTime)&#123;</span></span><br><span class="line">  <span class="comment">//     msg.viewTime=_getTimeStringAutoShort2(item.time, true)</span></span><br><span class="line">  <span class="comment">// &#125;else&#123;</span></span><br><span class="line">  <span class="comment">//     if (check2TimeGap(msg.time,curStartTime)) &#123;</span></span><br><span class="line">  <span class="comment">//         msg.viewTime=_getTimeStringAutoShort2(item.time, true)</span></span><br><span class="line">  <span class="comment">//     &#125;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="comment">// return msg</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基本使用如下</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">  <span class="keyword">var</span> mes = [</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息12&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1630113816000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息11&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1661649816000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息11&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664090674000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息周一&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664177074000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息前天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664263474000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息昨天&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664349874000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;m&quot;</span>: <span class="string">&quot;我是一条消息1&quot;</span>, <span class="string">&quot;time&quot;</span>: <span class="number">1664381016000</span>&#125;,</span><br><span class="line">  ];</span><br><span class="line">  <span class="comment">// _getTimeStringAutoShort2(1664380797000, true);</span></span><br><span class="line">  <span class="keyword">var</span> a = msgListTimeHook(mes);</span><br><span class="line">  <span class="built_in">print</span>(a);</span><br><span class="line">  <span class="comment">// 用于聊天内容界面时</span></span><br><span class="line">  <span class="keyword">var</span> b = _getTimeStringAutoShort2(<span class="number">1550789954260</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">///<span class="language-markdown">用于会话列表“消息”界面时</span></span></span><br><span class="line">  <span class="keyword">var</span> c = _getTimeStringAutoShort2(<span class="number">1550789954260</span>, <span class="keyword">false</span>);</span><br><span class="line">  <span class="built_in">print</span>(a);</span><br><span class="line">  <span class="built_in">print</span>(b);</span><br><span class="line">  <span class="built_in">print</span>(c);</span><br><span class="line">  <span class="comment">// mes.forEach((i) &#123;</span></span><br><span class="line">  <span class="comment">//   _getTimeStringAutoShort2(i[&quot;time&quot;] as int, true);</span></span><br><span class="line">  <span class="comment">// &#125;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大概结果如下下面返回的结果并非使用上面的数据</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息12&#x27;</span>, <span class="attr">time</span>: <span class="number">1630113816000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;2021年8月28日 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息11&#x27;</span>, <span class="attr">time</span>: <span class="number">1661649816000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;2022年8月28日 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息10.5&#x27;</span>, <span class="attr">time</span>: <span class="number">1664159074000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;星期一 10:24&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息10&#x27;</span>, <span class="attr">time</span>: <span class="number">1664328216000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息9&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息8&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息7&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息6&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息5&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378676000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息4&#x27;</span>, <span class="attr">time</span>: <span class="number">1664379876000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:44&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息3&#x27;</span>, <span class="attr">time</span>: <span class="number">1664379936000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息2&#x27;</span>, <span class="attr">time</span>: <span class="number">1664380797000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:59&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息1&#x27;</span>, <span class="attr">time</span>: <span class="number">1664381016000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-1&#x27;</span>, <span class="attr">time</span>: <span class="number">1664440902124</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;16:41&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-2&#x27;</span>, <span class="attr">time</span>: <span class="number">1664440962124</span> &#125;</span><br><span class="line">]</span><br><span class="line">&#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-3&#x27;</span>, <span class="attr">time</span>: <span class="number">1664441027131</span> &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> flutter </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> im </tag>
            
            <tag> flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IM聊天页面消息时间的展示(web)</title>
      <link href="/2022/04/20/20220420IM%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2%E6%B6%88%E6%81%AF%E6%97%B6%E9%97%B4%E7%9A%84%E5%B1%95%E7%A4%BAweb/"/>
      <url>/2022/04/20/20220420IM%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2%E6%B6%88%E6%81%AF%E6%97%B6%E9%97%B4%E7%9A%84%E5%B1%95%E7%A4%BAweb/</url>
      
        <content type="html"><![CDATA[<p>值得一提的是微信会根据手机系统的时间制度（24小时，12小时）展示的不一样的时间</p><blockquote><p>比如同一天 早上的11:30</p><p>24小时制 11:30</p><p>12小时制 上午 11:30</p></blockquote><p>下面时间为毫秒</p><p>数据结构因项目而异</p><p>核心代码如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对Date的扩展，将 Date 转化为指定格式的String。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，</span></span><br><span class="line"><span class="comment"> *  年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  【示例】：</span></span><br><span class="line"><span class="comment"> *  common.formatDate(new Date(), &#x27;yyyy-MM-dd hh:mm:ss.S&#x27;) ==&gt; 2006-07-02 08:09:04.423</span></span><br><span class="line"><span class="comment"> *  common.formatDate(new Date(), &#x27;yyyy-M-d h:m:s.S&#x27;)      ==&gt; 2006-7-2 8:9:4.18</span></span><br><span class="line"><span class="comment"> *  common.formatDate(new Date(), &#x27;hh:mm:ss.S&#x27;)            ==&gt; 08:09:04.423</span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> _formatDate = <span class="keyword">function</span> (<span class="params">date, fmt</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> o = &#123;</span><br><span class="line">        <span class="string">&quot;M+&quot;</span>: date.<span class="title function_">getMonth</span>() + <span class="number">1</span>, <span class="comment">//月份</span></span><br><span class="line">        <span class="string">&quot;d+&quot;</span>: date.<span class="title function_">getDate</span>(), <span class="comment">//日</span></span><br><span class="line">        <span class="string">&quot;h+&quot;</span>: date.<span class="title function_">getHours</span>(), <span class="comment">//小时</span></span><br><span class="line">        <span class="string">&quot;m+&quot;</span>: date.<span class="title function_">getMinutes</span>(), <span class="comment">//分</span></span><br><span class="line">        <span class="string">&quot;s+&quot;</span>: date.<span class="title function_">getSeconds</span>(), <span class="comment">//秒</span></span><br><span class="line">        <span class="string">&quot;q+&quot;</span>: <span class="title class_">Math</span>.<span class="title function_">floor</span>((date.<span class="title function_">getMonth</span>() + <span class="number">3</span>) / <span class="number">3</span>), <span class="comment">//季度</span></span><br><span class="line">        <span class="string">&quot;S&quot;</span>: date.<span class="title function_">getMilliseconds</span>() <span class="comment">//毫秒</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/(y+)/</span>.<span class="title function_">test</span>(fmt)) fmt = fmt.<span class="title function_">replace</span>(<span class="title class_">RegExp</span>.<span class="property">$1</span>, (date.<span class="title function_">getFullYear</span>() + <span class="string">&quot;&quot;</span>).<span class="title function_">substr</span>(<span class="number">4</span> - <span class="title class_">RegExp</span>.<span class="property">$1</span>.<span class="property">length</span>));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> o)</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">&quot;(&quot;</span> + k + <span class="string">&quot;)&quot;</span>).<span class="title function_">test</span>(fmt)) fmt = fmt.<span class="title function_">replace</span>(<span class="title class_">RegExp</span>.<span class="property">$1</span>, (<span class="title class_">RegExp</span>.<span class="property">$1</span>.<span class="property">length</span> == <span class="number">1</span>) ? (o[k]) : ((<span class="string">&quot;00&quot;</span> + o[k]).<span class="title function_">substr</span>((<span class="string">&quot;&quot;</span> + o[k]).<span class="property">length</span>)));</span><br><span class="line">    <span class="keyword">return</span> fmt;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 仿照微信中的消息时间显示逻辑，将时间戳（单位：毫秒）转换为友好的显示格式.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1）7天之内的日期显示逻辑是：今天、昨天(-1d)、前天(-2d)、星期？（只显示总计7天之内的星期数，即&lt;=-4d）；</span></span><br><span class="line"><span class="comment"> * 2）7天之外（即&gt;7天）的逻辑：直接显示完整日期时间。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[long]</span>&#125; timestamp 时间戳（单位：毫秒），形如：1550789954260</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">boolean</span>&#125; mustIncludeTime true表示输出的格式里一定会包含“时间:分钟”</span></span><br><span class="line"><span class="comment"> * ，否则不包含（参考微信，不包含时分的情况，用于首页“消息”中显示时）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> _getTimeStringAutoShort2 = <span class="keyword">function</span> (<span class="params">timestamp, mustIncludeTime</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前时间</span></span><br><span class="line">    <span class="keyword">var</span> currentDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="comment">// 目标判断时间</span></span><br><span class="line">    <span class="keyword">var</span> srcDate = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="built_in">parseInt</span>(timestamp));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> currentYear = currentDate.<span class="title function_">getFullYear</span>();</span><br><span class="line">    <span class="keyword">var</span> currentMonth = (currentDate.<span class="title function_">getMonth</span>() + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">var</span> currentDateD = currentDate.<span class="title function_">getDate</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> srcYear = srcDate.<span class="title function_">getFullYear</span>();</span><br><span class="line">    <span class="keyword">var</span> srcMonth = (srcDate.<span class="title function_">getMonth</span>() + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">var</span> srcDateD = srcDate.<span class="title function_">getDate</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> ret = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 要额外显示的时间分钟</span></span><br><span class="line">    <span class="keyword">var</span> timeExtraStr = (mustIncludeTime ? <span class="string">&quot; &quot;</span> + <span class="title function_">_formatDate</span>(srcDate, <span class="string">&quot;hh:mm&quot;</span>) : <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当年</span></span><br><span class="line">    <span class="keyword">if</span> (currentYear == srcYear) &#123;</span><br><span class="line">        <span class="keyword">var</span> currentTimestamp = currentDate.<span class="title function_">getTime</span>();</span><br><span class="line">        <span class="keyword">var</span> srcTimestamp = timestamp;</span><br><span class="line">        <span class="comment">// 相差时间（单位：毫秒）</span></span><br><span class="line">        <span class="keyword">var</span> deltaTime = (currentTimestamp - srcTimestamp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当天（月份和日期一致才是）</span></span><br><span class="line">        <span class="keyword">if</span> (currentMonth == srcMonth &amp;&amp; currentDateD == srcDateD) &#123;</span><br><span class="line">                ret = <span class="title function_">_formatDate</span>(srcDate, <span class="string">&quot;hh:mm&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 当年 &amp;&amp; 当天之外的时间（即昨天及以前的时间）</span></span><br><span class="line">            <span class="comment">// 昨天（以“现在”的时候为基准-1天）</span></span><br><span class="line">            <span class="keyword">var</span> yesterdayDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">            yesterdayDate.<span class="title function_">setDate</span>(yesterdayDate.<span class="title function_">getDate</span>() - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 前天（以“现在”的时候为基准-2天）</span></span><br><span class="line">            <span class="keyword">var</span> beforeYesterdayDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">            beforeYesterdayDate.<span class="title function_">setDate</span>(beforeYesterdayDate.<span class="title function_">getDate</span>() - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 用目标日期的“月”和“天”跟上方计算出来的“昨天”进行比较，是最为准确的（如果用时间戳差值</span></span><br><span class="line">            <span class="comment">// 的形式，是不准确的，比如：现在时刻是2019年02月22日1:00、而srcDate是2019年02月21日23:00，</span></span><br><span class="line">            <span class="comment">// 这两者间只相差2小时，直接用“deltaTime/(3600 * 1000)” &gt; 24小时来判断是否昨天，就完全是扯蛋的逻辑了）</span></span><br><span class="line">            <span class="keyword">if</span> (srcMonth == (yesterdayDate.<span class="title function_">getMonth</span>() + <span class="number">1</span>) &amp;&amp; srcDateD == yesterdayDate.<span class="title function_">getDate</span>())</span><br><span class="line">                ret = <span class="string">&quot;昨天&quot;</span> + timeExtraStr; <span class="comment">// -1d</span></span><br><span class="line">            <span class="comment">// “前天”判断逻辑同上</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (srcMonth == (beforeYesterdayDate.<span class="title function_">getMonth</span>() + <span class="number">1</span>) &amp;&amp; srcDateD == beforeYesterdayDate.<span class="title function_">getDate</span>())&#123;</span><br><span class="line">                ret = <span class="string">&quot;前天&quot;</span> + timeExtraStr; <span class="comment">// -2d</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 跟当前时间相差的小时数</span></span><br><span class="line">                <span class="keyword">var</span> deltaHour = (deltaTime / (<span class="number">3600</span> * <span class="number">1000</span>));</span><br><span class="line">                <span class="comment">// 如果小于或等 7*24小时就显示星期几</span></span><br><span class="line">                <span class="keyword">if</span> (deltaHour &lt;= <span class="number">7</span> * <span class="number">24</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> weekday = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">7</span>);</span><br><span class="line">                    weekday[<span class="number">0</span>] = <span class="string">&quot;星期日&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">1</span>] = <span class="string">&quot;星期一&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">2</span>] = <span class="string">&quot;星期二&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">3</span>] = <span class="string">&quot;星期三&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">4</span>] = <span class="string">&quot;星期四&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">5</span>] = <span class="string">&quot;星期五&quot;</span>;</span><br><span class="line">                    weekday[<span class="number">6</span>] = <span class="string">&quot;星期六&quot;</span>;</span><br><span class="line">                    <span class="comment">// 取出当前是星期几</span></span><br><span class="line">                    <span class="keyword">var</span> weedayDesc = weekday[srcDate.<span class="title function_">getDay</span>()];</span><br><span class="line">                    ret = weedayDesc + timeExtraStr;</span><br><span class="line">                &#125; <span class="keyword">else</span>&#123;<span class="comment">// 否则直接显示完整日期时间</span></span><br><span class="line">                    ret = <span class="title function_">_formatDate</span>(srcDate, <span class="string">&quot;yyyy年M月d日&quot;</span>) + timeExtraStr;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 往年</span></span><br><span class="line">        ret = <span class="title function_">_formatDate</span>(srcDate, <span class="string">&quot;yyyy年M月d日&quot;</span>) + timeExtraStr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">///聊天页面时间展示的最小差</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check2TimeGap</span>(<span class="params">t1, t2</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">abs</span>(t1 - t2) &gt; <span class="number">1000</span> * <span class="number">60</span> * <span class="number">5</span>) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 向新收到的消息列表时间</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@msg</span> 新收到的消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@curStartTime</span> 最近一条消息的时间</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">msgListTimeHook</span>(<span class="params">msgList,startTime</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> result=[]</span><br><span class="line">    msgList.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">            item.<span class="property">viewTime</span>=<span class="title function_">_getTimeStringAutoShort2</span>(item.<span class="property">time</span>, <span class="literal">true</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">check2TimeGap</span>(item.<span class="property">time</span>, mes[index-<span class="number">1</span>].<span class="property">time</span>)) &#123;</span><br><span class="line">            item.<span class="property">viewTime</span>=<span class="title function_">_getTimeStringAutoShort2</span>(item.<span class="property">time</span>, <span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        result.<span class="title function_">push</span>(item)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 向新收到的消息列表时间</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@msg</span> 新收到的消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@curStartTime</span> 最近一条消息的时间</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">msgAloneTimeHook</span>(<span class="params">msg,curStartTime</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!curStartTime)&#123;</span><br><span class="line">        msg.<span class="property">viewTime</span>=<span class="title function_">_getTimeStringAutoShort2</span>(item.<span class="property">time</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">check2TimeGap</span>(msg.<span class="property">time</span>,curStartTime)) &#123;</span><br><span class="line">            msg.<span class="property">viewTime</span>=<span class="title function_">_getTimeStringAutoShort2</span>(item.<span class="property">time</span>, <span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基本使用如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息12&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1630113816000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息11&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1661649816000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息10.5&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664159074000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息10&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664328216000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息9&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378616000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息8&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378616000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息7&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378616000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息6&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378616000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息5&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664378676000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息4&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664379876000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息3&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664379936000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息2&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664380797000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息1&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="number">1664381016000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息-1&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">valueOf</span>()-<span class="number">125</span>*<span class="number">1000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">m</span>: <span class="string">&quot;我是一条消息-2&quot;</span>,</span><br><span class="line">        <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">valueOf</span>()-<span class="number">65</span>*<span class="number">1000</span></span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">///向消息列表中添加时间</span></span><br><span class="line">mes=<span class="title function_">msgListTimeHook</span>(mes)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(mes)</span><br><span class="line"><span class="comment">///收到消息时判断是否需要展示时间</span></span><br><span class="line"><span class="keyword">var</span> curStartTime=mes[mes.<span class="property">length</span>-<span class="number">1</span>].<span class="property">time</span></span><br><span class="line"><span class="keyword">var</span> newmsg=<span class="title function_">msgAloneTimeHook</span>(&#123;</span><br><span class="line">    <span class="attr">m</span>: <span class="string">&quot;我是一条消息-3&quot;</span>,</span><br><span class="line">    <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">valueOf</span>()</span><br><span class="line">&#125;,curStartTime)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newmsg)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于聊天内容界面时</span></span><br><span class="line"><span class="title function_">_getTimeStringAutoShort2</span>(<span class="number">1550789954260</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="comment">///用于会话列表“消息”界面时</span></span><br><span class="line"><span class="title function_">_getTimeStringAutoShort2</span>(<span class="number">1550789954260</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>结果如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息12&#x27;</span>, <span class="attr">time</span>: <span class="number">1630113816000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;2021年8月28日 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息11&#x27;</span>, <span class="attr">time</span>: <span class="number">1661649816000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;2022年8月28日 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息10.5&#x27;</span>, <span class="attr">time</span>: <span class="number">1664159074000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;星期一 10:24&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息10&#x27;</span>, <span class="attr">time</span>: <span class="number">1664328216000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 09:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息9&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:23&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息8&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息7&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息6&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378616000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息5&#x27;</span>, <span class="attr">time</span>: <span class="number">1664378676000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息4&#x27;</span>, <span class="attr">time</span>: <span class="number">1664379876000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:44&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息3&#x27;</span>, <span class="attr">time</span>: <span class="number">1664379936000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息2&#x27;</span>, <span class="attr">time</span>: <span class="number">1664380797000</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;昨天 23:59&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息1&#x27;</span>, <span class="attr">time</span>: <span class="number">1664381016000</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-1&#x27;</span>, <span class="attr">time</span>: <span class="number">1664440902124</span>, <span class="attr">viewTime</span>: <span class="string">&#x27;16:41&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-2&#x27;</span>, <span class="attr">time</span>: <span class="number">1664440962124</span> &#125;</span><br><span class="line">]</span><br><span class="line">&#123; <span class="attr">m</span>: <span class="string">&#x27;我是一条消息-3&#x27;</span>, <span class="attr">time</span>: <span class="number">1664441027131</span> &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
            <tag> im </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在vue的data中调用computed的属性异常</title>
      <link href="/2022/01/02/20220102%E5%9C%A8vue%E7%9A%84data%E4%B8%AD%E8%B0%83%E7%94%A8computed%E7%9A%84%E5%B1%9E%E6%80%A7%E5%BC%82%E5%B8%B8/"/>
      <url>/2022/01/02/20220102%E5%9C%A8vue%E7%9A%84data%E4%B8%AD%E8%B0%83%E7%94%A8computed%E7%9A%84%E5%B1%9E%E6%80%A7%E5%BC%82%E5%B8%B8/</url>
      
        <content type="html"><![CDATA[<p>先看问题</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">data</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line"><span class="attr">name</span>:<span class="variable language_">this</span>.<span class="property">nickname</span> <span class="comment">//undefined</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">computed</span>:&#123;</span><br><span class="line"><span class="title function_">nickname</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;1111&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这里很容易想到是执行顺序的问题，computed中的属性和data中的属性最终都会加载到app这个实例下。</p><p>如果data中的实例属性被创建完成的时候，computed中的实例属性还没被创建，很明显，在data中获取到computed中的属性必定是undefined…</p><p>解决方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">name</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">nickname</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用name() 或者直接在computed中对data中的属性赋值，因为此时data已经初始化。</span></span><br></pre></td></tr></table></figure><p>看似简单实际有很多小伙伴都不知道。</p>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web前端 </tag>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Google Face web端登录</title>
      <link href="/2021/12/20/20211220GoogleFaceweb%E7%AB%AF%E7%99%BB%E5%BD%95/"/>
      <url>/2021/12/20/20211220GoogleFaceweb%E7%AB%AF%E7%99%BB%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h4 id="Google"><a href="#Google" class="headerlink" title="Google"></a>Google</h4><hr><ul><li>一定要使用最新的文档。<a href="https://developers.google.com/identity/gsi/web/guides/migration">https://developers.google.com/identity/gsi/web/guides/migration</a></li><li>控制台 <a href="https://console.cloud.google.com/apis/dashboard?project=tabbyceshi">https://console.cloud.google.com/apis/dashboard?project=tabbyceshi</a></li><li>应用 <a href="https://console.cloud.google.com/apis/credentials?project=tabbyceshi&amp;supportedpurview=project">https://console.cloud.google.com/apis/credentials?project=tabbyceshi&amp;supportedpurview=project</a></li></ul><p>测试demo</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;meta name=&quot;google-signin-client_id&quot; content=&quot;466619277311-sk2aoc77hg88lm4llvk74cbiq63utk9i.apps.googleusercontent.com&quot;&gt; --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;script src=&quot;https://accounts.google.com/gsi/client&quot; async defer&gt;&lt;/script&gt; --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;div class=&quot;g-signin2&quot; data-onsuccess=&quot;onSignIn&quot;&gt;222&lt;/div&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://accounts.google.com/gsi/client&quot;</span> <span class="attr">async</span> <span class="attr">defer</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;g_id_onload&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-login_uri</span>=<span class="string">&quot;http://localhost:5500/google.html&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-auto_prompt</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-client_id</span>=<span class="string">&quot;541694494382-p228lh72cbf9smp0greo8kekhvetkep3.apps.googleusercontent.com&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-callback</span>=<span class="string">&quot;handleCredentialResponse&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g_id_signin&quot;</span> <span class="attr">data-type</span>=<span class="string">&quot;standard&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handleCredentialResponse</span>(<span class="params">e</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>简易使用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">class</span> <span class="title class_">GoogleSDK</span> &#123;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">appendHtmlDOM</span>(<span class="params">attrs=[],dom=<span class="string">&#x27;script&#x27;</span></span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,_</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="keyword">var</span> body = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;body&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(dom);</span><br><span class="line">attrs.<span class="title function_">forEach</span>(<span class="function"><span class="params">i</span>=&gt;</span>&#123;script.<span class="title function_">setAttribute</span>(i.<span class="property">key</span>,i.<span class="property">value</span>)&#125;)</span><br><span class="line">body.<span class="title function_">appendChild</span>(script);</span><br><span class="line">script.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;<span class="title function_">resolve</span>()&#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">async</span> <span class="title class_">GetAaccessToken</span>(client_id) &#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="keyword">await</span> <span class="title class_">GoogleSDK</span>.<span class="title function_">appendHtmlDOM</span>([</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;src&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;https://accounts.google.com/gsi/client&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;type&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;text/javascript&quot;</span>&#125;,</span><br><span class="line">])</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">var</span> client= google.<span class="property">accounts</span>.<span class="property">oauth2</span>.<span class="title function_">initTokenClient</span>(&#123;</span><br><span class="line">client_id,</span><br><span class="line"><span class="attr">scope</span>: <span class="string">&#x27;https://www.googleapis.com/auth/calendar.readonly \ https://www.googleapis.com/auth/contacts.readonly&#x27;</span>,</span><br><span class="line"><span class="attr">callback</span>: <span class="function">(<span class="params">tokenResponse</span>) =&gt;</span> &#123;<span class="title function_">resolve</span>(tokenResponse)&#125;,</span><br><span class="line">&#125;);</span><br><span class="line">client.<span class="title function_">requestAccessToken</span>();</span><br><span class="line">&#125;)</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">revokeToken</span>(<span class="params">access_token</span>) &#123;</span><br><span class="line">google.<span class="property">accounts</span>.<span class="property">oauth2</span>.<span class="title function_">revoke</span>(access_token, <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;access token revoked&#x27;</span>) &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">async</span> <span class="title class_">UserLogin</span>(client_id) &#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">await</span> <span class="title class_">GoogleSDK</span>.<span class="title function_">appendHtmlDOM</span>([</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;src&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;https://accounts.google.com/gsi/client&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;type&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;text/javascript&quot;</span>&#125;,</span><br><span class="line">])</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">千万别放在有v-if的操作里面！！！</span></span><br><span class="line"><span class="comment">window.handleCredentialResponse=function(e)&#123;</span></span><br><span class="line"><span class="comment">console.log(e)</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">//需要写在html里面</span></span><br><span class="line"><span class="comment">&lt;div id=&quot;g_id_onload&quot;</span></span><br><span class="line"><span class="comment">data-login_uri=&quot;http://localhost:5500/google.html&quot;</span></span><br><span class="line"><span class="comment">data-auto_prompt=&quot;false&quot;</span></span><br><span class="line"><span class="comment">data-client_id=&quot;******&quot;</span></span><br><span class="line"><span class="comment">data-callback=&quot;handleCredentialResponse&quot;&gt;</span></span><br><span class="line"><span class="comment">&lt;/div&gt;</span></span><br><span class="line"><span class="comment">//点击即可登录，触发上面的handleCredentialResponse</span></span><br><span class="line"><span class="comment">&lt;div class=&quot;g_id_signin&quot; data-type=&quot;standard&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>相关报错。先尝试清缓存。如果是 vue/react 把 <script src="https://accounts.google.com/gsi/client" async defer></script> 放在模板文件的head里面</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Uncaught dw</span><br><span class="line"></span><br><span class="line">不能用127.0.0.1</span><br><span class="line">可以切换成http://localhost:**********</span><br></pre></td></tr></table></figure><p><img src="/assets/img/202112201.png"><br><img src="/assets/img/202112202.png"></p><h4 id="FaceBook"><a href="#FaceBook" class="headerlink" title="FaceBook"></a>FaceBook</h4><hr><ul><li>开发者 <a href="https://developers.facebook.com/docs/development/register?locale=zh_CN">https://developers.facebook.com/docs/development/register?locale=zh_CN</a></li><li>应用 <a href="https://developers.facebook.com/apps/?show_reminder=true">https://developers.facebook.com/apps/?show_reminder=true</a></li><li>白名单 <a href="https://developers.facebook.com/apps/1531808977238106/gaming-login/settings/">https://developers.facebook.com/apps/1531808977238106/gaming-login/settings/</a><br>demo<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Facebook Login JavaScript Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">checkLoginState</span>(<span class="params"></span>) &#123;               <span class="comment">// Called when a person is finished with the Login Button.</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable constant_">FB</span>.<span class="title function_">getLoginStatus</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;   <span class="comment">// See the onlogin handler</span></span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="property">fbAsyncInit</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable constant_">FB</span>.<span class="title function_">init</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">appId</span>: <span class="string">&#x27;**********&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">cookie</span>: <span class="literal">true</span>,                     <span class="comment">// Enable cookies to allow the server to access the session.</span></span></span><br><span class="line"><span class="language-javascript">                <span class="attr">xfbml</span>: <span class="literal">true</span>,                     <span class="comment">// Parse social plugins on this webpage.</span></span></span><br><span class="line"><span class="language-javascript">                <span class="attr">version</span>: <span class="string">&#x27;v14.0&#x27;</span>                  <span class="comment">// Use this Graph API version for this call.</span></span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            <span class="variable constant_">FB</span>.<span class="title function_">getLoginStatus</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;   <span class="comment">// Called after the JS SDK has been initialized.</span></span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(response);               <span class="comment">// The current login status of the person.</span></span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//   function testAPI() &#123;                      // Testing Graph API after login.  See statusChangeCallback() for when this call is made.</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//     console.log(&#x27;Welcome!  Fetching your information.... &#x27;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//     FB.api(&#x27;/me&#x27;, function(response) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//       console.log(&#x27;Successful login for: &#x27; + response.name);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//       document.getElementById(&#x27;status&#x27;).innerHTML = &#x27;Thanks for logging in, &#x27; + response.name + &#x27;!&#x27;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//     &#125;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">//   &#125;</span></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- The JS SDK Login Button --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fb:login-button</span> <span class="attr">scope</span>=<span class="string">&quot;public_profile,email&quot;</span> <span class="attr">onlogin</span>=<span class="string">&quot;checkLoginState();&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">fb:login-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;status&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Load the JS SDK asynchronously --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">async</span> <span class="attr">defer</span> <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://connect.facebook.net/en_US/sdk.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>简易使用<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FaceBookSDK</span> &#123;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">appendJSscript</span>(<span class="params">attrs=[]</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,_</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">var</span> body = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;body&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">attrs.<span class="title function_">forEach</span>(<span class="function"><span class="params">i</span>=&gt;</span>&#123;script.<span class="title function_">setAttribute</span>(i.<span class="property">key</span>,i.<span class="property">value</span>)&#125;)</span><br><span class="line">body.<span class="title function_">appendChild</span>(script);</span><br><span class="line">script.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;<span class="title function_">resolve</span>()&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">async</span> <span class="title class_">FBLogin</span>(appId) &#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="keyword">await</span> <span class="title class_">FaceBookSDK</span>.<span class="title function_">appendJSscript</span>([</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;src&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;https://connect.facebook.net/en_US/sdk.js&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;type&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;text/javascript&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">key</span>:<span class="string">&quot;crossorigin&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;anonymous&quot;</span>&#125;,</span><br><span class="line">])</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">fbAsyncInit</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable constant_">FB</span>.<span class="title function_">init</span>(&#123;appId,<span class="attr">cookie</span>:<span class="literal">true</span>,<span class="attr">xfbml</span>:<span class="literal">true</span>,<span class="attr">version</span>:<span class="string">&#x27;v14.0&#x27;</span>&#125;);</span><br><span class="line"><span class="variable constant_">FB</span>.<span class="title function_">getLoginStatus</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;</span><br><span class="line"><span class="variable constant_">FB</span>.<span class="title function_">login</span>(<span class="keyword">function</span>(<span class="params">a</span>) &#123;</span><br><span class="line"><span class="title function_">resolve</span>(a)</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="title class_">FaceBookSDK</span>.<span class="title class_">FBLogin</span>(<span class="string">&quot;*****&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">e</span>=&gt;</span>&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
            <tag> Google Sign </tag>
            
            <tag> Face Sign </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dart类中的构造函数</title>
      <link href="/2021/12/09/20211219flutter%E7%B1%BB%E4%B8%AD%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/"/>
      <url>/2021/12/09/20211219flutter%E7%B1%BB%E4%B8%AD%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<h3 id="传统的构造函数"><a href="#传统的构造函数" class="headerlink" title="传统的构造函数"></a>传统的构造函数</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line"><span class="built_in">int</span> age = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> id = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">String?</span> name=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">Student(<span class="built_in">int</span> age, <span class="built_in">int</span> id) &#123;</span><br><span class="line"><span class="keyword">this</span>.age = age;</span><br><span class="line"><span class="keyword">this</span>.id = id;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="命名构造函数"><a href="#命名构造函数" class="headerlink" title="命名构造函数"></a>命名构造函数</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line"><span class="built_in">int?</span> age = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int?</span> id = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">String?</span> name=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">Student(<span class="keyword">this</span>.age, <span class="keyword">this</span>.id,);</span><br><span class="line"></span><br><span class="line">Student.fromJson(<span class="built_in">Map</span> data) &#123;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;命名构造函数&#x27;</span>);</span><br><span class="line"><span class="keyword">this</span>.name=data[<span class="string">&quot;name&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b=Student.fromJson(&#123;<span class="string">&quot;firstName&quot;</span>:<span class="string">&quot;AAAAA&quot;</span>&#125;);</span><br><span class="line"><span class="built_in">print</span>(b.firstName);<span class="comment">///<span class="language-markdown">AAAAA</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>Student.fromJson 不固定也可以叫Student.fromJson1，Student.fromJson2</p></blockquote><h3 id="继承构造函数的执行顺序"><a href="#继承构造函数的执行顺序" class="headerlink" title="继承构造函数的执行顺序"></a>继承构造函数的执行顺序</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String?</span> firstName;</span><br><span class="line">  Student()&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;in Student con&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Student.fromJson(<span class="built_in">Map</span> data) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;in Student&#x27;</span>);</span><br><span class="line">    <span class="keyword">this</span>.firstName=data[<span class="string">&quot;firstName&quot;</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jone</span> <span class="keyword">extends</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">   Jone()&#123;</span><br><span class="line">     <span class="built_in">print</span>(<span class="string">&#x27;in Jone con&#x27;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">  Jone.fromJson(<span class="built_in">Map</span> data) : <span class="keyword">super</span>.fromJson(data) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;in Jone&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b=Student.fromJson(&#123;<span class="string">&quot;firstName&quot;</span>:<span class="string">&quot;AAAAA&quot;</span>&#125;);</span><br><span class="line"><span class="built_in">print</span>(b.firstName);</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="language-markdown">in Student</span></span></span><br><span class="line"><span class="comment">///<span class="language-markdown">AAAAA</span></span></span><br></pre></td></tr></table></figure><ul><li>调用初始化列表（初始化列表就是在构造函数执行之前执行的代码，和调用父类的构造函数一样，也使用：操作符，如下所示：）<blockquote><p>下面：后面的赋值就是出初始化列表</p></blockquote><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Point.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">double</span>&gt; json)</span><br><span class="line">    : x = json[<span class="string">&#x27;x&#x27;</span>]!,</span><br><span class="line">      y = json[<span class="string">&#x27;y&#x27;</span>]! &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;In Point.fromJson(): (<span class="subst">$x</span>, <span class="subst">$y</span>)&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>调用父类的构造函数</li><li>调用自己的构造函数</li></ul><h3 id="重定向构造函数"><a href="#重定向构造函数" class="headerlink" title="重定向构造函数"></a>重定向构造函数</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">  <span class="built_in">double</span> x, y;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 主构造函数</span></span><br><span class="line">  Point(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 构造函数</span></span><br><span class="line">  Point.formJson(<span class="built_in">double</span> x)&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重定向到主构造函数</span></span><br><span class="line">  Point.alongXAxis(<span class="built_in">double</span> x) : <span class="keyword">this</span>(x, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 重定向到formJson构造函数</span></span><br><span class="line">  Point.alongXAxis2(<span class="built_in">double</span> x) : <span class="keyword">this</span>.formJson(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="工厂构造函数"><a href="#工厂构造函数" class="headerlink" title="工厂构造函数"></a>工厂构造函数</h3><p>默认情况下，dart类中的构造函数返回的是该类的<strong>新实例</strong>，但是我们在实际的应用中可能会对返回的对象做些选择，比如从缓存中返回已经存在的对象，或者返回该类具体的实现子类。为了实现这样的功能，dart中专门有一个Factory关键字，使用Factory的构造函数叫做工厂构造函数。</p><p>那么问题来了，factory构造函数和普通构造函数到底有什么区别呢?最大的区别就是普通构造函数是没有返回值的，而factory构造函数需要一个返回值。</p><blockquote><p>Map.putIfAbsent方法回顾，下面备用</p></blockquote><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Map</span> user = &#123; <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Tom&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b=user.putIfAbsent(<span class="string">&#x27;job&#x27;</span>, () =&gt; <span class="string">&#x27;engineer&#x27;</span>);</span><br><span class="line"><span class="built_in">print</span>(user);</span><br><span class="line"><span class="built_in">print</span>(b);</span><br><span class="line"></span><br><span class="line">b=user.putIfAbsent(<span class="string">&#x27;job&#x27;</span>, () =&gt; <span class="string">&#x27;engineer22222222222&#x27;</span>);</span><br><span class="line"><span class="built_in">print</span>(user);</span><br><span class="line"><span class="built_in">print</span>(b);</span><br><span class="line">  </span><br><span class="line"><span class="comment">//     &#123;name: Tom, age: 20, job: engineer&#125;</span></span><br><span class="line"><span class="comment">//     engineer</span></span><br><span class="line"><span class="comment">//     &#123;name: Tom, age: 20, job: engineer&#125;</span></span><br><span class="line"><span class="comment">//     engineer</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure><p>例子</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    Student stu0 = Student(<span class="string">&quot;dart0&quot;</span>,<span class="number">99</span>);</span><br><span class="line">    Student stu1 = Student(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    Student stu2 = Student(<span class="string">&quot;dart&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    Student stu3 = Student.fromJson(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dart&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">3</span>&#125;);</span><br><span class="line">    Student stu4 = Student.fromJson2(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dart&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">4</span>&#125;);</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>); </span><br><span class="line">    <span class="comment">// 使用 Student() 工厂构造函数 和 Student.fromJson(&#123;&#125;) 工厂构造函数创建出来的对象是同一个对象</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu0, stu1));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu1, stu2));  <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu2, stu3));  <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu3, stu4));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>);</span><br><span class="line">    <span class="built_in">print</span>(stu1.age);  <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">print</span>(stu2.age);  <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">print</span>(stu3.age);  <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">print</span>(stu4.age);  <span class="comment">// 10</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>);</span><br><span class="line"><span class="built_in">print</span>(stu0.hashCode);<span class="comment">///<span class="language-markdown">595483760</span></span></span><br><span class="line"><span class="built_in">print</span>(stu1.hashCode);<span class="comment">///<span class="language-markdown">959865253</span></span></span><br><span class="line"><span class="built_in">print</span>(stu2.hashCode);<span class="comment">///<span class="language-markdown">959865253</span></span></span><br><span class="line"><span class="built_in">print</span>(stu3.hashCode);<span class="comment">///<span class="language-markdown">959865253</span></span></span><br><span class="line"><span class="built_in">print</span>(stu4.hashCode);<span class="comment">///<span class="language-markdown">730863203</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="built_in">String?</span> name;</span><br><span class="line">    <span class="built_in">int</span> age=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> _cache = &lt;<span class="built_in">String</span>, Student&gt;&#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> test = &lt;<span class="built_in">int</span>&gt;[];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 工厂构造函数</span></span><br><span class="line">    <span class="keyword">factory</span> Student(<span class="built_in">String</span> name,<span class="built_in">int</span> age) &#123;</span><br><span class="line">        test.add(age);</span><br><span class="line">        <span class="built_in">print</span>(test);</span><br><span class="line">        Student s =_cache.putIfAbsent(name, () =&gt; Student.useForFactory(name,age));</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 工厂构造函数</span></span><br><span class="line">    <span class="keyword">factory</span> Student.fromJson(<span class="built_in">Map</span> json) &#123;</span><br><span class="line">        <span class="keyword">return</span> Student(json[<span class="string">&#x27;name&#x27;</span>],json[<span class="string">&#x27;age&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 命名构造函数</span></span><br><span class="line">    Student.fromJson2(<span class="built_in">Map</span> json):name=json[<span class="string">&quot;json&quot;</span>],age=<span class="number">10</span>;</span><br><span class="line">  </span><br><span class="line">    Student.useForFactory(<span class="keyword">this</span>.name,<span class="keyword">this</span>.age);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如上的例子<strong>伪解释</strong>一下</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">先声明一下，比如我们声明了一个Student类，<span class="keyword">static</span> <span class="keyword">final</span> _cache 我们需要把他解读成一个全局单独的变量(或者说应用的一块单独内存)，上面特地加了<span class="keyword">static</span> <span class="keyword">final</span> test = &lt;<span class="built_in">int</span>&gt;[] 更加清晰明了。</span><br><span class="line"></span><br><span class="line">Student(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>) 向全局单独的变量_cache存入了一个键值对 &#123; <span class="string">&quot;dart&quot;</span> ：Student.useForFactory(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>)&#125;</span><br><span class="line"></span><br><span class="line">Student(<span class="string">&quot;dart&quot;</span>,<span class="number">2</span>) 则 不会！！！继续向全局单独的变量_cache存入了一个键值对，因为_cache中的键 <span class="string">&quot;dart&quot;</span> 已经存在了，所以他会直接返回Student.useForFactory(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>)，这里使用的是<span class="built_in">Map</span>.putIfAbsent实现。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> 反例</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    Student stu1 = Student(<span class="string">&quot;dart&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    Student stu2 = Student(<span class="string">&quot;dart&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    Student stu3 = Student.fromJson(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dart&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">3</span>&#125;);</span><br><span class="line">    Student stu4 = Student.fromJson2(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;dart&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">4</span>&#125;);</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>); </span><br><span class="line">    <span class="comment">// 使用 Student() 工厂构造函数 和 Student.fromJson(&#123;&#125;) 工厂构造函数创建出来的对象是同一个对象</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu1, stu2));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu2, stu3));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(identical(stu3, stu4));  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;============================&quot;</span>);</span><br><span class="line">    <span class="built_in">print</span>(stu1.age);  <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">print</span>(stu2.age);  <span class="comment">// 2</span></span><br><span class="line">    <span class="built_in">print</span>(stu3.age);  <span class="comment">// 3</span></span><br><span class="line">    <span class="built_in">print</span>(stu4.age);  <span class="comment">// 10</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="built_in">String?</span> name;</span><br><span class="line">    <span class="built_in">int</span> age=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> _cache = &lt;<span class="built_in">String</span>, Student&gt;&#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 工厂构造函数</span></span><br><span class="line">    <span class="keyword">factory</span> Student(<span class="built_in">String</span> name,<span class="built_in">int</span> age) &#123;</span><br><span class="line">        <span class="keyword">return</span> Student.useForFactory(name,age);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 工厂构造函数</span></span><br><span class="line">    <span class="keyword">factory</span> Student.fromJson(<span class="built_in">Map</span> json) &#123;</span><br><span class="line">        <span class="keyword">return</span> Student(json[<span class="string">&#x27;name&#x27;</span>],json[<span class="string">&#x27;age&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 命名构造函数</span></span><br><span class="line">    Student.fromJson2(<span class="built_in">Map</span> json):name=json[<span class="string">&quot;json&quot;</span>],age=<span class="number">10</span>;</span><br><span class="line">  </span><br><span class="line">    Student.useForFactory(<span class="keyword">this</span>.name,<span class="keyword">this</span>.age);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>工厂构造函数实现单例</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> Singleton _singleton = Singleton.internal();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> Singleton() =&gt; _singleton;</span><br><span class="line"></span><br><span class="line">  Singleton.internal();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Singleton s1=Singleton();</span><br><span class="line">Singleton s2=Singleton();</span><br><span class="line"><span class="built_in">print</span>(identical(s1, s2));<span class="comment">///<span class="language-markdown">true</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>注意，dart中只能有一个未命名的构造函数，对应命名函数来说，名字不能够重复，否则会报The default constructor is already defined异常。所以如果你再给Student加一个未命名构造函数：Student(this.name)因为已经有了 factory Student(String name)</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> flutter </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浏览器的文件加密解密</title>
      <link href="/2021/10/02/20211024%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86/"/>
      <url>/2021/10/02/20211024%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86/</url>
      
        <content type="html"><![CDATA[<p>对文件加/解密路线</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file -&gt; buffer -&gt; uint8list -&gt; wordArray(crypto-js辅助类型) -&gt; 加/解密后的wordArray -&gt; uint8list</span><br></pre></td></tr></table></figure><p>可以根据业务需求uint8list 转 buffer 或者 blob等</p><p>demo</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        *&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">40px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">button</span>&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: block;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">300px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">120px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;inp&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;encFn()&quot;</span>&gt;</span>加解密字符串<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;decFn()&quot;</span>&gt;</span>加解密文件<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;img&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;crypto-js/crypto-js.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript"><span class="keyword">class</span> <span class="title class_">CryptoJSTB</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    iv=<span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    key=<span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    mode= <span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">    padding=<span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">static</span> <span class="title function_">fromJson</span>(<span class="params">opt=&#123;&#125;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> intance = <span class="keyword">new</span> <span class="title class_">CryptoJSTB</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> &#123;iv,key,mode,padding&#125; = opt</span></span><br><span class="line"><span class="language-javascript">        intance.<span class="property">iv</span>=iv;</span></span><br><span class="line"><span class="language-javascript">        intance.<span class="property">key</span>=key;</span></span><br><span class="line"><span class="language-javascript">        intance.<span class="property">mode</span>=mode||<span class="title class_">CryptoJS</span>.<span class="property">mode</span>.<span class="property">CBC</span>;</span></span><br><span class="line"><span class="language-javascript">        intance.<span class="property">padding</span>=padding||<span class="title class_">CryptoJS</span>.<span class="property">pad</span>.<span class="property">Pkcs7</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> intance</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///加密字符串</span></span></span><br><span class="line"><span class="language-javascript">    encStrAES (plainText) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> options = &#123;<span class="attr">iv</span>:<span class="variable language_">this</span>.<span class="property">iv</span>,<span class="attr">mode</span>:<span class="variable language_">this</span>.<span class="property">mode</span>,<span class="attr">padding</span>:<span class="variable language_">this</span>.<span class="property">padding</span>&#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> words = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(plainText)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> encrypted = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">encrypt</span>(words,<span class="variable language_">this</span>.<span class="property">key</span>,options)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Base64</span>.<span class="title function_">stringify</span>(encrypted.<span class="property">ciphertext</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///解密字符串</span></span></span><br><span class="line"><span class="language-javascript">    decStrAES (plainText) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> options = &#123;<span class="attr">iv</span>:<span class="variable language_">this</span>.<span class="property">iv</span>,<span class="attr">mode</span>:<span class="variable language_">this</span>.<span class="property">mode</span>,<span class="attr">padding</span>:<span class="variable language_">this</span>.<span class="property">padding</span>&#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">///加密的时候导出的base64，这里也用base64解析</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> base64 = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Base64</span>.<span class="title function_">parse</span>(plainText)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> src = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Base64</span>.<span class="title function_">stringify</span>(base64)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> decrypt = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(src, <span class="variable language_">this</span>.<span class="property">key</span>, options)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> decryptedStr = decrypt.<span class="title function_">toString</span>(<span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> decryptedStr.<span class="title function_">toString</span>()</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///加密字节</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">encByteAES</span>(<span class="params">plainText</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> wordArray = <span class="variable language_">this</span>.<span class="title class_">Uint8ToW</span>(plainText);   <span class="comment">// Uint8Array-&gt;WordArray</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> options = &#123;<span class="attr">iv</span>:<span class="variable language_">this</span>.<span class="property">iv</span>,<span class="attr">mode</span>:<span class="variable language_">this</span>.<span class="property">mode</span>,<span class="attr">padding</span>:<span class="variable language_">this</span>.<span class="property">padding</span>&#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> res = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">encrypt</span>(wordArray, <span class="variable language_">this</span>.<span class="property">key</span>,options).<span class="property">ciphertext</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title class_">WToUint8</span>(res)                   <span class="comment">// WordArray-&gt;Uint8Array</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///解密字节</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">decByteAES</span>(<span class="params">plainText</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> wordArray = <span class="variable language_">this</span>.<span class="title class_">Uint8ToW</span>(plainText);   <span class="comment">// Uint8Array-&gt;WordArray</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> options = &#123;<span class="attr">iv</span>:<span class="variable language_">this</span>.<span class="property">iv</span>,<span class="attr">mode</span>:<span class="variable language_">this</span>.<span class="property">mode</span>,<span class="attr">padding</span>:<span class="variable language_">this</span>.<span class="property">padding</span>&#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> content = <span class="title class_">CryptoJS</span>.<span class="property">lib</span>.<span class="property">CipherParams</span>.<span class="title function_">create</span>(&#123;<span class="attr">ciphertext</span>:wordArray&#125;)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> res = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(content, <span class="variable language_">this</span>.<span class="property">key</span>,options)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title class_">WToUint8</span>(res)                   <span class="comment">// WordArray-&gt;Uint8Array</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//类型转换</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//Uint8Array -&gt; wordArray</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">Uint8ToW</span>(u8) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> len = u8.<span class="property">length</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> words= [];</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i += <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            words[i &gt;&gt;&gt; <span class="number">2</span>] |= (u8[i] &amp; <span class="number">0xff</span>) &lt;&lt; (<span class="number">24</span> - (i % <span class="number">4</span>) * <span class="number">8</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> res = <span class="title class_">CryptoJS</span>.<span class="property">lib</span>.<span class="property">WordArray</span>.<span class="title function_">create</span>(words, len);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> res;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//wordArray -&gt; Uint8Array</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">WToUint8</span>(wordArray)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> &#123; words &#125; = wordArray;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> &#123; sigBytes &#125; = wordArray;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> u8 = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(sigBytes);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; sigBytes; i += <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> byte = (words[i &gt;&gt;&gt; <span class="number">2</span>] &gt;&gt;&gt; (<span class="number">24</span> - (i % <span class="number">4</span>) * <span class="number">8</span>)) &amp; <span class="number">0xff</span>;</span></span><br><span class="line"><span class="language-javascript">            u8[i] = byte;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> u8;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///文件转u8</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">static</span> <span class="title function_">fileToUint8</span>(<span class="params">file</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span></span><br><span class="line"><span class="language-javascript">            reader.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;<span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(e.<span class="property">target</span>.<span class="property">result</span>))&#125;</span></span><br><span class="line"><span class="language-javascript">            reader.<span class="title function_">readAsArrayBuffer</span>(file);</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///文件保存</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">static</span> <span class="title function_">saveFile</span>(<span class="params">uint8List,fileName</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> blob=<span class="keyword">new</span> <span class="title class_">Blob</span>([uint8List]);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;a&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        link.<span class="property">href</span> = <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span></span><br><span class="line"><span class="language-javascript">        link.<span class="property">download</span> = fileName;</span></span><br><span class="line"><span class="language-javascript">        link.<span class="title function_">click</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">revokeObjectURL</span>(link.<span class="property">href</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">///实例化</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> keyStr=<span class="string">&quot;abcdabcdabcdabcd&quot;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> content=<span class="string">&quot;123456789aaaa啊我的哇打多阿瓦达&quot;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> c=<span class="title class_">CryptoJSTB</span>.<span class="title function_">fromJson</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">key</span>: <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(keyStr),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">iv</span>: <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(keyStr),</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">///字符串加解密测试</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">encFn</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> encStr=c.<span class="title function_">encStrAES</span>(content)</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(encStr)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> decStr=c.<span class="title function_">decStrAES</span>(encStr)</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(decStr)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">///文件加解密测试，！！！！！！！！！请先选择文件！！！！！！测试用的是图片，方便查看</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">decFn</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///先将文件读取为字节</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> file = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#inp&quot;</span>).<span class="property">files</span>[<span class="number">0</span>]</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">///加解密测试</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">CryptoJSTB</span>.<span class="title function_">fileToUint8</span>(file).<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(result)</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">///加密</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> encByte=c.<span class="title function_">encByteAES</span>(result)</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(encByte)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> decByte=c.<span class="title function_">decByteAES</span>(encByte)</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(decByte)</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">showImg</span>(decByte)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">showImg</span>(<span class="params">u8</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> blob=<span class="keyword">new</span> <span class="title class_">Blob</span>([u8]);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> src =  <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> img=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#img&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">    img.<span class="property">src</span> = src</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
            <tag> cryptojs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>win下WebAssembly环境安装和尝试(Golang)</title>
      <link href="/2021/10/02/20211111win%E4%B8%8BWebAssembly%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E5%92%8C%E5%B0%9D%E8%AF%95/"/>
      <url>/2021/10/02/20211111win%E4%B8%8BWebAssembly%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E5%92%8C%E5%B0%9D%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><ul><li>安装 Git。</li><li>安装cmake。<a href="https://cmake.org/download/">https://cmake.org/download/</a></li><li>安装vs。<a href="https://visualstudio.microsoft.com/zh-hans/downloads/">https://visualstudio.microsoft.com/zh-hans/downloads/</a></li><li>Python 2.7.x，在 Linux 和 OS X上，很可能已经装好了。<a href="https://www.python.org/downloads/release/python-2716/">https://www.python.org/downloads/release/python-2716/</a> 下载Windows x86-64 MSI installer for AMD64/EM64T/x64   python -V<h4 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/juj/emsdk.git</span><br><span class="line">//如果速度很慢可以直接去git下载代码</span><br></pre></td></tr></table></figure><h4 id="安装各种工具"><a href="#安装各种工具" class="headerlink" title="安装各种工具"></a>安装各种工具</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ./emsdk</span><br><span class="line">emsdk install latest</span><br></pre></td></tr></table></figure><h4 id="生成-emscripten-文件，激活配置"><a href="#生成-emscripten-文件，激活配置" class="headerlink" title="生成 ~/.emscripten 文件，激活配置"></a>生成 ~/.emscripten 文件，激活配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emsdk activate latest</span><br></pre></td></tr></table></figure><blockquote><p>双击emsdk目录下的emsdk_env.bat文件配置环境变量</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">这里可能会报错</span><br><span class="line">The changes made to environment variables only apply to the currently running shell instance. Use the &#x27;emsdk_env.bat&#x27; to re-enter this environment later, or if you&#x27;d like to permanently register this environment permanently, rerun this command with the option --permanent.</span><br><span class="line">&#x27;xftp&#x27; 不是内部或.............，也不是可运行的程序...........</span><br><span class="line"></span><br><span class="line">解决</span><br><span class="line">先查看pyhon的是否在全局可用</span><br><span class="line"></span><br><span class="line">然后在按照上面的运行</span><br><span class="line"></span><br><span class="line">emsdk_env.bat --permanent</span><br></pre></td></tr></table></figure><h4 id="查看是否已经安装完成"><a href="#查看是否已经安装完成" class="headerlink" title="查看是否已经安装完成"></a>查看是否已经安装完成</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emcc -v</span><br></pre></td></tr></table></figure><h4 id="查看全局是否可用，如果不能用单独设置环境变量。"><a href="#查看全局是否可用，如果不能用单独设置环境变量。" class="headerlink" title="查看全局是否可用，如果不能用单独设置环境变量。"></a>查看全局是否可用，如果不能用单独设置环境变量。</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 具体的变量的按照自己的目录来</span><br><span class="line"># 单独设置的环境变量，我这里是windows环境</span><br><span class="line">EMSDK=D:\workspace\emsdk\emsdk</span><br><span class="line">EMSDK_NODE=%EMSDK%\node\14.15.5_64bit\bin\node.exe</span><br><span class="line">EMSDK_PYTHON=%EMSDK%\python\3.9.2-1_64bit\python.exe</span><br><span class="line"></span><br><span class="line"># PATH中也要添加环境变量</span><br><span class="line">%EMSDK%</span><br><span class="line">%EMSDK%\upstream\emscripten</span><br><span class="line">%EMSDK%\node\14.15.5_64bit\bin</span><br></pre></td></tr></table></figure><h4 id="编译第一个wasm文件"><a href="#编译第一个wasm文件" class="headerlink" title="编译第一个wasm文件"></a>编译第一个wasm文件</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;emscripten/emscripten.h&gt;</span></span></span><br><span class="line"><span class="comment">// 一旦WASM模块被加载，main()中的代码就会执行</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;WebAssembly 的环境已经搭好了\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 返回1-6之间的一随机数</span></span><br><span class="line"><span class="type">int</span> EMSCRIPTEN_KEEPALIVE <span class="title function_">roll_dice</span><span class="params">()</span> &#123;</span><br><span class="line">    srand ( time(<span class="literal">NULL</span>) );</span><br><span class="line">    <span class="keyword">return</span> rand() % <span class="number">6</span> + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">然后用命令行工具定位到这个文件夹，执行：</span><br><span class="line">emcc index.c -s WASM=<span class="number">1</span> -O3 -o index.js</span><br><span class="line"></span><br><span class="line">等待片刻之后，你就能够看见生成了两个新文件：</span><br><span class="line">index.js</span><br><span class="line">index.wasm</span><br><span class="line"></span><br><span class="line">你可以用html引入这个index.js试试（index.wasm必须和index.js在同一路径下）</span><br><span class="line">vscode 使用 open with live server</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>WebAssembly 支持不仅限于 C、C++和 Rust。许多开发人员也在努力纳入对其他语言的支持。以下是当前支持的语言列表。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">C/C++</span><br><span class="line">Rust</span><br><span class="line">AssemblyScript（类似 TypeScript 的语法）</span><br><span class="line">C#</span><br><span class="line">F#</span><br><span class="line">Go</span><br><span class="line">Kotlin</span><br><span class="line">Swift</span><br><span class="line">D</span><br><span class="line">Pascal</span><br><span class="line">Zig</span><br></pre></td></tr></table></figure>Golang-webassembly编译及其错误解决<blockquote><p>出现”syscall/js”引入报错的时候（Build constraints exclude all the Go files in ‘E:/GoSdk/go1.18.1/src/syscall/js’），如下方式即可解决。详情参考：<a href="https://www.jetbrains.com/help/go/webassembly-project.html%E3%80%82">https://www.jetbrains.com/help/go/webassembly-project.html。</a></p></blockquote></li></ul><p><img src="/assets/img/202111111.png"><br><img src="/assets/img/202111112.png"></p><p>使用</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;syscall/js&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fibFunc</span><span class="params">(this js.Value, args []js.Value)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;我是Golang中的的方法&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">0</span>)</span><br><span class="line">   js.Global().Set(<span class="string">&quot;fibFunc&quot;</span>, js.FuncOf(fibFunc))</span><br><span class="line">   &lt;-done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行需要引入特定的js依赖。</p><blockquote><p>wasm_exec.js文件是框架自带的js驱动wasm(golang)的引擎<br>wasm_exec.html是自带的一个测试demo<br>别删了~~~</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E:\GoSdk\go1<span class="number">.18</span><span class="number">.1</span>\misc\wasm\wasm_exec.js</span><br><span class="line">E:\GoSdk\go1<span class="number">.18</span><span class="number">.1</span>\misc\wasm\wasm_exec.html   <span class="comment">//一个运行实例</span></span><br></pre></td></tr></table></figure><p>运行demo</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">目录结构</span><br><span class="line">/wasm_exec.js</span><br><span class="line">/wasm_exec.html</span><br><span class="line">/test.wasm</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">Copyright 2018 The Go Authors. All rights reserved.</span></span><br><span class="line"><span class="comment">Use of this source code is governed by a BSD-style</span></span><br><span class="line"><span class="comment">license that can be found in the LICENSE file.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Go wasm<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;wasm_exec.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">fibFunc</span>())&#125;,<span class="number">5000</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//这里是判断是否允许加载 wasm 文件的 JavaScript API</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (!<span class="title class_">WebAssembly</span>.<span class="property">instantiateStreaming</span>) &#123; <span class="comment">// polyfill</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title class_">WebAssembly</span>.<span class="property">instantiateStreaming</span> = <span class="keyword">async</span> (resp, importObject) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> source = <span class="keyword">await</span> (<span class="keyword">await</span> resp).<span class="title function_">arrayBuffer</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(source, importObject);</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> go = <span class="keyword">new</span> <span class="title class_">Go</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> mod, inst;</span></span><br><span class="line"><span class="language-javascript">        <span class="title class_">WebAssembly</span>.<span class="title function_">instantiateStreaming</span>(<span class="title function_">fetch</span>(<span class="string">&quot;test.wasm&quot;</span>), go.<span class="property">importObject</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            mod = result.<span class="property">module</span>;</span></span><br><span class="line"><span class="language-javascript">            inst = result.<span class="property">instance</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;runButton&quot;</span>).<span class="property">disabled</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">run</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">clear</span>();</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">await</span> go.<span class="title function_">run</span>(inst);</span></span><br><span class="line"><span class="language-javascript">            inst = <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(mod, go.<span class="property">importObject</span>); <span class="comment">// reset instance</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//代码是不会走到这里来的因为go main中阻塞了。</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&quot;run();&quot;</span> <span class="attr">id</span>=<span class="string">&quot;runButton&quot;</span> <span class="attr">style</span>=<span class="string">&quot;font-size: 100px;&quot;</span>&gt;</span>Run<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//Console</span><br><span class="line"></span><br><span class="line">Console was cleared</span><br><span class="line">我是Golang中的的方法</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
            <tag> webAssembly </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mac M1 flutter环境从装机到真机保姆级教程</title>
      <link href="/2021/10/02/20220625M1%E6%90%AD%E5%BB%BAflutter%E7%8E%AF%E5%A2%83/"/>
      <url>/2021/10/02/20220625M1%E6%90%AD%E5%BB%BAflutter%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<h2 id="flutter环境的安装"><a href="#flutter环境的安装" class="headerlink" title="flutter环境的安装"></a>flutter环境的安装</h2><h3 id="安装Android-Studio"><a href="#安装Android-Studio" class="headerlink" title="安装Android Studio"></a>安装Android Studio</h3><p>这个没什么好说的傻瓜式安装，需要注意的是Mac的可能会选择多个版本，M1一定要选<strong>arm</strong>架构的，这个很重要。</p><p>确保能运行一个空白的项目起来。</p><blockquote><p>解决flutterSDK找不到安卓环境</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vi ~/.bash_profile</span><br><span class="line">//添加</span><br><span class="line"><span class="built_in">export</span> ANDROID_SDK_ROOT=/usr/local/share/android-sdk</span><br></pre></td></tr></table></figure><h3 id="安装Flutter"><a href="#安装Flutter" class="headerlink" title="安装Flutter"></a>安装Flutter</h3><p>下载flutterSDK。M1一定要选择<strong>arm64</strong>的版本sdk！！！</p><blockquote><p>(<a href="https://docs.flutter.dev/development/tools/sdk/releases?tab=macos#macos">https://docs.flutter.dev/development/tools/sdk/releases?tab=macos#macos</a>)</p></blockquote><p>解压到某个目录，我这里解压的目录是</p><blockquote><p>/Users/bz/FlutterSDK</p></blockquote><p>导出环境变量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PUB_HOSTED_URL=https://pub.flutter-io.cn</span><br><span class="line"><span class="built_in">export</span> FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn</span><br><span class="line">// 上面两个为国内镜像，下面为sdk的环境变量</span><br><span class="line"><span class="built_in">export</span> PATH=/Users/bz/FlutterSDK/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><h3 id="解决重启电脑命令失效"><a href="#解决重启电脑命令失效" class="headerlink" title="解决重启电脑命令失效"></a>解决重启电脑命令失效</h3><p>完成了上面的步骤，现在在命令行运行flutter doctor应该是可以的。但是有个问题，当你重启电脑再次到命令行里面运行flutter doctor会提示命令不存在。</p><ul><li>向 ~/.bash_profile文件中添加（如果不存在就先创建）<blockquote><p>下面的 export PATH=/Users/bz/FlutterSDK/bin:$PATH 取决于你上面安装sdk的位置</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo vi ~/.bash_profile</span><br><span class="line">//添加如下</span><br><span class="line"><span class="built_in">export</span> PUB_HOSTED_URL=https://pub.flutter-io.cn</span><br><span class="line"><span class="built_in">export</span> FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn</span><br><span class="line"><span class="built_in">export</span> PATH=/Users/bz/FlutterSDK/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure></li><li>刷新此文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure></li><li>执行flutter doctor。</li></ul><blockquote><p>现在是每次开机都需要执行source ~/.bash_profile才能正常使用bash_profile里的命令</p></blockquote><ul><li>在~/.zshrc（如果没有就添加）添加 source ~/.bash_profile<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.zshrc</span><br><span class="line">//添加如下</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure></li></ul><h2 id="安装homebrew"><a href="#安装homebrew" class="headerlink" title="安装homebrew"></a>安装homebrew</h2><h3 id="安装方式一（推荐）"><a href="#安装方式一（推荐）" class="headerlink" title="安装方式一（推荐）"></a>安装方式一（推荐）</h3><p><a href="https://brew.idayer.com/">工具官网</a>，<a href="https://brew.idayer.com/guide/m1/">官网安装步骤</a>，<a href="https://juejin.cn/post/7088877842842255368">掘金教程</a></p><h4 id="脚本一键安装，安装目录为-opt-homebrew"><a href="#脚本一键安装，安装目录为-opt-homebrew" class="headerlink" title="脚本一键安装，安装目录为/opt/homebrew"></a>脚本一键安装，安装目录为/opt/homebrew</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash -c <span class="string">&quot;<span class="subst">$(curl -fsSL https://gitee.com/ineo6/homebrew-install/raw/master/install.sh)</span>&quot;</span></span><br></pre></td></tr></table></figure><h4 id="设置环境变量，仔细阅读。"><a href="#设置环境变量，仔细阅读。" class="headerlink" title="设置环境变量，仔细阅读。"></a>设置环境变量，仔细阅读。</h4><p>在终端执行命令echo $SHELL获得终端类型：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/bin/zsh =&gt; zsh =&gt; .zprofile</span><br><span class="line">/bin/bash =&gt; bash =&gt; .bash_profile</span><br></pre></td></tr></table></figure><ul><li>如果看到的是/bin/zsh<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;eval &quot;$(/opt/homebrew/bin/brew shellenv)&quot;&#x27;</span> &gt;&gt; ~/.zprofile</span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(/opt/homebrew/bin/brew shellenv)</span>&quot;</span></span><br></pre></td></tr></table></figure></li><li>如果看到的是/bin/bash<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;eval &quot;$(/opt/homebrew/bin/brew shellenv)&quot;&#x27;</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(/opt/homebrew/bin/brew shellenv)</span>&quot;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="安装方式二"><a href="#安装方式二" class="headerlink" title="安装方式二"></a>安装方式二</h3><h4 id="下载homebrew仓库"><a href="#下载homebrew仓库" class="headerlink" title="下载homebrew仓库"></a>下载homebrew仓库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /opt/Homebrew</span><br><span class="line">sudo git <span class="built_in">clone</span> https://mirrors.ustc.edu.cn/brew.git /opt/Homebrew</span><br></pre></td></tr></table></figure><h4 id="下载homebrew-core仓库"><a href="#下载homebrew-core仓库" class="headerlink" title="下载homebrew-core仓库"></a>下载homebrew-core仓库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /opt/Homebrew/Library/Taps/homebrew/homebrew-core</span><br><span class="line">sudo git <span class="built_in">clone</span> https://mirrors.ustc.edu.cn/homebrew-core.git /opt/Homebrew/Library/Taps/homebrew/homebrew-core</span><br></pre></td></tr></table></figure><h4 id="只将可执行文件放在PATH搜索路径中"><a href="#只将可执行文件放在PATH搜索路径中" class="headerlink" title="只将可执行文件放在PATH搜索路径中"></a>只将可执行文件放在PATH搜索路径中</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /opt/bin</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/opt/bin</span><br><span class="line">sudo <span class="built_in">ln</span> -s /opt/Homebrew/bin/brew /opt/bin/brew</span><br></pre></td></tr></table></figure><h4 id="var目录下存放锁"><a href="#var目录下存放锁" class="headerlink" title="var目录下存放锁"></a>var目录下存放锁</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /opt/var/Homebrew</span><br><span class="line"></span><br><span class="line">//该目录存放可能的配置文件，无则创建</span><br><span class="line">sudo <span class="built_in">mkdir</span> /opt/etc</span><br></pre></td></tr></table></figure><h4 id="改变目录权限"><a href="#改变目录权限" class="headerlink" title="改变目录权限"></a>改变目录权限</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> -R $(<span class="built_in">whoami</span>) /opt/Homebrew</span><br><span class="line">sudo <span class="built_in">chown</span> -R $(<span class="built_in">whoami</span>) /opt/etc</span><br></pre></td></tr></table></figure><h3 id="验证是否安装成功"><a href="#验证是否安装成功" class="headerlink" title="验证是否安装成功"></a>验证是否安装成功</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew update</span><br></pre></td></tr></table></figure><p>如果提示命令不存在，就在~/.bash_profile中添加，完了记得。source ~/.bash_profile</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//不一定是Homebrew 也可能是homebrew 或者 *** 具体看你自己情况</span><br><span class="line"><span class="built_in">export</span> PATH=/opt/Homebrew/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><blockquote><p>此路径取决于你安装的位置。/opt/Homebrew/bin目录下有个brew可执行文件，可以先执行./brew v 检查是否有问题，添加好了过后就执行</p></blockquote><h2 id="安装cocoapods"><a href="#安装cocoapods" class="headerlink" title="安装cocoapods"></a>安装cocoapods</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">brew install cocoapods</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://mirrors.tuna.tsinghua.edu.cn/git/CocoaPods/Specs.git ~/.cocoapods/repos/master</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>进入flutter项目的ios中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod install</span><br></pre></td></tr></table></figure><blockquote><p>中途拉库的时候可能会失败，然后重复拉<br>有可能会报错提示pod repo update，直接执行pod repo update就ok<br>老项目记得删除 Podfile.lock .</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> flutter </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flutter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在vue3中pinia页面刷新数据丢失的解决办法</title>
      <link href="/2021/09/20/20210920%E5%9C%A8vue3%E4%B8%ADpinia%E9%A1%B5%E9%9D%A2%E5%88%B7%E6%96%B0%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/"/>
      <url>/2021/09/20/20210920%E5%9C%A8vue3%E4%B8%ADpinia%E9%A1%B5%E9%9D%A2%E5%88%B7%E6%96%B0%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<p>pinia不多介绍。官方文档<a href="https://pinia.vuejs.org/introduction.html">https://pinia.vuejs.org/introduction.html</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install pinia@next</span><br></pre></td></tr></table></figure><p>在vue2中 插件 pinia-plugin-persist 可以辅助实现数据持久化功能。<a href="https://seb-l.github.io/pinia-plugin-persist/%E3%80%82">https://seb-l.github.io/pinia-plugin-persist/。</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i pinia-plugin-persist --save</span><br></pre></td></tr></table></figure><p>但是在这个插件只能在vue2中使用，vue3还未适配。。。</p><p>只有自己实现一个建议的状态存储了。</p><p>使用如下先创建一个简单的状态管理user.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&quot;pinia&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineStore</span>(&#123;</span><br><span class="line">   <span class="attr">id</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">   <span class="attr">state</span>: <span class="function">()=&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">mkey</span>:<span class="string">&quot;/home&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>:&#123;&#125;</span><br><span class="line">   &#125;),</span><br><span class="line">   <span class="attr">actions</span>:&#123;</span><br><span class="line">       <span class="title function_">countPlusOne</span>(<span class="params"></span>) &#123;</span><br><span class="line">         <span class="variable language_">this</span>.<span class="property">count</span>++;</span><br><span class="line">       &#125;,</span><br><span class="line">   &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>创建piniaPluginPersist.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;user&#125; <span class="keyword">from</span> <span class="string">&quot;@/store/index.js&quot;</span></span><br><span class="line"><span class="keyword">var</span> catchList=[</span><br><span class="line">   <span class="string">&quot;[object String]&quot;</span>,</span><br><span class="line">   <span class="string">&quot;[object Number]&quot;</span>,</span><br><span class="line">   <span class="string">&quot;[object Boolean]&quot;</span>,</span><br><span class="line">   <span class="string">&quot;[object Array]&quot;</span>,</span><br><span class="line">   <span class="string">&quot;[object Object]&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取对象集</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setPiniaObj</span>(<span class="params">stores=[]</span>)&#123;</span><br><span class="line">   <span class="keyword">var</span> itemsObj=&#123;&#125;  <span class="comment">//key模块名称,value模块对象</span></span><br><span class="line">   stores.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">var</span> key=item.<span class="property">$id</span></span><br><span class="line">      <span class="keyword">var</span> value=&#123;&#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> item)&#123;</span><br><span class="line">         <span class="keyword">if</span>(catchList.<span class="title function_">includes</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(item[k]))&amp;&amp;(k!=<span class="string">&quot;$id&quot;</span>))&#123;</span><br><span class="line">            value[k]=item[k]</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      itemsObj[key]=value</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">return</span> itemsObj</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">persistPinia</span> = (<span class="params"><span class="variable language_">window</span></span>) =&gt;&#123;</span><br><span class="line">   <span class="comment">//设置缓存</span></span><br><span class="line">   <span class="keyword">var</span> catchStore = sessionStorage.<span class="title function_">getItem</span>(<span class="string">&quot;_piniaPluginPersist&quot;</span>)</span><br><span class="line">   <span class="keyword">if</span>(catchStore)&#123;</span><br><span class="line">      catchStore=<span class="title class_">JSON</span>.<span class="title function_">parse</span>(catchStore)</span><br><span class="line">      <span class="keyword">var</span> storeArr = [<span class="title function_">user</span>()]</span><br><span class="line">      storeArr.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">         <span class="keyword">var</span> data=catchStore[item.<span class="property">$id</span>]</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> item)&#123;</span><br><span class="line">            <span class="keyword">if</span>(item[k]!==<span class="literal">undefined</span>&amp;&amp;(k!=<span class="string">&quot;$id&quot;</span>))&#123;item[k]=data[k]&#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      sessionStorage.<span class="title function_">removeItem</span>(<span class="string">&quot;_piniaPluginPersist&quot;</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//监听刷新</span></span><br><span class="line">   <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;beforeunload&quot;</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;222&quot;</span>)</span><br><span class="line">      <span class="keyword">var</span> storeObj=<span class="title function_">setPiniaObj</span>([<span class="title function_">user</span>()])</span><br><span class="line">      sessionStorage.<span class="title function_">setItem</span>(<span class="string">&quot;_piniaPluginPersist&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(storeObj))</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mainjs全局挂在函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; persistPinia &#125; <span class="keyword">from</span> <span class="string">&quot;@/utils/piniaPluginPersist.js&quot;</span></span><br><span class="line">app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">$persistPinia</span>=persistPinia</span><br></pre></td></tr></table></figure><p>在App.vue中使用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;getCurrentInstance , reactive &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> &#123; proxy &#125; = <span class="title function_">getCurrentInstance</span>();</span><br><span class="line">proxy.<span class="title function_">persistPinia</span>(<span class="variable language_">window</span>);</span><br></pre></td></tr></table></figure><p>解决</p>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
            <tag> vue </tag>
            
            <tag> pinia </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git游离(detached)分支解决</title>
      <link href="/2021/07/15/20210715git%E6%B8%B8%E7%A6%BB(detached)%E5%88%86%E6%94%AF%E8%A7%A3%E5%86%B3/"/>
      <url>/2021/07/15/20210715git%E6%B8%B8%E7%A6%BB(detached)%E5%88%86%E6%94%AF%E8%A7%A3%E5%86%B3/</url>
      
        <content type="html"><![CDATA[<p>报错内容大概为</p><blockquote><p>Git HEAD detached from XXX</p></blockquote><p>主要是看报错关键词detached</p><ul><li><p>查看当前分支状态（你自己冲突的可能是其他分支）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git branch</span><br><span class="line">* (HEAD detached at 925fda6)</span><br><span class="line">master</span><br></pre></td></tr></table></figure></li><li><p>新建一个临时 tem 分支，把当前提交的代码放到整个分支</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git branch tem</span><br><span class="line">git checkout tem</span><br></pre></td></tr></table></figure></li><li><p>换回要回到的那个分支，这里是 master</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout master</span><br></pre></td></tr></table></figure></li><li><p>然后 merge 刚才创建的临时分支</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git merge tem</span><br><span class="line">Updating cad0be9..2437c6b</span><br><span class="line">Fast-forward</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li><li><p>检查是否有冲突，没有就提交到远端</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">git push</span><br></pre></td></tr></table></figure></li><li><p>删除临时分支</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -d tem</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>有关parseInt第二个参数的一些问题</title>
      <link href="/2021/07/05/20210705%E6%9C%89%E5%85%B3parseInt%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/"/>
      <url>/2021/07/05/20210705%E6%9C%89%E5%85%B3parseInt%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>最近在网上看了一个面试题，如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>,<span class="string">&quot;3&quot;</span>].<span class="title function_">map</span>(<span class="built_in">parseInt</span>)</span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;1&quot;</span>,<span class="number">0</span>)</span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;2&quot;</span>,<span class="number">1</span>)</span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;3&quot;</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>相信答案不必多说</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>,<span class="title class_">NaN</span>,<span class="title class_">NaN</span>]</span><br></pre></td></tr></table></figure><p>那么问题来了，经过计算，2通过一进制解析是能得到数字的，3通过二进制解析也是是能得到数字的，为什么会是NaN呢？</p><p>分析如下：</p><p>parseInt(“3”,2)基数为2，合适的数字为0,1，但是3大于0和1，所以返回为NaN;</p><p>我又尝试了一些其他的数字，发现问题不止如此，出现了如下情况</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;16&quot;</span>,<span class="number">2</span>) <span class="comment">//1</span></span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;18&quot;</span>,<span class="number">2</span>) <span class="comment">//1</span></span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;19&quot;</span>,<span class="number">2</span>) <span class="comment">//1</span></span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;195&quot;</span>,<span class="number">2</span>) <span class="comment">//1</span></span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&quot;95&quot;</span>,<span class="number">2</span>) <span class="comment">//NaN</span></span><br></pre></td></tr></table></figure><p>因为基数为2，合适的数字只有0,1，所以走到了9或者8或者6就不会往后面继续解析直接返回，解析就停止了，实际解析的只有1，实际是在执行parseInt(“1”,2)</p><p>如果第一个都不符合那么直接返回NaN</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">parseInt</span>(<span class="string">&#x27;dsff984&#x27;</span>,<span class="number">16</span>)  <span class="comment">// 13</span></span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&#x27;d66&#x27;</span>,<span class="number">16</span>)  <span class="comment">// 3430</span></span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&#x27;ddff984&#x27;</span>,<span class="number">16</span>)  <span class="comment">// 14548838</span></span><br></pre></td></tr></table></figure><p>因为十进制最大的数字是9,但是到了十一进制往上，最大的数字是两位数了，这当然不行，所以从10开始往上，就用字母代替。</p><p>a==10,b==11,c=12,d=13  ……  z==35；所以parseInt的第二个参数必须要规定在2~36之间。注意还有个一进制</p><p>再看看上面这道问题，在16进制中，最大的数字是15，对应字母也就是f，超过f的字母也就超出了16进制的解析范围。</p><p>‘dsff984’的第一个字符是d，也就是十进制中的13，第二个字符s，代表十进制中的28，这显然超出了16进制的解析范围，所以s和它之后的字符都会被parseInt自动忽略，所以我们得到13。<br>‘d66’的第一个字符是d，也就是十进制中的13，(13<em>16²)+(6</em>16)+(6*16°)=3430<br>‘ddff984’ 参照上面</p><p>**parseInt(x,y)将y进制数x转化成普通数字(十进制)**如果x不是一个合格的y进制数就会采取措施，导致上面的情况，多提一句parseFloat只接受一个参数，只能使用十进制去解析。</p>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTP的进阶和理解</title>
      <link href="/2021/07/01/20210710HTTP%E7%9A%84%E8%BF%9B%E9%98%B6%E5%92%8C%E7%90%86%E8%A7%A3/"/>
      <url>/2021/07/01/20210710HTTP%E7%9A%84%E8%BF%9B%E9%98%B6%E5%92%8C%E7%90%86%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h3 id="GET和POST请求的区别"><a href="#GET和POST请求的区别" class="headerlink" title="GET和POST请求的区别"></a>GET和POST请求的区别</h3><ul><li>长度限制：GET会限制长度,POST不会</li><li>实际上 HTTP 协议规范并没有对 GET 方法请求的 url 长度进行限制，是浏览器及服务器的限制。</li><li>IE大约2083个字符，chrome大约 8192 个字符，其他浏览器大于 8192 个字符。主流的服务器对 get 方法中 url 的长度限制也大于等于8192个字符。</li><li>应用场景： GET 用于获取数据, POST 用于提交数据</li><li>安全性： GET 将参数放入 url 中，不太安全，因为url 会被保留在历史记录中。</li><li>报文格式： GET 请求的报文中实体部分为空，POST 请求的报文中实体部分为向发送的数据。</li><li>请求长度： GET 请求发送数据时的长度会根据浏览器的限制而不同。</li><li>是否缓存： 浏览器一般会对 GET 请求缓存，但很少对 POST 请求缓存。</li><li>参数类型： POST 的参数传递支持更多的数据类型。</li></ul><h3 id="HTTP，HTTP1-0，HTTP2-0-的部分区别"><a href="#HTTP，HTTP1-0，HTTP2-0-的部分区别" class="headerlink" title="HTTP，HTTP1.0，HTTP2.0 的部分区别"></a>HTTP，HTTP1.0，HTTP2.0 的部分区别</h3><p>超文本传输安全协议（Hypertext Transfer Protocol Secure，简称：HTTPS）是一种通过计算机网络进行安全通信的传输协议。HTTPS 经由 HTTP 进行通信，利用 SSL/TLS 来加密数据包。HTTPS 的主要目的是提供对网站服务器的身份认证，保护交换数据的隐私与完整性。</p><p>HTTP协议采用明文传输信息，存在信息窃听、信息篡改和信息劫持的风险，而协议TLS/SSL具有身份验证、信息加密和完整性校验的功能，可以避免此类问题发生。</p><p>安全层的主要职责就是对发起的 HTTP 请求的数据进行加密操作和对接收到的HTTP的内容进行解密操作。</p><h3 id="HTTPS是如何保证安全的"><a href="#HTTPS是如何保证安全的" class="headerlink" title="HTTPS是如何保证安全的"></a>HTTPS是如何保证安全的</h3><p>结合两种加密⽅式，将对称加密的密钥使⽤⾮对称加密的公钥进⾏加密，然后发送出去，接收⽅使⽤私钥进⾏解密得到对称加密的密钥，然后双⽅可以使⽤对称加密来进⾏沟通。<br>此时⼜带来⼀个问题，中间⼈问题：</p><p>如果此时在客户端和服务器之间存在⼀个中间⼈,这个中间⼈只需要把原本双⽅通信互发的公钥,换成⾃⼰的公钥,这样中间⼈就可以轻松解密通信双⽅所发送的所有数据。<br>所以这个时候需要⼀个安全的第三⽅颁发证书（CA），证明身份的身份，防⽌被中间⼈攻击。 证书中包括：签发者、证书⽤途、使⽤者公钥、使⽤者私钥、使⽤者的 Hash 算法、证书到期时间等。</p><p>但是问题来了，如果中间⼈篡改了证书，那么身份证明是不是就⽆效了？这个证明就⽩买了，这个时候需要⼀个新的技术，数字签名。</p><p>数字签名就是⽤ CA ⾃带的 Hash 算法对证书的内容进⾏ HASH 得到⼀个摘要，再⽤ CA 的私钥加密，最终组成数字签名。当别⼈把他的证书发过来的时候,我再⽤同样的 Hash 算法,再次⽣成消息摘要，然后⽤ CA 的公钥对数字签名解密,得到 CA 创建的消息摘要,两者⼀⽐,就知道中间有没有被⼈篡改了。这个时候就能最⼤程度保证通信的安全了。</p><h3 id="HTTP，HTTP1-0，HTTP2-0-的部分区别-1"><a href="#HTTP，HTTP1-0，HTTP2-0-的部分区别-1" class="headerlink" title="HTTP，HTTP1.0，HTTP2.0 的部分区别"></a>HTTP，HTTP1.0，HTTP2.0 的部分区别</h3><p>队头阻塞是由 HTTP 基本的“请求 - 应答”模型所导致的。HTTP 规定报文必须是“一发一收”，这就形成了一个先进先出的“串行”队列。队列里的请求是没有优先级的，只有入队的先后顺序，排在最前面的请求会被最优先处理。如果队首的请求因为处理的太慢耽误了时间，那么队列里后面的所有请求也不得不跟着一起等待，结果就是其他的请求承担了不应有的时间成本，造成了队头堵塞的现象。</p><h3 id="HTTP和HTTPS请求的区别"><a href="#HTTP和HTTPS请求的区别" class="headerlink" title="HTTP和HTTPS请求的区别"></a>HTTP和HTTPS请求的区别</h3><ul><li>HTTP 协议信息是明文传输的，HTTPS 则是具有安全性的 SSL 加密传输协议；</li><li>HTTP 协议端口是 80，HTTPS 协议端口是 443；</li><li>HTTP 协议连接很简单，是无状态的；HTTPS 协议是有 SSL 和 HTTP 协议构建的可进行加密传输、身份认证的网络协议，比 HTTP 更加安全。</li></ul><h3 id="HTTP状态码"><a href="#HTTP状态码" class="headerlink" title="HTTP状态码"></a>HTTP状态码</h3><table><thead><tr><th>类别</th><th>原因</th><th>描述</th></tr></thead><tbody><tr><td>1xx</td><td>Informational(信息性状态码)</td><td>接受的请求正在处理</td></tr><tr><td>2xx</td><td>Success(成功状态码)</td><td>请求正常处理完毕</td></tr><tr><td>3xx</td><td>Redirection(重定向状态码)</td><td>需要进行附加操作一完成请求</td></tr><tr><td>4xx</td><td>Client Error (客户端错误状态码)</td><td>服务器无法处理请求</td></tr><tr><td>5xx</td><td>Server Error(服务器错误状态码)</td><td>服务器处理请求出错</td></tr></tbody></table><ul><li>200 OK 表示客户端发来的请求被服务器端正常处理了。</li><li>204 No Content 表示客户端发送的请求已经在服务器端正常处理了，但是没有返回的内容，响应报文中不包含实体的主体部分。一般在只需要从客户端往服务器端发送信息，而服务器端不需要往客户端发送内容时使用。</li><li>206 Partial Content 表示客户端进行了范围请求，而服务器端执行了这部分的 GET 请求。响应报文中包含由 Content-Range 指定范围的实体内容。</li><li>301 永久重定向 表示请求的资源已经被分配了新的 URI，以后应使用资源指定的 URI。新的 URI 会在 HTTP 响应头中的 Location 首部字段指定。若用户已经把原来的URI保存为书签，此时会按照 Location 中新的URI重新保存该书签。同时，搜索引擎在抓取新内容的同时也将旧的网址替换为重定向之后的网址。使用场景<ul><li>当我们想换个域名，旧的域名不再使用时，用户访问旧域名时用301就重定向到新的域名。其实也是告诉搜索引擎收录的域名需要对新的域名进行收录。</li><li>在搜索引擎的搜索结果中出现了不带www的域名，而带www的域名却没有收录，这个时候可以用301重定向来告诉搜索引擎我们目标的域名是哪一个。</li></ul></li><li>302 临时重定向 表示请求的资源被分配到了新的 URI，希望用户（本次）能使用新的 URI 访问资源。和 301 Moved Permanently 状态码相似，但是 302 代表的资源不是被永久重定向，只是临时性质的。也就是说已移动的资源对应的 URI 将来还有可能发生改变。若用户把 URI 保存成书签，但不会像 301 状态码出现时那样去更新书签，而是仍旧保留返回 302 状态码的页面对应的 URI。同时，搜索引擎会抓取新的内容而保留旧的网址。因为服务器返回302代码，搜索引擎认为新的网址只是暂时的。使用场景<ul><li>当我们在做活动时，登录到首页自动重定向，进入活动页面。</li><li>未登陆的用户访问用户中心重定向到登录页面。</li><li>访问404页面重新定向到首页。</li></ul></li><li>304 Not Modified 浏览器缓存相关。 表示客户端发送附带条件的请求时，服务器端允许请求访问资源，但未满足条件的情况。</li><li>304 状态码返回时，不包含任何响应的主体部分。304 虽然被划分在 3XX 类别中，但是和重定向没有关系。带条件的请求（HTTP 条件请求）：使用 GET方法 请求，请求报文中包含（if-match、if-none-match、if-modified-since、if-unmodified-since、if-range）中任意首部。</li><li>304并不是一种错误，而是告诉客户端有缓存，直接使用缓存中的数据。返回页面的只有头部信息，是没有内容部分的，这样在一定程度上提高了网页的性能。</li><li>400 Bad Request 表示请求报文中存在语法错误。当错误发生时，需修改请求的内容后再次发送请求。另外，浏览器会像 200 OK 一样对待该状态码。</li><li>401 Unauthorized 表示发送的请求需要有通过 HTTP 认证(BASIC 认证、DIGEST 认证)的认证信息。若之前已进行过一次请求，则表示用户认证失败, 比如登录失败</li><li>403 Forbidden 表示请求资源的访问被服务器拒绝了，服务器端没有必要给出详细理由，但是可以在响应报文实体的主体中进行说明。进入该状态后，不能再继续进行验证。该访问是永久禁止的，并且与应用逻辑密切相关。</li><li>404 Not Found 表示服务器上无法找到请求的资源。</li><li>405 Method Not Allowed 表示客户端请求的方法虽然能被服务器识别，但是服务器禁止使用该方法。客户端可以通过 OPTIONS 方法（预检）来查看服务器允许的访问方法, 如下Access-Control-Allow-Methods: GET,HEAD,PUT,PATCH,POST,DELETE</li><li>500 Internal Server Error 表示服务器端在执行请求时发生了错误。例如出现了 Bug</li><li>502 Bad Gateway 表示扮演网关或代理角色的服务器，从上游服务器中接收到的响应是无效的。注意，502 错误通常不是客户端能够修复的，而是需要由途经的 Web 服务器或者代理服务器对其进行修复。以下情况会出现502：</li><li>503 Service Unavailable 表示服务器暂时处于超负载或正在进行停机维护，现在无法处理请求。使用场景：<ul><li>服务器停机维护时，主动用503响应请求；</li><li>nginx 设置限速，超过限速，会返回503。</li></ul></li><li>504 Gateway Timeout 表示网关或者代理的服务器无法在规定的时间内获得想要的响应。他是HTTP 1.1中新加入的。使用场景：代码执行时间超时，或者发生了死循环。</li></ul><h3 id="浏览器中输入URL按下回车后发生了什么"><a href="#浏览器中输入URL按下回车后发生了什么" class="headerlink" title="浏览器中输入URL按下回车后发生了什么"></a>浏览器中输入URL按下回车后发生了什么</h3><p>解析URL： 首先会对 URL 进行解析，分析所需要使用的传输协议和请求的资源的路径。会对非法字符进行转义</p><p>缓存判断： 如果存在有效的缓存, 就直接使用缓存，否则向服务器发起新的请求。</p><p>DNS解析： 此步骤主要是获取IP地址, 具体步骤：本地是否有缓存-&gt;否-&gt;本地 DNS 服务器是否有缓存-&gt;否-&gt;向根域名服务器发起请求-&gt;得到IP地址</p><p>获取MAC地址： 获取目标网址的 MAC( 局域网地址) 地址, 主要是需要判断目标地址与当前机器是否在同一个子网, 不在就需要网关转发。<br>TCP三次握手： 建立 TCP 连接。</p><p>HTTPS握手： 如果使用的是 HTTPS 协议，在通信前还存在 TLS 的一个四次握手的过程。首先由客户端向服务器端发送使用的协议的版本号、一个随机数和可以使用的加密方法。服务器端收到后，确认加密的方法，也向客户端发送一个随机数和自己的数字证书。客户端收到后，首先检查数字证书是否有效，如果有效，则再生成一个随机数，并使用证书中的公钥对随机数加密，然后发送给服务器端，并且还会提供一个前面所有内容的 hash 值供服务器端检验。服务器端接收后，使用自己的私钥对数据解密，同时向客户端发送一个前面所有内容的 hash 值供客户端检验。这个时候双方都有了三个随机数，按照之前所约定的加密方法，使用这三个随机数生成一把秘钥，以后双方通信前，就使用这个秘钥对数据进行加密后再传输。下面看详解</p><p>返回数据： 当页面请求发送到服务器端后，服务器端会返回一个 html 文件作为响应，浏览器接收到响应后，开始对 html 文件进行解析，开始页面的渲染过程。</p><p>页面渲染： 浏览器首先会根据 html 文件构建 DOM 树，根据解析到的 css 文件构建 CSSOM 树，如果遇到 script 标签，则判端是否含有 defer 或者 async 属性，要不然 script 的加载和执行会造成页面的渲染的阻塞。当 DOM 树和 CSSOM 树建立好后，根据它们来构建渲染树。渲染树构建好后，会根据渲染树来进行布局。布局完成后，最后使用浏览器的 UI 接口对页面进行绘制。这个时候整个页面就显示出来了。</p><p>TCP四次挥手： 最后一步是 TCP 断开连接的四次挥手过程。若客户端认为数据发送完成，则它需要向服务端发送连接释放请求。服务端收到连接释放请求后，会告诉应用层要释放 TCP 链接。然后会发送 ACK 包，并进入 CLOSE_WAIT 状态，此时表明客户端到服务端的连接已经释放，不再接收客户端发的数据了。但是因为 TCP 连接是双向的，所以服务端仍旧可以发送数据给客户端。服务端如果此时还有没发完的数据会继续发送，完毕后会向客户端发送连接释放请求，然后服务端便进入 LAST-ACK 状态。客户端收到释放请求后，向服务端发送确认应答，此时客户端进入 TIME-WAIT 状态。该状态会持续 2MSL（最大段生存期，指报文段在网络中生存的时间，超时会被抛弃） 时间，若该时间段内没有服务端的重发请求的话，就进入 CLOSED 状态。当服务端收到确认应答后，也便进入 CLOSED 状态。</p><h3 id="HTTPS通信-握手-过程"><a href="#HTTPS通信-握手-过程" class="headerlink" title="HTTPS通信(握手)过程"></a>HTTPS通信(握手)过程</h3><p>客户端向服务器发起请求，请求中包含使用的协议版本号、生成的一个随机数、以及客户端支持的加密方法。<br>服务器端接收到请求后，确认双方使用的加密方法、并给出服务器的证书、以及一个服务器生成的随机数。<br>客户端确认服务器证书有效后，生成一个新的随机数，并使用数字证书中的公钥，加密这个随机数，然后发给服 务器。并且还会提供一个前面所有内容的 hash 的值，用来供服务器检验。<br>服务器使用自己的私钥，来解密客户端发送过来的随机数。并提供前面所有内容的 hash 值来供客户端检验。<br>客户端和服务器端根据约定的加密方法使用前面的三个随机数，生成对话秘钥，以后的对话过程都使用这个秘钥来加密信息。</p><h3 id="HTTP三次握手"><a href="#HTTP三次握手" class="headerlink" title="HTTP三次握手"></a>HTTP三次握手</h3><p>三次握手（Three-way Handshake）其实就是指建立一个 TCP 连接时，需要客户端和服务器总共发送3个包。进行三次握手的主要作用就是为了确认双方的接收能力和发送能力是否正常、指定自己的初始化序列号为后面的可靠性传送做准备。实质上其实就是连接服务器指定端口，建立 TCP 连接，并同步连接双方的序列号和确认号，交换 TCP 窗口大小信息。<br>刚开始客户端处于 Closed 的状态，服务端处于 Listen 状态。<br>第一次握手： 客户端给服务端发一个 SYN 报文，并指明客户端的初始化序列号 ISN，此时客户端处于 SYN_SEND 状态。<br>第二次握手： 服务器收到客户端的 SYN 报文之后，会以自己的 SYN 报文作为应答，并且也是指定了自己的初始化序列号 ISN。同时会把客户端的 ISN + 1 作为ACK 的值，表示自己已经收到了客户端的 SYN，此时服务器处于 SYN_REVD 的状态。<br>第三次握手： 客户端收到 SYN 报文之后，会发送一个 ACK 报文，当然，也是一样把服务器的 ISN + 1 作为 ACK 的值，表示已经收到了服务端的 SYN 报文，此时客户端处于 ESTABLISHED 状态。服务器收到 ACK 报文之后，也处于 ESTABLISHED 状态，此时，双方已建立起了连接。<br>那为什么要三次握手呢？两次不行吗？<br>为了确认双方的接收能力和发送能力都正常<br>如果是用两次握手，则会出现下面这种情况：</p><blockquote><p>如客户端发出连接请求，但因连接请求报文丢失而未收到确认，于是客户端再重传一次连接请求。后来收到了确认，建立了连接。数据传输完毕后，就释放了连接，客户端共发出了两个连接请求报文段，其中第一个丢失，第二个到达了服务端，但是第一个丢失的报文段只是在某些网络结点长时间滞留了，延误到连接释放以后的某个时间才到达服务端，此时服务端误认为客户端又发出一次新的连接请求，于是就向客户端发出确认报文段，同意建立连接，不采用三次握手，只要服务端发出确认，就建立新的连接了，此时客户端忽略服务端发来的确认，也不发送数据，则服务端一致等待客户端发送数据，浪费资源。</p></blockquote><p>TCP 三次握手的建立连接的过程就是相互确认初始序号的过程，告诉对方，什么样序号的报文段能够被正确接收。 第三次握手的作用是客户端对服务器端的初始序号的确认。如果只使用两次握手，那么服务器就没有办法知道自己的序号是否已被确认。同时这样也是为了防止失效的请求报文段被服务器接收，而出现错误的情况。</p><h3 id="HTTP四次挥手"><a href="#HTTP四次挥手" class="headerlink" title="HTTP四次挥手"></a>HTTP四次挥手</h3><p>第一次挥手： 客户端会发送一个 FIN 报文，报文中会指定一个序列号。此时客户端处于 FIN_WAIT1 状态。</p><blockquote><p>即发出连接释放报文段（FIN=1，序号seq=u），并停止再发送数据，主动关闭TCP连接，进入FIN_WAIT1（终止等待1）状态，等待服务端的确认。</p></blockquote><p>第二次挥手： 服务端收到 FIN 之后，会发送 ACK 报文，且把客户端的序列号值 +1 作为 ACK 报文的序列号值，表明已经收到客户端的报文了，此时服务端处于 CLOSE_WAIT 状态。</p><blockquote><p>即服务端收到连接释放报文段后即发出确认报文段（ACK=1，确认号ack=u+1，序号seq=v），服务端进入CLOSE_WAIT（关闭等待）状态，此时的TCP处于半关闭状态，客户端到服务端的连接释放。客户端收到服务端的确认后，进入FIN_WAIT2（终止等待2）状态，等待服务端发出的连接释放报文段。</p></blockquote><p>第三次挥手： 如果服务端也想断开连接了，和客户端的第一次挥手一样，发给 FIN 报文，且指定一个序列号。此时服务端处于 LAST_ACK 的状态。</p><blockquote><p>即服务端没有要向客户端发出的数据，服务端发出连接释放报文段（FIN=1，ACK=1，序号seq=w，确认号ack=u+1），服务端进入LAST_ACK（最后确认）状态，等待客户端的确认。</p></blockquote><p>第四次挥手： 客户端收到 FIN 之后，一样发送一个 ACK 报文作为应答，且把服务端的序列号值 +1 作为自己 ACK 报文的序列号值，此时客户端处于 TIME_WAIT 状态。需要过一阵</p><blockquote><p>以确保服务端收到自己的 ACK 报文之后才会进入 CLOSED 状态，服务端收到 ACK 报文之后，就处于关闭连接了，处于 CLOSED 状态。即客户端收到服务端的连接释放报文段后，对此发出确认报文段（ACK=1，seq=u+1，ack=w+1），客户端进入TIME_WAIT（时间等待）状态。此时TCP未释放掉，需要经过时间等待计时器设置的时间2MSL后，客户端才进入CLOSED状态。</p></blockquote><p>为什么需要四次挥手呢？</p><p>因为当服务端收到客户端的SYN连接请求报文后，可以直接发送SYN+ACK报文。其中ACK报文是用来应答的，SYN报文是用来同步的。但是关闭连接时，当服务端收到FIN报文时，很可能并不会立即关闭SOCKET，所以只能先回复一个ACK报文，告诉客户端，“你发的FIN报文我收到了”。只有等到我服务端所有的报文都发送完了，我才能发送FIN报文，因此不能一起发送，故需要四次挥手。</p><p>TCP 使用四次挥手的原因是因为 TCP 的连接是全双工的，所以需要双方分别释放到对方的连接，单独一方的连接释放，只代表不能再向对方发送数据，连接处于的是半释放的状态。<br>最后一次挥手中，客户端会等待一段时间再关闭的原因，是为了防止发送给服务器的确认报文段丢失或者出错，从而导致服务器端不能正常关闭。</p>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web前端 </tag>
            
            <tag> http </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端对二进制深入剖析</title>
      <link href="/2021/06/01/20210601%E5%89%8D%E7%AB%AF%E5%AF%B9%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%9A%84%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/"/>
      <url>/2021/06/01/20210601%E5%89%8D%E7%AB%AF%E5%AF%B9%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%9A%84%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<p>自我感觉一直对浏览器的二进制操作比,文件操作,以及其他的io读写等较迷糊。今天开个专场彻底搞清。</p><h3 id="blob"><a href="#blob" class="headerlink" title="blob"></a>blob</h3><p>Blob 对象表示一个不可变、原始数据的类文件对象。Blob 表示的不一定是JavaScript原生格式的数据。Blob对象本质上是js中的一个对象，里面可以储存大量的二进制编码格式的数据，<strong>我们不可以直接操作他</strong>。</p><h4 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h4><p>var aBlob = new Blob( array, options );</p><ul><li>array .可以是如下<ul><li>ArrayBuffer</li><li>ArrayBufferView</li><li>Blob</li><li>DOMString(DOMStrings 会被编码为 UTF-8。)</li></ul></li><li>options 是一个可选的BlobPropertyBag字典，它可能会指定如下两个属性<ul><li>type，默认值为 “”，它代表了将会被放入到 blob 中的数组内容的 MIME 类型。</li><li>endings，默认值为”transparent”，用于指定包含行结束符\n的字符串如何被写入。它是以下两个值中的一个：”native”，代表行结束符会被更改为适合宿主操作系统文件系统的换行符，或者 “transparent”，代表会保持 blob 中保存的结束符不变 非标准<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> aFileParts = [<span class="string">&#x27;&lt;a id=&quot;a&quot;&gt;&lt;b id=&quot;b&quot;&gt;hey!&lt;/b&gt;&lt;/a&gt;&#x27;</span>]; <span class="comment">// 一个包含 DOMString 的数组</span></span><br><span class="line"><span class="keyword">var</span> oMyBlob = <span class="keyword">new</span> <span class="title class_">Blob</span>(aFileParts, &#123;type : <span class="string">&#x27;text/html&#x27;</span>&#125;); <span class="comment">// 得到 blob</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = &#123;<span class="attr">hello</span>: <span class="string">&#x27;我tm看看行不行&#x27;</span>&#125;;</span><br><span class="line"><span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj)],&#123;<span class="attr">type</span>:<span class="string">&#x27;application/json&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">32</span>);</span><br><span class="line"><span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([ab]); <span class="comment">// 注意必须包裹[]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//base64转Blob</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dataURLtoBlob</span>(<span class="params">base64Str</span>) &#123;</span><br><span class="line"><span class="comment">// data:image/jpeg;base64,/9j/4AAQSkZJR...</span></span><br><span class="line"><span class="keyword">var</span> arr =base64Str.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>),</span><br><span class="line">mime = arr[<span class="number">0</span>].<span class="title function_">match</span>(<span class="regexp">/:(.*?);/</span>)[<span class="number">1</span>],</span><br><span class="line">bstr = <span class="title function_">atob</span>(arr[<span class="number">1</span>]),  <span class="comment">//atob() //ASCII to Base64  ,  btoa() //Base64 to ASCII</span></span><br><span class="line">n = bstr.<span class="property">length</span>,</span><br><span class="line">u8arr = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(n);</span><br><span class="line"><span class="keyword">while</span> (n--) &#123;</span><br><span class="line">u8arr[n] = bstr.<span class="title function_">charCodeAt</span>(n);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Blob</span>([u8arr], &#123; <span class="attr">type</span>: mime &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//还有读出的文件</span></span><br></pre></td></tr></table></figure>demo<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;<span class="attr">hello</span>: <span class="string">&#x27;我tm看看行不行&#x27;</span>&#125;;</span><br><span class="line"><span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj)],&#123;<span class="attr">type</span>:<span class="string">&#x27;application/json&#x27;</span>&#125;);</span><br></pre></td></tr></table></figure><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4></li></ul></li><li>Blob.prototype.size 只读。Blob 对象中所包含数据的大小（字节）。</li><li>Blob.prototype.type 只读。一个字符串，表明该 Blob 对象所包含数据的 MIME 类型。如果类型未知，则该值为空字符串。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(blob.<span class="property">size</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(blob.<span class="property">tpye</span>)</span><br></pre></td></tr></table></figure></li></ul><h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><ul><li>Blob.prototype.text() 返回一个 promise，其会兑现一个包含 Blob 所有内容的 UTF-8 格式的字符串。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">blob.<span class="title function_">text</span>().<span class="title function_">then</span>(<span class="params">t=&gt;<span class="variable language_">console</span>.log(t)</span>)</span><br><span class="line">&#123;<span class="string">&quot;hello&quot;</span>:<span class="string">&quot;我tm看看行不行&quot;</span>&#125;</span><br></pre></td></tr></table></figure></li><li>Blob.prototype.slice() 返回一个新的 Blob 对象，包含了源 Blob 对象中指定范围内的数据。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> b=blob.<span class="title function_">slice</span>(<span class="number">0</span>,<span class="number">18</span>)</span><br><span class="line">b.<span class="title function_">text</span>().<span class="title function_">then</span>(<span class="params">t=&gt;<span class="variable language_">console</span>.log(t)</span>)</span><br><span class="line">&#123;<span class="string">&quot;hello&quot;</span>:<span class="string">&quot;我tm看</span></span><br></pre></td></tr></table></figure></li><li>Blob.prototype.arrayBuffer() 返回一个 promise，其会兑现一个包含 Blob 所有内容的二进制格式的 <strong>ArrayBuffer</strong> （下面详解）。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bufferPromise = blob.<span class="title function_">arrayBuffer</span>();</span><br><span class="line">blob.<span class="title function_">arrayBuffer</span>().<span class="title function_">then</span>(<span class="function"><span class="params">buffer</span> =&gt;</span> <span class="comment">/* 处理 ArrayBuffer 数据的代码……*/</span>);</span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">await</span> blob.<span class="title function_">arrayBuffer</span>();</span><br></pre></td></tr></table></figure></li><li>Blob.prototype.stream() 返回一个能读取 Blob 内容的 ReadableStream。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stream= blob.<span class="title function_">stream</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stream)</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">Response</span>(stream,&#123;<span class="attr">headers</span>:&#123;<span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;text/html&#x27;</span> &#125;&#125;).<span class="title function_">text</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">text</span>=&gt;</span>&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(text)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li></ul><h3 id="File"><a href="#File" class="headerlink" title="File"></a>File</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=<span class="string">&quot;file&quot;</span> id=<span class="string">&quot;file&quot;</span>&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;img&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#file&quot;</span>).<span class="title function_">addEventListener</span>(<span class="string">&quot;change&quot;</span>, <span class="keyword">function</span> (<span class="params">File</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="property">target</span>.<span class="property">files</span>[<span class="number">0</span>])</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">getFile</span>(<span class="title class_">File</span>.<span class="property">target</span>.<span class="property">files</span>[<span class="number">0</span>])</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">function</span> <span class="title function_">getFile</span>(<span class="params">File</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="property">lastModified</span>)      <span class="comment">//返回当前 File 对象所引用文件最后修改时间，自 UNIX 时间起始值（1970 年 1 月 1 日 00:00:00 UTC）以来的毫秒数。</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="property">lastModifiedDate</span>)  <span class="comment">//返回当前 File 对象所引用文件最后修改时间的 Date 对象。</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="property">name</span>)              <span class="comment">//返回当前 File 对象所引用文件的名字。</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="property">size</span>)              <span class="comment">//返回文件的大小。</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="property">webkitRelativePath</span>)<span class="comment">//返回 File 相关的 path 或 URL。</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="property">type</span>)              <span class="comment">//返回文件的 多用途互联网邮件扩展类型（MIME Type）由第三个参数中的type决定</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="comment">///File 接口没有定义任何方法，但是它从 Blob 接口继承了以下方法</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">File</span>.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="number">1000</span>))<span class="comment">//</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">1664593283489</span></span><br><span class="line"><span class="language-xml">Sat Oct 01 2022 11:01:23 GMT+0800 (中国标准时间)</span></span><br><span class="line"><span class="language-xml">1.jpg</span></span><br><span class="line"><span class="language-xml">123637</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">image/jpeg</span></span><br><span class="line"><span class="language-xml">Blob &#123;size: 1000, type: &#x27;&#x27;&#125;</span></span><br></pre></td></tr></table></figure><h3 id="FileReader"><a href="#FileReader" class="headerlink" title="FileReader"></a>FileReader</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">File</span> = <span class="keyword">new</span> <span class="title class_">File</span>([],<span class="string">&quot;./imgs/1.jpg&quot;</span>,&#123;<span class="attr">type</span>:<span class="string">&quot;image/jpg&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printFile</span>(<span class="params">file</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span><br><span class="line">  reader.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params">evt</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(evt);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(reader.<span class="property">error</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(reader.<span class="property">readyState</span>);<span class="comment">//0还没有加载任何数据。1数据正在被加载。2已完成全部的读取请求。</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(reader.<span class="property">result</span>);<span class="comment">///===evt.target.result</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>readAsArrayBuffer(blob/File)<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ProgressEvent</span> &#123;<span class="attr">isTrusted</span>: <span class="literal">true</span>, <span class="attr">lengthComputable</span>: <span class="literal">true</span>, <span class="attr">loaded</span>: <span class="number">123637</span>, <span class="attr">total</span>: <span class="number">123637</span>, <span class="attr">type</span>: <span class="string">&#x27;load&#x27;</span>, …&#125;</span><br><span class="line"><span class="literal">null</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="title class_">ArrayBuffer</span>(<span class="number">123637</span>)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ProgressEvent</span> &#123;<span class="attr">isTrusted</span>: <span class="literal">true</span>, <span class="attr">lengthComputable</span>: <span class="literal">true</span>, <span class="attr">loaded</span>: <span class="number">123637</span>, <span class="attr">total</span>: <span class="number">123637</span>, <span class="attr">type</span>: <span class="string">&#x27;load&#x27;</span>, …&#125;</span><br><span class="line"><span class="literal">null</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="title class_">ArrayBuffer</span>(<span class="number">123637</span>)</span><br></pre></td></tr></table></figure></li><li>readAsBinaryString(blob/File) 该特性是非标准的，请尽量不要在生产环境中使用它！</li><li>readAsDataURL(blob/File) 读出base64<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ProgressEvent</span> &#123;<span class="attr">isTrusted</span>: <span class="literal">true</span>, <span class="attr">lengthComputable</span>: <span class="literal">true</span>, <span class="attr">loaded</span>: <span class="number">2233</span>, <span class="attr">total</span>: <span class="number">2233</span>, <span class="attr">type</span>: <span class="string">&#x27;load&#x27;</span>, …&#125;</span><br><span class="line"><span class="literal">null</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="attr">data</span>:application/octet-stream;base64,/u3+7QAAAAIAAAABAAAAAQAGMTIzNDU2AAABc1Z=</span><br></pre></td></tr></table></figure></li><li>readAsText(blob/File) 读出字符串</li></ul><h3 id="ArrayBuffer"><a href="#ArrayBuffer" class="headerlink" title="ArrayBuffer"></a>ArrayBuffer</h3><p>ArrayBuffer表示二进制数据的原始缓冲区，用于存储不同类型化数组的数据。<strong>我们无法直接读取或写入 ArrayBuffer</strong>，但是可以根据需要将其传递到类型化数组 TypedArray 或 DataView 视图来操作二进制数据</p><p>浏览器中以现有数据获取 ArrayBuffer 或者创建一个空buffer</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;<span class="attr">hello</span>: <span class="string">&#x27;我tm看看行不行&#x27;</span>&#125;;</span><br><span class="line"><span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj)],&#123;<span class="attr">type</span>:<span class="string">&#x27;application/json&#x27;</span>&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(blob.<span class="property">buffer</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b0 =  <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;bwGO8X5gdaM5dsV@&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b0)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">0x15</span>,<span class="number">0xFF</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x34</span>,<span class="number">0xAB</span>,<span class="number">0x11</span>];</span><br><span class="line"><span class="keyword">var</span> u8 = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(arr);</span><br><span class="line"><span class="keyword">var</span> ab = u8.<span class="property">buffer</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ab); <span class="comment">// ab为要解析的ArrayBuffer</span></span><br></pre></td></tr></table></figure><p>以其他现有数据获取查看文档<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">MDN传送门</a></p><ul><li>length，缓冲区的长度，每个字节的值默认都是0。如果无法分配请求数目的字节，则将引发异常。</li><li>byteLength。 只读属性，用于获取到ArrayBuffer实例的长度（以字节为单位）。 如果分配的内存较大，可能会分配失败，所以可以通过校验长度来判断是否分配成功。</li><li>slice()。将内存区域的一部分，拷贝生成一个新的ArrayBuffer对象，与blob的slice方式类似。除了slice方法，ArrayBuffer对象不提供任何直接读写内存的方法，只允许在其上方建立视图，然后通过视图进行读写。</li><li>isView()。这是个静态方法！返回一个布尔值。表示参数是否为ArrayBuffer的视图实例，即是否为TypedArray或DataView实例。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="title class_">ArrayBuffer</span>.<span class="title function_">isView</span>(buffer) <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> file = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;file&quot;</span>).<span class="property">files</span>[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span><br><span class="line">reader.<span class="title function_">readAsArrayBuffer</span>(file)</span><br><span class="line">reader.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> data = e.<span class="property">target</span>.<span class="property">result</span>; </span><br><span class="line">    <span class="title class_">ArrayBuffer</span>.<span class="title function_">isView</span>(data) <span class="comment">// false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> i32 = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(buffer);</span><br><span class="line"><span class="title class_">ArrayBuffer</span>.<span class="title function_">isView</span>(i32) <span class="comment">// true</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="ReadableStream"><a href="#ReadableStream" class="headerlink" title="ReadableStream"></a>ReadableStream</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream/ReadableStream">ReadableStream</a>这个用的不是很我也只是了解下，做个记录，需要的时候在回来看看文档。😳</p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Streams_API">流操作API</a>中的ReadableStream 接口呈现了一个可读取的二进制流操作。</p><ul><li>ReadableStream.locked。一个可读流最多可以有一个激活的 reader，并且直到被释放之前都是锁定到该 reader。可以使用 ReadableStream.getReader() 方法获取 reader 然后使用 reader 的 releaseLock() 方法释放可读流。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> stream = <span class="keyword">new</span> <span class="title class_">ReadableStream</span>(&#123;...&#125;);</span><br><span class="line"><span class="keyword">const</span> reader = stream.<span class="title function_">getReader</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stream.<span class="property">locked</span>)</span><br><span class="line"><span class="comment">// 应返回 true，表示流已经锁定到了一个 reader</span></span><br></pre></td></tr></table></figure></li><li>getReader() 接口的 getReader() 方法会创建一个 reader，并将流锁定。只有当前 reader 将流释放后，其他 reader 才能使用。</li><li>cancel() 用于在不再需要来自它的任何数据的情况下（即使仍有排队等待的数据块）完全结束一个流。</li><li>pipeThrough() 方法提供了一种链式的方式，将当前流通过转换流或者其它任何一对可写/可读的流进行管道传输。</li><li>pipeTo() 方法通过管道将当前的 ReadableStream 中的数据传递给给定的 WritableStream 并且返回一个 Promise，promise 在传输成功完成时兑现，在遇到任何错误时则会被拒绝。</li><li>tee() 方法对当前的可读流进行拷贝（tees），返回包含两个 ReadableStream 实例分支的数组。<br>简单示例<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;http://127.0.0.1:8080/ping&#x27;</span>)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// response.text().then(res=&gt;&#123;console.log(res)&#125;)//可以直接取值，但是下面要演示</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(response)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">body: ReadableStream</span></span><br><span class="line"><span class="comment">bodyUsed: true</span></span><br><span class="line"><span class="comment">headers: Headers &#123;&#125;</span></span><br><span class="line"><span class="comment">ok: true</span></span><br><span class="line"><span class="comment">redirected: false</span></span><br><span class="line"><span class="comment">status: 200</span></span><br><span class="line"><span class="comment">statusText: &quot;OK&quot;</span></span><br><span class="line"><span class="comment">type: &quot;cors&quot;</span></span><br><span class="line"><span class="comment">url: &quot;http://127.0.0.1:8080/ping&quot;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">return</span> response.<span class="property">body</span></span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">(<span class="params">body</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">const</span> reader = body.<span class="title function_">getReader</span>();<span class="comment">///这里的body本身就是一个ReadableStream</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(reader)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">closed: Promise &#123;&lt;fulfilled&gt;: undefined&#125;</span></span><br><span class="line"><span class="comment">[[Prototype]]: ReadableStreamDefaultReader</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//构造一个新的ReadableStream</span></span><br><span class="line"><span class="keyword">const</span> newReadableStream=<span class="keyword">new</span> <span class="title class_">ReadableStream</span>(&#123;</span><br><span class="line"><span class="title function_">start</span>(<span class="params">controller</span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(controller)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">desiredSize: 0</span></span><br><span class="line"><span class="comment">[[Prototype]]: ReadableStreamDefaultController</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">push</span>(<span class="params"></span>) &#123;</span><br><span class="line">reader.<span class="title function_">read</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; done, value &#125;</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (done) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;写入流完成&#x27;</span>, done);</span><br><span class="line">controller.<span class="title function_">close</span>();<span class="comment">///关闭此流</span></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;开始写入流&quot;</span>)</span><br><span class="line">controller.<span class="title function_">enqueue</span>(value);<span class="comment">///将给定的块排入关联的流。</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(done, value);</span><br><span class="line"><span class="title function_">push</span>();<span class="comment">///在执行一次，如果已经完成则关闭此流</span></span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">push</span>();<span class="comment">///开始从body的流写入此流</span></span><br><span class="line">&#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">return</span> newReadableStream</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">(<span class="params">stream</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stream)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">locked: false</span></span><br><span class="line"><span class="comment">[[Prototype]]: ReadableStream</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(stream, &#123;<span class="attr">headers</span>:&#123;<span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;text/html&#x27;</span>&#125;&#125;).<span class="title function_">text</span>();</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(result); &#125;);<span class="comment">///&#123;&quot;message&quot;:&quot;pong&quot;&#125;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="TypedArray"><a href="#TypedArray" class="headerlink" title="TypedArray"></a>TypedArray</h3><p>ArrayBuffer对象作为内存区域，可以存放多种类型的数据。同一段内存，不同数据有不同的解读方式，这就叫做“视图”（view）。ArrayBuffer有两种视图，一种是 TypedArray视图，另一种是DataView视图。前者的数组成员都是同一种数据类型，后者的数组成员可以是不同种的数据类型。</p><h4 id="TypedArray视图共有9种类型，每一种视图都是一种构造函数。"><a href="#TypedArray视图共有9种类型，每一种视图都是一种构造函数。" class="headerlink" title="TypedArray视图共有9种类型，每一种视图都是一种构造函数。"></a>TypedArray视图共有9种类型，每一种视图都是一种构造函数。</h4><table><thead><tr><th>名称</th><th>类型</th><th>大小</th></tr></thead><tbody><tr><td>Int8Array</td><td>8位有符号整型</td><td>长度1个字节</td></tr><tr><td>Uint8Array</td><td>8位无符号整型</td><td>长度1个字节</td></tr><tr><td>Uint8ClampedArray</td><td>8位无符号整型</td><td>长度1个字节，溢出取极值</td></tr><tr><td>Int16Array</td><td>16位有符号整型</td><td>长度2个字节。</td></tr><tr><td>Uint16Array</td><td>16位无符号整型，</td><td>长度2个字节。</td></tr><tr><td>Int32Array</td><td>32位有符号整型</td><td>长度4个字节</td></tr><tr><td>Uint32Array</td><td>32位无符号整型</td><td>长度4个字节</td></tr><tr><td>Float32Array</td><td>32位浮点型</td><td>长度4个字节</td></tr><tr><td>Float64Array</td><td>64位浮点型</td><td>长度8个字节</td></tr></tbody></table><h4 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h4><p>这几个构造函数生成的实例都是<strong>类数组</strong>。</p><ul><li>也都是有length属性（注意与byteLength区分）</li><li>都能用取下标的方式（[]）获取单个数据，</li><li>所有数组的方法（无contact方法）都能使用。</li></ul><p>普通数组与TypedArray类数组的差异主要在以下方面。</p><ul><li>TypedArray数组中所有成员，都是同一种类型的。</li><li>TypedArray数组的成员是连续的，不会有空位。</li><li>TypedArray数组成员的默认值为0。比如，new Array(10)返回一个普通数组，里面没有任何成员，只是10个空位；new Uint8Array(10)返回一个TypedArray数组，里面10个成员都是0。</li><li>TypedArray数组只是一层视图，本身不储存数据，它的数据都储存在底层的ArrayBuffer对象之中，要获取底层对象必须使用buffer属性（prototype）。</li></ul><h4 id="TypedArray构造函数。"><a href="#TypedArray构造函数。" class="headerlink" title="TypedArray构造函数。"></a>TypedArray构造函数。</h4><p>这九种构造函数，可以生产不同类型的数据实例。</p><ul><li>TypedArray(buffer, byteOffset, length)。 byteOffset必须与所要建立的数据类型一致，否则会报错。 同一个TypedArray中，可以建立多个不同的数据视图。<ul><li>buffer（必需）：视图对应的底层ArrayBuffer对象。</li><li>byteOffset（可选）：视图开始的字节序号，默认从0开始。</li><li>length（可选）：视图包含的数据个数，默认直到本段内存区域结束。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个8字节的ArrayBuffer</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="comment">// 创建一个指向b的Int32视图，开始于字节0，直到缓冲区的末尾 </span></span><br><span class="line"><span class="keyword">var</span> v1 = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(b);</span><br><span class="line"><span class="comment">// 创建一个指向b的Uint8视图，开始于字节2，直到缓冲区的末尾 </span></span><br><span class="line"><span class="keyword">var</span> v2 = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(b, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// 创建一个指向b的Int16视图，开始于字节2，长度为2 </span></span><br><span class="line"><span class="keyword">var</span> v3 = <span class="keyword">new</span> <span class="title class_">Int16Array</span>(b, <span class="number">2</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure></li></ul></li><li>TypedArray(length)。还可以通过直接 new 构造函数的方式直接使用。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fa64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(<span class="number">8</span>);</span><br><span class="line">fa64[<span class="number">0</span>] = <span class="number">10</span>;</span><br><span class="line">fa64[<span class="number">1</span>] = <span class="number">20</span>;</span><br><span class="line">fa64[<span class="number">2</span>] = fa64[<span class="number">0</span>] + fa64[<span class="number">1</span>];</span><br></pre></td></tr></table></figure></li><li>TypedArray(typedArray)。参数也可以是其他 typedArray。注意，此时生成的新数组，只是复制了参数数组的值，对应的底层内存是不一样的。新数组会开辟一段新的内存储存数据，不会在原数组的内存之上建立视图。如果想基于同一段内存，构造不同的视图，可以采用下面的写法。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> typedArray = <span class="keyword">new</span> <span class="title class_">Int8Array</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">4</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//理解如下</span></span><br><span class="line"><span class="keyword">var</span> x = <span class="keyword">new</span> <span class="title class_">Int8Array</span>([<span class="number">1</span>, <span class="number">1</span>]);</span><br><span class="line"><span class="keyword">var</span> y = <span class="keyword">new</span> <span class="title class_">Int8Array</span>(x);</span><br><span class="line">x[<span class="number">0</span>]</span><br><span class="line">y[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">x[<span class="number">0</span>] = <span class="number">2</span>;</span><br><span class="line">y[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果想基于同一段内存，构造不同的视图，可以采用下面的写法。</span></span><br><span class="line"><span class="keyword">var</span> x = <span class="keyword">new</span> <span class="title class_">Int8Array</span>([<span class="number">1</span>, <span class="number">1</span>]);</span><br><span class="line"><span class="keyword">var</span> y = <span class="keyword">new</span> <span class="title class_">Int8Array</span>(x.<span class="property">buffer</span>);</span><br><span class="line">x[<span class="number">0</span>]</span><br><span class="line">y[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">x[<span class="number">0</span>] = <span class="number">2</span>;</span><br><span class="line">y[<span class="number">0</span>]</span><br></pre></td></tr></table></figure></li><li>TypedArray(arrayLikeObject)。构造函数的参数也可以是一个普通数组，TypedArray 数组也可以转换回普通数组。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> typedArray = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]);</span><br><span class="line"><span class="keyword">var</span> normalArray = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(typedArray);</span><br></pre></td></tr></table></figure></li></ul><h4 id="BYTES-PER-ELEMENT-属性。"><a href="#BYTES-PER-ELEMENT-属性。" class="headerlink" title="BYTES_PER_ELEMENT 属性。"></a>BYTES_PER_ELEMENT 属性。</h4><p>每一种视图的构造函数，都有一个 BYTES_PER_ELEMENT 属性，表示这种数据类型占据的字节数。这个属性在 TypedArray 实例上也能获取，即有 TypedArray.prototype.BYTES_PER_ELEMENT。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Int8Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="title class_">Uint8Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="title class_">Int16Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="title class_">Uint16Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="title class_">Int32Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="title class_">Uint32Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="title class_">Float32Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="title class_">Float64Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br></pre></td></tr></table></figure><h4 id="TypedArray-原型属性"><a href="#TypedArray-原型属性" class="headerlink" title="TypedArray 原型属性"></a>TypedArray 原型属性</h4><ul><li>TypedArray.prototype.buffer。前面我们也用到了，返回整段内存区域对应的 ArrayBuffer 对象。该属性为只读属性。视图对象和 b 视图对象，对应同一个 ArrayBuffer 对象，即同一段内存。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title class_">Float32Array</span>(<span class="number">64</span>);</span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(a.<span class="property">buffer</span>);</span><br></pre></td></tr></table></figure></li><li>TypedArray.prototype.length。该属性表示 TypedArray 数组含有多少个成员。注意将 byteLength 属性和 length 属性区分，前者是字节长度，后者是成员长度。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title class_">Int16Array</span>(<span class="number">90</span>);</span><br><span class="line">a.<span class="property">length</span>            <span class="comment">// 90 </span></span><br><span class="line">a.<span class="property">byteLength</span>        <span class="comment">// 180</span></span><br></pre></td></tr></table></figure></li><li>TypedArray.prototype.byteLength，TypedArray.prototype.byteOffset。byteLength 属性返回 TypedArray 数组占据的内存长度，单位为字节。byteOffset 属性返回 TypedArray 数组从底层 ArrayBuffer 对象的哪个字节开始。这两个属性都是只读属性。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> v1 = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(b);</span><br><span class="line"><span class="keyword">var</span> v2 = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(b, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">var</span> v3 = <span class="keyword">new</span> <span class="title class_">Int16Array</span>(b, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">v1.<span class="property">byteLength</span>        <span class="comment">// 8</span></span><br><span class="line">v2.<span class="property">byteLength</span>        <span class="comment">// 6</span></span><br><span class="line">v3.<span class="property">byteLength</span>        <span class="comment">// 4</span></span><br><span class="line"></span><br><span class="line">v1.<span class="property">byteOffset</span>        <span class="comment">// 0</span></span><br><span class="line">v2.<span class="property">byteOffset</span>        <span class="comment">// 2</span></span><br><span class="line">v3.<span class="property">byteOffset</span>        <span class="comment">// 2</span></span><br></pre></td></tr></table></figure></li><li>TypedArray.prototype.set()。TypedArray 数组的 set 方法用于复制数组（普通数组或 TypedArray 数组），也就是将一段内容完全复制到另一段内存。set 方法还可以接受第二个参数，表示从 b 对象的哪一个成员开始复制 a 对象。它是整段内存的复制，比一个个拷贝成员的那种复制快得多。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title class_">Uint16Array</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title class_">Uint16Array</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">b.<span class="title function_">set</span>(a, <span class="number">2</span>)</span><br></pre></td></tr></table></figure></li><li>TypedArray.prototype.subarray()。subarray 方法是对于 TypedArray 数组的一部分，再建立一个新的视图。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title class_">Uint16Array</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> b = a.<span class="title function_">subarray</span>(<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">a.<span class="property">byteLength</span></span><br><span class="line">b.<span class="property">byteLength</span></span><br></pre></td></tr></table></figure></li><li>TypedArray.prototype.slice()。类似于数组的 slice 方法，可以返回一个指定位置的新的 TypedArray 实例。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ui8 = <span class="title class_">Uint8Array</span>.<span class="title function_">of</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">ui8.<span class="title function_">slice</span>(-<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li><li>TypedArray.of()。该方法用于将参数转为一个 TypedArray 实例。</li><li>TypedArray.from()。静态方法 from 接受一个可遍历的数据结构（比如数组）作为参数，返回一个基于这个结构的 TypedArray 实例。</li></ul><h4 id="溢出问题"><a href="#溢出问题" class="headerlink" title="溢出问题"></a>溢出问题</h4><p>有一种特殊的 Uint8ClampedArray 类型，凡是发生正向溢出，该值一律等于当前数据类型的最大值，即 255；如果发生负向溢出，该值一律等于当前数据类型的最小值，即 0。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> uint8c = <span class="keyword">new</span> <span class="title class_">Uint8ClampedArray</span>(<span class="number">1</span>);</span><br><span class="line">uint8c[<span class="number">0</span>] = <span class="number">256</span>;</span><br><span class="line">uint8c[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">uint8c[<span class="number">0</span>] = -<span class="number">1</span>;</span><br><span class="line">uint8c[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">而另外的其他类型，都会出现溢出情况，</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> int8 = <span class="keyword">new</span> <span class="title class_">Int8Array</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">int8[<span class="number">0</span>] = <span class="number">128</span>;</span><br><span class="line">int8[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">int8[<span class="number">0</span>] = -<span class="number">129</span>;</span><br><span class="line">int8[<span class="number">0</span>]</span><br></pre></td></tr></table></figure><h3 id="复合视图"><a href="#复合视图" class="headerlink" title="复合视图"></a>复合视图</h3><ul><li><p>由于视图的构造函数可以指定起始位置和长度，所以在同一段内存之中，可以依次存放不同类型的数据，这叫做 “复合视图”。下面代码将一个 24 字节长度的 ArrayBuffer 对象，分成三个部分，字节 0 到字节 3 是 1 个 32 位无符号整数，字节 4 到字节 19 是 16 个 8 位整数，字节 20 到字节 23 是 1 个 32 位浮点数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">24</span>);</span><br><span class="line"><span class="keyword">var</span> idView = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(buffer, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">var</span> usernameView = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buffer, <span class="number">4</span>, <span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> amountDueView = <span class="keyword">new</span> <span class="title class_">Float32Array</span>(buffer, <span class="number">20</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure></li><li><p>如果一段数据包括多种类型（比如服务器传来的 HTTP 数据），这时除了建立 ArrayBuffer 对象的复合视图以外，还可以通过 DataView 视图进行操作。 DataView 视图本身也是构造函数，接受一个 ArrayBuffer 对象作为参数，生成视图。</p></li><li><p>DataView(ArrayBuffer buffer [, 字节起始位置 [, 长度]]);</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">24</span>);</span><br><span class="line"><span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="title class_">DataView</span>(buffer);</span><br></pre></td></tr></table></figure></li><li><p>DataView 实例有以下属性，含义与 TypedArray 实例的同名方法相同。</p><ul><li>DataView.prototype.buffer：返回对应的 ArrayBuffer 对象</li><li>DataView.prototype.byteLength：返回占据的内存字节长度</li><li>DataView.prototype.byteOffset：返回当前视图从对应的 ArrayBuffer 对象的哪个字节开始</li></ul></li><li><p>DataView 实例提供 8 个方法读取内存。</p><ul><li>getInt8：读取 1 个字节，返回一个 8 位整数。</li><li>getUint8：读取 1 个字节，返回一个无符号的 8 位整数。</li><li>getInt16：读取 2 个字节，返回一个 16 位整数。</li><li>getUint16：读取 2 个字节，返回一个无符号的 16 位整数。</li><li>getInt32：读取 4 个字节，返回一个 32 位整数。</li><li>getUint32：读取 4 个字节，返回一个无符号的 32 位整数。</li><li>getFloat32：读取 4 个字节，返回一个 32 位浮点数。</li><li>getFloat64：读取 8 个字节，返回一个 64 位浮点数。</li></ul></li><li><p>这一系列 get 方法的参数都是一个字节序号（不能是负数，否则会报错），表示从哪个字节开始读取。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">24</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="title class_">DataView</span>(buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> v1 = dv.<span class="title function_">getUint8</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> v2 = dv.<span class="title function_">getUint16</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> v3 = dv.<span class="title function_">getUint16</span>(<span class="number">3</span>);</span><br></pre></td></tr></table></figure><p>如果一次读取两个或两个以上字节，就必须明确数据的存储方式，到底是小端字节序还是大端字节序。默认情况下，DataView 的 get 方法使用大端字节序解读数据，如果需要使用小端字节序解读，必须在 get 方法的第二个参数指定 true。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> v1 = dv.<span class="title function_">getUint16</span>(<span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> v2 = dv.<span class="title function_">getUint16</span>(<span class="number">3</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> v3 = dv.<span class="title function_">getUint16</span>(<span class="number">3</span>);</span><br></pre></td></tr></table></figure></li><li><p>DataView 视图提供 8 个方法写入内存。</p><ul><li>setInt8：写入 1 个字节的 8 位整数。</li><li>setUint8：写入 1 个字节的 8 位无符号整数。</li><li>setInt16：写入 2 个字节的 16 位整数。</li><li>setUint16：写入 2 个字节的 16 位无符号整数。</li><li>setInt32：写入 4 个字节的 32 位整数。</li><li>setUint32：写入 4 个字节的 32 位无符号整数。</li><li>setFloat32：写入 4 个字节的 32 位浮点数。</li><li>setFloat64：写入 8 个字节的 64 位浮点数。<br>这一系列 set 方法，接受两个参数，第一个参数是字节序号，表示从哪个字节开始写入，第二个参数为写入的数据。对于那些写入两个或两个以上字节的方法，需要指定第三个参数，false 或者 undefined 表示使用大端字节序写入，true 表示使用小端字节序写入。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dv.<span class="title function_">setInt32</span>(<span class="number">0</span>, <span class="number">25</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">dv.<span class="title function_">setInt32</span>(<span class="number">4</span>, <span class="number">25</span>);</span><br><span class="line"></span><br><span class="line">dv.<span class="title function_">setFloat32</span>(<span class="number">8</span>, <span class="number">2.5</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果不确定正在使用的计算机的字节序，可以采用下面的判断方式</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> littleEndian = (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">DataView</span>(buffer).<span class="title function_">setInt16</span>(<span class="number">0</span>, <span class="number">256</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Int16Array</span>(buffer)[<span class="number">0</span>] === <span class="number">256</span>;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nuxt服务端的打包部署</title>
      <link href="/2021/05/04/20210504nuxt%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E6%89%93%E5%8C%85%E9%83%A8%E7%BD%B2/"/>
      <url>/2021/05/04/20210504nuxt%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E6%89%93%E5%8C%85%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<blockquote><h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br><span class="line">npm run generat</span><br><span class="line"></span><br><span class="line">如果是想做ssr，那就npm run build，然后npm start把项目服务起起来就行了，</span><br><span class="line">如果只是想做静态页面，那就npm run generat，然后通过静态服务器部署</span><br><span class="line"></span><br><span class="line">server: &#123;</span><br><span class="line">  port: 3000, // default: 3000</span><br><span class="line">  host: &#x27;0.0.0.0&#x27; // 在服务器上监听所有</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">所以我采用</span><br><span class="line"></span><br><span class="line">npm run build</span><br><span class="line"></span><br><span class="line">打包过后的产物</span><br><span class="line"></span><br><span class="line">.nuxt</span><br><span class="line">static</span><br><span class="line">package.json</span><br><span class="line">nuxt.config.js</span><br></pre></td></tr></table></figure><blockquote><h4 id="服务器安装node"><a href="#服务器安装node" class="headerlink" title="服务器安装node"></a>服务器安装node</h4></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install nodejs npm -y</span><br><span class="line">node --version</span><br><span class="line">npm --version</span><br></pre></td></tr></table></figure><h4 id="更换npm淘宝源（可跳过）"><a href="#更换npm淘宝源（可跳过）" class="headerlink" title="更换npm淘宝源（可跳过）"></a>更换npm淘宝源（可跳过）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">全局配置切换到淘宝源：</span><br><span class="line">npm config set registry https://registry.npm.taobao.org</span><br><span class="line">全局配置切换到官方源：</span><br><span class="line">npm config set registry http://www.npmjs.org</span><br><span class="line">检测是否切换到了淘宝源：</span><br><span class="line">npm info underscore</span><br><span class="line"></span><br><span class="line">//安装依赖</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure><blockquote><h4 id="启动项目"><a href="#启动项目" class="headerlink" title="启动项目"></a>启动项目</h4></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run start</span><br></pre></td></tr></table></figure><blockquote><h4 id="使用pm2开启进程守护"><a href="#使用pm2开启进程守护" class="headerlink" title="使用pm2开启进程守护"></a>使用pm2开启进程守护</h4></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">npm install pm2 -g</span><br><span class="line">安装</span><br><span class="line">pm2 update</span><br><span class="line">更新版本</span><br><span class="line">pm2 list</span><br><span class="line">显示所有进程状态</span><br><span class="line">pm2 monit</span><br><span class="line">监视所有进程</span><br><span class="line">pm2 log</span><br><span class="line">显示所有进程日志</span><br><span class="line">pm2 stop all</span><br><span class="line">停止所有进程</span><br><span class="line">pm2 restart all</span><br><span class="line">重启所有进程</span><br><span class="line">pm2 reload all</span><br><span class="line">0 秒停机重载进程 (用于 NETWORKED 进程)</span><br><span class="line">pm2 stop name</span><br><span class="line">停止指定的进程，name为标识</span><br><span class="line">pm2 restart name</span><br><span class="line">重启指定的进程，name为标识</span><br><span class="line">pm2 startup</span><br><span class="line">产生 init 脚本 保持进程活着</span><br><span class="line">pm2 web</span><br><span class="line">运行健壮的 computer API endpoint (http://localhost:9615)</span><br><span class="line">pm2 delete name</span><br><span class="line">杀死指定的进程，name为标识</span><br><span class="line">pm2 delete all</span><br><span class="line">杀死全部进程</span><br></pre></td></tr></table></figure><blockquote><h4 id="运行项目"><a href="#运行项目" class="headerlink" title="运行项目"></a>运行项目</h4></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pm2 start npm --name &quot;app&quot; -- start</span><br><span class="line">//进入到博客运行目录下</span><br><span class="line">pm2 start npm --name blog -- start</span><br><span class="line">app是pm2的进程的名字</span><br></pre></td></tr></table></figure><p><img src="/assets/img/202209201102.png" alt="成功部署后如图"></p><blockquote><h4 id="访问项目"><a href="#访问项目" class="headerlink" title="访问项目"></a>访问项目</h4></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http</span>:<span class="comment">//106.52.222.26:3001</span></span><br><span class="line">这里的端口来源于</span><br><span class="line">nuxt.<span class="property">config</span>.<span class="property">json</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">server</span>: &#123; <span class="comment">// 部署到线上nginx配置</span></span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;0.0.0.0&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="number">3001</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：如果数据是直接访问的服务器json文件，json文件改变了过后，但是页面中请求数据未改变，重启下进程就好了 pm2 reload all。</p><p>举个栗子。他的vuex中，存在一个值(普通的值，不存在什么权限判断啥的)，项目部署的时候不存在，如果接口请求过一次，那么vuex中这个值就已经存在，其他的用户进入页面的时候就不需要请求。</p>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web前端 </tag>
            
            <tag> nuxtjs </tag>
            
            <tag> vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javascript中的原型，原型对象，原型链</title>
      <link href="/2021/04/25/20210420js%E5%8E%9F%E5%9E%8B%E9%93%BE%E7%9A%84%E5%AD%A6%E4%B9%A0/"/>
      <url>/2021/04/25/20210420js%E5%8E%9F%E5%9E%8B%E9%93%BE%E7%9A%84%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="原型和原型对象"><a href="#原型和原型对象" class="headerlink" title="原型和原型对象"></a>原型和原型对象</h2><p><img src="/assets/img/202104201.png"></p><blockquote><p>class的类型为function</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///函数A或者 class A &#123;&#125;,对应上图左边</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">A</span>(<span class="params">age,name</span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">age</span>=age</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span>=name</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a=<span class="keyword">new</span> <span class="title function_">A</span>(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(A.<span class="property"><span class="keyword">prototype</span></span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(A.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">constructor</span>===A)</span><br></pre></td></tr></table></figure><h2 id="proto-和-prototype"><a href="#proto-和-prototype" class="headerlink" title="proto 和 prototype"></a><strong>proto</strong> 和 prototype</h2><p><img src="/assets/img/202104202.png"></p><h3 id="proto-（隐式原型）"><a href="#proto-（隐式原型）" class="headerlink" title="__proto__（隐式原型）"></a>__proto__（隐式原型）</h3><p>JavaScript中任意对象都有一个内置属性[[prototype]]，在ES5之前没有标准的方法访问这个内置属性，但是大多数浏览器都支持通过__proto__来访问。ES5中有了对于这个内置属性标准的Get方法Object.getPrototypeOf()。</p><p>__proto__指向的是当前对象的原型对象。换句话说指向创建这个对象的函数的prototype</p><blockquote><p>__proto__是每个对象都有的一个属性，函数也可能会有，因为函数也可能是一个实例对象。</p></blockquote><p><img src="/assets/img/202104203.png"></p><h3 id="prototype（显式原型）"><a href="#prototype（显式原型）" class="headerlink" title="prototype（显式原型）"></a>prototype（显式原型）</h3><p>每一个函数在创建之后都会拥有一个名为prototype的属性，这个属性指向函数的原型对象。</p><p>prototype指向的是以——当前函数作为构造函数(上图左边)——构造出来的对象(上图下边)——的原型对象(上图右边)。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">A</span>(<span class="params">age,name</span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">age</span>=age</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span>=name</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a=<span class="keyword">new</span> <span class="title function_">A</span>(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(A.<span class="property"><span class="keyword">prototype</span></span>===a.<span class="property">__proto__</span>)<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="property">__proto__</span>.<span class="property">constructor</span>===A)<span class="comment">//true</span></span><br></pre></td></tr></table></figure><p>举个例子js的内置Array</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">constructor</span>===<span class="title class_">Array</span>)<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span>===<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>)<span class="comment">//true</span></span><br></pre></td></tr></table></figure><blockquote><p>Array.prototype返回的是一个[constructor: ƒ, at: ƒ, concat: ƒ, copyWithin: ƒ, fill: ƒ, …] ，它其实是一个对象，里面有很多方法。</p></blockquote><p>可以看出完美验证了我们上面的流程。</p><p>那么出现了个新的Object.prototype是什么呢，继续往下看。</p><h2 id="原型链的图解和理解"><a href="#原型链的图解和理解" class="headerlink" title="原型链的图解和理解"></a>原型链的图解和理解</h2><p><img src="/assets/img/202104204.png"></p><p>内置的Object构造器和自己声明的构造器等都是通过内置的Function构造器构造出来的</p><p>所以他们都可以看做被内置的Function构造器new出来的实例，所以他们的__proto__都是内置的Function构造器的prototype</p><p>但是这些实例的类型为function，且他们拥有__proto__属性。（__proto__对象肯定有，函数可能有，prototype函数有）</p><p>当然内置的Function构造器也能当做一个实例</p>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>构建工具的复习记录</title>
      <link href="/2021/04/25/20210425gulp%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E7%9A%84%E5%A4%8D%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
      <url>/2021/04/25/20210425gulp%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E7%9A%84%E5%A4%8D%E4%B9%A0%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<p>因为公司项目老旧，有很多零散的html文件，老板让我做个优化版，让他们集中起来，易于管理。于是趁此机会复习一下gulp并记录一下</p><p>gulp.js 是一个自动化构建工具,用于自动化Web开发中涉及的耗时和重复性任务,Gulp.js 是基于 Node.js 构建的,利用 Node.js 流的威力,你可以快速构建项目。</p><p>先放上官网 <a href="http://www.gulpjs.com.cn/docs/getting-started/quick-start/">http://www.gulpjs.com.cn/docs/getting-started/quick-start/</a></p><p>然后在百度一波流的概念。</p><p>流（Stream）不是 gulp 创造的概念，而是从 unix 时代就开始使用的 I/O 机制，一直到现在仍在广泛使用。Node 封装了一个 stream 模块专门用来对流进行操作。gulp 所基于的流即是 Node 封装起来的 stream。上面 gulp.task() 代码里面的 pipe 方法并不是 gulp 提供的 api，而是 node 的 api，准确的说应该是 node 的 stream 模块提供的 api。具体是怎么实现的呢：    gulp.src() 的返回值是 node Stream 的一个实例，之后的 pipe 调用的其实是这个实例的 pipe 方法，而 pipe 方法的返回值依然是 node Stream 实例，以此实现前面的         .pipe().pipe().pipe() 这种串联写法。熟悉 jQuery 的同学应该很清楚这种技巧。</p><p>下表是从各个角度对 gulp 和 webpack 做的对比(当然构建化工具有很多，这里只比较了两个)：</p><table><thead><tr><th></th><th>Syntax</th><th>Description</th></tr></thead><tbody><tr><td>定位</td><td>基于流的自动化构建工具</td><td>一个万能模块打包器</td></tr><tr><td>目标</td><td>自动化和优化开发工作流，为通用 website 开发而生</td><td>通用模块打包加载器，为移动端大型 SPA(单页应用) 应用而生</td></tr><tr><td>学习难度</td><td>易于学习，易于使用，api总共只有5个方法</td><td>有大量新的概念和api，不过好在有详尽的官方文档</td></tr><tr><td>适用场景</td><td>基于流的作业方式适合多页面应用开发</td><td>一切皆模块的特点适合单页面应用开发</td></tr><tr><td>作业方式</td><td>对输入（gulp.src）的 js，ts，scss，less 等源文件依次执行打包（bundle）、编译（compile）、压缩、重命名等处理后输出（gulp.dest）到指定目录中去，为了构建而打包</td><td>对入口文件（entry）递归解析生成依赖关系图，然后将所有依赖打包在一起，在打包之前会将所有依赖转译成可打包的 js 模块，为了打包而构建</td></tr><tr><td>使用方式</td><td>常规 js 开发，编写一系列构建任务（task）</td><td>编辑各种 JSON 配置项</td></tr><tr><td>优点</td><td>适合多页面开发，易于学习，易于使用，接口优雅。</td><td>可以打包一切资源，适配各种模块系统</td></tr><tr><td>缺点</td><td>在单页面应用方面输出乏力，而且对流行的单页技术有些难以处理（比如 Vue 单文件组件，使用 gulp 处理就会很困难，而 webpack 一个 loader 就能轻松搞定）</td><td>不适合多页应用开发，灵活度高但同时配置很繁琐复杂。“打包一切” 这个优点对于 HTTP/1.1 尤其重要，因为所有资源打包在一起能明显减少浏览器访问页面时的资源请求数量，从而减少应用程序必须等待的时间。但这个优点可能会随着 HTTP/2 的流行而变得不那么突出，因为 HTTP/2 的多路复用可以有效解决客户端并行请求时的瓶颈问题。</td></tr><tr><td>结论</td><td>浏览器多页应用(MPA)首选方案</td><td>浏览器单页应用(SPA)首选方案</td></tr></tbody></table><p>我看好多人说 gulp 和 webpack 不是一类东西，我不这么觉得，虽然说两者的出发点确实是不一样的，gulp 走的是流式处理路线，webpack 走的是模块处理路线，但是两者所要达成的目标却是一样的，那就是促进前端领域的自动化和工程化管理。webpack 发展到现在，已经非常强大了，强大到在构建方面 gulp 能做的事 webpack 基本上都可以胜任，gulp 做不了的 webpack 也能搞。同样的那些开发工作中痛苦又耗时的任务，gulp 和 webpack 都能解决，只是解决思路有天壤之别。gulp 和 webpack 只是我们解决问题的工具，不要被工具束缚了手脚不能前进。                                                                                                                                |</p><p>全局安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cnpm i -g gulp</span><br><span class="line">//全局安装是为了执行你所编写的 gulp 任务，如gulp yourTask</span><br></pre></td></tr></table></figure><p>初始化项目</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//初始化</span><br><span class="line"></span><br><span class="line">npm init</span><br><span class="line"></span><br><span class="line">//安装gulp，本地安装，是为了咱们编写任务时使用 gulp 提供的 api，例如 gulp.src()</span><br><span class="line"></span><br><span class="line">cnpm i --save-dev gulp   //或者 -D</span><br><span class="line"></span><br><span class="line">//主目录下创建 gulpfile.js</span><br></pre></td></tr></table></figure><p>核心文件学习历程如下(更加详细的使用查看官网)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//cnpm i -D gulp-cssmin //替换css空格的插件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//cnpm i -D gulp-autoprefixer //给样式添加前缀，为了兼容浏览器</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  把配置写在package.json 里面</span></span><br><span class="line"><span class="comment">  eg &quot;browserslist&quot;:[&quot;last 5 versions&quot;]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Replace Autoprefixer browsers option to Browserslist config.</span></span><br><span class="line"><span class="comment">  Use browserslist key in package.json or .browserslistrc file.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Using browsers option can cause errors. Browserslist config can</span></span><br><span class="line"><span class="comment">  be used for Babel, Autoprefixer, postcss-normalize and other tools.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  If you really need to use option, rename it to overrideBrowserslist.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Learn more at:</span></span><br><span class="line"><span class="comment">  https://github.com/browserslist/browserslist#readme</span></span><br><span class="line"><span class="comment">  https://twitter.com/browserslist</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//cnpm i -D gulp-sass //打包sass   提示python啥的 那是版本没对</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//cnpm i -D gulp-uglify //压缩打包js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//cnpm i -D gulp-babel //es6 转 es5  gulp-babel@8用的gulp4  gulp-babel@7用的gulp3  同时还依赖下面两个</span></span><br><span class="line"><span class="comment">//cnpm i -D @babel/core</span></span><br><span class="line"><span class="comment">//cnpm i -D @babel/preset-env</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//cnpm i -D gulp-htmlmin //压缩html   参数详情看文档https://github.com/kangax/html-minifier</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//cnpm i -D del //清楚上次打包的文件 &lt;!--不是流，直接执行这个函数--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//cnpm i -D gulp-webserver //本地服务器 https://www.npmjs.com/package/gulp-webserver</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//cnpm i -D gulp-imagemin //压缩图片  因为要保证无损，大多时候不压缩</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//cnpm i -D gulp-file-include //组件打包，把一个html当成一个片段打到另一个组件里面</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//有些东西不需要打包，比如 fonts ....</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> gulp = <span class="built_in">require</span>(<span class="string">&quot;gulp&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> cssmin = <span class="built_in">require</span>(<span class="string">&quot;gulp-cssmin&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> autoprefixer = <span class="built_in">require</span>(<span class="string">&quot;gulp-autoprefixer&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> sass = <span class="built_in">require</span>(<span class="string">&quot;gulp-sass&quot;</span>)(<span class="built_in">require</span>(<span class="string">&quot;node-sass&quot;</span>))</span><br><span class="line"><span class="keyword">const</span> uglify = <span class="built_in">require</span>(<span class="string">&quot;gulp-uglify&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">&quot;gulp-babel&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> htmlMin = <span class="built_in">require</span>(<span class="string">&quot;gulp-htmlmin&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> del = <span class="built_in">require</span>(<span class="string">&quot;del&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> webserver = <span class="built_in">require</span>(<span class="string">&quot;gulp-webserver&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> fileInclude = <span class="built_in">require</span>(<span class="string">&quot;gulp-file-include&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//打包css</span></span><br><span class="line"><span class="keyword">const</span> cssompress = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// gulp.src(&quot;./src/**/*&quot;)</span></span><br><span class="line">    <span class="keyword">return</span> gulp</span><br><span class="line">        .<span class="title function_">src</span>(<span class="string">&quot;./src/css/*.css&quot;</span>)</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">autoprefixer</span>())</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">cssmin</span>())</span><br><span class="line">        .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&quot;./dist/css/&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//打包scss</span></span><br><span class="line"><span class="keyword">const</span> sassHandler = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// gulp.src(&quot;./src/**/*&quot;)</span></span><br><span class="line">    <span class="keyword">return</span> gulp</span><br><span class="line">        .<span class="title function_">src</span>(<span class="string">&quot;./src/css/*.scss&quot;</span>)</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">sass</span>())</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">autoprefixer</span>())</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">cssmin</span>())</span><br><span class="line">        .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&quot;./dist/css/&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//打包js</span></span><br><span class="line"><span class="keyword">const</span> jsHandler = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp</span><br><span class="line">        .<span class="title function_">src</span>(<span class="string">&quot;./src/js/*.js&quot;</span>)</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">babel</span>(&#123;</span><br><span class="line">            <span class="attr">presets</span>:[<span class="string">&quot;@babel/env&quot;</span>]</span><br><span class="line">        &#125;))</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">uglify</span>())</span><br><span class="line">        .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&quot;./dist/js/&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//打包html</span></span><br><span class="line"><span class="keyword">const</span> htmlHandler = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp</span><br><span class="line">        .<span class="title function_">src</span>(<span class="string">&quot;./src/page/*.html&quot;</span>)</span><br><span class="line">        <span class="comment">//打包组件</span></span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">fileInclude</span>(&#123;</span><br><span class="line">            <span class="attr">prefix</span>:<span class="string">&quot;@#@&quot;</span>,<span class="comment">//定义的一个标识符</span></span><br><span class="line">            <span class="attr">basepath</span>:<span class="string">&quot;./src/components&quot;</span>,<span class="comment">//组件存放的目录</span></span><br><span class="line">           </span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                使用 ：  @#@include(&quot;./header.html&quot;)</span></span><br><span class="line"><span class="comment">               </span></span><br><span class="line"><span class="comment">                给组件传值 @#@include(&quot;./header.html&quot;,&#123;data:&quot;1&quot;,name:&quot;header&quot;&#125;)</span></span><br><span class="line"><span class="comment">               </span></span><br><span class="line"><span class="comment">                组件 &lt;div&gt;@#@data&lt;/div&gt; &lt;div&gt;@#@header&lt;/div&gt;</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           </span><br><span class="line">        &#125;))</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">htmlMin</span>(&#123;</span><br><span class="line">            <span class="attr">collapseWhitespace</span>:<span class="literal">true</span>,<span class="comment">//移除空格</span></span><br><span class="line">            <span class="attr">removeEmptyAttributes</span>:<span class="literal">true</span>,<span class="comment">//移除空属性(自定义属性不行，原生的)</span></span><br><span class="line">            <span class="attr">collapseBooleanAttributes</span>:<span class="literal">true</span>,<span class="comment">//合并bool为true的属性 ，比如checked=&quot;checked&quot; =&gt; checked</span></span><br><span class="line">            <span class="attr">removeAttributeQuotes</span>:<span class="literal">true</span>,<span class="comment">//比如  class=&quot;a&quot; -&gt; class=a   class=&quot;a b&quot;则不行</span></span><br><span class="line">            <span class="attr">minifyCSS</span>:<span class="literal">true</span>,<span class="comment">//压缩style标签的代码(基本压缩，所以最好外联)</span></span><br><span class="line">            <span class="attr">minifyJS</span>:<span class="literal">true</span>,<span class="comment">//压缩js标签的代码(基本压缩，所以最好外联)</span></span><br><span class="line">            <span class="attr">removeScriptTypeAttributes</span>:<span class="literal">true</span>,<span class="comment">//type=&quot;text/javascript&quot;从script标签中删除。其他type属性值保持不变</span></span><br><span class="line">            <span class="attr">removeStyleLinkTypeAttributes</span>:<span class="literal">true</span>,<span class="comment">//type=&quot;text/css&quot;从style和link标签中删除。其他type属性值保持不变</span></span><br><span class="line">            <span class="comment">//其他看文档</span></span><br><span class="line">        &#125;))</span><br><span class="line">        .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&quot;./dist/page/&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//导出图片</span></span><br><span class="line"><span class="keyword">const</span> imgHandler = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp</span><br><span class="line">        .<span class="title function_">src</span>(<span class="string">&quot;./src/assets/*&quot;</span>)</span><br><span class="line">        .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&quot;./dist/assets/&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//打包一个第三方任务</span></span><br><span class="line"><span class="keyword">const</span> libHandler = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp</span><br><span class="line">        .<span class="title function_">src</span>(<span class="string">&quot;./src/lib/**/*&quot;</span>)</span><br><span class="line">        .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&quot;./dist/lib/&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除方任务</span></span><br><span class="line"><span class="keyword">const</span> delHandler = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//传如数组(你要删除的目录)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">del</span>([<span class="string">&quot;./dist/&quot;</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除方任务</span></span><br><span class="line"><span class="keyword">const</span> webserverHandler = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//传如数组(你要删除的目录)</span></span><br><span class="line">    <span class="keyword">return</span> gulp</span><br><span class="line">        .<span class="title function_">src</span>(<span class="string">&quot;./dist&quot;</span>)</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">webserver</span>(&#123;</span><br><span class="line">            <span class="attr">host</span>:<span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                如果你这里是自定义,假如 www.tabby.com</span></span><br><span class="line"><span class="comment">                找到 C:\Windows\System32\drivers\etc\hosts</span></span><br><span class="line"><span class="comment">                末尾加上 127.0.0.1       www.tabby.com</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="attr">port</span>:<span class="string">&quot;9527&quot;</span>,</span><br><span class="line">            <span class="attr">livereload</span>:<span class="literal">true</span>,<span class="comment">//默认你修改dist下面的文件才会刷新,但是要修改dist那么只能重新打包</span></span><br><span class="line">            <span class="attr">open</span>:<span class="literal">true</span>,<span class="comment">//自动打开浏览器</span></span><br><span class="line">            <span class="attr">fallback</span>: <span class="string">&#x27;./page/index.html&#x27;</span>,<span class="comment">//默认打开的路径(根目录是上面的dist</span></span><br><span class="line">            <span class="attr">proxies</span>:[</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    每一个代理都是一个对象，不要写空对象</span></span><br><span class="line"><span class="comment">                    http://localhost:9000/geta/cors 跨域错误的地址</span></span><br><span class="line"><span class="comment">                    http://localhost:9000/  代理地址</span></span><br><span class="line"><span class="comment">                    /proxytest/geta/cors  200</span></span><br><span class="line"><span class="comment">                   </span></span><br><span class="line"><span class="comment">                   </span></span><br><span class="line"><span class="comment">                    http://localhost:9000/geta/cors 跨域错误的地址</span></span><br><span class="line"><span class="comment">                    http://localhost:9000/geta/  代理地址</span></span><br><span class="line"><span class="comment">                    /proxytest/cors  200</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">source</span>: <span class="string">&#x27;/proxytest&#x27;</span>,<span class="comment">//代理标识符号</span></span><br><span class="line">                    <span class="attr">target</span>: <span class="string">&#x27;http://localhost:9000/geta/&#x27;</span>,<span class="comment">//代理地址</span></span><br><span class="line">                    <span class="comment">// options: &#123;</span></span><br><span class="line">                    <span class="comment">//  headers: &#123;</span></span><br><span class="line">                    <span class="comment">//      &#x27;ABC_HEADER&#x27;: &#x27;abc&#x27;,</span></span><br><span class="line">                    <span class="comment">//  &#125;,</span></span><br><span class="line">                    <span class="comment">// &#125;,</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//监控任务</span></span><br><span class="line"><span class="keyword">const</span> watchHandler = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    gulp.<span class="title function_">watch</span>(<span class="string">&quot;./src/css/*&quot;</span>,sassHandler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">cssompress</span>=cssompress</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">sassHandler</span>=sassHandler</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">jsHandler</span>=jsHandler</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">htmlHandler</span>=htmlHandler</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">imgHandler</span>=imgHandler</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">delHandler</span>=delHandler</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">webserverHandler</span>=webserverHandler</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    配置一个默认任务，把上面的一起执行了</span></span><br><span class="line"><span class="comment">    1.  gulp.task(&quot;defalut&quot;,()=&gt;&#123;&#125;)</span></span><br><span class="line"><span class="comment">    2.  module.exports.default=()=&gt;&#123;&#125;</span></span><br><span class="line"><span class="comment">   </span></span><br><span class="line"><span class="comment">    3.  如下   当然你也可以叫abc那么执行 gulp abc,如果是default,那么可以只执行gulp就OJ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// module.exports.default=gulp.parallel(cssompress,sassHandler,jsHandler,htmlHandler,imgHandler)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    删除任务</span></span><br><span class="line"><span class="comment">    比如你这次css文件夹里只有一个b.css文件删除了上次的a.css，</span></span><br><span class="line"><span class="comment">    那么你下次打包dist/css文件路径下a.css还是存在</span></span><br><span class="line"><span class="comment">   </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// module.exports.default=gulp.series(</span></span><br><span class="line"><span class="comment">//  delHandler,</span></span><br><span class="line"><span class="comment">//  gulp.parallel(cssompress,sassHandler,jsHandler,htmlHandler,imgHandler)</span></span><br><span class="line"><span class="comment">// )</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    用gulp启动一个服务</span></span><br><span class="line"><span class="comment">    src：</span></span><br><span class="line"><span class="comment">        html引用的是一个stylusScss.css文件 因为不存在所以会报错</span></span><br><span class="line"><span class="comment">    dist：</span></span><br><span class="line"><span class="comment">        html引用的是一个stylusScss.css文件 因为stylusScss.scss被转成了css文件所以没问题</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// module.exports.default=gulp.series(</span></span><br><span class="line"><span class="comment">//  delHandler,</span></span><br><span class="line"><span class="comment">//  gulp.parallel(cssompress,sassHandler,jsHandler,htmlHandler,imgHandler),</span></span><br><span class="line"><span class="comment">//  webserverHandler,</span></span><br><span class="line"><span class="comment">// )</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    监控任务</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">default</span>=gulp.<span class="title function_">series</span>(</span><br><span class="line">    delHandler,</span><br><span class="line">    gulp.<span class="title function_">parallel</span>(cssompress,sassHandler,jsHandler,htmlHandler,imgHandler),</span><br><span class="line">    webserverHandler,</span><br><span class="line">    watchHandler</span><br><span class="line">)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web前端 </tag>
            
            <tag> gulp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iframe高度根据链入的页面高度自适应</title>
      <link href="/2021/04/15/20210415iframe%E9%AB%98%E5%BA%A6%E6%A0%B9%E6%8D%AE%E9%93%BE%E5%85%A5%E7%9A%84%E9%A1%B5%E9%9D%A2%E9%AB%98%E5%BA%A6%E8%87%AA%E9%80%82%E5%BA%94/"/>
      <url>/2021/04/15/20210415iframe%E9%AB%98%E5%BA%A6%E6%A0%B9%E6%8D%AE%E9%93%BE%E5%85%A5%E7%9A%84%E9%A1%B5%E9%9D%A2%E9%AB%98%E5%BA%A6%E8%87%AA%E9%80%82%E5%BA%94/</url>
      
        <content type="html"><![CDATA[<p>最近突然有个需求是要在页面中的iframe链入其他各种各样的页面。</p><p>但是问题来了，实际情况是他不能根据页面内容自适应高度。加了scrolling=“no”过后然后又不能滚动了。页面的其他部分根本展示不出来。</p><p>页面的部分代码如下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;header&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- .... --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;content&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;data.src&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">&quot;ifr&quot;</span> <span class="attr">:src</span>=<span class="string">&quot;data.src&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;0&quot;</span> <span class="attr">height</span>=<span class="string">&quot;&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">scrolling</span>=<span class="string">&quot;no&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> timer = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">setHeight</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> iframe = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#ifr&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> iframeContext = iframe.<span class="property">contentWindow</span> || iframe.<span class="property">contentDocument</span>.<span class="property">parentWindow</span>;</span><br><span class="line">        <span class="keyword">if</span> (iframeContext.<span class="property">document</span>.<span class="property">body</span>) &#123;</span><br><span class="line">            iframe.<span class="property">height</span> = iframeContext.<span class="property">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>;</span><br><span class="line">            <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">userStore.<span class="property">data</span>.<span class="property">blogs</span>[route.<span class="property">query</span>.<span class="property">type</span>].<span class="title function_">forEach</span>(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(element.<span class="property">adr</span>==route.<span class="property">params</span>.<span class="property">artkey</span>)&#123;</span><br><span class="line">        data.<span class="property">article</span>=element</span><br><span class="line">        data.<span class="property">src</span>=<span class="string">`*******`</span></span><br><span class="line">        timer=<span class="built_in">setInterval</span>(setHeight,<span class="number">200</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title function_">onUnmounted</span>(<span class="function">()=&gt;</span>&#123;<span class="built_in">clearInterval</span>(timer)&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端操作excel导入和导出</title>
      <link href="/2021/03/20/20210320%E5%89%8D%E7%AB%AF%E6%93%8D%E4%BD%9Cexcel%E5%AF%BC%E5%85%A5%E5%92%8C%E5%AF%BC%E5%87%BA/"/>
      <url>/2021/03/20/20210320%E5%89%8D%E7%AB%AF%E6%93%8D%E4%BD%9Cexcel%E5%AF%BC%E5%85%A5%E5%92%8C%E5%AF%BC%E5%87%BA/</url>
      
        <content type="html"><![CDATA[<p>因业务需要从网页中导出excel文件。</p><p>顺便研究了下，导入，编辑，导出，导出带图片的</p><p>但是导出带图片的只能是xls文件，导入只能是xlsx文件</p><p>如果是vue/react工程项目那么只能在入口文件里面导入</p><p>eg：vue-&gt;public-&gt;index.html 文件中直接在head中script引入两个文件,两个脚本放在同级目录(当然你也可以自己创建目录)</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>JS读取和导出excel示例<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;description&quot;</span> <span class="attr">content</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./exceljs-min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./sheetjs.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br></pre></td></tr></table></figure><p>完整实例</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-cn&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>JS读取和导出excel示例<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;description&quot;</span> <span class="attr">content</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./exceljs-min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./sheetjs.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">table</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-collapse</span>: collapse;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">th</span>, <span class="selector-tag">td</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: solid <span class="number">1px</span> <span class="number">#6D6D6D</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.mt-sm</span> &#123;<span class="attribute">margin-top</span>: <span class="number">8px</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#f4f4f4</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.container</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">1024px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span> auto;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#fff</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">min-height</span>: <span class="number">100vh</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mt-sm&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display:none;&quot;</span> <span class="attr">accept</span>=<span class="string">&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:selectFile()&quot;</span>&gt;</span>加载本地excel文件<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>结果输出：（下面表格可直接编辑导出）<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;result&quot;</span> <span class="attr">contenteditable</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;导出编辑过后的&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;t0()&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;导出纯文本&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;t1()&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;导出带图片的&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;t2()&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">class</span> <span class="title class_">ExcelIntance</span> <span class="keyword">extends</span> <span class="title class_ inherited__">ExcelController</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">constructor</span>(<span class="params">args</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">super</span>(args)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//读取本地文件 xlsx</span></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">inputFiles</span>(<span class="params">files</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span>(files.<span class="property">length</span> == <span class="number">0</span>) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> f = files[<span class="number">0</span>];</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span>(!<span class="regexp">/\.xlsx$/g</span>.<span class="title function_">test</span>(f.<span class="property">name</span>)) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">alert</span>(<span class="string">&#x27;仅支持读取xlsx格式！&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">super</span>.<span class="title function_">readWorkbookFromLocalFile</span>(f,<span class="function">(<span class="params">workbook</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//可以做一些操作</span></span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">this</span>.<span class="title function_">readWorkbook</span>(workbook);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//加载远程的 xlsx</span></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">loadRemoteFile</span>(<span class="params">url</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">super</span>.<span class="title function_">readWorkbookFromRemoteFile</span>(url, <span class="function">(<span class="params">workbook</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//可以做一些操作.</span></span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">this</span>.<span class="title function_">readWorkbook</span>(workbook);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//导出编辑过后的</span></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">exportEditedExcel</span>(<span class="params">title=<span class="string">&quot;导出&quot;</span></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> el = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">`#<span class="subst">$&#123;<span class="variable language_">this</span>.tagId&#125;</span> table`</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> csv = <span class="variable language_">super</span>.<span class="title function_">table2csv</span>(el);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> sheet = <span class="variable language_">super</span>.<span class="title function_">csv2sheet</span>(csv);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> blob = <span class="variable language_">super</span>.<span class="title function_">sheet2blob</span>(sheet);</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">super</span>.<span class="title function_">openDownloadDialog</span>(blob, <span class="string">`<span class="subst">$&#123;title&#125;</span>.xlsx`</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//导出没有图片的excel</span></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">exportTextExcel</span>(<span class="params">sheet,title=<span class="string">&quot;导出&quot;</span></span>)&#123;<span class="variable language_">super</span>.<span class="title function_">openDownloadDialog</span>(<span class="variable language_">super</span>.<span class="title function_">sheet2blob</span>(sheet), <span class="string">`<span class="subst">$&#123;title&#125;</span>.xlsx`</span>);&#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//导出带图片的excel</span></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">exportImgExcel</span>(<span class="params">tHeader,tbody,title=<span class="string">&quot;导出&quot;</span></span>)&#123;<span class="title function_">export2Excel</span>(tHeader, tbody, title)&#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> a= <span class="keyword">new</span> <span class="title class_">ExcelIntance</span>(&#123;<span class="attr">tagId</span>:<span class="string">&quot;result&quot;</span>&#125;)</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// exportEditedExcel</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">t0</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        a.<span class="title function_">exportEditedExcel</span>()</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// exportTextExcel</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">t1</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> aoa = [</span></span><br><span class="line"><span class="language-javascript">            [<span class="string">&#x27;主要信息&#x27;</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="string">&#x27;其它信息&#x27;</span>], <span class="comment">// 特别注意合并的地方后面预留2个null</span></span></span><br><span class="line"><span class="language-javascript">            [<span class="string">&#x27;姓名&#x27;</span>, <span class="string">&#x27;性别&#x27;</span>, <span class="string">&#x27;年龄&#x27;</span>, <span class="string">&#x27;注册时间&#x27;</span>],</span></span><br><span class="line"><span class="language-javascript">            [<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;男&#x27;</span>, <span class="number">18</span>, <span class="keyword">new</span> <span class="title class_">Date</span>()],</span></span><br><span class="line"><span class="language-javascript">            [<span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;女&#x27;</span>, <span class="number">22</span>, <span class="keyword">new</span> <span class="title class_">Date</span>()]</span></span><br><span class="line"><span class="language-javascript">        ];</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> sheet = <span class="variable constant_">XLSX</span>.<span class="property">utils</span>.<span class="title function_">aoa_to_sheet</span>(aoa);</span></span><br><span class="line"><span class="language-javascript">        sheet[<span class="string">&#x27;!merges&#x27;</span>] = [</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 设置A1-C1的单元格合并</span></span></span><br><span class="line"><span class="language-javascript">            &#123;<span class="attr">s</span>: &#123;<span class="attr">r</span>: <span class="number">0</span>, <span class="attr">c</span>: <span class="number">0</span>&#125;, <span class="attr">e</span>: &#123;<span class="attr">r</span>: <span class="number">0</span>, <span class="attr">c</span>: <span class="number">2</span>&#125;&#125;</span></span><br><span class="line"><span class="language-javascript">        ];</span></span><br><span class="line"><span class="language-javascript">        a.<span class="title function_">exportTextExcel</span>(sheet)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// exportImgExcel</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">t2</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> tHeader = [</span></span><br><span class="line"><span class="language-javascript">            <span class="string">&#x27;鲜花&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="string">&#x27;颜色&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="string">&#x27;照片&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        ]</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> tbody = [</span></span><br><span class="line"><span class="language-javascript">            &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">name</span>: <span class="string">&#x27;玫瑰花&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">color</span>: <span class="string">&#x27;红色&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">pic</span>: <span class="string">&#x27;https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=2801998497,4036145562&amp;fm=27&amp;gp=0.jpg&#x27;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">name</span>: <span class="string">&#x27;桃花花&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">color</span>: <span class="string">&#x27;粉色&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">pic</span>: <span class="string">&#x27;https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=602076004,4209938077&amp;fm=27&amp;gp=0.jpg&#x27;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        ]</span></span><br><span class="line"><span class="language-javascript">        a.<span class="title function_">exportImgExcel</span>(tHeader,tbody)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
            <tag> exceljs </tag>
            
            <tag> sheetjs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>小程序ios部分机型格式化时间问题</title>
      <link href="/2021/02/28/20210228%E5%B0%8F%E7%A8%8B%E5%BA%8Fios%E9%83%A8%E5%88%86%E6%9C%BA%E5%9E%8B%E6%A0%BC%E5%BC%8F%E5%8C%96%E6%97%B6%E9%97%B4%E9%97%AE%E9%A2%98/"/>
      <url>/2021/02/28/20210228%E5%B0%8F%E7%A8%8B%E5%BA%8Fios%E9%83%A8%E5%88%86%E6%9C%BA%E5%9E%8B%E6%A0%BC%E5%BC%8F%E5%8C%96%E6%97%B6%E9%97%B4%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>此代码返回的是NaN</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> leftTime = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&quot;2022-11-11 23:07:00&quot;</span>).<span class="title function_">getTime</span>()</span><br></pre></td></tr></table></figure><p>原因是下面代码返回的是<strong>Invlid Date</strong>，是因为部分ios的系统<strong>（实际是因为某些版本的safari通常不支持DD-MM-YYYY格式）</strong>不支持格式化带有 - 符号的时间</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&quot;2022-11-11 23:07:00&quot;</span>)</span><br></pre></td></tr></table></figure><p>解决办法直接替换掉 - 符号为 /</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> endTime=<span class="string">&quot;2022-11-11 23:07:00&quot;</span></span><br><span class="line"><span class="keyword">let</span> newEndTime = endTime.<span class="title function_">replace</span>(<span class="regexp">/\.|\-/g</span>, <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> leftTime = <span class="keyword">new</span> <span class="title class_">Date</span>(newEndTime).<span class="title function_">getTime</span>() </span><br></pre></td></tr></table></figure><p>或者直接使用时间戳</p>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web前端 </tag>
            
            <tag> 小程序 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fetch网络请求的轻度封装</title>
      <link href="/2021/01/05/20210105Fetch%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E7%9A%84%E8%BD%BB%E5%BA%A6%E5%B0%81%E8%A3%85/"/>
      <url>/2021/01/05/20210105Fetch%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E7%9A%84%E8%BD%BB%E5%BA%A6%E5%B0%81%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<p>比较喜欢<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch">fetch</a>，不需要使用任何依赖，轻量，简介。</p><p>这里时间不多，最近赶上线，下面这是稍微的封装，比较粗糙。</p><p>需要注意的是如果后端是<strong>表单解析</strong>，前端POST请求Content-Type有两个值</p><ul><li>application/x-www-form-urlencoded;<ul><li>是浏览器默认的编码格式，用于键值对参数，参数之间用&amp;间隔，POST请求，后端用表单解析；</li></ul></li><li>multipart/form-data;<ul><li>用于键值对参数，参数之间用&amp;间隔，POST请求，后端用表单解析，<strong>他能携带二进制文件</strong>，<strong>如果GET请求的时候，Content-Type还是这个值，可能出现问题。需要注意</strong>；</li></ul></li></ul><blockquote><p>fetch实现下载和上传进度不是很友好，<a href="https://tabbycute.github.io/2020/10/11/20201011%E5%9F%BA%E4%BA%8ERange%E5%8F%82%E6%95%B0fetch%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/">这里是之前实现的demo</a>，要实现上传下载进度还是用XHR好的多</p></blockquote><h2 id="fetch请求简易demo"><a href="#fetch请求简易demo" class="headerlink" title="fetch请求简易demo"></a>fetch请求简易demo</h2><blockquote><p>需要引入qs；src=”<a href="https://cdn.bootcss.com/qs/6.7.0/qs.min.js&quot;">https://cdn.bootcss.com/qs/6.7.0/qs.min.js&quot;</a><br>vue或者react中，文件需要相互引入，html直接写在一个文件中就可以；<br>下载文件直接用浏览器；</p></blockquote><p>qs基础解释ss</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">qs.<span class="title function_">stringify</span>(&#123;<span class="attr">ids</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]&#125;, &#123;<span class="attr">indices</span>: <span class="literal">false</span>&#125;)</span><br><span class="line"><span class="comment">//形式：ids=1&amp;ids=2&amp;id=3</span></span><br><span class="line">qs.<span class="title function_">stringify</span>(&#123;<span class="attr">ids</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]&#125;, &#123;<span class="attr">arrayFormat</span>: <span class="string">&#x27;indices&#x27;</span>&#125;) </span><br><span class="line"><span class="comment">//形式：ids[0]=1&amp;ids[1]=2&amp;ids[2]=3</span></span><br><span class="line">qs.<span class="title function_">stringify</span>(&#123;<span class="attr">ids</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]&#125;, &#123;<span class="attr">arrayFormat</span>: <span class="string">&#x27;brackets&#x27;</span>&#125;)    </span><br><span class="line"><span class="comment">//形式：ids[]=1&amp;ids[]=2&amp;ids[]=3</span></span><br><span class="line">qs.<span class="title function_">stringify</span>(&#123;<span class="attr">ids</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]&#125;, &#123;<span class="attr">arrayFormat</span>: <span class="string">&#x27;repeat&#x27;</span>&#125;)  </span><br><span class="line"><span class="comment">//形式： ids=1&amp;ids=2&amp;id=3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//go 取值 c.GetPostFormArray(&quot;hobs&quot;)   qs.stringify(&#123;ids: [1, 2, 3]&#125;, &#123;arrayFormat: &#x27;repeat&#x27;&#125;)  </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> json = &#123; <span class="attr">a</span>: &#123; <span class="attr">b</span>: &#123; <span class="attr">c</span>: <span class="string">&#x27;d&#x27;</span>, <span class="attr">e</span>: <span class="string">&#x27;f&#x27;</span> &#125; &#125; &#125;;</span><br><span class="line">qs.<span class="title function_">stringify</span>(json);</span><br><span class="line"><span class="comment">//结果 &#x27;a[b][c]=d&amp;a[b][e]=f&#x27;</span></span><br><span class="line">qs.<span class="title function_">stringify</span>(json, &#123;<span class="attr">allowDots</span>: <span class="literal">true</span>&#125;);</span><br><span class="line"><span class="comment">//结果 &#x27;a.b.c=d&amp;a.b.e=f&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//go 取值 c.GetPostFormArray(&quot;kv&quot;)  allowDots: false（默认) 对象使用 kv[a]=1 kv[b]=2 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//go取值如下</span></span><br><span class="line"><span class="attr">name</span>: tabby</span><br><span class="line"><span class="attr">age</span>: <span class="number">18</span></span><br><span class="line"><span class="attr">hobs</span>: <span class="number">1</span></span><br><span class="line"><span class="attr">hobs</span>: <span class="number">2</span></span><br><span class="line"><span class="attr">hobs</span>: <span class="number">3</span></span><br><span class="line">kv[a]: <span class="number">1</span></span><br><span class="line">kv[b]: <span class="number">2</span></span><br></pre></td></tr></table></figure><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><ul><li><p>这个对象中的参数是覆盖CustomDefaultConfig的参数，详情查看CustomDefaultConfig</p></li><li><p>这个对象中的参数是覆盖CustomDefaultError的参数，详情查看CustomDefaultError</p></li><li><p>自定义错误。CustomDefaultError.getErr所有抛出（请求(interceptorsReq)/(interceptorsResp)响应拦截，请求验证(validateStatus)，请求错误…）都会在请求的catch里面的出现。</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userConfig = &#123;</span><br><span class="line">  <span class="attr">baseURL</span>: <span class="string">&#x27;http://127.0.0.1:8080&#x27;</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">3000</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> userErr = &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>导入到下面文件中也必须叫userErr，userConfig。比如  import userConfig from …….</p></blockquote><h3 id="请求文件"><a href="#请求文件" class="headerlink" title="请求文件"></a>请求文件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//fetch默认参数</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title class_">FetchDefaultConfig</span> = &#123;</span><br><span class="line">     <span class="attr">headers</span>: &#123;</span><br><span class="line">       <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded;charset=utf-8;&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;test&#x27;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">       <span class="comment">// &#x27;Content-Type&#x27;:&#x27;application/json;charset=utf-8;&#x27;</span></span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">     same-origin（默认值）：该模式是不允许跨域的，它需要遵守同源策略，否则浏览器会返回一个error告知不能跨域；其对应的response type为basic。</span></span><br><span class="line"><span class="comment">     cors: 该模式支持跨域请求，顾名思义它是以CORS的形式跨域；当然该模式也可以同域请求不需要后端额外的CORS支持；其对应的response type为cors。</span></span><br><span class="line"><span class="comment">     no-cors: 该模式用于跨域请求但是服务器不带CORS响应头，也就是服务端不支持CORS；这也是fetch的特殊跨域请求方式；其对应的response type为opaque。</span></span><br><span class="line"><span class="comment">     针对跨域请求，cors模式是常见跨域请求实现，但是fetch自带的no-cors跨域请求模式则较为陌生，该模式有一个比较明显的特点：</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">// mode: &quot;cors&quot;,</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">     default : 默认行为，fresh使用cache，stale与服务器通信检查资源变化（协商缓存）</span></span><br><span class="line"><span class="comment">     no-cache : 无论fresh还是stale，都与服务器通信检查资源变化（协商缓存）</span></span><br><span class="line"><span class="comment">     force-cache : 无论fresh还是stale，都使用cache</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">// cache:&quot;&quot;,</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">     credentials : 指定该请求是否携带cookie或其他credentials</span></span><br><span class="line"><span class="comment">     include : 总是携带cookie，无论同源还是跨域</span></span><br><span class="line"><span class="comment">     same-origin : 默认值，仅在同源请求时携带cookie</span></span><br><span class="line"><span class="comment">     omit : 从不携带cookie</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">// credentials: &#x27;same-origin&#x27;,</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">     标识请求的“来源”，一般不建议手动设置</span></span><br><span class="line"><span class="comment">     same-origin URL</span></span><br><span class="line"><span class="comment">     about:client</span></span><br><span class="line"><span class="comment">     empty string “”</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">// referrer:&quot;&quot;,</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">     指定设置 Referer HTTP header的规则</span></span><br><span class="line"><span class="comment">     默认值为 strict-origin-when-cross-origin ，具体行为表现为：</span></span><br><span class="line"><span class="comment">       同源请求，Referer header中写入完整的URL</span></span><br><span class="line"><span class="comment">       跨域请求，Referer header中仅写入当前请求URL的origin</span></span><br><span class="line"><span class="comment">       请求non-potentially trustworthy URL，无Referer header</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">// referrerpolicy:&quot;strict-origin-when-cross-origin&quot;,</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">     指定遇到重定向的行为</span></span><br><span class="line"><span class="comment">     follow : 默认值，跟随重定向URL</span></span><br><span class="line"><span class="comment">     error : 如果遇到重定向，中断请求抛出Error</span></span><br><span class="line"><span class="comment">     manual</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">// redirect:&quot;&quot;,</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//自定义默认参数</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title class_">CustomDefaultConfig</span> = &#123;</span><br><span class="line">     <span class="attr">reqURL</span>: <span class="keyword">function</span> (<span class="params">router</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">baseURL</span> + router</span><br><span class="line">     &#125;,</span><br><span class="line">     </span><br><span class="line">     <span class="comment">///请求验证</span></span><br><span class="line">     <span class="attr">validateStatus</span>: <span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (res.<span class="property">status</span> &gt;= <span class="number">200</span> &amp;&amp; res.<span class="property">status</span> &lt; <span class="number">300</span>) <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(res)</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(res)</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="comment">///GET请求参数hook（修改必须遵守如下规则）</span></span><br><span class="line">     <span class="attr">transformQuery</span>: <span class="keyword">function</span> (<span class="params">params</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="title class_">Qs</span>.<span class="title function_">stringify</span>(params, &#123;</span><br><span class="line">         <span class="attr">arrayFormat</span>: <span class="string">&#x27;repeat&#x27;</span></span><br><span class="line">       &#125;)</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="comment">///Post上传文件时候的hook（修改必须遵守如下规则）</span></span><br><span class="line">     <span class="attr">transformReqFiles</span>: <span class="keyword">function</span> (<span class="params">params, files = []</span>) &#123;</span><br><span class="line">       <span class="keyword">var</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>()</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">///添加文件</span></span><br><span class="line">         files.<span class="title function_">forEach</span>(<span class="function">(<span class="params">i</span>) =&gt;</span> &#123;</span><br><span class="line">           <span class="keyword">var</span> maps = <span class="title class_">Object</span>.<span class="title function_">entries</span>(i)[<span class="number">0</span>]</span><br><span class="line">           formData.<span class="title function_">append</span>(maps[<span class="number">0</span>], maps[<span class="number">1</span>])</span><br><span class="line">         &#125;)</span><br><span class="line">         <span class="comment">///添加参数</span></span><br><span class="line">         <span class="keyword">var</span> maps = <span class="variable language_">this</span>.<span class="title function_">transformReq</span>(params).<span class="title function_">split</span>(<span class="string">&quot;&amp;&quot;</span>)</span><br><span class="line">         maps.<span class="title function_">forEach</span>(<span class="function"><span class="params">i</span> =&gt;</span> &#123;</span><br><span class="line">           <span class="keyword">var</span> s = i.<span class="title function_">split</span>(<span class="string">&quot;=&quot;</span>)</span><br><span class="line">           formData.<span class="title function_">append</span>(<span class="built_in">decodeURIComponent</span>(s[<span class="number">0</span>]), <span class="built_in">decodeURIComponent</span>(s[<span class="number">1</span>]))</span><br><span class="line">         &#125;);</span><br><span class="line">         <span class="keyword">return</span> formData</span><br><span class="line">       &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">         <span class="variable language_">console</span>.<span class="title function_">error</span>(error)</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FormData</span>()</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="comment">///Get除外请求参数hook（修改需要根据Content-Type）</span></span><br><span class="line">     <span class="attr">transformReq</span>: <span class="keyword">function</span> (<span class="params">params</span>) &#123;</span><br><span class="line">       <span class="comment">// return JSON.stringify(params)                     // &#x27;Content-Type&#x27;:&#x27;application/json;charset=utf-8;&#x27;</span></span><br><span class="line">       <span class="keyword">return</span> <span class="title class_">Qs</span>.<span class="title function_">stringify</span>(params, &#123;<span class="attr">arrayFormat</span>: <span class="string">&#x27;repeat&#x27;</span>&#125;) <span class="comment">// &#x27;Content-Type&#x27;: &#x27;application/x-www-form-urlencoded;charset=utf-8;&#x27;</span></span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="comment">///请求响应参数翻译</span></span><br><span class="line">     <span class="attr">transformResp</span>: <span class="keyword">function</span> (<span class="params">params</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> params</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="comment">///请求拦截（这里的错误会直接到dealErr，如果要报错必须在options里面添加 interceptorsErr =&#123;code,data,msg&#125;）</span></span><br><span class="line">     <span class="attr">interceptorsReq</span>: <span class="keyword">function</span> (<span class="params">options</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(options)</span><br><span class="line">       <span class="comment">// return Promise.reject(&#123;...options,interceptorsErr:&#123;code:401&#125;&#125;)</span></span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="comment">///响应拦截（这里的错误会直接到dealErr，如果要报错必须在options里面添加 interceptorsErr =&#123;code,data,msg&#125;）</span></span><br><span class="line">     <span class="attr">interceptorsResp</span>: <span class="keyword">function</span> (<span class="params">options</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(options)</span><br><span class="line">       <span class="comment">// return Promise.reject(&#123;...options,interceptorsErr:&#123;code:1,data:2,msg:&quot;3&quot;&#125;&#125;)</span></span><br><span class="line">     &#125;,</span><br><span class="line"></span><br><span class="line">     ...userConfig,</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//默认错误处理这里处理的是请求中的网络错误</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title class_">CustomDefaultError</span> = &#123;</span><br><span class="line"></span><br><span class="line">     <span class="number">400</span>: <span class="string">&quot;Bad Request&quot;</span>,</span><br><span class="line">     <span class="number">401</span>: <span class="string">&quot;Unauthorized&quot;</span>,</span><br><span class="line">     <span class="number">403</span>: <span class="string">&quot;Bad Request&quot;</span>,</span><br><span class="line">     <span class="number">408</span>: <span class="string">&quot;Request Time-out&quot;</span>,</span><br><span class="line">     <span class="number">600</span>: <span class="string">&quot;Request cancel&quot;</span>,</span><br><span class="line">     <span class="number">601</span>: <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">     <span class="number">602</span>: <span class="string">&quot;Request XHR-Err&quot;</span>,</span><br><span class="line">     ...userErr,</span><br><span class="line">     <span class="title function_">getErr</span>(<span class="params">code,resp,msg</span>) &#123;</span><br><span class="line">       <span class="comment">///这里可以处理用户未登录跳转</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> &#123;</span><br><span class="line">         <span class="attr">errCode</span>: code||<span class="number">601</span>,</span><br><span class="line">         <span class="attr">data</span>:resp,</span><br><span class="line">         <span class="attr">errMsg</span>: msg||<span class="variable language_">this</span>[code] || <span class="variable language_">this</span>[<span class="number">601</span>]</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">class</span> <span class="title class_">HttpClient</span> &#123;</span><br><span class="line">     <span class="variable constant_">URL</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">     data = <span class="literal">null</span></span><br><span class="line">     auth = <span class="string">&quot;&quot;</span></span><br><span class="line">     outTimer = <span class="literal">null</span></span><br><span class="line">     abortController = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">     <span class="title function_">constructor</span>(<span class="params">router, data, options = &#123;&#125;</span>) &#123;</span><br><span class="line">       <span class="comment">//设置参数</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">data</span> = data</span><br><span class="line">       <span class="comment">//构造请求参数</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">URL</span> = <span class="title class_">CustomDefaultConfig</span>.<span class="title function_">reqURL</span>(router)</span><br><span class="line">       <span class="comment">//是否需要token</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">auth</span> = options.<span class="property">auth</span> || <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//构造options</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">options</span> = &#123;</span><br><span class="line">         ...<span class="title class_">FetchDefaultConfig</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//设置取消signal</span></span><br><span class="line">       <span class="keyword">if</span> (options.<span class="property">controller</span>) <span class="variable language_">this</span>.<span class="property">abortController</span> = options.<span class="property">controller</span></span><br><span class="line">       <span class="keyword">else</span> <span class="variable language_">this</span>.<span class="property">abortController</span> = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">signal</span> = <span class="variable language_">this</span>.<span class="property">abortController</span>.<span class="property">signal</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">///重写headers</span></span><br><span class="line">       <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">headers</span>, options.<span class="property">headers</span> || &#123;&#125;)</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="title class_">Request</span>(files = []) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">///请求拦截器</span></span><br><span class="line">           <span class="title class_">CustomDefaultConfig</span>.<span class="title function_">interceptorsReq</span>(<span class="variable language_">this</span>.<span class="property">options</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">_options</span>) =&gt;</span> &#123;</span><br><span class="line">             <span class="comment">///设置超时</span></span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">setOutTimer</span>()</span><br><span class="line"></span><br><span class="line">             <span class="comment">///翻译请求参数</span></span><br><span class="line">             <span class="keyword">if</span> (_options.<span class="property">method</span> !== <span class="string">&quot;GET&quot;</span> &amp;&amp; _options.<span class="property">method</span> !== <span class="string">&quot;HEAD&quot;</span>) &#123;</span><br><span class="line">               <span class="comment">///检查一下是否有文件</span></span><br><span class="line">               <span class="keyword">if</span> (files.<span class="property">length</span>) &#123;</span><br><span class="line">                 <span class="variable language_">this</span>.<span class="title function_">clearOutTimer</span>()</span><br><span class="line">                 _options.<span class="property">body</span> = <span class="title class_">CustomDefaultConfig</span>.<span class="title function_">transformReqFiles</span>(<span class="variable language_">this</span>.<span class="property">data</span>, files)</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 _options.<span class="property">body</span> = <span class="title class_">CustomDefaultConfig</span>.<span class="title function_">transformReq</span>(_options.<span class="property">body</span>)</span><br><span class="line">               &#125;</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             <span class="comment">///发送请求</span></span><br><span class="line">             <span class="title function_">fetch</span>(<span class="variable language_">this</span>.<span class="property">URL</span>, _options)</span><br><span class="line">               .<span class="title function_">then</span>(<span class="function"><span class="params">_res</span> =&gt;</span>&#123; <span class="keyword">return</span> _res.<span class="title function_">json</span>().<span class="title function_">then</span>(<span class="function"><span class="params">json</span>=&gt;</span>&#123; <span class="title class_">Object</span>.<span class="title function_">assign</span>(_res,&#123;<span class="attr">_data</span>:json&#125;);<span class="keyword">return</span> _res &#125;)&#125;) <span class="comment">///结果转json（只会返回响应的data）</span></span><br><span class="line">               .<span class="title function_">then</span>(<span class="function"><span class="params">_res</span> =&gt;</span> <span class="title class_">CustomDefaultConfig</span>.<span class="title function_">validateStatus</span>(_res)) <span class="comment">///先判断是否请求成功fetch部分错误不会走catch</span></span><br><span class="line">               .<span class="title function_">then</span>(<span class="function"><span class="params">_res</span> =&gt;</span> <span class="title class_">CustomDefaultConfig</span>.<span class="title function_">interceptorsResp</span>(_res))   <span class="comment">///响应拦截器</span></span><br><span class="line">               .<span class="title function_">then</span>(<span class="function"><span class="params">_res</span> =&gt;</span> <span class="title class_">CustomDefaultConfig</span>.<span class="title function_">transformResp</span>(_res.<span class="property">_data</span>)) <span class="comment">///响应成功翻译器</span></span><br><span class="line">               .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123; <span class="title function_">resolve</span>(data)&#125;)<span class="comment">///返回结果</span></span><br><span class="line">               .<span class="title function_">catch</span>(<span class="function">(<span class="params">res</span>) =&gt;</span>&#123; <span class="variable language_">this</span>.<span class="title function_">dealErr</span>(res,reject) &#125;) <span class="comment">///请求失败</span></span><br><span class="line">               .<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;<span class="variable language_">this</span>.<span class="title function_">clearOutTimer</span>()&#125;);</span><br><span class="line"></span><br><span class="line">           &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">options</span>) =&gt;</span> &#123;</span><br><span class="line">             options.<span class="property">interceptorsReq</span>=<span class="literal">true</span></span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">dealErr</span>(options,reject)</span><br><span class="line">           &#125;);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;post.err&quot;</span>, error)</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">get</span> <span class="title function_">POST</span>() &#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">method</span> = <span class="string">&quot;POST&quot;</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">body</span> = <span class="variable language_">this</span>.<span class="property">data</span></span><br><span class="line">       <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title class_">Request</span>()</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">get</span> <span class="title function_">GET</span>() &#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">method</span> = <span class="string">&quot;GET&quot;</span></span><br><span class="line">       <span class="comment">///构造get的querry参数</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">URL</span> = <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.URL&#125;</span>?<span class="subst">$&#123;CustomDefaultConfig.transformQuery(<span class="variable language_">this</span>.data)&#125;</span>`</span></span><br><span class="line">       <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title class_">Request</span>()</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">///[&#123;file:文件&#125;]</span></span><br><span class="line">     <span class="title class_">UpFile</span>(files = []) &#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">method</span> = <span class="string">&quot;POST&quot;</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">body</span> = <span class="variable language_">this</span>.<span class="property">data</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">headers</span>=<span class="variable language_">this</span>.<span class="property">getPostFileHeader</span></span><br><span class="line">       <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title class_">Request</span>(files)</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">///带进度的上传文件</span></span><br><span class="line">     <span class="title class_">UpFileProgress</span>(files = [], onprogress) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="title class_">CustomDefaultConfig</span>.<span class="title function_">interceptorsReq</span>(<span class="variable language_">this</span>.<span class="property">options</span>).<span class="title function_">then</span>(<span class="function"><span class="params">_</span>=&gt;</span>&#123;</span><br><span class="line">           <span class="keyword">var</span> formData = <span class="title class_">CustomDefaultConfig</span>.<span class="title function_">transformReqFiles</span>(<span class="variable language_">this</span>.<span class="property">data</span>, files)</span><br><span class="line">           <span class="comment">// XMLHttpRequest对象</span></span><br><span class="line">           <span class="keyword">const</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">           <span class="variable language_">this</span>.<span class="title function_">setOutTimer</span>();</span><br><span class="line">           <span class="comment">// 请求完成。在此进行处理。</span></span><br><span class="line">           xhr.<span class="property">onloadend</span> =<span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span><br><span class="line">             <span class="title class_">CustomDefaultConfig</span>.<span class="title function_">validateStatus</span>(xhr)</span><br><span class="line">             .<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span><span class="title class_">JSON</span>.<span class="title function_">parse</span>(xhr.<span class="property">responseText</span>))</span><br><span class="line">             .<span class="title function_">then</span>(<span class="function"><span class="params">_res</span> =&gt;</span> <span class="title class_">CustomDefaultConfig</span>.<span class="title function_">interceptorsResp</span>(_res))</span><br><span class="line">             .<span class="title function_">then</span>(<span class="function"><span class="params">_res</span> =&gt;</span> <span class="title class_">CustomDefaultConfig</span>.<span class="title function_">transformResp</span>(_res))</span><br><span class="line">             .<span class="title function_">then</span>(<span class="function"><span class="params">_res</span> =&gt;</span> &#123;<span class="title function_">resolve</span>(_res)&#125;)</span><br><span class="line">             .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span>=&gt;</span>&#123;<span class="variable language_">this</span>.<span class="title function_">dealErr</span>(err,reject)&#125;)</span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="comment">// 上传进度</span></span><br><span class="line">           xhr.<span class="property">upload</span>.<span class="property">onprogress</span> =  <span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">clearOutTimer</span>()</span><br><span class="line">             onprogress&amp;&amp;<span class="title function_">onprogress</span>(e)</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 设置请求方式和请求地址</span></span><br><span class="line">           xhr.<span class="title function_">open</span>(<span class="string">&quot;POST&quot;</span>, <span class="variable language_">this</span>.<span class="property">URL</span>);</span><br><span class="line">           <span class="comment">// 设置请求头别设置 Content-Type否自不会自动计算</span></span><br><span class="line">           <span class="keyword">var</span> headers=<span class="variable language_">this</span>.<span class="property">getPostFileHeader</span></span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> headers) &#123;xhr.<span class="title function_">setRequestHeader</span>(key,headers[key])&#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 传递参数</span></span><br><span class="line">           xhr.<span class="title function_">send</span>(formData);</span><br><span class="line">           <span class="comment">///监听取消</span></span><br><span class="line">           <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">signal</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;abort&quot;</span>, <span class="function">() =&gt;</span> &#123;xhr.<span class="title function_">abort</span>();&#125;);</span><br><span class="line">         &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">options</span>=&gt;</span>&#123;</span><br><span class="line">           <span class="variable language_">this</span>.<span class="title function_">dealErr</span>(options,reject)</span><br><span class="line">         &#125;)</span><br><span class="line">         </span><br><span class="line">       &#125;)</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">get</span> <span class="title function_">getPostFileHeader</span>()&#123;</span><br><span class="line">       <span class="keyword">var</span> newHeaders=&#123;&#125;</span><br><span class="line">       <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">headers</span>)&#123;</span><br><span class="line">         <span class="keyword">var</span> headers=<span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">headers</span>));</span><br><span class="line">         <span class="title class_">Object</span>.<span class="title function_">entries</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">headers</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">i</span> =&gt;</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (i[<span class="number">0</span>].<span class="title function_">toLowerCase</span>() !== <span class="string">&quot;content-type&quot;</span>)newHeaders[i[<span class="number">0</span>]]=i[<span class="number">1</span>]</span><br><span class="line">         &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> newHeaders</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">///错误网络请求处理</span></span><br><span class="line">     <span class="title function_">dealErr</span>(<span class="params">res, reject</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span>(res <span class="keyword">instanceof</span> <span class="title class_">Response</span>)&#123;<span class="comment">///fetch http响应错误</span></span><br><span class="line">         <span class="title function_">reject</span>(<span class="title class_">CustomDefaultError</span>.<span class="title function_">getErr</span>(res.<span class="property">status</span>,res.<span class="property">_data</span>))</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">signal</span>.<span class="property">aborted</span>)&#123;<span class="comment">///自定义中断，如果reason为1为取消可以直接不处理这个</span></span><br><span class="line">         <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">signal</span>.<span class="property">reason</span>===<span class="number">408</span>)&#123;</span><br><span class="line">           <span class="comment">///请求超时</span></span><br><span class="line">           <span class="title function_">reject</span>(<span class="title class_">CustomDefaultError</span>.<span class="title function_">getErr</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">signal</span>.<span class="property">reason</span>,res.<span class="property">_data</span>))</span><br><span class="line">         &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;请求取消&quot;</span>)</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(res <span class="keyword">instanceof</span> <span class="title class_">XMLHttpRequest</span>)&#123;<span class="comment">///XMLHttpRequest错误,全都是602错误</span></span><br><span class="line">         <span class="title function_">reject</span>(<span class="title class_">CustomDefaultError</span>.<span class="title function_">getErr</span>(<span class="number">602</span>))</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(res.<span class="property">interceptorsErr</span>)&#123;<span class="comment">///请求/响应拦截</span></span><br><span class="line">         <span class="title function_">reject</span>(<span class="title class_">CustomDefaultError</span>.<span class="title function_">getErr</span>(res.<span class="property">interceptorsErr</span>.<span class="property">code</span>,res.<span class="property">interceptorsErr</span>.<span class="property">data</span>,res.<span class="property">interceptorsErr</span>.<span class="property">msg</span>))</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;未知错误:&quot;</span>,res)</span><br><span class="line">         <span class="title function_">reject</span>(<span class="title class_">CustomDefaultError</span>.<span class="title function_">getErr</span>(<span class="number">601</span>))</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">///开启超时</span></span><br><span class="line">     <span class="title function_">setOutTimer</span>(<span class="params"></span>) &#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">outTimer</span> = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">         <span class="variable language_">this</span>.<span class="property">abortController</span>.<span class="title function_">abort</span>(<span class="number">408</span>)</span><br><span class="line">       &#125;, <span class="title class_">CustomDefaultConfig</span>.<span class="property">timeout</span> + <span class="number">500</span>)</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">///关闭超时</span></span><br><span class="line">     <span class="title function_">clearOutTimer</span>(<span class="params"></span>) &#123;</span><br><span class="line">       <span class="built_in">clearTimeout</span>(<span class="variable language_">this</span>.<span class="property">outTimer</span>)</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;tabby&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">18</span>,</span><br><span class="line">  <span class="attr">hobs</span>: [<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>],</span><br><span class="line">  <span class="attr">kv</span>: &#123;</span><br><span class="line"><span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line"><span class="attr">b</span>: <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// const controller2 = new AbortController();</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// //xhr上传文件带进度条,带取消</span></span><br><span class="line">   <span class="comment">// var file = document.querySelector(&quot;#file&quot;)</span></span><br><span class="line">   <span class="comment">// file.addEventListener(&quot;input&quot;, (e) =&gt; &#123;</span></span><br><span class="line">   <span class="comment">//   var fileData = file.files[0]</span></span><br><span class="line">   <span class="comment">//   // setTimeout(()=&gt;&#123;</span></span><br><span class="line">   <span class="comment">//   //   controller2.abort()</span></span><br><span class="line">   <span class="comment">//   // &#125;,2000)</span></span><br><span class="line">   <span class="comment">//   new HttpClient(&quot;/post2&quot;, obj,&#123;controller:controller2&#125;)</span></span><br><span class="line">   <span class="comment">//   .UpFileProgress([&#123;file: fileData&#125;],function(e)&#123;console.log(&quot;当前进度&quot;,e.loaded)&#125;)</span></span><br><span class="line">   <span class="comment">//   .then(res=&gt;&#123;</span></span><br><span class="line">   <span class="comment">//     console.log(res)</span></span><br><span class="line">   <span class="comment">//   &#125;).catch(res=&gt;&#123;</span></span><br><span class="line">   <span class="comment">//     console.log(res)</span></span><br><span class="line">   <span class="comment">//   &#125;)</span></span><br><span class="line">   <span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">////fetch post普通请求</span></span><br><span class="line">   <span class="comment">// new HttpClient(&quot;/post2&quot;,obj).POST.then(res=&gt;&#123;</span></span><br><span class="line">   <span class="comment">//   console.log(res)</span></span><br><span class="line">   <span class="comment">// &#125;).catch(err=&gt;&#123;</span></span><br><span class="line">   <span class="comment">//   console.log(err)</span></span><br><span class="line">   <span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">//fetch post请求取消</span></span><br><span class="line">   <span class="comment">// new HttpClient(&quot;/post3&quot;,obj,&#123;controller:controller2&#125;).POST.then(res=&gt;&#123;</span></span><br><span class="line">   <span class="comment">//   console.log(res)</span></span><br><span class="line">   <span class="comment">// &#125;).catch(err=&gt;&#123;</span></span><br><span class="line">   <span class="comment">//   console.log(&quot;/post2&quot;,err)</span></span><br><span class="line">   <span class="comment">// &#125;)</span></span><br><span class="line">   <span class="comment">// setTimeout(()=&gt;&#123;</span></span><br><span class="line">   <span class="comment">//   controller2.abort()</span></span><br><span class="line">   <span class="comment">// &#125;,2000)</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">///fetch post请求超时</span></span><br><span class="line">   <span class="comment">// new HttpClient(&quot;/post3&quot;,obj).POST.then(res=&gt;&#123;</span></span><br><span class="line">   <span class="comment">//   console.log(res)</span></span><br><span class="line">   <span class="comment">// &#125;).catch(err=&gt;&#123;</span></span><br><span class="line">   <span class="comment">//   console.log(&quot;/post2&quot;,err)</span></span><br><span class="line">   <span class="comment">// &#125;)</span></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">   <span class="comment">////fetch post请求上传文件</span></span><br><span class="line">   <span class="comment">// var file=document.querySelector(&quot;#file&quot;)</span></span><br><span class="line">   <span class="comment">// file.addEventListener(&quot;input&quot;,(e)=&gt;&#123;</span></span><br><span class="line">   <span class="comment">//   var fileData=file.files[0]</span></span><br><span class="line">   <span class="comment">//   new HttpClient(&quot;/post2&quot;, obj).UpFile([&#123;file:fileData&#125;]).then(res =&gt; &#123;</span></span><br><span class="line">   <span class="comment">//     console.log(res)</span></span><br><span class="line">   <span class="comment">//   &#125;).catch(err =&gt; &#123;</span></span><br><span class="line">   <span class="comment">//     console.log(err)</span></span><br><span class="line">   <span class="comment">//   &#125;)</span></span><br><span class="line">   <span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">///fetch post请求上传文件终止取消</span></span><br><span class="line">   <span class="comment">// var file=document.querySelector(&quot;#file&quot;)</span></span><br><span class="line">   <span class="comment">// file.addEventListener(&quot;input&quot;,(e)=&gt;&#123;</span></span><br><span class="line">   <span class="comment">//   var fileData=file.files[0]</span></span><br><span class="line">   <span class="comment">//   setTimeout(()=&gt;&#123;</span></span><br><span class="line">   <span class="comment">//     controller2.abort(1)</span></span><br><span class="line">   <span class="comment">//   &#125;,2000)</span></span><br><span class="line">   <span class="comment">//   new HttpClient(&quot;/post3&quot;, obj,&#123;controller:controller2&#125;).UpFile([&#123;file:fileData&#125;]).then(res =&gt; &#123;</span></span><br><span class="line">   <span class="comment">//     console.log(res)</span></span><br><span class="line">   <span class="comment">//   &#125;).catch(err =&gt; &#123;</span></span><br><span class="line">   <span class="comment">//     console.log(err)</span></span><br><span class="line">   <span class="comment">//   &#125;)</span></span><br><span class="line">   <span class="comment">// &#125;)</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于js实现一个有序任务队列</title>
      <link href="/2020/12/09/20201209%E5%9F%BA%E4%BA%8Ejs%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%9C%89%E5%BA%8F%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97/"/>
      <url>/2020/12/09/20201209%E5%9F%BA%E4%BA%8Ejs%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%9C%89%E5%BA%8F%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97/</url>
      
        <content type="html"><![CDATA[<p>最近出现一个问题，项目首页渲染的时候由于一次图片量过大（图片尺寸小且还要解密），可能会导致卡顿。如果能让他们按照顺序加载(但是加载的时间不保证，因为图片的大小不一样)。</p><p>实现了如下简易队列。基本代码虽然简单，但是我给他预留了很多可以拓展的空间。如果以后用得上那么还是挺方便的。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">params</span><br><span class="line">    size  容量(最大可以一起执行的任务数量)</span><br><span class="line">callback 任务回调。每个回调执行完了过后触发，参数为任务<span class="title class_">Promise</span>的resovle的值</span><br><span class="line">method</span><br><span class="line">destroyed    停止队列(已经抛出的任务仍然会继续执行，这里主要是对我没什么影响，如要有其他需要可以自己定义拓展)</span><br><span class="line">    add          每一个任务的回调，返回必须是<span class="title class_">Promise</span>。resolve出去的值会作为callback的参数</span><br></pre></td></tr></table></figure><p>注意，为了防止队友乱来，因为js的class并不支持私有方法和属性。我利用symbol的唯一性和闭包定义局部变量为他实现了私有方法和属性。当然私有方法和属性的实现方法不唯一，实现的方法有很多吧。<br>比如</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">TbPool</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> size = <span class="keyword">new</span> <span class="title class_">WeakMap</span>();</span><br><span class="line">    <span class="keyword">const</span> run = <span class="keyword">new</span> <span class="title class_">WeakMap</span>();</span><br><span class="line">    <span class="keyword">class</span>  <span class="title class_">Pool</span> &#123;</span><br><span class="line">        <span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">b</span> = <span class="string">&#x27;b这是公有变量&#x27;</span>;</span><br><span class="line">            size.<span class="title function_">set</span>(<span class="variable language_">this</span>, <span class="string">&#x27;私有变量size&#x27;</span>)</span><br><span class="line">            run.<span class="title function_">set</span>(<span class="variable language_">this</span>, <span class="function">()=&gt;</span>&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;私有方法&quot;</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">test</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(size.<span class="title function_">get</span>(<span class="variable language_">this</span>));</span><br><span class="line">            run.<span class="title function_">get</span>(<span class="variable language_">this</span>)()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Pool</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> q = <span class="title class_">TbPool</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(q)</span><br><span class="line">q.<span class="title function_">test</span>()</span><br></pre></td></tr></table></figure><p>业务中使用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">TbPool</span>(<span class="params">arg</span>)&#123;</span><br><span class="line"><span class="keyword">const</span> listener=<span class="title class_">Symbol</span>(<span class="string">&quot;listener&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> taskRun=<span class="title class_">Symbol</span>(<span class="string">&quot;taskRun&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> tasksTimer=<span class="title class_">Symbol</span>(<span class="string">&quot;tasksTimer&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> queenTimer=<span class="title class_">Symbol</span>(<span class="string">&quot;queenTimer&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> queen=<span class="title class_">Symbol</span>(<span class="string">&quot;queen&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> tasks=<span class="title class_">Symbol</span>(<span class="string">&quot;tasks&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> size=<span class="title class_">Symbol</span>(<span class="string">&quot;size&quot;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pool</span> &#123;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">obj=&#123;&#125;</span>)&#123;</span><br><span class="line"><span class="variable language_">this</span>[size]=obj.<span class="property">size</span>||<span class="number">10</span></span><br><span class="line"><span class="variable language_">this</span>[queen]=[]</span><br><span class="line"><span class="variable language_">this</span>[tasks]=[]</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="variable language_">this</span>[size];i++)&#123;<span class="variable language_">this</span>[tasks].<span class="title function_">push</span>(&#123;<span class="attr">status</span>:-<span class="number">1</span>,<span class="attr">task</span>:<span class="literal">null</span>&#125;)&#125;</span><br><span class="line"><span class="variable language_">this</span>[listener]=<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">obj.<span class="title function_">callback</span>(e)</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">this</span>[taskRun]=<span class="keyword">function</span>(<span class="params">index</span>)&#123;</span><br><span class="line"><span class="variable language_">this</span>[tasks][index].<span class="property">status</span>=<span class="number">1</span></span><br><span class="line"><span class="variable language_">this</span>[tasks][index].<span class="title function_">task</span>().<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line"><span class="variable language_">this</span>[listener](res)</span><br><span class="line"><span class="variable language_">this</span>[tasks][index]=&#123;<span class="attr">status</span>:-<span class="number">1</span>,<span class="attr">task</span>:<span class="literal">null</span>&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">this</span>[tasksTimer]=<span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">var</span> isHasWait=<span class="variable language_">this</span>[tasks].<span class="title function_">findIndex</span>(<span class="function"><span class="params">item</span>=&gt;</span>item.<span class="property">status</span>===<span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span>(isHasWait!==-<span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="variable language_">this</span>[tasks].<span class="property">length</span>;i++)&#123;<span class="keyword">if</span>(<span class="variable language_">this</span>[tasks][i].<span class="property">status</span>===<span class="number">0</span>)<span class="variable language_">this</span>[taskRun](i)&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">this</span>[queenTimer]=<span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">var</span> isHasWait=<span class="variable language_">this</span>[tasks].<span class="title function_">findIndex</span>(<span class="function"><span class="params">item</span>=&gt;</span>item.<span class="property">status</span>===-<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span>(<span class="variable language_">this</span>[queen].<span class="property">length</span>&amp;&amp;(isHasWait!==-<span class="number">1</span>))&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="variable language_">this</span>[queen].<span class="property">length</span>;i++)&#123;</span><br><span class="line"><span class="keyword">var</span> index=<span class="variable language_">this</span>[tasks].<span class="title function_">findIndex</span>(<span class="function"><span class="params">item</span>=&gt;</span>item.<span class="property">status</span>===-<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span>(index!==-<span class="number">1</span>)<span class="variable language_">this</span>[tasks][index]=<span class="variable language_">this</span>[queen].<span class="title function_">shift</span>()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">add</span>(<span class="params">data=[]</span>)&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;data.<span class="property">length</span>;i++)&#123;</span><br><span class="line"><span class="variable language_">this</span>[queen].<span class="title function_">push</span>(&#123;<span class="attr">status</span>:<span class="number">0</span>,<span class="attr">task</span>:data[i]&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">destroyed</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="built_in">clearInterval</span>(<span class="variable language_">this</span>[tasksTimer])</span><br><span class="line"><span class="built_in">clearInterval</span>(<span class="variable language_">this</span>[queenTimer])</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Pool</span>(arg)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line"><span class="keyword">var</span> q =<span class="title class_">TbPool</span>(&#123;</span><br><span class="line"><span class="attr">size</span>:<span class="number">6</span>,<span class="comment">//容量(最大可以一起执行的任务数量)</span></span><br><span class="line"><span class="attr">callback</span>:<span class="keyword">function</span>(<span class="params">e</span>)&#123;<span class="comment">//任务回调。每个回调执行完了过后触发，参数为任务Promise的resovle的值</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;callback监听:&quot;</span>,e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(q)</span><br><span class="line"><span class="comment">//每一个任务的回调，返回必须是Promise</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">r</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;<span class="title function_">r</span>(<span class="string">`当前完成任务:<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().valueOf()&#125;</span>`</span>)&#125;,<span class="number">3000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f3</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="comment">//停止队列(已经抛出的任务仍然会继续执行，可以自己定义拓展)</span></span><br><span class="line">q.<span class="title function_">destroyed</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line"><span class="comment">//添加任务</span></span><br><span class="line">q.<span class="title function_">add</span>([f2,f2])</span><br><span class="line">&#125;,<span class="number">1000</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浏览器的事件循环机制EventLoop及其相关理解</title>
      <link href="/2020/11/11/20201111%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6/"/>
      <url>/2020/11/11/20201111%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="任务队列"><a href="#任务队列" class="headerlink" title="任务队列"></a>任务队列</h2><p>首先我们需要明白以下几件事情：</p><ul><li>JS分为同步任务和异步任务。</li><li>同步任务都在主线程上执行，形成一个执行栈。</li><li>主线程之外，事件触发线程管理着一个任务队列，只要异步任务有了运行结果，就在任务队列之中放置一个事件。</li><li>一旦执行栈中的所有同步任务执行完毕（此时JS引擎空闲），系统就会读取任务队列，将可运行的异步任务添加到可执行栈中，开始执行。</li></ul><p>根据规范，事件循环是通过任务队列的机制来进行协调的。一个 Event Loop 中，可以有一个或者多个任务队列(task queue)，一个任务队列便是一系列有序任务(task)的集合；每个任务都有一个任务源(task source)，源自同一个任务源的 task 必须放到同一个任务队列，从不同源来的则被添加到不同队列。 setTimeout/Promise 等API便是任务源，而进入任务队列的是他们指定的具体执行任务。</p><p><img src="/assets/img/202011111.png"></p><h2 id="事件循环EventLoop"><a href="#事件循环EventLoop" class="headerlink" title="事件循环EventLoop"></a>事件循环EventLoop</h2><p>事件循环的概念非常简单。它是一个在 JavaScript 引擎等待任务，执行任务和进入休眠状态等待更多任务这几个状态之间转换的无限循环。</p><p>1.当有任务时。从最先进入的任务开始执行。</p><p>2.休眠直到出现任务，然后转到第 1 步。当我们浏览一个网页时就是上述这种形式。JavaScript 引擎大多数时候不执行任何操作，它仅在脚本/处理程序/事件激活时执行。</p><ul><li>当外部脚本。比如页面的script脚本加载完成时，任务就是执行它。</li><li>当用户移动鼠标时，任务就是派生出 mousemove 事件和执行处理程序。</li><li>当安排的（scheduled）setTimeout 时间到达时，任务就是执行其回调。</li></ul><p>设置任务 —— 引擎处理它们 —— 然后等待更多任务（即休眠，几乎不消耗 CPU 资源）。一个任务到来时，引擎可能正处于繁忙状态，那么这个任务就会被排入队列。多个任务组成了一个队列，即所谓的“宏任务队列”。</p><p>在事件循环中，每进行一次循环操作称为 tick，每一次 tick 的任务处理模型是比较复杂的，但关键步骤如下：</p><ul><li>执行一个宏任务（栈中没有就从事件队列中获取）</li><li>执行过程中如果遇到微任务，就将它添加到微任务的任务队列中</li><li>宏任务执行完毕后，立即执行当前微任务队列中的所有微任务（依次执行）</li><li>当前宏任务执行完毕，开始检查渲染，然后GUI线程接管渲染</li><li>渲染完毕后，JS线程继续接管，开始下一个宏任务（从事件队列中获取）</li></ul><p><img src="/assets/img/202011113.png"></p><h2 id="宏任务-macrotask或者task-和微任务-microtask"><a href="#宏任务-macrotask或者task-和微任务-microtask" class="headerlink" title="宏任务(macrotask或者task)和微任务(microtask)"></a>宏任务(macrotask或者task)和微任务(microtask)</h2><h3 id="宏任务-task"><a href="#宏任务-task" class="headerlink" title="宏任务(task)"></a>宏任务(task)</h3><p>宏任务(task)可以理解是每次执行栈执行的代码就是一个宏任务（包括每次从事件队列中获取一个事件回调并放到执行栈中执行）。</p><p>浏览器为了能够使得JS内部task与DOM任务能够有序的执行，会在一个task执行结束后，在下一个task 执行开始前，对页面进行重新渲染，流程如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">task-&gt;microtask微任务执行-&gt;渲染-&gt;task-&gt;</span><br></pre></td></tr></table></figure><p>task主要包含：script(整体代码)、setTimeout、setInterval、I/O、UI交互事件、postMessage、MessageChannel、setImmediate(Node.js 环境)</p><h3 id="微任务-microtask"><a href="#微任务-microtask" class="headerlink" title="微任务(microtask)"></a>微任务(microtask)</h3><p>微任务（microtask）可以理解是在当前 task 执行结束后立即执行的任务。也就是说，在当前task任务后，下一个task之前，在渲染之前。</p><blockquote><p>执行顺序为:微任务-宏任务-UI渲染</p><p>task（加载script标签）-&gt;microtask微任务执行-&gt;UI渲染-&gt;task-&gt;</p><p>上面先是宏任务，因为当前没有任务，这个task是<strong>任务源</strong>或者说是在<strong>加载任务</strong>，并非违法规则</p></blockquote><p>微任务仅来自于我们的代码。它们通常是由 promise 创建的：对 .then/catch/finally 处理程序的执行会成为微任务。微任务也被用于 await 的“幕后”，因为它是 promise 处理的另一种形式。</p><p>microtask主要包含：Promise.then、MutaionObserver、<strong>queueMicrotask</strong>、process.nextTick(Node.js 环境)</p><blockquote><p>下面的srcipt加载，mousemove，settimeout，都是宏任务</p><p><strong>任务源</strong> - 微任务 - UI渲染(render) -宏任务 - 微任务 - UI渲染(render) - 宏任务</p></blockquote><p><img src="/assets/img/202011112.png"></p><blockquote><p>这里有必要提一下vue中的 <strong>$nextTick</strong> ，$nextTick（callback）在下次 DOM 更新循环结束之后执行延迟回调(<strong>这意味着他需要在UI本次更新后下次更新前，宏任务-微任务-UI更新–$nextTick–UI更新-宏任务-微任务</strong>)。</p><p>补充一下下面需要用到的：MutationObserver是HTML5新增的属性，用于监听DOM修改事件，能够监听到节点的属性、文本内容、子节点等的改动，是一个功能强大的利器，基本用法如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MO基本用法</span></span><br><span class="line"><span class="keyword">var</span> observer = <span class="keyword">new</span> <span class="title class_">MutationObserver</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DOM被修改了！&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> dom = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.d&#x27;</span>);</span><br><span class="line">observer.<span class="title function_">observer</span>(dom)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++)&#123;</span><br><span class="line">    dom.<span class="property">style</span>.<span class="property">left</span> = i + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;,<span class="number">1000</span>)</span><br></pre></td></tr></table></figure><p>上面的代码，render只会渲染一次，因为这个setTimeout是一个宏任务task。</p><p>只要让nextTick里的代码放在UI render步骤后面执行，就能拿到更新后的dom，vue就是基于事件循环的思路实现的$nextTick。</p><p>当然vue做的更佳的严谨友好。先来看看vue内部实现的核心代码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> isUsingMicroTask = <span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(<span class="title class_">Promise</span>)) &#123;</span><br><span class="line"> <span class="comment">//判断1：是否原生支持Promise</span></span><br><span class="line"> <span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line"> timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">   p.<span class="title function_">then</span>(flushCallbacks)</span><br><span class="line">   <span class="keyword">if</span> (isIOS) <span class="built_in">setTimeout</span>(noop)</span><br><span class="line"> &#125;</span><br><span class="line"> isUsingMicroTask = <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isIE &amp;&amp; <span class="keyword">typeof</span> <span class="title class_">MutationObserver</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; (</span><br><span class="line"> <span class="title function_">isNative</span>(<span class="title class_">MutationObserver</span>) ||</span><br><span class="line"> <span class="title class_">MutationObserver</span>.<span class="title function_">toString</span>() === <span class="string">&#x27;[object MutationObserverConstructor]&#x27;</span></span><br><span class="line">)) &#123;</span><br><span class="line"> <span class="comment">//判断2：是否原生支持MutationObserver</span></span><br><span class="line"> <span class="keyword">let</span> counter = <span class="number">1</span></span><br><span class="line"> <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">MutationObserver</span>(flushCallbacks)</span><br><span class="line"> <span class="keyword">const</span> textNode = <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(<span class="title class_">String</span>(counter))</span><br><span class="line"> observer.<span class="title function_">observe</span>(textNode, &#123;</span><br><span class="line">   <span class="attr">characterData</span>: <span class="literal">true</span></span><br><span class="line"> &#125;)</span><br><span class="line"> timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">   counter = (counter + <span class="number">1</span>) % <span class="number">2</span></span><br><span class="line">   textNode.<span class="property">data</span> = <span class="title class_">String</span>(counter)</span><br><span class="line"> &#125;</span><br><span class="line"> isUsingMicroTask = <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> setImmediate !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(setImmediate)) &#123;</span><br><span class="line"> <span class="comment">//判断3：是否原生支持setImmediate</span></span><br><span class="line"> timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">   <span class="title function_">setImmediate</span>(flushCallbacks)</span><br><span class="line"> &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="comment">//判断4：上面都不行，直接用setTimeout</span></span><br><span class="line"> timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">   <span class="built_in">setTimeout</span>(flushCallbacks, <span class="number">0</span>)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>vue的降级策略：vue根据当前环境来判断是用什么方法(Promise.then、MutationObserver、setImmediate、setTimeout)把回调添加到render后面执行。</p><p>但是他优先放在微任务中，也就是说，Vue.nextTick就是希望在DOM更新后，尽可能早地调用传递的回调函数callback。这时，微任务就是一个最佳的选择。</p><p>不管是宏任务还是微任务，他都在一个叫做flushCallbacks的函数里面从callbacks取出回调然后执行(不管是宏任务还是微任务都是在render的末尾)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">flushCallbacks</span> () &#123;</span><br><span class="line"> pending = <span class="literal">false</span></span><br><span class="line"> <span class="keyword">const</span> copies = callbacks.<span class="title function_">slice</span>(<span class="number">0</span>)</span><br><span class="line"> callbacks.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; copies.<span class="property">length</span>; i++) &#123;</span><br><span class="line">   copies[i]()</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大致流程就是</p><ul><li>修改dom(会导致更新UI的操作)</li><li>执行this.$nextTick(cb)</li><li>this.$nextTick(cb)把cb添加到内部的callbacks中，</li><li>vue判断当前环境，进行降级策略</li><li>UI render渲染</li><li>flushCallbacks从callbacks中取出nextTick的回调进行执行</li></ul></blockquote><h2 id="拆分CPU过载任务"><a href="#拆分CPU过载任务" class="headerlink" title="拆分CPU过载任务"></a>拆分CPU过载任务</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">count</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 做一个繁重的任务</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; <span class="number">1e9</span>; j++) &#123;</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">alert</span>(<span class="string">&quot;Done in &quot;</span> + (<span class="title class_">Date</span>.<span class="title function_">now</span>() - start) + <span class="string">&#x27;ms&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">count</span>();</span><br></pre></td></tr></table></figure><p>这种情况浏览器甚至可能会显示一个“脚本执行时间过长”的警告。让我们使用嵌套的 setTimeout 调用来拆分这个任务：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">count</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 做繁重的任务的一部分 (*)</span></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    i++;</span><br><span class="line">  &#125; <span class="keyword">while</span> (i % <span class="number">1e6</span> != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (i == <span class="number">1e9</span>) &#123;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">&quot;Done in &quot;</span> + (<span class="title class_">Date</span>.<span class="title function_">now</span>() - start) + <span class="string">&#x27;ms&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(count); <span class="comment">// 安排（schedule）新的调用 (**)</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">count</span>();</span><br></pre></td></tr></table></figure><p>单次执行 count 会完成工作的一部分，然后根据需要重新安排（schedule）自身的执行，<strong>类似“多线程”</strong>：</p><p>1.首先执行计数：i=1…1000000。</p><p>2.然后执行计数：i=1000001..2000000。</p><p>但是这样他的执行耗时实际上没有多少改变让我们来做一个改进。我们将要把调度（scheduling）移动到 count() 的开头，<strong>类似“多线程”并发</strong>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">count</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 将调度（scheduling）移动到开头。“多线程的感觉”</span></span><br><span class="line">  <span class="keyword">if</span> (i &lt; <span class="number">1e9</span> - <span class="number">1e6</span>) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(count); <span class="comment">// 安排（schedule）新的调用</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    i++;</span><br><span class="line">  &#125; <span class="keyword">while</span> (i % <span class="number">1e6</span> != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (i == <span class="number">1e9</span>) &#123;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">&quot;Done in &quot;</span> + (<span class="title class_">Date</span>.<span class="title function_">now</span>() - start) + <span class="string">&#x27;ms&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">count</span>();</span><br></pre></td></tr></table></figure><h2 id="async，await，queueMicrotask执行分析"><a href="#async，await，queueMicrotask执行分析" class="headerlink" title="async，await，queueMicrotask执行分析"></a>async，await，queueMicrotask执行分析</h2><h3 id="async，await"><a href="#async，await" class="headerlink" title="async，await"></a>async，await</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//请写出输出内容</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">async1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;async1 start&#x27;</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">async2</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;async1 end&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">async2</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;async2&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;script start&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;setTimeout&#x27;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="title function_">async1</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise1&#x27;</span>);</span><br><span class="line">    <span class="title function_">resolve</span>();</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise2&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;script end&#x27;</span>);</span><br></pre></td></tr></table></figure><p>1.首先，事件循环从宏任务(macrotask)队列开始，这个时候，宏任务队列中，只有一个script(整体代码)任务；当遇到任务源(task source)时，则会先分发任务到对应的任务队列中去。所以，<br><img src="/assets/img/202011114.png"></p><p>2.然后我们看到首先定义了两个async函数，接着往下看，然后遇到了 console 语句，直接输出 script start。输出之后，script 任务继续往下执行，遇到 setTimeout，其作为一个宏任务源，则会先将其任务分发到对应的队列中：<br><img src="/assets/img/202011115.png"></p><p>3.script 任务继续往下执行，执行了async1()函数，前面讲过async函数中在await之前的代码是立即执行的，所以会立即输出async1 start。</p><blockquote><p>遇到了await时，会将await后面的表达式执行一遍，所以就紧接着输出async2，然后将await后面的代码也就是console.log(‘async1 end’)加入到microtask中的Promise队列中，接着跳出async1函数来执行后面的代码。<br><img src="/assets/img/202011116.png"></p></blockquote><p>4.script任务继续往下执行，遇到Promise实例。<strong>由于Promise中的函数是立即执行的</strong>，而后续的 .then 则会被分发到 microtask 的 Promise 队列中去。所以会先输出 promise1，然后执行 resolve，将 promise2 分配到对应队列。<br><img src="/assets/img/202011117.png"></p><p>5.script任务继续往下执行，最后只有一句输出了 script end，至此，全局任务就执行完毕了。</p><blockquote><p>根据上述，每次执行完一个宏任务之后，会去检查是否存在 Microtasks；如果有，则执行 Microtasks 直至清空 Microtask Queue。</p><p>因而在script任务执行完毕之后，开始查找清空微任务队列。此时，微任务中， Promise 队列有的两个任务async1 end和promise2，因此按先后顺序输出 async1 end，promise2。当所有的 Microtasks 执行完毕之后，表示第一轮的循环就结束了。</p></blockquote><p>6.第二轮循环依旧从宏任务队列开始。此时宏任务中只有一个 setTimeout，取出直接输出即可，至此整个流程结束。</p><h3 id="queueMicrotask"><a href="#queueMicrotask" class="headerlink" title="queueMicrotask"></a>queueMicrotask</h3><p>还有一个特殊的函数 queueMicrotask(func)，它对 func 进行排队，让func在微任务队列中执行。类似写同步代码一样，<strong>但是他是排在微任务队列的末尾</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;宏任务1&#x27;</span>)</span><br><span class="line">    <span class="title function_">queueMicrotask</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;微任务2&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;宏任务2&#x27;</span>)</span><br><span class="line">    <span class="title function_">queueMicrotask</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;微任务3&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title function_">queueMicrotask</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;微任务1&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 被宏任务嵌套的微任务，在宏任务后执行，并不会有插队现象</span></span><br><span class="line"><span class="comment">// 1 2 微任务1 宏任务1 微任务2 宏任务2 微任务3</span></span><br></pre></td></tr></table></figure><h3 id="Node的事件循环"><a href="#Node的事件循环" class="headerlink" title="Node的事件循环"></a>Node的事件循环</h3><p>Node的事件循环是libuv实现的，引用一张官网的图：</p><p><img src="/assets/img/202011113.png"></p><p>大体的task（宏任务）执行顺序是这样的：</p><ul><li>timers定时器：本阶段执行已经安排的 setTimeout() 和 setInterval() 的回调函数。</li><li>pending callbacks待定回调：执行延迟到下一个循环迭代的 I/O 回调。</li><li>idle, prepare：仅系统内部使用。</li><li>poll 轮询：检索新的 I/O 事件;执行与 I/O 相关的回调（几乎所有情况下，除了关闭的回调函数，它们由计时器和 setImmediate() 排定的之外），其余情况 node 将在此处阻塞。</li><li>check 检测：setImmediate() 回调函数在这里执行。</li><li>close callbacks 关闭的回调函数：一些准备关闭的回调函数，如：socket.on(‘close’, …)。</li><li>微任务和宏任务在Node的执行顺序</li></ul><p>Node 10以前：</p><ul><li>执行完一个阶段的所有任务</li><li>执行完nextTick队列里面的内容</li><li>然后执行完微任务队列的内容</li></ul><p>Node 11以后：</p><p>和浏览器的行为统一了，都是每执行一个宏任务就执行完微任务队列。</p>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何使用软键盘自定义Input框</title>
      <link href="/2020/11/09/20201109%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E8%BD%AF%E9%94%AE%E7%9B%98%E8%87%AA%E5%AE%9A%E4%B9%89Input%E6%A1%86/"/>
      <url>/2020/11/09/20201109%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E8%BD%AF%E9%94%AE%E7%9B%98%E8%87%AA%E5%AE%9A%E4%B9%89Input%E6%A1%86/</url>
      
        <content type="html"><![CDATA[<p>最近在项目中遇见一个问题，页面需求是输入邀请码，要能是文本，而且输入的时候上面的字符要有动画效果。</p><p>感觉实现的方法比较low，但是简单啊。哈哈哈</p><p>先看设计图</p><p><img src="/assets/img/202011091.png"></p><p>如此一来uniapp的input框是肯定无法满足我们的要求，在原生的Android或者ios上面或者flutter上面，这都不是什么难事，但是要在uniapp上这个第一时间我想到了几种方法</p><ul><li>方案一：首先让他定位在下图位置z-index为1，当input聚焦事件触发的时候直接给他z-index为-1让在数字框后面藏起来，结果效果不触发，这个方案直接pass。<br><img src="/assets/img/202011092.png"></li><li>方案二：思路如上，我让他在聚焦的时候把他一道屏幕外面。结果出现了个尴尬的情况，让input输入框变化的时候视角直接拉过去了。感兴趣可以自己去尝试。总之就是pass。<br><img src="/assets/img/202011093.png"></li><li>最终方案：直接让他宽度超出屏幕外设置透明度为0这样用户也是无感知的。最终临时的解决了这个问题也不知道有没有更好的方法，待定这个方案。<br><img src="/assets/img/202011094.png"></li></ul><p>代码如下(项目中的业务代码，无关的需要删掉)</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;content&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;input&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">v-for</span>=<span class="string">&quot;i in maxLength&quot;</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;num&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;inum[i-1]&quot;</span>&gt;</span>&#123;&#123;inum[i-1]&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;con&quot;</span>  <span class="attr">v-if</span>=<span class="string">&quot;value.length+1===i&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">v-if</span>=<span class="string">&quot;nativeKey&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;inputValue&quot;</span> @<span class="attr">input</span>=<span class="string">&quot;change&quot;</span> <span class="attr">class</span>=<span class="string">&quot;input&quot;</span> <span class="attr">confirm-type</span>=<span class="string">&quot;done&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">props</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">value</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">type</span>:<span class="title class_">String</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">default</span>:<span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">maxLength</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">type</span>:<span class="title class_">Number</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">default</span>:<span class="number">6</span>,</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">nativeKey</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">type</span>:<span class="title class_">Boolean</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">default</span>:<span class="literal">false</span>,</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">data</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">inputValue</span>:<span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">computed</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">inum</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> arr = <span class="variable language_">this</span>.<span class="property">value</span>.<span class="title function_">split</span>(<span class="string">&quot;&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> arr</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">methods</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">change</span>(<span class="params">e</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> v=e.<span class="property">detail</span>.<span class="property">value</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//判断当前是否在删除</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span>(v.<span class="property">length</span>&lt;=<span class="variable language_">this</span>.<span class="property">maxLength</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>,v.<span class="property">length</span>)</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">this</span>.$emit(<span class="string">&quot;input&quot;</span>,v.<span class="title function_">substring</span>(<span class="number">0</span>,<span class="number">7</span>))</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span> <span class="attr">lang</span>=<span class="string">&quot;stylus&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.input</span></span></span><br><span class="line"><span class="language-css">    <span class="attribute">display</span> <span class="attribute">flex</span></span></span><br><span class="line"><span class="language-css">    <span class="attribute">align-items</span> center</span></span><br><span class="line"><span class="language-css">    <span class="attribute">justify-content</span> space-between</span></span><br><span class="line"><span class="language-css">    <span class="attribute">position</span> relative</span></span><br><span class="line"><span class="language-css">    <span class="attribute">overflow</span> hidden</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">input</span></span></span><br><span class="line"><span class="language-css">        <span class="attribute">display</span> block</span></span><br><span class="line"><span class="language-css">        <span class="attribute">position</span> absolute</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background-color</span> red</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span> <span class="number">900%</span></span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span> <span class="number">100%</span></span></span><br><span class="line"><span class="language-css">        <span class="attribute">top</span> <span class="number">0</span></span></span><br><span class="line"><span class="language-css">        <span class="attribute">left</span> -<span class="number">800%</span></span></span><br><span class="line"><span class="language-css">        zIndex <span class="number">10</span></span></span><br><span class="line"><span class="language-css">        <span class="attribute">caret-color</span> rgba(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span></span><br><span class="line"><span class="language-css">        <span class="attribute">opacity</span> <span class="number">0</span></span></span><br><span class="line"><span class="language-css">        user-select:none;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.item</span></span></span><br><span class="line"><span class="language-css">    <span class="attribute">width</span> <span class="number">68</span>rpx</span></span><br><span class="line"><span class="language-css">    <span class="attribute">height</span> <span class="number">90</span>rpx</span></span><br><span class="line"><span class="language-css">    <span class="attribute">border-bottom</span> <span class="number">2</span>rpx solid <span class="selector-id">#cccccc</span></span></span><br><span class="line"><span class="language-css">    <span class="attribute">display</span> <span class="attribute">flex</span></span></span><br><span class="line"><span class="language-css">    <span class="attribute">justify-content</span> center</span></span><br><span class="line"><span class="language-css">    <span class="attribute">align-items</span> center</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.con</span></span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">6</span>rpx;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">40</span>rpx;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#0A293E</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-radius</span>: <span class="number">2</span>rpx;</span></span><br><span class="line"><span class="language-css">        // <span class="attribute">margin-bottom</span> <span class="number">24</span>rpx</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.num</span></span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-size</span> <span class="number">48</span>rpx</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-family</span>: PingFangSC-Medium, PingFang SC;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-weight</span>: <span class="number">500</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">animation</span>:scale-out-bl .<span class="number">15s</span> <span class="built_in">cubic-bezier</span>(.<span class="number">55</span>,.<span class="number">085</span>,.<span class="number">68</span>,.<span class="number">53</span>) <span class="number">0.01s</span> reverse both</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
            <tag> uniapp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Http请求的Range参数精简解释</title>
      <link href="/2020/10/11/20201011%E5%9F%BA%E4%BA%8ERange%E5%8F%82%E6%95%B0fetch%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/"/>
      <url>/2020/10/11/20201011%E5%9F%BA%E4%BA%8ERange%E5%8F%82%E6%95%B0fetch%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/</url>
      
        <content type="html"><![CDATA[<p>主要是依赖Http请求头Range实现大文件的下载暂停，同时他还能实现文件分片下载，分片下载这里demo不做演示。</p><p>Range: &lt;数据格式&gt;=&lt;数据开始的索引位置&gt;-&lt;数据结束的索引位置&gt;；</p><ul><li>请求从0至500的byte数据：Range: bytes=0-500</li><li>请求第500个byte以后的全部数据：Range: bytes=501-</li><li>请求最后500个byte的数据：Range:bytes=-500</li><li>请求多个分段时，各分段以,分割：Range: bytes=0-100,101-200</li></ul><p><img src="/assets/img/202010111.png"></p><p>如果响应头中的Accept-Ranges：none； 那么服务器就不支持当前格式</p><p>请求的范围不合格或者超出文件大小都会报错超</p><blockquote><p>GET <a href="http://127.0.0.1:8080/down">http://127.0.0.1:8080/down</a> 416 (Requested Range Not Satisfiable)<br>416:表示Range请求的资源范围无法满足;<br>206:支持部分返回，将返回指定部分数据；<br>200:不支持部分返回，将从头开始完整返回数据；</p></blockquote><p>响应头中将返回Content—Range字段:Content-Range: &lt;数据格式&gt; &lt;数据开始的索引位置&gt;-&lt;数据结束的索引位置&gt;/&lt;完整数据大小&gt;。</p><p>与Transfer-Encoding分块传输的差别</p><p><strong>分块传输编码只在HTTP协议1.1版本（HTTP/1.1）中提供。</strong></p><p>数据分解成一系列数据块，并以一个或多个块发送，这样服务器可以发送数据而不需要预先知道发送内容的总大小。而使用Range需要服务端在返回响应前就知道数据完整大小，因此Transfer-Encoding的响应速度相应会更快一些。两者不冲突，可以一起使用。</p><blockquote><p>在头部加入 Transfer-Encoding: chunked 之后，就代表这个报文采用了分块编码。这时，报文中的实体需要改为用一系列分块来传输。每个分块包含十六进制的长度值和数据，长度值独占一行，长度不包括它结尾的 CRLF(\r\n)，也不包括分块数据结尾的 CRLF。最后一个分块长度值必须为 0，对应的分块数据没有内容，表示实体结束。</p></blockquote><p>Content-Encoding 和 Transfer-Encoding 二者经常会结合来用，其实就是针对 Transfer-Encoding 的分块再进行 Content-Encoding压缩。</p><p>有时候服务器开启压缩或者为了减少cpu压力等等，是不会去计算文件的总大小的，这时候从响应头中就无法获取资源的总大小。</p><p><img src="/assets/img/202010112.png"></p><p>大文件上传和下载的进度监听和暂停fetch也能实现，这里时间不多，后面回来补上，先给个解决方案的思路.</p><p><strong>更简单的是使用XHR！！！</strong></p><h4 id="Fetch大文件下载"><a href="#Fetch大文件下载" class="headerlink" title="Fetch大文件下载"></a>Fetch大文件下载</h4><p>大文件的下载进度和暂停可以如下实现。如下代码实际是操作一个流的进度而已。最终把Uint8Array转成一个文件就OK。</p><blockquote><p>如果想实现文件快速下载，<strong>可以考虑使用 <a href="https://tabbycute.github.io/2020/10/11/20201011Http%E8%AF%B7%E6%B1%82%E7%9A%84Range%E5%8F%82%E6%95%B0%E7%B2%BE%E7%AE%80%E8%A7%A3%E9%87%8A/">Range</a> 来实现同时下载多个文件段</strong>，然后把它们按照顺序拼接起来。<br>当然 <a href="https://tabbycute.github.io/2020/10/11/20201011Http%E8%AF%B7%E6%B1%82%E7%9A%84Range%E5%8F%82%E6%95%B0%E7%B2%BE%E7%AE%80%E8%A7%A3%E9%87%8A/">Range</a> 也能实现文件的进度监听，不过效率不太好。每个客户端的网速不一样，比如我现在的实际网速能达到10MB/S，我们设定的是Range:0-512,这样显得很缓慢，但是对于个别网速差的客户端却很合适。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> size = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> data=[]</span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;http://127.0.0.1:8080/file&quot;</span>,&#123;</span><br><span class="line">    <span class="attr">cache</span>: <span class="string">&#x27;no-cache&#x27;</span>,</span><br><span class="line"><span class="comment">// headers:&#123;</span></span><br><span class="line"><span class="comment">// Range:&quot;&quot;,///如果暂停了，下次继续开始就用这个，接着上一次的断点继续开始</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (response.<span class="property">ok</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;请求失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 取出body</span></span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="property">body</span>)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">body</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> reader = body.<span class="title function_">getReader</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReadableStream</span>(&#123;</span><br><span class="line">        <span class="title function_">start</span>(<span class="params">controller</span>) &#123;</span><br><span class="line">            <span class="keyword">function</span> <span class="title function_">pump</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> reader.<span class="title function_">read</span>().<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;   <span class="comment">//res  (&#123; done, value &#125;) </span></span><br><span class="line">                    <span class="keyword">const</span> &#123; done, value &#125; = res;</span><br><span class="line">                    <span class="keyword">if</span> (done) &#123;<span class="comment">// 读不到更多数据就关闭流</span></span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">                        controller.<span class="title function_">close</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                    data=[...data,...value]</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;本次请求长度：&quot;</span>,value.<span class="property">length</span>, <span class="string">&quot;--------现在的总长度:&quot;</span>,data.<span class="property">length</span>)</span><br><span class="line">                    <span class="comment">// 将下一个数据块置入流中</span></span><br><span class="line">                    controller.<span class="title function_">enqueue</span>(value);</span><br><span class="line">                    <span class="keyword">return</span> <span class="title function_">pump</span>();</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">pump</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(err));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">本次请求长度： 1638400 --------现在的总长度: 1638400</span></span><br><span class="line"><span class="comment">本次请求长度： 458752 --------现在的总长度: 2097152</span></span><br><span class="line"><span class="comment">本次请求长度： 1638400 --------现在的总长度: 3735552</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">本次请求长度： 509341 --------现在的总长度: 15648157</span></span><br><span class="line"><span class="comment">end</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><h4 id="大文件上传"><a href="#大文件上传" class="headerlink" title="大文件上传"></a>大文件上传</h4><p>目前能想到的只有切片。</p>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JSON.stringify的详解</title>
      <link href="/2020/10/01/20201001JSON.stringify%E7%9A%84%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0/"/>
      <url>/2020/10/01/20201001JSON.stringify%E7%9A%84%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<p>JSON.stringify尽然有3个参数的啊一直都以为只有一个。(value[, replacer [, space]])</p><h4 id="参数一"><a href="#参数一" class="headerlink" title="参数一"></a>参数一</h4><p>没什么好说的,但是有几个地方需要注意</p><ul><li>非数组对象的属性不能保证以特定的顺序出现在序列化后的字符串中（对象的属性的顺序可能会改变）<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data = &#123;<span class="attr">name</span>:<span class="string">&quot;tabby&quot;</span>,<span class="attr">hobs</span>:[<span class="string">&quot;篮球&quot;</span>,<span class="string">&quot;足球&quot;</span>],<span class="attr">other</span>:&#123;<span class="attr">a</span>:<span class="number">1</span>,<span class="attr">b</span>:<span class="number">2</span>,<span class="attr">c</span>:<span class="number">3</span>&#125;&#125;;</span><br><span class="line"><span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data); </span><br></pre></td></tr></table></figure></li><li>布尔值、数字、字符串的包装对象在序列化过程中会自动转换成对应的原始值。</li><li>undefined、任意的函数 、 symbol 键值对、不可枚举的属性、 在序列化过程中会被忽略（出现在非数组对象的属性值中时）或者被转换成 null（出现在数组中时）。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;t1&quot;</span>:<span class="literal">undefined</span>,<span class="string">&quot;t2&quot;</span>:<span class="keyword">function</span>(<span class="params">a</span>)&#123;<span class="keyword">var</span> a=<span class="number">10</span>;<span class="keyword">return</span> a&#125;,<span class="string">&quot;t3&quot;</span>:<span class="title class_">Symbol</span>(<span class="string">&quot;asdada&quot;</span>),<span class="string">&quot;t4&quot;</span>:&#123;<span class="string">&quot;fnc&quot;</span>:<span class="keyword">function</span>(<span class="params">a</span>)&#123;<span class="keyword">var</span> a=<span class="number">10</span>;<span class="keyword">return</span> a&#125;,<span class="attr">a</span>:<span class="number">1</span>&#125;,[<span class="title class_">Symbol</span>(<span class="string">&quot;t5&quot;</span>)]: <span class="string">&quot;t5&quot;</span>&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj)) </span><br><span class="line"><span class="comment">//&#123;&quot;t4&quot;:&#123;&quot;a&quot;:1&#125;&#125;</span></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="literal">undefined</span>,<span class="title class_">Symbol</span>(<span class="string">&quot;aaa&quot;</span>),<span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;,&#123;<span class="string">&quot;fnc&quot;</span>:<span class="keyword">function</span>(<span class="params">a</span>)&#123;<span class="keyword">var</span> a=<span class="number">10</span>;<span class="keyword">return</span> a&#125;,<span class="attr">a</span>:<span class="number">1</span>&#125;];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arr))</span><br><span class="line"><span class="comment">//[null,null,null,&#123;&quot;a&quot;:1&#125;]</span></span><br><span class="line"><span class="title class_">JSON</span>.<span class="title function_">stringify</span>( <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>, &#123; <span class="attr">t1</span>: &#123; <span class="attr">value</span>: <span class="string">&#x27;t1&#x27;</span>, <span class="attr">enumerable</span>: <span class="literal">false</span> &#125;, <span class="attr">t2</span>: &#123; <span class="attr">value</span>: <span class="string">&#x27;t2&#x27;</span>, <span class="attr">enumerable</span>: <span class="literal">true</span> &#125; &#125;) );</span><br><span class="line"><span class="comment">//&#123;&quot;t2&quot;:&quot;t2&quot;&#125;</span></span><br></pre></td></tr></table></figure><h4 id="参数二"><a href="#参数二" class="headerlink" title="参数二"></a>参数二</h4></li><li>当第二个参数为函数的时候，每个“key”，“value”都会经过该函数的转换和处理，<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;tabby&quot;</span>,</span><br><span class="line">    <span class="attr">t1</span>: &#123;</span><br><span class="line">        <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">b</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">c</span>: [<span class="string">&quot;cccc&quot;</span>, <span class="number">2</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> b = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data, <span class="keyword">function</span> (<span class="params">key, val</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;key is %s&quot;</span>, key);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;val is %s , type is %s&quot;</span>,val,<span class="keyword">typeof</span> (val));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;-----------------------------------------------------&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b)</span><br><span class="line"><span class="comment">//输出如下</span></span><br><span class="line">key is </span><br><span class="line">val is &#123; <span class="attr">name</span>: <span class="string">&#x27;tabby&#x27;</span>, <span class="attr">t1</span>: [<span class="title class_">Object</span>] &#125; , type is object</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">key is name</span><br><span class="line">val is tabby , type is string</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">key is t1</span><br><span class="line">val is &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span>, <span class="attr">c</span>: [<span class="title class_">Array</span>] &#125; , type is object</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">key is a</span><br><span class="line">val is <span class="number">1</span> , type is number</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">key is b</span><br><span class="line">val is <span class="number">2</span> , type is number</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">key is c</span><br><span class="line">val is [ <span class="string">&#x27;cccc&#x27;</span>, <span class="number">2</span> ] , type is object</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">key is <span class="number">0</span></span><br><span class="line">val is cccc , type is string</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">key is <span class="number">1</span></span><br><span class="line">val is <span class="number">2</span> , type is number</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;tabby&quot;</span>,<span class="string">&quot;t1&quot;</span>:&#123;<span class="string">&quot;a&quot;</span>:<span class="number">1</span>,<span class="string">&quot;b&quot;</span>:<span class="number">2</span>,<span class="string">&quot;c&quot;</span>:[<span class="string">&quot;cccc&quot;</span>,<span class="number">2</span>]&#125;&#125;</span><br></pre></td></tr></table></figure></li><li>当第二个参数为数组的时候<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;tabby&quot;</span>,</span><br><span class="line">    <span class="attr">t1</span>: &#123;</span><br><span class="line">        <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">b</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">c</span>: [<span class="string">&quot;cccc&quot;</span>, <span class="number">1</span>,&#123;<span class="attr">d</span>:<span class="number">1</span>,<span class="attr">c</span>:<span class="string">&quot;嘻嘻嘻&quot;</span>&#125;]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">t2</span>:<span class="string">&quot;AAAAA&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> b = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data, [<span class="string">&quot;name&quot;</span>, <span class="string">&quot;t1&quot;</span>,<span class="string">&quot;c&quot;</span>, <span class="string">&quot;cccc&quot;</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="params">b</span>)</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;tabby&quot;</span>,<span class="string">&quot;t1&quot;</span>:&#123;<span class="string">&quot;c&quot;</span>:[<span class="string">&quot;cccc&quot;</span>,<span class="number">1</span>,&#123;<span class="string">&quot;c&quot;</span>:<span class="string">&quot;嘻嘻嘻&quot;</span>&#125;]&#125;&#125;</span><br></pre></td></tr></table></figure><h4 id="参数三"><a href="#参数三" class="headerlink" title="参数三"></a>参数三</h4>控制序列化格式过后的缩进<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;tabby&quot;</span>,</span><br><span class="line">    <span class="attr">t1</span>: &#123;</span><br><span class="line">        <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">b</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">c</span>: [<span class="string">&quot;cccc&quot;</span>, <span class="number">1</span>,&#123;<span class="attr">d</span>:<span class="number">1</span>,<span class="attr">c</span>:<span class="string">&quot;嘻嘻嘻&quot;</span>&#125;]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">t2</span>:<span class="string">&quot;AAAAA&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> b = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data,<span class="literal">null</span>,<span class="number">5</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b)</span><br><span class="line"><span class="comment">///</span></span><br><span class="line">&#123;</span><br><span class="line">     <span class="string">&quot;name&quot;</span>: <span class="string">&quot;tabby&quot;</span>,</span><br><span class="line">     <span class="string">&quot;t1&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;a&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="string">&quot;b&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="string">&quot;c&quot;</span>: [</span><br><span class="line">               <span class="string">&quot;cccc&quot;</span>,</span><br><span class="line">               <span class="number">1</span>,</span><br><span class="line">               &#123;</span><br><span class="line">                    <span class="string">&quot;d&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                    <span class="string">&quot;c&quot;</span>: <span class="string">&quot;嘻嘻嘻&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">          ]</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="string">&quot;t2&quot;</span>: <span class="string">&quot;AAAAA&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> b = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data,<span class="literal">null</span>,<span class="string">&quot;***&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b)</span><br><span class="line"><span class="comment">///</span></span><br><span class="line">&#123;</span><br><span class="line">***<span class="string">&quot;name&quot;</span>: <span class="string">&quot;tabby&quot;</span>,</span><br><span class="line">***<span class="string">&quot;t1&quot;</span>: &#123;</span><br><span class="line">******<span class="string">&quot;a&quot;</span>: <span class="number">1</span>,</span><br><span class="line">******<span class="string">&quot;b&quot;</span>: <span class="number">2</span>,</span><br><span class="line">******<span class="string">&quot;c&quot;</span>: [</span><br><span class="line">*********<span class="string">&quot;cccc&quot;</span>,</span><br><span class="line">*********<span class="number">1</span>,</span><br><span class="line">*********&#123;</span><br><span class="line">************<span class="string">&quot;d&quot;</span>: <span class="number">1</span>,</span><br><span class="line">************<span class="string">&quot;c&quot;</span>: <span class="string">&quot;嘻嘻嘻&quot;</span></span><br><span class="line">*********&#125;</span><br><span class="line">******]</span><br><span class="line">***&#125;,</span><br><span class="line">***<span class="string">&quot;t2&quot;</span>: <span class="string">&quot;AAAAA&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> b = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data,<span class="literal">null</span>,<span class="string">&quot;\t&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="params">b</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;name&quot;</span>: <span class="string">&quot;tabby&quot;</span>,</span><br><span class="line"><span class="string">&quot;t1&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;a&quot;</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;b&quot;</span>: <span class="number">2</span>,</span><br><span class="line"><span class="string">&quot;c&quot;</span>: [</span><br><span class="line"><span class="string">&quot;cccc&quot;</span>,</span><br><span class="line"><span class="number">1</span>,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;d&quot;</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;c&quot;</span>: <span class="string">&quot;嘻嘻嘻&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;t2&quot;</span>: <span class="string">&quot;AAAAA&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="toJSON"><a href="#toJSON" class="headerlink" title="toJSON()"></a>toJSON()</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;tabby&quot;</span>,</span><br><span class="line">    <span class="attr">t1</span>: &#123;</span><br><span class="line">        <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">b</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">c</span>: [<span class="string">&quot;cccc&quot;</span>, <span class="number">1</span>,&#123;<span class="attr">d</span>:<span class="number">1</span>,<span class="attr">c</span>:<span class="string">&quot;嘻嘻嘻&quot;</span>&#125;]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">t2</span>:<span class="string">&quot;AAAAA&quot;</span>,</span><br><span class="line">    <span class="attr">toJSON</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我是序列化过后的数据&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> b = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;我是序列化过后的数据&quot;</span></span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> web前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo Tags自动摘要</title>
      <link href="/2020/07/05/20200705hexo%E8%87%AA%E5%8A%A8%E6%91%98%E8%A6%81/"/>
      <url>/2020/07/05/20200705hexo%E8%87%AA%E5%8A%A8%E6%91%98%E8%A6%81/</url>
      
        <content type="html"><![CDATA[<p>使用插件hexo-excerpt实现</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install hexo-excerpt --save</span><br></pre></td></tr></table></figure><p>在站点配置文件中添加（项目的_config.yml）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">excerpt:</span><br><span class="line">  depth: 3  </span><br><span class="line">  excerpt_excludes: []</span><br><span class="line">  more_excludes: []</span><br><span class="line">  hideWholePostExcerpts: true</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
